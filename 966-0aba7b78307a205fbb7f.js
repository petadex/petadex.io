"use strict";(self.webpackChunkgatsby_starter_default=self.webpackChunkgatsby_starter_default||[]).push([[966],{9966:function(e,t,n){n.d(t,{createPluginUI:function(){return tB}});var i={};n.r(i),n.d(i,{boolean:function(){return C},booleanish:function(){return w},commaOrSpaceSeparated:function(){return j},commaSeparated:function(){return I},number:function(){return B},overloadedBoolean:function(){return k},spaceSeparated:function(){return P}});var s={};n.r(s),n.d(s,{attentionMarkers:function(){return rn},contentInitial:function(){return Yt},disable:function(){return on},document:function(){return Wt},flow:function(){return en},flowInitial:function(){return Jt},insideSpan:function(){return sn},string:function(){return tn},text:function(){return nn}});var r=n(96540),o=n(74848),a=n(51142),l=n(79632);function c(){}function u(){}const d=/^[$_\p{ID_Start}][$_\u{200C}\u{200D}\p{ID_Continue}]*$/u,h=/^[$_\p{ID_Start}][-$_\u{200C}\u{200D}\p{ID_Continue}]*$/u,p={};function m(e,t){return((t||p).jsx?h:d).test(e)}const f=/[ \t\n\f\r]/g;function g(e){return""===e.replace(f,"")}class y{constructor(e,t,n){this.normal=t,this.property=e,n&&(this.space=n)}}function v(e,t){const n={},i={};for(const s of e)Object.assign(n,s.property),Object.assign(i,s.normal);return new y(n,i,t)}function b(e){return e.toLowerCase()}y.prototype.normal={},y.prototype.property={},y.prototype.space=void 0;class x{constructor(e,t){this.attribute=t,this.property=e}}x.prototype.attribute="",x.prototype.booleanish=!1,x.prototype.boolean=!1,x.prototype.commaOrSpaceSeparated=!1,x.prototype.commaSeparated=!1,x.prototype.defined=!1,x.prototype.mustUseProperty=!1,x.prototype.number=!1,x.prototype.overloadedBoolean=!1,x.prototype.property="",x.prototype.spaceSeparated=!1,x.prototype.space=void 0;let S=0;const C=T(),w=T(),k=T(),B=T(),P=T(),I=T(),j=T();function T(){return 2**++S}const A=Object.keys(i);class M extends x{constructor(e,t,n,s){let r=-1;if(super(e,t),L(this,"space",s),"number"==typeof n)for(;++r<A.length;){const e=A[r];L(this,A[r],(n&i[e])===i[e])}}}function L(e,t,n){n&&(e[t]=n)}function E(e){const t={},n={};for(const[i,s]of Object.entries(e.properties)){const r=new M(i,e.transform(e.attributes||{},i),s,e.space);e.mustUseProperty&&e.mustUseProperty.includes(i)&&(r.mustUseProperty=!0),t[i]=r,n[b(i)]=i,n[b(r.attribute)]=i}return new y(t,n,e.space)}M.prototype.defined=!0;const D=E({properties:{ariaActiveDescendant:null,ariaAtomic:w,ariaAutoComplete:null,ariaBusy:w,ariaChecked:w,ariaColCount:B,ariaColIndex:B,ariaColSpan:B,ariaControls:P,ariaCurrent:null,ariaDescribedBy:P,ariaDetails:null,ariaDisabled:w,ariaDropEffect:P,ariaErrorMessage:null,ariaExpanded:w,ariaFlowTo:P,ariaGrabbed:w,ariaHasPopup:null,ariaHidden:w,ariaInvalid:null,ariaKeyShortcuts:null,ariaLabel:null,ariaLabelledBy:P,ariaLevel:B,ariaLive:null,ariaModal:w,ariaMultiLine:w,ariaMultiSelectable:w,ariaOrientation:null,ariaOwns:P,ariaPlaceholder:null,ariaPosInSet:B,ariaPressed:w,ariaReadOnly:w,ariaRelevant:null,ariaRequired:w,ariaRoleDescription:P,ariaRowCount:B,ariaRowIndex:B,ariaRowSpan:B,ariaSelected:w,ariaSetSize:B,ariaSort:null,ariaValueMax:B,ariaValueMin:B,ariaValueNow:B,ariaValueText:null,role:null},transform(e,t){return"role"===t?t:"aria-"+t.slice(4).toLowerCase()}});function N(e,t){return t in e?e[t]:t}function F(e,t){return N(e,t.toLowerCase())}const R=E({attributes:{acceptcharset:"accept-charset",classname:"class",htmlfor:"for",httpequiv:"http-equiv"},mustUseProperty:["checked","multiple","muted","selected"],properties:{abbr:null,accept:I,acceptCharset:P,accessKey:P,action:null,allow:null,allowFullScreen:C,allowPaymentRequest:C,allowUserMedia:C,alt:null,as:null,async:C,autoCapitalize:null,autoComplete:P,autoFocus:C,autoPlay:C,blocking:P,capture:null,charSet:null,checked:C,cite:null,className:P,cols:B,colSpan:null,content:null,contentEditable:w,controls:C,controlsList:P,coords:B|I,crossOrigin:null,data:null,dateTime:null,decoding:null,default:C,defer:C,dir:null,dirName:null,disabled:C,download:k,draggable:w,encType:null,enterKeyHint:null,fetchPriority:null,form:null,formAction:null,formEncType:null,formMethod:null,formNoValidate:C,formTarget:null,headers:P,height:B,hidden:k,high:B,href:null,hrefLang:null,htmlFor:P,httpEquiv:P,id:null,imageSizes:null,imageSrcSet:null,inert:C,inputMode:null,integrity:null,is:null,isMap:C,itemId:null,itemProp:P,itemRef:P,itemScope:C,itemType:P,kind:null,label:null,lang:null,language:null,list:null,loading:null,loop:C,low:B,manifest:null,max:null,maxLength:B,media:null,method:null,min:null,minLength:B,multiple:C,muted:C,name:null,nonce:null,noModule:C,noValidate:C,onAbort:null,onAfterPrint:null,onAuxClick:null,onBeforeMatch:null,onBeforePrint:null,onBeforeToggle:null,onBeforeUnload:null,onBlur:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onContextLost:null,onContextMenu:null,onContextRestored:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnded:null,onError:null,onFocus:null,onFormData:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLanguageChange:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadEnd:null,onLoadStart:null,onMessage:null,onMessageError:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRejectionHandled:null,onReset:null,onResize:null,onScroll:null,onScrollEnd:null,onSecurityPolicyViolation:null,onSeeked:null,onSeeking:null,onSelect:null,onSlotChange:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnhandledRejection:null,onUnload:null,onVolumeChange:null,onWaiting:null,onWheel:null,open:C,optimum:B,pattern:null,ping:P,placeholder:null,playsInline:C,popover:null,popoverTarget:null,popoverTargetAction:null,poster:null,preload:null,readOnly:C,referrerPolicy:null,rel:P,required:C,reversed:C,rows:B,rowSpan:B,sandbox:P,scope:null,scoped:C,seamless:C,selected:C,shadowRootClonable:C,shadowRootDelegatesFocus:C,shadowRootMode:null,shape:null,size:B,sizes:null,slot:null,span:B,spellCheck:w,src:null,srcDoc:null,srcLang:null,srcSet:null,start:B,step:null,style:null,tabIndex:B,target:null,title:null,translate:null,type:null,typeMustMatch:C,useMap:null,value:w,width:B,wrap:null,writingSuggestions:null,align:null,aLink:null,archive:P,axis:null,background:null,bgColor:null,border:B,borderColor:null,bottomMargin:B,cellPadding:null,cellSpacing:null,char:null,charOff:null,classId:null,clear:null,code:null,codeBase:null,codeType:null,color:null,compact:C,declare:C,event:null,face:null,frame:null,frameBorder:null,hSpace:B,leftMargin:B,link:null,longDesc:null,lowSrc:null,marginHeight:B,marginWidth:B,noResize:C,noHref:C,noShade:C,noWrap:C,object:null,profile:null,prompt:null,rev:null,rightMargin:B,rules:null,scheme:null,scrolling:w,standby:null,summary:null,text:null,topMargin:B,valueType:null,version:null,vAlign:null,vLink:null,vSpace:B,allowTransparency:null,autoCorrect:null,autoSave:null,disablePictureInPicture:C,disableRemotePlayback:C,prefix:null,property:null,results:B,security:null,unselectable:null},space:"html",transform:F}),O=E({attributes:{accentHeight:"accent-height",alignmentBaseline:"alignment-baseline",arabicForm:"arabic-form",baselineShift:"baseline-shift",capHeight:"cap-height",className:"class",clipPath:"clip-path",clipRule:"clip-rule",colorInterpolation:"color-interpolation",colorInterpolationFilters:"color-interpolation-filters",colorProfile:"color-profile",colorRendering:"color-rendering",crossOrigin:"crossorigin",dataType:"datatype",dominantBaseline:"dominant-baseline",enableBackground:"enable-background",fillOpacity:"fill-opacity",fillRule:"fill-rule",floodColor:"flood-color",floodOpacity:"flood-opacity",fontFamily:"font-family",fontSize:"font-size",fontSizeAdjust:"font-size-adjust",fontStretch:"font-stretch",fontStyle:"font-style",fontVariant:"font-variant",fontWeight:"font-weight",glyphName:"glyph-name",glyphOrientationHorizontal:"glyph-orientation-horizontal",glyphOrientationVertical:"glyph-orientation-vertical",hrefLang:"hreflang",horizAdvX:"horiz-adv-x",horizOriginX:"horiz-origin-x",horizOriginY:"horiz-origin-y",imageRendering:"image-rendering",letterSpacing:"letter-spacing",lightingColor:"lighting-color",markerEnd:"marker-end",markerMid:"marker-mid",markerStart:"marker-start",navDown:"nav-down",navDownLeft:"nav-down-left",navDownRight:"nav-down-right",navLeft:"nav-left",navNext:"nav-next",navPrev:"nav-prev",navRight:"nav-right",navUp:"nav-up",navUpLeft:"nav-up-left",navUpRight:"nav-up-right",onAbort:"onabort",onActivate:"onactivate",onAfterPrint:"onafterprint",onBeforePrint:"onbeforeprint",onBegin:"onbegin",onCancel:"oncancel",onCanPlay:"oncanplay",onCanPlayThrough:"oncanplaythrough",onChange:"onchange",onClick:"onclick",onClose:"onclose",onCopy:"oncopy",onCueChange:"oncuechange",onCut:"oncut",onDblClick:"ondblclick",onDrag:"ondrag",onDragEnd:"ondragend",onDragEnter:"ondragenter",onDragExit:"ondragexit",onDragLeave:"ondragleave",onDragOver:"ondragover",onDragStart:"ondragstart",onDrop:"ondrop",onDurationChange:"ondurationchange",onEmptied:"onemptied",onEnd:"onend",onEnded:"onended",onError:"onerror",onFocus:"onfocus",onFocusIn:"onfocusin",onFocusOut:"onfocusout",onHashChange:"onhashchange",onInput:"oninput",onInvalid:"oninvalid",onKeyDown:"onkeydown",onKeyPress:"onkeypress",onKeyUp:"onkeyup",onLoad:"onload",onLoadedData:"onloadeddata",onLoadedMetadata:"onloadedmetadata",onLoadStart:"onloadstart",onMessage:"onmessage",onMouseDown:"onmousedown",onMouseEnter:"onmouseenter",onMouseLeave:"onmouseleave",onMouseMove:"onmousemove",onMouseOut:"onmouseout",onMouseOver:"onmouseover",onMouseUp:"onmouseup",onMouseWheel:"onmousewheel",onOffline:"onoffline",onOnline:"ononline",onPageHide:"onpagehide",onPageShow:"onpageshow",onPaste:"onpaste",onPause:"onpause",onPlay:"onplay",onPlaying:"onplaying",onPopState:"onpopstate",onProgress:"onprogress",onRateChange:"onratechange",onRepeat:"onrepeat",onReset:"onreset",onResize:"onresize",onScroll:"onscroll",onSeeked:"onseeked",onSeeking:"onseeking",onSelect:"onselect",onShow:"onshow",onStalled:"onstalled",onStorage:"onstorage",onSubmit:"onsubmit",onSuspend:"onsuspend",onTimeUpdate:"ontimeupdate",onToggle:"ontoggle",onUnload:"onunload",onVolumeChange:"onvolumechange",onWaiting:"onwaiting",onZoom:"onzoom",overlinePosition:"overline-position",overlineThickness:"overline-thickness",paintOrder:"paint-order",panose1:"panose-1",pointerEvents:"pointer-events",referrerPolicy:"referrerpolicy",renderingIntent:"rendering-intent",shapeRendering:"shape-rendering",stopColor:"stop-color",stopOpacity:"stop-opacity",strikethroughPosition:"strikethrough-position",strikethroughThickness:"strikethrough-thickness",strokeDashArray:"stroke-dasharray",strokeDashOffset:"stroke-dashoffset",strokeLineCap:"stroke-linecap",strokeLineJoin:"stroke-linejoin",strokeMiterLimit:"stroke-miterlimit",strokeOpacity:"stroke-opacity",strokeWidth:"stroke-width",tabIndex:"tabindex",textAnchor:"text-anchor",textDecoration:"text-decoration",textRendering:"text-rendering",transformOrigin:"transform-origin",typeOf:"typeof",underlinePosition:"underline-position",underlineThickness:"underline-thickness",unicodeBidi:"unicode-bidi",unicodeRange:"unicode-range",unitsPerEm:"units-per-em",vAlphabetic:"v-alphabetic",vHanging:"v-hanging",vIdeographic:"v-ideographic",vMathematical:"v-mathematical",vectorEffect:"vector-effect",vertAdvY:"vert-adv-y",vertOriginX:"vert-origin-x",vertOriginY:"vert-origin-y",wordSpacing:"word-spacing",writingMode:"writing-mode",xHeight:"x-height",playbackOrder:"playbackorder",timelineBegin:"timelinebegin"},properties:{about:j,accentHeight:B,accumulate:null,additive:null,alignmentBaseline:null,alphabetic:B,amplitude:B,arabicForm:null,ascent:B,attributeName:null,attributeType:null,azimuth:B,bandwidth:null,baselineShift:null,baseFrequency:null,baseProfile:null,bbox:null,begin:null,bias:B,by:null,calcMode:null,capHeight:B,className:P,clip:null,clipPath:null,clipPathUnits:null,clipRule:null,color:null,colorInterpolation:null,colorInterpolationFilters:null,colorProfile:null,colorRendering:null,content:null,contentScriptType:null,contentStyleType:null,crossOrigin:null,cursor:null,cx:null,cy:null,d:null,dataType:null,defaultAction:null,descent:B,diffuseConstant:B,direction:null,display:null,dur:null,divisor:B,dominantBaseline:null,download:C,dx:null,dy:null,edgeMode:null,editable:null,elevation:B,enableBackground:null,end:null,event:null,exponent:B,externalResourcesRequired:null,fill:null,fillOpacity:B,fillRule:null,filter:null,filterRes:null,filterUnits:null,floodColor:null,floodOpacity:null,focusable:null,focusHighlight:null,fontFamily:null,fontSize:null,fontSizeAdjust:null,fontStretch:null,fontStyle:null,fontVariant:null,fontWeight:null,format:null,fr:null,from:null,fx:null,fy:null,g1:I,g2:I,glyphName:I,glyphOrientationHorizontal:null,glyphOrientationVertical:null,glyphRef:null,gradientTransform:null,gradientUnits:null,handler:null,hanging:B,hatchContentUnits:null,hatchUnits:null,height:null,href:null,hrefLang:null,horizAdvX:B,horizOriginX:B,horizOriginY:B,id:null,ideographic:B,imageRendering:null,initialVisibility:null,in:null,in2:null,intercept:B,k:B,k1:B,k2:B,k3:B,k4:B,kernelMatrix:j,kernelUnitLength:null,keyPoints:null,keySplines:null,keyTimes:null,kerning:null,lang:null,lengthAdjust:null,letterSpacing:null,lightingColor:null,limitingConeAngle:B,local:null,markerEnd:null,markerMid:null,markerStart:null,markerHeight:null,markerUnits:null,markerWidth:null,mask:null,maskContentUnits:null,maskUnits:null,mathematical:null,max:null,media:null,mediaCharacterEncoding:null,mediaContentEncodings:null,mediaSize:B,mediaTime:null,method:null,min:null,mode:null,name:null,navDown:null,navDownLeft:null,navDownRight:null,navLeft:null,navNext:null,navPrev:null,navRight:null,navUp:null,navUpLeft:null,navUpRight:null,numOctaves:null,observer:null,offset:null,onAbort:null,onActivate:null,onAfterPrint:null,onBeforePrint:null,onBegin:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnd:null,onEnded:null,onError:null,onFocus:null,onFocusIn:null,onFocusOut:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadStart:null,onMessage:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onMouseWheel:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRepeat:null,onReset:null,onResize:null,onScroll:null,onSeeked:null,onSeeking:null,onSelect:null,onShow:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnload:null,onVolumeChange:null,onWaiting:null,onZoom:null,opacity:null,operator:null,order:null,orient:null,orientation:null,origin:null,overflow:null,overlay:null,overlinePosition:B,overlineThickness:B,paintOrder:null,panose1:null,path:null,pathLength:B,patternContentUnits:null,patternTransform:null,patternUnits:null,phase:null,ping:P,pitch:null,playbackOrder:null,pointerEvents:null,points:null,pointsAtX:B,pointsAtY:B,pointsAtZ:B,preserveAlpha:null,preserveAspectRatio:null,primitiveUnits:null,propagate:null,property:j,r:null,radius:null,referrerPolicy:null,refX:null,refY:null,rel:j,rev:j,renderingIntent:null,repeatCount:null,repeatDur:null,requiredExtensions:j,requiredFeatures:j,requiredFonts:j,requiredFormats:j,resource:null,restart:null,result:null,rotate:null,rx:null,ry:null,scale:null,seed:null,shapeRendering:null,side:null,slope:null,snapshotTime:null,specularConstant:B,specularExponent:B,spreadMethod:null,spacing:null,startOffset:null,stdDeviation:null,stemh:null,stemv:null,stitchTiles:null,stopColor:null,stopOpacity:null,strikethroughPosition:B,strikethroughThickness:B,string:null,stroke:null,strokeDashArray:j,strokeDashOffset:null,strokeLineCap:null,strokeLineJoin:null,strokeMiterLimit:B,strokeOpacity:B,strokeWidth:null,style:null,surfaceScale:B,syncBehavior:null,syncBehaviorDefault:null,syncMaster:null,syncTolerance:null,syncToleranceDefault:null,systemLanguage:j,tabIndex:B,tableValues:null,target:null,targetX:B,targetY:B,textAnchor:null,textDecoration:null,textRendering:null,textLength:null,timelineBegin:null,title:null,transformBehavior:null,type:null,typeOf:j,to:null,transform:null,transformOrigin:null,u1:null,u2:null,underlinePosition:B,underlineThickness:B,unicode:null,unicodeBidi:null,unicodeRange:null,unitsPerEm:B,values:null,vAlphabetic:B,vMathematical:B,vectorEffect:null,vHanging:B,vIdeographic:B,version:null,vertAdvY:B,vertOriginX:B,vertOriginY:B,viewBox:null,viewTarget:null,visibility:null,width:null,widths:null,wordSpacing:null,writingMode:null,x:null,x1:null,x2:null,xChannelSelector:null,xHeight:B,y:null,y1:null,y2:null,yChannelSelector:null,z:null,zoomAndPan:null},space:"svg",transform:N}),z=E({properties:{xLinkActuate:null,xLinkArcRole:null,xLinkHref:null,xLinkRole:null,xLinkShow:null,xLinkTitle:null,xLinkType:null},space:"xlink",transform(e,t){return"xlink:"+t.slice(5).toLowerCase()}}),H=E({attributes:{xmlnsxlink:"xmlns:xlink"},properties:{xmlnsXLink:null,xmlns:null},space:"xmlns",transform:F}),U=E({properties:{xmlBase:null,xmlLang:null,xmlSpace:null},space:"xml",transform(e,t){return"xml:"+t.slice(3).toLowerCase()}}),V=v([D,R,z,H,U],"html"),_=v([D,O,z,H,U],"svg"),G=/[A-Z]/g,q=/-[a-z]/g,$=/^data[-\w.:]+$/i;function Z(e){return"-"+e.toLowerCase()}function K(e){return e.charAt(1).toUpperCase()}const Q={classId:"classID",dataType:"datatype",itemId:"itemID",strokeDashArray:"strokeDasharray",strokeDashOffset:"strokeDashoffset",strokeLineCap:"strokeLinecap",strokeLineJoin:"strokeLinejoin",strokeMiterLimit:"strokeMiterlimit",typeOf:"typeof",xLinkActuate:"xlinkActuate",xLinkArcRole:"xlinkArcrole",xLinkHref:"xlinkHref",xLinkRole:"xlinkRole",xLinkShow:"xlinkShow",xLinkTitle:"xlinkTitle",xLinkType:"xlinkType",xmlnsXLink:"xmlnsXlink"};var X=n(35229);const W=J("end"),Y=J("start");function J(e){return function(t){const n=t&&t.position&&t.position[e]||{};if("number"==typeof n.line&&n.line>0&&"number"==typeof n.column&&n.column>0)return{line:n.line,column:n.column,offset:"number"==typeof n.offset&&n.offset>-1?n.offset:void 0}}}function ee(e){return e&&"object"==typeof e?"position"in e||"type"in e?ne(e.position):"start"in e||"end"in e?ne(e):"line"in e||"column"in e?te(e):"":""}function te(e){return ie(e&&e.line)+":"+ie(e&&e.column)}function ne(e){return te(e&&e.start)+"-"+te(e&&e.end)}function ie(e){return e&&"number"==typeof e?e:1}class se extends Error{constructor(e,t,n){super(),"string"==typeof t&&(n=t,t=void 0);let i="",s={},r=!1;if(t&&(s="line"in t&&"column"in t||"start"in t&&"end"in t?{place:t}:"type"in t?{ancestors:[t],place:t.position}:{...t}),"string"==typeof e?i=e:!s.cause&&e&&(r=!0,i=e.message,s.cause=e),!s.ruleId&&!s.source&&"string"==typeof n){const e=n.indexOf(":");-1===e?s.ruleId=n:(s.source=n.slice(0,e),s.ruleId=n.slice(e+1))}if(!s.place&&s.ancestors&&s.ancestors){const e=s.ancestors[s.ancestors.length-1];e&&(s.place=e.position)}const o=s.place&&"start"in s.place?s.place.start:s.place;this.ancestors=s.ancestors||void 0,this.cause=s.cause||void 0,this.column=o?o.column:void 0,this.fatal=void 0,this.file="",this.message=i,this.line=o?o.line:void 0,this.name=ee(s.place)||"1:1",this.place=s.place||void 0,this.reason=this.message,this.ruleId=s.ruleId||void 0,this.source=s.source||void 0,this.stack=r&&s.cause&&"string"==typeof s.cause.stack?s.cause.stack:"",this.actual=void 0,this.expected=void 0,this.note=void 0,this.url=void 0}}se.prototype.file="",se.prototype.name="",se.prototype.reason="",se.prototype.message="",se.prototype.stack="",se.prototype.column=void 0,se.prototype.line=void 0,se.prototype.ancestors=void 0,se.prototype.cause=void 0,se.prototype.fatal=void 0,se.prototype.place=void 0,se.prototype.ruleId=void 0,se.prototype.source=void 0;const re={}.hasOwnProperty,oe=new Map,ae=/[A-Z]/g,le=new Set(["table","tbody","thead","tfoot","tr"]),ce=new Set(["td","th"]),ue="https://github.com/syntax-tree/hast-util-to-jsx-runtime";function de(e,t){if(!t||void 0===t.Fragment)throw new TypeError("Expected `Fragment` in options");const n=t.filePath||void 0;let i;if(t.development){if("function"!=typeof t.jsxDEV)throw new TypeError("Expected `jsxDEV` in options when `development: true`");i=function(e,t){return n;function n(n,i,s,r){const o=Array.isArray(s.children),a=Y(n);return t(i,s,r,o,{columnNumber:a?a.column-1:void 0,fileName:e,lineNumber:a?a.line:void 0},void 0)}}(n,t.jsxDEV)}else{if("function"!=typeof t.jsx)throw new TypeError("Expected `jsx` in production options");if("function"!=typeof t.jsxs)throw new TypeError("Expected `jsxs` in production options");i=function(e,t,n){return i;function i(e,i,s,r){const o=Array.isArray(s.children)?n:t;return r?o(i,s,r):o(i,s)}}(0,t.jsx,t.jsxs)}const s={Fragment:t.Fragment,ancestors:[],components:t.components||{},create:i,elementAttributeNameCase:t.elementAttributeNameCase||"react",evaluater:t.createEvaluater?t.createEvaluater():void 0,filePath:n,ignoreInvalidStyle:t.ignoreInvalidStyle||!1,passKeys:!1!==t.passKeys,passNode:t.passNode||!1,schema:"svg"===t.space?_:V,stylePropertyNameCase:t.stylePropertyNameCase||"dom",tableCellAlignToStyle:!1!==t.tableCellAlignToStyle},r=he(s,e,void 0);return r&&"string"!=typeof r?r:s.create(e,s.Fragment,{children:r||void 0},void 0)}function he(e,t,n){return"element"===t.type?function(e,t,n){const i=e.schema;let s=i;"svg"===t.tagName.toLowerCase()&&"html"===i.space&&(s=_,e.schema=s);e.ancestors.push(t);const r=ye(e,t.tagName,!1),o=function(e,t){const n={};let i,s;for(s in t.properties)if("children"!==s&&re.call(t.properties,s)){const r=ge(e,s,t.properties[s]);if(r){const[s,o]=r;e.tableCellAlignToStyle&&"align"===s&&"string"==typeof o&&ce.has(t.tagName)?i=o:n[s]=o}}if(i){(n.style||(n.style={}))["css"===e.stylePropertyNameCase?"text-align":"textAlign"]=i}return n}(e,t);let a=fe(e,t);le.has(t.tagName)&&(a=a.filter(function(e){return"string"!=typeof e||!("object"==typeof(t=e)?"text"===t.type&&g(t.value):g(t));var t}));return pe(e,o,r,t),me(o,a),e.ancestors.pop(),e.schema=i,e.create(t,r,o,n)}(e,t,n):"mdxFlowExpression"===t.type||"mdxTextExpression"===t.type?function(e,t){if(t.data&&t.data.estree&&e.evaluater){const n=t.data.estree.body[0];return n.type,e.evaluater.evaluateExpression(n.expression)}ve(e,t.position)}(e,t):"mdxJsxFlowElement"===t.type||"mdxJsxTextElement"===t.type?function(e,t,n){const i=e.schema;let s=i;"svg"===t.name&&"html"===i.space&&(s=_,e.schema=s);e.ancestors.push(t);const r=null===t.name?e.Fragment:ye(e,t.name,!0),o=function(e,t){const n={};for(const i of t.attributes)if("mdxJsxExpressionAttribute"===i.type)if(i.data&&i.data.estree&&e.evaluater){const t=i.data.estree.body[0];c(t.type);const s=t.expression;c(s.type);const r=s.properties[0];c(r.type),Object.assign(n,e.evaluater.evaluateExpression(r.argument))}else ve(e,t.position);else{const s=i.name;let r;if(i.value&&"object"==typeof i.value)if(i.value.data&&i.value.data.estree&&e.evaluater){const t=i.value.data.estree.body[0];c(t.type),r=e.evaluater.evaluateExpression(t.expression)}else ve(e,t.position);else r=null===i.value||i.value;n[s]=r}return n}(e,t),a=fe(e,t);return pe(e,o,r,t),me(o,a),e.ancestors.pop(),e.schema=i,e.create(t,r,o,n)}(e,t,n):"mdxjsEsm"===t.type?function(e,t){if(t.data&&t.data.estree&&e.evaluater)return e.evaluater.evaluateProgram(t.data.estree);ve(e,t.position)}(e,t):"root"===t.type?function(e,t,n){const i={};return me(i,fe(e,t)),e.create(t,e.Fragment,i,n)}(e,t,n):"text"===t.type?function(e,t){return t.value}(0,t):void 0}function pe(e,t,n,i){"string"!=typeof n&&n!==e.Fragment&&e.passNode&&(t.node=i)}function me(e,t){if(t.length>0){const n=t.length>1?t:t[0];n&&(e.children=n)}}function fe(e,t){const n=[];let i=-1;const s=e.passKeys?new Map:oe;for(;++i<t.children.length;){const r=t.children[i];let o;if(e.passKeys){const e="element"===r.type?r.tagName:"mdxJsxFlowElement"===r.type||"mdxJsxTextElement"===r.type?r.name:void 0;if(e){const t=s.get(e)||0;o=e+"-"+t,s.set(e,t+1)}}const a=he(e,r,o);void 0!==a&&n.push(a)}return n}function ge(e,t,n){const i=function(e,t){const n=b(t);let i=t,s=x;if(n in e.normal)return e.property[e.normal[n]];if(n.length>4&&"data"===n.slice(0,4)&&$.test(t)){if("-"===t.charAt(4)){const e=t.slice(5).replace(q,K);i="data"+e.charAt(0).toUpperCase()+e.slice(1)}else{const e=t.slice(4);if(!q.test(e)){let n=e.replace(G,Z);"-"!==n.charAt(0)&&(n="-"+n),t="data"+n}}s=M}return new s(i,t)}(e.schema,t);if(!(null==n||"number"==typeof n&&Number.isNaN(n))){if(Array.isArray(n)&&(n=i.commaSeparated?function(e,t){const n=t||{};return(""===e[e.length-1]?[...e,""]:e).join((n.padRight?" ":"")+","+(!1===n.padLeft?"":" ")).trim()}(n):n.join(" ").trim()),"style"===i.property){let t="object"==typeof n?n:function(e,t){try{return X(t,{reactCompat:!0})}catch(n){if(e.ignoreInvalidStyle)return{};const t=n,i=new se("Cannot parse `style` attribute",{ancestors:e.ancestors,cause:t,ruleId:"style",source:"hast-util-to-jsx-runtime"});throw i.file=e.filePath||void 0,i.url=ue+"#cannot-parse-style-attribute",i}}(e,String(n));return"css"===e.stylePropertyNameCase&&(t=function(e){const t={};let n;for(n in e)re.call(e,n)&&(t[be(n)]=e[n]);return t}(t)),["style",t]}return["react"===e.elementAttributeNameCase&&i.space?Q[i.property]||i.property:i.attribute,n]}}function ye(e,t,n){let i;if(n)if(t.includes(".")){const e=t.split(".");let n,s=-1;for(;++s<e.length;){const t=m(e[s])?{type:"Identifier",name:e[s]}:{type:"Literal",value:e[s]};n=n?{type:"MemberExpression",object:n,property:t,computed:Boolean(s&&"Literal"===t.type),optional:!1}:t}i=n}else i=m(t)&&!/^[a-z]/.test(t)?{type:"Identifier",name:t}:{type:"Literal",value:t};else i={type:"Literal",value:t};if("Literal"===i.type){const t=i.value;return re.call(e.components,t)?e.components[t]:t}if(e.evaluater)return e.evaluater.evaluateExpression(i);ve(e)}function ve(e,t){const n=new se("Cannot handle MDX estrees without `createEvaluater`",{ancestors:e.ancestors,place:t,ruleId:"mdx-estree",source:"hast-util-to-jsx-runtime"});throw n.file=e.filePath||void 0,n.url=ue+"#cannot-handle-mdx-estrees-without-createevaluater",n}function be(e){let t=e.replace(ae,xe);return"ms-"===t.slice(0,3)&&(t="-"+t),t}function xe(e){return"-"+e.toLowerCase()}const Se={action:["form"],cite:["blockquote","del","ins","q"],data:["object"],formAction:["button","input"],href:["a","area","base","link"],icon:["menuitem"],itemId:null,manifest:["html"],ping:["a","area"],poster:["video"],src:["audio","embed","iframe","img","input","script","source","track","video"]},Ce={};function we(e,t){const n=t||Ce;return ke(e,"boolean"!=typeof n.includeImageAlt||n.includeImageAlt,"boolean"!=typeof n.includeHtml||n.includeHtml)}function ke(e,t,n){if(function(e){return Boolean(e&&"object"==typeof e)}(e)){if("value"in e)return"html"!==e.type||n?e.value:"";if(t&&"alt"in e&&e.alt)return e.alt;if("children"in e)return Be(e.children,t,n)}return Array.isArray(e)?Be(e,t,n):""}function Be(e,t,n){const i=[];let s=-1;for(;++s<e.length;)i[s]=ke(e[s],t,n);return i.join("")}function Pe(e,t,n,i){const s=e.length;let r,o=0;if(t=t<0?-t>s?0:s+t:t>s?s:t,n=n>0?n:0,i.length<1e4)r=Array.from(i),r.unshift(t,n),e.splice(...r);else for(n&&e.splice(t,n);o<i.length;)r=i.slice(o,o+1e4),r.unshift(t,0),e.splice(...r),o+=1e4,t+=1e4}function Ie(e,t){return e.length>0?(Pe(e,e.length,0,t),e):t}class je{constructor(e){this.left=e?[...e]:[],this.right=[]}get(e){if(e<0||e>=this.left.length+this.right.length)throw new RangeError("Cannot access index `"+e+"` in a splice buffer of size `"+(this.left.length+this.right.length)+"`");return e<this.left.length?this.left[e]:this.right[this.right.length-e+this.left.length-1]}get length(){return this.left.length+this.right.length}shift(){return this.setCursor(0),this.right.pop()}slice(e,t){const n=null==t?Number.POSITIVE_INFINITY:t;return n<this.left.length?this.left.slice(e,n):e>this.left.length?this.right.slice(this.right.length-n+this.left.length,this.right.length-e+this.left.length).reverse():this.left.slice(e).concat(this.right.slice(this.right.length-n+this.left.length).reverse())}splice(e,t,n){const i=t||0;this.setCursor(Math.trunc(e));const s=this.right.splice(this.right.length-i,Number.POSITIVE_INFINITY);return n&&Te(this.left,n),s.reverse()}pop(){return this.setCursor(Number.POSITIVE_INFINITY),this.left.pop()}push(e){this.setCursor(Number.POSITIVE_INFINITY),this.left.push(e)}pushMany(e){this.setCursor(Number.POSITIVE_INFINITY),Te(this.left,e)}unshift(e){this.setCursor(0),this.right.push(e)}unshiftMany(e){this.setCursor(0),Te(this.right,e.reverse())}setCursor(e){if(!(e===this.left.length||e>this.left.length&&0===this.right.length||e<0&&0===this.left.length))if(e<this.left.length){const t=this.left.splice(e,Number.POSITIVE_INFINITY);Te(this.right,t.reverse())}else{const t=this.right.splice(this.left.length+this.right.length-e,Number.POSITIVE_INFINITY);Te(this.left,t.reverse())}}}function Te(e,t){let n=0;if(t.length<1e4)e.push(...t);else for(;n<t.length;)e.push(...t.slice(n,n+1e4)),n+=1e4}function Ae(e){const t={};let n,i,s,r,o,a,l,c=-1;const u=new je(e);for(;++c<u.length;){for(;c in t;)c=t[c];if(n=u.get(c),c&&"chunkFlow"===n[1].type&&"listItemPrefix"===u.get(c-1)[1].type&&(a=n[1]._tokenizer.events,s=0,s<a.length&&"lineEndingBlank"===a[s][1].type&&(s+=2),s<a.length&&"content"===a[s][1].type))for(;++s<a.length&&"content"!==a[s][1].type;)"chunkText"===a[s][1].type&&(a[s][1]._isInFirstContentOfListItem=!0,s++);if("enter"===n[0])n[1].contentType&&(Object.assign(t,Me(u,c)),c=t[c],l=!0);else if(n[1]._container){for(s=c,i=void 0;s--;)if(r=u.get(s),"lineEnding"===r[1].type||"lineEndingBlank"===r[1].type)"enter"===r[0]&&(i&&(u.get(i)[1].type="lineEndingBlank"),r[1].type="lineEnding",i=s);else if("linePrefix"!==r[1].type&&"listItemIndent"!==r[1].type)break;i&&(n[1].end={...u.get(i)[1].start},o=u.slice(i,c),o.unshift(n),u.splice(i,c-i+1,o))}}return Pe(e,0,Number.POSITIVE_INFINITY,u.slice(0)),!l}function Me(e,t){const n=e.get(t)[1],i=e.get(t)[2];let s=t-1;const r=[];let o=n._tokenizer;o||(o=i.parser[n.contentType](n.start),n._contentTypeTextTrailing&&(o._contentTypeTextTrailing=!0));const a=o.events,l=[],c={};let u,d,h=-1,p=n,m=0,f=0;const g=[f];for(;p;){for(;e.get(++s)[1]!==p;);r.push(s),p._tokenizer||(u=i.sliceStream(p),p.next||u.push(null),d&&o.defineSkip(p.start),p._isInFirstContentOfListItem&&(o._gfmTasklistFirstContentOfListItem=!0),o.write(u),p._isInFirstContentOfListItem&&(o._gfmTasklistFirstContentOfListItem=void 0)),d=p,p=p.next}for(p=n;++h<a.length;)"exit"===a[h][0]&&"enter"===a[h-1][0]&&a[h][1].type===a[h-1][1].type&&a[h][1].start.line!==a[h][1].end.line&&(f=h+1,g.push(f),p._tokenizer=void 0,p.previous=void 0,p=p.next);for(o.events=[],p?(p._tokenizer=void 0,p.previous=void 0):g.pop(),h=g.length;h--;){const t=a.slice(g[h],g[h+1]),n=r.pop();l.push([n,n+t.length-1]),e.splice(n,2,t)}for(l.reverse(),h=-1;++h<l.length;)c[m+l[h][0]]=m+l[h][1],m+=l[h][1]-l[h][0]-1;return c}const Le={}.hasOwnProperty;function Ee(e){const t={};let n=-1;for(;++n<e.length;)De(t,e[n]);return t}function De(e,t){let n;for(n in t){const i=(Le.call(e,n)?e[n]:void 0)||(e[n]={}),s=t[n];let r;if(s)for(r in s){Le.call(i,r)||(i[r]=[]);const e=s[r];Ne(i[r],Array.isArray(e)?e:e?[e]:[])}}}function Ne(e,t){let n=-1;const i=[];for(;++n<t.length;)("after"===t[n].add?e:i).push(t[n]);Pe(e,0,0,i)}const Fe=Ke(/[A-Za-z]/),Re=Ke(/[\dA-Za-z]/),Oe=Ke(/[#-'*+\--9=?A-Z^-~]/);function ze(e){return null!==e&&(e<32||127===e)}const He=Ke(/\d/),Ue=Ke(/[\dA-Fa-f]/),Ve=Ke(/[!-/:-@[-`{-~]/);function _e(e){return null!==e&&e<-2}function Ge(e){return null!==e&&(e<0||32===e)}function qe(e){return-2===e||-1===e||32===e}const $e=Ke(/\p{P}|\p{S}/u),Ze=Ke(/\s/);function Ke(e){return function(t){return null!==t&&t>-1&&e.test(String.fromCharCode(t))}}function Qe(e,t,n,i){const s=i?i-1:Number.POSITIVE_INFINITY;let r=0;return function(i){if(qe(i))return e.enter(n),o(i);return t(i)};function o(i){return qe(i)&&r++<s?(e.consume(i),o):(e.exit(n),t(i))}}const Xe={tokenize:function(e){const t=e.attempt(this.parser.constructs.contentInitial,function(n){if(null===n)return void e.consume(n);return e.enter("lineEnding"),e.consume(n),e.exit("lineEnding"),Qe(e,t,"linePrefix")},function(t){return e.enter("paragraph"),i(t)});let n;return t;function i(t){const i=e.enter("chunkText",{contentType:"text",previous:n});return n&&(n.next=i),n=i,s(t)}function s(t){return null===t?(e.exit("chunkText"),e.exit("paragraph"),void e.consume(t)):_e(t)?(e.consume(t),e.exit("chunkText"),i):(e.consume(t),s)}}};const We={tokenize:function(e){const t=this,n=[];let i,s,r,o=0;return a;function a(i){if(o<n.length){const s=n[o];return t.containerState=s[1],e.attempt(s[0].continuation,l,c)(i)}return c(i)}function l(e){if(o++,t.containerState._closeFlow){t.containerState._closeFlow=void 0,i&&v();const n=t.events.length;let s,r=n;for(;r--;)if("exit"===t.events[r][0]&&"chunkFlow"===t.events[r][1].type){s=t.events[r][1].end;break}y(o);let a=n;for(;a<t.events.length;)t.events[a][1].end={...s},a++;return Pe(t.events,r+1,0,t.events.slice(n)),t.events.length=a,c(e)}return a(e)}function c(s){if(o===n.length){if(!i)return h(s);if(i.currentConstruct&&i.currentConstruct.concrete)return m(s);t.interrupt=Boolean(i.currentConstruct&&!i._gfmTableDynamicInterruptHack)}return t.containerState={},e.check(Ye,u,d)(s)}function u(e){return i&&v(),y(o),h(e)}function d(e){return t.parser.lazy[t.now().line]=o!==n.length,r=t.now().offset,m(e)}function h(n){return t.containerState={},e.attempt(Ye,p,m)(n)}function p(e){return o++,n.push([t.currentConstruct,t.containerState]),h(e)}function m(n){return null===n?(i&&v(),y(0),void e.consume(n)):(i=i||t.parser.flow(t.now()),e.enter("chunkFlow",{_tokenizer:i,contentType:"flow",previous:s}),f(n))}function f(n){return null===n?(g(e.exit("chunkFlow"),!0),y(0),void e.consume(n)):_e(n)?(e.consume(n),g(e.exit("chunkFlow")),o=0,t.interrupt=void 0,a):(e.consume(n),f)}function g(e,n){const a=t.sliceStream(e);if(n&&a.push(null),e.previous=s,s&&(s.next=e),s=e,i.defineSkip(e.start),i.write(a),t.parser.lazy[e.start.line]){let e=i.events.length;for(;e--;)if(i.events[e][1].start.offset<r&&(!i.events[e][1].end||i.events[e][1].end.offset>r))return;const n=t.events.length;let s,a,l=n;for(;l--;)if("exit"===t.events[l][0]&&"chunkFlow"===t.events[l][1].type){if(s){a=t.events[l][1].end;break}s=!0}for(y(o),e=n;e<t.events.length;)t.events[e][1].end={...a},e++;Pe(t.events,l+1,0,t.events.slice(n)),t.events.length=e}}function y(i){let s=n.length;for(;s-- >i;){const i=n[s];t.containerState=i[1],i[0].exit.call(t,e)}n.length=i}function v(){i.write([null]),s=void 0,i=void 0,t.containerState._closeFlow=void 0}}},Ye={tokenize:function(e,t,n){return Qe(e,e.attempt(this.parser.constructs.document,t,n),"linePrefix",this.parser.constructs.disable.null.includes("codeIndented")?void 0:4)}};const Je={partial:!0,tokenize:function(e,t,n){return function(t){return qe(t)?Qe(e,i,"linePrefix")(t):i(t)};function i(e){return null===e||_e(e)?t(e):n(e)}}};const et={resolve:function(e){return Ae(e),e},tokenize:function(e,t){let n;return function(t){return e.enter("content"),n=e.enter("chunkContent",{contentType:"content"}),i(t)};function i(t){return null===t?s(t):_e(t)?e.check(tt,r,s)(t):(e.consume(t),i)}function s(n){return e.exit("chunkContent"),e.exit("content"),t(n)}function r(t){return e.consume(t),e.exit("chunkContent"),n.next=e.enter("chunkContent",{contentType:"content",previous:n}),n=n.next,i}}},tt={partial:!0,tokenize:function(e,t,n){const i=this;return function(t){return e.exit("chunkContent"),e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),Qe(e,s,"linePrefix")};function s(s){if(null===s||_e(s))return n(s);const r=i.events[i.events.length-1];return!i.parser.constructs.disable.null.includes("codeIndented")&&r&&"linePrefix"===r[1].type&&r[2].sliceSerialize(r[1],!0).length>=4?t(s):e.interrupt(i.parser.constructs.flow,n,t)(s)}}};const nt={tokenize:function(e){const t=this,n=e.attempt(Je,function(i){if(null===i)return void e.consume(i);return e.enter("lineEndingBlank"),e.consume(i),e.exit("lineEndingBlank"),t.currentConstruct=void 0,n},e.attempt(this.parser.constructs.flowInitial,i,Qe(e,e.attempt(this.parser.constructs.flow,i,e.attempt(et,i)),"linePrefix")));return n;function i(i){if(null!==i)return e.enter("lineEnding"),e.consume(i),e.exit("lineEnding"),t.currentConstruct=void 0,n;e.consume(i)}}};const it={resolveAll:at()},st=ot("string"),rt=ot("text");function ot(e){return{resolveAll:at("text"===e?lt:void 0),tokenize:function(t){const n=this,i=this.parser.constructs[e],s=t.attempt(i,r,o);return r;function r(e){return l(e)?s(e):o(e)}function o(e){if(null!==e)return t.enter("data"),t.consume(e),a;t.consume(e)}function a(e){return l(e)?(t.exit("data"),s(e)):(t.consume(e),a)}function l(e){if(null===e)return!0;const t=i[e];let s=-1;if(t)for(;++s<t.length;){const e=t[s];if(!e.previous||e.previous.call(n,n.previous))return!0}return!1}}}}function at(e){return function(t,n){let i,s=-1;for(;++s<=t.length;)void 0===i?t[s]&&"data"===t[s][1].type&&(i=s,s++):t[s]&&"data"===t[s][1].type||(s!==i+2&&(t[i][1].end=t[s-1][1].end,t.splice(i+2,s-i-2),s=i+2),i=void 0);return e?e(t,n):t}}function lt(e,t){let n=0;for(;++n<=e.length;)if((n===e.length||"lineEnding"===e[n][1].type)&&"data"===e[n-1][1].type){const i=e[n-1][1],s=t.sliceStream(i);let r,o=s.length,a=-1,l=0;for(;o--;){const e=s[o];if("string"==typeof e){for(a=e.length;32===e.charCodeAt(a-1);)l++,a--;if(a)break;a=-1}else if(-2===e)r=!0,l++;else if(-1!==e){o++;break}}if(t._contentTypeTextTrailing&&n===e.length&&(l=0),l){const s={type:n===e.length||r||l<2?"lineSuffix":"hardBreakTrailing",start:{_bufferIndex:o?a:i.start._bufferIndex+a,_index:i.start._index+o,line:i.end.line,column:i.end.column-l,offset:i.end.offset-l},end:{...i.end}};i.end={...s.start},i.start.offset===i.end.offset?Object.assign(i,s):(e.splice(n,0,["enter",s,t],["exit",s,t]),n+=2)}n++}return e}const ct={name:"thematicBreak",tokenize:function(e,t,n){let i,s=0;return function(t){return e.enter("thematicBreak"),function(e){return i=e,r(e)}(t)};function r(r){return r===i?(e.enter("thematicBreakSequence"),o(r)):s>=3&&(null===r||_e(r))?(e.exit("thematicBreak"),t(r)):n(r)}function o(t){return t===i?(e.consume(t),s++,o):(e.exit("thematicBreakSequence"),qe(t)?Qe(e,r,"whitespace")(t):r(t))}}};const ut={continuation:{tokenize:function(e,t,n){const i=this;return i.containerState._closeFlow=void 0,e.check(Je,s,r);function s(n){return i.containerState.furtherBlankLines=i.containerState.furtherBlankLines||i.containerState.initialBlankLine,Qe(e,t,"listItemIndent",i.containerState.size+1)(n)}function r(n){return i.containerState.furtherBlankLines||!qe(n)?(i.containerState.furtherBlankLines=void 0,i.containerState.initialBlankLine=void 0,o(n)):(i.containerState.furtherBlankLines=void 0,i.containerState.initialBlankLine=void 0,e.attempt(ht,t,o)(n))}function o(s){return i.containerState._closeFlow=!0,i.interrupt=void 0,Qe(e,e.attempt(ut,t,n),"linePrefix",i.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(s)}}},exit:function(e){e.exit(this.containerState.type)},name:"list",tokenize:function(e,t,n){const i=this,s=i.events[i.events.length-1];let r=s&&"linePrefix"===s[1].type?s[2].sliceSerialize(s[1],!0).length:0,o=0;return function(t){const s=i.containerState.type||(42===t||43===t||45===t?"listUnordered":"listOrdered");if("listUnordered"===s?!i.containerState.marker||t===i.containerState.marker:He(t)){if(i.containerState.type||(i.containerState.type=s,e.enter(s,{_container:!0})),"listUnordered"===s)return e.enter("listItemPrefix"),42===t||45===t?e.check(ct,n,l)(t):l(t);if(!i.interrupt||49===t)return e.enter("listItemPrefix"),e.enter("listItemValue"),a(t)}return n(t)};function a(t){return He(t)&&++o<10?(e.consume(t),a):(!i.interrupt||o<2)&&(i.containerState.marker?t===i.containerState.marker:41===t||46===t)?(e.exit("listItemValue"),l(t)):n(t)}function l(t){return e.enter("listItemMarker"),e.consume(t),e.exit("listItemMarker"),i.containerState.marker=i.containerState.marker||t,e.check(Je,i.interrupt?n:c,e.attempt(dt,d,u))}function c(e){return i.containerState.initialBlankLine=!0,r++,d(e)}function u(t){return qe(t)?(e.enter("listItemPrefixWhitespace"),e.consume(t),e.exit("listItemPrefixWhitespace"),d):n(t)}function d(n){return i.containerState.size=r+i.sliceSerialize(e.exit("listItemPrefix"),!0).length,t(n)}}},dt={partial:!0,tokenize:function(e,t,n){const i=this;return Qe(e,function(e){const s=i.events[i.events.length-1];return!qe(e)&&s&&"listItemPrefixWhitespace"===s[1].type?t(e):n(e)},"listItemPrefixWhitespace",i.parser.constructs.disable.null.includes("codeIndented")?void 0:5)}},ht={partial:!0,tokenize:function(e,t,n){const i=this;return Qe(e,function(e){const s=i.events[i.events.length-1];return s&&"listItemIndent"===s[1].type&&s[2].sliceSerialize(s[1],!0).length===i.containerState.size?t(e):n(e)},"listItemIndent",i.containerState.size+1)}};const pt={continuation:{tokenize:function(e,t,n){const i=this;return function(t){if(qe(t))return Qe(e,s,"linePrefix",i.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(t);return s(t)};function s(i){return e.attempt(pt,t,n)(i)}}},exit:function(e){e.exit("blockQuote")},name:"blockQuote",tokenize:function(e,t,n){const i=this;return function(t){if(62===t){const n=i.containerState;return n.open||(e.enter("blockQuote",{_container:!0}),n.open=!0),e.enter("blockQuotePrefix"),e.enter("blockQuoteMarker"),e.consume(t),e.exit("blockQuoteMarker"),s}return n(t)};function s(n){return qe(n)?(e.enter("blockQuotePrefixWhitespace"),e.consume(n),e.exit("blockQuotePrefixWhitespace"),e.exit("blockQuotePrefix"),t):(e.exit("blockQuotePrefix"),t(n))}}};function mt(e,t,n,i,s,r,o,a,l){const c=l||Number.POSITIVE_INFINITY;let u=0;return function(t){if(60===t)return e.enter(i),e.enter(s),e.enter(r),e.consume(t),e.exit(r),d;if(null===t||32===t||41===t||ze(t))return n(t);return e.enter(i),e.enter(o),e.enter(a),e.enter("chunkString",{contentType:"string"}),m(t)};function d(n){return 62===n?(e.enter(r),e.consume(n),e.exit(r),e.exit(s),e.exit(i),t):(e.enter(a),e.enter("chunkString",{contentType:"string"}),h(n))}function h(t){return 62===t?(e.exit("chunkString"),e.exit(a),d(t)):null===t||60===t||_e(t)?n(t):(e.consume(t),92===t?p:h)}function p(t){return 60===t||62===t||92===t?(e.consume(t),h):h(t)}function m(s){return u||null!==s&&41!==s&&!Ge(s)?u<c&&40===s?(e.consume(s),u++,m):41===s?(e.consume(s),u--,m):null===s||32===s||40===s||ze(s)?n(s):(e.consume(s),92===s?f:m):(e.exit("chunkString"),e.exit(a),e.exit(o),e.exit(i),t(s))}function f(t){return 40===t||41===t||92===t?(e.consume(t),m):m(t)}}function ft(e,t,n,i,s,r){const o=this;let a,l=0;return function(t){return e.enter(i),e.enter(s),e.consume(t),e.exit(s),e.enter(r),c};function c(d){return l>999||null===d||91===d||93===d&&!a||94===d&&!l&&"_hiddenFootnoteSupport"in o.parser.constructs?n(d):93===d?(e.exit(r),e.enter(s),e.consume(d),e.exit(s),e.exit(i),t):_e(d)?(e.enter("lineEnding"),e.consume(d),e.exit("lineEnding"),c):(e.enter("chunkString",{contentType:"string"}),u(d))}function u(t){return null===t||91===t||93===t||_e(t)||l++>999?(e.exit("chunkString"),c(t)):(e.consume(t),a||(a=!qe(t)),92===t?d:u)}function d(t){return 91===t||92===t||93===t?(e.consume(t),l++,u):u(t)}}function gt(e,t,n,i,s,r){let o;return function(t){if(34===t||39===t||40===t)return e.enter(i),e.enter(s),e.consume(t),e.exit(s),o=40===t?41:t,a;return n(t)};function a(n){return n===o?(e.enter(s),e.consume(n),e.exit(s),e.exit(i),t):(e.enter(r),l(n))}function l(t){return t===o?(e.exit(r),a(o)):null===t?n(t):_e(t)?(e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),Qe(e,l,"linePrefix")):(e.enter("chunkString",{contentType:"string"}),c(t))}function c(t){return t===o||null===t||_e(t)?(e.exit("chunkString"),l(t)):(e.consume(t),92===t?u:c)}function u(t){return t===o||92===t?(e.consume(t),c):c(t)}}function yt(e,t){let n;return function i(s){if(_e(s))return e.enter("lineEnding"),e.consume(s),e.exit("lineEnding"),n=!0,i;if(qe(s))return Qe(e,i,n?"linePrefix":"lineSuffix")(s);return t(s)}}function vt(e){return e.replace(/[\t\n\r ]+/g," ").replace(/^ | $/g,"").toLowerCase().toUpperCase()}const bt={name:"definition",tokenize:function(e,t,n){const i=this;let s;return function(t){return e.enter("definition"),function(t){return ft.call(i,e,r,n,"definitionLabel","definitionLabelMarker","definitionLabelString")(t)}(t)};function r(t){return s=vt(i.sliceSerialize(i.events[i.events.length-1][1]).slice(1,-1)),58===t?(e.enter("definitionMarker"),e.consume(t),e.exit("definitionMarker"),o):n(t)}function o(t){return Ge(t)?yt(e,a)(t):a(t)}function a(t){return mt(e,l,n,"definitionDestination","definitionDestinationLiteral","definitionDestinationLiteralMarker","definitionDestinationRaw","definitionDestinationString")(t)}function l(t){return e.attempt(xt,c,c)(t)}function c(t){return qe(t)?Qe(e,u,"whitespace")(t):u(t)}function u(r){return null===r||_e(r)?(e.exit("definition"),i.parser.defined.push(s),t(r)):n(r)}}},xt={partial:!0,tokenize:function(e,t,n){return function(t){return Ge(t)?yt(e,i)(t):n(t)};function i(t){return gt(e,s,n,"definitionTitle","definitionTitleMarker","definitionTitleString")(t)}function s(t){return qe(t)?Qe(e,r,"whitespace")(t):r(t)}function r(e){return null===e||_e(e)?t(e):n(e)}}};const St={name:"codeIndented",tokenize:function(e,t,n){const i=this;return function(t){return e.enter("codeIndented"),Qe(e,s,"linePrefix",5)(t)};function s(e){const t=i.events[i.events.length-1];return t&&"linePrefix"===t[1].type&&t[2].sliceSerialize(t[1],!0).length>=4?r(e):n(e)}function r(t){return null===t?a(t):_e(t)?e.attempt(Ct,r,a)(t):(e.enter("codeFlowValue"),o(t))}function o(t){return null===t||_e(t)?(e.exit("codeFlowValue"),r(t)):(e.consume(t),o)}function a(n){return e.exit("codeIndented"),t(n)}}},Ct={partial:!0,tokenize:function(e,t,n){const i=this;return s;function s(t){return i.parser.lazy[i.now().line]?n(t):_e(t)?(e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),s):Qe(e,r,"linePrefix",5)(t)}function r(e){const r=i.events[i.events.length-1];return r&&"linePrefix"===r[1].type&&r[2].sliceSerialize(r[1],!0).length>=4?t(e):_e(e)?s(e):n(e)}}};const wt={name:"headingAtx",resolve:function(e,t){let n,i,s=e.length-2,r=3;"whitespace"===e[r][1].type&&(r+=2);s-2>r&&"whitespace"===e[s][1].type&&(s-=2);"atxHeadingSequence"===e[s][1].type&&(r===s-1||s-4>r&&"whitespace"===e[s-2][1].type)&&(s-=r+1===s?2:4);s>r&&(n={type:"atxHeadingText",start:e[r][1].start,end:e[s][1].end},i={type:"chunkText",start:e[r][1].start,end:e[s][1].end,contentType:"text"},Pe(e,r,s-r+1,[["enter",n,t],["enter",i,t],["exit",i,t],["exit",n,t]]));return e},tokenize:function(e,t,n){let i=0;return function(t){return e.enter("atxHeading"),function(t){return e.enter("atxHeadingSequence"),s(t)}(t)};function s(t){return 35===t&&i++<6?(e.consume(t),s):null===t||Ge(t)?(e.exit("atxHeadingSequence"),r(t)):n(t)}function r(n){return 35===n?(e.enter("atxHeadingSequence"),o(n)):null===n||_e(n)?(e.exit("atxHeading"),t(n)):qe(n)?Qe(e,r,"whitespace")(n):(e.enter("atxHeadingText"),a(n))}function o(t){return 35===t?(e.consume(t),o):(e.exit("atxHeadingSequence"),r(t))}function a(t){return null===t||35===t||Ge(t)?(e.exit("atxHeadingText"),r(t)):(e.consume(t),a)}}};const kt={name:"setextUnderline",resolveTo:function(e,t){let n,i,s,r=e.length;for(;r--;)if("enter"===e[r][0]){if("content"===e[r][1].type){n=r;break}"paragraph"===e[r][1].type&&(i=r)}else"content"===e[r][1].type&&e.splice(r,1),s||"definition"!==e[r][1].type||(s=r);const o={type:"setextHeading",start:{...e[n][1].start},end:{...e[e.length-1][1].end}};e[i][1].type="setextHeadingText",s?(e.splice(i,0,["enter",o,t]),e.splice(s+1,0,["exit",e[n][1],t]),e[n][1].end={...e[s][1].end}):e[n][1]=o;return e.push(["exit",o,t]),e},tokenize:function(e,t,n){const i=this;let s;return function(t){let o,a=i.events.length;for(;a--;)if("lineEnding"!==i.events[a][1].type&&"linePrefix"!==i.events[a][1].type&&"content"!==i.events[a][1].type){o="paragraph"===i.events[a][1].type;break}if(!i.parser.lazy[i.now().line]&&(i.interrupt||o))return e.enter("setextHeadingLine"),s=t,function(t){return e.enter("setextHeadingLineSequence"),r(t)}(t);return n(t)};function r(t){return t===s?(e.consume(t),r):(e.exit("setextHeadingLineSequence"),qe(t)?Qe(e,o,"lineSuffix")(t):o(t))}function o(i){return null===i||_e(i)?(e.exit("setextHeadingLine"),t(i)):n(i)}}};const Bt=["address","article","aside","base","basefont","blockquote","body","caption","center","col","colgroup","dd","details","dialog","dir","div","dl","dt","fieldset","figcaption","figure","footer","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","header","hr","html","iframe","legend","li","link","main","menu","menuitem","nav","noframes","ol","optgroup","option","p","param","search","section","summary","table","tbody","td","tfoot","th","thead","title","tr","track","ul"],Pt=["pre","script","style","textarea"],It={concrete:!0,name:"htmlFlow",resolveTo:function(e){let t=e.length;for(;t--&&("enter"!==e[t][0]||"htmlFlow"!==e[t][1].type););t>1&&"linePrefix"===e[t-2][1].type&&(e[t][1].start=e[t-2][1].start,e[t+1][1].start=e[t-2][1].start,e.splice(t-2,2));return e},tokenize:function(e,t,n){const i=this;let s,r,o,a,l;return function(t){return function(t){return e.enter("htmlFlow"),e.enter("htmlFlowData"),e.consume(t),c}(t)};function c(a){return 33===a?(e.consume(a),u):47===a?(e.consume(a),r=!0,p):63===a?(e.consume(a),s=3,i.interrupt?t:D):Fe(a)?(e.consume(a),o=String.fromCharCode(a),m):n(a)}function u(r){return 45===r?(e.consume(r),s=2,d):91===r?(e.consume(r),s=5,a=0,h):Fe(r)?(e.consume(r),s=4,i.interrupt?t:D):n(r)}function d(s){return 45===s?(e.consume(s),i.interrupt?t:D):n(s)}function h(s){const r="CDATA[";return s===r.charCodeAt(a++)?(e.consume(s),6===a?i.interrupt?t:P:h):n(s)}function p(t){return Fe(t)?(e.consume(t),o=String.fromCharCode(t),m):n(t)}function m(a){if(null===a||47===a||62===a||Ge(a)){const l=47===a,c=o.toLowerCase();return l||r||!Pt.includes(c)?Bt.includes(o.toLowerCase())?(s=6,l?(e.consume(a),f):i.interrupt?t(a):P(a)):(s=7,i.interrupt&&!i.parser.lazy[i.now().line]?n(a):r?g(a):y(a)):(s=1,i.interrupt?t(a):P(a))}return 45===a||Re(a)?(e.consume(a),o+=String.fromCharCode(a),m):n(a)}function f(s){return 62===s?(e.consume(s),i.interrupt?t:P):n(s)}function g(t){return qe(t)?(e.consume(t),g):k(t)}function y(t){return 47===t?(e.consume(t),k):58===t||95===t||Fe(t)?(e.consume(t),v):qe(t)?(e.consume(t),y):k(t)}function v(t){return 45===t||46===t||58===t||95===t||Re(t)?(e.consume(t),v):b(t)}function b(t){return 61===t?(e.consume(t),x):qe(t)?(e.consume(t),b):y(t)}function x(t){return null===t||60===t||61===t||62===t||96===t?n(t):34===t||39===t?(e.consume(t),l=t,S):qe(t)?(e.consume(t),x):C(t)}function S(t){return t===l?(e.consume(t),l=null,w):null===t||_e(t)?n(t):(e.consume(t),S)}function C(t){return null===t||34===t||39===t||47===t||60===t||61===t||62===t||96===t||Ge(t)?b(t):(e.consume(t),C)}function w(e){return 47===e||62===e||qe(e)?y(e):n(e)}function k(t){return 62===t?(e.consume(t),B):n(t)}function B(t){return null===t||_e(t)?P(t):qe(t)?(e.consume(t),B):n(t)}function P(t){return 45===t&&2===s?(e.consume(t),A):60===t&&1===s?(e.consume(t),M):62===t&&4===s?(e.consume(t),N):63===t&&3===s?(e.consume(t),D):93===t&&5===s?(e.consume(t),E):!_e(t)||6!==s&&7!==s?null===t||_e(t)?(e.exit("htmlFlowData"),I(t)):(e.consume(t),P):(e.exit("htmlFlowData"),e.check(jt,F,I)(t))}function I(t){return e.check(Tt,j,F)(t)}function j(t){return e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),T}function T(t){return null===t||_e(t)?I(t):(e.enter("htmlFlowData"),P(t))}function A(t){return 45===t?(e.consume(t),D):P(t)}function M(t){return 47===t?(e.consume(t),o="",L):P(t)}function L(t){if(62===t){const n=o.toLowerCase();return Pt.includes(n)?(e.consume(t),N):P(t)}return Fe(t)&&o.length<8?(e.consume(t),o+=String.fromCharCode(t),L):P(t)}function E(t){return 93===t?(e.consume(t),D):P(t)}function D(t){return 62===t?(e.consume(t),N):45===t&&2===s?(e.consume(t),D):P(t)}function N(t){return null===t||_e(t)?(e.exit("htmlFlowData"),F(t)):(e.consume(t),N)}function F(n){return e.exit("htmlFlow"),t(n)}}},jt={partial:!0,tokenize:function(e,t,n){return function(i){return e.enter("lineEnding"),e.consume(i),e.exit("lineEnding"),e.attempt(Je,t,n)}}},Tt={partial:!0,tokenize:function(e,t,n){const i=this;return function(t){if(_e(t))return e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),s;return n(t)};function s(e){return i.parser.lazy[i.now().line]?n(e):t(e)}}};const At={partial:!0,tokenize:function(e,t,n){const i=this;return function(t){if(null===t)return n(t);return e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),s};function s(e){return i.parser.lazy[i.now().line]?n(e):t(e)}}},Mt={concrete:!0,name:"codeFenced",tokenize:function(e,t,n){const i=this,s={partial:!0,tokenize:function(e,t,n){let s=0;return o;function o(t){return e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),l}function l(t){return e.enter("codeFencedFence"),qe(t)?Qe(e,c,"linePrefix",i.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(t):c(t)}function c(t){return t===r?(e.enter("codeFencedFenceSequence"),u(t)):n(t)}function u(t){return t===r?(s++,e.consume(t),u):s>=a?(e.exit("codeFencedFenceSequence"),qe(t)?Qe(e,d,"whitespace")(t):d(t)):n(t)}function d(i){return null===i||_e(i)?(e.exit("codeFencedFence"),t(i)):n(i)}}};let r,o=0,a=0;return function(t){return function(t){const n=i.events[i.events.length-1];return o=n&&"linePrefix"===n[1].type?n[2].sliceSerialize(n[1],!0).length:0,r=t,e.enter("codeFenced"),e.enter("codeFencedFence"),e.enter("codeFencedFenceSequence"),l(t)}(t)};function l(t){return t===r?(a++,e.consume(t),l):a<3?n(t):(e.exit("codeFencedFenceSequence"),qe(t)?Qe(e,c,"whitespace")(t):c(t))}function c(n){return null===n||_e(n)?(e.exit("codeFencedFence"),i.interrupt?t(n):e.check(At,p,v)(n)):(e.enter("codeFencedFenceInfo"),e.enter("chunkString",{contentType:"string"}),u(n))}function u(t){return null===t||_e(t)?(e.exit("chunkString"),e.exit("codeFencedFenceInfo"),c(t)):qe(t)?(e.exit("chunkString"),e.exit("codeFencedFenceInfo"),Qe(e,d,"whitespace")(t)):96===t&&t===r?n(t):(e.consume(t),u)}function d(t){return null===t||_e(t)?c(t):(e.enter("codeFencedFenceMeta"),e.enter("chunkString",{contentType:"string"}),h(t))}function h(t){return null===t||_e(t)?(e.exit("chunkString"),e.exit("codeFencedFenceMeta"),c(t)):96===t&&t===r?n(t):(e.consume(t),h)}function p(t){return e.attempt(s,v,m)(t)}function m(t){return e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),f}function f(t){return o>0&&qe(t)?Qe(e,g,"linePrefix",o+1)(t):g(t)}function g(t){return null===t||_e(t)?e.check(At,p,v)(t):(e.enter("codeFlowValue"),y(t))}function y(t){return null===t||_e(t)?(e.exit("codeFlowValue"),g(t)):(e.consume(t),y)}function v(n){return e.exit("codeFenced"),t(n)}}};const Lt=document.createElement("i");function Et(e){const t="&"+e+";";Lt.innerHTML=t;const n=Lt.textContent;return(59!==n.charCodeAt(n.length-1)||"semi"===e)&&(n!==t&&n)}const Dt={name:"characterReference",tokenize:function(e,t,n){const i=this;let s,r,o=0;return function(t){return e.enter("characterReference"),e.enter("characterReferenceMarker"),e.consume(t),e.exit("characterReferenceMarker"),a};function a(t){return 35===t?(e.enter("characterReferenceMarkerNumeric"),e.consume(t),e.exit("characterReferenceMarkerNumeric"),l):(e.enter("characterReferenceValue"),s=31,r=Re,c(t))}function l(t){return 88===t||120===t?(e.enter("characterReferenceMarkerHexadecimal"),e.consume(t),e.exit("characterReferenceMarkerHexadecimal"),e.enter("characterReferenceValue"),s=6,r=Ue,c):(e.enter("characterReferenceValue"),s=7,r=He,c(t))}function c(a){if(59===a&&o){const s=e.exit("characterReferenceValue");return r!==Re||Et(i.sliceSerialize(s))?(e.enter("characterReferenceMarker"),e.consume(a),e.exit("characterReferenceMarker"),e.exit("characterReference"),t):n(a)}return r(a)&&o++<s?(e.consume(a),c):n(a)}}};const Nt={name:"characterEscape",tokenize:function(e,t,n){return function(t){return e.enter("characterEscape"),e.enter("escapeMarker"),e.consume(t),e.exit("escapeMarker"),i};function i(i){return Ve(i)?(e.enter("characterEscapeValue"),e.consume(i),e.exit("characterEscapeValue"),e.exit("characterEscape"),t):n(i)}}};const Ft={name:"lineEnding",tokenize:function(e,t){return function(n){return e.enter("lineEnding"),e.consume(n),e.exit("lineEnding"),Qe(e,t,"linePrefix")}}};function Rt(e,t,n){const i=[];let s=-1;for(;++s<e.length;){const r=e[s].resolveAll;r&&!i.includes(r)&&(t=r(t,n),i.push(r))}return t}const Ot={name:"labelEnd",resolveAll:function(e){let t=-1;const n=[];for(;++t<e.length;){const i=e[t][1];if(n.push(e[t]),"labelImage"===i.type||"labelLink"===i.type||"labelEnd"===i.type){const e="labelImage"===i.type?4:2;i.type="data",t+=e}}e.length!==n.length&&Pe(e,0,e.length,n);return e},resolveTo:function(e,t){let n,i,s,r,o=e.length,a=0;for(;o--;)if(n=e[o][1],i){if("link"===n.type||"labelLink"===n.type&&n._inactive)break;"enter"===e[o][0]&&"labelLink"===n.type&&(n._inactive=!0)}else if(s){if("enter"===e[o][0]&&("labelImage"===n.type||"labelLink"===n.type)&&!n._balanced&&(i=o,"labelLink"!==n.type)){a=2;break}}else"labelEnd"===n.type&&(s=o);const l={type:"labelLink"===e[i][1].type?"link":"image",start:{...e[i][1].start},end:{...e[e.length-1][1].end}},c={type:"label",start:{...e[i][1].start},end:{...e[s][1].end}},u={type:"labelText",start:{...e[i+a+2][1].end},end:{...e[s-2][1].start}};return r=[["enter",l,t],["enter",c,t]],r=Ie(r,e.slice(i+1,i+a+3)),r=Ie(r,[["enter",u,t]]),r=Ie(r,Rt(t.parser.constructs.insideSpan.null,e.slice(i+a+4,s-3),t)),r=Ie(r,[["exit",u,t],e[s-2],e[s-1],["exit",c,t]]),r=Ie(r,e.slice(s+1)),r=Ie(r,[["exit",l,t]]),Pe(e,i,e.length,r),e},tokenize:function(e,t,n){const i=this;let s,r,o=i.events.length;for(;o--;)if(("labelImage"===i.events[o][1].type||"labelLink"===i.events[o][1].type)&&!i.events[o][1]._balanced){s=i.events[o][1];break}return function(t){if(!s)return n(t);if(s._inactive)return u(t);return r=i.parser.defined.includes(vt(i.sliceSerialize({start:s.end,end:i.now()}))),e.enter("labelEnd"),e.enter("labelMarker"),e.consume(t),e.exit("labelMarker"),e.exit("labelEnd"),a};function a(t){return 40===t?e.attempt(zt,c,r?c:u)(t):91===t?e.attempt(Ht,c,r?l:u)(t):r?c(t):u(t)}function l(t){return e.attempt(Ut,c,u)(t)}function c(e){return t(e)}function u(e){return s._balanced=!0,n(e)}}},zt={tokenize:function(e,t,n){return function(t){return e.enter("resource"),e.enter("resourceMarker"),e.consume(t),e.exit("resourceMarker"),i};function i(t){return Ge(t)?yt(e,s)(t):s(t)}function s(t){return 41===t?c(t):mt(e,r,o,"resourceDestination","resourceDestinationLiteral","resourceDestinationLiteralMarker","resourceDestinationRaw","resourceDestinationString",32)(t)}function r(t){return Ge(t)?yt(e,a)(t):c(t)}function o(e){return n(e)}function a(t){return 34===t||39===t||40===t?gt(e,l,n,"resourceTitle","resourceTitleMarker","resourceTitleString")(t):c(t)}function l(t){return Ge(t)?yt(e,c)(t):c(t)}function c(i){return 41===i?(e.enter("resourceMarker"),e.consume(i),e.exit("resourceMarker"),e.exit("resource"),t):n(i)}}},Ht={tokenize:function(e,t,n){const i=this;return function(t){return ft.call(i,e,s,r,"reference","referenceMarker","referenceString")(t)};function s(e){return i.parser.defined.includes(vt(i.sliceSerialize(i.events[i.events.length-1][1]).slice(1,-1)))?t(e):n(e)}function r(e){return n(e)}}},Ut={tokenize:function(e,t,n){return function(t){return e.enter("reference"),e.enter("referenceMarker"),e.consume(t),e.exit("referenceMarker"),i};function i(i){return 93===i?(e.enter("referenceMarker"),e.consume(i),e.exit("referenceMarker"),e.exit("reference"),t):n(i)}}};const Vt={name:"labelStartImage",resolveAll:Ot.resolveAll,tokenize:function(e,t,n){const i=this;return function(t){return e.enter("labelImage"),e.enter("labelImageMarker"),e.consume(t),e.exit("labelImageMarker"),s};function s(t){return 91===t?(e.enter("labelMarker"),e.consume(t),e.exit("labelMarker"),e.exit("labelImage"),r):n(t)}function r(e){return 94===e&&"_hiddenFootnoteSupport"in i.parser.constructs?n(e):t(e)}}};function _t(e){return null===e||Ge(e)||Ze(e)?1:$e(e)?2:void 0}const Gt={name:"attention",resolveAll:function(e,t){let n,i,s,r,o,a,l,c,u=-1;for(;++u<e.length;)if("enter"===e[u][0]&&"attentionSequence"===e[u][1].type&&e[u][1]._close)for(n=u;n--;)if("exit"===e[n][0]&&"attentionSequence"===e[n][1].type&&e[n][1]._open&&t.sliceSerialize(e[n][1]).charCodeAt(0)===t.sliceSerialize(e[u][1]).charCodeAt(0)){if((e[n][1]._close||e[u][1]._open)&&(e[u][1].end.offset-e[u][1].start.offset)%3&&!((e[n][1].end.offset-e[n][1].start.offset+e[u][1].end.offset-e[u][1].start.offset)%3))continue;a=e[n][1].end.offset-e[n][1].start.offset>1&&e[u][1].end.offset-e[u][1].start.offset>1?2:1;const d={...e[n][1].end},h={...e[u][1].start};qt(d,-a),qt(h,a),r={type:a>1?"strongSequence":"emphasisSequence",start:d,end:{...e[n][1].end}},o={type:a>1?"strongSequence":"emphasisSequence",start:{...e[u][1].start},end:h},s={type:a>1?"strongText":"emphasisText",start:{...e[n][1].end},end:{...e[u][1].start}},i={type:a>1?"strong":"emphasis",start:{...r.start},end:{...o.end}},e[n][1].end={...r.start},e[u][1].start={...o.end},l=[],e[n][1].end.offset-e[n][1].start.offset&&(l=Ie(l,[["enter",e[n][1],t],["exit",e[n][1],t]])),l=Ie(l,[["enter",i,t],["enter",r,t],["exit",r,t],["enter",s,t]]),l=Ie(l,Rt(t.parser.constructs.insideSpan.null,e.slice(n+1,u),t)),l=Ie(l,[["exit",s,t],["enter",o,t],["exit",o,t],["exit",i,t]]),e[u][1].end.offset-e[u][1].start.offset?(c=2,l=Ie(l,[["enter",e[u][1],t],["exit",e[u][1],t]])):c=0,Pe(e,n-1,u-n+3,l),u=n+l.length-c-2;break}u=-1;for(;++u<e.length;)"attentionSequence"===e[u][1].type&&(e[u][1].type="data");return e},tokenize:function(e,t){const n=this.parser.constructs.attentionMarkers.null,i=this.previous,s=_t(i);let r;return function(t){return r=t,e.enter("attentionSequence"),o(t)};function o(a){if(a===r)return e.consume(a),o;const l=e.exit("attentionSequence"),c=_t(a),u=!c||2===c&&s||n.includes(a),d=!s||2===s&&c||n.includes(i);return l._open=Boolean(42===r?u:u&&(s||!d)),l._close=Boolean(42===r?d:d&&(c||!u)),t(a)}}};function qt(e,t){e.column+=t,e.offset+=t,e._bufferIndex+=t}const $t={name:"autolink",tokenize:function(e,t,n){let i=0;return function(t){return e.enter("autolink"),e.enter("autolinkMarker"),e.consume(t),e.exit("autolinkMarker"),e.enter("autolinkProtocol"),s};function s(t){return Fe(t)?(e.consume(t),r):64===t?n(t):l(t)}function r(e){return 43===e||45===e||46===e||Re(e)?(i=1,o(e)):l(e)}function o(t){return 58===t?(e.consume(t),i=0,a):(43===t||45===t||46===t||Re(t))&&i++<32?(e.consume(t),o):(i=0,l(t))}function a(i){return 62===i?(e.exit("autolinkProtocol"),e.enter("autolinkMarker"),e.consume(i),e.exit("autolinkMarker"),e.exit("autolink"),t):null===i||32===i||60===i||ze(i)?n(i):(e.consume(i),a)}function l(t){return 64===t?(e.consume(t),c):Oe(t)?(e.consume(t),l):n(t)}function c(e){return Re(e)?u(e):n(e)}function u(n){return 46===n?(e.consume(n),i=0,c):62===n?(e.exit("autolinkProtocol").type="autolinkEmail",e.enter("autolinkMarker"),e.consume(n),e.exit("autolinkMarker"),e.exit("autolink"),t):d(n)}function d(t){if((45===t||Re(t))&&i++<63){const n=45===t?d:u;return e.consume(t),n}return n(t)}}};const Zt={name:"htmlText",tokenize:function(e,t,n){const i=this;let s,r,o;return function(t){return e.enter("htmlText"),e.enter("htmlTextData"),e.consume(t),a};function a(t){return 33===t?(e.consume(t),l):47===t?(e.consume(t),x):63===t?(e.consume(t),v):Fe(t)?(e.consume(t),w):n(t)}function l(t){return 45===t?(e.consume(t),c):91===t?(e.consume(t),r=0,p):Fe(t)?(e.consume(t),y):n(t)}function c(t){return 45===t?(e.consume(t),h):n(t)}function u(t){return null===t?n(t):45===t?(e.consume(t),d):_e(t)?(o=u,L(t)):(e.consume(t),u)}function d(t){return 45===t?(e.consume(t),h):u(t)}function h(e){return 62===e?M(e):45===e?d(e):u(e)}function p(t){const i="CDATA[";return t===i.charCodeAt(r++)?(e.consume(t),6===r?m:p):n(t)}function m(t){return null===t?n(t):93===t?(e.consume(t),f):_e(t)?(o=m,L(t)):(e.consume(t),m)}function f(t){return 93===t?(e.consume(t),g):m(t)}function g(t){return 62===t?M(t):93===t?(e.consume(t),g):m(t)}function y(t){return null===t||62===t?M(t):_e(t)?(o=y,L(t)):(e.consume(t),y)}function v(t){return null===t?n(t):63===t?(e.consume(t),b):_e(t)?(o=v,L(t)):(e.consume(t),v)}function b(e){return 62===e?M(e):v(e)}function x(t){return Fe(t)?(e.consume(t),S):n(t)}function S(t){return 45===t||Re(t)?(e.consume(t),S):C(t)}function C(t){return _e(t)?(o=C,L(t)):qe(t)?(e.consume(t),C):M(t)}function w(t){return 45===t||Re(t)?(e.consume(t),w):47===t||62===t||Ge(t)?k(t):n(t)}function k(t){return 47===t?(e.consume(t),M):58===t||95===t||Fe(t)?(e.consume(t),B):_e(t)?(o=k,L(t)):qe(t)?(e.consume(t),k):M(t)}function B(t){return 45===t||46===t||58===t||95===t||Re(t)?(e.consume(t),B):P(t)}function P(t){return 61===t?(e.consume(t),I):_e(t)?(o=P,L(t)):qe(t)?(e.consume(t),P):k(t)}function I(t){return null===t||60===t||61===t||62===t||96===t?n(t):34===t||39===t?(e.consume(t),s=t,j):_e(t)?(o=I,L(t)):qe(t)?(e.consume(t),I):(e.consume(t),T)}function j(t){return t===s?(e.consume(t),s=void 0,A):null===t?n(t):_e(t)?(o=j,L(t)):(e.consume(t),j)}function T(t){return null===t||34===t||39===t||60===t||61===t||96===t?n(t):47===t||62===t||Ge(t)?k(t):(e.consume(t),T)}function A(e){return 47===e||62===e||Ge(e)?k(e):n(e)}function M(i){return 62===i?(e.consume(i),e.exit("htmlTextData"),e.exit("htmlText"),t):n(i)}function L(t){return e.exit("htmlTextData"),e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),E}function E(t){return qe(t)?Qe(e,D,"linePrefix",i.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(t):D(t)}function D(t){return e.enter("htmlTextData"),o(t)}}};const Kt={name:"labelStartLink",resolveAll:Ot.resolveAll,tokenize:function(e,t,n){const i=this;return function(t){return e.enter("labelLink"),e.enter("labelMarker"),e.consume(t),e.exit("labelMarker"),e.exit("labelLink"),s};function s(e){return 94===e&&"_hiddenFootnoteSupport"in i.parser.constructs?n(e):t(e)}}};const Qt={name:"hardBreakEscape",tokenize:function(e,t,n){return function(t){return e.enter("hardBreakEscape"),e.consume(t),i};function i(i){return _e(i)?(e.exit("hardBreakEscape"),t(i)):n(i)}}};const Xt={name:"codeText",previous:function(e){return 96!==e||"characterEscape"===this.events[this.events.length-1][1].type},resolve:function(e){let t,n,i=e.length-4,s=3;if(!("lineEnding"!==e[s][1].type&&"space"!==e[s][1].type||"lineEnding"!==e[i][1].type&&"space"!==e[i][1].type))for(t=s;++t<i;)if("codeTextData"===e[t][1].type){e[s][1].type="codeTextPadding",e[i][1].type="codeTextPadding",s+=2,i-=2;break}t=s-1,i++;for(;++t<=i;)void 0===n?t!==i&&"lineEnding"!==e[t][1].type&&(n=t):t!==i&&"lineEnding"!==e[t][1].type||(e[n][1].type="codeTextData",t!==n+2&&(e[n][1].end=e[t-1][1].end,e.splice(n+2,t-n-2),i-=t-n-2,t=n+2),n=void 0);return e},tokenize:function(e,t,n){let i,s,r=0;return function(t){return e.enter("codeText"),e.enter("codeTextSequence"),o(t)};function o(t){return 96===t?(e.consume(t),r++,o):(e.exit("codeTextSequence"),a(t))}function a(t){return null===t?n(t):32===t?(e.enter("space"),e.consume(t),e.exit("space"),a):96===t?(s=e.enter("codeTextSequence"),i=0,c(t)):_e(t)?(e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),a):(e.enter("codeTextData"),l(t))}function l(t){return null===t||32===t||96===t||_e(t)?(e.exit("codeTextData"),a(t)):(e.consume(t),l)}function c(n){return 96===n?(e.consume(n),i++,c):i===r?(e.exit("codeTextSequence"),e.exit("codeText"),t(n)):(s.type="codeTextData",l(n))}}};const Wt={42:ut,43:ut,45:ut,48:ut,49:ut,50:ut,51:ut,52:ut,53:ut,54:ut,55:ut,56:ut,57:ut,62:pt},Yt={91:bt},Jt={[-2]:St,[-1]:St,32:St},en={35:wt,42:ct,45:[kt,ct],60:It,61:kt,95:ct,96:Mt,126:Mt},tn={38:Dt,92:Nt},nn={[-5]:Ft,[-4]:Ft,[-3]:Ft,33:Vt,38:Dt,42:Gt,60:[$t,Zt],91:Kt,92:[Qt,Nt],93:Ot,95:Gt,96:Xt},sn={null:[Gt,it]},rn={null:[42,95]},on={null:[]};function an(e,t,n){let i={_bufferIndex:-1,_index:0,line:n&&n.line||1,column:n&&n.column||1,offset:n&&n.offset||0};const s={},r=[];let o=[],a=[],l=!0;const c={attempt:v(function(e,t){b(e,t.from)}),check:v(y),consume:function(e){_e(e)?(i.line++,i.column=1,i.offset+=-3===e?2:1,x()):-1!==e&&(i.column++,i.offset++);i._bufferIndex<0?i._index++:(i._bufferIndex++,i._bufferIndex===o[i._index].length&&(i._bufferIndex=-1,i._index++));u.previous=e,l=!0},enter:function(e,t){const n=t||{};return n.type=e,n.start=m(),u.events.push(["enter",n,u]),a.push(n),n},exit:function(e){const t=a.pop();return t.end=m(),u.events.push(["exit",t,u]),t},interrupt:v(y,{interrupt:!0})},u={code:null,containerState:{},defineSkip:function(e){s[e.line]=e.column,x()},events:[],now:m,parser:e,previous:null,sliceSerialize:function(e,t){return function(e,t){let n=-1;const i=[];let s;for(;++n<e.length;){const r=e[n];let o;if("string"==typeof r)o=r;else switch(r){case-5:o="\r";break;case-4:o="\n";break;case-3:o="\r\n";break;case-2:o=t?" ":"\t";break;case-1:if(!t&&s)continue;o=" ";break;default:o=String.fromCharCode(r)}s=-2===r,i.push(o)}return i.join("")}(p(e),t)},sliceStream:p,write:function(e){if(o=Ie(o,e),f(),null!==o[o.length-1])return[];return b(t,0),u.events=Rt(r,u.events,u),u.events}};let d,h=t.tokenize.call(u,c);return t.resolveAll&&r.push(t),u;function p(e){return function(e,t){const n=t.start._index,i=t.start._bufferIndex,s=t.end._index,r=t.end._bufferIndex;let o;if(n===s)o=[e[n].slice(i,r)];else{if(o=e.slice(n,s),i>-1){const e=o[0];"string"==typeof e?o[0]=e.slice(i):o.shift()}r>0&&o.push(e[s].slice(0,r))}return o}(o,e)}function m(){const{_bufferIndex:e,_index:t,line:n,column:s,offset:r}=i;return{_bufferIndex:e,_index:t,line:n,column:s,offset:r}}function f(){let e;for(;i._index<o.length;){const t=o[i._index];if("string"==typeof t)for(e=i._index,i._bufferIndex<0&&(i._bufferIndex=0);i._index===e&&i._bufferIndex<t.length;)g(t.charCodeAt(i._bufferIndex));else g(t)}}function g(e){l=void 0,d=e,h=h(e)}function y(e,t){t.restore()}function v(e,t){return function(n,s,r){let o,d,h,p;return Array.isArray(n)?f(n):"tokenize"in n?f([n]):function(e){return t;function t(t){const n=null!==t&&e[t],i=null!==t&&e.null;return f([...Array.isArray(n)?n:n?[n]:[],...Array.isArray(i)?i:i?[i]:[]])(t)}}(n);function f(e){return o=e,d=0,0===e.length?r:g(e[d])}function g(e){return function(n){p=function(){const e=m(),t=u.previous,n=u.currentConstruct,s=u.events.length,r=Array.from(a);return{from:s,restore:o};function o(){i=e,u.previous=t,u.currentConstruct=n,u.events.length=s,a=r,x()}}(),h=e,e.partial||(u.currentConstruct=e);if(e.name&&u.parser.constructs.disable.null.includes(e.name))return v(n);return e.tokenize.call(t?Object.assign(Object.create(u),t):u,c,y,v)(n)}}function y(t){return l=!0,e(h,p),s}function v(e){return l=!0,p.restore(),++d<o.length?g(o[d]):r}}}function b(e,t){e.resolveAll&&!r.includes(e)&&r.push(e),e.resolve&&Pe(u.events,t,u.events.length-t,e.resolve(u.events.slice(t),u)),e.resolveTo&&(u.events=e.resolveTo(u.events,u))}function x(){i.line in s&&i.column<2&&(i.column=s[i.line],i.offset+=s[i.line]-1)}}const ln=/[\0\t\n\r]/g;function cn(e,t){const n=Number.parseInt(e,t);return n<9||11===n||n>13&&n<32||n>126&&n<160||n>55295&&n<57344||n>64975&&n<65008||!(65535&~n)||65534==(65535&n)||n>1114111?"":String.fromCodePoint(n)}const un=/\\([!-/:-@[-`{-~])|&(#(?:\d{1,7}|x[\da-f]{1,6})|[\da-z]{1,31});/gi;function dn(e,t,n){if(t)return t;if(35===n.charCodeAt(0)){const e=n.charCodeAt(1),t=120===e||88===e;return cn(n.slice(t?2:1),t?16:10)}return Et(n)||e}const hn={}.hasOwnProperty;function pn(e,t,n){return"string"!=typeof t&&(n=t,t=void 0),function(e){const t={transforms:[],canContainEols:["emphasis","fragment","heading","paragraph","strong"],enter:{autolink:r(ne),autolinkProtocol:B,autolinkEmail:B,atxHeading:r(W),blockQuote:r($),characterEscape:B,characterReference:B,codeFenced:r(Z),codeFencedFenceInfo:o,codeFencedFenceMeta:o,codeIndented:r(Z,o),codeText:r(K,o),codeTextData:B,data:B,codeFlowValue:B,definition:r(Q),definitionDestinationString:o,definitionLabelString:o,definitionTitleString:o,emphasis:r(X),hardBreakEscape:r(Y),hardBreakTrailing:r(Y),htmlFlow:r(J,o),htmlFlowData:B,htmlText:r(J,o),htmlTextData:B,image:r(te),label:o,link:r(ne),listItem:r(se),listItemValue:h,listOrdered:r(ie,d),listUnordered:r(ie),paragraph:r(re),reference:z,referenceString:o,resourceDestinationString:o,resourceTitleString:o,setextHeading:r(W),strong:r(oe),thematicBreak:r(le)},exit:{atxHeading:l(),atxHeadingSequence:S,autolink:l(),autolinkEmail:q,autolinkProtocol:G,blockQuote:l(),characterEscapeValue:P,characterReferenceMarkerHexadecimal:U,characterReferenceMarkerNumeric:U,characterReferenceValue:V,characterReference:_,codeFenced:l(g),codeFencedFence:f,codeFencedFenceInfo:p,codeFencedFenceMeta:m,codeFlowValue:P,codeIndented:l(y),codeText:l(M),codeTextData:P,data:P,definition:l(),definitionDestinationString:x,definitionLabelString:v,definitionTitleString:b,emphasis:l(),hardBreakEscape:l(j),hardBreakTrailing:l(j),htmlFlow:l(T),htmlFlowData:P,htmlText:l(A),htmlTextData:P,image:l(E),label:N,labelText:D,lineEnding:I,link:l(L),listItem:l(),listOrdered:l(),listUnordered:l(),paragraph:l(),referenceString:H,resourceDestinationString:F,resourceTitleString:R,resource:O,setextHeading:l(k),setextHeadingLineSequence:w,setextHeadingText:C,strong:l(),thematicBreak:l()}};fn(t,(e||{}).mdastExtensions||[]);const n={};return i;function i(e){let i={type:"root",children:[]};const r={stack:[i],tokenStack:[],config:t,enter:a,exit:c,buffer:o,resume:u,data:n},l=[];let d=-1;for(;++d<e.length;)if("listOrdered"===e[d][1].type||"listUnordered"===e[d][1].type)if("enter"===e[d][0])l.push(d);else{d=s(e,l.pop(),d)}for(d=-1;++d<e.length;){const n=t[e[d][0]];hn.call(n,e[d][1].type)&&n[e[d][1].type].call(Object.assign({sliceSerialize:e[d][2].sliceSerialize},r),e[d][1])}if(r.tokenStack.length>0){const e=r.tokenStack[r.tokenStack.length-1];(e[1]||yn).call(r,void 0,e[0])}for(i.position={start:mn(e.length>0?e[0][1].start:{line:1,column:1,offset:0}),end:mn(e.length>0?e[e.length-2][1].end:{line:1,column:1,offset:0})},d=-1;++d<t.transforms.length;)i=t.transforms[d](i)||i;return i}function s(e,t,n){let i,s,r,o,a=t-1,l=-1,c=!1;for(;++a<=n;){const t=e[a];switch(t[1].type){case"listUnordered":case"listOrdered":case"blockQuote":"enter"===t[0]?l++:l--,o=void 0;break;case"lineEndingBlank":"enter"===t[0]&&(!i||o||l||r||(r=a),o=void 0);break;case"linePrefix":case"listItemValue":case"listItemMarker":case"listItemPrefix":case"listItemPrefixWhitespace":break;default:o=void 0}if(!l&&"enter"===t[0]&&"listItemPrefix"===t[1].type||-1===l&&"exit"===t[0]&&("listUnordered"===t[1].type||"listOrdered"===t[1].type)){if(i){let o=a;for(s=void 0;o--;){const t=e[o];if("lineEnding"===t[1].type||"lineEndingBlank"===t[1].type){if("exit"===t[0])continue;s&&(e[s][1].type="lineEndingBlank",c=!0),t[1].type="lineEnding",s=o}else if("linePrefix"!==t[1].type&&"blockQuotePrefix"!==t[1].type&&"blockQuotePrefixWhitespace"!==t[1].type&&"blockQuoteMarker"!==t[1].type&&"listItemIndent"!==t[1].type)break}r&&(!s||r<s)&&(i._spread=!0),i.end=Object.assign({},s?e[s][1].start:t[1].end),e.splice(s||a,0,["exit",i,t[2]]),a++,n++}if("listItemPrefix"===t[1].type){const s={type:"listItem",_spread:!1,start:Object.assign({},t[1].start),end:void 0};i=s,e.splice(a,0,["enter",s,t[2]]),a++,n++,r=void 0,o=!0}}}return e[t][1]._spread=c,n}function r(e,t){return n;function n(n){a.call(this,e(n),n),t&&t.call(this,n)}}function o(){this.stack.push({type:"fragment",children:[]})}function a(e,t,n){this.stack[this.stack.length-1].children.push(e),this.stack.push(e),this.tokenStack.push([t,n||void 0]),e.position={start:mn(t.start),end:void 0}}function l(e){return t;function t(t){e&&e.call(this,t),c.call(this,t)}}function c(e,t){const n=this.stack.pop(),i=this.tokenStack.pop();if(!i)throw new Error("Cannot close `"+e.type+"` ("+ee({start:e.start,end:e.end})+"): its not open");if(i[0].type!==e.type)if(t)t.call(this,e,i[0]);else{(i[1]||yn).call(this,e,i[0])}n.position.end=mn(e.end)}function u(){return we(this.stack.pop())}function d(){this.data.expectingFirstListItemValue=!0}function h(e){if(this.data.expectingFirstListItemValue){this.stack[this.stack.length-2].start=Number.parseInt(this.sliceSerialize(e),10),this.data.expectingFirstListItemValue=void 0}}function p(){const e=this.resume();this.stack[this.stack.length-1].lang=e}function m(){const e=this.resume();this.stack[this.stack.length-1].meta=e}function f(){this.data.flowCodeInside||(this.buffer(),this.data.flowCodeInside=!0)}function g(){const e=this.resume();this.stack[this.stack.length-1].value=e.replace(/^(\r?\n|\r)|(\r?\n|\r)$/g,""),this.data.flowCodeInside=void 0}function y(){const e=this.resume();this.stack[this.stack.length-1].value=e.replace(/(\r?\n|\r)$/g,"")}function v(e){const t=this.resume(),n=this.stack[this.stack.length-1];n.label=t,n.identifier=vt(this.sliceSerialize(e)).toLowerCase()}function b(){const e=this.resume();this.stack[this.stack.length-1].title=e}function x(){const e=this.resume();this.stack[this.stack.length-1].url=e}function S(e){const t=this.stack[this.stack.length-1];if(!t.depth){const n=this.sliceSerialize(e).length;t.depth=n}}function C(){this.data.setextHeadingSlurpLineEnding=!0}function w(e){this.stack[this.stack.length-1].depth=61===this.sliceSerialize(e).codePointAt(0)?1:2}function k(){this.data.setextHeadingSlurpLineEnding=void 0}function B(e){const t=this.stack[this.stack.length-1].children;let n=t[t.length-1];n&&"text"===n.type||(n=ae(),n.position={start:mn(e.start),end:void 0},t.push(n)),this.stack.push(n)}function P(e){const t=this.stack.pop();t.value+=this.sliceSerialize(e),t.position.end=mn(e.end)}function I(e){const n=this.stack[this.stack.length-1];if(this.data.atHardBreak){return n.children[n.children.length-1].position.end=mn(e.end),void(this.data.atHardBreak=void 0)}!this.data.setextHeadingSlurpLineEnding&&t.canContainEols.includes(n.type)&&(B.call(this,e),P.call(this,e))}function j(){this.data.atHardBreak=!0}function T(){const e=this.resume();this.stack[this.stack.length-1].value=e}function A(){const e=this.resume();this.stack[this.stack.length-1].value=e}function M(){const e=this.resume();this.stack[this.stack.length-1].value=e}function L(){const e=this.stack[this.stack.length-1];if(this.data.inReference){const t=this.data.referenceType||"shortcut";e.type+="Reference",e.referenceType=t,delete e.url,delete e.title}else delete e.identifier,delete e.label;this.data.referenceType=void 0}function E(){const e=this.stack[this.stack.length-1];if(this.data.inReference){const t=this.data.referenceType||"shortcut";e.type+="Reference",e.referenceType=t,delete e.url,delete e.title}else delete e.identifier,delete e.label;this.data.referenceType=void 0}function D(e){const t=this.sliceSerialize(e),n=this.stack[this.stack.length-2];n.label=function(e){return e.replace(un,dn)}(t),n.identifier=vt(t).toLowerCase()}function N(){const e=this.stack[this.stack.length-1],t=this.resume(),n=this.stack[this.stack.length-1];if(this.data.inReference=!0,"link"===n.type){const t=e.children;n.children=t}else n.alt=t}function F(){const e=this.resume();this.stack[this.stack.length-1].url=e}function R(){const e=this.resume();this.stack[this.stack.length-1].title=e}function O(){this.data.inReference=void 0}function z(){this.data.referenceType="collapsed"}function H(e){const t=this.resume(),n=this.stack[this.stack.length-1];n.label=t,n.identifier=vt(this.sliceSerialize(e)).toLowerCase(),this.data.referenceType="full"}function U(e){this.data.characterReferenceType=e.type}function V(e){const t=this.sliceSerialize(e),n=this.data.characterReferenceType;let i;if(n)i=cn(t,"characterReferenceMarkerNumeric"===n?10:16),this.data.characterReferenceType=void 0;else{i=Et(t)}this.stack[this.stack.length-1].value+=i}function _(e){this.stack.pop().position.end=mn(e.end)}function G(e){P.call(this,e);this.stack[this.stack.length-1].url=this.sliceSerialize(e)}function q(e){P.call(this,e);this.stack[this.stack.length-1].url="mailto:"+this.sliceSerialize(e)}function $(){return{type:"blockquote",children:[]}}function Z(){return{type:"code",lang:null,meta:null,value:""}}function K(){return{type:"inlineCode",value:""}}function Q(){return{type:"definition",identifier:"",label:null,title:null,url:""}}function X(){return{type:"emphasis",children:[]}}function W(){return{type:"heading",depth:0,children:[]}}function Y(){return{type:"break"}}function J(){return{type:"html",value:""}}function te(){return{type:"image",title:null,url:"",alt:null}}function ne(){return{type:"link",title:null,url:"",children:[]}}function ie(e){return{type:"list",ordered:"listOrdered"===e.type,start:null,spread:e._spread,children:[]}}function se(e){return{type:"listItem",spread:e._spread,checked:null,children:[]}}function re(){return{type:"paragraph",children:[]}}function oe(){return{type:"strong",children:[]}}function ae(){return{type:"text",value:""}}function le(){return{type:"thematicBreak"}}}(n)(function(e){for(;!Ae(e););return e}(function(e){const t={constructs:Ee([s,...(e||{}).extensions||[]]),content:n(Xe),defined:[],document:n(We),flow:n(nt),lazy:{},string:n(st),text:n(rt)};return t;function n(e){return function(n){return an(t,e,n)}}}(n).document().write(function(){let e,t=1,n="",i=!0;return function(s,r,o){const a=[];let l,c,u,d,h;for(s=n+("string"==typeof s?s.toString():new TextDecoder(r||void 0).decode(s)),u=0,n="",i&&(65279===s.charCodeAt(0)&&u++,i=void 0);u<s.length;){if(ln.lastIndex=u,l=ln.exec(s),d=l&&void 0!==l.index?l.index:s.length,h=s.charCodeAt(d),!l){n=s.slice(u);break}if(10===h&&u===d&&e)a.push(-3),e=void 0;else switch(e&&(a.push(-5),e=void 0),u<d&&(a.push(s.slice(u,d)),t+=d-u),h){case 0:a.push(65533),t++;break;case 9:for(c=4*Math.ceil(t/4),a.push(-2);t++<c;)a.push(-1);break;case 10:a.push(-4),t=1;break;default:e=!0,t=1}u=d+1}return o&&(e&&a.push(-5),n&&a.push(n),a.push(null)),a}}()(e,t,!0))))}function mn(e){return{line:e.line,column:e.column,offset:e.offset}}function fn(e,t){let n=-1;for(;++n<t.length;){const i=t[n];Array.isArray(i)?fn(e,i):gn(e,i)}}function gn(e,t){let n;for(n in t)if(hn.call(t,n))switch(n){case"canContainEols":{const i=t[n];i&&e[n].push(...i);break}case"transforms":{const i=t[n];i&&e[n].push(...i);break}case"enter":case"exit":{const i=t[n];i&&Object.assign(e[n],i);break}}}function yn(e,t){throw e?new Error("Cannot close `"+e.type+"` ("+ee({start:e.start,end:e.end})+"): a different token (`"+t.type+"`, "+ee({start:t.start,end:t.end})+") is open"):new Error("Cannot close document, a token (`"+t.type+"`, "+ee({start:t.start,end:t.end})+") is still open")}function vn(e){const t=this;t.parser=function(n){return pn(n,{...t.data("settings"),...e,extensions:t.data("micromarkExtensions")||[],mdastExtensions:t.data("fromMarkdownExtensions")||[]})}}const bn="object"==typeof self?self:globalThis,xn=e=>((e,t)=>{const n=(t,n)=>(e.set(n,t),t),i=s=>{if(e.has(s))return e.get(s);const[r,o]=t[s];switch(r){case 0:case-1:return n(o,s);case 1:{const e=n([],s);for(const t of o)e.push(i(t));return e}case 2:{const e=n({},s);for(const[t,n]of o)e[i(t)]=i(n);return e}case 3:return n(new Date(o),s);case 4:{const{source:e,flags:t}=o;return n(new RegExp(e,t),s)}case 5:{const e=n(new Map,s);for(const[t,n]of o)e.set(i(t),i(n));return e}case 6:{const e=n(new Set,s);for(const t of o)e.add(i(t));return e}case 7:{const{name:e,message:t}=o;return n(new bn[e](t),s)}case 8:return n(BigInt(o),s);case"BigInt":return n(Object(BigInt(o)),s);case"ArrayBuffer":return n(new Uint8Array(o).buffer,o);case"DataView":{const{buffer:e}=new Uint8Array(o);return n(new DataView(e),o)}}return n(new bn[r](o),s)};return i})(new Map,e)(0),Sn="",{toString:Cn}={},{keys:wn}=Object,kn=e=>{const t=typeof e;if("object"!==t||!e)return[0,t];const n=Cn.call(e).slice(8,-1);switch(n){case"Array":return[1,Sn];case"Object":return[2,Sn];case"Date":return[3,Sn];case"RegExp":return[4,Sn];case"Map":return[5,Sn];case"Set":return[6,Sn];case"DataView":return[1,n]}return n.includes("Array")?[1,n]:n.includes("Error")?[7,n]:[2,n]},Bn=([e,t])=>0===e&&("function"===t||"symbol"===t),Pn=(e,{json:t,lossy:n}={})=>{const i=[];return((e,t,n,i)=>{const s=(e,t)=>{const s=i.push(e)-1;return n.set(t,s),s},r=i=>{if(n.has(i))return n.get(i);let[o,a]=kn(i);switch(o){case 0:{let t=i;switch(a){case"bigint":o=8,t=i.toString();break;case"function":case"symbol":if(e)throw new TypeError("unable to serialize "+a);t=null;break;case"undefined":return s([-1],i)}return s([o,t],i)}case 1:{if(a){let e=i;return"DataView"===a?e=new Uint8Array(i.buffer):"ArrayBuffer"===a&&(e=new Uint8Array(i)),s([a,[...e]],i)}const e=[],t=s([o,e],i);for(const n of i)e.push(r(n));return t}case 2:{if(a)switch(a){case"BigInt":return s([a,i.toString()],i);case"Boolean":case"Number":case"String":return s([a,i.valueOf()],i)}if(t&&"toJSON"in i)return r(i.toJSON());const n=[],l=s([o,n],i);for(const t of wn(i))!e&&Bn(kn(i[t]))||n.push([r(t),r(i[t])]);return l}case 3:return s([o,i.toISOString()],i);case 4:{const{source:e,flags:t}=i;return s([o,{source:e,flags:t}],i)}case 5:{const t=[],n=s([o,t],i);for(const[s,o]of i)(e||!Bn(kn(s))&&!Bn(kn(o)))&&t.push([r(s),r(o)]);return n}case 6:{const t=[],n=s([o,t],i);for(const s of i)!e&&Bn(kn(s))||t.push(r(s));return n}}const{message:l}=i;return s([o,{name:a,message:l}],i)};return r})(!(t||n),!!t,new Map,i)(e),i};var In="function"==typeof structuredClone?(e,t)=>t&&("json"in t||"lossy"in t)?xn(Pn(e,t)):structuredClone(e):(e,t)=>xn(Pn(e,t));function jn(e){const t=[];let n=-1,i=0,s=0;for(;++n<e.length;){const r=e.charCodeAt(n);let o="";if(37===r&&Re(e.charCodeAt(n+1))&&Re(e.charCodeAt(n+2)))s=2;else if(r<128)/[!#$&-;=?-Z_a-z~]/.test(String.fromCharCode(r))||(o=String.fromCharCode(r));else if(r>55295&&r<57344){const t=e.charCodeAt(n+1);r<56320&&t>56319&&t<57344?(o=String.fromCharCode(r,t),s=1):o=""}else o=String.fromCharCode(r);o&&(t.push(e.slice(i,n),encodeURIComponent(o)),i=n+s+1,o=""),s&&(n+=s,s=0)}return t.join("")+e.slice(i)}function Tn(e,t){const n=[{type:"text",value:""}];return t>1&&n.push({type:"element",tagName:"sup",properties:{},children:[{type:"text",value:String(t)}]}),n}function An(e,t){return"Back to reference "+(e+1)+(t>1?"-"+t:"")}const Mn=function(e){if(null==e)return En;if("function"==typeof e)return Ln(e);if("object"==typeof e)return Array.isArray(e)?function(e){const t=[];let n=-1;for(;++n<e.length;)t[n]=Mn(e[n]);return Ln(i);function i(...e){let n=-1;for(;++n<t.length;)if(t[n].apply(this,e))return!0;return!1}}(e):function(e){const t=e;return Ln(n);function n(n){const i=n;let s;for(s in e)if(i[s]!==t[s])return!1;return!0}}(e);if("string"==typeof e)return function(e){return Ln(t);function t(t){return t&&t.type===e}}(e);throw new Error("Expected function, string, or object as test")};function Ln(e){return function(t,n,i){return Boolean(Dn(t)&&e.call(this,t,"number"==typeof n?n:void 0,i||void 0))}}function En(){return!0}function Dn(e){return null!==e&&"object"==typeof e&&"type"in e}const Nn=[],Fn=!0,Rn=!1;function On(e,t,n,i){let s;"function"==typeof t&&"function"!=typeof n?(i=n,n=t):s=t;const r=Mn(s),o=i?-1:1;!function e(s,a,l){const c=s&&"object"==typeof s?s:{};if("string"==typeof c.type){const e="string"==typeof c.tagName?c.tagName:"string"==typeof c.name?c.name:void 0;Object.defineProperty(u,"name",{value:"node ("+s.type+(e?"<"+e+">":"")+")"})}return u;function u(){let c,u,d,h=Nn;if((!t||r(s,a,l[l.length-1]||void 0))&&(h=function(e){if(Array.isArray(e))return e;if("number"==typeof e)return[Fn,e];return null==e?Nn:[e]}(n(s,l)),h[0]===Rn))return h;if("children"in s&&s.children){const t=s;if(t.children&&"skip"!==h[0])for(u=(i?t.children.length:-1)+o,d=l.concat(t);u>-1&&u<t.children.length;){const n=t.children[u];if(c=e(n,u,d)(),c[0]===Rn)return c;u="number"==typeof c[1]?c[1]:u+o}}return h}}(e,void 0,[])()}function zn(e,t,n,i){let s,r,o;"function"==typeof t&&"function"!=typeof n?(r=void 0,o=t,s=n):(r=t,o=n,s=i),On(e,r,function(e,t){const n=t[t.length-1],i=n?n.children.indexOf(e):void 0;return o(e,i,n)},s)}function Hn(e,t){const n=t.referenceType;let i="]";if("collapsed"===n?i+="[]":"full"===n&&(i+="["+(t.label||t.identifier)+"]"),"imageReference"===t.type)return[{type:"text",value:"!["+t.alt+i}];const s=e.all(t),r=s[0];r&&"text"===r.type?r.value="["+r.value:s.unshift({type:"text",value:"["});const o=s[s.length-1];return o&&"text"===o.type?o.value+=i:s.push({type:"text",value:i}),s}function Un(e){const t=e.spread;return null==t?e.children.length>1:t}function Vn(e){const t=String(e),n=/\r?\n|\r/g;let i=n.exec(t),s=0;const r=[];for(;i;)r.push(_n(t.slice(s,i.index),s>0,!0),i[0]),s=i.index+i[0].length,i=n.exec(t);return r.push(_n(t.slice(s),s>0,!1)),r.join("")}function _n(e,t,n){let i=0,s=e.length;if(t){let t=e.codePointAt(i);for(;9===t||32===t;)i++,t=e.codePointAt(i)}if(n){let t=e.codePointAt(s-1);for(;9===t||32===t;)s--,t=e.codePointAt(s-1)}return s>i?e.slice(i,s):""}const Gn={blockquote:function(e,t){const n={type:"element",tagName:"blockquote",properties:{},children:e.wrap(e.all(t),!0)};return e.patch(t,n),e.applyData(t,n)},break:function(e,t){const n={type:"element",tagName:"br",properties:{},children:[]};return e.patch(t,n),[e.applyData(t,n),{type:"text",value:"\n"}]},code:function(e,t){const n=t.value?t.value+"\n":"",i={},s=t.lang?t.lang.split(/\s+/):[];s.length>0&&(i.className=["language-"+s[0]]);let r={type:"element",tagName:"code",properties:i,children:[{type:"text",value:n}]};return t.meta&&(r.data={meta:t.meta}),e.patch(t,r),r=e.applyData(t,r),r={type:"element",tagName:"pre",properties:{},children:[r]},e.patch(t,r),r},delete:function(e,t){const n={type:"element",tagName:"del",properties:{},children:e.all(t)};return e.patch(t,n),e.applyData(t,n)},emphasis:function(e,t){const n={type:"element",tagName:"em",properties:{},children:e.all(t)};return e.patch(t,n),e.applyData(t,n)},footnoteReference:function(e,t){const n="string"==typeof e.options.clobberPrefix?e.options.clobberPrefix:"user-content-",i=String(t.identifier).toUpperCase(),s=jn(i.toLowerCase()),r=e.footnoteOrder.indexOf(i);let o,a=e.footnoteCounts.get(i);void 0===a?(a=0,e.footnoteOrder.push(i),o=e.footnoteOrder.length):o=r+1,a+=1,e.footnoteCounts.set(i,a);const l={type:"element",tagName:"a",properties:{href:"#"+n+"fn-"+s,id:n+"fnref-"+s+(a>1?"-"+a:""),dataFootnoteRef:!0,ariaDescribedBy:["footnote-label"]},children:[{type:"text",value:String(o)}]};e.patch(t,l);const c={type:"element",tagName:"sup",properties:{},children:[l]};return e.patch(t,c),e.applyData(t,c)},heading:function(e,t){const n={type:"element",tagName:"h"+t.depth,properties:{},children:e.all(t)};return e.patch(t,n),e.applyData(t,n)},html:function(e,t){if(e.options.allowDangerousHtml){const n={type:"raw",value:t.value};return e.patch(t,n),e.applyData(t,n)}},imageReference:function(e,t){const n=String(t.identifier).toUpperCase(),i=e.definitionById.get(n);if(!i)return Hn(e,t);const s={src:jn(i.url||""),alt:t.alt};null!==i.title&&void 0!==i.title&&(s.title=i.title);const r={type:"element",tagName:"img",properties:s,children:[]};return e.patch(t,r),e.applyData(t,r)},image:function(e,t){const n={src:jn(t.url)};null!==t.alt&&void 0!==t.alt&&(n.alt=t.alt),null!==t.title&&void 0!==t.title&&(n.title=t.title);const i={type:"element",tagName:"img",properties:n,children:[]};return e.patch(t,i),e.applyData(t,i)},inlineCode:function(e,t){const n={type:"text",value:t.value.replace(/\r?\n|\r/g," ")};e.patch(t,n);const i={type:"element",tagName:"code",properties:{},children:[n]};return e.patch(t,i),e.applyData(t,i)},linkReference:function(e,t){const n=String(t.identifier).toUpperCase(),i=e.definitionById.get(n);if(!i)return Hn(e,t);const s={href:jn(i.url||"")};null!==i.title&&void 0!==i.title&&(s.title=i.title);const r={type:"element",tagName:"a",properties:s,children:e.all(t)};return e.patch(t,r),e.applyData(t,r)},link:function(e,t){const n={href:jn(t.url)};null!==t.title&&void 0!==t.title&&(n.title=t.title);const i={type:"element",tagName:"a",properties:n,children:e.all(t)};return e.patch(t,i),e.applyData(t,i)},listItem:function(e,t,n){const i=e.all(t),s=n?function(e){let t=!1;if("list"===e.type){t=e.spread||!1;const n=e.children;let i=-1;for(;!t&&++i<n.length;)t=Un(n[i])}return t}(n):Un(t),r={},o=[];if("boolean"==typeof t.checked){const e=i[0];let n;e&&"element"===e.type&&"p"===e.tagName?n=e:(n={type:"element",tagName:"p",properties:{},children:[]},i.unshift(n)),n.children.length>0&&n.children.unshift({type:"text",value:" "}),n.children.unshift({type:"element",tagName:"input",properties:{type:"checkbox",checked:t.checked,disabled:!0},children:[]}),r.className=["task-list-item"]}let a=-1;for(;++a<i.length;){const e=i[a];(s||0!==a||"element"!==e.type||"p"!==e.tagName)&&o.push({type:"text",value:"\n"}),"element"!==e.type||"p"!==e.tagName||s?o.push(e):o.push(...e.children)}const l=i[i.length-1];l&&(s||"element"!==l.type||"p"!==l.tagName)&&o.push({type:"text",value:"\n"});const c={type:"element",tagName:"li",properties:r,children:o};return e.patch(t,c),e.applyData(t,c)},list:function(e,t){const n={},i=e.all(t);let s=-1;for("number"==typeof t.start&&1!==t.start&&(n.start=t.start);++s<i.length;){const e=i[s];if("element"===e.type&&"li"===e.tagName&&e.properties&&Array.isArray(e.properties.className)&&e.properties.className.includes("task-list-item")){n.className=["contains-task-list"];break}}const r={type:"element",tagName:t.ordered?"ol":"ul",properties:n,children:e.wrap(i,!0)};return e.patch(t,r),e.applyData(t,r)},paragraph:function(e,t){const n={type:"element",tagName:"p",properties:{},children:e.all(t)};return e.patch(t,n),e.applyData(t,n)},root:function(e,t){const n={type:"root",children:e.wrap(e.all(t))};return e.patch(t,n),e.applyData(t,n)},strong:function(e,t){const n={type:"element",tagName:"strong",properties:{},children:e.all(t)};return e.patch(t,n),e.applyData(t,n)},table:function(e,t){const n=e.all(t),i=n.shift(),s=[];if(i){const n={type:"element",tagName:"thead",properties:{},children:e.wrap([i],!0)};e.patch(t.children[0],n),s.push(n)}if(n.length>0){const i={type:"element",tagName:"tbody",properties:{},children:e.wrap(n,!0)},r=Y(t.children[1]),o=W(t.children[t.children.length-1]);r&&o&&(i.position={start:r,end:o}),s.push(i)}const r={type:"element",tagName:"table",properties:{},children:e.wrap(s,!0)};return e.patch(t,r),e.applyData(t,r)},tableCell:function(e,t){const n={type:"element",tagName:"td",properties:{},children:e.all(t)};return e.patch(t,n),e.applyData(t,n)},tableRow:function(e,t,n){const i=n?n.children:void 0,s=0===(i?i.indexOf(t):1)?"th":"td",r=n&&"table"===n.type?n.align:void 0,o=r?r.length:t.children.length;let a=-1;const l=[];for(;++a<o;){const n=t.children[a],i={},o=r?r[a]:void 0;o&&(i.align=o);let c={type:"element",tagName:s,properties:i,children:[]};n&&(c.children=e.all(n),e.patch(n,c),c=e.applyData(n,c)),l.push(c)}const c={type:"element",tagName:"tr",properties:{},children:e.wrap(l,!0)};return e.patch(t,c),e.applyData(t,c)},text:function(e,t){const n={type:"text",value:Vn(String(t.value))};return e.patch(t,n),e.applyData(t,n)},thematicBreak:function(e,t){const n={type:"element",tagName:"hr",properties:{},children:[]};return e.patch(t,n),e.applyData(t,n)},toml:qn,yaml:qn,definition:qn,footnoteDefinition:qn};function qn(){}const $n={}.hasOwnProperty,Zn={};function Kn(e,t){e.position&&(t.position=function(e){const t=Y(e),n=W(e);if(t&&n)return{start:t,end:n}}(e))}function Qn(e,t){let n=t;if(e&&e.data){const t=e.data.hName,i=e.data.hChildren,s=e.data.hProperties;if("string"==typeof t)if("element"===n.type)n.tagName=t;else{n={type:"element",tagName:t,properties:{},children:"children"in n?n.children:[n]}}"element"===n.type&&s&&Object.assign(n.properties,In(s)),"children"in n&&n.children&&null!=i&&(n.children=i)}return n}function Xn(e,t){const n=t.data||{},i=!("value"in t)||$n.call(n,"hProperties")||$n.call(n,"hChildren")?{type:"element",tagName:"div",properties:{},children:e.all(t)}:{type:"text",value:t.value};return e.patch(t,i),e.applyData(t,i)}function Wn(e,t){const n=[];let i=-1;for(t&&n.push({type:"text",value:"\n"});++i<e.length;)i&&n.push({type:"text",value:"\n"}),n.push(e[i]);return t&&e.length>0&&n.push({type:"text",value:"\n"}),n}function Yn(e){let t=0,n=e.charCodeAt(t);for(;9===n||32===n;)t++,n=e.charCodeAt(t);return e.slice(t)}function Jn(e,t){const n=function(e,t){const n=t||Zn,i=new Map,s=new Map,r=new Map,o={...Gn,...n.handlers},a={all:function(e){const t=[];if("children"in e){const n=e.children;let i=-1;for(;++i<n.length;){const s=a.one(n[i],e);if(s){if(i&&"break"===n[i-1].type&&(Array.isArray(s)||"text"!==s.type||(s.value=Yn(s.value)),!Array.isArray(s)&&"element"===s.type)){const e=s.children[0];e&&"text"===e.type&&(e.value=Yn(e.value))}Array.isArray(s)?t.push(...s):t.push(s)}}}return t},applyData:Qn,definitionById:i,footnoteById:s,footnoteCounts:r,footnoteOrder:[],handlers:o,one:function(e,t){const n=e.type,i=a.handlers[n];if($n.call(a.handlers,n)&&i)return i(a,e,t);if(a.options.passThrough&&a.options.passThrough.includes(n)){if("children"in e){const{children:t,...n}=e,i=In(n);return i.children=a.all(e),i}return In(e)}return(a.options.unknownHandler||Xn)(a,e,t)},options:n,patch:Kn,wrap:Wn};return zn(e,function(e){if("definition"===e.type||"footnoteDefinition"===e.type){const t="definition"===e.type?i:s,n=String(e.identifier).toUpperCase();t.has(n)||t.set(n,e)}}),a}(e,t),i=n.one(e,void 0),s=function(e){const t="string"==typeof e.options.clobberPrefix?e.options.clobberPrefix:"user-content-",n=e.options.footnoteBackContent||Tn,i=e.options.footnoteBackLabel||An,s=e.options.footnoteLabel||"Footnotes",r=e.options.footnoteLabelTagName||"h2",o=e.options.footnoteLabelProperties||{className:["sr-only"]},a=[];let l=-1;for(;++l<e.footnoteOrder.length;){const s=e.footnoteById.get(e.footnoteOrder[l]);if(!s)continue;const r=e.all(s),o=String(s.identifier).toUpperCase(),c=jn(o.toLowerCase());let u=0;const d=[],h=e.footnoteCounts.get(o);for(;void 0!==h&&++u<=h;){d.length>0&&d.push({type:"text",value:" "});let e="string"==typeof n?n:n(l,u);"string"==typeof e&&(e={type:"text",value:e}),d.push({type:"element",tagName:"a",properties:{href:"#"+t+"fnref-"+c+(u>1?"-"+u:""),dataFootnoteBackref:"",ariaLabel:"string"==typeof i?i:i(l,u),className:["data-footnote-backref"]},children:Array.isArray(e)?e:[e]})}const p=r[r.length-1];if(p&&"element"===p.type&&"p"===p.tagName){const e=p.children[p.children.length-1];e&&"text"===e.type?e.value+=" ":p.children.push({type:"text",value:" "}),p.children.push(...d)}else r.push(...d);const m={type:"element",tagName:"li",properties:{id:t+"fn-"+c},children:e.wrap(r,!0)};e.patch(s,m),a.push(m)}if(0!==a.length)return{type:"element",tagName:"section",properties:{dataFootnotes:!0,className:["footnotes"]},children:[{type:"element",tagName:r,properties:{...In(o),id:"footnote-label"},children:[{type:"text",value:s}]},{type:"text",value:"\n"},{type:"element",tagName:"ol",properties:{},children:e.wrap(a,!0)},{type:"text",value:"\n"}]}}(n),r=Array.isArray(i)?{type:"root",children:i}:i||{type:"root",children:[]};return s&&r.children.push({type:"text",value:"\n"},s),r}function ei(e,t){return e&&"run"in e?async function(n,i){const s=Jn(n,{file:i,...t});await e.run(s,i)}:function(n,i){return Jn(n,{file:i,...e||t})}}function ti(e){if(e)throw e}var ni=n(92849);function ii(e){if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||Symbol.toStringTag in e||Symbol.iterator in e)}function si(){const e=[],t={run:function(...t){let n=-1;const i=t.pop();if("function"!=typeof i)throw new TypeError("Expected function as last argument, not "+i);!function s(r,...o){const a=e[++n];let l=-1;if(r)i(r);else{for(;++l<t.length;)null!==o[l]&&void 0!==o[l]||(o[l]=t[l]);t=o,a?function(e,t){let n;return i;function i(...t){const i=e.length>t.length;let a;i&&t.push(s);try{a=e.apply(this,t)}catch(r){if(i&&n)throw r;return s(r)}i||(a&&a.then&&"function"==typeof a.then?a.then(o,s):a instanceof Error?s(a):o(a))}function s(e,...i){n||(n=!0,t(e,...i))}function o(e){s(null,e)}}(a,s)(...o):i(null,...o)}}(null,...t)},use:function(n){if("function"!=typeof n)throw new TypeError("Expected `middelware` to be a function, not "+n);return e.push(n),t}};return t}const ri={basename:function(e,t){if(void 0!==t&&"string"!=typeof t)throw new TypeError('"ext" argument must be a string');oi(e);let n,i=0,s=-1,r=e.length;if(void 0===t||0===t.length||t.length>e.length){for(;r--;)if(47===e.codePointAt(r)){if(n){i=r+1;break}}else s<0&&(n=!0,s=r+1);return s<0?"":e.slice(i,s)}if(t===e)return"";let o=-1,a=t.length-1;for(;r--;)if(47===e.codePointAt(r)){if(n){i=r+1;break}}else o<0&&(n=!0,o=r+1),a>-1&&(e.codePointAt(r)===t.codePointAt(a--)?a<0&&(s=r):(a=-1,s=o));i===s?s=o:s<0&&(s=e.length);return e.slice(i,s)},dirname:function(e){if(oi(e),0===e.length)return".";let t,n=-1,i=e.length;for(;--i;)if(47===e.codePointAt(i)){if(t){n=i;break}}else t||(t=!0);return n<0?47===e.codePointAt(0)?"/":".":1===n&&47===e.codePointAt(0)?"//":e.slice(0,n)},extname:function(e){oi(e);let t,n=e.length,i=-1,s=0,r=-1,o=0;for(;n--;){const a=e.codePointAt(n);if(47!==a)i<0&&(t=!0,i=n+1),46===a?r<0?r=n:1!==o&&(o=1):r>-1&&(o=-1);else if(t){s=n+1;break}}if(r<0||i<0||0===o||1===o&&r===i-1&&r===s+1)return"";return e.slice(r,i)},join:function(...e){let t,n=-1;for(;++n<e.length;)oi(e[n]),e[n]&&(t=void 0===t?e[n]:t+"/"+e[n]);return void 0===t?".":function(e){oi(e);const t=47===e.codePointAt(0);let n=function(e,t){let n,i,s="",r=0,o=-1,a=0,l=-1;for(;++l<=e.length;){if(l<e.length)n=e.codePointAt(l);else{if(47===n)break;n=47}if(47===n){if(o===l-1||1===a);else if(o!==l-1&&2===a){if(s.length<2||2!==r||46!==s.codePointAt(s.length-1)||46!==s.codePointAt(s.length-2))if(s.length>2){if(i=s.lastIndexOf("/"),i!==s.length-1){i<0?(s="",r=0):(s=s.slice(0,i),r=s.length-1-s.lastIndexOf("/")),o=l,a=0;continue}}else if(s.length>0){s="",r=0,o=l,a=0;continue}t&&(s=s.length>0?s+"/..":"..",r=2)}else s.length>0?s+="/"+e.slice(o+1,l):s=e.slice(o+1,l),r=l-o-1;o=l,a=0}else 46===n&&a>-1?a++:a=-1}return s}(e,!t);0!==n.length||t||(n=".");n.length>0&&47===e.codePointAt(e.length-1)&&(n+="/");return t?"/"+n:n}(t)},sep:"/"};function oi(e){if("string"!=typeof e)throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}const ai={cwd:function(){return"/"}};function li(e){return Boolean(null!==e&&"object"==typeof e&&"href"in e&&e.href&&"protocol"in e&&e.protocol&&void 0===e.auth)}function ci(e){if("string"==typeof e)e=new URL(e);else if(!li(e)){const t=new TypeError('The "path" argument must be of type string or an instance of URL. Received `'+e+"`");throw t.code="ERR_INVALID_ARG_TYPE",t}if("file:"!==e.protocol){const e=new TypeError("The URL must be of scheme file");throw e.code="ERR_INVALID_URL_SCHEME",e}return function(e){if(""!==e.hostname){const e=new TypeError('File URL host must be "localhost" or empty on darwin');throw e.code="ERR_INVALID_FILE_URL_HOST",e}const t=e.pathname;let n=-1;for(;++n<t.length;)if(37===t.codePointAt(n)&&50===t.codePointAt(n+1)){const e=t.codePointAt(n+2);if(70===e||102===e){const e=new TypeError("File URL path must not include encoded / characters");throw e.code="ERR_INVALID_FILE_URL_PATH",e}}return decodeURIComponent(t)}(e)}const ui=["history","path","basename","stem","extname","dirname"];class di{constructor(e){let t;t=e?li(e)?{path:e}:"string"==typeof e||function(e){return Boolean(e&&"object"==typeof e&&"byteLength"in e&&"byteOffset"in e)}(e)?{value:e}:e:{},this.cwd="cwd"in t?"":ai.cwd(),this.data={},this.history=[],this.messages=[],this.value,this.map,this.result,this.stored;let n,i=-1;for(;++i<ui.length;){const e=ui[i];e in t&&void 0!==t[e]&&null!==t[e]&&(this[e]="history"===e?[...t[e]]:t[e])}for(n in t)ui.includes(n)||(this[n]=t[n])}get basename(){return"string"==typeof this.path?ri.basename(this.path):void 0}set basename(e){pi(e,"basename"),hi(e,"basename"),this.path=ri.join(this.dirname||"",e)}get dirname(){return"string"==typeof this.path?ri.dirname(this.path):void 0}set dirname(e){mi(this.basename,"dirname"),this.path=ri.join(e||"",this.basename)}get extname(){return"string"==typeof this.path?ri.extname(this.path):void 0}set extname(e){if(hi(e,"extname"),mi(this.dirname,"extname"),e){if(46!==e.codePointAt(0))throw new Error("`extname` must start with `.`");if(e.includes(".",1))throw new Error("`extname` cannot contain multiple dots")}this.path=ri.join(this.dirname,this.stem+(e||""))}get path(){return this.history[this.history.length-1]}set path(e){li(e)&&(e=ci(e)),pi(e,"path"),this.path!==e&&this.history.push(e)}get stem(){return"string"==typeof this.path?ri.basename(this.path,this.extname):void 0}set stem(e){pi(e,"stem"),hi(e,"stem"),this.path=ri.join(this.dirname||"",e+(this.extname||""))}fail(e,t,n){const i=this.message(e,t,n);throw i.fatal=!0,i}info(e,t,n){const i=this.message(e,t,n);return i.fatal=void 0,i}message(e,t,n){const i=new se(e,t,n);return this.path&&(i.name=this.path+":"+i.name,i.file=this.path),i.fatal=!1,this.messages.push(i),i}toString(e){if(void 0===this.value)return"";if("string"==typeof this.value)return this.value;return new TextDecoder(e||void 0).decode(this.value)}}function hi(e,t){if(e&&e.includes(ri.sep))throw new Error("`"+t+"` cannot be a path: did not expect `"+ri.sep+"`")}function pi(e,t){if(!e)throw new Error("`"+t+"` cannot be empty")}function mi(e,t){if(!e)throw new Error("Setting `"+t+"` requires `path` to be set too")}const fi=function(e){const t=this.constructor.prototype,n=t[e],i=function(){return n.apply(i,arguments)};return Object.setPrototypeOf(i,t),i},gi={}.hasOwnProperty;class yi extends fi{constructor(){super("copy"),this.Compiler=void 0,this.Parser=void 0,this.attachers=[],this.compiler=void 0,this.freezeIndex=-1,this.frozen=void 0,this.namespace={},this.parser=void 0,this.transformers=si()}copy(){const e=new yi;let t=-1;for(;++t<this.attachers.length;){const n=this.attachers[t];e.use(...n)}return e.data(ni(!0,{},this.namespace)),e}data(e,t){return"string"==typeof e?2===arguments.length?(Si("data",this.frozen),this.namespace[e]=t,this):gi.call(this.namespace,e)&&this.namespace[e]||void 0:e?(Si("data",this.frozen),this.namespace=e,this):this.namespace}freeze(){if(this.frozen)return this;const e=this;for(;++this.freezeIndex<this.attachers.length;){const[t,...n]=this.attachers[this.freezeIndex];if(!1===n[0])continue;!0===n[0]&&(n[0]=void 0);const i=t.call(e,...n);"function"==typeof i&&this.transformers.use(i)}return this.frozen=!0,this.freezeIndex=Number.POSITIVE_INFINITY,this}parse(e){this.freeze();const t=ki(e),n=this.parser||this.Parser;return bi("parse",n),n(String(t),t)}process(e,t){const n=this;return this.freeze(),bi("process",this.parser||this.Parser),xi("process",this.compiler||this.Compiler),t?i(void 0,t):new Promise(i);function i(i,s){const r=ki(e),o=n.parse(r);function a(e,n){e||!n?s(e):i?i(n):t(void 0,n)}n.run(o,r,function(e,t,i){if(e||!t||!i)return a(e);const s=t,r=n.stringify(s,i);var o;"string"==typeof(o=r)||function(e){return Boolean(e&&"object"==typeof e&&"byteLength"in e&&"byteOffset"in e)}(o)?i.value=r:i.result=r,a(e,i)})}}processSync(e){let t,n=!1;return this.freeze(),bi("processSync",this.parser||this.Parser),xi("processSync",this.compiler||this.Compiler),this.process(e,function(e,i){n=!0,ti(e),t=i}),wi("processSync","process",n),t}run(e,t,n){Ci(e),this.freeze();const i=this.transformers;return n||"function"!=typeof t||(n=t,t=void 0),n?s(void 0,n):new Promise(s);function s(s,r){const o=ki(t);i.run(e,o,function(t,i,o){const a=i||e;t?r(t):s?s(a):n(void 0,a,o)})}}runSync(e,t){let n,i=!1;return this.run(e,t,function(e,t){ti(e),n=t,i=!0}),wi("runSync","run",i),n}stringify(e,t){this.freeze();const n=ki(t),i=this.compiler||this.Compiler;return xi("stringify",i),Ci(e),i(e,n)}use(e,...t){const n=this.attachers,i=this.namespace;if(Si("use",this.frozen),null==e);else if("function"==typeof e)a(e,t);else{if("object"!=typeof e)throw new TypeError("Expected usable value, not `"+e+"`");Array.isArray(e)?o(e):r(e)}return this;function s(e){if("function"==typeof e)a(e,[]);else{if("object"!=typeof e)throw new TypeError("Expected usable value, not `"+e+"`");if(Array.isArray(e)){const[t,...n]=e;a(t,n)}else r(e)}}function r(e){if(!("plugins"in e)&&!("settings"in e))throw new Error("Expected usable value but received an empty preset, which is probably a mistake: presets typically come with `plugins` and sometimes with `settings`, but this has neither");o(e.plugins),e.settings&&(i.settings=ni(!0,i.settings,e.settings))}function o(e){let t=-1;if(null==e);else{if(!Array.isArray(e))throw new TypeError("Expected a list of plugins, not `"+e+"`");for(;++t<e.length;){s(e[t])}}}function a(e,t){let i=-1,s=-1;for(;++i<n.length;)if(n[i][0]===e){s=i;break}if(-1===s)n.push([e,...t]);else if(t.length>0){let[i,...r]=t;const o=n[s][1];ii(o)&&ii(i)&&(i=ni(!0,o,i)),n[s]=[e,i,...r]}}}}const vi=(new yi).freeze();function bi(e,t){if("function"!=typeof t)throw new TypeError("Cannot `"+e+"` without `parser`")}function xi(e,t){if("function"!=typeof t)throw new TypeError("Cannot `"+e+"` without `compiler`")}function Si(e,t){if(t)throw new Error("Cannot call `"+e+"` on a frozen processor.\nCreate a new processor first, by calling it: use `processor()` instead of `processor`.")}function Ci(e){if(!ii(e)||"string"!=typeof e.type)throw new TypeError("Expected node, got `"+e+"`")}function wi(e,t,n){if(!n)throw new Error("`"+e+"` finished async. Use `"+t+"` instead")}function ki(e){return function(e){return Boolean(e&&"object"==typeof e&&"message"in e&&"messages"in e)}(e)?e:new di(e)}const Bi=[],Pi={allowDangerousHtml:!0},Ii=/^(https?|ircs?|mailto|xmpp)$/i,ji=[{from:"astPlugins",id:"remove-buggy-html-in-markdown-parser"},{from:"allowDangerousHtml",id:"remove-buggy-html-in-markdown-parser"},{from:"allowNode",id:"replace-allownode-allowedtypes-and-disallowedtypes",to:"allowElement"},{from:"allowedTypes",id:"replace-allownode-allowedtypes-and-disallowedtypes",to:"allowedElements"},{from:"className",id:"remove-classname"},{from:"disallowedTypes",id:"replace-allownode-allowedtypes-and-disallowedtypes",to:"disallowedElements"},{from:"escapeHtml",id:"remove-buggy-html-in-markdown-parser"},{from:"includeElementIndex",id:"#remove-includeelementindex"},{from:"includeNodeIndex",id:"change-includenodeindex-to-includeelementindex"},{from:"linkTarget",id:"remove-linktarget"},{from:"plugins",id:"change-plugins-to-remarkplugins",to:"remarkPlugins"},{from:"rawSourcePos",id:"#remove-rawsourcepos"},{from:"renderers",id:"change-renderers-to-components",to:"components"},{from:"source",id:"change-source-to-children",to:"children"},{from:"sourcePos",id:"#remove-sourcepos"},{from:"transformImageUri",id:"#add-urltransform",to:"urlTransform"},{from:"transformLinkUri",id:"#add-urltransform",to:"urlTransform"}];function Ti(e){const t=Ai(e),n=Mi(e);return Li(t.runSync(t.parse(n),n),e)}function Ai(e){const t=e.rehypePlugins||Bi,n=e.remarkPlugins||Bi,i=e.remarkRehypeOptions?{...e.remarkRehypeOptions,...Pi}:Pi;return vi().use(vn).use(n).use(ei,i).use(t)}function Mi(e){const t=e.children||"",n=new di;return"string"==typeof t&&(n.value=t),n}function Li(e,t){const n=t.allowedElements,i=t.allowElement,s=t.components,r=t.disallowedElements,a=t.skipHtml,l=t.unwrapDisallowed,c=t.urlTransform||Ei;for(const o of ji)Object.hasOwn(t,o.from)&&u((o.from,o.to&&o.to,o.id));return zn(e,function(e,t,s){if("raw"===e.type&&s&&"number"==typeof t)return a?s.children.splice(t,1):s.children[t]={type:"text",value:e.value},t;if("element"===e.type){let t;for(t in Se)if(Object.hasOwn(Se,t)&&Object.hasOwn(e.properties,t)){const n=e.properties[t],i=Se[t];(null===i||i.includes(e.tagName))&&(e.properties[t]=c(String(n||""),t,e))}}if("element"===e.type){let o=n?!n.includes(e.tagName):!!r&&r.includes(e.tagName);if(!o&&i&&"number"==typeof t&&(o=!i(e,t,s)),o&&s&&"number"==typeof t)return l&&e.children?s.children.splice(t,1,...e.children):s.children.splice(t,1),t}}),de(e,{Fragment:o.Fragment,components:s,ignoreInvalidStyle:!0,jsx:o.jsx,jsxs:o.jsxs,passKeys:!0,passNode:!0})}function Ei(e){const t=e.indexOf(":"),n=e.indexOf("?"),i=e.indexOf("#"),s=e.indexOf("/");return-1===t||-1!==s&&t>s||-1!==n&&t>n||-1!==i&&t>i||Ii.test(e.slice(0,t))?e:""}var Di=n(57365),Ni=n(45212),Fi=n(17e3),Ri=n(30099),Oi=n(96410),zi=n(90336);class Hi extends l.dL{constructor(){super(...arguments),this.updateParams=e=>{this.plugin.managers.animation.updateParams({[e.name]:e.value})},this.updateCurrentParams=e=>{this.plugin.managers.animation.updateCurrentParams({[e.name]:e.value})},this.startOrStop=()=>{const e=this.plugin.managers.animation;"playing"===e.state.animationState?e.stop():(this.props.onStart&&this.props.onStart(),e.start())}}componentDidMount(){this.subscribe(this.plugin.managers.animation.events.updated,()=>this.forceUpdate())}render(){var e,t;const n=this.plugin.managers.animation;if(n.isEmpty)return null;const i="playing"===n.state.animationState,s=null===(t=(e=n.current.anim).canApply)||void 0===t?void 0:t.call(e,this.plugin);return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(zi.y1,{params:n.getParams(),values:n.state.params,onChange:this.updateParams,isDisabled:i}),(0,o.jsx)(zi.y1,{params:n.current.params,values:n.current.paramValues,onChange:this.updateCurrentParams,isDisabled:i}),(0,o.jsx)("div",{className:"msp-flex-row",children:(0,o.jsx)(Ri.$n,{icon:"playing"!==n.state.animationState?void 0:Oi.M6,onClick:this.startOrStop,disabled:void 0!==s&&!1===s.canApply,children:"playing"===n.state.animationState?"Stop":void 0===s||s.canApply?"Start":s.reason||"Start"})})]})}}var Ui=n(29012),Vi=n(92360),_i=n(72110),Gi=n(28243),qi=n(58247),$i=n(88610),Zi=n(24832),Ki=n(23391),Qi=n(35332),Xi=n(9422),Wi=n(86431),Yi=n(66139),Ji=n(58810),es=n(78739),ts=n(51139);const ns="overpaint-controls";async function is(e,t,n,i,s){await ss(e,t,async(e,t,r)=>{if(s&&s.length>0&&!s.includes(t.params.values.type.name))return;const o=t.obj.data.sourceData,a=await i(o.root);if(ts.QN.isEmpty(a)||(0,ts.$M)(a))return;const l={bundle:Gi.iZ.Bundle.fromLoci(a),color:-1===n?(0,es.Q1)(0):n,clear:-1===n};if(r){const t=rs([...r.params.values.layers,l],o);e.to(r).update(Ji.l.toBundle(t))}else{const n=rs([l],o);e.to(t.transform.ref).apply(Ni.f.Representation.OverpaintStructureRepresentation3DFromBundle,Ji.l.toBundle(n),{tags:ns})}})}async function ss(e,t,n){const i=e.state.data,s=i.build();for(const r of t)for(const e of r.representations){const t=i.select(Yi.QX.Generators.ofTransformer(Ni.f.Representation.OverpaintStructureRepresentation3DFromBundle,e.cell.transform.ref).withTag(ns));await n(s,e.cell,t[0])}return s.commit({doNotUpdateCurrent:!0})}function rs(e,t){const n=Ji.l.ofBundle(e,t.root),i=Ji.l.merge(n);return Ji.l.filter(i,t)}var os=n(11485),as=n(13554),ls=n(25064);const cs="clipping-controls";async function us(e,t,n,i,s){await async function(e,t,n){const i=e.state.data,s=i.build();for(const r of t)for(const e of r.representations){const t=i.select(Yi.QX.Generators.ofTransformer(Ni.f.Representation.ClippingStructureRepresentation3DFromBundle,e.cell.transform.ref).withTag(cs));await n(s,e.cell,t[0])}return s.commit({doNotUpdateCurrent:!0})}(e,t,async(e,t,r)=>{if(s&&s.length>0&&!s.includes(t.params.values.type.name))return;const o=t.obj.data.sourceData,a=await i(o.root);if(ts.QN.isEmpty(a)||(0,ts.$M)(a))return;const l={bundle:Gi.iZ.Bundle.fromLoci(a),groups:n};if(r){const t=ds([...r.params.values.layers,l],o);e.to(r).update(ls.l.toBundle(t))}else{const n=ds([l],o);e.to(t.transform.ref).apply(Ni.f.Representation.ClippingStructureRepresentation3DFromBundle,ls.l.toBundle(n),{tags:cs})}})}function ds(e,t){const n=ls.l.ofBundle(e,t.root),i=ls.l.merge(n);return ls.l.filter(i,t)}var hs=n(75216);const ps="transparency-controls";async function ms(e,t,n,i,s){await fs(e,t,async(e,t,r)=>{if(s&&s.length>0&&!s.includes(t.params.values.type.name))return;const o=t.obj.data.sourceData,a=await i(o.root);if(ts.QN.isEmpty(a)||(0,ts.$M)(a))return;const l={bundle:Gi.iZ.Bundle.fromLoci(a),value:n};if(r){const t=gs([...r.params.values.layers,l],o);e.to(r).update(hs.x.toBundle(t))}else{const n=gs([l],o);e.to(t.transform.ref).apply(Ni.f.Representation.TransparencyStructureRepresentation3DFromBundle,hs.x.toBundle(n),{tags:ps})}})}async function fs(e,t,n){const i=e.state.data,s=i.build();for(const r of t)for(const e of r.representations){const t=i.select(Yi.QX.Generators.ofTransformer(Ni.f.Representation.TransparencyStructureRepresentation3DFromBundle,e.cell.transform.ref).withTag(ps));await n(s,e.cell,t[0])}return s.commit({doNotUpdateCurrent:!0})}function gs(e,t){const n=hs.x.ofBundle(e,t.root),i=hs.x.merge(n);return hs.x.filter(i,t)}var ys=n(78588),vs=n(16754),bs=n(330);const xs="substance-controls";async function Ss(e,t,n,i,s){await Cs(e,t,async(e,t,r)=>{if(s&&s.length>0&&!s.includes(t.params.values.type.name))return;const o=t.obj.data.sourceData,a=await i(o.root);if(ts.QN.isEmpty(a)||(0,ts.$M)(a))return;const l={bundle:Gi.iZ.Bundle.fromLoci(a),material:null!=n?n:(0,bs.i)(),clear:!n};if(r){const t=ws([...r.params.values.layers,l],o);e.to(r).update(vs.l.toBundle(t))}else{const n=ws([l],o);e.to(t.transform.ref).apply(Ni.f.Representation.SubstanceStructureRepresentation3DFromBundle,vs.l.toBundle(n),{tags:xs})}})}async function Cs(e,t,n){const i=e.state.data,s=i.build();for(const r of t)for(const e of r.representations){const t=i.select(Yi.QX.Generators.ofTransformer(Ni.f.Representation.SubstanceStructureRepresentation3DFromBundle,e.cell.transform.ref).withTag(xs));await n(s,e.cell,t[0])}return s.commit({doNotUpdateCurrent:!0})}function ws(e,t){const n=vs.l.ofBundle(e,t.root),i=vs.l.merge(n);return vs.l.filter(i,t)}var ks=n(84481),Bs=n(57589);const Ps="emissive-controls";async function Is(e,t,n,i,s){await js(e,t,async(e,t,r)=>{if(s&&s.length>0&&!s.includes(t.params.values.type.name))return;const o=t.obj.data.sourceData,a=await i(o.root);if(ts.QN.isEmpty(a)||(0,ts.$M)(a))return;const l={bundle:Gi.iZ.Bundle.fromLoci(a),value:n};if(r){const t=Ts([...r.params.values.layers,l],o);e.to(r).update(Bs.a.toBundle(t))}else{const n=Ts([l],o);e.to(t.transform.ref).apply(Ni.f.Representation.EmissiveStructureRepresentation3DFromBundle,Bs.a.toBundle(n),{tags:Ps})}})}async function js(e,t,n){const i=e.state.data,s=i.build();for(const r of t)for(const e of r.representations){const t=i.select(Yi.QX.Generators.ofTransformer(Ni.f.Representation.EmissiveStructureRepresentation3DFromBundle,e.cell.transform.ref).withTag(Ps));await n(s,e.cell,t[0])}return s.commit({doNotUpdateCurrent:!0})}function Ts(e,t){const n=Bs.a.ofBundle(e,t.root),i=Bs.a.merge(n);return Bs.a.filter(i,t)}class As extends Wi.e{get currentStructures(){return this.plugin.managers.structure.hierarchy.selection.structures}get pivotStructure(){return this.currentStructures[0]}_setSnapshotState(e){this.updateState({options:e}),this.events.optionsUpdated.next(void 0)}async setOptions(e){const t=e.interactions!==this.state.options.interactions;this.updateState({options:e}),this.events.optionsUpdated.next(void 0);const n=this.dataState.build();for(const i of this.currentStructures)for(const e of i.components)this.updateReprParams(n,e);return this.plugin.dataTransaction(async()=>{await n.commit(),await this.plugin.state.updateBehavior(ys.b,t=>{t.ignoreHydrogens="all"!==e.hydrogens,t.ignoreHydrogensVariant="only-polar"===e.hydrogens?"non-polar":"all",t.ignoreLight=e.ignoreLight,t.material=e.materialStyle,t.clip=e.clipObjects}),t&&await this.updateInterationProps()})}updateReprParams(e,t){const{hydrogens:n,visualQuality:i,ignoreLight:s,materialStyle:r,clipObjects:o}=this.state.options,l="all"!==n,c="only-polar"===n?"non-polar":"all";for(const u of t.representations){if(u.cell.transform.transformer!==as.StructureRepresentation3D)continue;const t=u.cell.transform.params;!!t.type.params.ignoreHydrogens===l&&t.type.params.ignoreHydrogensVariant===c&&t.type.params.quality===i&&t.type.params.ignoreLight===s&&(0,a.bN)(t.type.params.material,r)&&Xi.t.areEqual(ks.B.Params,t.type.params.clip,o)||e.to(u.cell).update(e=>{e.type.params.ignoreHydrogens=l,e.type.params.ignoreHydrogensVariant=c,e.type.params.quality=i,e.type.params.ignoreLight=s,e.type.params.material=r,e.type.params.clip=o})}}async updateInterationProps(){var e,t,n;for(const i of this.currentStructures){const s=_i.r.getParams(null===(e=i.cell.obj)||void 0===e?void 0:e.data);if(i.properties){const e=null===(t=i.properties.cell.transform.params)||void 0===t?void 0:t.properties[_i.r.descriptor.name];if(Xi.t.areEqual(s,e,this.state.options.interactions))continue;await this.dataState.build().to(i.properties.cell).update(e=>{e.properties[_i.r.descriptor.name]=this.state.options.interactions}).commit()}else{const e=this.plugin.customStructureProperties.getParams(null===(n=i.cell.obj)||void 0===n?void 0:n.data),t=Xi.t.getDefaultValues(e);if(Xi.t.areEqual(s,t.properties[_i.r.descriptor.name],this.state.options.interactions))continue;t.properties[_i.r.descriptor.name]=this.state.options.interactions,await this.plugin.builders.structure.insertStructureProperties(i.cell,t)}}}applyPreset(e,t,n){return this.plugin.dataTransaction(async()=>{for(const i of e){const e=await this.plugin.builders.structure.representation.applyPreset(i.cell,t,n);await this.syncPreset(i,e)}},{canUndo:"Preset"})}syncPreset(e,t){if(!t||!t.components)return this.clearComponents([e]);const n=new Set;if((0,Qi.IF)(t.components,e=>{e&&n.add(e.ref)}),t.representations&&(0,Qi.IF)(t.representations,e=>{e&&n.add(e.ref)}),0===n.size)return this.clearComponents([e]);let i=!1;const s=this.dataState.build(),r=e=>{n.has(e.cell.transform.ref)||(i=!0,s.delete(e.cell))};for(const o of e.components){r(o);for(const e of o.representations)r(e);if(o.genericRepresentations)for(const e of o.genericRepresentations)r(e)}if(e.genericRepresentations)for(const o of e.genericRepresentations)r(o);return i?s.commit():void 0}clear(e){return this.clearComponents(e)}selectThis(e){var t;const n=this.plugin.managers.structure.selection;n.clear();for(const i of e){const e=Gi.Structure.toSubStructureElementLoci(i.structure.cell.obj.data,null===(t=i.cell.obj)||void 0===t?void 0:t.data);n.fromLoci("set",e)}}canBeModified(e){return this.plugin.builders.structure.isComponentTransform(e.cell)}modifyByCurrentSelection(e,t){return this.plugin.runTask(Zi.YZ.create("Modify Component",async n=>{const i=this.dataState.build();for(const s of e){if(!this.canBeModified(s))continue;const e=this.plugin.managers.structure.selection.getStructure(s.structure.cell.obj.data);e&&0!==e.elementCount&&this.modifyComponent(i,s,e,t)}await this.dataState.updateTree(i,{canUndo:"Modify Selection"}).runInContext(n)}))}toggleVisibility(e,t){if(0!==e.length)if(t){const n=e[0].representations.indexOf(t),i=!t.cell.state.isHidden;for(const t of e){const e=t.representations[n];e&&(0,$i.setSubtreeVisibility)(this.dataState,e.cell.transform.ref,i)}}else{const t=!e[0].cell.state.isHidden;for(const n of e)(0,$i.setSubtreeVisibility)(this.dataState,n.cell.transform.ref,t)}}removeRepresentations(e,t){if(0===e.length)return;const n=[];if(t){const i=e[0].representations.indexOf(t);if(i<0)return;for(const t of e)t.representations[i]&&n.push(t.representations[i])}else for(const i of e)for(const e of i.representations)n.push(e);return this.plugin.managers.structure.hierarchy.remove(n,!0)}updateRepresentations(e,t,n){if(0===e.length)return Promise.resolve();const i=e[0].representations.indexOf(t);if(i<0)return Promise.resolve();const s=this.dataState.build();for(const r of e){const e=r.representations[i];e&&(e.cell.transform.transformer===t.cell.transform.transformer&&s.to(e.cell).update(n))}return s.commit({canUndo:"Update Representation"})}updateRepresentationsTheme(e,t){var n,i,s,r;if(0===e.length)return;const o=this.dataState.build();for(const a of e)for(const e of a.representations){const l=e.cell.transform.params,c="function"==typeof t?t(a,e):t,u="default"===c.color?(0,Ui.IZ)(this.plugin,null===(n=a.structure.cell.obj)||void 0===n?void 0:n.data,null==l?void 0:l.type.name):c.color?(0,Ui.IZ)(this.plugin,null===(i=a.structure.cell.obj)||void 0===i?void 0:i.data,null==l?void 0:l.type.name,c.color,c.colorParams):void 0,d="default"===c.size?(0,Ui.eD)(this.plugin,null===(s=a.structure.cell.obj)||void 0===s?void 0:s.data,null==l?void 0:l.type.name):c.color?(0,Ui.eD)(this.plugin,null===(r=a.structure.cell.obj)||void 0===r?void 0:r.data,null==l?void 0:l.type.name,c.size,c.sizeParams):void 0;(u||d)&&o.to(e.cell).update(e=>{u&&(e.colorTheme=u),d&&(e.sizeTheme=d)})}return o.commit({canUndo:"Update Theme"})}addRepresentation(e,t){if(0===e.length)return;const{hydrogens:n,visualQuality:i,ignoreLight:s,materialStyle:r,clipObjects:o}=this.state.options,a={ignoreHydrogens:"all"!==n,ignoreHydrogensVariant:"only-polar"===n?"non-polar":"all",quality:i,ignoreLight:s,material:r,clip:o};return this.plugin.dataTransaction(async()=>{for(const n of e)await this.plugin.builders.structure.representation.addRepresentation(n.cell,{type:this.plugin.representation.structure.registry.get(t),typeParams:a})},{canUndo:"Add Representation"})}tryFindComponent(e,t){if(0!==e.components.length)return this.plugin.runTask(Zi.YZ.create("Find Component",async n=>{var i,s;const r=null===(i=e.cell.obj)||void 0===i?void 0:i.data;if(!r)return;const o=Gi.cv.unionStructure(await t.getSelection(this.plugin,n,r));for(const t of e.components){const e=null===(s=t.cell.obj)||void 0===s?void 0:s.data;if(e&&t.cell.parent&&(0,qi.IP)(o,e))return t.cell}}))}async add(e,t){return this.plugin.dataTransaction(async()=>{const n=t||this.currentStructures;if(0===n.length)return;const{hydrogens:i,visualQuality:s,ignoreLight:r,materialStyle:o,clipObjects:l}=this.state.options,c={ignoreHydrogens:"all"!==i,ignoreHydrogensVariant:"only-polar"===i?"non-polar":"all",quality:s,ignoreLight:r,material:o,clip:l},u=a.kk.create22();for(const t of n){let n;e.options.checkExisting&&(n=await this.tryFindComponent(t,e.selection)),n||(n=await this.plugin.builders.structure.tryCreateComponentFromSelection(t.cell,e.selection,u,{label:e.options.label||(e.selection===os.Ou.current?"Custom Selection":"")})),"none"!==e.representation&&n&&await this.plugin.builders.structure.representation.addRepresentation(n,{type:this.plugin.representation.structure.registry.get(e.representation),typeParams:c})}},{canUndo:"Add Selection"})}async applyTheme(e,t){return this.plugin.dataTransaction(async n=>{const i=t||this.currentStructures;if(0===i.length)return;const s=async t=>Gi.cv.toLociWithSourceUnits(await e.selection.getSelection(this.plugin,n,t));for(const t of i)if("color"===e.action.name){const n=e.action.params;await is(this.plugin,t.components,n.color,s,e.representations)}else if("resetColor"===e.action.name)await is(this.plugin,t.components,-1,s,e.representations);else if("transparency"===e.action.name){const n=e.action.params;await ms(this.plugin,t.components,n.value,s,e.representations)}else if("emissive"===e.action.name){const n=e.action.params;await Is(this.plugin,t.components,n.value,s,e.representations)}else if("material"===e.action.name){const n=e.action.params;await Ss(this.plugin,t.components,n.material,s,e.representations)}else if("resetMaterial"===e.action.name)await Ss(this.plugin,t.components,void 0,s,e.representations);else if("clipping"===e.action.name){const n=e.action.params;await us(this.plugin,t.components,ls.l.Groups.fromNames(n.excludeGroups),s,e.representations)}},{canUndo:"Apply Theme"})}modifyComponent(e,t,n,i){var s,r,o;const a=null===(s=t.cell.obj)||void 0===s?void 0:s.data;if(!a)return;if(("subtract"===i||"intersect"===i)&&!(0,qi.HK)(a,n))return;const l=null===(r=t.structure.cell.obj)||void 0===r?void 0:r.data,c="union"===i?(0,qi.l6)(l,[a,n]):"intersect"===i?(0,qi.jU)(a,n):(0,qi.Kt)(a,n);if(0===c.elementCount)e.delete(t.cell.transform.ref);else{const n={type:{name:"bundle",params:Gi.iZ.Bundle.fromSubStructure(l,c)},nullIfEmpty:!0,label:null===(o=t.cell.obj)||void 0===o?void 0:o.label};e.to(t.cell).update(n)}}updateLabel(e,t){var n,i;const s={type:null===(n=e.cell.params)||void 0===n?void 0:n.values.type,nullIfEmpty:null===(i=e.cell.params)||void 0===i?void 0:i.values.nullIfEmpty,label:t};this.dataState.build().to(e.cell).update(s).commit()}get dataState(){return this.plugin.state.data}clearComponents(e){const t=this.dataState.build();for(const n of e)for(const e of n.components)t.delete(e.cell.transform.ref);return t.commit({canUndo:"Clear Selections"})}constructor(e){super({options:Xi.t.getDefaultValues(As.OptionsParams)}),this.plugin=e,this.events={optionsUpdated:this.ev()}}}!function(e){function t(e,t){var n,i;return(null===(n=null==t?void 0:t.cell.obj)||void 0===n?void 0:n.data)?e.representation.structure.registry.getApplicableTypes(null===(i=t.cell.obj)||void 0===i?void 0:i.data):e.representation.structure.registry.types}function n(e,n,i,s){const r=[...i,...t(e,n)];return Xi.t.Select(r[0][0],r,{label:s})}e.OptionsParams={hydrogens:Xi.t.Select("all",[["all","Show All"],["hide-all","Hide All"],["only-polar","Only Polar"]],{description:"Determine display of hydrogen atoms in representations"}),visualQuality:Xi.t.Select("auto",Vi.sF,{description:"Control the visual/rendering quality of representations"}),ignoreLight:Xi.t.Boolean(!1,{description:"Ignore light for stylized rendering of representations"}),materialStyle:bs.i.getParam(),clipObjects:Xi.t.Group(ks.B.Params),interactions:Xi.t.Group(_i.r.defaultParams,{label:"Non-covalent Interactions"})},e.getAddParams=function(e,t){const{options:i}=e.query.structure.registry;return t={pivot:e.managers.structure.component.pivotStructure,allowNone:!0,hideSelection:!1,checkExisting:!1,...t},{selection:Xi.t.Select(i[1][0],i,{isHidden:null==t?void 0:t.hideSelection}),representation:n(e,null==t?void 0:t.pivot,(null==t?void 0:t.allowNone)?[["none","< Create Later >"]]:[]),options:Xi.t.Group({label:Xi.t.Text(""),checkExisting:Xi.t.Boolean(!!(null==t?void 0:t.checkExisting),{help:()=>({description:"Checks if a selection with the specifield elements already exists to avoid creating duplicate components."})})})}},e.getThemeParams=function(e,n){const{options:i}=e.query.structure.registry;return{selection:Xi.t.Select(i[1][0],i,{isHidden:!1}),action:Xi.t.MappedStatic("color",{color:Xi.t.Group({color:Xi.t.Color(Ki.s.blue,{isExpanded:!0})},{isFlat:!0}),resetColor:Xi.t.EmptyGroup({label:"Reset Color"}),transparency:Xi.t.Group({value:Xi.t.Numeric(.5,{min:0,max:1,step:.01})},{isFlat:!0}),emissive:Xi.t.Group({value:Xi.t.Numeric(.5,{min:0,max:1,step:.01})},{isFlat:!0}),material:Xi.t.Group({material:bs.i.getParam({isFlat:!0})},{isFlat:!0}),resetMaterial:Xi.t.EmptyGroup({label:"Reset Material"}),clipping:Xi.t.Group({excludeGroups:Xi.t.MultiSelect([],Xi.t.objectToOptions(ls.l.Groups.Names))},{isFlat:!0})}),representations:Xi.t.MultiSelect([],t(e,n),{emptyValue:"All"})}},e.getRepresentationTypes=t}(As||(As={}));var Ms=n(24303),Ls=n(12720),Es=n(26088);function Ds(e,t){const n=function(e,t){return{state:e,oldHierarchy:t,hierarchy:Ns(),changed:!1,added:new Set}}(e,t||Ns());return function(e,t){const n={tree:e,state:t};sr(n,e.root),n.state}(e.tree,n),t&&t.refs.forEach(nr,n),{hierarchy:n.hierarchy,added:n.added,changed:n.changed}}function Ns(){return{trajectories:[],models:[],structures:[],refs:new Map}}function Fs(e){return{kind:"trajectory",cell:e,version:e.transform.version,models:[]}}function Rs(e,t){return{kind:"model",cell:e,version:e.transform.version,trajectory:t,structures:[]}}function Os(e,t){return{kind:"model-properties",cell:e,version:e.transform.version,model:t}}function zs(e,t){return{kind:"model-unitcell",cell:e,version:e.transform.version,model:t}}function Hs(e,t){return{kind:"structure",cell:e,version:e.transform.version,model:t,components:[]}}function Us(e,t){return{kind:"structure-properties",cell:e,version:e.transform.version,structure:t}}function Vs(e,t){return{kind:"structure-transform",cell:e,version:e.transform.version,structure:t}}function _s(e,t){return{kind:"structure-volume-streaming",cell:e,version:e.transform.version,structure:t}}function Gs(e){return e.transform.tags?[...e.transform.tags].sort().join():e.transform.ref}function qs(e,t){return{kind:"structure-component",cell:e,version:e.transform.version,structure:t,key:Gs(e),representations:[]}}function $s(e,t){return{kind:"structure-representation",cell:e,version:e.transform.version,component:t}}function Zs(e,t){return{kind:"generic-representation",cell:e,version:e.transform.version,parent:t}}function Ks(e,t,n,i,...s){const r=i(...s);n.push(r),e.hierarchy.refs.set(t.transform.ref,r);const o=e.oldHierarchy.refs.get(t.transform.ref);return o?o.version!==t.transform.version&&(e.changed=!0):(e.added.add(r.cell.transform.ref),e.changed=!0),r}function Qs(e,t,n,...i){const s=n(...i);e.hierarchy.refs.set(t.transform.ref,s);const r=e.oldHierarchy.refs.get(t.transform.ref);return r?r.version!==t.transform.version&&(e.changed=!0):(e.added.add(s.cell.transform.ref),e.changed=!0),s}function Xs(e){return t=>e.is(t.obj)}function Ws(e,t){return(n,i)=>!t(i)&&e.is(n.obj)}function Ys(e){return t=>t.transform.transformer===e}function Js(){}const er=[[Xs(Ls.O.Molecule.Trajectory),(e,t)=>{e.currentTrajectory=Ks(e,t,e.hierarchy.trajectories,Fs,t)},e=>e.currentTrajectory=void 0],[Ws(Ls.O.Molecule.Model,e=>e.currentModel),(e,t)=>{e.currentTrajectory?e.currentModel=Ks(e,t,e.currentTrajectory.models,Rs,t,e.currentTrajectory):e.currentModel=Qs(e,t,Rs,t),e.hierarchy.models.push(e.currentModel)},e=>e.currentModel=void 0],[Ys(Ni.f.Model.CustomModelProperties),(e,t)=>{if(!e.currentModel)return!1;e.currentModel.properties=Qs(e,t,Os,t,e.currentModel)},Js],[Ys(Ni.f.Representation.ModelUnitcell3D),(e,t)=>{if(!e.currentModel)return!1;e.currentModel.unitcell=Qs(e,t,zs,t,e.currentModel)},Js],[Ws(Ls.O.Molecule.Structure,e=>e.currentStructure),(e,t)=>{e.currentModel?e.currentStructure=Ks(e,t,e.currentModel.structures,Hs,t,e.currentModel):e.currentStructure=Qs(e,t,Hs,t),e.hierarchy.structures.push(e.currentStructure)},e=>e.currentStructure=void 0],[Ys(Ni.f.Model.CustomStructureProperties),(e,t)=>{if(!e.currentStructure)return!1;e.currentStructure.properties=Qs(e,t,Us,t,e.currentStructure)},Js],[Ys(Ni.f.Model.TransformStructureConformation),(e,t)=>{if(!e.currentStructure)return!1;e.currentStructure.transform=Qs(e,t,Vs,t,e.currentStructure)},Js],[Xs(Es.h),(e,t)=>!!e.currentStructure&&(e.currentStructure.volumeStreaming=Qs(e,t,_s,t,e.currentStructure),!1),Js],[(e,t)=>!(!t.currentStructure||e.transform.transformer.definition.isDecorator)&&Ls.O.Molecule.Structure.is(e.obj),(e,t)=>{e.currentStructure&&(e.currentComponent&&(e.parentComponents||(e.parentComponents=[]),e.parentComponents.push(e.currentComponent)),e.currentComponent=Ks(e,t,e.currentStructure.components,qs,t,e.currentStructure))},e=>{e.parentComponents&&e.parentComponents.length>0?e.currentComponent=e.parentComponents.pop():e.currentComponent=void 0}],[(e,t)=>!e.state.isGhost&&!!t.currentComponent&&Ls.O.Molecule.Structure.Representation3D.is(e.obj),(e,t)=>(e.currentComponent&&Ks(e,t,e.currentComponent.representations,$s,t,e.currentComponent),!1),Js],[e=>!e.state.isGhost&&Ls.O.isRepresentation3D(e.obj),(e,t)=>{const n=e.currentComponent||e.currentStructure||e.currentModel;n&&(n.genericRepresentations||(n.genericRepresentations=[]),Ks(e,t,n.genericRepresentations,Zs,t,n))},Js]];function tr(e){if(!e||!(null==e?void 0:e.parent)||!e.parent.cells.has(e.transform.ref))return!1;const{obj:t}=e;return!(!t||t===Yi.BM.Null||"ok"!==e.status&&"error"!==e.status)}function nr(e){const{cell:t}=e;tr(t)||(this.changed=!0)}function ir(e){sr(this,this.tree.transforms.get(e))}function sr(e,t){const{state:n}=e,i=n.state.cells.get(t.ref);if(!tr(i))return;let s,r=!1;for(const[a,l,c]of er)if(a(i,n)){if(!1===l(n,i)){r=!0;break}s=c;break}if(r)return;const o=e.tree.children.get(t.ref);o&&o.size&&o.forEach(ir,e),s&&s(n)}class rr extends Wi.N{get dataState(){return this.plugin.state.data}get currentComponentGroups(){return this._currentComponentGroups||(this._currentComponentGroups=rr.getComponentGroups(this.selection.structures)),this._currentComponentGroups}get seletionSet(){if(this._currentSelectionSet)return this._currentSelectionSet;this._currentSelectionSet=new Set;for(const e of this.selection.trajectories)this._currentSelectionSet.add(e.cell.transform.ref);for(const e of this.selection.models)this._currentSelectionSet.add(e.cell.transform.ref);for(const e of this.selection.structures)this._currentSelectionSet.add(e.cell.transform.ref);return this._currentSelectionSet}get current(){return this.sync(!1),this.state.hierarchy}get selection(){return this.sync(!1),this.state.selection}getStructuresWithSelection(){const e=this.plugin.managers.structure.hierarchy.current.structures,t=[];for(const n of e)this.plugin.managers.structure.selection.structureHasSelection(n)&&t.push(n);return t}findStructure(e){if(!e)return;const t=this.plugin.helpers.substructureParent.get(e);if(!t)return;const n=this.plugin.state.data.selectQ(e=>e.byValue(t).rootOfType(Ls.O.Molecule.Structure))[0];return n?this.behaviors.selection.value.structures.find(e=>e.cell===n):void 0}syncCurrent(e,t){const n=this.seletionSet,i=[];for(const s of e){const e=s.cell.transform.ref;(n.has(e)||t.has(e))&&i.push(s)}return 0===i.length?e.length>0?[e[0]]:[]:i}sync(e){if(!e&&this.dataState.inUpdate)return;if(this.state.syncedTree===this.dataState.tree)return void(e&&!this.state.notified&&(this.state.notified=!0,this.behaviors.selection.next({hierarchy:this.state.hierarchy,...this.state.selection})));this.state.syncedTree=this.dataState.tree;const t=Ds(this.plugin.state.data,this.current);if(!t.changed)return;const{hierarchy:n}=t,i=this.syncCurrent(n.trajectories,t.added),s=this.syncCurrent(n.models,t.added),r=this.syncCurrent(n.structures,t.added);this._currentComponentGroups=void 0,this._currentSelectionSet=void 0,this.state.hierarchy=n,this.state.selection.trajectories=i,this.state.selection.models=s,this.state.selection.structures=r,e?(this.state.notified=!0,this.behaviors.selection.next({hierarchy:n,trajectories:i,models:s,structures:r})):this.state.notified=!1}updateCurrent(e,t){const n=this.current,i="add"===t?Ms.M.union(this.seletionSet,new Set(e.map(e=>e.cell.transform.ref))):Ms.M.difference(this.seletionSet,new Set(e.map(e=>e.cell.transform.ref))),s=[],r=[],o=[];for(const a of n.trajectories)i.has(a.cell.transform.ref)&&s.push(a);for(const a of n.models)i.has(a.cell.transform.ref)&&r.push(a);for(const a of n.structures)i.has(a.cell.transform.ref)&&o.push(a);this._currentComponentGroups=void 0,this._currentSelectionSet=void 0,this.state.selection.trajectories=s,this.state.selection.models=r,this.state.selection.structures=o,this.behaviors.selection.next({hierarchy:n,trajectories:s,models:r,structures:o})}remove(e,t){if(0===e.length)return;const n=this.plugin.state.data.build();for(const i of e)n.delete("string"==typeof i?i:i.cell.transform.ref);return n.commit({canUndo:!!t&&"Remove"})}toggleVisibility(e,t){if(0===e.length)return;const n=void 0!==t?"show"!==t:!e[0].cell.state.isHidden;for(const i of e)(0,$i.setSubtreeVisibility)(this.dataState,i.cell.transform.ref,n)}applyPreset(e,t,n){return this.plugin.dataTransaction(async()=>{for(const i of e)i.models.length>0&&await this.clearTrajectory(i),await this.plugin.builders.structure.hierarchy.applyPreset(i.cell,t,n)})}async updateStructure(e,t){await this.plugin.dataTransaction(async()=>{const n=Yi.uF.getDecoratorRoot(this.dataState.tree,e.cell.transform.ref),i=this.dataState.tree.children.get(n).toArray();await this.remove(i,!1),await this.plugin.state.updateTransform(this.plugin.state.data,e.cell.transform.ref,t,"Structure Type"),await this.plugin.builders.structure.representation.applyPreset(e.cell.transform.ref,"auto")},{canUndo:"Structure Type"}),Fi.a.Camera.Reset(this.plugin)}clearTrajectory(e){const t=this.dataState.build();for(const n of e.models)t.delete(n.cell);return t.commit()}constructor(e){super(),this.plugin=e,this.state={syncedTree:this.dataState.tree,notified:!1,hierarchy:Ns(),selection:{trajectories:[],models:[],structures:[]}},this.behaviors={selection:this.ev.behavior({hierarchy:this.current,trajectories:this.selection.trajectories,models:this.selection.models,structures:this.selection.structures})},this._currentComponentGroups=void 0,this._currentSelectionSet=void 0,this.subscribe(e.state.data.events.changed,t=>{t.inTransaction||e.behaviors.state.isAnimating.value||this.sync(!0)}),this.subscribe(e.behaviors.state.isAnimating,t=>{t||e.behaviors.state.isUpdating.value||this.sync(!0)})}}!function(e){e.getComponentGroups=function(e){if(!e.length)return[];if(1===e.length)return e[0].components.map(e=>[e]);const t=[],n=new Map;for(const i of e)for(const e of i.components){const i=e.key;if(!i)continue;let s=n.get(i);s||(s=[],n.set(i,s),t.push(s)),s.push(e)}return t},e.getSelectedStructuresDescription=function(e){var t,n,i,s,r,o,a,l,c;const{structures:u}=e.managers.structure.hierarchy.selection;if(0===u.length)return"";if(1===u.length){const e=u[0],a=null===(t=e.cell.obj)||void 0===t?void 0:t.data;if(!a)return(null===(n=e.cell.obj)||void 0===n?void 0:n.label)||"Structure";const l=a.models[0]||a.representativeModel||a.masterModel;if(!l)return(null===(i=e.cell.obj)||void 0===i?void 0:i.label)||"Structure";const c=l.entryId;return(null===(r=null===(s=e.model)||void 0===s?void 0:s.trajectory)||void 0===r?void 0:r.models)&&1===e.model.trajectory.models.length?c:e.model?`${null===(o=e.model.cell.obj)||void 0===o?void 0:o.label} | ${c}`:c}const d=u[0],h=null===(a=null==d?void 0:d.model)||void 0===a?void 0:a.trajectory;let p=!0;for(const m of u)if((null===(l=null==m?void 0:m.model)||void 0===l?void 0:l.trajectory)!==h){p=!1;break}return p&&h?`${null===(c=h.cell.obj)||void 0===c?void 0:c.label} | ${u.length} structures`:`${u.length} structures`}}(rr||(rr={}));var or=n(58794),ar=n(46867),lr=n(22016),cr=n(5328);function ur(e){return(0,cr.p)(function(t,n){return e<=n})}class dr extends l.jB{constructor(){super(...arguments),this.onChange=({name:e,value:t})=>{const n={...this.props.params,[e]:t};this.props.events.onChange(n,this.areInitial(n),this.validate(n))}}validate(e){}areInitial(e){return Xi.t.areEqual(this.props.info.params,e,this.props.info.initialValues)}render(){return(0,o.jsx)(zi.y1,{params:this.props.info.params,values:this.props.params,onChange:this.onChange,onEnter:this.props.events.onEnter,isDisabled:this.props.isDisabled})}}!function(e){function t(e){const t=Object.keys(e);for(const n of t)if(!e[n].isHidden)return!1;return!0}e.infoFromAction=function(e,n,i,s){const r=n.cells.get(s).obj,o=i.definition.params?i.definition.params(r,e):{};return{initialValues:Xi.t.getDefaultValues(o),params:o,isEmpty:t(o)}},e.infoFromTransform=function(e,n,i){const s=n.cells.get(i.ref),r=s.params&&s.params.definition||{};return{initialValues:s.params&&s.params.values||{},params:r,isEmpty:t(r)}}}(dr||(dr={}));class hr extends l.jB{constructor(){super(...arguments),this.busy=new lr.t(!1),this.onEnter=()=>{this.state.error||this.apply()},this.autoApplyHandle=void 0,this.events={onEnter:this.onEnter,onChange:(e,t,n)=>{this.clearAutoApply(),this.setState({params:e,isInitial:t,error:n&&n[0]},()=>{t||this.state.error||!this.canAutoApply(e)||(this.clearAutoApply(),this.autoApplyHandle=setTimeout(this.apply,50))})}},this.apply=async()=>{var e,t;this.clearAutoApply(),this.setState({busy:!0});try{await this.applyAction()}catch(n){console.error(n)}finally{null===(t=(e=this.props).onApply)||void 0===t||t.call(e),this.busy.next(!1)}},this.refresh=()=>{this.setState({params:this.getInfo().initialValues,isInitial:!0,error:void 0})},this.setDefault=()=>{const e=this.getInfo(),t=Xi.t.getDefaultValues(e.params);this.setState({params:t,isInitial:Xi.t.areEqual(e.params,t,e.initialValues),error:void 0})},this.toggleExpanded=()=>{this.setState({isCollapsed:!this.state.isCollapsed})}}clearAutoApply(){void 0!==this.autoApplyHandle&&(clearTimeout(this.autoApplyHandle),this.autoApplyHandle=void 0)}componentDidMount(){this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.busy.value!==e&&this.busy.next(e)}),this.subscribe(this.busy.pipe(ur(1)),e=>{this.setState({busy:e})})}renderApply(){const e=this.canApply();return!this.props.autoHideApply||e&&!this.canAutoApply(this.state.params)?(0,o.jsxs)("div",{className:"msp-transform-apply-wrap",children:[(0,o.jsx)(Ri.K0,{svg:Oi.ij,className:"msp-transform-default-params",onClick:this.setDefault,disabled:this.state.busy,title:"Set default params"}),(0,o.jsx)("div",{className:"msp-transform-apply-wider",children:(0,o.jsx)(Ri.$n,{icon:e?Oi.Xq:void 0,className:"msp-btn-commit msp-btn-commit-"+(e?"on":"off"),onClick:this.apply,disabled:!e,children:this.props.applyLabel||this.applyText()})})]}):null}renderDefault(){const e=this.getInfo(),t=e.isEmpty&&this.isUpdate(),n=this.getHeader(),i=this.getTransformerId(),s=this.plugin.customParamEditors.has(i)?this.plugin.customParamEditors.get(i):dr,r=this.state.isCollapsed?"msp-transform-wrapper msp-transform-wrapper-collapsed":"msp-transform-wrapper";let a=null;if(!t&&!this.state.isCollapsed){const{a:t,b:n,bCell:i}=this.getSourceAndTarget(),r=this.renderApply();a=(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(s,{info:e,a:t,b:n,bCell:i,events:this.events,params:this.state.params,isDisabled:this.state.busy}),r]})}const l=(0,o.jsxs)("div",{className:r,style:{marginBottom:this.props.noMargin?0:void 0},children:["none"!==n&&!this.props.wrapInExpander&&(0,o.jsx)("div",{className:"msp-transform-header",children:(0,o.jsxs)(Ri.$n,{onClick:this.toggleExpanded,title:n.description,children:[!t&&(0,o.jsx)(Oi.In,{svg:this.state.isCollapsed?Oi.Cp:Oi.DM}),n.name]})}),a]});return t||!this.props.wrapInExpander?l:(0,o.jsx)(Ri.Yj,{header:this.isUpdate()?`Update ${"none"===n?"":n.name}`:`Apply ${"none"===n?"":n.name}`,headerLeftMargin:this.props.expanderHeaderLeftMargin,children:l})}renderSimple(){var e,t,n;const i=this.getInfo(),s=this.canApply(),r=(0,o.jsxs)("div",{className:"msp-flex-row",children:[(0,o.jsx)(Ri.$n,{icon:null===(e=this.props.simpleApply)||void 0===e?void 0:e.icon,title:null===(t=this.props.simpleApply)||void 0===t?void 0:t.title,disabled:this.state.busy||!s,onClick:this.apply,className:"msp-btn-apply-simple",children:null===(n=this.props.simpleApply)||void 0===n?void 0:n.header}),!i.isEmpty&&(0,o.jsx)(Ri.ff,{icon:Oi.Hk,label:"",title:"Options",toggle:this.toggleExpanded,isSelected:!this.state.isCollapsed,disabled:this.state.busy,style:{flex:"0 0 40px",padding:0}})]});if(this.state.isCollapsed)return r;const a=this.getTransformerId(),l=this.plugin.customParamEditors.has(a)?this.plugin.customParamEditors.get(a):dr,{a:c,b:u,bCell:d}=this.getSourceAndTarget();return(0,o.jsxs)(o.Fragment,{children:[r,(0,o.jsx)(l,{info:i,a:c,b:u,bCell:d,events:this.events,params:this.state.params,isDisabled:this.state.busy})]})}render(){return this.props.simpleApply?this.renderSimple():this.renderDefault()}}class pr extends hr{constructor(){super(...arguments),this._getInfo=(0,ar._)(e=>dr.infoFromTransform(this.plugin,this.props.state,e)),this.state={error:void 0,isInitial:!0,params:this.getInfo().initialValues,busy:!1,isCollapsed:this.props.initiallyCollapsed}}applyAction(){return this.props.customUpdate?this.props.customUpdate(this.state.params):this.plugin.state.updateTransform(this.props.state,this.props.transform.ref,this.state.params)}getInfo(){return this._getInfo(this.props.transform)}getTransformerId(){return this.props.transform.transformer.id}getHeader(){return this.props.customHeader||this.props.transform.transformer.definition.display}canApply(){const{state:e}=this.props,t=e.cells.get(this.props.transform.ref);if(!t)return!1;if("error"===t.status){const t=e.cells.get(this.props.transform.parent);return!!t&&"ok"===t.status}return!this.state.error&&!this.state.busy&&!this.state.isInitial}applyText(){return this.canApply()?"Update":"Nothing to Update"}isUpdate(){return!0}getSourceAndTarget(){const e=this.props.state.cells.get(this.props.transform.ref);return{a:this.props.state.cells.get(this.props.transform.parent).obj,b:null==e?void 0:e.obj,bCell:e}}canAutoApply(e){const t=this.props.transform.transformer.definition.canAutoUpdate;if(!t)return!1;const{state:n}=this.props,i=n.cells.get(this.props.transform.ref);if(!i||!i.sourceRef||"ok"!==i.status)return!1;return t({a:n.cells.get(i.sourceRef).obj,b:i.obj,oldParams:this.getInfo().initialValues,newParams:e},this.plugin)}componentDidMount(){super.componentDidMount(),this.props.toggleCollapsed&&this.subscribe(this.props.toggleCollapsed,()=>this.setState({isCollapsed:!this.state.isCollapsed})),this.subscribe(this.plugin.state.events.object.updated,({ref:e,state:t})=>{this.props.transform.ref===e&&this.props.state===t&&this.state.params!==this.props.transform.params&&(this._getInfo=(0,ar._)(e=>dr.infoFromTransform(this.plugin,this.props.state,e)),this.setState({params:this.props.transform.params,isInitial:!0}))})}componentDidUpdate(e){var t;if(this.props.transform!==e.transform){const e=this.props.state.cells.get(this.props.transform.ref);this.setState({params:(null===(t=e.params)||void 0===t?void 0:t.values)||{},isInitial:!0,error:void 0,simpleOnly:this.state.simpleOnly})}}}class mr extends l.jB{get current(){return this.plugin.managers.structure.hierarchy.behaviors.selection}componentDidMount(){this.subscribe(this.current,()=>this.forceUpdate())}get unitcell(){var e;const{selection:t}=this.plugin.managers.structure.hierarchy;if(0===t.structures.length)return null;const n=[];for(const i of t.structures){const t=i.model;(null==t?void 0:t.unitcell)&&(null===(e=t.unitcell)||void 0===e?void 0:e.cell.obj)&&n.push(t.unitcell)}return 0===n.length?null:(0,o.jsx)(fr,{refs:n,labelMultiple:"Unit Cells"})}get customControls(){const e=[];return this.plugin.genericRepresentationControls.forEach((t,n)=>{const[i,s]=t(this.plugin.managers.structure.hierarchy.selection);i.length>0&&e.push((0,o.jsx)("div",{children:(0,o.jsx)(fr,{refs:i,labelMultiple:s})},n))}),e.length>0?e:null}render(){return(0,o.jsx)(o.Fragment,{children:(0,o.jsxs)("div",{style:{marginTop:"6px"},children:[this.unitcell,this.customControls]})})}}class fr extends l.jB{constructor(){super(...arguments),this.state={showOptions:!1},this.toggleVisibility=e=>{e.preventDefault(),this.plugin.managers.structure.hierarchy.toggleVisibility(this.props.refs),e.currentTarget.blur()},this.highlight=e=>{e.preventDefault(),this.pivot.cell.parent&&Fi.a.Interactivity.Object.Highlight(this.plugin,{state:this.pivot.cell.parent,ref:this.props.refs.map(e=>e.cell.transform.ref)})},this.clearHighlight=e=>{e.preventDefault(),Fi.a.Interactivity.ClearHighlights(this.plugin)},this.focus=e=>{var t;e.preventDefault();let n=!0;for(const s of this.props.refs)if(!s.cell.state.isHidden){n=!1;break}n&&this.plugin.managers.structure.hierarchy.toggleVisibility(this.props.refs,"show");const i=[];for(const s of this.props.refs){if(s.cell.state.isHidden)continue;const e=null===(t=s.cell.obj)||void 0===t?void 0:t.data.repr.getLoci();e&&i.push(e)}this.plugin.managers.camera.focusLoci(i)},this.toggleOptions=()=>this.setState({showOptions:!this.state.showOptions})}componentDidMount(){this.subscribe(this.plugin.state.events.cell.stateUpdated,e=>{var t;Yi.Uw.ObjectEvent.isCell(e,null===(t=this.pivot)||void 0===t?void 0:t.cell)&&this.forceUpdate()})}get pivot(){return this.props.refs[0]}render(){const{refs:e,labelMultiple:t}=this.props;if(0===e.length)return null;const n=e[0];let i,s;if(1===e.length){const{obj:e}=n.cell;if(!e)return null;i=null==e?void 0:e.label,s=null==e?void 0:e.description}else i=`${e.length} ${t||"Objects"}`;return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"msp-flex-row",children:[(0,o.jsxs)("button",{className:"msp-form-control msp-control-button-label",title:`${i}. Click to focus.`,onClick:this.focus,onMouseEnter:this.highlight,onMouseLeave:this.clearHighlight,style:{textAlign:"left"},children:[i," ",(0,o.jsx)("small",{children:s})]}),(0,o.jsx)(Ri.K0,{svg:n.cell.state.isHidden?Oi.qF:Oi.zs,toggleState:!1,className:"msp-form-control",onClick:this.toggleVisibility,title:""+(n.cell.state.isHidden?"Show":"Hide"),small:!0,flex:!0}),1===e.length&&(0,o.jsx)(Ri.K0,{svg:Oi.cv,className:"msp-form-control",onClick:this.toggleOptions,title:"Options",toggleState:this.state.showOptions,flex:!0})]}),1===e.length&&this.state.showOptions&&n.cell.parent&&(0,o.jsx)(o.Fragment,{children:(0,o.jsx)("div",{className:"msp-control-offset",children:(0,o.jsx)(pr,{state:n.cell.parent,transform:n.cell.transform,customHeader:"none",autoHideApply:!0})})})]})}}class gr extends l.VK{defaultState(){return{header:"Components",isCollapsed:!1,isDisabled:!1,brand:{accent:"blue",svg:Oi.c3}}}componentDidMount(){this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,e=>this.setState({description:rr.getSelectedStructuresDescription(this.plugin)}))}renderControls(){return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(yr,{}),(0,o.jsx)(xr,{}),(0,o.jsx)(mr,{})]})}}class yr extends l.jB{constructor(){super(...arguments),this.state={isEmpty:!0,isBusy:!1,canUndo:!1},this.togglePreset=this.toggleAction("preset"),this.toggleAdd=this.toggleAction("add"),this.toggleOptions=this.toggleAction("options"),this.hideAction=()=>this.setState({action:void 0}),this.applyPreset=e=>{if(this.hideAction(),!e)return;const t=this.plugin.managers.structure,{structures:n}=t.hierarchy.selection;null===e.value?t.component.clear(n):t.component.applyPreset(n,e.value)},this.undo=()=>{const e=this.plugin.state.data.undo();e&&this.plugin.runTask(e)}}get isDisabled(){return this.state.isBusy||this.state.isEmpty}componentDidMount(){this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,e=>this.setState({action:"options"!==this.state.action||0===e.structures.length?void 0:"options",isEmpty:0===e.structures.length})),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e,action:"options"!==this.state.action?void 0:"options"})}),this.subscribe(this.plugin.state.data.events.historyUpdated,({state:e})=>{this.setState({canUndo:e.canUndo})})}toggleAction(e){return()=>this.setState({action:this.state.action===e?void 0:e})}get presetControls(){return(0,o.jsx)(or.W,{items:this.presetActions,onSelect:this.applyPreset})}get presetActions(){const e=this.plugin.managers.structure.component.pivotStructure,t=this.plugin.builders.structure.representation.getPresets(null==e?void 0:e.cell.obj);return or.W.createItems(t,{label:e=>e.display.name,category:e=>e.display.group,description:e=>e.display.description})}render(){const e=this.state.canUndo?`Undo ${this.plugin.state.data.latestUndoLabel}`:"Some mistakes of the past can be undone.";return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"msp-flex-row",children:[(0,o.jsx)(Ri.ff,{icon:Oi.sM,label:"Preset",title:"Apply a representation preset for the current structure(s).",toggle:this.togglePreset,isSelected:"preset"===this.state.action,disabled:this.isDisabled}),(0,o.jsx)(Ri.ff,{icon:Oi.CR,label:"Add",title:"Add a new representation component for a selection.",toggle:this.toggleAdd,isSelected:"add"===this.state.action,disabled:this.isDisabled}),(0,o.jsx)(Ri.ff,{icon:Oi.Hk,label:"",title:"Options that are applied to all applicable representations.",style:{flex:"0 0 40px",padding:0},toggle:this.toggleOptions,isSelected:"options"===this.state.action,disabled:this.isDisabled}),(0,o.jsx)(Ri.K0,{svg:Oi.L3,className:"msp-flex-item",flex:"40px",onClick:this.undo,disabled:!this.state.canUndo||this.isDisabled,title:e})]}),"preset"===this.state.action&&this.presetControls,"add"===this.state.action&&(0,o.jsx)("div",{className:"msp-control-offset",children:(0,o.jsx)(vr,{onApply:this.hideAction})}),"options"===this.state.action&&(0,o.jsx)("div",{className:"msp-control-offset",children:(0,o.jsx)(br,{isDisabled:this.isDisabled})})]})}}class vr extends l.jB{constructor(){super(...arguments),this.state=this.createState(),this.apply=()=>{const e=this.props.forSelection?this.currentStructures:this.selectedStructures;this.props.onApply(),this.plugin.managers.structure.component.add(this.state.values,e)},this.paramsChanged=e=>this.setState({values:e})}createState(){const e=As.getAddParams(this.plugin);return{params:e,values:Xi.t.getDefaultValues(e)}}get selectedStructures(){return this.plugin.managers.structure.component.currentStructures}get currentStructures(){return this.plugin.managers.structure.hierarchy.current.structures}render(){return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(zi.y1,{params:this.state.params,values:this.state.values,onChangeValues:this.paramsChanged}),(0,o.jsx)(Ri.$n,{icon:Oi.CR,title:"Use Selection and optional Representation to create a new Component.",className:"msp-btn-commit msp-btn-commit-on",onClick:this.apply,style:{marginTop:"1px"},children:"Create Component"})]})}}class br extends l.jB{constructor(){super(...arguments),this.update=e=>this.plugin.managers.structure.component.setOptions(e)}componentDidMount(){this.subscribe(this.plugin.managers.structure.component.events.optionsUpdated,()=>this.forceUpdate())}render(){return(0,o.jsx)(zi.y1,{params:As.OptionsParams,values:this.plugin.managers.structure.component.state.options,onChangeValues:this.update,isDisabled:this.props.isDisabled})}}class xr extends l.jB{componentDidMount(){this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,()=>{this.forceUpdate()})}render(){const e=this.plugin.managers.structure.hierarchy.currentComponentGroups;return 0===e.length?null:(0,o.jsx)("div",{style:{marginTop:"6px"},children:e.map(e=>(0,o.jsx)(Sr,{group:e},e[0].cell.transform.ref))})}}class Sr extends l.jB{constructor(){super(...arguments),this.state={action:void 0},this.toggleVisible=e=>{e.preventDefault(),e.currentTarget.blur(),this.plugin.managers.structure.component.toggleVisibility(this.props.group)},this.selectAction=e=>{e&&(null==e?void 0:e.value)()},this.remove=()=>this.plugin.managers.structure.hierarchy.remove(this.props.group,!0),this.toggleAction=()=>this.setState({action:"action"===this.state.action?void 0:"action"}),this.toggleLabel=()=>this.setState({action:"label"===this.state.action?void 0:"label"}),this.highlight=e=>{e.preventDefault(),this.props.group[0].cell.parent&&Fi.a.Interactivity.Object.Highlight(this.plugin,{state:this.props.group[0].cell.parent,ref:this.props.group.map(e=>e.cell.transform.ref)})},this.clearHighlight=e=>{e.preventDefault(),Fi.a.Interactivity.ClearHighlights(this.plugin)},this.focus=()=>{let e=!0;for(const t of this.props.group)if(!t.cell.state.isHidden){e=!1;break}e&&this.plugin.managers.structure.hierarchy.toggleVisibility(this.props.group,"show"),this.plugin.managers.camera.focusSpheres(this.props.group,e=>{var t;if(!e.cell.state.isHidden)return null===(t=e.cell.obj)||void 0===t?void 0:t.data.boundary.sphere})},this.updateLabel=e=>{this.plugin.managers.structure.component.updateLabel(this.pivot,e)}}get pivot(){return this.props.group[0]}componentDidMount(){this.subscribe(this.plugin.state.events.cell.stateUpdated,e=>{Yi.Uw.ObjectEvent.isCell(e,this.pivot.cell)&&this.forceUpdate()})}get colorByActions(){var e,t;const n=this.plugin.managers.structure.component,i=null===(e=this.pivot.representations[0].cell.transform.params)||void 0===e?void 0:e.colorTheme.name,s=(0,Ui.A8)(this.plugin,null===(t=this.pivot.cell.obj)||void 0===t?void 0:t.data);return or.W.createItemsFromSelectOptions(s,{value:e=>()=>n.updateRepresentationsTheme(this.props.group,{color:e[0]}),selected:e=>e[0]===i})}get actions(){const e=this.plugin.managers.structure.component,t=[[or.W.Header("Add Representation"),...As.getRepresentationTypes(this.plugin,this.props.group[0]).map(t=>or.W.Item(t[1],()=>e.addRepresentation(this.props.group,t[0])))]];return this.pivot.representations.length>0&&t.push([or.W.Header("Set Coloring",{isIndependent:!0}),...this.colorByActions]),e.canBeModified(this.props.group[0])&&t.push([or.W.Header("Modify by Selection"),or.W.Item("Include",()=>e.modifyByCurrentSelection(this.props.group,"union"),{icon:Oi.QM}),or.W.Item("Subtract",()=>e.modifyByCurrentSelection(this.props.group,"subtract"),{icon:Oi.tk}),or.W.Item("Intersect",()=>e.modifyByCurrentSelection(this.props.group,"intersect"),{icon:Oi.sx})]),t.push(or.W.Item("Select This",()=>e.selectThis(this.props.group),{icon:Oi.B7})),e.canBeModified(this.props.group[0])&&t.push(or.W.Item("Edit Label",this.toggleLabel)),t}get reprLabel(){var e;const t=this.pivot;return 0===t.representations.length?"No repr.":1===t.representations.length?null===(e=t.representations[0].cell.obj)||void 0===e?void 0:e.label:`${t.representations.length} reprs`}render(){var e;const t=this.pivot,n=t.cell,i=null===(e=n.obj)||void 0===e?void 0:e.label,s=this.reprLabel;return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"msp-flex-row",children:[(0,o.jsxs)(Ri.$n,{noOverflow:!0,className:"msp-control-button-label",title:`${i}. Click to focus.`,onClick:this.focus,onMouseEnter:this.highlight,onMouseLeave:this.clearHighlight,style:{textAlign:"left"},children:[i,(0,o.jsx)("small",{className:"msp-25-lower-contrast-text",style:{float:"right"},children:s})]}),(0,o.jsx)(Ri.K0,{svg:n.state.isHidden?Oi.qF:Oi.zs,toggleState:!1,onClick:this.toggleVisible,title:(n.state.isHidden?"Show":"Hide")+" component",small:!0,className:"msp-form-control",flex:!0}),(0,o.jsx)(Ri.K0,{svg:Oi.mf,toggleState:!1,onClick:this.remove,title:"Remove",small:!0,className:"msp-form-control",flex:!0}),(0,o.jsx)(Ri.K0,{svg:Oi.cv,onClick:this.toggleAction,title:"Actions",toggleState:"action"===this.state.action,className:"msp-form-control",flex:!0})]}),"label"===this.state.action&&(0,o.jsx)("div",{className:"msp-control-offset",style:{marginBottom:"6px"},children:(0,o.jsx)(Ri.eJ,{label:"Label",control:(0,o.jsxs)("div",{style:{display:"flex",textAlignLast:"center"},children:[(0,o.jsx)(Ri.ks,{onChange:this.updateLabel,value:i,style:{flex:"1 1 auto",minWidth:0},className:"msp-form-control",blurOnEnter:!0,blurOnEscape:!0}),(0,o.jsx)(Ri.K0,{svg:Oi.Xq,onClick:this.toggleLabel,className:"msp-form-control msp-control-button-label",flex:!0})]})})}),"action"===this.state.action&&(0,o.jsxs)("div",{className:"msp-accent-offset",children:[(0,o.jsx)("div",{style:{marginBottom:"6px"},children:(0,o.jsx)(or.W,{items:this.actions,onSelect:this.selectAction,noOffset:!0})}),(0,o.jsx)("div",{style:{marginBottom:"6px"},children:t.representations.map(e=>(0,o.jsx)(Cr,{group:this.props.group,representation:e},e.cell.transform.ref))})]})]})}}class Cr extends l.jB{constructor(){super(...arguments),this.remove=()=>this.plugin.managers.structure.component.removeRepresentations(this.props.group,this.props.representation),this.toggleVisible=e=>{e.preventDefault(),e.currentTarget.blur(),this.plugin.managers.structure.component.toggleVisibility(this.props.group,this.props.representation)},this.update=e=>this.plugin.managers.structure.component.updateRepresentations(this.props.group,this.props.representation,e)}componentDidMount(){this.subscribe(this.plugin.state.events.cell.stateUpdated,e=>{Yi.Uw.ObjectEvent.isCell(e,this.props.representation.cell)&&this.forceUpdate()})}render(){var e;const t=this.props.representation.cell;return(0,o.jsxs)("div",{className:"msp-representation-entry",children:[t.parent&&(0,o.jsx)(Ri.Yj,{header:`${(null===(e=t.obj)||void 0===e?void 0:e.label)||""} Representation`,noOffset:!0,children:(0,o.jsx)(pr,{state:t.parent,transform:t.transform,customHeader:"none",customUpdate:this.update,noMargin:!0})}),(0,o.jsx)(Ri.K0,{svg:Oi.mf,onClick:this.remove,title:"Remove",small:!0,className:"msp-default-bg",toggleState:!1,style:{position:"absolute",top:0,right:"32px",lineHeight:"24px",height:"24px",textAlign:"right",width:"44px",paddingRight:"6px",background:"none"}}),(0,o.jsx)(Ri.K0,{svg:this.props.representation.cell.state.isHidden?Oi.qF:Oi.zs,toggleState:!1,onClick:this.toggleVisible,title:"Toggle Visibility",small:!0,className:"msp-default-bg",style:{position:"absolute",top:0,right:0,lineHeight:"24px",height:"24px",textAlign:"right",width:"32px",paddingRight:"6px",background:"none"}})]})}}var wr=n(31186),kr=n(20397);const Br="measurement-group",Pr="measurement-order-label",Ir={distanceUnitLabel:Xi.t.Text("",{isEssential:!0}),textColor:kr.w.textColor},jr=Xi.t.getDefaultValues(Ir);function Tr(e){return{bundle:Gi.iZ.Bundle.fromLoci(e)}}class Ar extends Wi.e{stateUpdated(){this.behaviors.state.next(this.state)}getGroup(){const e=this.plugin.state.data,t=Yi.QX.findTagInSubtree(e.tree,Yi.Cn.RootRef,Br),n=this.plugin.state.data.build();return t?n.to(t):n.toRoot().group(Ni.f.Misc.CreateGroup,{label:"Measurements"},{tags:Br})}async setOptions(e){this.updateState({options:e})&&this.stateUpdated();const t=this.plugin.state.data.build();for(const n of this.state.distances)t.to(n).update(t=>{t.unitLabel=e.distanceUnitLabel,t.textColor=e.textColor});for(const n of this.state.labels)t.to(n).update(t=>{t.textColor=e.textColor});for(const n of this.state.angles)t.to(n).update(t=>{t.textColor=e.textColor});for(const n of this.state.dihedrals)t.to(n).update(t=>{t.textColor=e.textColor});0!==t.editInfo.count&&await Fi.a.State.Update(this.plugin,{state:this.plugin.state.data,tree:t,options:{doNotLogTiming:!0}})}async addDistance(e,t,n){const i=this.plugin.helpers.substructureParent.get(e.structure),s=this.plugin.helpers.substructureParent.get(t.structure);if(!i||!s)return;const r=[i.transform.ref];(0,wr.Z2)(r,s.transform.ref);const o=this.getGroup().apply(Ni.f.Model.MultiStructureSelectionFromBundle,{selections:[{key:"a",groupId:"a",ref:i.transform.ref,...Tr(e)},{key:"b",groupId:"b",ref:s.transform.ref,...Tr(t)}],isTransitive:!0,label:"Distance"},{dependsOn:r,tags:null==n?void 0:n.selectionTags}),a=o.apply(Ni.f.Representation.StructureSelectionsDistance3D,{customText:(null==n?void 0:n.customText)||"",unitLabel:this.state.options.distanceUnitLabel,textColor:this.state.options.textColor,...null==n?void 0:n.lineParams,...null==n?void 0:n.labelParams,...null==n?void 0:n.visualParams},{tags:null==n?void 0:n.reprTags}),l=this.plugin.state.data;return await Fi.a.State.Update(this.plugin,{state:l,tree:a,options:{doNotLogTiming:!0}}),{selection:o.selector,representation:a.selector}}async addAngle(e,t,n,i){const s=this.plugin.helpers.substructureParent.get(e.structure),r=this.plugin.helpers.substructureParent.get(t.structure),o=this.plugin.helpers.substructureParent.get(n.structure);if(!s||!r||!o)return;const a=[s.transform.ref];(0,wr.Z2)(a,r.transform.ref),(0,wr.Z2)(a,o.transform.ref);const l=this.getGroup().apply(Ni.f.Model.MultiStructureSelectionFromBundle,{selections:[{key:"a",ref:s.transform.ref,...Tr(e)},{key:"b",ref:r.transform.ref,...Tr(t)},{key:"c",ref:o.transform.ref,...Tr(n)}],isTransitive:!0,label:"Angle"},{dependsOn:a,tags:null==i?void 0:i.selectionTags}),c=l.apply(Ni.f.Representation.StructureSelectionsAngle3D,{customText:(null==i?void 0:i.customText)||"",textColor:this.state.options.textColor,...null==i?void 0:i.lineParams,...null==i?void 0:i.labelParams,...null==i?void 0:i.visualParams},{tags:null==i?void 0:i.reprTags}),u=this.plugin.state.data;return await Fi.a.State.Update(this.plugin,{state:u,tree:c,options:{doNotLogTiming:!0}}),{selection:l.selector,representation:c.selector}}async addDihedral(e,t,n,i,s){const r=this.plugin.helpers.substructureParent.get(e.structure),o=this.plugin.helpers.substructureParent.get(t.structure),a=this.plugin.helpers.substructureParent.get(n.structure),l=this.plugin.helpers.substructureParent.get(i.structure);if(!(r&&o&&a&&l))return;const c=[r.transform.ref];(0,wr.Z2)(c,o.transform.ref),(0,wr.Z2)(c,a.transform.ref),(0,wr.Z2)(c,l.transform.ref);const u=this.getGroup().apply(Ni.f.Model.MultiStructureSelectionFromBundle,{selections:[{key:"a",ref:r.transform.ref,...Tr(e)},{key:"b",ref:o.transform.ref,...Tr(t)},{key:"c",ref:a.transform.ref,...Tr(n)},{key:"d",ref:l.transform.ref,...Tr(i)}],isTransitive:!0,label:"Dihedral"},{dependsOn:c,tags:null==s?void 0:s.selectionTags}),d=u.apply(Ni.f.Representation.StructureSelectionsDihedral3D,{customText:(null==s?void 0:s.customText)||"",textColor:this.state.options.textColor,...null==s?void 0:s.lineParams,...null==s?void 0:s.labelParams,...null==s?void 0:s.visualParams},{tags:null==s?void 0:s.reprTags}),h=this.plugin.state.data;return await Fi.a.State.Update(this.plugin,{state:h,tree:d,options:{doNotLogTiming:!0}}),{selection:u.selector,representation:d.selector}}async addLabel(e,t){const n=this.plugin.helpers.substructureParent.get(e.structure);if(!n)return;const i=[n.transform.ref],s=this.getGroup().apply(Ni.f.Model.MultiStructureSelectionFromBundle,{selections:[{key:"a",ref:n.transform.ref,...Tr(e)}],isTransitive:!0,label:"Label"},{dependsOn:i,tags:null==t?void 0:t.selectionTags}),r=s.apply(Ni.f.Representation.StructureSelectionsLabel3D,{textColor:this.state.options.textColor,...null==t?void 0:t.labelParams,...null==t?void 0:t.visualParams},{tags:null==t?void 0:t.reprTags}),o=this.plugin.state.data;return await Fi.a.State.Update(this.plugin,{state:o,tree:r,options:{doNotLogTiming:!0}}),{selection:s.selector,representation:r.selector}}async addOrientation(e){const t=[],n=[];for(let o=0,a=e.length;o<a;++o){const i=e[o],s=this.plugin.helpers.substructureParent.get(i.structure);s&&((0,wr.Z2)(n,s.transform.ref),t.push({key:`l${o}`,ref:s.transform.ref,...Tr(i)}))}if(0===t.length)return;const i=this.getGroup().apply(Ni.f.Model.MultiStructureSelectionFromBundle,{selections:t,isTransitive:!0,label:"Orientation"},{dependsOn:n}),s=i.apply(Ni.f.Representation.StructureSelectionsOrientation3D),r=this.plugin.state.data;return await Fi.a.State.Update(this.plugin,{state:r,tree:s,options:{doNotLogTiming:!0}}),{selection:i.selector,representation:s.selector}}async addPlane(e){const t=[],n=[];for(let a=0,l=e.length;a<l;++a){const i=e[a],s=this.plugin.helpers.substructureParent.get(i.structure);s&&((0,wr.Z2)(n,s.transform.ref),t.push({key:`l${a}`,ref:s.transform.ref,...Tr(i)}))}if(0===t.length)return;const i=this.getGroup(),s=i.apply(Ni.f.Model.MultiStructureSelectionFromBundle,{selections:t,isTransitive:!0,label:"Plane"},{dependsOn:n}),r=s.apply(Ni.f.Representation.StructureSelectionsPlane3D),o=this.plugin.state.data;return await Fi.a.State.Update(this.plugin,{state:o,tree:i,options:{doNotLogTiming:!0}}),{selection:s.selector,representation:r.selector}}async addOrderLabels(e){const t=this.getGroup(),n=this.plugin.state.data.select(Yi.QX.Generators.ofType(Ls.O.Molecule.Structure.Selections).withTag(Pr));for(const r of n)t.delete(r);let i=1;for(const r of e){const e=this.plugin.helpers.substructureParent.get(r.structure);if(!e)continue;const n=[e.transform.ref];t.apply(Ni.f.Model.MultiStructureSelectionFromBundle,{selections:[{key:"a",ref:e.transform.ref,...Tr(r)}],isTransitive:!0,label:"Order"},{dependsOn:n,tags:Pr}).apply(Ni.f.Representation.StructureSelectionsLabel3D,{textColor:es.Q1.fromRgb(255,255,255),borderColor:es.Q1.fromRgb(0,0,0),textSize:.33,borderWidth:.3,offsetZ:.75,customText:""+i++},{tags:Pr})}const s=this.plugin.state.data;return await Fi.a.State.Update(this.plugin,{state:s,tree:t,options:{doNotLogTiming:!0}}),{representation:t.selector}}getTransforms(e){const t=this.plugin.state.data,n=Yi.QX.findTagInSubtree(t.tree,Yi.Cn.RootRef,Br),i=n?t.select(Yi.QX.Generators.ofTransformer(e,n)):this._empty;return 0===i.length?this._empty:i}sync(){const e=[];for(const t of this.getTransforms(Ni.f.Representation.StructureSelectionsLabel3D)){const n=t.obj.tags;n&&n.includes(Pr)||e.push(t)}this.updateState({labels:e,distances:this.getTransforms(Ni.f.Representation.StructureSelectionsDistance3D),angles:this.getTransforms(Ni.f.Representation.StructureSelectionsAngle3D),dihedrals:this.getTransforms(Ni.f.Representation.StructureSelectionsDihedral3D),orientations:this.getTransforms(Ni.f.Representation.StructureSelectionsOrientation3D),planes:this.getTransforms(Ni.f.Representation.StructureSelectionsPlane3D)})&&this.stateUpdated()}constructor(e){super({labels:[],distances:[],angles:[],dihedrals:[],orientations:[],planes:[],options:jr}),this.plugin=e,this.behaviors={state:this.ev.behavior(this.state)},this._empty=[],e.state.data.events.changed.subscribe(t=>{t.inTransaction||e.behaviors.state.isAnimating.value||this.sync()}),e.behaviors.state.isAnimating.subscribe(t=>{t||e.behaviors.state.isUpdating.value||this.sync()})}}var Mr=n(31517),Lr=n(46362),Er=n(18395),Dr=n(22316);class Nr extends Wi.e{get props(){return{...this.state.props}}setProps(e){const t=this.props,n={...this.state.props,...e};(0,Qi.bN)(t,n)||(this.updateState({props:n}),this.lociSelects.setProps(n),this.lociHighlights.setProps(n),this.events.propsUpdated.next(void 0))}dispose(){super.dispose(),this.lociSelects.dispose(),this.lociHighlights.dispose()}constructor(e,t={}){super({props:{...Xi.t.getDefaultValues(Nr.Params),...t}}),this.plugin=e,this._props=Xi.t.getDefaultValues(Nr.Params),this.events={propsUpdated:this.ev()},this.lociSelects=new Nr.LociSelectManager(e,this._props),this.lociHighlights=new Nr.LociHighlightManager(e,this._props)}}!function(e){e.Params={granularity:Xi.t.Select("residue",ts.QN.GranularityOptions,{label:"Picking Level",description:"Controls if selections are expanded upon picking to whole residues, chains, structures, instances, or left as atoms and coarse elements"})};class t{setProps(e){Object.assign(this.props,e)}addProvider(e){this.providers.push(e)}removeProvider(e){this.providers=this.providers.filter(t=>t!==e)}normalizedLoci(e,t,n=!1){const{loci:i,repr:s}=e,r=t?this.props.granularity:void 0;return{loci:ts.QN.normalize(i,r,n),repr:s}}mark(e,t,n=!1){if(!ts.QN.isEmpty(e.loci))for(const i of this.providers)i(e,t,n)}dispose(){this.providers.length=0,this.sel.dispose()}constructor(t,n={}){this.ctx=t,this.providers=[],this.props=Xi.t.getDefaultValues(e.Params),this.sel=t.managers.structure.selection,this.setProps(n)}}e.LociMarkManager=t;e.LociHighlightManager=class extends t{constructor(){super(...arguments),this.prev=[],this.clearHighlights=(e=!1)=>{for(const t of this.prev)this.mark(t,Dr.xi.RemoveHighlight,e);this.prev.length=0}}isHighlighted(e){for(const t of this.prev)if(Er.YL.Loci.areEqual(t,e))return!0;return!1}addHighlight(e){this.mark(e,Dr.xi.Highlight),this.prev.push(e)}highlight(e,t=!0){const n=this.normalizedLoci(e,t);this.isHighlighted(n)||this.addHighlight(n)}highlightOnly(e,t=!0){const n=this.normalizedLoci(e,t);this.isHighlighted(n)||(ts.QN.isEmpty(n.loci)?this.clearHighlights():(this.clearHighlights(!0),this.addHighlight(n)))}highlightOnlyExtend(e,t=!0){const n=this.normalizedLoci(e,t);if(Gi.iZ.Loci.is(n.loci)){const e=this.ctx.selectionMode?this.sel.tryGetRange(n.loci):this.ctx.managers.structure.focus.tryGetRange(n.loci),t={loci:null!=e?e:n.loci,repr:n.repr};this.isHighlighted(t)||(ts.QN.isEmpty(t.loci)?this.clearHighlights():(this.clearHighlights(!0),this.addHighlight(t)))}}dispose(){super.dispose(),this.prev.length=0}};e.LociSelectManager=class extends t{toggle(e,t=!0){if(ts.QN.isEmpty(e.loci))return;const n=this.normalizedLoci(e,t,!0);Gi.iZ.Loci.is(n.loci)?this.toggleSel(n):super.mark(n,Dr.xi.Toggle)}toggleExtend(e,t=!0){if(ts.QN.isEmpty(e.loci))return;const n=this.normalizedLoci(e,t,!0);if(Gi.iZ.Loci.is(n.loci)){const e=this.sel.tryGetRange(n.loci)||n.loci;this.toggleSel({loci:e,repr:n.repr})}}select(e,t=!0){const n=this.normalizedLoci(e,t,!0);Gi.iZ.Loci.is(n.loci)&&this.sel.modify("add",n.loci),this.mark(n,Dr.xi.Select)}selectJoin(e,t=!0){const n=this.normalizedLoci(e,t,!0);Gi.iZ.Loci.is(n.loci)&&this.sel.modify("intersect",n.loci),this.mark(n,Dr.xi.Select)}selectOnly(e,t=!0){const n=this.normalizedLoci(e,t,!0);Gi.iZ.Loci.is(n.loci)&&(this.mark({loci:Gi.Structure.Loci(n.loci.structure),repr:n.repr},Dr.xi.Deselect),this.sel.modify("set",n.loci)),this.mark(n,Dr.xi.Select)}deselect(e,t=!0){const n=this.normalizedLoci(e,t,!0);Gi.iZ.Loci.is(n.loci)&&this.sel.modify("remove",n.loci),this.mark(n,Dr.xi.Deselect)}deselectAll(){this.sel.clear(),this.mark({loci:ts.FE},Dr.xi.Deselect)}deselectAllOnEmpty(e){(0,ts.$M)(e.loci)&&this.deselectAll()}mark(e,t){const{loci:n}=e;if(!ts.QN.isEmpty(n))if(Gi.iZ.Loci.is(n)){const e=this.sel.getLoci(n.structure);super.mark({loci:Gi.Structure.Loci(n.structure)},Dr.xi.Deselect,!ts.QN.isEmpty(e)),super.mark({loci:e},Dr.xi.Select)}else super.mark(e,t)}toggleSel(e){this.sel.has(e.loci)?(this.sel.modify("remove",e.loci),this.mark(e,Dr.xi.Deselect)):(this.sel.modify("add",e.loci),this.mark(e,Dr.xi.Select))}}}(Nr||(Nr={}));var Fr=n(13636),Rr=n(14139),Or=n(54135);function zr(e){return e.split(",").map(e=>e.trim().split(/\s+|[-]/g).filter(e=>!!e)).map(e=>function(e,t,n){if(e&&0!==t.length&&!Number.isNaN(+t[0]))return Number.isNaN(n)?{kind:"single",asym_id:e,seq_id:+t[0],ins_code:t[1]}:{kind:"range",asym_id:e,seq_id_beg:+t[0],seq_id_end:n}}(e[0],function(e){return e?e.split(":"):[]}(e[1]),+e[2])).filter(e=>!!e)}function Hr(e){return e.split(",").map(e=>e.trim().split(/\s+|[-]/g).filter(e=>!!e)).filter(e=>1===e.length||2===e.length).map(e=>1===e.length?[+e[0],+e[0]]:[+e[0],+e[1]])}function Ur(e,t){if("atom-id"===t){return function(e){const t=Or.th.create();for(const[i,s]of e)for(let e=i;e<=s;e++)Or.th.add(t,e,e);const n=Fr.J.struct.generator.atomGroups({"atom-test":Fr.J.core.set.has([Fr.J.set(...t.array),Fr.J.ammp("id")])});return(0,Rr.wE)(n)}(Hr(e))}if("element-symbol"===t){if(/[a-zA-Z]/.test(e))return function(e){const t=Fr.J.struct.generator.atomGroups({"atom-test":Fr.J.core.set.has([Fr.J.set(...e),Fr.J.acp("elementSymbol")])});return(0,Rr.wE)(t)}(e.split(",").map(e=>e.trim()));return function(e){const t=Or.th.create();for(const[i,s]of e)for(let e=i;e<=s;e++)Or.th.add(t,e.toString(),e.toString());const n=Fr.J.struct.generator.atomGroups({"atom-test":Fr.J.core.set.has([Fr.J.set(...t.array),Fr.J.acp("elementSymbol")])});return(0,Rr.wE)(n)}(Hr(e))}return function(e,t){var n;const i=[],s="auth"===t?"auth_asym_id":"label_asym_id",r="auth"===t?"auth_seq_id":"label_seq_id";for(const a of e)if("range"===a.kind)i.push(Fr.J.struct.generator.atomGroups({"chain-test":Fr.J.core.rel.eq([Fr.J.ammp(s),a.asym_id]),"residue-test":Fr.J.core.rel.inRange([Fr.J.ammp(r),a.seq_id_beg,a.seq_id_end])}));else{const e=(null!==(n=a.ins_code)&&void 0!==n?n:"").trim();i.push(Fr.J.struct.generator.atomGroups({"chain-test":Fr.J.core.rel.eq([Fr.J.ammp(s),a.asym_id]),"residue-test":Fr.J.core.logic.and([Fr.J.core.rel.eq([Fr.J.ammp(r),a.seq_id]),Fr.J.core.rel.eq([Fr.J.ammp("pdbx_PDB_ins_code"),e])])}))}const o=Fr.J.struct.combinator.merge(i);return(0,Rr.wE)(o)}(zr(e),t)}var Vr=n(78850),_r=n(62458),Gr=n(52756);class qr extends r.PureComponent{getBindingComponents(){const e=(t=this.props.bindings,Object.keys(t).map(e=>[e,t[e]]).filter(e=>_r.O.isBinding(e[1])));var t;return(0,o.jsx)(o.Fragment,{children:e.map(e=>{const[t,n]=e;return _r.O.isEmpty(n)?null:(0,o.jsxs)("div",{style:{marginBottom:"6px"},children:[(0,o.jsx)("b",{children:n.action}),(0,o.jsx)("br",{}),(0,o.jsx)("span",{dangerouslySetInnerHTML:{__html:_r.O.format(n,t)}})]},t)})})}render(){return(0,o.jsx)($r,{children:this.getBindingComponents()})}}class $r extends r.PureComponent{render(){return(0,o.jsx)("div",{className:"msp-help-text",children:(0,o.jsx)("div",{children:this.props.children})})}}class Zr extends r.PureComponent{constructor(){super(...arguments),this.state={header:this.props.header,isExpanded:!!this.props.initiallyExpanded},this.toggleExpanded=()=>this.setState({isExpanded:!this.state.isExpanded})}render(){return(0,o.jsxs)("div",{className:"msp-control-group-wrapper",children:[(0,o.jsx)("div",{className:"msp-control-group-header",children:(0,o.jsxs)(Ri.$n,{onClick:this.toggleExpanded,children:[(0,o.jsx)(Oi.In,{svg:this.state.isExpanded?Oi.DM:Oi.Cp}),this.props.header]})}),this.state.isExpanded&&(0,o.jsx)("div",{className:"msp-control-offset",style:{display:this.state.isExpanded?"block":"none"},children:this.props.children})]})}}function Kr(e){return(0,o.jsx)("div",{className:"msp-simple-help-section",children:e.header})}class Qr extends l.dL{constructor(){super(...arguments),this.getInteractionBindings=(0,ar._)(e=>{let t;return e.forEach(e=>{var n;const i=null===(n=e.params)||void 0===n?void 0:n.values;(null==i?void 0:i.bindings)&&Object.keys(i.bindings).length>0&&(t||(t={}),Object.assign(t,i.bindings))}),t})}componentDidMount(){this.subscribe(this.plugin.events.canvas3d.settingsUpdated,()=>this.forceUpdate())}render(){const e=this.getInteractionBindings(this.plugin.state.behaviors.cells);return(0,o.jsxs)(o.Fragment,{children:[!this.props.selectOnly&&this.plugin.canvas3d&&(0,o.jsx)(Zr,{header:"Moving in 3D",children:(0,o.jsx)(qr,{bindings:this.plugin.canvas3d.attribs.trackball.bindings})},"trackball"),!!e&&(0,o.jsx)(Zr,{header:"Mouse & Key Controls",children:(0,o.jsx)(qr,{bindings:e})},"interactions")]})}}class Xr extends l.dL{componentDidMount(){this.subscribe(this.plugin.events.canvas3d.settingsUpdated,()=>this.forceUpdate())}formatTriggers(e){return e.triggers.map(e=>_r.O.Trigger.format(e)).join(" or ")}getTriggerFor(e,t){const n=this.plugin.state.behaviors.select(Yi.QX.Generators.ofTransformer(e)),i=1===n.length?n[0].params:void 0,s=i?i.values.bindings:{},r=t in s?s[t]:_r.O.Empty;return this.formatTriggers(r)}render(){const e=this.getTriggerFor(Gr.SelectLoci,"clickSelectToggle"),t=this.getTriggerFor(Gr.FocusLoci,"clickFocus");return(0,o.jsxs)("div",{children:[(0,o.jsx)(Kr,{header:"Interface Controls"}),(0,o.jsxs)(Zr,{header:"Inline Help",children:[(0,o.jsx)($r,{children:"Many user interface elements show a little questionmark icon when hovered over. Clicking the icon toggles the display of an inline help text."}),(0,o.jsx)($r,{children:"Tooltips may provide additional information on a user interface element and are shown when hovering over it with the mouse."})]}),(0,o.jsx)(Zr,{header:"Selections",children:(0,o.jsxs)($r,{children:["The viewer allows changing colors and representations for selections of atoms, residues or chains. Selections can be created by",(0,o.jsxs)("ul",{style:{paddingLeft:"20px"},children:[(0,o.jsxs)("li",{children:["picking elements on the 3D canvas or the sequence view using the mouse, e.g. toggle selection using ",e," (for more see help section on ",(0,o.jsx)("i",{children:"Mouse Controls"}),")"]}),(0,o.jsxs)("li",{children:["using the ",(0,o.jsx)("i",{children:"Add"}),", ",(0,o.jsx)("i",{children:"Remove"})," and ",(0,o.jsx)("i",{children:"Only"})," dropdown buttons in the ",(0,o.jsx)("i",{children:"Manage Selection"})," panel which allow modifing the current selection by predefined sets"]})]})]})}),(0,o.jsx)(Zr,{header:"Coloring",children:(0,o.jsxs)($r,{children:["There are two ways to color structures. Every representation (e.g. cartoon or spacefill) has a color theme which can be changed using the dropdown for each representation in the ",(0,o.jsx)("i",{children:"Structure Settings"})," panel. Additionally any selection atoms, residues or chains can by given a custom color. For that, first select the parts of the structure to be colored (see help section on ",(0,o.jsx)("i",{children:"Selections"}),") and, second, choose a color from the color dropdown botton in the ",(0,o.jsx)("i",{children:"Selection"})," row of the ",(0,o.jsx)("i",{children:"Change Representation"})," panel. The theme color can be seen as a base color that is overpainted by the custom color. Custom colors can be removed for a selection with the 'Clear' option in the color dropdown."]})}),(0,o.jsx)(Zr,{header:"Representations",children:(0,o.jsxs)($r,{children:["Structures can be shown with many different representations (e.g. cartoon or spacefill). The ",(0,o.jsx)("i",{children:"Change Representation"})," panel offers a collection of predefined styles which can be applied using the ",(0,o.jsx)("i",{children:"Preset"})," dropdown button. Additionally any selection atoms, residues or chains can by shown with a custom representation. For that, first select the parts of the structure to be mofified (see help section on ",(0,o.jsx)("i",{children:"Selections"}),") and, second, choose a representation to hide or show from the ",(0,o.jsx)("i",{children:"Show"})," and ",(0,o.jsx)("i",{children:"Hide"})," dropdown bottons in the ",(0,o.jsx)("i",{children:"Selection"})," row of the ",(0,o.jsx)("i",{children:"Change Representation"})," panel. The ",(0,o.jsx)("i",{children:"Everything"})," row applies the action to the whole structure instead of the current selection."]})}),(0,o.jsx)(Zr,{header:"Surroundings",children:(0,o.jsxs)($r,{children:["To show the surroundings of a residue or ligand, click it in the 3D scene or in the sequence widget using ",t,"."]})}),(0,o.jsx)(Kr,{header:"How-to Guides"}),(0,o.jsx)(Zr,{header:"Create an Image",children:(0,o.jsxs)($r,{children:[(0,o.jsxs)("p",{children:["Use the ",(0,o.jsx)(Oi.In,{svg:Oi.OY})," icon in the viewport to bring up the screenshot controls."]}),(0,o.jsxs)("p",{children:["To adjust the size of the image, use the ",(0,o.jsx)("i",{children:"Resolution"})," dropdown."]})]})}),(0,o.jsx)(Kr,{header:"Mouse Controls"}),(0,o.jsx)(Qr,{})]})}}class Wr extends l.jB{constructor(){super(...arguments),this._toggleSelMode=()=>{this.plugin.selectionMode=!this.plugin.selectionMode}}componentDidMount(){this.subscribe(this.plugin.events.canvas3d.settingsUpdated,()=>this.forceUpdate()),this.subscribe(this.plugin.layout.events.updated,()=>this.forceUpdate()),this.subscribe(this.plugin.behaviors.interaction.selectionMode,()=>this.forceUpdate())}render(){const e=this.props.inline?{background:"transparent",width:"auto",height:"auto",lineHeight:"unset"}:{background:"transparent"};return(0,o.jsx)(Ri.K0,{svg:Oi.yG,onClick:this._toggleSelMode,title:"Toggle Selection Mode",style:e,toggleState:this.plugin.selectionMode})}}const Yr={granularity:Nr.Params.granularity},Jr=new Map([["add","Add/Union Selection"],["remove","Remove/Subtract Selection"],["intersect","Intersect Selection"],["set","Set Selection"]]);class eo extends l.dL{constructor(){super(...arguments),this.state={action:void 0,helper:void 0,isEmpty:!0,isBusy:!1,canUndo:!1,structureSelectionParams:Yr},this.set=(e,t)=>{this.plugin.managers.structure.selection.fromSelectionQuery(e,t,!1)},this.selectQuery=(e,t)=>{if(!e||!this.state.action)return void this.setState({action:void 0});const n=this.state.action;(null==t?void 0:t.shiftKey)?this.set(n,e.value):this.setState({action:void 0},()=>{this.set(n,e.value)})},this.selectHelper=(e,t)=>{console.log(e),e&&this.state.action?this.setState({helper:e.value.kind}):this.setState({action:void 0,helper:void 0})},this.queriesItems=[],this.queriesVersion=-1,this.helpersItems=void 0,this.toggleAdd=this.showAction("add"),this.toggleRemove=this.showAction("remove"),this.toggleIntersect=this.showAction("intersect"),this.toggleSet=this.showAction("set"),this.toggleTheme=this.showAction("theme"),this.toggleAddComponent=this.showAction("add-component"),this.toggleHelp=this.showAction("help"),this.setGranuality=({value:e})=>{this.plugin.managers.interactivity.setProps({granularity:e})},this.turnOff=()=>this.plugin.selectionMode=!1,this.undo=()=>{const e=this.plugin.state.data.undo();e&&this.plugin.runTask(e)},this.subtract=()=>{const e=this.plugin.managers.structure.hierarchy.getStructuresWithSelection(),t=[];for(const n of e)t.push(...n.components);0!==t.length&&this.plugin.managers.structure.component.modifyByCurrentSelection(t,"subtract")}}componentDidMount(){var e,t;this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,e=>{const t=0===e.hierarchy.structures.length;this.state.isEmpty!==t&&this.setState({isEmpty:t}),this.queriesVersion=-1,this.forceUpdate()}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e,action:void 0})}),this.subscribe(this.plugin.managers.interactivity.events.propsUpdated,()=>{this.forceUpdate()}),this.subscribe(this.plugin.state.data.events.historyUpdated,({state:e})=>{this.setState({canUndo:e.canUndo})});const n=null===(t=null===(e=this.plugin.spec.components)||void 0===e?void 0:e.selectionTools)||void 0===t?void 0:t.granularityOptions;if(n){const e=new Set(n),t={...Yr,granularity:{...Yr.granularity,options:Yr.granularity.options.filter(([t])=>e.has(t))}};this.setState({structureSelectionParams:t})}}get isDisabled(){return this.state.isBusy||this.state.isEmpty}get structures(){var e;const t=[];for(const n of this.plugin.managers.structure.hierarchy.selection.structures){const i=null===(e=n.cell.obj)||void 0===e?void 0:e.data;i&&t.push(i)}return t}get queries(){const{registry:e}=this.plugin.query.structure;if(e.version!==this.queriesVersion){const t=this.structures,n=[...e.list,...(0,os.Ag)(t),...(0,os.Mt)(t),...(0,os.HU)(t)].sort((e,t)=>t.priority-e.priority);this.queriesItems=or.W.createItems(n,{filter:e=>e!==os.Ou.current&&!e.isHidden,label:e=>e.label,category:e=>e.category,description:e=>e.description}),this.queriesVersion=e.version}return this.queriesItems}get helpers(){if(this.helpersItems)return this.helpersItems;return this.helpersItems=or.W.createItems([{kind:"residue-list",category:"Helpers",label:"Atom/Residue Identifier List",description:"Create a selection from a list of atom/residue ranges."}],{label:e=>e.label,category:e=>e.category,description:e=>e.description}),this.helpersItems}showAction(e){return()=>this.setState({action:this.state.action===e?void 0:e,helper:void 0})}render(){var e,t;const n=this.plugin.managers.interactivity.props.granularity,i=null===(t=null===(e=this.plugin.spec.components)||void 0===e?void 0:e.selectionTools)||void 0===t?void 0:t.hide,s=this.state.canUndo?`Undo ${this.plugin.state.data.latestUndoLabel}`:"Some mistakes of the past can be undone.";let r;if(this.state.action&&!this.state.helper)r=(0,o.jsxs)(o.Fragment,{children:[this.state.action&&"theme"!==this.state.action&&"add-component"!==this.state.action&&"help"!==this.state.action&&(0,o.jsxs)("div",{className:"msp-selection-viewport-controls-actions",children:[(0,o.jsx)(or.W,{header:Jr.get(this.state.action),title:"Click to close.",items:this.queries,onSelect:this.selectQuery,noOffset:!0}),(0,o.jsx)(or.W,{items:this.helpers,onSelect:this.selectHelper,noOffset:!0})]}),"theme"===this.state.action&&(0,o.jsx)("div",{className:"msp-selection-viewport-controls-actions",children:(0,o.jsx)(Ri.tW,{header:"Theme",title:"Click to close.",initialExpanded:!0,hideExpander:!0,hideOffset:!0,onHeaderClick:this.toggleTheme,topRightIcon:Oi.X6,children:(0,o.jsx)(no,{onApply:this.toggleTheme})})}),"add-component"===this.state.action&&(0,o.jsx)("div",{className:"msp-selection-viewport-controls-actions",children:(0,o.jsx)(Ri.tW,{header:"Add Component",title:"Click to close.",initialExpanded:!0,hideExpander:!0,hideOffset:!0,onHeaderClick:this.toggleAddComponent,topRightIcon:Oi.X6,children:(0,o.jsx)(vr,{onApply:this.toggleAddComponent,forSelection:!0})})}),"help"===this.state.action&&(0,o.jsx)("div",{className:"msp-selection-viewport-controls-actions",children:(0,o.jsxs)(Ri.tW,{header:"Help",title:"Click to close.",initialExpanded:!0,hideExpander:!0,hideOffset:!0,onHeaderClick:this.toggleHelp,topRightIcon:Oi.X6,maxHeight:"300px",children:[(0,o.jsx)(Zr,{header:"Selection Operations",children:(0,o.jsxs)($r,{children:["Use ",(0,o.jsx)(Oi.In,{svg:Oi.QM,inline:!0})," ",(0,o.jsx)(Oi.In,{svg:Oi.tk,inline:!0})," ",(0,o.jsx)(Oi.In,{svg:Oi.sx,inline:!0})," ",(0,o.jsx)(Oi.In,{svg:Oi.B7,inline:!0})," to modify the selection."]})}),(0,o.jsx)(Zr,{header:"Representation Operations",children:(0,o.jsxs)($r,{children:["Use ",(0,o.jsx)(Oi.In,{svg:Oi.fe,inline:!0})," ",(0,o.jsx)(Oi.In,{svg:Oi.c3,inline:!0})," ",(0,o.jsx)(Oi.In,{svg:Oi.$j,inline:!0})," ",(0,o.jsx)(Oi.In,{svg:Oi.L3,inline:!0})," to color, create components, remove from components, or undo actions."]})}),(0,o.jsx)(Qr,{selectOnly:!0})]})})]});else if(Jr.has(this.state.action)&&"residue-list"===this.state.helper){const e=()=>this.setState({action:void 0,helper:void 0});r=(0,o.jsx)("div",{className:"msp-selection-viewport-controls-actions",children:(0,o.jsx)(Ri.tW,{header:"Atom/Residue Identifier List",title:"Click to close.",initialExpanded:!0,hideExpander:!0,hideOffset:!0,onHeaderClick:e,topRightIcon:Oi.X6,children:(0,o.jsx)(ro,{modifier:this.state.action,plugin:this.plugin,close:e})})})}return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"msp-flex-row",style:{background:"none"},children:[!(null==i?void 0:i.granularity)&&(0,o.jsx)(zi.UT,{title:"Picking Level for selecting and highlighting",param:this.state.structureSelectionParams.granularity,name:"granularity",value:n,onChange:this.setGranuality,isDisabled:this.isDisabled}),!(null==i?void 0:i.union)&&(0,o.jsx)(Ri.ff,{icon:Oi.QM,title:`${Jr.get("add")}. Hold shift key to keep menu open.`,toggle:this.toggleAdd,isSelected:"add"===this.state.action,disabled:this.isDisabled}),!(null==i?void 0:i.subtract)&&(0,o.jsx)(Ri.ff,{icon:Oi.tk,title:`${Jr.get("remove")}. Hold shift key to keep menu open.`,toggle:this.toggleRemove,isSelected:"remove"===this.state.action,disabled:this.isDisabled}),!(null==i?void 0:i.intersect)&&(0,o.jsx)(Ri.ff,{icon:Oi.sx,title:`${Jr.get("intersect")}. Hold shift key to keep menu open.`,toggle:this.toggleIntersect,isSelected:"intersect"===this.state.action,disabled:this.isDisabled}),!(null==i?void 0:i.set)&&(0,o.jsx)(Ri.ff,{icon:Oi.B7,title:`${Jr.get("set")}. Hold shift key to keep menu open.`,toggle:this.toggleSet,isSelected:"set"===this.state.action,disabled:this.isDisabled}),!(null==i?void 0:i.theme)&&(0,o.jsx)(Ri.ff,{icon:Oi.fe,title:"Apply Theme to Selection",toggle:this.toggleTheme,isSelected:"theme"===this.state.action,disabled:this.isDisabled,style:{marginLeft:"10px"}}),!(null==i?void 0:i.componentAdd)&&(0,o.jsx)(Ri.ff,{icon:Oi.c3,title:"Create Component of Selection with Representation",toggle:this.toggleAddComponent,isSelected:"add-component"===this.state.action,disabled:this.isDisabled}),!(null==i?void 0:i.componentRemove)&&(0,o.jsx)(Ri.K0,{svg:Oi.$j,title:"Remove/subtract Selection from all Components",onClick:this.subtract,disabled:this.isDisabled}),!(null==i?void 0:i.undo)&&(0,o.jsx)(Ri.K0,{svg:Oi.L3,onClick:this.undo,disabled:!this.state.canUndo||this.isDisabled,title:s}),!(null==i?void 0:i.help)&&(0,o.jsx)(Ri.ff,{icon:Oi.ml,title:"Show/hide help",toggle:this.toggleHelp,style:{marginLeft:"10px"},isSelected:"help"===this.state.action}),!(null==i?void 0:i.cancel)&&this.plugin.config.get(Mr.AB.Viewport.ShowSelectionMode)&&(0,o.jsx)(Ri.K0,{svg:Oi.XD,title:"Turn selection mode off",onClick:this.turnOff})]}),r]})}}class to extends l.dL{constructor(){super(...arguments),this.state={isEmpty:!0,isBusy:!1},this.clear=()=>this.plugin.managers.interactivity.lociSelects.deselectAll(),this.focus=()=>{if(0===this.plugin.managers.structure.selection.stats.elementCount)return;const{sphere:e}=this.plugin.managers.structure.selection.getBoundary();this.plugin.managers.camera.focusSphere(e)},this.highlight=e=>{this.plugin.managers.interactivity.lociHighlights.clearHighlights(),this.plugin.managers.structure.selection.entries.forEach(e=>{this.plugin.managers.interactivity.lociHighlights.highlight({loci:e.selection},!1)})},this.clearHighlight=()=>{this.plugin.managers.interactivity.lociHighlights.clearHighlights()}}componentDidMount(){this.subscribe(this.plugin.managers.structure.selection.events.changed,()=>{this.forceUpdate()}),this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,e=>{const t=0===e.structures.length;this.state.isEmpty!==t&&this.setState({isEmpty:t})}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e})})}get isDisabled(){return this.state.isBusy||this.state.isEmpty}get stats(){const e=this.plugin.managers.structure.selection.stats;return 0===e.structureCount||0===e.elementCount?"Nothing Selected":`${(0,Vr.Kq)(e.label)} Selected`}render(){const e=this.plugin.managers.structure.selection.stats,t=0===e.structureCount||0===e.elementCount;return t&&this.props.hideOnEmpty?null:(0,o.jsx)(o.Fragment,{children:(0,o.jsxs)("div",{className:"msp-flex-row",children:[(0,o.jsx)(Ri.$n,{noOverflow:!0,onClick:this.focus,title:"Click to Focus Selection",disabled:t,onMouseEnter:this.highlight,onMouseLeave:this.clearHighlight,style:{textAlignLast:t?void 0:"left"},children:this.stats}),!t&&(0,o.jsx)(Ri.K0,{svg:Oi.XD,onClick:this.clear,title:"Clear",className:"msp-form-control",flex:!0})]})})}}class no extends l.jB{constructor(){super(...arguments),this._params=(0,ar._)(e=>As.getThemeParams(this.plugin,e)),this.state={values:Xi.t.getDefaultValues(this.params)},this.apply=()=>{var e,t;this.plugin.managers.structure.component.applyTheme(this.state.values,this.plugin.managers.structure.hierarchy.current.structures),null===(t=(e=this.props).onApply)||void 0===t||t.call(e)},this.paramsChanged=e=>this.setState({values:e})}get params(){return this._params(this.plugin.managers.structure.component.pivotStructure)}render(){return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(zi.y1,{params:this.params,values:this.state.values,onChangeValues:this.paramsChanged}),(0,o.jsx)(Ri.$n,{icon:Oi.fe,className:"msp-btn-commit msp-btn-commit-on",onClick:this.apply,style:{marginTop:"1px"},children:"Apply Theme"})]})}}const io={idType:Xi.t.Select("auth",Xi.t.arrayToOptions(["auth","label","atom-id","element-symbol"])),identifiers:Xi.t.Text("",{description:"A comma separated list of atom identifiers (e.g. 10, 15-25), element symbols (e.g. N, C or 20-200) or residue ranges in given chain (e.g. A 10-15, B 25, C 30:i)"})},so=Xi.t.getDefaultValues(io);function ro({modifier:e,plugin:t,close:n}){const[i,s]=r.useState(so),a=()=>{if(0!==i.identifiers.trim().length)try{n();const s=Ur(i.identifiers,i.idType);t.managers.structure.selection.fromCompiledQuery(e,s,!1)}catch(s){console.error(s),t.log.error("Failed to create selection")}};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(zi.y1,{params:io,values:i,onChangeValues:s,onEnter:a}),(0,o.jsxs)(Ri.$n,{className:"msp-btn-commit msp-btn-commit-on",disabled:0===i.identifiers.trim().length,onClick:a,style:{marginTop:"1px"},children:[(0,Vr.ZH)(e)," Selection"]})]})}class oo extends l.VK{defaultState(){return{isCollapsed:!1,header:"Measurements",brand:{accent:"gray",svg:Oi.yF}}}renderControls(){return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(lo,{}),(0,o.jsx)(ao,{})]})}}class ao extends l.jB{componentDidMount(){this.subscribe(this.plugin.managers.structure.measurement.behaviors.state,()=>{this.forceUpdate()})}renderGroup(e,t){const n=[];for(const i of e)i.obj&&n.push((0,o.jsx)(uo,{cell:i},i.obj.id));return n.length?(0,o.jsx)(Ri.Yj,{header:t,initiallyExpanded:!0,children:n}):null}render(){const e=this.plugin.managers.structure.measurement.state;return(0,o.jsxs)("div",{style:{marginTop:"6px"},children:[this.renderGroup(e.labels,"Labels"),this.renderGroup(e.distances,"Distances"),this.renderGroup(e.angles,"Angles"),this.renderGroup(e.dihedrals,"Dihedrals"),this.renderGroup(e.orientations,"Orientations"),this.renderGroup(e.planes,"Planes")]})}}class lo extends l.jB{constructor(){super(...arguments),this.state={isBusy:!1,action:void 0},this.measureDistance=()=>{const e=this.plugin.managers.structure.selection.additionsHistory;this.plugin.managers.structure.measurement.addDistance(e[0].loci,e[1].loci)},this.measureAngle=()=>{const e=this.plugin.managers.structure.selection.additionsHistory;this.plugin.managers.structure.measurement.addAngle(e[0].loci,e[1].loci,e[2].loci)},this.measureDihedral=()=>{const e=this.plugin.managers.structure.selection.additionsHistory;this.plugin.managers.structure.measurement.addDihedral(e[0].loci,e[1].loci,e[2].loci,e[3].loci)},this.addLabel=()=>{const e=this.plugin.managers.structure.selection.additionsHistory;this.plugin.managers.structure.measurement.addLabel(e[0].loci)},this.addOrientation=()=>{const e=[];this.plugin.managers.structure.selection.entries.forEach(t=>{e.push(t.selection)}),this.plugin.managers.structure.measurement.addOrientation(e)},this.addPlane=()=>{const e=[];this.plugin.managers.structure.selection.entries.forEach(t=>{e.push(t.selection)}),this.plugin.managers.structure.measurement.addPlane(e)},this.selectAction=e=>{this.toggleAdd(),e&&(null==e?void 0:e.value)()},this.toggleAdd=()=>this.setState({action:"add"===this.state.action?void 0:"add"}),this.toggleOptions=()=>this.setState({action:"options"===this.state.action?void 0:"options"})}componentDidMount(){this.subscribe(this.selection.events.additionsHistoryUpdated,()=>{this.forceUpdate(),this.updateOrderLabels()}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e})})}componentWillUnmount(){this.clearOrderLabels(),super.componentWillUnmount()}componentDidUpdate(e,t){this.state.action!==t.action&&this.updateOrderLabels()}clearOrderLabels(){this.plugin.managers.structure.measurement.addOrderLabels([])}updateOrderLabels(){if("add"!==this.state.action)return void this.clearOrderLabels();const e=[],t=this.selection.additionsHistory;for(let n=0;n<t.length&&n<4;n++)e.push(t[n].loci);this.plugin.managers.structure.measurement.addOrderLabels(e)}get selection(){return this.plugin.managers.structure.selection}get actions(){const e=this.selection.additionsHistory;return[{kind:"item",label:"Label "+(0===e.length?" (1 selection item required)":" (1st selection item)"),value:this.addLabel,disabled:0===e.length},{kind:"item",label:"Distance "+(e.length<2?" (2 selection items required)":" (top 2 selection items)"),value:this.measureDistance,disabled:e.length<2},{kind:"item",label:"Angle "+(e.length<3?" (3 selection items required)":" (top 3 items)"),value:this.measureAngle,disabled:e.length<3},{kind:"item",label:"Dihedral "+(e.length<4?" (4 selection items required)":" (top 4 selection items)"),value:this.measureDihedral,disabled:e.length<4},{kind:"item",label:"Orientation "+(0===e.length?" (selection required)":" (current selection)"),value:this.addOrientation,disabled:0===e.length},{kind:"item",label:"Plane "+(0===e.length?" (selection required)":" (current selection)"),value:this.addPlane,disabled:0===e.length}]}highlight(e){this.plugin.managers.interactivity.lociHighlights.highlightOnly({loci:e},!1)}moveHistory(e,t){this.plugin.managers.structure.selection.modifyHistory(e,t,4)}focusLoci(e){this.plugin.managers.camera.focusLoci(e)}historyEntry(e,t){const n=this.plugin.managers.structure.selection.additionsHistory;return(0,o.jsxs)("div",{className:"msp-flex-row",onMouseEnter:()=>this.highlight(e.loci),onMouseLeave:()=>this.plugin.managers.interactivity.lociHighlights.clearHighlights(),children:[(0,o.jsxs)(Ri.$n,{noOverflow:!0,title:"Click to focus. Hover to highlight.",onClick:()=>this.focusLoci(e.loci),style:{width:"auto",textAlign:"left"},children:[t,". ",(0,o.jsx)("span",{dangerouslySetInnerHTML:{__html:e.label}})]}),n.length>1&&(0,o.jsx)(Ri.K0,{svg:Oi.p8,small:!0,className:"msp-form-control",onClick:()=>this.moveHistory(e,"up"),flex:"20px",title:"Move up"}),n.length>1&&(0,o.jsx)(Ri.K0,{svg:Oi.qp,small:!0,className:"msp-form-control",onClick:()=>this.moveHistory(e,"down"),flex:"20px",title:"Move down"}),(0,o.jsx)(Ri.K0,{svg:Oi.mf,small:!0,className:"msp-form-control",onClick:()=>this.plugin.managers.structure.selection.modifyHistory(e,"remove"),flex:!0,title:"Remove"})]},e.id)}add(){const e=this.plugin.managers.structure.selection.additionsHistory,t=[];for(let i=0,s=Math.min(e.length,4);i<s;i++)t.push(this.historyEntry(e[i],i+1));const n=this.plugin.config.get(Mr.AB.Viewport.ShowSelectionMode)?(0,o.jsxs)(o.Fragment,{children:[" ","(toggle ",(0,o.jsx)(Wr,{inline:!0})," mode)"]}):null;return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(or.W,{items:this.actions,onSelect:this.selectAction}),t.length>0&&(0,o.jsx)("div",{className:"msp-control-offset",children:t}),0===t.length&&(0,o.jsx)("div",{className:"msp-control-offset msp-help-text",children:(0,o.jsxs)("div",{className:"msp-help-description",children:[(0,o.jsx)(Oi.In,{svg:Oi.ml,inline:!0}),"Add one or more selections",n]})})]})}render(){return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"msp-flex-row",children:[(0,o.jsx)(Ri.ff,{icon:Oi.CR,label:"Add",toggle:this.toggleAdd,isSelected:"add"===this.state.action,disabled:this.state.isBusy,className:"msp-btn-apply-simple"}),(0,o.jsx)(Ri.ff,{icon:Oi.Hk,label:"",title:"Options",toggle:this.toggleOptions,isSelected:"options"===this.state.action,disabled:this.state.isBusy,style:{flex:"0 0 40px",padding:0}})]}),"add"===this.state.action&&this.add(),"options"===this.state.action&&(0,o.jsx)(co,{})]})}}class co extends l.jB{constructor(){super(...arguments),this.state={isDisabled:!1},this.changed=e=>{this.plugin.managers.structure.measurement.setOptions(e)}}componentDidMount(){this.subscribe(this.plugin.managers.structure.measurement.behaviors.state,()=>{this.forceUpdate()}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isDisabled:e})})}render(){const e=this.plugin.managers.structure.measurement.state;return(0,o.jsx)("div",{className:"msp-control-offset",children:(0,o.jsx)(zi.y1,{params:Ir,values:e.options,onChangeValues:this.changed,isDisabled:this.state.isDisabled})})}}class uo extends l.jB{constructor(){super(...arguments),this.state={showUpdate:!1},this.delete=()=>{Fi.a.State.RemoveObject(this.plugin,{state:this.props.cell.parent,ref:this.props.cell.transform.parent,removeParentGhosts:!0})},this.toggleVisibility=e=>{e.preventDefault(),Fi.a.State.ToggleVisibility(this.plugin,{state:this.props.cell.parent,ref:this.props.cell.transform.parent}),e.currentTarget.blur()},this.highlight=()=>{var e;if(!this.selections)return;this.plugin.managers.interactivity.lociHighlights.clearHighlights();for(const n of this.lociArray)this.plugin.managers.interactivity.lociHighlights.highlight({loci:n},!1);const t=null===(e=this.props.cell.obj)||void 0===e?void 0:e.data.repr.getAllLoci();if(t)for(const n of t)this.plugin.managers.interactivity.lociHighlights.highlight({loci:n},!1)},this.clearHighlight=()=>{this.plugin.managers.interactivity.lociHighlights.clearHighlights()},this.toggleUpdate=()=>this.setState({showUpdate:!this.state.showUpdate}),this.focus=()=>{if(!this.selections)return;const e=ts.QN.getBundleBoundingSphere({loci:this.lociArray});e&&this.plugin.managers.camera.focusSphere(e)},this.selectAction=e=>{e&&(this.setState({showUpdate:!1}),(null==e?void 0:e.value)())}}componentDidMount(){this.subscribe(this.plugin.state.events.cell.stateUpdated,e=>{this.forceUpdate()})}get selections(){var e;return null===(e=this.props.cell.obj)||void 0===e?void 0:e.data.sourceData}get lociArray(){const e=this.selections;return e?e.infos?[e.infos[0].loci]:e.pairs?e.pairs[0].loci:e.triples?e.triples[0].loci:e.quads?e.quads[0].loci:e.locis?e.locis:[]:[]}get label(){const e=this.selections;return e?e.infos?(0,Lr.YQ)(e.infos[0].loci,{condensed:!0}):e.pairs?(0,Lr.W8)(e.pairs[0],{condensed:!0,unitLabel:this.plugin.managers.structure.measurement.state.options.distanceUnitLabel}):e.triples?(0,Lr.k0)(e.triples[0],{condensed:!0}):e.quads?(0,Lr.kd)(e.quads[0],{condensed:!0}):e.locis?(0,Lr.k7)(e.locis,{countsOnly:!0}):"<empty>":"<empty>"}get actions(){return this.props.cell.sourceRef,[or.W.Item("Select This",()=>this.plugin.managers.structure.selection.fromSelections(this.props.cell.sourceRef),{icon:Oi.B7})]}render(){const{cell:e}=this.props,{obj:t}=e;return t?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"msp-flex-row",onMouseEnter:this.highlight,onMouseLeave:this.clearHighlight,children:[(0,o.jsx)("button",{className:"msp-form-control msp-control-button-label msp-no-overflow",title:"Click to focus. Hover to highlight.",onClick:this.focus,style:{width:"auto",textAlign:"left"},children:(0,o.jsx)("span",{dangerouslySetInnerHTML:{__html:this.label}})}),(0,o.jsx)(Ri.K0,{svg:e.state.isHidden?Oi.qF:Oi.zs,toggleState:!1,small:!0,className:"msp-form-control",onClick:this.toggleVisibility,flex:!0,title:e.state.isHidden?"Show":"Hide"}),(0,o.jsx)(Ri.K0,{svg:Oi.mf,small:!0,className:"msp-form-control",onClick:this.delete,flex:!0,title:"Delete",toggleState:!1}),(0,o.jsx)(Ri.K0,{svg:Oi.cv,className:"msp-form-control",onClick:this.toggleUpdate,flex:!0,title:"Actions",toggleState:this.state.showUpdate})]},t.id),this.state.showUpdate&&e.parent&&(0,o.jsx)(o.Fragment,{children:(0,o.jsxs)("div",{className:"msp-accent-offset",children:[(0,o.jsx)(or.W,{items:this.actions,onSelect:this.selectAction,noOffset:!0}),(0,o.jsx)(Ri.Yj,{header:"Options",noOffset:!0,children:(0,o.jsx)(pr,{state:e.parent,transform:e.transform,customHeader:"none",autoHideApply:!0})})]})})]}):null}}var ho=n(65533);function po(e,t,n,i){const s=ho.X9.indexOf(t.unit.elements,t.element),r=Gi.iZ.Loci(t.structure,[{unit:t.unit,indices:ho.CD.ofSingleton(s)}]),o="residue"===i?Gi.iZ.Loci.extendToWholeResidues(r):Gi.iZ.Loci.extendToWholeChains(r),a=Gi.ZP.entity.pdbx_description(t).join(", ");for(const l of n.units){const t=Gi.iZ.Loci(o.structure,[{unit:l,indices:o.elements[0].indices}]);let s=(0,Lr.YQ)(t,{reverse:!0,hidePrefix:!0,htmlStyling:!1,granularity:i});s||(s=(0,Lr.YQ)(t,{hidePrefix:!1,htmlStyling:!1})),n.units.length>1&&(s+=` | ${t.elements[0].unit.conformation.operator.name}`);const r={label:s,category:a,loci:t};e.has(a)?e.get(a).push(r):e.set(a,[r])}}function mo(e){const t=new Map,n=Gi.iZ.Location.create(e);for(const s of e.unitSymmetryGroups){if(!Gi.Nf.isAtomic(s.units[0]))continue;n.unit=s.units[0],n.element=s.elements[0];const e=Gi.Nf.Traits.is(n.unit.traits,Gi.Nf.Trait.MultiChain),i=Gi.ZP.entity.type(n),r="non-polymer"===i,o="branched"===i;if(!!Gi.ZP.entity.prd_id(n))po(t,n,s,"chain");else if(r&&!e)po(t,n,s,"residue");else if(o||r&&e){const e=n.unit,{index:i}=e.model.atomicHierarchy.residueAtomSegments;let r=-1;for(let o=0,a=e.elements.length;o<a;++o){const a=e.elements[o],l=i[a];l!==r&&(n.element=a,po(t,n,s,"residue"),r=l)}}}const i=[];return t.forEach((e,t)=>{1===e.length?i.push({label:`${t}: ${e[0].label}`,loci:e[0].loci}):e.length<2e3&&i.push(...e)}),i}class fo extends l.dL{constructor(){super(...arguments),this.state={isBusy:!1,showAction:!1},this.getSelectionItems=(0,ar._)(e=>{var t;const n=[];for(const i of e){const e=null===(t=i.cell.obj)||void 0===t?void 0:t.data;if(e){const t=mo(e);t.length>0&&n.push([or.W.Header(e.label,{description:e.label}),...or.W.createItems(t,{label:e=>e.label,category:e=>e.category,description:e=>e.label})])}}return n}),this.selectAction=(e,t)=>{if(!e||!this.state.showAction)return void this.setState({showAction:!1});const n=e.value;(null==t?void 0:t.shiftKey)?this.plugin.managers.structure.focus.addFromLoci(n.loci):this.plugin.managers.structure.focus.set(n),this.focusCamera()},this.toggleAction=()=>this.setState({showAction:!this.state.showAction}),this.focusCamera=()=>{const{current:e}=this.plugin.managers.structure.focus;e&&this.plugin.managers.camera.focusLoci(e.loci)},this.clear=()=>{this.plugin.managers.structure.focus.clear(),this.plugin.managers.camera.reset()},this.highlightCurrent=()=>{const{current:e}=this.plugin.managers.structure.focus;e&&this.plugin.managers.interactivity.lociHighlights.highlightOnly({loci:e.loci},!1)},this.clearHighlights=()=>{this.plugin.managers.interactivity.lociHighlights.clearHighlights()}}componentDidMount(){this.subscribe(this.plugin.managers.structure.focus.behaviors.current,e=>{this.getSelectionItems([]),this.forceUpdate()}),this.subscribe(this.plugin.managers.structure.focus.events.historyUpdated,e=>{this.forceUpdate()}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e,showAction:!1})})}get isDisabled(){return this.state.isBusy||0===this.plugin.managers.structure.hierarchy.selection.structures.length}get actionItems(){const e=[],{history:t}=this.plugin.managers.structure.focus;t.length>0&&e.push([or.W.Header("History",{description:"Previously focused on items."}),...or.W.createItems(t,{label:e=>e.label,description:e=>e.category&&e.label!==e.category?`${e.category} | ${e.label}`:e.label})]);const n=this.getSelectionItems(this.plugin.managers.structure.hierarchy.selection.structures);if(1===n.length){n[0][0].initiallyExpanded=!0}const i=[];return n.length>0&&i.push(...n),e.length>0&&i.push(...e),i}getToggleBindingLabel(){var e;const t=this.plugin.state.behaviors.transforms.get(Gr.FocusLoci.id);if(!t)return"";const n=null===(e=t.params)||void 0===e?void 0:e.bindings.clickFocus;return!n||_r.O.isEmpty(n)?"":_r.O.formatTriggers(n)}render(){const{current:e}=this.plugin.managers.structure.focus,t=(null==e?void 0:e.label)||"Nothing Focused";let n="Click to Center Camera";if(!e){n="Select focus using the menu";const e=this.getToggleBindingLabel();e&&(n+=`\nor use '${e}' on element`)}return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"msp-flex-row",children:[(0,o.jsx)(Ri.$n,{noOverflow:!0,onClick:this.focusCamera,title:n,onMouseEnter:this.highlightCurrent,onMouseLeave:this.clearHighlights,disabled:this.isDisabled||!e,style:{textAlignLast:e?"left":void 0},children:t}),e&&(0,o.jsx)(Ri.K0,{svg:Oi.XD,onClick:this.clear,title:"Clear",className:"msp-form-control",flex:!0,disabled:this.isDisabled}),(0,o.jsx)(Ri.ff,{icon:Oi.vC,title:"Select a focus target to center on an show its surroundings. Hold shift to focus on multiple targets.",toggle:this.toggleAction,isSelected:this.state.showAction,disabled:this.isDisabled,style:{flex:"0 0 40px",padding:0}})]}),this.state.showAction&&(0,o.jsx)(or.W,{items:this.actionItems,onSelect:this.selectAction})]})}}class go extends l.VK{constructor(){super(...arguments),this.item=e=>{var t,n,i,s,r,o,a,l,c;const u=this.plugin.managers.structure.hierarchy.seletionSet;let d;switch(e.kind){case"model":{const r=null===(t=e.cell.obj)||void 0===t?void 0:t.data;r&&Gi.Kx.TrajectoryInfo.get(r).size>1&&(d=`${null===(n=e.cell.obj)||void 0===n?void 0:n.data.entryId} | Model ${Gi.Kx.TrajectoryInfo.get(r).index+1} of ${Gi.Kx.TrajectoryInfo.get(r).size}`),d=`${null===(i=e.cell.obj)||void 0===i?void 0:i.data.entryId} | ${null===(s=e.cell.obj)||void 0===s?void 0:s.label}`;break}case"structure":{const t=null===(r=e.cell.obj)||void 0===r?void 0:r.data.models[0];if(t&&Gi.Kx.TrajectoryInfo.get(t).size>1){d=`${t.entryId} | ${null===(o=e.cell.obj)||void 0===o?void 0:o.label} (Model ${Gi.Kx.TrajectoryInfo.get(t).index+1} of ${Gi.Kx.TrajectoryInfo.get(t).size})`;break}if(t){d=`${t.entryId} | ${null===(a=e.cell.obj)||void 0===a?void 0:a.label}`;break}d=`${null===(l=e.cell.obj)||void 0===l?void 0:l.label}`;break}default:d=null===(c=e.cell.obj)||void 0===c?void 0:c.label}return{kind:"item",label:d||e.kind,selected:u.has(e.cell.transform.ref),value:[e]}},this.getTrajectoryItems=e=>{var t;return 0===e.models.length?this.item(e):[or.W.Header(null===(t=e.cell.obj)||void 0===t?void 0:t.label),...e.models.map(this.getModelItems)]},this.getModelItems=e=>{var t,n,i;if(0===e.structures.length)return this.item(e);if(1===e.structures.length){const i=this.plugin.managers.structure.hierarchy.seletionSet,s=e.structures[0];return{label:`${null===(t=e.cell.obj)||void 0===t?void 0:t.label} | ${null===(n=s.cell.obj)||void 0===n?void 0:n.label}`,selected:i.has(s.cell.transform.ref),value:[e,s]}}return[or.W.Header(null===(i=e.cell.obj)||void 0===i?void 0:i.label),...e.structures.map(this.item)]},this.selectHierarchy=e=>{if(!e||0===e.length)return;const t=[];for(const n of e)for(const e of n.value)t.push(e);this.plugin.managers.structure.hierarchy.updateCurrent(t,e[0].selected?"remove":"add")},this.toggleHierarchy=()=>this.setState({show:"hierarchy"!==this.state.show?"hierarchy":void 0}),this.togglePreset=()=>this.setState({show:"presets"!==this.state.show?"presets":void 0}),this.applyPreset=e=>{if(this.setState({show:void 0}),!e)return;const t=this.plugin.managers.structure,{trajectories:n}=t.hierarchy.selection;t.hierarchy.applyPreset(n,e.value)},this.updateModelQueueParams=void 0,this.isUpdatingModel=!1,this.updateStructureModel=e=>{this.updateModelQueueParams=e,this._updateStructureModel()},this.updateStructure=e=>{const{selection:t}=this.plugin.managers.structure.hierarchy,n=t.structures[0];return this.plugin.managers.structure.hierarchy.updateStructure(n,e)}}defaultState(){return{header:"Structure",isCollapsed:!1,isBusy:!1,brand:{accent:"purple",svg:Oi.Rm}}}componentDidMount(){this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,()=>this.forceUpdate()),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e})})}get hierarchyItems(){const e=this.plugin.managers.structure.hierarchy,{current:t}=e,n=[];return t.trajectories.length>1&&n.push([or.W.Header("Trajectories"),...t.trajectories.map(this.item)]),(t.models.length>1||t.trajectories.length>1)&&n.push([or.W.Header("Models"),...t.models.map(this.item)]),1===t.trajectories.length&&1===t.models.length?n.push(...t.structures.map(this.item)):t.structures.length>0&&n.push([or.W.Header("Structures"),...t.structures.map(this.item)]),n}get isEmpty(){const{structures:e,models:t,trajectories:n}=this.plugin.managers.structure.hierarchy.current;return 0===n.length&&0===t.length&&0===e.length}get label(){var e,t,n,i,s,r,o,a,l,c,u,d,h,p;const{structures:m,models:f,trajectories:g}=this.plugin.managers.structure.hierarchy.selection;if(1===m.length){const o=m[0];return(null===(t=null===(e=o.model)||void 0===e?void 0:e.trajectory)||void 0===t?void 0:t.models)&&1===o.model.trajectory.models.length?null===(n=o.cell.obj)||void 0===n?void 0:n.data.label:o.model?`${null===(i=o.model.cell.obj)||void 0===i?void 0:i.label} | ${null===(s=o.cell.obj)||void 0===s?void 0:s.data.label}`:null===(r=o.cell.obj)||void 0===r?void 0:r.data.label}if(m.length>1){const e=m[0],t=null===(o=null==e?void 0:e.model)||void 0===o?void 0:o.trajectory;let n=!0;for(const i of m)if((null===(a=null==i?void 0:i.model)||void 0===a?void 0:a.trajectory)!==t){n=!1;break}return n&&t?`${null===(l=t.cell.obj)||void 0===l?void 0:l.label} | ${m.length} structures`:`${m.length} structures`}if(f.length>0){const e=f[0].trajectory;if(1===f.length){const t=null===(c=f[0].cell.obj)||void 0===c?void 0:c.data;return t&&Gi.Kx.TrajectoryInfo.get(t).size>1?`${null===(u=null==e?void 0:e.cell.obj)||void 0===u?void 0:u.label} | Model ${Gi.Kx.TrajectoryInfo.get(t).index+1} of ${Gi.Kx.TrajectoryInfo.get(t).size}`:`${null===(d=null==e?void 0:e.cell.obj)||void 0===d?void 0:d.label} | Model`}let t=!0;for(const n of f)if(n.trajectory!==e){t=!1;break}return t?`${null===(h=null==e?void 0:e.cell.obj)||void 0===h?void 0:h.label} | ${f.length} models`:`${f.length} models`}return g.length>0?1===g.length?`${null===(p=g[0].cell.obj)||void 0===p?void 0:p.label} trajectory`:`${g.length} trajectories`:0===g.length&&0===f.length&&0===m.length?"Nothing Loaded":"Nothing Selected"}get presetActions(){const e=[],{trajectories:t}=this.plugin.managers.structure.hierarchy.selection;if(0===t.length)return e;let n=this.plugin.builders.structure.hierarchy.getPresets(t[0].cell.obj);if(t.length>1){const e=new Set(n);for(let n=1;n<t.length;n++){const i=this.plugin.builders.structure.hierarchy.getPresets(t[n].cell.obj),s=new Set(i);for(const t of i)s.has(t)||e.delete(t)}n=n.filter(t=>e.has(t))}for(const i of n)e.push(or.W.Item(i.display.name,i,{description:i.display.description}));return e}async _updateStructureModel(){if(!this.updateModelQueueParams||this.isUpdatingModel)return;const e=this.updateModelQueueParams;this.updateModelQueueParams=void 0;try{this.isUpdatingModel=!0;const{selection:t}=this.plugin.managers.structure.hierarchy,n=t.structures[0].model;await this.plugin.state.updateTransform(this.plugin.state.data,n.cell.transform.ref,e,"Model Index")}finally{this.isUpdatingModel=!1,this._updateStructureModel()}}get modelIndex(){var e,t;const{selection:n}=this.plugin.managers.structure.hierarchy;if(1!==n.structures.length)return null;const i=n.structures[0].model;if(!i||i.cell.transform.transformer!==Ni.f.Model.ModelFromTrajectory)return null;if(!i.cell.obj||Gi.Kx.TrajectoryInfo.get(i.cell.obj.data).size<=1)return null;const s=null===(e=i.cell.params)||void 0===e?void 0:e.definition;return s?(0,o.jsx)(zi.y1,{params:s,values:null===(t=i.cell.params)||void 0===t?void 0:t.values,onChangeValues:this.updateStructureModel,isDisabled:this.state.isBusy}):null}get structureType(){var e;const{selection:t}=this.plugin.managers.structure.hierarchy;if(1!==t.structures.length)return null;const n=t.structures[0];return(null===(e=n.cell.params)||void 0===e?void 0:e.definition)&&n.cell.parent?(0,o.jsx)(pr,{state:n.cell.parent,transform:n.cell.transform,customHeader:"none",customUpdate:this.updateStructure,noMargin:!0,autoHideApply:!0}):null}get transform(){const{selection:e}=this.plugin.managers.structure.hierarchy;if(1!==e.structures.length)return null;const t=e.structures[0];if(!t.cell.parent)return null;const n=Yi.QX.tryFindDecorator(this.plugin.state.data,t.cell.transform.ref,Ni.f.Model.TransformStructureConformation);return n?(0,o.jsx)(Ri.Yj,{header:"Conformation Transform",children:(0,o.jsx)(pr,{state:n.parent,transform:n.transform,customHeader:"none",noMargin:!0,autoHideApply:!0})}):void 0}renderControls(){const e=this.state.isBusy||this.isEmpty,t=this.presetActions,n=this.label;return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"msp-flex-row",style:{marginTop:"1px"},children:[(0,o.jsx)(Ri.$n,{noOverflow:!0,flex:!0,onClick:this.toggleHierarchy,disabled:e,title:n,children:n}),t.length>0&&(0,o.jsx)(Ri.K0,{svg:Oi.sM,className:"msp-form-control",flex:"40px",onClick:this.togglePreset,title:"Apply a structure presets to the current hierarchy.",toggleState:"presets"===this.state.show,disabled:e})]}),"hierarchy"===this.state.show&&(0,o.jsx)(or.W,{items:this.hierarchyItems,onSelect:this.selectHierarchy,multiselect:!0}),"presets"===this.state.show&&(0,o.jsx)(or.W,{items:t,onSelect:this.applyPreset}),this.modelIndex,this.structureType,this.transform,(0,o.jsxs)("div",{style:{marginTop:"6px"},children:[(0,o.jsx)(fo,{}),(0,o.jsx)(to,{hideOnEmpty:!0})]})]})}}var yo=n(46124);function vo(e,t,n={}){const i=n;return"string"==typeof i.type||"string"==typeof i.color||"string"==typeof i.size?function(e,t,n){const i=n.type&&e.representation.volume.registry.get(n.type)||e.representation.volume.registry.default.provider,s=n.color&&e.representation.volume.themes.colorThemeRegistry.get(n.color)||e.representation.volume.themes.colorThemeRegistry.get(i.defaultColorTheme.name),r=n.size&&e.representation.volume.themes.sizeThemeRegistry.get(n.size)||e.representation.volume.themes.sizeThemeRegistry.get(i.defaultSizeTheme.name);return bo(e,t,{type:i,typeParams:n.typeParams,color:s,colorParams:n.colorParams,size:r,sizeParams:n.sizeParams})}(e,t||yo.f.One,n):bo(e,t||yo.f.One,n)}function bo(e,t,n={}){const{themes:i}=e.representation.volume,s={volume:t},r=n.type||e.representation.volume.registry.default.provider,o=Xi.t.getDefaultValues(r.getParams(i,t)),a=Object.assign(o,n.typeParams),l=n.color||i.colorThemeRegistry.get(r.defaultColorTheme.name),c=Xi.t.getDefaultValues(l.getParams(s));l.name===r.defaultColorTheme.name&&Object.assign(c,r.defaultColorTheme.props);const u=Object.assign(c,n.colorParams),d=n.size||i.sizeThemeRegistry.get(r.defaultSizeTheme.name),h=Xi.t.getDefaultValues(d.getParams(s));d.name===r.defaultSizeTheme.name&&Object.assign(h,r.defaultSizeTheme.props);const p=Object.assign(h,n.sizeParams);return{type:{name:r.name,params:a},colorTheme:{name:l.name,params:u},sizeTheme:{name:d.name,params:p}}}function xo(e,t){const n=function(e,t){return{state:e,oldHierarchy:t,hierarchy:So(),changed:!1,added:new Set}}(e,t||So());return function(e,t){const n={tree:e,state:t};Mo(n,e.root),n.state}(e.tree,n),t&&t.refs.forEach(To,n),{hierarchy:n.hierarchy,added:n.added,changed:n.changed}}function So(){return{volumes:[],lazyVolumes:[],refs:new Map}}function Co(e){return{kind:"volume",cell:e,version:e.transform.version,representations:[]}}function wo(e){return{kind:"lazy-volume",cell:e,version:e.transform.version}}function ko(e,t){return{kind:"volume-representation",cell:e,version:e.transform.version,volume:t}}function Bo(e,t,n,i,...s){const r=i(...s);n.push(r),e.hierarchy.refs.set(t.transform.ref,r);const o=e.oldHierarchy.refs.get(t.transform.ref);return o?o.version!==t.transform.version&&(e.changed=!0):(e.added.add(r.cell.transform.ref),e.changed=!0),r}function Po(){}const Io=[[function(e,t){return(n,i)=>!t(i)&&e.is(n.obj)}(Ls.O.Volume.Data,e=>e.currentVolume),(e,t)=>{e.currentVolume=Bo(e,t,e.hierarchy.volumes,Co,t)},e=>e.currentVolume=void 0],[e=>Ls.O.Volume.Lazy.is(e.obj),(e,t)=>{Bo(e,t,e.hierarchy.lazyVolumes,wo,t)},Po],[(e,t)=>!e.state.isGhost&&!!t.currentVolume&&Ls.O.Volume.Representation3D.is(e.obj),(e,t)=>(e.currentVolume&&Bo(e,t,e.currentVolume.representations,ko,t,e.currentVolume),!1),Po]];function jo(e){if(!e||!(null==e?void 0:e.parent)||!e.parent.cells.has(e.transform.ref))return!1;const{obj:t}=e;return!(!t||t===Yi.BM.Null||"ok"!==e.status&&"error"!==e.status)}function To(e){const{cell:t}=e;jo(t)||(this.changed=!0)}function Ao(e){Mo(this,this.tree.transforms.get(e))}function Mo(e,t){const{state:n}=e,i=n.state.cells.get(t.ref);if(!jo(i))return;let s,r=!1;for(const[a,l,c]of Io)if(a(i,n)){if(!1===l(n,i)){r=!0;break}s=c;break}if(r)return;const o=e.tree.children.get(t.ref);o&&o.size&&o.forEach(Ao,e),s&&s(n)}class Lo extends Wi.N{get dataState(){return this.plugin.state.data}get current(){return this.sync(!1),this.state.hierarchy}get selection(){return this.sync(!1),this.state.selection}sync(e){if(!e&&this.dataState.inUpdate)return;if(this.state.syncedTree===this.dataState.tree)return void(e&&!this.state.notified&&(this.state.notified=!0,this.behaviors.selection.next({hierarchy:this.state.hierarchy,volume:this.state.selection})));this.state.syncedTree=this.dataState.tree;const t=xo(this.plugin.state.data,this.current);if(!t.changed)return;const{hierarchy:n}=t;this.state.hierarchy=n,this.state.selection?this.state.selection=n.refs.has(this.state.selection.cell.transform.ref)?n.refs.get(this.state.selection.cell.transform.ref):n.volumes[0]:this.state.selection=n.volumes[0],e?(this.state.notified=!0,this.behaviors.selection.next({hierarchy:n,volume:this.state.selection})):this.state.notified=!1}setCurrent(e){this.state.selection=e||this.state.hierarchy.volumes[0],this.behaviors.selection.next({hierarchy:this.state.hierarchy,volume:e||this.state.hierarchy.volumes[0]})}remove(e,t){if(0===e.length)return;const n=this.plugin.state.data.build();for(const i of e)n.delete("string"==typeof i?i:i.cell.transform.ref);return n.commit({canUndo:!!t&&"Remove"})}toggleVisibility(e,t){if(0===e.length)return;const n=void 0!==t?"show"!==t:!e[0].cell.state.isHidden;for(const i of e)(0,$i.setSubtreeVisibility)(this.dataState,i.cell.transform.ref,n)}addRepresentation(e,t){var n;return this.dataState.build().to(e.cell).apply(Ni.f.Representation.VolumeRepresentation3D,vo(this.plugin,null===(n=e.cell.obj)||void 0===n?void 0:n.data,{type:t})).commit({canUndo:"Add Representation"})}constructor(e){super(),this.plugin=e,this.state={syncedTree:this.dataState.tree,notified:!1,hierarchy:So(),selection:void 0},this.behaviors={selection:this.ev.behavior({hierarchy:this.current,volume:this.selection})},this.subscribe(e.state.data.events.changed,t=>{t.inTransaction||e.behaviors.state.isAnimating.value||this.sync(!0)}),this.subscribe(e.behaviors.state.isAnimating,t=>{t||e.behaviors.state.isUpdating.value||this.sync(!0)})}}!function(e){e.getRepresentationTypes=function(e,t){var n,i;return(null===(n=null==t?void 0:t.cell.obj)||void 0===n?void 0:n.data)?e.representation.volume.registry.getApplicableTypes(null===(i=t.cell.obj)||void 0===i?void 0:i.data):e.representation.volume.registry.types}}(Lo||(Lo={}));var Eo=n(459),Do=n(34251);class No extends hr{constructor(){super(...arguments),this._getInfo=(0,ar._)((e,t,n)=>dr.infoFromAction(this.plugin,this.props.state,this.props.action,this.props.nodeRef)),this.state={plugin:this.plugin,ref:this.props.nodeRef,version:this.props.state.transforms.get(this.props.nodeRef).version,error:void 0,isInitial:!0,params:this.getInfo().initialValues,busy:!1,isCollapsed:this.props.initiallyCollapsed}}applyAction(){return Fi.a.State.ApplyAction(this.plugin,{state:this.props.state,action:this.props.action.create(this.state.params),ref:this.props.nodeRef})}getInfo(){var e;return this._getInfo(this.props.nodeRef,this.props.state.transforms.get(this.props.nodeRef).version,null===(e=this.state)||void 0===e?void 0:e.isCollapsed)}getTransformerId(){return this.props.state.transforms.get(this.props.nodeRef).transformer.id}getHeader(){return this.props.hideHeader?"none":this.props.action.definition.display}canApply(){return!this.state.error&&!this.state.busy}canAutoApply(){return!1}applyText(){return"Apply"}isUpdate(){return!1}getSourceAndTarget(){return{a:this.props.state.cells.get(this.props.nodeRef).obj}}static getDerivedStateFromProps(e,t){const n=e.state.transforms.get(e.nodeRef).version;if(e.nodeRef===t.ref&&n===t.version)return null;const i=e.state.cells.get(e.nodeRef).obj,s=e.action.definition.params?Xi.t.getDefaultValues(e.action.definition.params(i,t.plugin)):{};return{plugin:t.plugin,ref:e.nodeRef,version:n,params:s,isInitial:!0,error:void 0}}}var Fo=n(90605),Ro=n(33081);class Oo extends l.VK{defaultState(){return{header:"Volume Streaming",isCollapsed:!1,isBusy:!1,isHidden:!0,brand:{accent:"cyan",svg:Oi.Fi}}}componentDidMount(){this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,()=>{this.setState({isHidden:!this.canEnable(),description:rr.getSelectedStructuresDescription(this.plugin)})}),this.subscribe(this.plugin.state.events.cell.stateUpdated,e=>{Yi.Cn.hasTag(e.cell.transform,Es.h.RootTag)&&this.forceUpdate()}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e})})}get pivot(){return this.plugin.managers.structure.hierarchy.selection.structures[0]}canEnable(){var e,t;const{selection:n}=this.plugin.managers.structure.hierarchy;if(1!==n.structures.length)return!1;const i=this.pivot.cell;return!!i.obj&&!!(null===(t=(e=Eo.p3.definition).isApplicable)||void 0===t?void 0:t.call(e,i.obj,i.transform,this.plugin))}renderEnable(){var e,t;const n=this.pivot;if(!n.cell.parent)return null;const i=Yi.QX.findTagInSubtree(n.cell.parent.tree,this.pivot.cell.transform.ref,Es.h.RootTag),s=i&&n.cell.parent.cells.get(i),r=s&&"error"===s.status?{header:s.errorText&&(null===(e=s.errorText)||void 0===e?void 0:e.includes("404"))?"No Density Data Available":"Error Enabling",icon:Oi.Bw,title:s.errorText}:s&&0===(null===(t=s.obj)||void 0===t?void 0:t.data.entries.length)?{header:"Error Enabling",icon:Oi.Bw,title:"No Entry for Streaming Found"}:{header:"Enable",icon:Oi.Xq,title:"Enable"};return(0,o.jsx)(No,{state:n.cell.parent,action:Eo.p3,initiallyCollapsed:!0,nodeRef:n.cell.transform.ref,simpleApply:r})}renderParams(){var e,t,n,i,s;const r=this.pivot;if(!r.cell.parent)return null;const a="selection-box"===(null===(t=null===(e=r.volumeStreaming)||void 0===e?void 0:e.cell.transform.params)||void 0===t?void 0:t.entry.params.view.name)&&(null===(s=null===(i=null===(n=this.plugin.state.behaviors.cells.get(Gr.FocusLoci.id))||void 0===n?void 0:n.params)||void 0===i?void 0:i.values)||void 0===s?void 0:s.bindings);return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(pr,{state:r.cell.parent,transform:r.volumeStreaming.cell.transform,customHeader:"none",noMargin:!0}),a&&(0,o.jsx)(Ri.Yj,{header:"Controls Help",children:(0,o.jsx)(qr,{bindings:a})})]})}renderControls(){const e=this.pivot;return e?e.volumeStreaming?this.renderParams():this.renderEnable():null}}class zo extends l.VK{constructor(){super(...arguments),this.item=e=>{var t;const n=this.plugin.managers.volume.hierarchy.selection,i=(null===(t=e.cell.obj)||void 0===t?void 0:t.label)||"Volume";return{kind:"item",label:("lazy-volume"===e.kind?"Load ":"")+(i||e.kind),selected:n===e,value:e}},this.selectCurrent=e=>{if(this.toggleHierarchy(),!e)return;const t=e.value;"volume"===t.kind?this.plugin.managers.volume.hierarchy.setCurrent(t):this.lazyLoad(t.cell)},this.selectAdd=e=>{e&&(this.setState({show:void 0}),e.value())},this.toggleHierarchy=()=>this.setState({show:"hierarchy"!==this.state.show?"hierarchy":void 0}),this.toggleAddRepr=()=>this.setState({show:"add-repr"!==this.state.show?"add-repr":void 0}),this.toggleVisibility=()=>{var e,t;const n=this.plugin.managers.volume.hierarchy,{current:i}=n,s=!(null===(t=null===(e=i.volumes[0])||void 0===e?void 0:e.representations[0])||void 0===t?void 0:t.cell.state.isHidden);this.plugin.managers.volume.hierarchy.toggleVisibility(i.volumes.flatMap(e=>e.representations),s?"hide":"show")}}defaultState(){return{header:"Volume",isCollapsed:!1,isBusy:!1,isHidden:!0,brand:{accent:"purple",svg:Oi.Fi}}}componentDidMount(){this.subscribe(this.plugin.managers.volume.hierarchy.behaviors.selection,e=>{this.setState({isHidden:0===e.hierarchy.volumes.length&&0===e.hierarchy.lazyVolumes.length})}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e})})}get hierarchyItems(){const e=this.plugin.managers.volume.hierarchy,{current:t}=e,n=[];for(const i of t.volumes)n.push(this.item(i));for(const i of t.lazyVolumes)n.push(this.item(i));return n}get addActions(){const e=this.plugin.managers.volume.hierarchy,t=e.selection,n=[...Lo.getRepresentationTypes(this.plugin,t).map(n=>or.W.Item(n[1],()=>e.addRepresentation(t,n[0])))];return n}get isEmpty(){const{volumes:e,lazyVolumes:t}=this.plugin.managers.volume.hierarchy.current;return 0===e.length&&0===t.length}get label(){var e;if(this.state.loadingLabel)return`Loading ${this.state.loadingLabel}...`;const t=this.plugin.managers.volume.hierarchy.selection;return t?(null===(e=null==t?void 0:t.cell.obj)||void 0===e?void 0:e.label)||"Volume":"Nothing Selected"}async lazyLoad(e){const{url:t,isBinary:n,format:i,entryId:s,isovalues:r}=e.obj.data;this.setState({isBusy:!0,loadingLabel:e.obj.label});try{const o=this.plugin;await o.dataTransaction(async()=>{var a,l,c,u;const d=await o.builders.data.download({url:t,isBinary:n},{state:{isGhost:!0}}),h=await o.dataFormats.get(i).parse(o,d,{entryId:s}),p=h.volume||h.volumes[0];if(!(null==p?void 0:p.isOk))throw new Error("Failed to parse any volume.");const m=o.build();for(const e of r)m.to(null!==(c=null===(a=h.volumes)||void 0===a?void 0:a[null!==(l=e.volumeIndex)&&void 0!==l?l:0])&&void 0!==c?c:h.volume).apply(Ni.f.Representation.VolumeRepresentation3D,vo(this.plugin,p.data,{type:"isosurface",typeParams:{alpha:null!==(u=e.alpha)&&void 0!==u?u:1,isoValue:"absolute"===e.type?{kind:"absolute",absoluteValue:e.value}:{kind:"relative",relativeValue:e.value}},color:"uniform",colorParams:{value:e.color}}));await m.commit(),await o.build().delete(e).commit()})}finally{this.setState({isBusy:!1,loadingLabel:void 0})}}renderControls(){const e=this.state.isBusy||this.isEmpty,t=this.label,n=this.plugin.managers.volume.hierarchy.selection,i=this.plugin.managers.volume.hierarchy,{current:s}=i;return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"msp-flex-row",style:{marginTop:"1px"},children:[(0,o.jsx)(Ri.$n,{noOverflow:!0,flex:!0,onClick:this.toggleHierarchy,disabled:e,title:t,children:t}),!this.isEmpty&&n&&(0,o.jsx)(Ri.K0,{svg:Oi.CR,onClick:this.toggleAddRepr,title:"Apply a structure presets to the current hierarchy.",toggleState:"add-repr"===this.state.show,disabled:e}),!this.isEmpty&&(0,o.jsx)(Ri.K0,{svg:Oi.zs,onClick:this.toggleVisibility,toggleState:!1,title:"Toggle visibility of all volumes.",disabled:e})]}),"hierarchy"===this.state.show&&(0,o.jsx)(or.W,{items:this.hierarchyItems,onSelect:this.selectCurrent}),"add-repr"===this.state.show&&(0,o.jsx)(or.W,{items:this.addActions,onSelect:this.selectAdd}),s.volumes.length>0&&(0,o.jsx)("div",{style:{marginTop:"6px"},children:s.volumes.map(e=>(0,o.jsx)(Ho,{volume:e},e.cell.transform.ref))})]})}}function Ho({volume:e}){var t,n;return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("div",{className:"msp-control-group-header",style:{marginTop:"1px"},children:(0,o.jsx)("div",{children:(0,o.jsx)("b",{children:null!==(n=null===(t=e.cell.obj)||void 0===t?void 0:t.label)&&void 0!==n?n:"n/a"})})}),e.representations.map(t=>(0,o.jsx)(Uo,{volume:e,representation:t},t.cell.transform.ref))]})}class Uo extends l.jB{constructor(){super(...arguments),this.state={action:void 0},this.updateIsoValueEvent=new Fo.B,this.remove=()=>this.plugin.managers.volume.hierarchy.remove([this.props.representation],!0),this.toggleVisible=e=>{e.preventDefault(),e.currentTarget.blur(),this.plugin.managers.volume.hierarchy.toggleVisibility([this.props.representation])},this.toggleColor=()=>{this.setState({action:"select-color"===this.state.action?void 0:"select-color"})},this.toggleUpdate=()=>this.setState({action:"update"===this.state.action?void 0:"update"}),this.highlight=e=>{e.preventDefault(),this.props.representation.cell.parent&&Fi.a.Interactivity.Object.Highlight(this.plugin,{state:this.props.representation.cell.parent,ref:this.props.representation.cell.transform.ref})},this.clearHighlight=e=>{e.preventDefault(),Fi.a.Interactivity.ClearHighlights(this.plugin)},this.focus=()=>{var e;const t=this.props.representation,n=null===(e=t.cell.obj)||void 0===e?void 0:e.data.repr.getAllLoci();t.cell.state.isHidden&&this.plugin.managers.volume.hierarchy.toggleVisibility([this.props.representation],"show"),n&&this.plugin.managers.camera.focusLoci(n,{extraRadius:1})},this.updateColor=({value:e})=>{const t=this.props.representation.cell.transform;return this.plugin.build().to(t.ref).update({...t.params,colorTheme:{name:"uniform",params:{value:e}}}).commit()},this.requestIsoValueUpdate=e=>{this.updateIsoValueEvent.next(e)},this.updateIsoValue=e=>{var t,n;const i=this.props.representation.cell.transform;return this.plugin.build().to(i.ref).update({...i.params,type:{...null===(t=i.params)||void 0===t?void 0:t.type,params:{...null===(n=i.params)||void 0===n?void 0:n.type.params,isoValue:e.isoValue}}}).commit()},this.isoValueParams=(0,ar._)((e,t)=>{var n,i;const s=this.props.representation.cell.transform.params;if("isosurface"===(null==s?void 0:s.type.name))return{isoValue:yo.f.createIsoValueParam(s.type.params.isoValue,null===(i=null===(n=this.props.volume.cell.obj)||void 0===n?void 0:n.data.grid)||void 0===i?void 0:i.stats)}})}componentDidMount(){this.subscribe(this.plugin.state.events.cell.stateUpdated,e=>{Yi.Uw.ObjectEvent.isCell(e,this.props.representation.cell)&&this.forceUpdate()}),this.subscribe(this.updateIsoValueEvent.pipe((0,Ro.c)(100,void 0,{leading:!1,trailing:!0})),this.updateIsoValue)}get color(){var e,t;const n=this.props.representation.cell;if("uniform"===(null===(e=n.transform.params)||void 0===e?void 0:e.colorTheme.name))return null===(t=n.transform.params)||void 0===t?void 0:t.colorTheme.params.value}get isIsoSurface(){var e;return"isosurface"===(null===(e=this.props.representation.cell.transform.params)||void 0===e?void 0:e.type.name)}render(){var e,t,n;const i=this.props.representation.cell,s=i.transform.params,r=this.color,a=this.isoValueParams(i.transform.ref,null==s?void 0:s.type.name);return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"msp-flex-row",children:[void 0!==r&&(0,o.jsx)(Ri.$n,{style:{backgroundColor:es.Q1.toStyle(r),minWidth:32,width:32},onClick:this.toggleColor}),(0,o.jsxs)(Ri.$n,{noOverflow:!0,className:"msp-control-button-label",title:`${null===(e=i.obj)||void 0===e?void 0:e.label}. Click to focus.`,onClick:this.focus,onMouseEnter:this.highlight,onMouseLeave:this.clearHighlight,style:{textAlign:"left"},children:[null===(t=i.obj)||void 0===t?void 0:t.label,(0,o.jsx)("small",{className:"msp-25-lower-contrast-text",style:{float:"right"},children:null===(n=i.obj)||void 0===n?void 0:n.description})]}),(0,o.jsx)(Ri.K0,{svg:i.state.isHidden?Oi.qF:Oi.zs,toggleState:!1,onClick:this.toggleVisible,title:(i.state.isHidden?"Show":"Hide")+" component",small:!0,className:"msp-form-control",flex:!0}),(0,o.jsx)(Ri.K0,{svg:Oi.mf,onClick:this.remove,title:"Remove",small:!0}),(0,o.jsx)(Ri.K0,{svg:Oi.cv,onClick:this.toggleUpdate,title:"Actions",toggleState:"update"===this.state.action})]}),"update"===this.state.action&&!!i.parent&&(0,o.jsx)("div",{style:{marginBottom:"6px"},className:"msp-accent-offset",children:(0,o.jsxs)("div",{children:[!!a&&(0,o.jsx)("div",{style:{marginBottom:"1px"},children:(0,o.jsx)(zi.y1,{params:a,values:{isoValue:null==s?void 0:s.type.params.isoValue},onChangeValues:this.requestIsoValueUpdate})}),(0,o.jsx)(pr,{state:i.parent,transform:i.transform,customHeader:"none",noMargin:!0})]})}),"select-color"===this.state.action&&void 0!==r&&(0,o.jsx)("div",{style:{marginBottom:"6px",marginTop:1},className:"msp-accent-offset",children:(0,o.jsx)(Ri.tW,{header:"Select Color",initialExpanded:!0,hideExpander:!0,hideOffset:!0,onHeaderClick:this.toggleColor,topRightIcon:Oi.X6,noTopMargin:!0,childrenClassName:"msp-viewport-controls-panel-controls",children:(0,o.jsx)(Do.cq,{param:Vo,value:this.color,onChange:this.updateColor,name:"color",hideNameRow:!0})})})]})}}const Vo=Xi.t.Color((0,es.Q1)(1184274));var _o,Go=n(73868),qo=n(61217),$o=n(95156),Zo=n(93273);function Ko(e,t){if(Math.abs(e)>Math.abs(t)){const n=t/e;return Math.abs(e)*Math.sqrt(1+n*n)}if(0!==t){const n=e/t;return Math.abs(t)*Math.sqrt(1+n*n)}return 0}!function(e){e.createCache=function(e){return{size:e,matrix:Zo.u.create(e,e),eigenValues:new Float64Array(e),D:new Float64Array(e),E:new Float64Array(e)}},e.compute=function(e){!function(e,t,n,i,s){for(let o=0;o<e;o++)s[o]=0;const r=e-1;for(let o=0;o<e;o++)i[o]=t[o*e+r];(function(e,t,n,i){for(let s=i-1;s>0;s--){let r=0,o=0;for(let e=0;e<s;e++)r+=Math.abs(t[e]);if(0===r){n[s]=t[s-1];for(let n=0;n<s;n++)t[n]=e[n*i+s-1],e[n*i+s]=0,e[s*i+n]=0}else{for(let e=0;e<s;e++)t[e]/=r,o+=t[e]*t[e];let a=t[s-1],l=Math.sqrt(o);a>0&&(l=-l),n[s]=r*l,o-=a*l,t[s-1]=a-l;for(let e=0;e<s;e++)n[e]=0;for(let r=0;r<s;r++){a=t[r],e[s*i+r]=a,l=n[r]+e[r*i+r]*a;for(let o=r+1;o<=s-1;o++)l+=e[r*i+o]*t[o],n[o]+=e[r*i+o]*a;n[r]=l}a=0;for(let e=0;e<s;e++)n[e]/=o,a+=n[e]*t[e];const c=a/(o+o);for(let e=0;e<s;e++)n[e]-=c*t[e];for(let r=0;r<s;r++){a=t[r],l=n[r];for(let o=r;o<=s-1;o++)e[r*i+o]-=a*n[o]+l*t[o];t[r]=e[r*i+s-1],e[r*i+s]=0}}t[s]=o}for(let s=0;s<i-1;s++){e[s*i+i-1]=e[s*i+s],e[s*i+s]=1;const n=t[s+1];if(0!==n){for(let r=0;r<=s;r++)t[r]=e[(s+1)*i+r]/n;for(let n=0;n<=s;n++){let r=0;for(let t=0;t<=s;t++)r+=e[(s+1)*i+t]*e[n*i+t];for(let o=0;o<=s;o++)e[n*i+o]-=r*t[o]}}for(let t=0;t<=s;t++)e[(s+1)*i+t]=0}for(let s=0;s<i;s++)t[s]=e[s*i+i-1],e[s*i+i-1]=0;e[i*i-1]=1,n[0]=0})(t,i,s,e),function(e,t,n,i){const s=1e3;for(let l=1;l<i;l++)n[l-1]=n[l];n[i-1]=0;let r=0,o=0;const a=Math.pow(2,-53);for(let l=0;l<i;l++){o=Math.max(o,Math.abs(t[l])+Math.abs(n[l]));let c=l;for(;c<i&&!(Math.abs(n[c])<=a*o);)c++;if(c>l){let u=0;do{u+=1;let o=t[l],a=(t[l+1]-o)/(2*n[l]),d=Ko(a,1);a<0&&(d=-d),t[l]=n[l]/(a+d),t[l+1]=n[l]*(a+d);const h=t[l+1];let p=o-t[l];for(let e=l+2;e<i;e++)t[e]-=p;r+=p,a=t[c];let m=1,f=m,g=m;const y=n[l+1];let v=0,b=0;for(let s=c-1;s>=l;s--){g=f,f=m,b=v,o=m*n[s],p=m*a,d=Ko(a,n[s]),n[s+1]=v*d,v=n[s]/d,m=a/d,a=m*t[s]-v*o,t[s+1]=p+v*(m*o+v*t[s]);for(let t=0;t<i;t++)p=e[(s+1)*i+t],e[(s+1)*i+t]=v*e[s*i+t]+m*p,e[s*i+t]=m*e[s*i+t]-v*p}if(a=-v*b*g*y*n[l]/h,n[l]=v*a,t[l]=m*a,u>=s)throw new Error("SVD: Not converging.")}while(Math.abs(n[l])>a*o)}t[l]=t[l]+r,n[l]=0}for(let l=0;l<i-1;l++){let n=l,s=t[l];for(let e=l+1;e<i;e++)t[e]<s&&(n=e,s=t[e]);if(n!==l){t[n]=t[l],t[l]=s;for(let t=0;t<i;t++)s=e[l*i+t],e[l*i+t]=e[n*i+t],e[n*i+t]=s}}}(t,i,s,e);for(let o=0;o<e;o++)n[o]=i[o]}(e.size,e.matrix.data,e.eigenValues,e.D,e.E)}}(_o||(_o={}));var Qo,Xo=n(33565),Wo=n(46291);!function(e){let t;!function(e){e.empty=function(e){return{x:new Float64Array(e),y:new Float64Array(e),z:new Float64Array(e)}}}(t=e.Positions||(e.Positions={})),e.compute=function(e,t){return null!=t||(t={bTransform:$o.$.zero(),rmsd:0,nAlignedElements:0}),function(e){const t=function(e){const t=e.evdCache.matrix;Zo.u.makeZero(t);const n=e.a.x,i=e.a.y,s=e.a.z,r=e.b.x,o=e.b.y,a=e.b.z,l=e.centerA,c=e.centerB;let u=0;const d=Math.min(e.a.x.length,e.b.x.length);for(let h=0;h<d;h++){const e=n[h]-l[0],d=i[h]-l[1],p=s[h]-l[2],m=r[h]-c[0],f=o[h]-c[1],g=a[h]-c[2];u+=e*e+d*d+p*p+m*m+f*f+g*g,Zo.u.add(t,0,0,e*m+d*f+p*g),Zo.u.add(t,0,1,-p*f+d*g),Zo.u.add(t,0,2,p*m-e*g),Zo.u.add(t,0,3,-d*m+e*f),Zo.u.add(t,1,0,-p*f+d*g),Zo.u.add(t,1,1,e*m-d*f-p*g),Zo.u.add(t,1,2,d*m+e*f),Zo.u.add(t,1,3,p*m+e*g),Zo.u.add(t,2,0,p*m-e*g),Zo.u.add(t,2,1,d*m+e*f),Zo.u.add(t,2,2,-e*m+d*f-p*g),Zo.u.add(t,2,3,p*f+d*g),Zo.u.add(t,3,0,-d*m+e*f),Zo.u.add(t,3,1,p*m+e*g),Zo.u.add(t,3,2,p*f+d*g),Zo.u.add(t,3,3,-e*m-d*f+p*g)}return u}(e);_o.compute(e.evdCache);let n=t-2*e.evdCache.eigenValues[3];n=n<0?0:Math.sqrt(n/e.a.x.length),function(e){const t=e.evdCache.matrix,n=Zo.u.get(t,1,3),i=Zo.u.get(t,2,3),s=Zo.u.get(t,3,3),r=Zo.u.get(t,0,3),o=2*i*i,a=2*s*s,l=2*n*n,c=2*n*i,u=2*r*s,d=2*n*s,h=2*r*i,p=2*i*s,m=2*r*n;let f=e.translateB;$o.$.setValue(f,0,3,-e.centerB[0]),$o.$.setValue(f,1,3,-e.centerB[1]),$o.$.setValue(f,2,3,-e.centerB[2]),f=e.rotateB,$o.$.setValue(f,0,0,1-o-a),$o.$.setValue(f,0,1,c+u),$o.$.setValue(f,0,2,d-h),$o.$.setValue(f,1,0,c-u),$o.$.setValue(f,1,1,1-l-a),$o.$.setValue(f,1,2,p+m),$o.$.setValue(f,2,0,d+h),$o.$.setValue(f,2,1,p-m),$o.$.setValue(f,2,2,1-l-o),$o.$.setValue(f,3,3,1),$o.$.mul(e.tempMatrix,e.rotateB,e.translateB),f=e.translateB,$o.$.setValue(f,0,3,e.centerA[0]),$o.$.setValue(f,1,3,e.centerA[1]),$o.$.setValue(f,2,3,e.centerA[2]),$o.$.mul(e.result.bTransform,e.translateB,e.tempMatrix)}(e),e.result.rmsd=n,e.result.nAlignedElements=e.a.x.length}(new Yo(e,t)),t}}(Qo||(Qo={}));class Yo{constructor(e,t){this.evdCache=_o.createCache(4),this.translateB=$o.$.identity(),this.rotateB=$o.$.identity(),this.tempMatrix=$o.$.identity(),this.a=e.a,this.b=e.b,e.centerA?this.centerA=e.centerA:this.centerA=e.centerA=Xo.p.fromArrays(e.a,(0,Wo.f)()).center,e.centerB?this.centerB=e.centerB:this.centerB=e.centerB=Xo.p.fromArrays(e.b,(0,Wo.f)()).center,this.result=t}}var Jo=n(21547),ea=n(77936);const ta=[[4,0,-2,-1,-2,0,-2,-1,-1,-1,-1,-2,-1,-1,-1,1,0,0,-3,-2],[0,9,-3,-4,-2,-3,-3,-1,-3,-1,-1,-3,-3,-3,-3,-1,-1,-1,-2,-2],[-2,-3,6,2,-3,-1,-1,-3,-1,-4,-3,1,-1,0,-2,0,-1,-3,-4,-3],[-1,-4,2,5,-3,-2,0,-3,1,-3,-2,0,-1,2,0,0,-1,-2,-3,-2],[-2,-2,-3,-3,6,-3,-1,0,-3,0,0,-3,-4,-3,-3,-2,-2,-1,1,3],[0,-3,-1,-2,-3,6,-2,-4,-2,-4,-3,0,-2,-2,-2,0,-2,-3,-2,-3],[-2,-3,-1,0,-1,-2,8,-3,-1,-3,-2,1,-2,0,0,-1,-2,-3,-2,2],[-1,-1,-3,-3,0,-4,-3,4,-3,2,1,-3,-3,-3,-3,-2,-1,3,-3,-1],[-1,-3,-1,1,-3,-2,-1,-3,5,-2,-1,0,-1,1,2,0,-1,-2,-3,-2],[-1,-1,-4,-3,0,-4,-3,2,-2,4,2,-3,-3,-2,-2,-2,-1,1,-2,-1],[-1,-1,-3,-2,0,-3,-2,1,-1,2,5,-2,-2,0,-1,-1,-1,1,-1,-1],[-2,-3,1,0,-3,0,1,-3,0,-3,-2,6,-2,0,0,1,0,-3,-4,-2],[-1,-3,-1,-1,-4,-2,-2,-3,-1,-3,-2,-2,7,-1,-2,-1,-1,-2,-4,-3],[-1,-3,0,2,-3,-2,0,-3,1,-2,0,0,-1,5,1,0,-1,-2,-2,-1],[-1,-3,-2,0,-3,-2,0,-3,2,-2,-1,0,-2,1,5,-1,-1,-3,-3,-2],[1,-1,0,0,-2,0,-1,-2,0,-2,-1,1,-1,0,-1,4,1,-2,-3,-2],[0,-1,-1,-1,-2,-2,-2,-1,-1,-1,-1,0,-1,-1,-1,1,5,0,-2,-2],[0,-1,-3,-2,-1,-3,-3,3,-2,1,1,-3,-2,-2,-3,-2,0,4,-3,-1],[-3,-2,-4,-3,1,-2,-2,-3,-3,-2,-1,-4,-4,-2,-3,-3,-2,-3,11,2],[-2,-2,-3,-2,3,-3,2,-1,-2,-1,-1,-2,-3,-1,-2,-2,-2,-1,2,7]];function na(e,t){let n,i=0;const s={};return t.forEach(t=>{n=0;const r={};t.forEach(t=>r[e[n++]]=t),s[e[i++]]=r}),s}const ia={blosum62:na("ARNDCQEGHILKMFPSTWYVBZX",[[4,-1,-2,-2,0,-1,-1,0,-2,-1,-1,-1,-1,-2,-1,1,0,-3,-2,0,-2,-1,0],[-1,5,0,-2,-3,1,0,-2,0,-3,-2,2,-1,-3,-2,-1,-1,-3,-2,-3,-1,0,-1],[-2,0,6,1,-3,0,0,0,1,-3,-3,0,-2,-3,-2,1,0,-4,-2,-3,3,0,-1],[-2,-2,1,6,-3,0,2,-1,-1,-3,-4,-1,-3,-3,-1,0,-1,-4,-3,-3,4,1,-1],[0,-3,-3,-3,9,-3,-4,-3,-3,-1,-1,-3,-1,-2,-3,-1,-1,-2,-2,-1,-3,-3,-2],[-1,1,0,0,-3,5,2,-2,0,-3,-2,1,0,-3,-1,0,-1,-2,-1,-2,0,3,-1],[-1,0,0,2,-4,2,5,-2,0,-3,-3,1,-2,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-2,0,-1,-3,-2,-2,6,-2,-4,-4,-2,-3,-3,-2,0,-2,-2,-3,-3,-1,-2,-1],[-2,0,1,-1,-3,0,0,-2,8,-3,-3,-1,-2,-1,-2,-1,-2,-2,2,-3,0,0,-1],[-1,-3,-3,-3,-1,-3,-3,-4,-3,4,2,-3,1,0,-3,-2,-1,-3,-1,3,-3,-3,-1],[-1,-2,-3,-4,-1,-2,-3,-4,-3,2,4,-2,2,0,-3,-2,-1,-2,-1,1,-4,-3,-1],[-1,2,0,-1,-3,1,1,-2,-1,-3,-2,5,-1,-3,-1,0,-1,-3,-2,-2,0,1,-1],[-1,-1,-2,-3,-1,0,-2,-3,-2,1,2,-1,5,0,-2,-1,-1,-1,-1,1,-3,-1,-1],[-2,-3,-3,-3,-2,-3,-3,-3,-1,0,0,-3,0,6,-4,-2,-2,1,3,-1,-3,-3,-1],[-1,-2,-2,-1,-3,-1,-1,-2,-2,-3,-3,-1,-2,-4,7,-1,-1,-4,-3,-2,-2,-1,-2],[1,-1,1,0,-1,0,0,0,-1,-2,-2,0,-1,-2,-1,4,1,-3,-2,-2,0,0,0],[0,-1,0,-1,-1,-1,-1,-2,-2,-1,-1,-1,-1,-2,-1,1,5,-2,-2,0,-1,-1,0],[-3,-3,-4,-4,-2,-2,-3,-2,-2,-3,-2,-3,-1,1,-4,-3,-2,11,2,-3,-4,-3,-2],[-2,-2,-2,-3,-2,-1,-2,-3,2,-1,-1,-2,-1,3,-3,-2,-2,2,7,-1,-3,-2,-1],[0,-3,-3,-3,-1,-2,-2,-3,-3,3,1,-2,1,-1,-2,-2,0,-3,-1,4,-3,-2,-1],[-2,-1,3,4,-3,0,1,-1,0,-3,-4,0,-3,-3,-2,0,-1,-4,-3,-3,4,1,-1],[-1,0,0,1,-3,3,4,-2,0,-3,-3,1,-1,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-1,-1,-1,-2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,0,0,-2,-1,-1,-1,-1,-1]]),blosum62x:na("ACDEFGHIKLMNPQRSTVWY",ta)},sa={gapPenalty:-11,gapExtensionPenalty:-1,substMatrix:"default"};class ra{constructor(e,t,n){this.seqA=e,this.seqB=t,this.S=[],this.V=[],this.H=[],this.gapPenalty=n.gapPenalty,this.gapExtensionPenalty=n.gapExtensionPenalty,this.substMatrix="default"===n.substMatrix?void 0:ia[n.substMatrix],this.n=this.seqA.length,this.m=this.seqB.length}initMatrices(){const{n:e,m:t,gapPenalty:n,S:i,V:s,H:r}=this;for(let o=0;o<=e;++o){i[o]=[],s[o]=[],r[o]=[];for(let e=0;e<=t;++e)i[o][e]=0,s[o][e]=0,r[o][e]=0}for(let o=0;o<=e;++o)i[o][0]=n,r[o][0]=-1/0;for(let o=0;o<=t;++o)i[0][o]=n,s[0][o]=-1/0;i[0][0]=0}makeScoreFn(){const{seqA:e,seqB:t,substMatrix:n}=this;return n?function(i,s){var r,o;const a=e[i],l=t[s];return null!==(o=null===(r=n[a])||void 0===r?void 0:r[l])&&void 0!==o?o:-4}:function(n,i){return e[n]===t[i]?5:-3}}calculate(){this.initMatrices();const e=this.makeScoreFn(),{V:t,H:n,S:i,n:s,m:r,gapExtensionPenalty:o,gapPenalty:a}=this;let l,c,u,d,h;for(let p=1;p<=s;++p){c=i[p-1],l=t[p-1],u=t[p],d=n[p],h=i[p];for(let t=1;t<=r;++t)u[t]=Math.max(c[t]+a,l[t]+o),d[t]=Math.max(h[t-1]+a,d[t-1]+o),h[t]=Math.max(c[t-1]+e(p-1,t-1),u[t],d[t])}}trace(){const e=this.makeScoreFn(),{V:t,H:n,S:i,seqA:s,seqB:r,gapExtensionPenalty:o,gapPenalty:a}=this;let l,c,u=this.n,d=this.m,h="",p="";for(i[u][d]>=t[u][d]?(l="S",c=i[u][d]):t[u][d]>=n[u][d]?(l="V",c=t[u][d]):(l="H",c=n[u][d]);u>0&&d>0;)"S"===l?i[u][d]===i[u-1][d-1]+e(u-1,d-1)?(h=s[u-1]+h,p=r[d-1]+p,--u,--d,l="S"):i[u][d]===t[u][d]?l="V":i[u][d]===n[u][d]?l="H":(--u,--d):"V"===l?t[u][d]===t[u-1][d]+o?(h=s[u-1]+h,p="-"+p,--u,l="V"):t[u][d]===i[u-1][d]+a?(h=s[u-1]+h,p="-"+p,--u,l="S"):--u:"H"===l&&(n[u][d]===n[u][d-1]+o?(h="-"+h,p=r[d-1]+p,--d,l="H"):n[u][d]===i[u][d-1]+a?(h="-"+h,p=r[d-1]+p,--d,l="S"):--d);for(;u>0;)h=s[u-1]+h,p="-"+p,--u;for(;d>0;)h="-"+h,p=r[d-1]+p,--d;return{aliA:h,aliB:p,score:c}}}var oa;function aa(e){return e.model.sequence.byEntityKey[function(e){switch(e.kind){case ea.Nf.Kind.Atomic:return e.model.atomicHierarchy.index.getEntityFromChain(e.chainIndex[e.elements[0]]);case ea.Nf.Kind.Spheres:return e.model.coarseHierarchy.spheres.entityKey[e.elements[0]];case ea.Nf.Kind.Gaussians:return e.model.coarseHierarchy.gaussians.entityKey[e.elements[0]]}}(e)].sequence}!function(e){function t(e){const t=new Map;if(ea.Nf.isAtomic(e.unit)){const{label_seq_id:n}=e.unit.model.atomicHierarchy.residues,{residueIndex:i}=e.unit;for(let s=0,r=ho.CD.size(e.indices);s<r;++s){const r=ho.CD.getAt(e.indices,s),o=e.unit.elements[r],a=n.value(i[o]);t.has(a)?t.get(a).push(r):t.set(a,[r])}}else if(ea.Nf.isCoarse(e.unit)){const{seq_id_begin:n}=ea.Nf.isSpheres(e.unit)?e.unit.model.coarseHierarchy.spheres:e.unit.model.coarseHierarchy.gaussians;for(let i=0,s=ho.CD.size(e.indices);i<s;++i){const s=ho.CD.getAt(e.indices,i),r=e.unit.elements[s],o=n.value(r);t.set(o,[s])}}return t}e.createSeqIdIndicesMap=t,e.compute=function(e,n={}){const i=aa(e.a.unit),s=aa(e.b.unit),r=t(e.a),o=t(e.b),a=[],l=[],{aliA:c,aliB:u,score:d}=function(e,t,n={}){const i={...sa,...n},s=new ra(e,t,i);return s.calculate(),s.trace()}(i.code.toArray(),s.code.toArray(),n);let h=0,p=0;for(let t=0,g=c.length;t<g;++t){if("-"===c[t]||"-"===u[t]){"-"!==c[t]&&(h+=1),"-"!==u[t]&&(p+=1);continue}const e=i.seqId.value(h),n=s.seqId.value(p);if(r.has(e)&&o.has(n)){const t=r.get(e),i=o.get(n);for(let e=0,n=Math.min(t.length,i.length);e<n;++e)a.push(t[e]),l.push(i[e])}h+=1,p+=1}const m=ho.CD.intersect(ho.CD.ofSortedArray(a),e.a.indices),f=ho.CD.intersect(ho.CD.ofSortedArray(l),e.b.indices);return{a:{unit:e.a.unit,indices:m},b:{unit:e.b.unit,indices:f},score:d}}}(oa||(oa={}));var la=n(64059);function ca(e){const t=[];if(e.length<=0)return t;const n=function(e){if(0===e.length)return 0;let t=Jo.i.Loci.size(e[0]);for(let n=1;n<e.length;n++){const i=Jo.i.Loci.size(e[n]);i<t&&(t=i)}return t}(e),i={a:da(e[0],n),b:da(e[1],n)};t[0]=Qo.compute(i);for(let s=2;s<e.length;s++)i.b=da(e[s],n),i.centerB=void 0,t.push(Qo.compute(i));return t}const ua=/(polypeptide|cyclic-pseudo-peptide)/i;function da(e,t){const n=Qo.Positions.empty(t);let i=0;for(const s of e.elements){const{unit:e,indices:r}=s,{elements:o,conformation:a}=e;for(let s=0,l=ho.CD.size(r);s<l;s++){const e=o[ho.CD.getAt(r,s)];if(n.x[i]=a.x(e),n.y[i]=a.y(e),n.z[i]=a.z(e),i++,i>=t)break}if(i>=t)break}return n}var ha=n(69926);function pa(e,t){var n,i;const s=new Map;for(let u=0;u<e.length;u++)ga(e[u],s,u,null===(n=null==t?void 0:t.traceOnly)||void 0===n||n,null!==(i=null==t?void 0:t.includeResidueTest)&&void 0!==i?i:fa);const r=Array.from(s.values()),o=function(e,t){const n=[];for(let s=0;s<e;s++){n[s]=[];for(let t=0;t<e;t++)n[s][t]=0}for(const{pivots:s}of t)for(let t=0;t<e;t++){if(!s[t])continue;const i=s[t][2]-s[t][1];for(let r=t+1;r<e;r++){if(!s[r])continue;const e=s[r][2]-s[r][1];n[t][r]=n[t][r]+Math.min(i,e)}}const i=[];for(let s=1;s<e;s++)i[s-1]={i:0,j:s,count:n[0][s]};return i}(e.length,r),a=[],l=[],c=[];for(const u of o)if(0===u.count)a.push([u.i,u.j]);else{const[e,t]=ma(r,u.i,u.j,u.count),n=Qo.compute({a:e,b:t});Number.isNaN(n.rmsd)?l.push([u.i,u.j]):c.push({transform:n,pivot:u.i,other:u.j})}return{entries:c,zeroOverlapPairs:a,failedPairs:l}}function ma(e,t,n,i){const s=Qo.Positions.empty(i),r=Qo.Positions.empty(i);let o=0;for(const{pivots:a}of e){const e=a[t],i=a[n];if(!e||!i)continue;const l=Math.min(e[2]-e[1],i[2]-i[1]);for(let t=0;t<l;t++){let n=e[1]+t;s.x[o]=e[0].conformation.x(n),s.y[o]=e[0].conformation.y(n),s.z[o]=e[0].conformation.z(n),n=i[1]+t,r.x[o]=i[0].conformation.x(n),r.y[o]=i[0].conformation.y(n),r.z[o]=i[0].conformation.z(n),o++}}return[s,r]}function fa(){return!0}function ga(e,t,n,i,s){const r=Jo.i.Location.create(e);for(const o of e.units){if(o.kind!==ha.N.Kind.Atomic)continue;const{elements:e,model:a}=o;r.unit=o;const l=qo.W.Provider.get(a).value;if(!l)return;const{dbName:c,accession:u,num:d}=l,h=ho.hT.transientSegments(o.model.atomicHierarchy.chainAtomSegments,e),p=ho.hT.transientSegments(o.model.atomicHierarchy.residueAtomSegments,e),m=o.model.atomicHierarchy.derived.residue.traceElementIndex;for(;h.hasNext;){const a=h.move();for(p.setSegment(a);p.hasNext;){const a=p.move(),l=a.index;if(!c[l])continue;const h=m[l];let f,g;if(i){if(f=h,-1===f)continue;g=f+1}else f=e[a.start],g=e[a.end-1]+1;if(r.element=h>=0?h:f,!s(r,l,f,g))continue;const y=`${c[l]}-${u[l]}-${d[l]}`;if(t.has(y)){const e=t.get(y);e.pivots[n]||(e.pivots[n]=[o,f,g])}else t.set(y,{key:y,pivots:{[n]:[o,f,g]}})}}}}class ya extends l.VK{defaultState(){return{isCollapsed:!1,header:"Superposition",brand:{accent:"gray",svg:Oi.lj},isHidden:!0}}componentDidMount(){this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,e=>{this.setState({isHidden:e.structures.length<2})})}renderControls(){return(0,o.jsx)(o.Fragment,{children:(0,o.jsx)(xa,{})})}}const va={alignSequences:Xi.t.Boolean(!0,{isEssential:!0,description:"For Chain-based 3D superposition, perform a sequence alignment and use the aligned residue pairs to guide the 3D superposition."}),traceOnly:Xi.t.Boolean(!0,{description:"For Chain- and Uniprot-based 3D superposition, base superposition only on CA (and equivalent) atoms."})},ba=Xi.t.getDefaultValues(va);class xa extends l.jB{constructor(){super(...arguments),this.state={isBusy:!1,canUseDb:!1,action:void 0,options:ba},this.superposeChains=async()=>{var e,t,n;const{query:i}=this.state.options.traceOnly?os.Ou.trace:os.Ou.polymer,s=this.chainEntries,r=s.map(e=>{const t=Gi.iZ.Loci.toStructure(e.loci),n=Gi.cv.toLociWithSourceUnits(i(new Gi.cY(t)));return Gi.iZ.Loci.remap(n,this.getRootStructure(e.loci.structure))}),o=this.plugin.managers.structure.hierarchy.findStructure(null===(e=r[0])||void 0===e?void 0:e.structure),a=null===(n=null===(t=null==o?void 0:o.transform)||void 0===t?void 0:t.cell.obj)||void 0===n?void 0:n.data.coordinateSystem,l=this.state.options.alignSequences?function(e){const t=[];if(e.length<=0)return t;const n=Jo.i.Loci.getFirstLocation(e[0]),i=la.Z.entity.subtype(n).match(ua)?"blosum62":"default";for(let s=1;s<e.length;s++){const{a:n,b:r,score:o}=oa.compute({a:e[0].elements[0],b:e[s].elements[0]},{substMatrix:i}),a=Jo.i.Loci(e[0].structure,[n]),l=Jo.i.Loci(e[s].structure,[r]),c=ho.CD.size(n.indices);t.push({...Qo.compute({a:da(a,c),b:da(l,c)}),alignmentScore:o})}return t}(r):ca(r),c=s[0];for(let u=1,d=r.length;u<d;++u){const e=s[u],{bTransform:t,rmsd:n}=l[u-1];await this.transform(e.cell,t,a);const i=(0,Vr.Kq)(c.label),r=(0,Vr.Kq)(e.label);this.plugin.log.info(`Superposed [${i}] and [${r}] with RMSD ${n.toFixed(2)}.`)}await this.cameraReset()},this.superposeAtoms=async()=>{var e,t,n;const i=this.atomEntries,s=i.map(e=>Gi.iZ.Loci.remap(e.loci,this.getRootStructure(e.loci.structure))),r=ca(s),o=this.plugin.managers.structure.hierarchy.findStructure(null===(e=s[0])||void 0===e?void 0:e.structure),a=null===(n=null===(t=null==o?void 0:o.transform)||void 0===t?void 0:t.cell.obj)||void 0===n?void 0:n.data.coordinateSystem,l=i[0];for(let c=1,u=s.length;c<u;++c){const e=i[c],{bTransform:t,rmsd:n}=r[c-1];await this.transform(e.cell,t,a);const s=(0,Vr.Kq)(l.label),o=(0,Vr.Kq)(e.label),u=i[c].atoms.length;this.plugin.log.info(`Superposed ${u} ${1===u?"atom":"atoms"} of [${s}] and [${o}] with RMSD ${n.toFixed(2)}.`)}await this.cameraReset()},this.superposeDb=async()=>{var e,t,n;const i=this.plugin.managers.structure.hierarchy.behaviors.selection.value.structures,s=this.state.options.traceOnly,r=i.map(e=>{var t;return null===(t=e.cell.obj)||void 0===t?void 0:t.data}),{entries:o,failedPairs:a,zeroOverlapPairs:l}=pa(r,{traceOnly:s}),c=null===(n=null===(t=null===(e=i[0])||void 0===e?void 0:e.transform)||void 0===t?void 0:t.cell.obj)||void 0===n?void 0:n.data.coordinateSystem;let u=0;for(const h of o)await this.transform(i[h.other].cell,h.transform.bTransform,c),u+=h.transform.rmsd;u/=Math.max(o.length-1,1);const d=e=>`[${e.map(([e,t])=>`(${r[e].models[0].entryId}, ${r[t].models[0].entryId})`).join(", ")}]`;l.length&&this.plugin.log.warn(`Superposition: No UNIPROT mapping overlap between structures ${d(l)}.`),a.length&&this.plugin.log.error(`Superposition: Failed to superpose structures ${d(a)}.`),o.length&&(this.plugin.log.info(`Superposed ${o.length+1} structures with avg. RMSD ${u.toFixed(2)} .`),await this.cameraReset())},this.toggleByChains=()=>this.setState({action:"byChains"===this.state.action?void 0:"byChains"}),this.toggleByAtoms=()=>this.setState({action:"byAtoms"===this.state.action?void 0:"byAtoms"}),this.toggleOptions=()=>this.setState({action:"options"===this.state.action?void 0:"options"}),this.setOptions=e=>{this.setState({options:e})}}componentDidMount(){this.subscribe(this.selection.events.changed,()=>{this.forceUpdate()}),this.subscribe(this.selection.events.additionsHistoryUpdated,()=>{this.forceUpdate()}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{this.setState({isBusy:e})}),this.subscribe(this.plugin.managers.structure.hierarchy.behaviors.selection,e=>{this.setState({canUseDb:e.structures.every(e=>{var t;return!!(null===(t=e.cell.obj)||void 0===t?void 0:t.data)&&e.cell.obj.data.models.some(e=>qo.W.Provider.isApplicable(e))})})})}get selection(){return this.plugin.managers.structure.selection}async transform(e,t,n){const i=Yi.so.resolveAndCheck(this.plugin.state.data,e);if(!i)return;const s=this.plugin.state.data.selectQ(e=>e.byRef(i.transform.ref).subtree().withTransformer(Ni.f.Model.TransformStructureConformation))[0],r={transform:{name:"matrix",params:{data:n&&!Go.$I.isIdentity(n.matrix)?Go.$I.mul((0,Go.$I)(),n.matrix,t):t,transpose:!1}}},o=s?this.plugin.state.data.build().to(s).update(r):this.plugin.state.data.build().to(e).insert(Ni.f.Model.TransformStructureConformation,r,{tags:"SuperpositionTransform"});await this.plugin.runTask(this.plugin.state.data.updateTree(o))}getRootStructure(e){var t;const n=this.plugin.helpers.substructureParent.get(e);return null===(t=this.plugin.state.data.selectQ(e=>e.byValue(n).rootOfType(Ls.O.Molecule.Structure))[0].obj)||void 0===t?void 0:t.data}async cameraReset(){await new Promise(e=>requestAnimationFrame(e)),Fi.a.Camera.Reset(this.plugin)}highlight(e){this.plugin.managers.interactivity.lociHighlights.highlightOnly({loci:e},!1)}moveHistory(e,t){this.plugin.managers.structure.selection.modifyHistory(e,t,void 0,!0)}focusLoci(e){this.plugin.managers.camera.focusLoci(e)}lociEntry(e,t){return(0,o.jsx)("div",{className:"msp-flex-row",children:(0,o.jsx)(Ri.$n,{noOverflow:!0,title:"Click to focus. Hover to highlight.",onClick:()=>this.focusLoci(e.loci),style:{width:"auto",textAlign:"left"},onMouseEnter:()=>this.highlight(e.loci),onMouseLeave:()=>this.plugin.managers.interactivity.lociHighlights.clearHighlights(),children:(0,o.jsx)("span",{dangerouslySetInnerHTML:{__html:e.label}})})},t)}historyEntry(e,t){const n=this.plugin.managers.structure.selection.additionsHistory;return(0,o.jsxs)("div",{className:"msp-flex-row",children:[(0,o.jsxs)(Ri.$n,{noOverflow:!0,title:"Click to focus. Hover to highlight.",onClick:()=>this.focusLoci(e.loci),style:{width:"auto",textAlign:"left"},onMouseEnter:()=>this.highlight(e.loci),onMouseLeave:()=>this.plugin.managers.interactivity.lociHighlights.clearHighlights(),children:[t,". ",(0,o.jsx)("span",{dangerouslySetInnerHTML:{__html:e.label}})]}),n.length>1&&(0,o.jsx)(Ri.K0,{svg:Oi.p8,small:!0,className:"msp-form-control",onClick:()=>this.moveHistory(e,"up"),flex:"20px",title:"Move up"}),n.length>1&&(0,o.jsx)(Ri.K0,{svg:Oi.qp,small:!0,className:"msp-form-control",onClick:()=>this.moveHistory(e,"down"),flex:"20px",title:"Move down"}),(0,o.jsx)(Ri.K0,{svg:Oi.mf,small:!0,className:"msp-form-control",onClick:()=>this.plugin.managers.structure.selection.modifyHistory(e,"remove"),flex:!0,title:"Remove"})]},e.id)}atomsLociEntry(e,t){return(0,o.jsxs)("div",{children:[(0,o.jsx)("div",{className:"msp-control-group-header",children:(0,o.jsx)("div",{className:"msp-no-overflow",title:e.label,children:e.label})}),(0,o.jsx)("div",{className:"msp-control-offset",children:e.atoms.map((e,t)=>this.historyEntry(e,t))})]},t)}get chainEntries(){const e=Gi.iZ.Location.create(),t=[];return this.plugin.managers.structure.selection.entries.forEach(({selection:n},i)=>{const s=Yi.so.resolveAndCheck(this.plugin.state.data,i);if(!s||Gi.iZ.Loci.isEmpty(n))return;const r=Gi.iZ.Loci.getFirstLocation(n,e);if(n.elements.length>1||"polymer"!==Gi.ZP.entity.type(r))return;const o=Gi.iZ.Stats.ofLoci(n),a=(0,Lr.d_)(o,{countsOnly:!0}),l=(0,Lr.BB)(r,{reverse:!0,granularity:"chain"}).split("|"),c=`${a} | ${l[0]} | ${l[l.length-1]}`;t.push({loci:n,label:c,cell:s})}),t}get atomEntries(){const e=new Map,t=this.plugin.managers.structure.selection.additionsHistory;for(let i=0,s=t.length;i<s;++i){const n=t[i];if(1!==Gi.iZ.Loci.size(n.loci))continue;const s=n.loci.structure;e.has(s)?e.get(s).push(n):e.set(s,[n])}const n=[];return e.forEach((e,t)=>{const i=this.plugin.helpers.substructureParent.get(t),s=[];for(let n=0,a=e.length;n<a;++n)s.push(e[n].loci.elements[0]);const r=Gi.iZ.Loci(e[0].loci.structure,s),o=r.structure.label.split(" | ")[0];n.push({loci:r,label:o,cell:i,atoms:e})}),n}toggleHint(){return this.plugin.config.get(Mr.AB.Viewport.ShowSelectionMode)?(0,o.jsxs)(o.Fragment,{children:[" ","(toggle ",(0,o.jsx)(Wr,{inline:!0})," mode)"]}):null}addByChains(){const e=this.chainEntries;return(0,o.jsxs)(o.Fragment,{children:[e.length>0&&(0,o.jsx)("div",{className:"msp-control-offset",children:e.map((e,t)=>this.lociEntry(e,t))}),e.length<2&&(0,o.jsx)("div",{className:"msp-control-offset msp-help-text",children:(0,o.jsxs)("div",{className:"msp-help-description",children:[(0,o.jsx)(Oi.In,{svg:Oi.ml,inline:!0}),"Add 2 or more selections",this.toggleHint()," from separate structures. Selections must be limited to single polymer chains or residues therein."]})}),e.length>1&&(0,o.jsx)(Ri.$n,{title:"Superpose structures by selected chains.",className:"msp-btn-commit msp-btn-commit-on",onClick:this.superposeChains,style:{marginTop:"1px"},children:"Superpose"})]})}addByAtoms(){const e=this.atomEntries;return(0,o.jsxs)(o.Fragment,{children:[e.length>0&&(0,o.jsx)("div",{className:"msp-control-offset",children:e.map((e,t)=>this.atomsLociEntry(e,t))}),e.length<2&&(0,o.jsx)("div",{className:"msp-control-offset msp-help-text",children:(0,o.jsxs)("div",{className:"msp-help-description",children:[(0,o.jsx)(Oi.In,{svg:Oi.ml,inline:!0}),"Add 1 or more selections",this.toggleHint()," from separate structures. Selections must be limited to single atoms."]})}),e.length>1&&(0,o.jsx)(Ri.$n,{title:"Superpose structures by selected atoms.",className:"msp-btn-commit msp-btn-commit-on",onClick:this.superposeAtoms,style:{marginTop:"1px"},children:"Superpose"})]})}superposeByDbMapping(){return(0,o.jsx)(o.Fragment,{children:(0,o.jsx)(Ri.$n,{icon:Oi.$8,title:"Superpose structures using intersection of residues from SIFTS UNIPROT mapping.",className:"msp-btn msp-btn-block",onClick:this.superposeDb,style:{marginTop:"1px"},disabled:this.state.isBusy,children:"Uniprot"})})}render(){return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"msp-flex-row",children:[(0,o.jsx)(Ri.ff,{icon:Oi.$8,label:"Chains",toggle:this.toggleByChains,isSelected:"byChains"===this.state.action,disabled:this.state.isBusy}),(0,o.jsx)(Ri.ff,{icon:Oi.z7,label:"Atoms",toggle:this.toggleByAtoms,isSelected:"byAtoms"===this.state.action,disabled:this.state.isBusy}),this.state.canUseDb&&this.superposeByDbMapping(),(0,o.jsx)(Ri.ff,{icon:Oi.Hk,label:"",title:"Options",toggle:this.toggleOptions,isSelected:"options"===this.state.action,disabled:this.state.isBusy,style:{flex:"0 0 40px",padding:0}})]}),"byChains"===this.state.action&&this.addByChains(),"byAtoms"===this.state.action&&this.addByAtoms(),"options"===this.state.action&&(0,o.jsx)("div",{className:"msp-control-offset",children:(0,o.jsx)(zi.y1,{params:va,values:this.state.options,onChangeValues:this.setOptions,isDisabled:this.state.isBusy})})]})}}var Sa=n(51404),Ca=n(29173);class wa extends l.VK{defaultState(){return{isCollapsed:!1,header:"Quick Styles",brand:{accent:"gray",svg:Oi._c}}}renderControls(){return(0,o.jsx)(o.Fragment,{children:(0,o.jsx)(ka,{})})}}class ka extends l.jB{constructor(){super(...arguments),this.state={busy:!1,style:"default"}}async applyRepresentation(e){this.setState({busy:!0}),await async function(e,t){const{structures:n}=e.managers.structure.hierarchy.selection;switch(t){case"default":const t=e.config.get(Mr.AB.Structure.DefaultRepresentationPreset)||Ca.Bj.auto.id,i=e.builders.structure.representation.resolveProvider(t);await e.managers.structure.component.applyPreset(n,i);break;case"spacefill":await e.managers.structure.component.applyPreset(n,Ca.Bj.illustrative);break;case"cartoon":await e.managers.structure.component.applyPreset(n,Ca.Bj["polymer-and-ligand"]);break;case"surface":await e.managers.structure.component.applyPreset(n,Ca.Bj["molecular-surface"])}}(this.plugin,e),await Pa(this.plugin,this.state.style),this.setState({busy:!1})}async applyStyle(e){this.setState({busy:!0}),await Pa(this.plugin,e),this.setState({busy:!1,style:e})}render(){return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(Ba,{title:"Apply Representation",children:(0,o.jsxs)("div",{className:"msp-flex-row",children:[(0,o.jsx)(Ri.$n,{title:"Applies default representation preset (depends on structure size)",onClick:()=>this.applyRepresentation("default"),disabled:this.state.busy,children:"Default"}),(0,o.jsx)(Ri.$n,{title:"Applies cartoon polymer and ball-and-stick ligand representation preset",onClick:()=>this.applyRepresentation("cartoon"),disabled:this.state.busy,children:"Cartoon"}),(0,o.jsx)(Ri.$n,{title:"Applies spacefill representation preset",onClick:()=>this.applyRepresentation("spacefill"),disabled:this.state.busy,children:"Spacefill"}),(0,o.jsx)(Ri.$n,{title:"Applies molecular surface representation preset",onClick:()=>this.applyRepresentation("surface"),disabled:this.state.busy,children:"Surface"})]})}),(0,o.jsx)(Ba,{title:"Apply Style",children:(0,o.jsxs)("div",{className:"msp-flex-row",children:[(0,o.jsx)(Ri.$n,{title:"Applies default appearance (no outline, no ignore-light)",onClick:()=>this.applyStyle("default"),disabled:this.state.busy,children:"Default"}),(0,o.jsx)(Ri.$n,{title:"Applies illustrative appearance (outline, ignore-light)",onClick:()=>this.applyStyle("illustrative"),disabled:this.state.busy,children:"Illustrative"})]})})]})}}function Ba(e){return(0,o.jsxs)("div",{className:"msp-control-group-wrapper",children:[(0,o.jsx)("div",{className:"msp-control-group-header",children:(0,o.jsx)("div",{children:(0,o.jsx)("b",{children:e.title})})}),e.children]})}async function Pa(e,t){if("default"===t&&(await e.managers.structure.component.setOptions({...e.managers.structure.component.state.options,ignoreLight:!1}),e.canvas3d)){const t=Xi.t.getDefaultValues(Sa.co);e.canvas3d.setProps({postprocessing:{outline:t.outline,occlusion:t.occlusion,shadow:t.shadow}})}if("illustrative"===t&&(await e.managers.structure.component.setOptions({...e.managers.structure.component.state.options,ignoreLight:!0}),e.canvas3d)){const t=e.canvas3d.props.postprocessing;e.canvas3d.setProps({postprocessing:{outline:{name:"on",params:"on"===t.outline.name?t.outline.params:{scale:1,color:(0,es.Q1)(0),threshold:.33,includeTransparent:!0}},occlusion:{name:"on",params:"on"===t.occlusion.name?t.occlusion.params:{multiScale:{name:"off",params:{}},radius:5,bias:.8,blurKernelSize:15,blurDepthBias:.5,samples:32,resolutionScale:1,color:(0,es.Q1)(0),transparentThreshold:.4}},shadow:{name:"off",params:{}}}})}}function Ia(e,t){const n=String(e);if("string"!=typeof t)throw new TypeError("Expected character");let i=0,s=n.indexOf(t);for(;-1!==s;)i++,s=n.indexOf(t,s+t.length);return i}function ja(e,t,n){const i=Mn((n||{}).ignore||[]),s=function(e){const t=[];if(!Array.isArray(e))throw new TypeError("Expected find and replace tuple or list of tuples");const n=!e[0]||Array.isArray(e[0])?e:[e];let i=-1;for(;++i<n.length;){const e=n[i];t.push([Ta(e[0]),Aa(e[1])])}return t}(t);let r=-1;for(;++r<s.length;)On(e,"text",o);function o(e,t){let n,o=-1;for(;++o<t.length;){const e=t[o],s=n?n.children:void 0;if(i(e,s?s.indexOf(e):void 0,n))return;n=e}if(n)return function(e,t){const n=t[t.length-1],i=s[r][0],o=s[r][1];let a=0;const l=n.children.indexOf(e);let c=!1,u=[];i.lastIndex=0;let d=i.exec(e.value);for(;d;){const n=d.index,s={index:d.index,input:d.input,stack:[...t,e]};let r=o(...d,s);if("string"==typeof r&&(r=r.length>0?{type:"text",value:r}:void 0),!1===r?i.lastIndex=n+1:(a!==n&&u.push({type:"text",value:e.value.slice(a,n)}),Array.isArray(r)?u.push(...r):r&&u.push(r),a=n+d[0].length,c=!0),!i.global)break;d=i.exec(e.value)}c?(a<e.value.length&&u.push({type:"text",value:e.value.slice(a)}),n.children.splice(l,1,...u)):u=[e];return l+u.length}(e,t)}}function Ta(e){return"string"==typeof e?new RegExp(function(e){if("string"!=typeof e)throw new TypeError("Expected a string");return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")}(e),"g"):e}function Aa(e){return"function"==typeof e?e:function(){return e}}const Ma="phrasing",La=["autolink","link","image","label"];function Ea(e){this.enter({type:"link",title:null,url:"",children:[]},e)}function Da(e){this.config.enter.autolinkProtocol.call(this,e)}function Na(e){this.config.exit.autolinkProtocol.call(this,e)}function Fa(e){this.config.exit.data.call(this,e);const t=this.stack[this.stack.length-1];t.type,t.url="http://"+this.sliceSerialize(e)}function Ra(e){this.config.exit.autolinkEmail.call(this,e)}function Oa(e){this.exit(e)}function za(e){ja(e,[[/(https?:\/\/|www(?=\.))([-.\w]+)([^ \t\r\n]*)/gi,Ha],[/(?<=^|\s|\p{P}|\p{S})([-.\w+]+)@([-\w]+(?:\.[-\w]+)+)/gu,Ua]],{ignore:["link","linkReference"]})}function Ha(e,t,n,i,s){let r="";if(!Va(s))return!1;if(/^w/i.test(t)&&(n=t+n,t="",r="http://"),!function(e){const t=e.split(".");if(t.length<2||t[t.length-1]&&(/_/.test(t[t.length-1])||!/[a-zA-Z\d]/.test(t[t.length-1]))||t[t.length-2]&&(/_/.test(t[t.length-2])||!/[a-zA-Z\d]/.test(t[t.length-2])))return!1;return!0}(n))return!1;const o=function(e){const t=/[!"&'),.:;<>?\]}]+$/.exec(e);if(!t)return[e,void 0];e=e.slice(0,t.index);let n=t[0],i=n.indexOf(")");const s=Ia(e,"(");let r=Ia(e,")");for(;-1!==i&&s>r;)e+=n.slice(0,i+1),n=n.slice(i+1),i=n.indexOf(")"),r++;return[e,n]}(n+i);if(!o[0])return!1;const a={type:"link",title:null,url:r+t+o[0],children:[{type:"text",value:t+o[0]}]};return o[1]?[a,{type:"text",value:o[1]}]:a}function Ua(e,t,n,i){return!(!Va(i,!0)||/[-\d_]$/.test(n))&&{type:"link",title:null,url:"mailto:"+t+"@"+n,children:[{type:"text",value:t+"@"+n}]}}function Va(e,t){const n=e.input.charCodeAt(e.index-1);return(0===e.index||Ze(n)||$e(n))&&(!t||47!==n)}function _a(){this.buffer()}function Ga(e){this.enter({type:"footnoteReference",identifier:"",label:""},e)}function qa(){this.buffer()}function $a(e){this.enter({type:"footnoteDefinition",identifier:"",label:"",children:[]},e)}function Za(e){const t=this.resume(),n=this.stack[this.stack.length-1];n.type,n.identifier=vt(this.sliceSerialize(e)).toLowerCase(),n.label=t}function Ka(e){this.exit(e)}function Qa(e){const t=this.resume(),n=this.stack[this.stack.length-1];n.type,n.identifier=vt(this.sliceSerialize(e)).toLowerCase(),n.label=t}function Xa(e){this.exit(e)}function Wa(e,t,n,i){const s=n.createTracker(i);let r=s.move("[^");const o=n.enter("footnoteReference"),a=n.enter("reference");return r+=s.move(n.safe(n.associationId(e),{after:"]",before:r})),a(),o(),r+=s.move("]"),r}function Ya(e){let t=!1;return e&&e.firstLineBlank&&(t=!0),{handlers:{footnoteDefinition:function(e,n,i,s){const r=i.createTracker(s);let o=r.move("[^");const a=i.enter("footnoteDefinition"),l=i.enter("label");o+=r.move(i.safe(i.associationId(e),{before:o,after:"]"})),l(),o+=r.move("]:"),e.children&&e.children.length>0&&(r.shift(4),o+=r.move((t?"\n":" ")+i.indentLines(i.containerFlow(e,r.current()),t?el:Ja)));return a(),o},footnoteReference:Wa},unsafe:[{character:"[",inConstruct:["label","phrasing","reference"]}]}}function Ja(e,t,n){return 0===t?e:el(e,t,n)}function el(e,t,n){return(n?"":"    ")+e}Wa.peek=function(){return"["};const tl=["autolink","destinationLiteral","destinationRaw","reference","titleQuote","titleApostrophe"];function nl(e){this.enter({type:"delete",children:[]},e)}function il(e){this.exit(e)}function sl(e,t,n,i){const s=n.createTracker(i),r=n.enter("strikethrough");let o=s.move("~~");return o+=n.containerPhrasing(e,{...s.current(),before:o,after:"~"}),o+=s.move("~~"),r(),o}function rl(e){return e.length}function ol(e){return null==e?"":String(e)}function al(e){const t="string"==typeof e?e.codePointAt(0):0;return 67===t||99===t?99:76===t||108===t?108:82===t||114===t?114:0}function ll(e,t,n){return">"+(n?"":" ")+e}function cl(e,t){return ul(e,t.inConstruct,!0)&&!ul(e,t.notInConstruct,!1)}function ul(e,t,n){if("string"==typeof t&&(t=[t]),!t||0===t.length)return n;let i=-1;for(;++i<t.length;)if(e.includes(t[i]))return!0;return!1}function dl(e,t,n,i){let s=-1;for(;++s<n.unsafe.length;)if("\n"===n.unsafe[s].character&&cl(n.stack,n.unsafe[s]))return/[ \t]/.test(i.before)?"":" ";return"\\\n"}function hl(e,t,n){return(n?"":"    ")+e}function pl(e){const t=e.options.quote||'"';if('"'!==t&&"'"!==t)throw new Error("Cannot serialize title with `"+t+"` for `options.quote`, expected `\"`, or `'`");return t}function ml(e){return"&#x"+e.toString(16).toUpperCase()+";"}function fl(e,t,n){const i=_t(e),s=_t(t);return void 0===i?void 0===s?"_"===n?{inside:!0,outside:!0}:{inside:!1,outside:!1}:1===s?{inside:!0,outside:!0}:{inside:!1,outside:!0}:1===i?void 0===s?{inside:!1,outside:!1}:1===s?{inside:!0,outside:!0}:{inside:!1,outside:!1}:void 0===s?{inside:!1,outside:!1}:1===s?{inside:!0,outside:!1}:{inside:!1,outside:!1}}function gl(e,t,n,i){const s=function(e){const t=e.options.emphasis||"*";if("*"!==t&&"_"!==t)throw new Error("Cannot serialize emphasis with `"+t+"` for `options.emphasis`, expected `*`, or `_`");return t}(n),r=n.enter("emphasis"),o=n.createTracker(i),a=o.move(s);let l=o.move(n.containerPhrasing(e,{after:s,before:a,...o.current()}));const c=l.charCodeAt(0),u=fl(i.before.charCodeAt(i.before.length-1),c,s);u.inside&&(l=ml(c)+l.slice(1));const d=l.charCodeAt(l.length-1),h=fl(i.after.charCodeAt(0),d,s);h.inside&&(l=l.slice(0,-1)+ml(d));const p=o.move(s);return r(),n.attentionEncodeSurroundingInfo={after:h.outside,before:u.outside},a+l+p}function yl(e){return e.value||""}function vl(e,t,n,i){const s=pl(n),r='"'===s?"Quote":"Apostrophe",o=n.enter("image");let a=n.enter("label");const l=n.createTracker(i);let c=l.move("![");return c+=l.move(n.safe(e.alt,{before:c,after:"]",...l.current()})),c+=l.move("]("),a(),!e.url&&e.title||/[\0- \u007F]/.test(e.url)?(a=n.enter("destinationLiteral"),c+=l.move("<"),c+=l.move(n.safe(e.url,{before:c,after:">",...l.current()})),c+=l.move(">")):(a=n.enter("destinationRaw"),c+=l.move(n.safe(e.url,{before:c,after:e.title?" ":")",...l.current()}))),a(),e.title&&(a=n.enter(`title${r}`),c+=l.move(" "+s),c+=l.move(n.safe(e.title,{before:c,after:s,...l.current()})),c+=l.move(s),a()),c+=l.move(")"),o(),c}function bl(e,t,n,i){const s=e.referenceType,r=n.enter("imageReference");let o=n.enter("label");const a=n.createTracker(i);let l=a.move("![");const c=n.safe(e.alt,{before:l,after:"]",...a.current()});l+=a.move(c+"]["),o();const u=n.stack;n.stack=[],o=n.enter("reference");const d=n.safe(n.associationId(e),{before:l,after:"]",...a.current()});return o(),n.stack=u,r(),"full"!==s&&c&&c===d?"shortcut"===s?l=l.slice(0,-1):l+=a.move("]"):l+=a.move(d+"]"),l}function xl(e,t,n){let i=e.value||"",s="`",r=-1;for(;new RegExp("(^|[^`])"+s+"([^`]|$)").test(i);)s+="`";for(/[^ \r\n]/.test(i)&&(/^[ \r\n]/.test(i)&&/[ \r\n]$/.test(i)||/^`|`$/.test(i))&&(i=" "+i+" ");++r<n.unsafe.length;){const e=n.unsafe[r],t=n.compilePattern(e);let s;if(e.atBreak)for(;s=t.exec(i);){let e=s.index;10===i.charCodeAt(e)&&13===i.charCodeAt(e-1)&&e--,i=i.slice(0,e)+" "+i.slice(s.index+1)}}return s+i+s}function Sl(e,t){const n=we(e);return Boolean(!t.options.resourceLink&&e.url&&!e.title&&e.children&&1===e.children.length&&"text"===e.children[0].type&&(n===e.url||"mailto:"+n===e.url)&&/^[a-z][a-z+.-]+:/i.test(e.url)&&!/[\0- <>\u007F]/.test(e.url))}function Cl(e,t,n,i){const s=pl(n),r='"'===s?"Quote":"Apostrophe",o=n.createTracker(i);let a,l;if(Sl(e,n)){const t=n.stack;n.stack=[],a=n.enter("autolink");let i=o.move("<");return i+=o.move(n.containerPhrasing(e,{before:i,after:">",...o.current()})),i+=o.move(">"),a(),n.stack=t,i}a=n.enter("link"),l=n.enter("label");let c=o.move("[");return c+=o.move(n.containerPhrasing(e,{before:c,after:"](",...o.current()})),c+=o.move("]("),l(),!e.url&&e.title||/[\0- \u007F]/.test(e.url)?(l=n.enter("destinationLiteral"),c+=o.move("<"),c+=o.move(n.safe(e.url,{before:c,after:">",...o.current()})),c+=o.move(">")):(l=n.enter("destinationRaw"),c+=o.move(n.safe(e.url,{before:c,after:e.title?" ":")",...o.current()}))),l(),e.title&&(l=n.enter(`title${r}`),c+=o.move(" "+s),c+=o.move(n.safe(e.title,{before:c,after:s,...o.current()})),c+=o.move(s),l()),c+=o.move(")"),a(),c}function wl(e,t,n,i){const s=e.referenceType,r=n.enter("linkReference");let o=n.enter("label");const a=n.createTracker(i);let l=a.move("[");const c=n.containerPhrasing(e,{before:l,after:"]",...a.current()});l+=a.move(c+"]["),o();const u=n.stack;n.stack=[],o=n.enter("reference");const d=n.safe(n.associationId(e),{before:l,after:"]",...a.current()});return o(),n.stack=u,r(),"full"!==s&&c&&c===d?"shortcut"===s?l=l.slice(0,-1):l+=a.move("]"):l+=a.move(d+"]"),l}function kl(e){const t=e.options.bullet||"*";if("*"!==t&&"+"!==t&&"-"!==t)throw new Error("Cannot serialize items with `"+t+"` for `options.bullet`, expected `*`, `+`, or `-`");return t}function Bl(e){const t=e.options.rule||"*";if("*"!==t&&"-"!==t&&"_"!==t)throw new Error("Cannot serialize rules with `"+t+"` for `options.rule`, expected `*`, `-`, or `_`");return t}sl.peek=function(){return"~"},gl.peek=function(e,t,n){return n.options.emphasis||"*"},yl.peek=function(){return"<"},vl.peek=function(){return"!"},bl.peek=function(){return"!"},xl.peek=function(){return"`"},Cl.peek=function(e,t,n){return Sl(e,n)?"<":"["},wl.peek=function(){return"["};const Pl=Mn(["break","delete","emphasis","footnote","footnoteReference","image","imageReference","inlineCode","inlineMath","link","linkReference","mdxJsxTextElement","mdxTextExpression","strong","text","textDirective"]);function Il(e,t,n,i){const s=function(e){const t=e.options.strong||"*";if("*"!==t&&"_"!==t)throw new Error("Cannot serialize strong with `"+t+"` for `options.strong`, expected `*`, or `_`");return t}(n),r=n.enter("strong"),o=n.createTracker(i),a=o.move(s+s);let l=o.move(n.containerPhrasing(e,{after:s,before:a,...o.current()}));const c=l.charCodeAt(0),u=fl(i.before.charCodeAt(i.before.length-1),c,s);u.inside&&(l=ml(c)+l.slice(1));const d=l.charCodeAt(l.length-1),h=fl(i.after.charCodeAt(0),d,s);h.inside&&(l=l.slice(0,-1)+ml(d));const p=o.move(s+s);return r(),n.attentionEncodeSurroundingInfo={after:h.outside,before:u.outside},a+l+p}Il.peek=function(e,t,n){return n.options.strong||"*"};const jl={blockquote:function(e,t,n,i){const s=n.enter("blockquote"),r=n.createTracker(i);r.move("> "),r.shift(2);const o=n.indentLines(n.containerFlow(e,r.current()),ll);return s(),o},break:dl,code:function(e,t,n,i){const s=function(e){const t=e.options.fence||"`";if("`"!==t&&"~"!==t)throw new Error("Cannot serialize code with `"+t+"` for `options.fence`, expected `` ` `` or `~`");return t}(n),r=e.value||"",o="`"===s?"GraveAccent":"Tilde";if(function(e,t){return Boolean(!1===t.options.fences&&e.value&&!e.lang&&/[^ \r\n]/.test(e.value)&&!/^[\t ]*(?:[\r\n]|$)|(?:^|[\r\n])[\t ]*$/.test(e.value))}(e,n)){const e=n.enter("codeIndented"),t=n.indentLines(r,hl);return e(),t}const a=n.createTracker(i),l=s.repeat(Math.max(function(e,t){const n=String(e);let i=n.indexOf(t),s=i,r=0,o=0;if("string"!=typeof t)throw new TypeError("Expected substring");for(;-1!==i;)i===s?++r>o&&(o=r):r=1,s=i+t.length,i=n.indexOf(t,s);return o}(r,s)+1,3)),c=n.enter("codeFenced");let u=a.move(l);if(e.lang){const t=n.enter(`codeFencedLang${o}`);u+=a.move(n.safe(e.lang,{before:u,after:" ",encode:["`"],...a.current()})),t()}if(e.lang&&e.meta){const t=n.enter(`codeFencedMeta${o}`);u+=a.move(" "),u+=a.move(n.safe(e.meta,{before:u,after:"\n",encode:["`"],...a.current()})),t()}return u+=a.move("\n"),r&&(u+=a.move(r+"\n")),u+=a.move(l),c(),u},definition:function(e,t,n,i){const s=pl(n),r='"'===s?"Quote":"Apostrophe",o=n.enter("definition");let a=n.enter("label");const l=n.createTracker(i);let c=l.move("[");return c+=l.move(n.safe(n.associationId(e),{before:c,after:"]",...l.current()})),c+=l.move("]: "),a(),!e.url||/[\0- \u007F]/.test(e.url)?(a=n.enter("destinationLiteral"),c+=l.move("<"),c+=l.move(n.safe(e.url,{before:c,after:">",...l.current()})),c+=l.move(">")):(a=n.enter("destinationRaw"),c+=l.move(n.safe(e.url,{before:c,after:e.title?" ":"\n",...l.current()}))),a(),e.title&&(a=n.enter(`title${r}`),c+=l.move(" "+s),c+=l.move(n.safe(e.title,{before:c,after:s,...l.current()})),c+=l.move(s),a()),o(),c},emphasis:gl,hardBreak:dl,heading:function(e,t,n,i){const s=Math.max(Math.min(6,e.depth||1),1),r=n.createTracker(i);if(function(e,t){let n=!1;return zn(e,function(e){if("value"in e&&/\r?\n|\r/.test(e.value)||"break"===e.type)return n=!0,Rn}),Boolean((!e.depth||e.depth<3)&&we(e)&&(t.options.setext||n))}(e,n)){const t=n.enter("headingSetext"),i=n.enter("phrasing"),o=n.containerPhrasing(e,{...r.current(),before:"\n",after:"\n"});return i(),t(),o+"\n"+(1===s?"=":"-").repeat(o.length-(Math.max(o.lastIndexOf("\r"),o.lastIndexOf("\n"))+1))}const o="#".repeat(s),a=n.enter("headingAtx"),l=n.enter("phrasing");r.move(o+" ");let c=n.containerPhrasing(e,{before:"# ",after:"\n",...r.current()});return/^[\t ]/.test(c)&&(c=ml(c.charCodeAt(0))+c.slice(1)),c=c?o+" "+c:o,n.options.closeAtx&&(c+=" "+o),l(),a(),c},html:yl,image:vl,imageReference:bl,inlineCode:xl,link:Cl,linkReference:wl,list:function(e,t,n,i){const s=n.enter("list"),r=n.bulletCurrent;let o=e.ordered?function(e){const t=e.options.bulletOrdered||".";if("."!==t&&")"!==t)throw new Error("Cannot serialize items with `"+t+"` for `options.bulletOrdered`, expected `.` or `)`");return t}(n):kl(n);const a=e.ordered?"."===o?")":".":function(e){const t=kl(e),n=e.options.bulletOther;if(!n)return"*"===t?"-":"*";if("*"!==n&&"+"!==n&&"-"!==n)throw new Error("Cannot serialize items with `"+n+"` for `options.bulletOther`, expected `*`, `+`, or `-`");if(n===t)throw new Error("Expected `bullet` (`"+t+"`) and `bulletOther` (`"+n+"`) to be different");return n}(n);let l=!(!t||!n.bulletLastUsed)&&o===n.bulletLastUsed;if(!e.ordered){const t=e.children?e.children[0]:void 0;if("*"!==o&&"-"!==o||!t||t.children&&t.children[0]||"list"!==n.stack[n.stack.length-1]||"listItem"!==n.stack[n.stack.length-2]||"list"!==n.stack[n.stack.length-3]||"listItem"!==n.stack[n.stack.length-4]||0!==n.indexStack[n.indexStack.length-1]||0!==n.indexStack[n.indexStack.length-2]||0!==n.indexStack[n.indexStack.length-3]||(l=!0),Bl(n)===o&&t){let t=-1;for(;++t<e.children.length;){const n=e.children[t];if(n&&"listItem"===n.type&&n.children&&n.children[0]&&"thematicBreak"===n.children[0].type){l=!0;break}}}}l&&(o=a),n.bulletCurrent=o;const c=n.containerFlow(e,i);return n.bulletLastUsed=o,n.bulletCurrent=r,s(),c},listItem:function(e,t,n,i){const s=function(e){const t=e.options.listItemIndent||"one";if("tab"!==t&&"one"!==t&&"mixed"!==t)throw new Error("Cannot serialize items with `"+t+"` for `options.listItemIndent`, expected `tab`, `one`, or `mixed`");return t}(n);let r=n.bulletCurrent||kl(n);t&&"list"===t.type&&t.ordered&&(r=("number"==typeof t.start&&t.start>-1?t.start:1)+(!1===n.options.incrementListMarker?0:t.children.indexOf(e))+r);let o=r.length+1;("tab"===s||"mixed"===s&&(t&&"list"===t.type&&t.spread||e.spread))&&(o=4*Math.ceil(o/4));const a=n.createTracker(i);a.move(r+" ".repeat(o-r.length)),a.shift(o);const l=n.enter("listItem"),c=n.indentLines(n.containerFlow(e,a.current()),function(e,t,n){if(t)return(n?"":" ".repeat(o))+e;return(n?r:r+" ".repeat(o-r.length))+e});return l(),c},paragraph:function(e,t,n,i){const s=n.enter("paragraph"),r=n.enter("phrasing"),o=n.containerPhrasing(e,i);return r(),s(),o},root:function(e,t,n,i){const s=e.children.some(function(e){return Pl(e)});return(s?n.containerPhrasing:n.containerFlow).call(n,e,i)},strong:Il,text:function(e,t,n,i){return n.safe(e.value,i)},thematicBreak:function(e,t,n){const i=(Bl(n)+(n.options.ruleSpaces?" ":"")).repeat(function(e){const t=e.options.ruleRepetition||3;if(t<3)throw new Error("Cannot serialize rules with repetition `"+t+"` for `options.ruleRepetition`, expected `3` or more");return t}(n));return n.options.ruleSpaces?i.slice(0,-1):i}};function Tl(e){const t=e._align;this.enter({type:"table",align:t.map(function(e){return"none"===e?null:e}),children:[]},e),this.data.inTable=!0}function Al(e){this.exit(e),this.data.inTable=void 0}function Ml(e){this.enter({type:"tableRow",children:[]},e)}function Ll(e){this.exit(e)}function El(e){this.enter({type:"tableCell",children:[]},e)}function Dl(e){let t=this.resume();this.data.inTable&&(t=t.replace(/\\([\\|])/g,Nl));const n=this.stack[this.stack.length-1];n.type,n.value=t,this.exit(e)}function Nl(e,t){return"|"===t?t:e}function Fl(e){const t=e||{},n=t.tableCellPadding,i=t.tablePipeAlign,s=t.stringLength,r=n?" ":"|";return{unsafe:[{character:"\r",inConstruct:"tableCell"},{character:"\n",inConstruct:"tableCell"},{atBreak:!0,character:"|",after:"[\t :-]"},{character:"|",inConstruct:"tableCell"},{atBreak:!0,character:":",after:"-"},{atBreak:!0,character:"-",after:"[:|-]"}],handlers:{inlineCode:function(e,t,n){let i=jl.inlineCode(e,t,n);n.stack.includes("tableCell")&&(i=i.replace(/\|/g,"\\$&"));return i},table:function(e,t,n,i){return a(function(e,t,n){const i=e.children;let s=-1;const r=[],o=t.enter("table");for(;++s<i.length;)r[s]=l(i[s],t,n);return o(),r}(e,n,i),e.align)},tableCell:o,tableRow:function(e,t,n,i){const s=l(e,n,i),r=a([s]);return r.slice(0,r.indexOf("\n"))}}};function o(e,t,n,i){const s=n.enter("tableCell"),o=n.enter("phrasing"),a=n.containerPhrasing(e,{...i,before:r,after:r});return o(),s(),a}function a(e,t){return function(e,t){const n=t||{},i=(n.align||[]).concat(),s=n.stringLength||rl,r=[],o=[],a=[],l=[];let c=0,u=-1;for(;++u<e.length;){const t=[],i=[];let r=-1;for(e[u].length>c&&(c=e[u].length);++r<e[u].length;){const o=ol(e[u][r]);if(!1!==n.alignDelimiters){const e=s(o);i[r]=e,(void 0===l[r]||e>l[r])&&(l[r]=e)}t.push(o)}o[u]=t,a[u]=i}let d=-1;if("object"==typeof i&&"length"in i)for(;++d<c;)r[d]=al(i[d]);else{const e=al(i);for(;++d<c;)r[d]=e}d=-1;const h=[],p=[];for(;++d<c;){const e=r[d];let t="",i="";99===e?(t=":",i=":"):108===e?t=":":114===e&&(i=":");let s=!1===n.alignDelimiters?1:Math.max(1,l[d]-t.length-i.length);const o=t+"-".repeat(s)+i;!1!==n.alignDelimiters&&(s=t.length+s+i.length,s>l[d]&&(l[d]=s),p[d]=s),h[d]=o}o.splice(1,0,h),a.splice(1,0,p),u=-1;const m=[];for(;++u<o.length;){const e=o[u],t=a[u];d=-1;const i=[];for(;++d<c;){const s=e[d]||"";let o="",a="";if(!1!==n.alignDelimiters){const e=l[d]-(t[d]||0),n=r[d];114===n?o=" ".repeat(e):99===n?e%2?(o=" ".repeat(e/2+.5),a=" ".repeat(e/2-.5)):(o=" ".repeat(e/2),a=o):a=" ".repeat(e)}!1===n.delimiterStart||d||i.push("|"),!1===n.padding||!1===n.alignDelimiters&&""===s||!1===n.delimiterStart&&!d||i.push(" "),!1!==n.alignDelimiters&&i.push(o),i.push(s),!1!==n.alignDelimiters&&i.push(a),!1!==n.padding&&i.push(" "),!1===n.delimiterEnd&&d===c-1||i.push("|")}m.push(!1===n.delimiterEnd?i.join("").replace(/ +$/,""):i.join(""))}return m.join("\n")}(e,{align:t,alignDelimiters:i,padding:n,stringLength:s})}function l(e,t,n){const i=e.children;let s=-1;const r=[],a=t.enter("tableRow");for(;++s<i.length;)r[s]=o(i[s],0,t,n);return a(),r}}function Rl(e){const t=this.stack[this.stack.length-2];t.type,t.checked="taskListCheckValueChecked"===e.type}function Ol(e){const t=this.stack[this.stack.length-2];if(t&&"listItem"===t.type&&"boolean"==typeof t.checked){const e=this.stack[this.stack.length-1];e.type;const n=e.children[0];if(n&&"text"===n.type){const i=t.children;let s,r=-1;for(;++r<i.length;){const e=i[r];if("paragraph"===e.type){s=e;break}}s===e&&(n.value=n.value.slice(1),0===n.value.length?e.children.shift():e.position&&n.position&&"number"==typeof n.position.start.offset&&(n.position.start.column++,n.position.start.offset++,e.position.start=Object.assign({},n.position.start)))}}this.exit(e)}function zl(e,t,n,i){const s=e.children[0],r="boolean"==typeof e.checked&&s&&"paragraph"===s.type,o="["+(e.checked?"x":" ")+"] ",a=n.createTracker(i);r&&a.move(o);let l=jl.listItem(e,t,n,{...i,...a.current()});return r&&(l=l.replace(/^(?:[*+-]|\d+\.)([\r\n]| {1,3})/,function(e){return e+o})),l}const Hl={tokenize:function(e,t,n){let i=0;return function t(r){if((87===r||119===r)&&i<3)return i++,e.consume(r),t;if(46===r&&3===i)return e.consume(r),s;return n(r)};function s(e){return null===e?n(e):t(e)}},partial:!0},Ul={tokenize:function(e,t,n){let i,s,r;return o;function o(t){return 46===t||95===t?e.check(_l,l,a)(t):null===t||Ge(t)||Ze(t)||45!==t&&$e(t)?l(t):(r=!0,e.consume(t),o)}function a(t){return 95===t?i=!0:(s=i,i=void 0),e.consume(t),o}function l(e){return s||i||!r?n(e):t(e)}},partial:!0},Vl={tokenize:function(e,t){let n=0,i=0;return s;function s(o){return 40===o?(n++,e.consume(o),s):41===o&&i<n?r(o):33===o||34===o||38===o||39===o||41===o||42===o||44===o||46===o||58===o||59===o||60===o||63===o||93===o||95===o||126===o?e.check(_l,t,r)(o):null===o||Ge(o)||Ze(o)?t(o):(e.consume(o),s)}function r(t){return 41===t&&i++,e.consume(t),s}},partial:!0},_l={tokenize:function(e,t,n){return i;function i(o){return 33===o||34===o||39===o||41===o||42===o||44===o||46===o||58===o||59===o||63===o||95===o||126===o?(e.consume(o),i):38===o?(e.consume(o),r):93===o?(e.consume(o),s):60===o||null===o||Ge(o)||Ze(o)?t(o):n(o)}function s(e){return null===e||40===e||91===e||Ge(e)||Ze(e)?t(e):i(e)}function r(e){return Fe(e)?o(e):n(e)}function o(t){return 59===t?(e.consume(t),i):Fe(t)?(e.consume(t),o):n(t)}},partial:!0},Gl={tokenize:function(e,t,n){return function(t){return e.consume(t),i};function i(e){return Re(e)?n(e):t(e)}},partial:!0},ql={name:"wwwAutolink",tokenize:function(e,t,n){const i=this;return function(t){if(87!==t&&119!==t||!Xl.call(i,i.previous)||ec(i.events))return n(t);return e.enter("literalAutolink"),e.enter("literalAutolinkWww"),e.check(Hl,e.attempt(Ul,e.attempt(Vl,s),n),n)(t)};function s(n){return e.exit("literalAutolinkWww"),e.exit("literalAutolink"),t(n)}},previous:Xl},$l={name:"protocolAutolink",tokenize:function(e,t,n){const i=this;let s="",r=!1;return function(t){if((72===t||104===t)&&Wl.call(i,i.previous)&&!ec(i.events))return e.enter("literalAutolink"),e.enter("literalAutolinkHttp"),s+=String.fromCodePoint(t),e.consume(t),o;return n(t)};function o(t){if(Fe(t)&&s.length<5)return s+=String.fromCodePoint(t),e.consume(t),o;if(58===t){const n=s.toLowerCase();if("http"===n||"https"===n)return e.consume(t),a}return n(t)}function a(t){return 47===t?(e.consume(t),r?l:(r=!0,a)):n(t)}function l(t){return null===t||ze(t)||Ge(t)||Ze(t)||$e(t)?n(t):e.attempt(Ul,e.attempt(Vl,c),n)(t)}function c(n){return e.exit("literalAutolinkHttp"),e.exit("literalAutolink"),t(n)}},previous:Wl},Zl={name:"emailAutolink",tokenize:function(e,t,n){const i=this;let s,r;return function(t){if(!Jl(t)||!Yl.call(i,i.previous)||ec(i.events))return n(t);return e.enter("literalAutolink"),e.enter("literalAutolinkEmail"),o(t)};function o(t){return Jl(t)?(e.consume(t),o):64===t?(e.consume(t),a):n(t)}function a(t){return 46===t?e.check(Gl,c,l)(t):45===t||95===t||Re(t)?(r=!0,e.consume(t),a):c(t)}function l(t){return e.consume(t),s=!0,a}function c(o){return r&&s&&Fe(i.previous)?(e.exit("literalAutolinkEmail"),e.exit("literalAutolink"),t(o)):n(o)}},previous:Yl},Kl={};let Ql=48;for(;Ql<123;)Kl[Ql]=Zl,Ql++,58===Ql?Ql=65:91===Ql&&(Ql=97);function Xl(e){return null===e||40===e||42===e||95===e||91===e||93===e||126===e||Ge(e)}function Wl(e){return!Fe(e)}function Yl(e){return!(47===e||Jl(e))}function Jl(e){return 43===e||45===e||46===e||95===e||Re(e)}function ec(e){let t=e.length,n=!1;for(;t--;){const i=e[t][1];if(("labelLink"===i.type||"labelImage"===i.type)&&!i._balanced){n=!0;break}if(i._gfmAutolinkLiteralWalkedInto){n=!1;break}}return e.length>0&&!n&&(e[e.length-1][1]._gfmAutolinkLiteralWalkedInto=!0),n}Kl[43]=Zl,Kl[45]=Zl,Kl[46]=Zl,Kl[95]=Zl,Kl[72]=[Zl,$l],Kl[104]=[Zl,$l],Kl[87]=[Zl,ql],Kl[119]=[Zl,ql];const tc={tokenize:function(e,t,n){const i=this;return Qe(e,function(e){const s=i.events[i.events.length-1];return s&&"gfmFootnoteDefinitionIndent"===s[1].type&&4===s[2].sliceSerialize(s[1],!0).length?t(e):n(e)},"gfmFootnoteDefinitionIndent",5)},partial:!0};function nc(e,t,n){const i=this;let s=i.events.length;const r=i.parser.gfmFootnotes||(i.parser.gfmFootnotes=[]);let o;for(;s--;){const e=i.events[s][1];if("labelImage"===e.type){o=e;break}if("gfmFootnoteCall"===e.type||"labelLink"===e.type||"label"===e.type||"image"===e.type||"link"===e.type)break}return function(s){if(!o||!o._balanced)return n(s);const a=vt(i.sliceSerialize({start:o.end,end:i.now()}));if(94!==a.codePointAt(0)||!r.includes(a.slice(1)))return n(s);return e.enter("gfmFootnoteCallLabelMarker"),e.consume(s),e.exit("gfmFootnoteCallLabelMarker"),t(s)}}function ic(e,t){let n,i=e.length;for(;i--;)if("labelImage"===e[i][1].type&&"enter"===e[i][0]){n=e[i][1];break}e[i+1][1].type="data",e[i+3][1].type="gfmFootnoteCallLabelMarker";const s={type:"gfmFootnoteCall",start:Object.assign({},e[i+3][1].start),end:Object.assign({},e[e.length-1][1].end)},r={type:"gfmFootnoteCallMarker",start:Object.assign({},e[i+3][1].end),end:Object.assign({},e[i+3][1].end)};r.end.column++,r.end.offset++,r.end._bufferIndex++;const o={type:"gfmFootnoteCallString",start:Object.assign({},r.end),end:Object.assign({},e[e.length-1][1].start)},a={type:"chunkString",contentType:"string",start:Object.assign({},o.start),end:Object.assign({},o.end)},l=[e[i+1],e[i+2],["enter",s,t],e[i+3],e[i+4],["enter",r,t],["exit",r,t],["enter",o,t],["enter",a,t],["exit",a,t],["exit",o,t],e[e.length-2],e[e.length-1],["exit",s,t]];return e.splice(i,e.length-i+1,...l),e}function sc(e,t,n){const i=this,s=i.parser.gfmFootnotes||(i.parser.gfmFootnotes=[]);let r,o=0;return function(t){return e.enter("gfmFootnoteCall"),e.enter("gfmFootnoteCallLabelMarker"),e.consume(t),e.exit("gfmFootnoteCallLabelMarker"),a};function a(t){return 94!==t?n(t):(e.enter("gfmFootnoteCallMarker"),e.consume(t),e.exit("gfmFootnoteCallMarker"),e.enter("gfmFootnoteCallString"),e.enter("chunkString").contentType="string",l)}function l(a){if(o>999||93===a&&!r||null===a||91===a||Ge(a))return n(a);if(93===a){e.exit("chunkString");const r=e.exit("gfmFootnoteCallString");return s.includes(vt(i.sliceSerialize(r)))?(e.enter("gfmFootnoteCallLabelMarker"),e.consume(a),e.exit("gfmFootnoteCallLabelMarker"),e.exit("gfmFootnoteCall"),t):n(a)}return Ge(a)||(r=!0),o++,e.consume(a),92===a?c:l}function c(t){return 91===t||92===t||93===t?(e.consume(t),o++,l):l(t)}}function rc(e,t,n){const i=this,s=i.parser.gfmFootnotes||(i.parser.gfmFootnotes=[]);let r,o,a=0;return function(t){return e.enter("gfmFootnoteDefinition")._container=!0,e.enter("gfmFootnoteDefinitionLabel"),e.enter("gfmFootnoteDefinitionLabelMarker"),e.consume(t),e.exit("gfmFootnoteDefinitionLabelMarker"),l};function l(t){return 94===t?(e.enter("gfmFootnoteDefinitionMarker"),e.consume(t),e.exit("gfmFootnoteDefinitionMarker"),e.enter("gfmFootnoteDefinitionLabelString"),e.enter("chunkString").contentType="string",c):n(t)}function c(t){if(a>999||93===t&&!o||null===t||91===t||Ge(t))return n(t);if(93===t){e.exit("chunkString");const n=e.exit("gfmFootnoteDefinitionLabelString");return r=vt(i.sliceSerialize(n)),e.enter("gfmFootnoteDefinitionLabelMarker"),e.consume(t),e.exit("gfmFootnoteDefinitionLabelMarker"),e.exit("gfmFootnoteDefinitionLabel"),d}return Ge(t)||(o=!0),a++,e.consume(t),92===t?u:c}function u(t){return 91===t||92===t||93===t?(e.consume(t),a++,c):c(t)}function d(t){return 58===t?(e.enter("definitionMarker"),e.consume(t),e.exit("definitionMarker"),s.includes(r)||s.push(r),Qe(e,h,"gfmFootnoteDefinitionWhitespace")):n(t)}function h(e){return t(e)}}function oc(e,t,n){return e.check(Je,t,e.attempt(tc,t,n))}function ac(e){e.exit("gfmFootnoteDefinition")}function lc(e){let t=(e||{}).singleTilde;const n={name:"strikethrough",tokenize:function(e,n,i){const s=this.previous,r=this.events;let o=0;return function(t){if(126===s&&"characterEscape"!==r[r.length-1][1].type)return i(t);return e.enter("strikethroughSequenceTemporary"),a(t)};function a(r){const l=_t(s);if(126===r)return o>1?i(r):(e.consume(r),o++,a);if(o<2&&!t)return i(r);const c=e.exit("strikethroughSequenceTemporary"),u=_t(r);return c._open=!u||2===u&&Boolean(l),c._close=!l||2===l&&Boolean(u),n(r)}},resolveAll:function(e,t){let n=-1;for(;++n<e.length;)if("enter"===e[n][0]&&"strikethroughSequenceTemporary"===e[n][1].type&&e[n][1]._close){let i=n;for(;i--;)if("exit"===e[i][0]&&"strikethroughSequenceTemporary"===e[i][1].type&&e[i][1]._open&&e[n][1].end.offset-e[n][1].start.offset===e[i][1].end.offset-e[i][1].start.offset){e[n][1].type="strikethroughSequence",e[i][1].type="strikethroughSequence";const s={type:"strikethrough",start:Object.assign({},e[i][1].start),end:Object.assign({},e[n][1].end)},r={type:"strikethroughText",start:Object.assign({},e[i][1].end),end:Object.assign({},e[n][1].start)},o=[["enter",s,t],["enter",e[i][1],t],["exit",e[i][1],t],["enter",r,t]],a=t.parser.constructs.insideSpan.null;a&&Pe(o,o.length,0,Rt(a,e.slice(i+1,n),t)),Pe(o,o.length,0,[["exit",r,t],["enter",e[n][1],t],["exit",e[n][1],t],["exit",s,t]]),Pe(e,i-1,n-i+3,o),n=i+o.length-2;break}}n=-1;for(;++n<e.length;)"strikethroughSequenceTemporary"===e[n][1].type&&(e[n][1].type="data");return e}};return null==t&&(t=!0),{text:{126:n},insideSpan:{null:[n]},attentionMarkers:{null:[126]}}}class cc{constructor(){this.map=[]}add(e,t,n){!function(e,t,n,i){let s=0;if(0===n&&0===i.length)return;for(;s<e.map.length;){if(e.map[s][0]===t)return e.map[s][1]+=n,void e.map[s][2].push(...i);s+=1}e.map.push([t,n,i])}(this,e,t,n)}consume(e){if(this.map.sort(function(e,t){return e[0]-t[0]}),0===this.map.length)return;let t=this.map.length;const n=[];for(;t>0;)t-=1,n.push(e.slice(this.map[t][0]+this.map[t][1]),this.map[t][2]),e.length=this.map[t][0];n.push(e.slice()),e.length=0;let i=n.pop();for(;i;){for(const t of i)e.push(t);i=n.pop()}this.map.length=0}}function uc(e,t){let n=!1;const i=[];for(;t<e.length;){const s=e[t];if(n){if("enter"===s[0])"tableContent"===s[1].type&&i.push("tableDelimiterMarker"===e[t+1][1].type?"left":"none");else if("tableContent"===s[1].type){if("tableDelimiterMarker"===e[t-1][1].type){const e=i.length-1;i[e]="left"===i[e]?"center":"right"}}else if("tableDelimiterRow"===s[1].type)break}else"enter"===s[0]&&"tableDelimiterRow"===s[1].type&&(n=!0);t+=1}return i}function dc(e,t,n){const i=this;let s,r=0,o=0;return function(e){let t=i.events.length-1;for(;t>-1;){const e=i.events[t][1].type;if("lineEnding"!==e&&"linePrefix"!==e)break;t--}const s=t>-1?i.events[t][1].type:null,r="tableHead"===s||"tableRow"===s?x:a;if(r===x&&i.parser.lazy[i.now().line])return n(e);return r(e)};function a(t){return e.enter("tableHead"),e.enter("tableRow"),function(e){if(124===e)return l(e);return s=!0,o+=1,l(e)}(t)}function l(t){return null===t?n(t):_e(t)?o>1?(o=0,i.interrupt=!0,e.exit("tableRow"),e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),d):n(t):qe(t)?Qe(e,l,"whitespace")(t):(o+=1,s&&(s=!1,r+=1),124===t?(e.enter("tableCellDivider"),e.consume(t),e.exit("tableCellDivider"),s=!0,l):(e.enter("data"),c(t)))}function c(t){return null===t||124===t||Ge(t)?(e.exit("data"),l(t)):(e.consume(t),92===t?u:c)}function u(t){return 92===t||124===t?(e.consume(t),c):c(t)}function d(t){return i.interrupt=!1,i.parser.lazy[i.now().line]?n(t):(e.enter("tableDelimiterRow"),s=!1,qe(t)?Qe(e,h,"linePrefix",i.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(t):h(t))}function h(t){return 45===t||58===t?m(t):124===t?(s=!0,e.enter("tableCellDivider"),e.consume(t),e.exit("tableCellDivider"),p):b(t)}function p(t){return qe(t)?Qe(e,m,"whitespace")(t):m(t)}function m(t){return 58===t?(o+=1,s=!0,e.enter("tableDelimiterMarker"),e.consume(t),e.exit("tableDelimiterMarker"),f):45===t?(o+=1,f(t)):null===t||_e(t)?v(t):b(t)}function f(t){return 45===t?(e.enter("tableDelimiterFiller"),g(t)):b(t)}function g(t){return 45===t?(e.consume(t),g):58===t?(s=!0,e.exit("tableDelimiterFiller"),e.enter("tableDelimiterMarker"),e.consume(t),e.exit("tableDelimiterMarker"),y):(e.exit("tableDelimiterFiller"),y(t))}function y(t){return qe(t)?Qe(e,v,"whitespace")(t):v(t)}function v(n){return 124===n?h(n):(null===n||_e(n))&&s&&r===o?(e.exit("tableDelimiterRow"),e.exit("tableHead"),t(n)):b(n)}function b(e){return n(e)}function x(t){return e.enter("tableRow"),S(t)}function S(n){return 124===n?(e.enter("tableCellDivider"),e.consume(n),e.exit("tableCellDivider"),S):null===n||_e(n)?(e.exit("tableRow"),t(n)):qe(n)?Qe(e,S,"whitespace")(n):(e.enter("data"),C(n))}function C(t){return null===t||124===t||Ge(t)?(e.exit("data"),S(t)):(e.consume(t),92===t?w:C)}function w(t){return 92===t||124===t?(e.consume(t),C):C(t)}}function hc(e,t){let n,i,s,r=-1,o=!0,a=0,l=[0,0,0,0],c=[0,0,0,0],u=!1,d=0;const h=new cc;for(;++r<e.length;){const p=e[r],m=p[1];"enter"===p[0]?"tableHead"===m.type?(u=!1,0!==d&&(mc(h,t,d,n,i),i=void 0,d=0),n={type:"table",start:Object.assign({},m.start),end:Object.assign({},m.end)},h.add(r,0,[["enter",n,t]])):"tableRow"===m.type||"tableDelimiterRow"===m.type?(o=!0,s=void 0,l=[0,0,0,0],c=[0,r+1,0,0],u&&(u=!1,i={type:"tableBody",start:Object.assign({},m.start),end:Object.assign({},m.end)},h.add(r,0,[["enter",i,t]])),a="tableDelimiterRow"===m.type?2:i?3:1):!a||"data"!==m.type&&"tableDelimiterMarker"!==m.type&&"tableDelimiterFiller"!==m.type?"tableCellDivider"===m.type&&(o?o=!1:(0!==l[1]&&(c[0]=c[1],s=pc(h,t,l,a,void 0,s)),l=c,c=[l[1],r,0,0])):(o=!1,0===c[2]&&(0!==l[1]&&(c[0]=c[1],s=pc(h,t,l,a,void 0,s),l=[0,0,0,0]),c[2]=r)):"tableHead"===m.type?(u=!0,d=r):"tableRow"===m.type||"tableDelimiterRow"===m.type?(d=r,0!==l[1]?(c[0]=c[1],s=pc(h,t,l,a,r,s)):0!==c[1]&&(s=pc(h,t,c,a,r,s)),a=0):!a||"data"!==m.type&&"tableDelimiterMarker"!==m.type&&"tableDelimiterFiller"!==m.type||(c[3]=r)}for(0!==d&&mc(h,t,d,n,i),h.consume(t.events),r=-1;++r<t.events.length;){const e=t.events[r];"enter"===e[0]&&"table"===e[1].type&&(e[1]._align=uc(t.events,r))}return e}function pc(e,t,n,i,s,r){const o=1===i?"tableHeader":2===i?"tableDelimiter":"tableData";0!==n[0]&&(r.end=Object.assign({},fc(t.events,n[0])),e.add(n[0],0,[["exit",r,t]]));const a=fc(t.events,n[1]);if(r={type:o,start:Object.assign({},a),end:Object.assign({},a)},e.add(n[1],0,[["enter",r,t]]),0!==n[2]){const s=fc(t.events,n[2]),r=fc(t.events,n[3]),o={type:"tableContent",start:Object.assign({},s),end:Object.assign({},r)};if(e.add(n[2],0,[["enter",o,t]]),2!==i){const i=t.events[n[2]],s=t.events[n[3]];if(i[1].end=Object.assign({},s[1].end),i[1].type="chunkText",i[1].contentType="text",n[3]>n[2]+1){const t=n[2]+1,i=n[3]-n[2]-1;e.add(t,i,[])}}e.add(n[3]+1,0,[["exit",o,t]])}return void 0!==s&&(r.end=Object.assign({},fc(t.events,s)),e.add(s,0,[["exit",r,t]]),r=void 0),r}function mc(e,t,n,i,s){const r=[],o=fc(t.events,n);s&&(s.end=Object.assign({},o),r.push(["exit",s,t])),i.end=Object.assign({},o),r.push(["exit",i,t]),e.add(n+1,0,r)}function fc(e,t){const n=e[t],i="enter"===n[0]?"start":"end";return n[1][i]}const gc={name:"tasklistCheck",tokenize:function(e,t,n){const i=this;return function(t){if(null!==i.previous||!i._gfmTasklistFirstContentOfListItem)return n(t);return e.enter("taskListCheck"),e.enter("taskListCheckMarker"),e.consume(t),e.exit("taskListCheckMarker"),s};function s(t){return Ge(t)?(e.enter("taskListCheckValueUnchecked"),e.consume(t),e.exit("taskListCheckValueUnchecked"),r):88===t||120===t?(e.enter("taskListCheckValueChecked"),e.consume(t),e.exit("taskListCheckValueChecked"),r):n(t)}function r(t){return 93===t?(e.enter("taskListCheckMarker"),e.consume(t),e.exit("taskListCheckMarker"),e.exit("taskListCheck"),o):n(t)}function o(i){return _e(i)?t(i):qe(i)?e.check({tokenize:yc},t,n)(i):n(i)}}};function yc(e,t,n){return Qe(e,function(e){return null===e?n(e):t(e)},"whitespace")}const vc={};function bc(e){const t=e||vc,n=this.data(),i=n.micromarkExtensions||(n.micromarkExtensions=[]),s=n.fromMarkdownExtensions||(n.fromMarkdownExtensions=[]),r=n.toMarkdownExtensions||(n.toMarkdownExtensions=[]);i.push(function(e){return Ee([{text:Kl},{document:{91:{name:"gfmFootnoteDefinition",tokenize:rc,continuation:{tokenize:oc},exit:ac}},text:{91:{name:"gfmFootnoteCall",tokenize:sc},93:{name:"gfmPotentialFootnoteCall",add:"after",tokenize:nc,resolveTo:ic}}},lc(e),{flow:{null:{name:"table",tokenize:dc,resolveAll:hc}}},{text:{91:gc}}])}(t)),s.push([{transforms:[za],enter:{literalAutolink:Ea,literalAutolinkEmail:Da,literalAutolinkHttp:Da,literalAutolinkWww:Da},exit:{literalAutolink:Oa,literalAutolinkEmail:Ra,literalAutolinkHttp:Na,literalAutolinkWww:Fa}},{enter:{gfmFootnoteCallString:_a,gfmFootnoteCall:Ga,gfmFootnoteDefinitionLabelString:qa,gfmFootnoteDefinition:$a},exit:{gfmFootnoteCallString:Za,gfmFootnoteCall:Ka,gfmFootnoteDefinitionLabelString:Qa,gfmFootnoteDefinition:Xa}},{canContainEols:["delete"],enter:{strikethrough:nl},exit:{strikethrough:il}},{enter:{table:Tl,tableData:El,tableHeader:El,tableRow:Ml},exit:{codeText:Dl,table:Al,tableData:Ll,tableHeader:Ll,tableRow:Ll}},{exit:{taskListCheckValueChecked:Rl,taskListCheckValueUnchecked:Rl,paragraph:Ol}}]),r.push(function(e){return{extensions:[{unsafe:[{character:"@",before:"[+\\-.\\w]",after:"[\\-.\\w]",inConstruct:Ma,notInConstruct:La},{character:".",before:"[Ww]",after:"[\\-.\\w]",inConstruct:Ma,notInConstruct:La},{character:":",before:"[ps]",after:"\\/",inConstruct:Ma,notInConstruct:La}]},Ya(e),{unsafe:[{character:"~",inConstruct:"phrasing",notInConstruct:tl}],handlers:{delete:sl}},Fl(e),{unsafe:[{atBreak:!0,character:"-",after:"[:|-]"}],handlers:{listItem:zl}}]}}(t))}var xc=n(34370),Sc=n(86606);const Cc=r.useSyncExternalStore?function(e){return r.useSyncExternalStore(r.useCallback(t=>{const n=null==e?void 0:e.pipe(ur(1)).subscribe(t);return()=>null==n?void 0:n.unsubscribe()},[e]),r.useCallback(()=>null==e?void 0:e.value,[e]))}:function(e){const[,t]=r.useState({}),n=r.useRef();return n.current=null==e?void 0:e.value,r.useEffect(()=>{if(!e)return;const i=e.subscribe(e=>{n.current!==e&&t({})});return()=>i.unsubscribe()},[e]),null==e?void 0:e.value};function wc(e){return Cc(e)}function kc({children:e,components:t}){return(0,o.jsxs)("div",{className:"msp-markdown",children:[(0,o.jsx)(Bc,{}),(0,o.jsx)(Ti,{skipHtml:!0,components:{a:Tc,img:Pc,...t},remarkPlugins:[bc],children:e})]})}function Bc(){const e=(0,r.useRef)(null),t=(0,r.useContext)(l.aU),n=wc(null==t?void 0:t.managers.markdownExtensions.state.audioPlayer);return(0,r.useEffect)(()=>{if(e.current)return e.current.appendChild(n),()=>{null==n||n.remove()}},[n]),n?(0,o.jsx)("div",{className:"msp-markdown-audio-player",ref:e}):null}function Pc({src:e,element:t,alt:n}){const i=(0,r.useContext)(l.aU);if(!e)return t;Ac(i);const s=null==i?void 0:i.managers.markdownExtensions.parseArgs(e);if(s){const e=null==i?void 0:i.managers.markdownExtensions.tryRender(s,jc);return null!=e?e:t}{const t=null==i?void 0:i.managers.markdownExtensions.tryResolveUri(e);if("function"==typeof(null==t?void 0:t.then))return(0,o.jsx)(Ic,{alt:n,data:t});if("string"==typeof t&&t)return(0,o.jsx)("img",{src:t,alt:n})}return(0,o.jsx)("img",{src:e,alt:n})}function Ic({alt:e,data:t}){const[n,i]=(0,r.useState)(void 0);return(0,r.useEffect)(()=>{let e=!0;return t.then(t=>{e&&i(t)}).catch(t=>{console.error("Failed to load static image",t),e&&i(void 0)}),()=>{e=!1}},[t]),n?(0,o.jsx)("img",{src:n,alt:e}):null}const jc=[{name:"color-swatch",reactRenderFn:({args:e})=>{const t=e["color-swatch"];return t?(0,o.jsx)("span",{style:{display:"inline-block",width:"0.75em",height:"0.75em",backgroundColor:t,borderRadius:"25%"}}):null}},{name:"color-palette",reactRenderFn:({args:e})=>{var t,n,i;const s=e["color-palette-name"],r=e["color-palette-colors"],a=null!==(t=e["color-palette-width"])&&void 0!==t?t:"150px",l=null!==(n=e["color-palette-height"])&&void 0!==n?n:"0.5em",c="color-palette-discrete"in e;if(!s&&!r)return null;const u=r?(0,Sc.fs)(r):null===(i=xc.VI[s.toLowerCase()])||void 0===i?void 0:i.list;return(null==u?void 0:u.length)?(0,o.jsx)("span",{style:{display:"inline-block",minWidth:a,height:l,background:(c?Sc.y8:Sc.Ch)(u),borderRadius:"2px"}}):(console.warn("Color palette could not be resolved.",e),null)}}];function Tc({href:e,children:t,element:n}){const i=(0,r.useContext)(l.aU);if(!e)return n;Ac(i);const s=null==i?void 0:i.managers.markdownExtensions.parseArgs(e);return s?(0,o.jsx)("a",{href:"#",onClick:e=>{e.preventDefault(),null==i||i.managers.markdownExtensions.tryExecute("click",s)},onMouseEnter:()=>null==i?void 0:i.managers.markdownExtensions.tryExecute("mouse-enter",s),onMouseLeave:()=>null==i?void 0:i.managers.markdownExtensions.tryExecute("mouse-leave",s),children:t}):"#"===e[0]?(Ac(i),(0,o.jsx)("a",{href:"#",onClick:t=>{t.preventDefault(),null==i||i.managers.snapshot.applyKey(e.substring(1))},children:t})):e?(0,o.jsxs)("a",{href:e,target:"_blank",rel:"noopener noreferrer",children:[t,""]}):t}function Ac(e){e||console.warn("Markdown component requires a PluginReactContext to be set.")}var Mc=n(89643),Lc=n(19299),Ec=n(3625);class Dc extends l.dL{constructor(){super(...arguments),this.state={show:!1,label:""},this.update=()=>{const e=this.plugin.state.data,t=e.selectQ(e=>e.ofTransformer(Ni.f.Model.ModelFromTrajectory));if(0===t.length)return void this.setState({show:!1});let n="",i=0;const s=new Set;for(const r of t){if(!r.sourceRef)continue;const t=e.cells.get(r.sourceRef).obj;if(t&&t.data.frameCount>1){if(s.has(r.sourceRef))return void this.setState({show:!1});if(s.add(r.sourceRef),i++,!n){const e=r.transform.params.modelIndex;n=`Model ${Math.round(e+1)} / ${t.data.frameCount}`}}}i>1&&(n=""),this.setState({show:i>0,label:n})},this.reset=()=>Fi.a.State.ApplyAction(this.plugin,{state:this.plugin.state.data,action:Di.UpdateTrajectory.create({action:"reset"})}),this.prev=()=>Fi.a.State.ApplyAction(this.plugin,{state:this.plugin.state.data,action:Di.UpdateTrajectory.create({action:"advance",by:-1})}),this.next=()=>Fi.a.State.ApplyAction(this.plugin,{state:this.plugin.state.data,action:Di.UpdateTrajectory.create({action:"advance",by:1})})}componentDidMount(){this.subscribe(this.plugin.state.data.events.changed,this.update),this.subscribe(this.plugin.behaviors.state.isAnimating,this.update)}render(){const e=this.plugin.behaviors.state.isAnimating.value;return!this.state.show||e&&!this.state.label||!this.plugin.config.get(Mr.AB.Viewport.ShowTrajectoryControls)?null:(0,o.jsxs)("div",{className:"msp-traj-controls",children:[!e&&(0,o.jsx)(Ri.K0,{svg:Oi.je,title:"First Model",onClick:this.reset,disabled:e}),!e&&(0,o.jsx)(Ri.K0,{svg:Oi.d6,title:"Previous Model",onClick:this.prev,disabled:e}),!e&&(0,o.jsx)(Ri.K0,{svg:Oi.xf,title:"Next Model",onClick:this.next,disabled:e}),!!this.state.label&&(0,o.jsx)("span",{children:this.state.label})]})}}class Nc extends l.dL{constructor(){super(...arguments),this.state={isBusy:!1,show:!0,showAnimation:!1},this.change=e=>{"none"!==e.target.value&&this.update(e.target.value)},this.prev=()=>{const e=this.plugin.managers.snapshot,t=e.getNextId(e.state.current,-1);t&&this.update(t)},this.next=()=>{const e=this.plugin.managers.snapshot,t=e.getNextId(e.state.current,1);t&&this.update(t)},this.togglePlay=()=>{this.plugin.managers.snapshot.togglePlay()},this.toggleShowAnimation=()=>{this.setState({showAnimation:!this.state.showAnimation})},this.toggleStateAnimation=()=>{this.state.isBusy?(this.plugin.managers.animation.stop(),this.plugin.managers.markdownExtensions.audio.pause()):this.plugin.managers.animation.play(Lc.c,{})}}componentDidMount(){this.subscribe(this.plugin.managers.snapshot.events.changed,()=>this.forceUpdate()),this.subscribe(this.plugin.behaviors.state.isBusy,e=>this.setState({isBusy:e})),this.subscribe(this.plugin.behaviors.state.isAnimating,e=>this.setState({isBusy:e}))}componentWillUnmount(){super.componentWillUnmount()}async update(e){this.setState({isBusy:!0}),await Fi.a.State.Snapshots.Apply(this.plugin,{id:e}),this.setState({isBusy:!1})}get isStateTransitionPlaying(){return this.plugin.managers.animation.isAnimatingStateTransition}render(){var e,t;const n=this.plugin.managers.snapshot,i=n.state.entries.size;if(!i||!this.state.show)return null;const s=n.state.current,r=n.state.isPlaying,a=n.getEntry(s),l=!!(null==a?void 0:a.snapshot.transition),c=r||this.state.isBusy&&!this.isStateTransitionPlaying;return(0,o.jsxs)("div",{className:"msp-state-snapshot-viewport-controls",children:[(0,o.jsxs)("select",{className:"msp-form-control",value:s||"none",onChange:this.change,disabled:c,children:[!s&&(0,o.jsx)("option",{value:"none"},"none"),n.state.entries.valueSeq().map((e,t)=>(0,o.jsxs)("option",{value:e.snapshot.id,children:[`[${t+1}/${i}]`," ",e.name||new Date(e.timestamp).toLocaleString()]},e.snapshot.id))]}),(0,o.jsx)(Ri.K0,{svg:r?Oi.xY:Oi.M6,title:r?"Pause":"Cycle States",onClick:this.togglePlay,disabled:!r&&(this.state.isBusy&&!this.isStateTransitionPlaying)}),!r&&(0,o.jsxs)(o.Fragment,{children:[i>1&&(0,o.jsx)(Ri.K0,{svg:Oi.d6,title:"Previous State",onClick:this.prev,disabled:c}),i>1&&(0,o.jsx)(Ri.K0,{svg:Oi.xf,title:"Next State",onClick:this.next,disabled:c}),l&&(0,o.jsx)(Ri.K0,{svg:Oi.hU,className:"msp-state-snapshot-animation-button",title:"Snapshot Transition",onClick:this.toggleShowAnimation,disabled:!l,toggleState:this.state.showAnimation})]}),l&&this.state.showAnimation&&!r&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"msp-state-snapshot-animation-slider msp-form-control",children:[(0,o.jsx)(Mc.Ap,{value:Math.round(100*(null!==(e=n.state.currentAnimationTimeMs)&&void 0!==e?e:0))/100,min:0,step:Ec.p.getMinFrameDuration(null==a?void 0:a.snapshot),max:null!==(t=Ec.p.getStateTransitionDuration(null==a?void 0:a.snapshot))&&void 0!==t?t:1e3,onChange:()=>{},onChangeImmediate:e=>n.setSnapshotAnimationFrame(e,!0),hideInput:!0,disabled:this.state.isBusy}),""]}),(0,o.jsx)(Ri.K0,{svg:this.state.isBusy?Oi.xY:Oi.ij,title:this.state.isBusy?"Stop":"Replay",onClick:this.toggleStateAnimation,toggleState:!1})]})]})}}function Fc(){var e;const t=r.useContext(l.aU),[n,i]=r.useState(0);r.useEffect(()=>{const e=t.managers.snapshot.events.changed.subscribe(()=>i(e=>e+1));return()=>e.unsubscribe()},[t]);const s=t.managers.snapshot.state.current;if(!s)return null;const a=t.managers.snapshot.getEntry(s);return(null===(e=null==a?void 0:a.description)||void 0===e?void 0:e.trim())?(0,o.jsx)("div",{id:"snapinfo",className:"msp-snapshot-description-wrapper",children:"plaintext"===a.descriptionFormat&&a.description||(0,o.jsx)(kc,{children:a.description})}):null}class Rc extends l.dL{constructor(){super(...arguments),this.state={isEmpty:!0,isExpanded:!1,isBusy:!1,isAnimating:!1,isPlaying:!1},this.toggleExpanded=()=>this.setState({isExpanded:!this.state.isExpanded}),this.stop=()=>{this.plugin.managers.animation.stop(),this.plugin.managers.snapshot.stop()}}componentDidMount(){this.subscribe(this.plugin.managers.snapshot.events.changed,()=>{this.plugin.managers.snapshot.state.isPlaying?this.setState({isPlaying:!0,isExpanded:!1}):this.setState({isPlaying:!1})}),this.subscribe(this.plugin.behaviors.state.isBusy,e=>{e?this.setState({isBusy:!0,isExpanded:!1,isEmpty:this.plugin.state.data.tree.transforms.size<2}):this.setState({isBusy:!1,isEmpty:this.plugin.state.data.tree.transforms.size<2})}),this.subscribe(this.plugin.behaviors.state.isAnimating,e=>{e?this.setState({isAnimating:!0,isExpanded:!1}):this.setState({isAnimating:!1})})}render(){const e=this.plugin.managers.snapshot.state.isPlaying;if(e||this.state.isEmpty||this.plugin.managers.animation.isEmpty||!this.plugin.config.get(Mr.AB.Viewport.ShowAnimation))return null;const t=this.state.isAnimating;return(0,o.jsxs)("div",{className:"msp-animation-viewport-controls",children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("div",{className:"msp-semi-transparent-background"}),(0,o.jsx)(Ri.K0,{svg:t||e?Oi.xY:Oi.NT,transparent:!0,title:t?"Stop":"Select Animation",onClick:t||e?this.stop:this.toggleExpanded,toggleState:this.state.isExpanded,disabled:!t&&!e&&(this.state.isBusy||this.state.isPlaying||this.state.isEmpty)})]}),this.state.isExpanded&&!this.state.isBusy&&(0,o.jsx)("div",{className:"msp-animation-viewport-controls-select",children:(0,o.jsx)(Hi,{onStart:this.toggleExpanded})})]})}}class Oc extends l.dL{componentDidMount(){this.subscribe(this.plugin.behaviors.interaction.selectionMode,()=>this.forceUpdate())}render(){return this.plugin.selectionMode?(0,o.jsx)("div",{className:"msp-selection-viewport-controls",children:(0,o.jsx)(eo,{})}):null}}class zc extends l.dL{constructor(){super(...arguments),this.state={labels:[]}}componentDidMount(){this.subscribe(this.plugin.behaviors.labels.highlight,e=>this.setState({labels:e.labels}))}render(){return 0===this.state.labels.length?null:(0,o.jsx)("div",{className:"msp-highlight-info",children:this.state.labels.map((e,t)=>e.indexOf("\n")>=0?(0,o.jsx)("div",{className:"msp-highlight-markdown-row",children:(0,o.jsx)(Ti,{skipHtml:!0,children:e})},""+t):(0,o.jsx)("div",{className:"msp-highlight-simple-row",dangerouslySetInnerHTML:{__html:e}},""+t))})}}class Hc extends l.dL{componentDidMount(){this.subscribe(this.plugin.state.behaviors.events.changed,()=>this.forceUpdate())}render(){const e=[];return this.plugin.customStructureControls.forEach((t,n)=>{e.push((0,o.jsx)(t,{initiallyCollapsed:this.props.initiallyCollapsed},n))}),e.length>0?(0,o.jsx)(o.Fragment,{children:e}):null}}class Uc extends l.dL{render(){return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"msp-section-header",children:[(0,o.jsx)(Oi.In,{svg:Oi.RZ}),"Structure Tools"]}),(0,o.jsx)(go,{}),(0,o.jsx)(oo,{}),(0,o.jsx)(ya,{}),(0,o.jsx)(wa,{}),(0,o.jsx)(gr,{}),this.plugin.config.get(Mr.AB.VolumeStreaming.Enabled)&&(0,o.jsx)(Oo,{}),(0,o.jsx)(zo,{}),(0,o.jsx)(Hc,{})]})}}var Vc=n(80031);class _c extends l.dL{get current(){return this.props.state.behaviors.currentObject.value}componentDidMount(){this.subscribe(this.plugin.state.events.object.updated,({ref:e,state:t})=>{const n=this.current;n.ref===e&&n.state===t&&this.forceUpdate()}),this.subscribe(this.plugin.state.data.actions.events.added,()=>this.forceUpdate()),this.subscribe(this.plugin.state.data.actions.events.removed,()=>this.forceUpdate())}render(){const{state:e,nodeRef:t}=this.props,n=e.cells.get(t),i=e.actions.fromCell(n,this.plugin);if(0===i.length)return null;const s=n.transform.transformer.definition,r=n.obj?n.obj.label:s.display&&s.display.name||s.name;return(0,o.jsxs)("div",{className:"msp-state-actions",children:[!this.props.hideHeader&&(0,o.jsxs)("div",{className:"msp-section-header",children:[(0,o.jsx)(Oi.In,{svg:Oi.Mm})," ",`Actions (${r})`]}),i.map((n,i)=>(0,o.jsx)(No,{state:e,action:n,nodeRef:t,initiallyCollapsed:0===i?!this.props.alwaysExpandFirst&&this.props.initiallyCollapsed:this.props.initiallyCollapsed},`${n.id}`))]})}}var Gc=n(78746),qc=n(86143),$c=n(44090);class Zc extends l.dL{render(){var e;return(0,o.jsxs)("div",{children:[(0,o.jsx)(Ri.X3,{icon:Oi.e,title:"Plugin State"}),(0,o.jsx)("div",{style:{marginBottom:"10px"},children:(0,o.jsx)(Ri.Yj,{header:"Save Options",initiallyExpanded:!1,children:(0,o.jsx)(Qc,{})})}),(0,o.jsx)(Xc,{}),(0,o.jsx)(Jc,{}),(0,o.jsx)(Ri.X3,{title:"Save as File",accent:"blue"}),(0,o.jsx)(Kc,{}),"none"!==(null===(e=this.plugin.spec.components)||void 0===e?void 0:e.remoteState)&&(0,o.jsx)(nu,{})]})}}class Kc extends l.dL{constructor(){super(...arguments),this.downloadToFileJson=()=>{var e,t;null===(t=(e=this.props).onAction)||void 0===t||t.call(e),Fi.a.State.Snapshots.DownloadToFile(this.plugin,{type:"json"})},this.downloadToFileZip=()=>{var e,t;null===(t=(e=this.props).onAction)||void 0===t||t.call(e),Fi.a.State.Snapshots.DownloadToFile(this.plugin,{type:"zip"})},this.open=e=>{var t,n;e.target.files&&e.target.files[0]?(null===(n=(t=this.props).onAction)||void 0===n||n.call(t),Fi.a.State.Snapshots.OpenFile(this.plugin,{file:e.target.files[0]})):this.plugin.log.error("No state file selected")}}render(){return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"msp-flex-row",children:[(0,o.jsx)(Ri.$n,{icon:Oi.U3,onClick:this.downloadToFileJson,title:"Save the state description. Input data are loaded using the provided sources. Does not work if local files are used as input.",children:"State"}),(0,o.jsx)(Ri.$n,{icon:Oi.U3,onClick:this.downloadToFileZip,title:"Save the state including the input data.",children:"Session"}),(0,o.jsxs)("div",{className:"msp-btn msp-btn-block msp-btn-action msp-loader-msp-btn-file",children:[(0,o.jsx)(Oi.In,{svg:Oi.sd,inline:!0})," Open ",(0,o.jsx)("input",{onChange:this.open,type:"file",multiple:!1,accept:".molx,.molj"})]})]}),(0,o.jsxs)("div",{className:"msp-help-text",style:{padding:"10px"},children:[(0,o.jsx)(Oi.In,{svg:Oi.Rf})," This is an experimental feature and stored states/sessions might not be openable in a future version."]})]})}}class Qc extends l.dL{componentDidMount(){this.subscribe(this.plugin.state.snapshotParams,()=>this.forceUpdate())}render(){return(0,o.jsx)(zi.y1,{params:Ec.p.SnapshotParams,values:this.plugin.state.snapshotParams.value,onChangeValues:this.plugin.state.setSnapshotParams})}}class Xc extends l.dL{constructor(){super(...arguments),this.state={params:Xi.t.getDefaultValues(Xc.Params)},this.add=()=>{Fi.a.State.Snapshots.Add(this.plugin,{name:this.state.params.name,description:this.state.params.description})},this.updateParams=e=>this.setState({params:e}),this.clear=()=>{Fi.a.State.Snapshots.Clear(this.plugin,{})}}shouldComponentUpdate(e,t){return!(0,a.f8)(this.props,e)||!(0,a.f8)(this.state,t)}render(){return(0,o.jsx)("div",{children:(0,o.jsx)(Yc,{parent:this})})}}function Wc(e,t,n){return!!t&&e.managers.snapshot.state.entries.some(e=>(!n||e.snapshot.id!==n)&&e.key===t)}function Yc({parent:e}){const[t,n]=r.useState({key:"",name:"",description:""}),i=()=>{Fi.a.State.Snapshots.Add(e.plugin,{key:t.key,name:t.name,description:t.description}),n({key:"",name:"",description:""})},s=Wc(e.plugin,t.key);return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(eu,{state:t,setState:n,apply:i}),(0,o.jsxs)("div",{className:"msp-flex-row",children:[(0,o.jsx)(Ri.K0,{onClick:e.clear,svg:Oi.mf,title:"Remove All"}),(0,o.jsx)(Ri.$n,{onClick:i,icon:s?void 0:Oi.CR,style:{textAlign:"right"},commit:s?"off":"on",disabled:s,children:s?"Key must be unique":"Add"})]})]})}Xc.Params={name:Xi.t.Text(),description:Xi.t.Text()};class Jc extends l.dL{constructor(){super(...arguments),this.state={editingId:void 0},this.edit=e=>{const t=e.currentTarget.getAttribute("data-id");if(!t)return;const n=this.state.editingId;this.setState({editingId:t===n?void 0:t})},this.doneEdit=()=>this.setState({editingId:void 0}),this.apply=e=>{const t=e.currentTarget.getAttribute("data-id");t&&Fi.a.State.Snapshots.Apply(this.plugin,{id:t})},this.remove=e=>{const t=e.currentTarget.getAttribute("data-id");t&&Fi.a.State.Snapshots.Remove(this.plugin,{id:t})},this.moveUp=e=>{const t=e.currentTarget.getAttribute("data-id");t&&Fi.a.State.Snapshots.Move(this.plugin,{id:t,dir:-1})},this.moveDown=e=>{const t=e.currentTarget.getAttribute("data-id");t&&Fi.a.State.Snapshots.Move(this.plugin,{id:t,dir:1})},this.replace=e=>{const t=e.currentTarget.getAttribute("data-id");t&&Fi.a.State.Snapshots.Replace(this.plugin,{id:t})}}componentDidMount(){this.subscribe(this.plugin.managers.snapshot.events.changed,()=>this.forceUpdate())}render(){const e=this.plugin.managers.snapshot.state.current,t=[];return this.plugin.managers.snapshot.state.entries.forEach(n=>{var i;t.push((0,o.jsxs)("li",{className:"msp-flex-row",children:[(0,o.jsxs)(Ri.$n,{"data-id":n.snapshot.id,onClick:this.apply,className:"msp-no-overflow",children:[(0,o.jsxs)("span",{style:{fontWeight:n.snapshot.id===e?"bold":void 0},children:[!!n.key&&`[${n.key}] `,n.name||new Date(n.timestamp).toLocaleString()]})," ",(0,o.jsx)("small",{children:`${n.snapshot.durationInMs?(0,qc.H)(n.snapshot.durationInMs,!1):""}`})]}),(0,o.jsx)(Ri.K0,{svg:Oi.Hk,"data-id":n.snapshot.id,title:"Edit",onClick:this.edit,flex:"28px"}),(0,o.jsx)(Ri.K0,{svg:Oi.p8,"data-id":n.snapshot.id,title:"Move Up",onClick:this.moveUp,flex:"20px"}),(0,o.jsx)(Ri.K0,{svg:Oi.qp,"data-id":n.snapshot.id,title:"Move Down",onClick:this.moveDown,flex:"20px"}),(0,o.jsx)(Ri.K0,{svg:Oi.sy,"data-id":n.snapshot.id,title:"Replace",onClick:this.replace,flex:"20px"}),(0,o.jsx)(Ri.K0,{svg:Oi.mf,"data-id":n.snapshot.id,title:"Remove",onClick:this.remove,flex:"20px"})]},n.snapshot.id)),this.state.editingId===n.snapshot.id&&t.push((0,o.jsx)(tu,{entry:n,plugin:this.plugin,done:this.doneEdit},`${n.snapshot.id}-edit`));const s=n.image&&(null===(i=this.plugin.managers.asset.get(n.image))||void 0===i?void 0:i.file);s&&t.push((0,o.jsx)("li",{className:"msp-state-image-row",children:(0,o.jsx)(Ri.$n,{"data-id":n.snapshot.id,onClick:this.apply,children:(0,o.jsx)("img",{draggable:!1,src:URL.createObjectURL(s)})})},`${n.snapshot.id}-image`))}),(0,o.jsx)(o.Fragment,{children:(0,o.jsx)("ul",{style:{listStyle:"none",marginTop:"10px"},className:"msp-state-list",children:t})})}}function eu({state:e,setState:t,apply:n}){const i=r.useRef(),s=r.useRef(),[a,l]=r.useState(!1);return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(Ri.eJ,{label:"Name",control:(0,o.jsx)("input",{type:"text",value:e.name,placeholder:"Name",onChange:n=>t({...e,name:n.target.value}),onKeyUp:e=>{var t;"Enter"===e.key&&(null===(t=i.current)||void 0===t||t.focus())}})}),(0,o.jsx)(Ri.eJ,{label:(0,o.jsxs)(o.Fragment,{children:["Key",(0,o.jsx)(zi.Z4,{show:a,toggle:()=>l(e=>!e)})]}),control:(0,o.jsx)("input",{type:"text",ref:i,value:e.key,placeholder:"Key (optional)",onChange:n=>t({...e,key:n.target.value}),onKeyUp:e=>{var t;"Enter"===e.key&&(null===(t=s.current)||void 0===t||t.focus())}})}),a&&(0,o.jsx)("div",{className:"msp-control-offset",children:(0,o.jsx)(zi.jH,{description:"Optional snapshot key used to activate snapshots from descriptions, labels, etc."})}),(0,o.jsx)("div",{className:"msp-flex-row msp-text-area-wrapper",style:{marginBottom:1},children:(0,o.jsx)("textarea",{ref:s,placeholder:"Markdown Description\n\n- Use [title](#key) to link to a snapshot",className:"msp-form-control",value:e.description,onChange:n=>t({...e,description:n.target.value}),onKeyUp:t=>{"Enter"===t.key&&t.ctrlKey&&n(e)}})})]})}function tu({entry:e,plugin:t,done:n}){var i,s,a;const[l,c]=r.useState({key:null!==(i=e.key)&&void 0!==i?i:"",name:null!==(s=e.name)&&void 0!==s?s:"",description:null!==(a=e.description)&&void 0!==a?a:"",descriptionFormat:e.descriptionFormat}),u=()=>{t.managers.snapshot.update(e,l),n()},d=Wc(t,l.key,e.snapshot.id);return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(eu,{state:l,setState:c,apply:u}),(0,o.jsx)("div",{className:"msp-flex-row",style:{marginBottom:1},children:(0,o.jsx)(Ri.$n,{onClick:u,icon:d?void 0:Oi.Xq,style:{textAlign:"right"},commit:d?"off":"on",disabled:d,children:d?"Key must be unique":"Apply"})})]})}class nu extends l.dL{constructor(){super(...arguments),this.Params={name:Xi.t.Text(),options:Xi.t.Group({description:Xi.t.Text(),playOnLoad:Xi.t.Boolean(!1),serverUrl:Xi.t.Text(this.plugin.config.get(Mr.AB.State.CurrentServer))})},this.state={params:Xi.t.getDefaultValues(this.Params),entries:(0,Gc.uY)(),isBusy:!1},this.ListOnlyParams={options:Xi.t.Group({serverUrl:Xi.t.Text(this.plugin.config.get(Mr.AB.State.CurrentServer))},{isFlat:!0})},this._mounted=!1,this.refresh=async()=>{try{this.setState({isBusy:!0}),this.plugin.config.set(Mr.AB.State.CurrentServer,this.state.params.options.serverUrl);const e=await this.plugin.runTask(this.plugin.fetch({url:this.serverUrl("list"),type:"json"}))||[];e.sort((e,t)=>e.isSticky===t.isSticky?e.timestamp-t.timestamp:e.isSticky?-1:1);const t=(0,Gc.uY)().asMutable();for(const n of e)t.set(n.id,{...n,url:this.serverUrl(`get/${n.id}`),removeUrl:this.serverUrl(`remove/${n.id}`)});this._mounted&&this.setState({entries:t.asImmutable(),isBusy:!1})}catch(e){console.error(e),this.plugin.log.error("Error fetching remote snapshots"),this._mounted&&this.setState({entries:(0,Gc.uY)(),isBusy:!1})}},this.upload=async()=>{this.setState({isBusy:!0}),this.plugin.config.set(Mr.AB.State.CurrentServer,this.state.params.options.serverUrl),await Fi.a.State.Snapshots.Upload(this.plugin,{name:this.state.params.name,description:this.state.params.options.description,playOnLoad:this.state.params.options.playOnLoad,serverUrl:this.state.params.options.serverUrl}),this.plugin.log.message("Snapshot uploaded."),this._mounted&&(this.setState({isBusy:!1}),this.refresh())},this.fetch=async e=>{const t=e.currentTarget.getAttribute("data-id");if(!t)return;const n=this.state.entries.get(t);if(n){this.setState({isBusy:!0});try{await Fi.a.State.Snapshots.Fetch(this.plugin,{url:n.url})}finally{this._mounted&&this.setState({isBusy:!1})}}},this.remove=async e=>{const t=e.currentTarget.getAttribute("data-id");if(!t)return;const n=this.state.entries.get(t);if(n){this.setState({entries:this.state.entries.remove(t)});try{await fetch(n.removeUrl)}catch(e){console.error(e)}}}}componentDidMount(){this.refresh(),this._mounted=!0}componentWillUnmount(){super.componentWillUnmount(),this._mounted=!1}serverUrl(e){return e?(0,$c.r)(this.state.params.options.serverUrl,e):this.state.params.options.serverUrl}render(){return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(Ri.X3,{title:"Remote States",accent:"blue"}),!this.props.listOnly&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(zi.y1,{params:this.Params,values:this.state.params,onEnter:this.upload,onChange:e=>{this.setState({params:{...this.state.params,[e.name]:e.value}})},isDisabled:this.state.isBusy}),(0,o.jsxs)("div",{className:"msp-flex-row",children:[(0,o.jsx)(Ri.K0,{onClick:this.refresh,disabled:this.state.isBusy,svg:Oi.ij}),(0,o.jsx)(Ri.$n,{icon:Oi.XI,onClick:this.upload,disabled:this.state.isBusy,commit:!0,children:"Upload"})]})]}),(0,o.jsx)(iu,{entries:this.state.entries,isBusy:this.state.isBusy,serverUrl:this.state.params.options.serverUrl,fetch:this.fetch,remove:this.props.listOnly?void 0:this.remove}),this.props.listOnly&&(0,o.jsxs)("div",{style:{marginTop:"10px"},children:[(0,o.jsx)(zi.y1,{params:this.ListOnlyParams,values:this.state.params,onEnter:this.upload,onChange:e=>{this.setState({params:{...this.state.params,[e.name]:e.value}})},isDisabled:this.state.isBusy}),(0,o.jsx)("div",{className:"msp-flex-row",children:(0,o.jsx)(Ri.$n,{onClick:this.refresh,disabled:this.state.isBusy,icon:Oi.ij,children:"Refresh"})})]})]})}}class iu extends l.jB{constructor(){super(...arguments),this.open=async e=>{const t=e.currentTarget.getAttribute("data-id");if(!t)return;const n=this.props.entries.get(t);if(!n)return;e.preventDefault();let i=`${window.location}`;const s=i.indexOf("?");s>0&&(i=i.substr(0,s)),window.open(`${i}?snapshot-url=${encodeURIComponent(n.url)}`,"_blank")}}render(){return(0,o.jsx)("ul",{style:{listStyle:"none",marginTop:"10px"},className:"msp-state-list",children:this.props.entries.valueSeq().map(e=>(0,o.jsxs)("li",{className:"msp-flex-row",children:[(0,o.jsxs)(Ri.$n,{"data-id":e.id,onClick:this.props.fetch,disabled:this.props.isBusy,onContextMenu:this.open,title:"Click to download, right-click to open in a new tab.",children:[e.name||new Date(e.timestamp).toLocaleString()," ",(0,o.jsx)("small",{children:e.description})]}),!e.isSticky&&this.props.remove&&(0,o.jsx)(Ri.K0,{svg:Oi.mf,"data-id":e.id,title:"Remove",onClick:this.props.remove,disabled:this.props.isBusy,small:!0})]},e.id))})}}var su=n(73876),ru=n(12198);class ou extends l.dL{constructor(){super(...arguments),this.state={showActions:!0}}componentDidMount(){this.subscribe(this.plugin.state.events.cell.created,e=>{e.cell.transform.parent===Yi.Cn.RootRef&&this.forceUpdate()}),this.subscribe(this.plugin.state.events.cell.removed,e=>{e.parent===Yi.Cn.RootRef&&this.forceUpdate()})}static getDerivedStateFromProps(e,t){const n=e.state.tree.root.ref,i=0===e.state.tree.children.get(n).size;return t.showActions===i?null:{showActions:i}}render(){const e=this.props.state.tree.root.ref;return this.state.showActions?(0,o.jsxs)("div",{style:{margin:"10px",cursor:"default"},children:[(0,o.jsx)("p",{children:"Nothing to see here yet."}),(0,o.jsxs)("p",{children:["Structures and Volumes can be loaded from the ",(0,o.jsx)(Oi.In,{svg:Oi.yf})," tab."]})]}):(0,o.jsx)(au,{cell:this.props.state.cells.get(e),depth:0})}}class au extends l.dL{constructor(){super(...arguments),this.state={isCollapsed:!!this.props.cell.state.isCollapsed,isNull:au.isNull(this.props.cell),showLabel:au.showLabel(this.props.cell)}}is(e){return e.ref===this.ref&&e.state===this.props.cell.parent}get ref(){return this.props.cell.transform.ref}componentDidMount(){this.subscribe(this.plugin.state.events.cell.stateUpdated,e=>{this.props.cell===e.cell&&this.is(e)&&e.state.cells.has(this.ref)&&(this.state.isCollapsed===!!e.cell.state.isCollapsed&&this.state.isNull===au.isNull(e.cell)&&this.state.showLabel===au.showLabel(e.cell)||this.forceUpdate())}),this.subscribe(this.plugin.state.events.cell.created,e=>{this.props.cell.parent===e.state&&this.ref===e.cell.transform.parent&&this.forceUpdate()}),this.subscribe(this.plugin.state.events.cell.removed,e=>{this.props.cell.parent===e.state&&this.ref===e.parent&&this.forceUpdate()})}static getDerivedStateFromProps(e,t){const n=au.isNull(e.cell),i=au.showLabel(e.cell);return!!e.cell.state.isCollapsed===t.isCollapsed&&t.isNull===n&&t.showLabel===i?null:{isCollapsed:!!e.cell.state.isCollapsed,isNull:n,showLabel:i}}static hasDecorator(e){var t;const n=e.parent.tree.children.get(e.transform.ref);if(1!==n.size)return!1;const i=n.first();return!!i&&!!(null===(t=e.parent)||void 0===t?void 0:t.tree.transforms.get(i).transformer.definition.isDecorator)}static isNull(e){return!e||!e.parent||e.obj===Yi.BM.Null||!e.parent.tree.transforms.has(e.transform.ref)}static showLabel(e){return e.transform.ref!==Yi.Cn.RootRef&&("ok"!==e.status||!e.state.isGhost&&!au.hasDecorator(e))}render(){if(this.state.isNull)return null;const e=this.props.cell,t=e.parent.tree.children.get(this.ref);if(!this.state.showLabel)return 0===t.size?null:(0,o.jsx)(o.Fragment,{children:t.map(t=>(0,o.jsx)(au,{cell:e.parent.cells.get(t),depth:this.props.depth},t))});const n=this.props.depth+1;return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(lu,{cell:e,depth:this.props.depth}),0===t.size?void 0:(0,o.jsx)("div",{style:{display:this.state.isCollapsed?"none":"block"},children:t.map(t=>(0,o.jsx)(au,{cell:e.parent.cells.get(t),depth:n},t))})]})}}class lu extends l.dL{constructor(){super(...arguments),this.state={isCurrent:this.props.cell.parent.current===this.ref,isCollapsed:!!this.props.cell.state.isCollapsed,action:void 0,currentAction:void 0},this.setCurrent=e=>{null==e||e.preventDefault(),null==e||e.currentTarget.blur(),Fi.a.State.SetCurrentObject(this.plugin,{state:this.props.cell.parent,ref:this.ref})},this.setCurrentRoot=e=>{null==e||e.preventDefault(),null==e||e.currentTarget.blur(),this.props.cell.parent&&Fi.a.State.SetCurrentObject(this.plugin,{state:this.props.cell.parent,ref:Yi.Cn.RootRef})},this.remove=e=>{null==e||e.preventDefault(),Fi.a.State.RemoveObject(this.plugin,{state:this.props.cell.parent,ref:this.ref,removeParentGhosts:!0})},this.toggleVisible=e=>{e.preventDefault(),Fi.a.State.ToggleVisibility(this.plugin,{state:this.props.cell.parent,ref:this.ref}),e.currentTarget.blur()},this.toggleExpanded=e=>{e.preventDefault(),Fi.a.State.ToggleExpanded(this.plugin,{state:this.props.cell.parent,ref:this.ref}),e.currentTarget.blur()},this.highlight=e=>{e.preventDefault(),Fi.a.Interactivity.Object.Highlight(this.plugin,{state:this.props.cell.parent,ref:this.ref}),e.currentTarget.blur()},this.clearHighlight=e=>{e.preventDefault(),Fi.a.Interactivity.ClearHighlights(this.plugin),e.currentTarget.blur()},this.hideApply=()=>{this.setCurrentRoot()},this.selectAction=e=>{e&&(null==e?void 0:e.value)()}}is(e){return e.ref===this.ref&&e.state===this.props.cell.parent}get ref(){return this.props.cell.transform.ref}componentDidMount(){this.subscribe(this.plugin.state.events.cell.stateUpdated.pipe((0,cr.p)(e=>this.is(e)),(0,su.B)(33)),e=>{this.forceUpdate()}),this.subscribe(this.props.cell.parent.behaviors.currentObject,e=>{this.is(e)?e.state.transforms.has(this.ref)&&this._setCurrent(this.props.cell.parent.current===this.ref,!!this.props.cell.state.isCollapsed):this.state.isCurrent&&e.state.transforms.has(this.ref)&&this._setCurrent(this.props.cell.parent.current===this.ref,this.state.isCollapsed)})}_setCurrent(e,t){e?this.setState({isCurrent:e,action:"options",currentAction:void 0,isCollapsed:t}):this.setState({isCurrent:e,action:void 0,currentAction:void 0,isCollapsed:t})}static getDerivedStateFromProps(e,t){const n=e.cell.parent.current===e.cell.transform.ref,i=!!e.cell.state.isCollapsed;return t.isCollapsed===i&&t.isCurrent===n?null:{isCurrent:n,isCollapsed:i,action:void 0,currentAction:void 0}}get actions(){const e=this.props.cell,t=[...e.parent.actions.fromCell(e,this.plugin)];if(0!==t.length)return t.sort((e,t)=>e.definition.display.name<t.definition.display.name?-1:e.definition.display.name===t.definition.display.name?0:1),[or.W.Header("Apply Action"),...t.map(e=>or.W.Item(e.definition.display.name,()=>this.setState({action:"apply",currentAction:e})))]}updates(e){const t=this.props.cell,n=ru.P.getDecoratorChain(t.parent,t.transform.ref),i=[];for(let s=n.length-1;s>=0;s--){const r=n[s];i.push((0,o.jsx)(pr,{state:t.parent,transform:r.transform,noMargin:!0,wrapInExpander:!0,expanderHeaderLeftMargin:e},`${r.transform.transformer.id}-${s}`))}return(0,o.jsx)("div",{className:"msp-tree-updates-wrapper",children:i})}render(){const e=this.props.cell,t=e.transform;if(!e)return null;const n=this.is(e.parent.behaviors.currentObject.value),i="error"!==e.status&&"ok"!==e.status;let s;if("error"!==e.status&&e.obj){const t=e.obj,n=`${t.label} ${t.description?t.description:""}`;s=(0,o.jsxs)(Ri.$n,{className:`msp-btn-tree-label msp-type-class-${t.type.typeClass}`,noOverflow:!0,disabled:i,title:n,onClick:this.state.isCurrent?this.setCurrentRoot:this.setCurrent,children:[(0,o.jsx)("span",{children:t.label})," ",t.description?(0,o.jsx)("small",{children:t.description}):void 0]})}else{const n="error"===e.status?e.errorText:t.transformer.definition.display.name;s=(0,o.jsxs)(Ri.$n,{className:"msp-btn-tree-label msp-no-hover-outline",noOverflow:!0,title:n,onClick:this.state.isCurrent?this.setCurrentRoot:this.setCurrent,disabled:i,children:["error"===e.status&&(0,o.jsxs)("b",{children:["[",e.status,"]"]})," ",(0,o.jsx)("span",{children:n})]})}const r=e.parent.tree.children.get(this.ref),a=e.state,l=(0,o.jsx)(Ri.K0,{svg:a.isCollapsed?Oi.Cp:Oi.DM,flex:"20px",disabled:i,onClick:this.toggleExpanded,transparent:!0,className:"msp-no-hover-outline",style:{visibility:r.size>0?"visible":"hidden"}}),c=e.state.isLocked?void 0:(0,o.jsx)(Ri.K0,{svg:Oi.mf,onClick:this.remove,disabled:i,small:!0,toggleState:!1}),u=(0,o.jsx)(Ri.K0,{svg:a.isHidden?Oi.qF:Oi.zs,toggleState:!1,disabled:i,small:!0,onClick:this.toggleVisible}),d={marginLeft:8*this.props.depth+"px"},h=(0,o.jsxs)("div",{className:"msp-flex-row msp-tree-row"+(n?" msp-tree-row-current":""),onMouseEnter:this.highlight,onMouseLeave:this.clearHighlight,style:d,children:[l,s,c,u]});if(!n)return h;if("apply"===this.state.action&&this.state.currentAction)return(0,o.jsxs)("div",{style:{marginBottom:"1px"},children:[h,(0,o.jsx)(Ri.tW,{header:`Apply ${this.state.currentAction.definition.display.name}`,initialExpanded:!0,hideExpander:!0,hideOffset:!1,onHeaderClick:this.hideApply,topRightIcon:Oi.X6,headerLeftMargin:8*this.props.depth+21+"px",children:(0,o.jsx)(No,{onApply:this.hideApply,state:this.props.cell.parent,action:this.state.currentAction,nodeRef:this.props.cell.transform.ref,hideHeader:!0,noMargin:!0})})]});if("options"===this.state.action){const e=this.actions,t=this.updates(8*this.props.depth+21+"px");return(0,o.jsxs)("div",{style:{marginBottom:"1px"},children:[h,t,e&&(0,o.jsx)("div",{style:{marginLeft:8*this.props.depth+21+"px",marginTop:"-1px"},children:(0,o.jsx)(or.W,{items:e,onSelect:this.selectAction})})]})}return h}}class cu extends l.dL{componentDidMount(){this.subscribe(this.plugin.state.behaviors.events.changed,()=>this.forceUpdate())}render(){const e=[];return this.plugin.customImportControls.forEach((t,n)=>{e.push((0,o.jsx)(t,{initiallyCollapsed:this.props.initiallyCollapsed},n))}),e.length>0?(0,o.jsx)(o.Fragment,{children:e}):null}}class uu extends l.dL{constructor(){var e;super(...arguments),this.state={tab:this.plugin.behaviors.layout.leftPanelTabName.value},this.set=e=>{if(this.state.tab===e)return this.setState({tab:"none"},()=>this.plugin.behaviors.layout.leftPanelTabName.next("none")),void Fi.a.Layout.Update(this.plugin,{state:{regionState:{...this.plugin.layout.state.regionState,left:"collapsed"}}});this.setState({tab:e},()=>this.plugin.behaviors.layout.leftPanelTabName.next(e)),"full"!==this.plugin.layout.state.regionState.left&&Fi.a.Layout.Update(this.plugin,{state:{regionState:{...this.plugin.layout.state.regionState,left:"full"}}})},this.tabs={none:(0,o.jsx)(o.Fragment,{}),root:(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(Ri.X3,{icon:Oi.yf,title:"Home"}),(0,o.jsx)(_c,{state:this.plugin.state.data,nodeRef:Yi.Cn.RootRef,hideHeader:!0,initiallyCollapsed:!0,alwaysExpandFirst:!0}),(0,o.jsx)(cu,{}),"none"!==(null===(e=this.plugin.spec.components)||void 0===e?void 0:e.remoteState)&&(0,o.jsx)(nu,{listOnly:!0})]}),data:(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(Ri.X3,{icon:Oi.ID,title:(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(pu,{})," State Tree"]})}),(0,o.jsx)(ou,{state:this.plugin.state.data})]}),states:(0,o.jsx)(Zc,{}),settings:(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(Ri.X3,{icon:Oi.Hk,title:"Plugin Settings"}),(0,o.jsx)(hu,{})]}),help:(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(Ri.X3,{icon:Oi.ml,title:"Help"}),(0,o.jsx)(Xr,{})]})}}componentDidMount(){this.subscribe(this.plugin.behaviors.layout.leftPanelTabName,e=>{this.state.tab!==e&&this.setState({tab:e}),"none"===e&&"collapsed"!==this.plugin.layout.state.regionState.left&&Fi.a.Layout.Update(this.plugin,{state:{regionState:{...this.plugin.layout.state.regionState,left:"collapsed"}}})}),this.subscribe(this.plugin.state.data.events.changed,({state:e})=>{"data"===this.state.tab&&1===e.cells.size&&this.set("root")})}render(){const e=this.state.tab;return(0,o.jsxs)("div",{className:"msp-left-panel-controls",children:[(0,o.jsxs)("div",{className:"msp-left-panel-controls-buttons",children:[(0,o.jsx)(Ri.K0,{svg:Oi.yf,toggleState:"root"===e,transparent:!0,onClick:()=>this.set("root"),title:"Home"}),(0,o.jsx)(du,{set:this.set}),(0,o.jsx)(Ri.K0,{svg:Oi.e,toggleState:"states"===e,transparent:!0,onClick:()=>this.set("states"),title:"Plugin State"}),(0,o.jsx)(Ri.K0,{svg:Oi.ml,toggleState:"help"===e,transparent:!0,onClick:()=>this.set("help"),title:"Help"}),(0,o.jsx)("div",{className:"msp-left-panel-controls-buttons-bottom",children:(0,o.jsx)(Ri.K0,{svg:Oi.Hk,toggleState:"settings"===e,transparent:!0,onClick:()=>this.set("settings"),title:"Settings"})})]}),(0,o.jsx)("div",{className:"msp-scrollable-container",children:this.tabs[e]})]})}}class du extends l.dL{constructor(){super(...arguments),this.state={changed:!1}}get tab(){return this.plugin.behaviors.layout.leftPanelTabName.value}componentDidMount(){this.subscribe(this.plugin.behaviors.layout.leftPanelTabName,e=>{"data"===this.tab?this.setState({changed:!1}):this.forceUpdate()}),this.subscribe(this.plugin.state.data.events.changed,e=>{"data"!==this.tab&&this.setState({changed:!0})})}render(){return(0,o.jsx)(Ri.K0,{svg:Oi.ID,toggleState:"data"===this.tab,transparent:!0,onClick:()=>this.props.set("data"),title:"State Tree",style:{position:"relative"},extraContent:this.state.changed?(0,o.jsx)("div",{className:"msp-left-panel-controls-button-data-dirty"}):void 0})}}class hu extends l.dL{constructor(){super(...arguments),this.setSettings=e=>{Fi.a.Canvas3D.SetSettings(this.plugin,{settings:{[e.name]:e.value}})},this.setCanvas3DContextProps=e=>{var t;null===(t=this.plugin.canvas3dContext)||void 0===t||t.setProps({[e.name]:e.value}),this.plugin.events.canvas3d.settingsUpdated.next(void 0)}}componentDidMount(){this.subscribe(this.plugin.events.canvas3d.settingsUpdated,()=>this.forceUpdate()),this.subscribe(this.plugin.layout.events.updated,()=>this.forceUpdate()),this.plugin.canvas3d&&this.subscribe(this.plugin.canvas3d.camera.stateChanged.pipe((0,Ro.c)(500,void 0,{leading:!0,trailing:!0})),e=>{void 0===e.radiusMax&&void 0===e.radius||this.forceUpdate()})}render(){return(0,o.jsxs)(o.Fragment,{children:[this.plugin.canvas3d&&this.plugin.canvas3dContext&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(Ri.X3,{title:"Viewport"}),(0,o.jsx)(zi.y1,{params:Vc._i,values:this.plugin.canvas3d.props,onChange:this.setSettings}),(0,o.jsx)(zi.y1,{params:Vc.H7.Params,values:this.plugin.canvas3dContext.props,onChange:this.setCanvas3DContextProps})]}),(0,o.jsx)(Ri.X3,{title:"Behavior"}),(0,o.jsx)(ou,{state:this.plugin.state.behaviors})]})}}class pu extends l.dL{constructor(){super(...arguments),this.remove=e=>{e.preventDefault(),Fi.a.State.RemoveObject(this.plugin,{state:this.plugin.state.data,ref:Yi.Cn.RootRef})}}componentDidMount(){this.subscribe(this.plugin.state.events.cell.created,e=>{e.cell.transform.parent===Yi.Cn.RootRef&&this.forceUpdate()}),this.subscribe(this.plugin.state.events.cell.removed,e=>{e.parent===Yi.Cn.RootRef&&this.forceUpdate()})}render(){return 0===this.plugin.state.data.tree.children.get(Yi.Cn.RootRef).size?null:(0,o.jsx)(Ri.K0,{svg:Oi.mf,onClick:this.remove,title:"Remove All",style:{display:"inline-block"},small:!0,className:"msp-no-hover-outline",transparent:!0})}}var mu=n(47079);const fu={selected:"rgb(51, 255, 25)",highlighted:"rgb(255, 102, 153)",focused:""};class gu extends l.dL{constructor(){super(...arguments),this.parentDiv=r.createRef(),this.lastMouseOverSeqIdx=-1,this.highlightQueue=new Fo.B,this.markerColors={...fu},this.customColorThemeWrapper=void 0,this.customColorFunction=void 0,this.lociHighlightProvider=(e,t)=>{this.props.sequenceWrapper.markResidue(e.loci,t)&&this.updateMarker()},this.lociSelectionProvider=(e,t)=>{this.props.sequenceWrapper.markResidue(e.loci,t)&&this.updateMarker()},this.contextMenu=e=>{e.preventDefault()},this.mouseDownLoci=void 0,this.mouseDown=e=>{e.stopPropagation();const t=this.getSeqIdx(e),n=this.getLoci(t);this.mouseDownLoci=n},this.mouseUp=e=>{if(e.stopPropagation(),void 0===this.mouseDownLoci)return;const t=this.getSeqIdx(e),n=this.getLoci(t);if(n){const t=(0,mu.Y7)(e.nativeEvent),i=(0,mu.vq)(e.nativeEvent),s=(0,mu.RN)(e.nativeEvent);let r=n;if(!Gi.iZ.Loci.areEqual(this.mouseDownLoci,n)){const e=this.mouseDownLoci.elements[0],t=n.elements[0],i=Math.min(ho.CD.min(e.indices),ho.CD.min(t.indices)),s=Math.max(ho.CD.max(e.indices),ho.CD.max(t.indices));r=Gi.iZ.Loci(n.structure,[{unit:e.unit,indices:ho.CD.ofRange(i,s)}])}this.click(r,t,i,s)}this.mouseDownLoci=void 0},this.location=Gi.iZ.Location.create(void 0),this.mouseMove=e=>{e.stopPropagation();const t=(0,mu.Y7)(e.nativeEvent),n=(0,mu.vq)(e.nativeEvent),i=(0,mu.RN)(e.nativeEvent),s=e.target;if(!s||!s.getAttribute){if(-1===this.lastMouseOverSeqIdx)return;return this.lastMouseOverSeqIdx=-1,void this.highlightQueue.next({seqIdx:-1,buttons:t,button:n,modifiers:i})}const r=s.hasAttribute("data-seqid")?+s.getAttribute("data-seqid"):-1;if(this.lastMouseOverSeqIdx!==r)if(this.lastMouseOverSeqIdx=r,void 0!==this.mouseDownLoci){const e=this.getLoci(r);this.hover(e,mu.qt.Flag.None,mu.qt.Flag.None,i)}else this.highlightQueue.next({seqIdx:r,buttons:t,button:n,modifiers:i})},this.mouseLeave=e=>{if(e.stopPropagation(),this.mouseDownLoci=void 0,-1===this.lastMouseOverSeqIdx)return;this.lastMouseOverSeqIdx=-1;const t=(0,mu.Y7)(e.nativeEvent),n=(0,mu.vq)(e.nativeEvent),i=(0,mu.RN)(e.nativeEvent);this.highlightQueue.next({seqIdx:-1,buttons:t,button:n,modifiers:i})}}get sequenceNumberPeriod(){if(void 0!==this.props.sequenceNumberPeriod)return this.props.sequenceNumberPeriod;if(this.props.sequenceWrapper.length>10)return 10;return this.getSequenceNumber(this.props.sequenceWrapper.length-1).length>1?5:1}componentDidMount(){this.plugin.managers.interactivity.lociHighlights.addProvider(this.lociHighlightProvider),this.plugin.managers.interactivity.lociSelects.addProvider(this.lociSelectionProvider),this.subscribe(this.highlightQueue.pipe((0,Ro.c)(3*16.666,void 0,{leading:!0,trailing:!0})),e=>{const t=this.getLoci(e.seqIdx<0?void 0:e.seqIdx);this.hover(t,e.buttons,e.button,e.modifiers)}),this.subscribe(this.plugin.managers.structure.focus.behaviors.current,e=>{this.updateFocus(null==e?void 0:e.loci),this.updateMarker()}),this.updateColors(),Fi.a.Canvas3D.SetSettings.subscribe(this.plugin,()=>{this.updateColors(),this.updateMarker()});const e=this.plugin.customUIState.experimentalSequenceColorTheme;e&&this.subscribe(e,e=>{(e||this.customColorThemeWrapper)&&(this.customColorThemeWrapper=function(e,t,n){const i=Gi.iZ.Location.create();function s(e,t,n){const s=e.getLoci(t);if(!s||Gi.iZ.Loci.isEmpty(s))return"";Gi.iZ.Loci.getFirstLocation(s,i);const r=n(i,!1);return r<0?"":es.Q1.toHexStyle(r)}const r=(0,ar._)(i=>{var r,o,a;if(!t)return;const l=null===(r=i.getLoci(0))||void 0===r?void 0:r.structure;if(!l)return;let c;const u=null!==(a=null===(o=t.getProps)||void 0===o?void 0:o.call(t,{structure:l}))&&void 0!==a?a:t.provider.defaultValues;t.provider.ensureCustomProperties?e.runTask(Zi.YZ.create("Attach custom properties for coloring theme",async i=>{var s;try{await(null===(s=t.provider.ensureCustomProperties)||void 0===s?void 0:s.attach({assetManager:e.managers.asset,runtime:i},{structure:l}))}catch(r){console.warn(`Failed to attach custom properties needed for coloring theme ${t.provider.name}:`,r)}finally{c=t.provider.factory({structure:l},u).color,n()}})):c=t.provider.factory({structure:l},u).color;const d={};return e=>{var t;return c?null!==(t=d[e])&&void 0!==t?t:d[e]=s(i,e,c):""}});return{themeName:null==t?void 0:t.provider.name,getColorFunction:r}}(this.plugin,e,()=>this.forceUpdate()),this.forceUpdate())})}updateColors(){this.plugin.canvas3d?(this.markerColors.highlighted=es.Q1.toHexStyle(this.plugin.canvas3d.props.renderer.highlightColor),this.markerColors.selected=es.Q1.toHexStyle(this.plugin.canvas3d.props.renderer.selectColor)):(this.markerColors.highlighted=fu.highlighted,this.markerColors.selected=fu.selected)}updateFocus(e){this.props.sequenceWrapper.markResidue(ts.FE,"unfocus"),e&&this.props.sequenceWrapper.markResidue(e,"focus")}componentWillUnmount(){super.componentWillUnmount(),this.plugin.managers.interactivity.lociHighlights.removeProvider(this.lociHighlightProvider),this.plugin.managers.interactivity.lociSelects.removeProvider(this.lociSelectionProvider)}getLoci(e){if(void 0!==e){const t=this.props.sequenceWrapper.getLoci(e);if(!Gi.iZ.Loci.isEmpty(t))return t}}getSeqIdx(e){let t;const n=e.target;return n&&n.getAttribute&&(t=n.hasAttribute("data-seqid")?+n.getAttribute("data-seqid"):void 0),t}hover(e,t,n,i){const s={current:Er.YL.Loci.Empty,buttons:t,button:n,modifiers:i};if(void 0!==e&&!Gi.iZ.Loci.isEmpty(e)&&(s.current={loci:e},this.mouseDownLoci)){const t=this.mouseDownLoci.elements[0],n=e.elements[0],i=Math.min(ho.CD.min(t.indices),ho.CD.min(n.indices)),r=Math.max(ho.CD.max(t.indices),ho.CD.max(n.indices)),o=Gi.iZ.Loci(e.structure,[{unit:t.unit,indices:ho.CD.ofRange(i,r)}]);s.current={loci:o}}this.plugin.behaviors.interaction.hover.next(s)}click(e,t,n,i){const s={current:Er.YL.Loci.Empty,buttons:t,button:n,modifiers:i};void 0===e||Gi.iZ.Loci.isEmpty(e)||(s.current={loci:e}),this.plugin.behaviors.interaction.click.next(s)}getBackgroundColor(e){const t=this.props.sequenceWrapper;return t.isHighlighted(e)&&this.markerColors.highlighted?this.markerColors.highlighted:t.isSelected(e)&&this.markerColors.selected?this.markerColors.selected:t.isFocused(e)&&this.markerColors.focused?this.markerColors.focused:this.customColorFunction?this.customColorFunction(e):""}getResidueClass(e,t){const n=this.props.sequenceWrapper,i=[n.residueClass(e)];return t.length>1&&i.push(0===e?"msp-sequence-residue-long-begin":"msp-sequence-residue-long"),n.isHighlighted(e)&&i.push("msp-sequence-residue-highlighted"),n.isSelected(e)&&i.push("msp-sequence-residue-selected"),n.isFocused(e)&&i.push("msp-sequence-residue-focused"),i.join(" ")}residue(e,t){return(0,o.jsx)("span",{"data-seqid":e,style:{backgroundColor:this.getBackgroundColor(e)},className:this.getResidueClass(e,t),children:`${t}`},e)}getSequenceNumberClass(e,t,n){const i=["msp-sequence-number"];return t.startsWith("-")?n.length>1&&e>0?i.push("msp-sequence-number-long-negative"):i.push("msp-sequence-number-negative"):n.length>1&&e>0&&i.push("msp-sequence-number-long"),i.join(" ")}getSequenceNumber(e){let t="";const n=this.props.sequenceWrapper.getLoci(e),i=Gi.iZ.Loci.getFirstLocation(n,this.location);if(i)if(Gi.Nf.isAtomic(i.unit)){const e=Gi.ZP.residue.auth_seq_id(i),n=Gi.ZP.residue.pdbx_PDB_ins_code(i);t=`${e}${n||""}`}else Gi.Nf.isCoarse(i.unit)&&(t=`${e+1}`);return t}padSeqNum(e){return e.length<5?e+new Array(5-e.length+1).join(""):e}getSequenceNumberSpan(e,t){const n=this.getSequenceNumber(e);return(0,o.jsx)("span",{className:this.getSequenceNumberClass(e,n,t),children:this.padSeqNum(n)},`marker-${e}`)}updateMarker(){if(!this.parentDiv.current)return;const e=this.parentDiv.current.children,t=!this.props.hideSequenceNumbers,n=this.sequenceNumberPeriod,i=this.props.sequenceWrapper,s=i.length;let r=0;for(let o=0;o<s;o++){t&&o%n===0&&o<s&&r++;const a=e[r];if(!a)return;r++;const l=this.getResidueClass(o,i.residueLabel(o));a.className!==l&&(a.className=l);const c=this.getBackgroundColor(o);a.style.backgroundColor!==c&&(a.style.backgroundColor=c)}}render(){var e;const t=this.props.sequenceWrapper,n=[];this.customColorThemeWrapper&&(this.customColorFunction=this.customColorThemeWrapper.getColorFunction(t));const i=!this.props.hideSequenceNumbers,s=this.sequenceNumberPeriod;for(let r=0,o=t.length;r<o;++r){const e=t.residueLabel(r);i&&r%s===0&&r<o&&(n[n.length]=this.getSequenceNumberSpan(r,e)),n[n.length]=this.residue(r,e)}return this.updateFocus(null===(e=this.plugin.managers.structure.focus.behaviors.current.value)||void 0===e?void 0:e.loci),this.updateMarker(),(0,o.jsx)("div",{className:"msp-sequence-wrapper",onContextMenu:this.contextMenu,onMouseDown:this.mouseDown,onMouseUp:this.mouseUp,onMouseMove:this.mouseMove,onMouseLeave:this.mouseLeave,ref:this.parentDiv,children:n})}}class yu{mark(e,t){const n=this.getSeqIndices(e);return 0!==ho.CD.size(n)&&(0,Dr.BH)(this.markerArray,n,t)}markResidue(e,t){return"focus"===t?this.markResidueFocus(e,!0):"unfocus"===t?this.markResidueFocus(e,!1):(0,ts.xc)(e)?(0,Dr.BH)(this.markerArray,ho.IX.ofLength(this.length),t):this.mark(e,t)}markResidueFocus(e,t){const n=t?1:0;if((0,ts.xc)(e))return this.focusMarkerArray.fill(n,0,this.length),!0;{const t=this.getSeqIndices(e);return ho.CD.forEach(t,e=>this.focusMarkerArray[e]=n),ho.CD.size(t)>0}}isHighlighted(e){return!!(1&this.markerArray[e])}isSelected(e){return!!(2&this.markerArray[e])}isFocused(e){return!!this.focusMarkerArray[e]}constructor(e,t){this.data=e,this.length=t,this.markerArray=new Uint8Array(t),this.focusMarkerArray=new Uint8Array(t)}}class vu extends yu{seqId(e){return this.sequence.seqId.value(e)}residueLabel(e){return this.sequence.label.value(e)||this.sequence.code.value(e)}residueColor(e){return this.missing.has(this.modelNum,this.asymId,this.seqId(e))?Ki.s.grey:Ki.s.black}residueClass(e){return this.missing.has(this.modelNum,this.asymId,this.seqId(e))?"msp-sequence-missing":"msp-sequence-present"}getSeqIndices(e){const{structure:t}=this.data,n=e=>this.sequence.index(e);if(Gi.iZ.Loci.is(e)){if(!Gi.Structure.areRootsEquivalent(e.structure,t))return ho.IX.Empty;e=Gi.iZ.Loci.remap(e,t);const i=[];for(const t of e.elements)this.unitMap.has(t.unit.id)&&(Gi.Nf.isAtomic(t.unit)?bu(i,t,n):xu(i,t,n));return ho.X9.deduplicate(ho.X9.ofSortedArray(i))}return Gi.Structure.isLoci(e)&&Gi.Structure.areRootsEquivalent(e.structure,t)?this.observed:ho.IX.Empty}getLoci(e){const t=(n=this.data.units[0].chainGroupId,i=this.data.units[0].conformation.operator.name,s=this.seqId(e),Gi.RT.generators.atoms({unitTest:e=>Gi.ZP.unit.chainGroupId(e.element)===n&&Gi.ZP.unit.operator_name(e.element)===i,residueTest:e=>e.element.unit.kind===Gi.Nf.Kind.Atomic?Gi.ZP.residue.label_seq_id(e.element)===s:Gi.ZP.coarse.seq_id_begin(e.element)<=s&&Gi.ZP.coarse.seq_id_end(e.element)>=s}));var n,i,s;return Gi.cv.toLociWithSourceUnits(Gi.Oz.run(t,this.data.structure))}constructor(e){const t=Gi.iZ.Location.create(e.structure,e.units[0],e.units[0].elements[0]),n=e.units[0].model.sequence.byEntityKey[Gi.ZP.entity.key(t)],i=n.sequence.length;super(e,i),this.unitMap=new Map;for(const r of e.units)this.unitMap.set(r.id,r);this.sequence=n.sequence,this.missing=e.units[0].model.properties.missingResidues,this.modelNum=e.units[0].model.modelNum,this.asymId=Gi.Nf.isAtomic(e.units[0])?Gi.ZP.chain.label_asym_id(t):Gi.ZP.coarse.asym_id(t);const s=[];for(let r=0;r<i;++r)this.missing.has(this.modelNum,this.asymId,this.seqId(r))&&s.push(r);this.observed=ho.CD.subtract(ho.IX.ofBounds(0,i),ho.X9.ofSortedArray(s))}}function bu(e,t,n){const{model:i,elements:s}=t.unit,{index:r}=i.atomicHierarchy.residueAtomSegments,{label_seq_id:o}=i.atomicHierarchy.residues;return ho.CD.forEachSegment(t.indices,e=>r[s[e]],t=>{const i=o.value(t),s=n(i);e.push(s)}),!0}function xu(e,t,n){const{model:i,elements:s}=t.unit,r=Gi.Nf.isSpheres(t.unit)?i.coarseHierarchy.spheres.seq_id_begin:i.coarseHierarchy.gaussians.seq_id_begin,o=Gi.Nf.isSpheres(t.unit)?i.coarseHierarchy.spheres.seq_id_end:i.coarseHierarchy.gaussians.seq_id_end;return ho.CD.forEach(t.indices,t=>{const i=s[t];for(let s=n(r.value(i)),a=n(o.value(i));s<=a;s++)e.push(s)}),!0}class Su extends yu{residueLabel(e){return this.sequence[e]}residueColor(e){return Ki.s.black}residueClass(e){return"msp-sequence-present"}getSeqIndices(e){const{structure:t}=this.data;if(Gi.iZ.Loci.is(e)){if(!Gi.Structure.areRootsEquivalent(e.structure,t))return ho.IX.Empty;e=Gi.iZ.Loci.remap(e,t);const n=[];for(const t of e.elements){const e=this.unitMap.get(t.unit.id);if(e){const{index:i}=t.unit.model.atomicHierarchy.residueAtomSegments;ho.CD.forEach(t.indices,t=>{const s=this.sequenceIndices.get(i[e.elements[t]]);void 0!==s&&n.push(s)})}}return ho.X9.deduplicate(ho.X9.ofSortedArray(n))}return Gi.Structure.isLoci(e)&&Gi.Structure.areRootsEquivalent(e.structure,t)?ho.IX.ofBounds(0,this.length):ho.IX.Empty}getLoci(e){const t=[],n=this.residueIndices.get(e);if(void 0!==n){const i=this.seqToUnit.get(e),{offsets:s}=i.model.atomicHierarchy.residueAtomSegments,r=ho.X9.findPredecessorIndex(i.elements,s[n]),o=ho.X9.findPredecessorIndex(i.elements,s[n+1]);t.push({unit:i,indices:ho.IX.ofBounds(r,o)})}return Gi.iZ.Loci(this.data.structure,t)}constructor(e){const t=[],n=new Map,i=new Map,s=new Map;for(let r=0,o=e.units.length;r<o;++r){const o=e.units[r],{residueAtomSegments:a,atoms:l}=o.model.atomicHierarchy,c=ho.hT.transientSegments(a,o.elements);for(;c.hasNext;){const{index:e}=c.move();n.set(e,t.length),i.set(t.length,e),s.set(t.length,o),t.push(l.label_comp_id.value(a.offsets[e]))}}super(e,t.length),this.unitMap=new Map;for(const r of e.units)this.unitMap.set(r.id,r);this.sequence=t,this.sequenceIndices=n,this.residueIndices=i,this.seqToUnit=s}}class Cu extends yu{residueLabel(e){return this.label}residueColor(e){return Ki.s.black}residueClass(e){return"msp-sequence-present"}getSeqIndices(e){const{structure:t}=this.data;if(Gi.iZ.Loci.is(e)){if(!Gi.Structure.areRootsEquivalent(e.structure,t))return ho.IX.Empty;e=Gi.iZ.Loci.remap(e,t);for(const t of e.elements){const e=this.unitIndices.get(t.unit.id);if(e&&ho.CD.isSubset(e,t.indices))return ho.IX.ofSingleton(0)}}else if(Gi.Structure.isLoci(e))return Gi.Structure.areRootsEquivalent(e.structure,t)?ho.IX.ofSingleton(0):ho.IX.Empty;return ho.IX.Empty}getLoci(e){return this.loci}constructor(e){let t=0,n=0;const i=[],s=Gi.iZ.Location.create(e.structure),r=new Map,o=[];for(let a=0,l=e.units.length;a<l;++a){const i=e.units[a];Gi.iZ.Location.set(s,e.structure,i,i.elements[0]);const l=i.model.sequence.byEntityKey[Gi.ZP.entity.key(s)];l&&(t+=l.sequence.length),n+=i.elements.length;const c=ho.IX.ofBounds(0,i.elements.length);r.set(i.id,c),o.push({unit:i,indices:c})}t>0&&i.push(`${t} residues`),i.push(`${n} elements`);super(e,1),this.label=`Whole Chain (${i.join(", ")})`,this.unitIndices=r,this.loci=Gi.iZ.Loci(this.data.structure,o)}}class wu extends yu{residueLabel(e){return"X"}residueColor(e){return Ki.s.black}residueClass(e){return"msp-sequence-present"}getSeqIndices(e){const{structure:t,units:n}=this.data;if(Gi.iZ.Loci.is(e)){if(!Gi.Structure.areRootsEquivalent(e.structure,t))return ho.IX.Empty;e=Gi.iZ.Loci.remap(e,t);for(const t of e.elements){const e=this.unitIndices.get(t.unit.id);if(e&&ho.CD.isSubset(e,t.indices))return t.indices}}else if(Gi.Structure.isLoci(e)){if(!Gi.Structure.areRootsEquivalent(e.structure,t))return ho.IX.Empty;for(let e=0,t=n.length;e<t;++e){return this.unitIndices.get(n[e].id)}}return ho.IX.Empty}getLoci(e){const{units:t}=this.data,n=[];let i=0;for(let s=0,r=t.length;s<r;++s){const r=t[s];if(e<i+r.elements.length){n.push({unit:r,indices:ho.IX.ofSingleton(e-i)});break}i+=r.elements.length}return Gi.iZ.Loci(this.data.structure,n)}constructor(e){let t=0;const n=new Map,i=[];for(let s=0,r=e.units.length;s<r;++s){const r=e.units[s];t+=r.elements.length;const o=ho.IX.ofBounds(0,r.elements.length);n.set(r.id,o),i.push({unit:r,indices:o})}super(e,t),this.unitIndices=n}}const ku=5e3,Bu=1e3;function Pu(e){const t=Gi.ZP.unit.pdbx_struct_oper_list_ids(e),n=Gi.ZP.unit.struct_ncs_oper_id(e),i=Gi.ZP.unit.hkl(e),s=Gi.ZP.unit.spgrOp(e);return`${t.sort().join(",")}|${n}|${i}|${s}`}function Iu(e){const[t,n]=e.split("|");return[parseInt(t),n]}function ju(e,t){const{structure:n,modelEntityId:i,chainGroupId:s,operatorKey:r}=e,o=Gi.iZ.Location.create(n),[a,l]=Iu(i),c=[];for(const u of n.units)Gi.iZ.Location.set(o,n,u,u.elements[0]),n.getModelIndex(u.model)===a&&Gi.ZP.entity.id(o)===l&&u.chainGroupId===s&&Pu(o)===r&&c.push(u);if(c.length>0){const e={structure:n,units:c},i=c[0];let s;if(i.polymerElements.length){const t=Gi.iZ.Location.create(n,i,i.elements[0]),r=i.model.sequence.byEntityKey[Gi.ZP.entity.key(t)];if(r&&r.sequence.length<=ku)s=new vu(e);else{const t=c.reduce((e,t)=>e+t.polymerElements.length,0);s=Gi.Nf.isAtomic(i)||t>ku?new Cu(e):new wu(e)}}else if(Gi.Nf.isAtomic(i)){const t=c.reduce((e,t)=>e+t.residueCount,0);s=t>ku?new Cu(e):new Su(e)}else console.warn("should not happen, expecting coarse units to be polymeric"),s=new Cu(e);return s.markResidue(t.getLoci(n),Dr.xi.Select),s}return"No sequence available"}function Tu(e,t=!1){const n=[],i=Gi.iZ.Location.create(e),s=new Set;for(const r of e.units){Gi.iZ.Location.set(i,e,r,r.elements[0]);const o=Gi.ZP.entity.id(i),a=e.getModelIndex(r.model),l=`${a}|${o}`;if(s.has(l))continue;if(t&&"polymer"!==Gi.ZP.entity.type(i))continue;let c=Gi.ZP.entity.pdbx_description(i).join(", ");e.models.length&&(e.representativeModel?c+=` (Model ${e.models[a].modelNum})`:c.startsWith("Polymer ")&&(c+=` (${e.models[a].entry})`));const u=`${o}: ${c}`;if(n.push([l,u]),s.add(l),n.length>Bu)return[["","Too many entities"]]}return 0===n.length&&n.push(["","No entities"]),n}function Au(e,t){const n=[],i=Gi.iZ.Location.create(e),s=new Set,[r,o]=Iu(t);for(const a of e.units){if(Gi.iZ.Location.set(i,e,a,a.elements[0]),e.getModelIndex(a.model)!==r)continue;if(Gi.ZP.entity.id(i)!==o)continue;const t=a.chainGroupId;if(s.has(t))continue;const l=(0,Lr.BB)(i,{granularity:"chain",hidePrefix:!0,htmlStyling:!1});if(n.push([t,l]),s.add(t),n.length>Bu)return[[-1,"Too many chains"]]}return 0===n.length&&n.push([-1,"No chains"]),n}function Mu(e,t,n){const i=[],s=Gi.iZ.Location.create(e),r=new Set,[o,a]=Iu(t);for(const l of e.units){if(Gi.iZ.Location.set(s,e,l,l.elements[0]),e.getModelIndex(l.model)!==o)continue;if(Gi.ZP.entity.id(s)!==a)continue;if(l.chainGroupId!==n)continue;const t=Pu(s);if(r.has(t))continue;const c=l.conformation.operator.name;if(i.push([t,c]),r.add(t),i.length>Bu)return[["","Too many operators"]]}return 0===i.length&&i.push(["","No operators"]),i}function Lu(e){var t;const n=[],i=[],s=e.select(Yi.QX.Generators.rootsOfType(Ls.O.Molecule.Structure));for(const r of s)(null===(t=r.obj)||void 0===t?void 0:t.data)&&(i.push(r.obj.data),n.push([r.transform.ref,r.obj.data.label]));return 0===n.length&&n.push(["","No structure"]),{options:n,all:i}}const Eu=Xi.t.Select("single",[["single","Chain"],["polymers","Polymers"],["all","Everything"]]);class Du extends l.dL{constructor(){super(...arguments),this.state={structureOptions:{options:[],all:[]},structure:Gi.Structure.Empty,structureRef:"",modelEntityId:"",chainGroupId:-1,operatorKey:"",mode:"single",sequenceViewModeParam:Eu},this.setParamProps=e=>{const t={...this.state};switch(e.name){case"mode":if(t.mode=e.value,this.state.mode===t.mode)return;if("all"===t.mode||"polymers"===t.mode)break;case"structure":"structure"===e.name&&(t.structureRef=e.value),t.structure=this.getStructure(t.structureRef),t.modelEntityId=Tu(t.structure)[0][0],t.chainGroupId=Au(t.structure,t.modelEntityId)[0][0],t.operatorKey=Mu(t.structure,t.modelEntityId,t.chainGroupId)[0][0];break;case"entity":t.modelEntityId=e.value,t.chainGroupId=Au(t.structure,t.modelEntityId)[0][0],t.operatorKey=Mu(t.structure,t.modelEntityId,t.chainGroupId)[0][0];break;case"chain":t.chainGroupId=e.value,t.operatorKey=Mu(t.structure,t.modelEntityId,t.chainGroupId)[0][0];break;case"operator":t.operatorKey=e.value}this.setState(t)}}componentDidMount(){var e,t;this.plugin.state.data.select(Yi.QX.Generators.rootsOfType(Ls.O.Molecule.Structure)).length>0&&this.setState(this.getInitialState()),this.subscribe(this.plugin.state.events.object.updated,({ref:e,obj:t})=>{e===this.state.structureRef&&t&&t.type===Ls.O.Molecule.Structure.type&&t.data!==this.state.structure&&this.sync()}),this.subscribe(this.plugin.state.events.object.created,({obj:e})=>{e&&e.type===Ls.O.Molecule.Structure.type&&this.sync()}),this.subscribe(this.plugin.state.events.object.removed,({obj:e})=>{e&&e.type===Ls.O.Molecule.Structure.type&&this.sync()});const n=null===(t=null===(e=this.plugin.spec.components)||void 0===e?void 0:e.sequenceViewer)||void 0===t?void 0:t.modeOptions;if(n){const e=new Set(n),t={...Eu,options:Eu.options.filter(([t])=>e.has(t))};this.setState({sequenceViewModeParam:t})}}sync(){const e=Lu(this.plugin.state.data);(0,wr.af)(e.all,this.state.structureOptions.all)||this.setState(this.getInitialState())}getStructure(e){const t=this.plugin.state.data.select(e)[0];return e&&t&&t.obj?t.obj.data:Gi.Structure.Empty}getSequenceWrapper(e){return{wrapper:ju(this.state,this.plugin.managers.structure.selection),label:`${Xi.t.optionLabel(e.chain,this.state.chainGroupId)} | ${Xi.t.optionLabel(e.entity,this.state.modelEntityId)}`}}getSequenceWrappers(e){if("single"===this.state.mode)return[this.getSequenceWrapper(e)];const t=this.getStructure(this.state.structureRef),n=[];for(const[i,s]of Tu(t,"polymers"===this.state.mode))for(const[e,r]of Au(t,i))for(const[o]of Mu(t,i,e))if(n.push({wrapper:ju({structure:t,modelEntityId:i,chainGroupId:e,operatorKey:o},this.plugin.managers.structure.selection),label:`${r} | ${s}`}),n.length>30)return[];return n}getInitialState(){var e,t,n,i;const s=Lu(this.plugin.state.data),r=s.options[0][0],o=this.getStructure(r);let a=Tu(o)[0][0],l=Au(o,a)[0][0],c=Mu(o,a,l)[0][0];this.state.structure&&this.state.structure===o&&(a=this.state.modelEntityId,l=this.state.chainGroupId,c=this.state.operatorKey);const u=null===(t=null===(e=this.plugin.spec.components)||void 0===e?void 0:e.sequenceViewer)||void 0===t?void 0:t.defaultMode;return{structureOptions:s,structure:o,structureRef:r,modelEntityId:a,chainGroupId:l,operatorKey:c,mode:null!==(i=null!==(n=this.props.defaultMode)&&void 0!==n?n:u)&&void 0!==i?i:"single",sequenceViewModeParam:this.state.sequenceViewModeParam}}get params(){const{structureOptions:e,structure:t,modelEntityId:n,chainGroupId:i}=this.state,s=Tu(t),r=Au(t,n),o=Mu(t,n,i);return{structure:Xi.t.Select(e.options[0][0],e.options,{shortLabel:!0}),entity:Xi.t.Select(s[0][0],s,{shortLabel:!0}),chain:Xi.t.Select(r[0][0],r,{shortLabel:!0,twoColumns:!0,label:"Chain"}),operator:Xi.t.Select(o[0][0],o,{shortLabel:!0,twoColumns:!0}),mode:this.state.sequenceViewModeParam}}get values(){return{structure:this.state.structureRef,entity:this.state.modelEntityId,chain:this.state.chainGroupId,operator:this.state.operatorKey,mode:this.state.mode}}render(){if(this.getStructure(this.state.structureRef)===Gi.Structure.Empty)return(0,o.jsx)("div",{className:"msp-sequence",children:(0,o.jsxs)("div",{className:"msp-sequence-select",children:[(0,o.jsx)(Oi.In,{svg:Oi.ml,style:{cursor:"help",position:"absolute",right:0,top:0},title:"Shows a sequence of one or more chains. Use the controls to alter selection."}),(0,o.jsx)("span",{children:"Sequence"}),(0,o.jsx)("span",{style:{fontWeight:"normal"},children:"No structure available"})]})});const e=this.params,t=this.values,n=this.getSequenceWrappers(e);return(0,o.jsxs)("div",{className:"msp-sequence",children:[(0,o.jsxs)("div",{className:"msp-sequence-select",children:[(0,o.jsx)(Oi.In,{svg:Oi.ml,style:{cursor:"help",position:"absolute",right:0,top:0},title:"This shows a single sequence. Use the controls to show a different sequence. \nUse Ctrl or Cmd key to add a sequence range to focus; use Shift key to extend last focused/selected range."}),(0,o.jsx)("span",{children:"Sequence of"}),(0,o.jsx)(zi.UT,{title:`[Structure] ${Xi.t.optionLabel(e.structure,t.structure)}`,param:e.structure,name:"structure",value:t.structure,onChange:this.setParamProps}),(0,o.jsx)(zi.UT,{title:"[Mode]",param:this.state.sequenceViewModeParam,name:"mode",value:t.mode,onChange:this.setParamProps}),"single"===t.mode&&(0,o.jsx)(zi.UT,{title:`[Entity] ${Xi.t.optionLabel(e.entity,t.entity)}`,param:e.entity,name:"entity",value:t.entity,onChange:this.setParamProps}),"single"===t.mode&&(0,o.jsx)(zi.UT,{title:`[Chain] ${Xi.t.optionLabel(e.chain,t.chain)}`,param:e.chain,name:"chain",value:t.chain,onChange:this.setParamProps}),e.operator.options.length>1&&(0,o.jsx)(o.Fragment,{children:(0,o.jsx)(zi.UT,{title:`[Instance] ${Xi.t.optionLabel(e.operator,t.operator)}`,param:e.operator,name:"operator",value:t.operator,onChange:this.setParamProps})})]}),(0,o.jsx)(Nu,{children:n.map((e,n)=>{const i="string"==typeof e.wrapper?(0,o.jsx)("div",{className:"msp-sequence-wrapper",children:e.wrapper},n):(0,o.jsx)(gu,{sequenceWrapper:e.wrapper},n);return"single"===t.mode?i:(0,o.jsxs)(r.Fragment,{children:[(0,o.jsx)("div",{className:"msp-sequence-chain-label",children:e.label}),i]},n)})})]})}}function Nu({children:e}){return(0,o.jsx)("div",{className:"msp-sequence-wrapper-non-empty",children:e})}function Fu(){const e=(0,r.useContext)(l.aU),[t,n]=(0,r.useState)((0,Gc.uY)());return(0,r.useEffect)(()=>{const t=e.events.task.progress.subscribe(t=>{var i;const s=!!(null===(i=e.spec.components)||void 0===i?void 0:i.hideTaskOverlay);"background"!==t.level||!s&&t.useOverlay||n(e=>e.set(t.id,t))}),i=e.events.task.finished.subscribe(({id:e})=>{n(t=>t.delete(e))});return()=>{t.unsubscribe(),i.unsubscribe()}},[e]),(0,o.jsxs)("div",{className:"msp-background-tasks",children:[t.valueSeq().map(e=>(0,o.jsx)(Ou,{event:e},e.id)),(0,o.jsx)(Ru,{})]})}function Ru(){var e;const t=wc(null===(e=(0,r.useContext)(l.aU).canvas3d)||void 0===e?void 0:e.commitQueueSize);return t?(0,o.jsx)("div",{className:"msp-task-state",children:(0,o.jsx)("div",{children:(0,o.jsxs)("div",{children:["Commiting renderables... ",t," remaining"]})})}):null}class Ou extends l.dL{constructor(){super(...arguments),this.abort=()=>{this.plugin.managers.task.requestAbort(this.props.event.progress.root.progress.taskId,"User Request")}}render(){const e=this.props.event.progress.root,t=zu(this.props.event.progress.root)-1,n=e.progress.isIndeterminate?void 0:(0,o.jsxs)(o.Fragment,{children:["[",e.progress.current,"/",e.progress.max,"]"]}),i=t>0?(0,o.jsxs)(o.Fragment,{children:["[",t," subtask(s)]"]}):void 0;return(0,o.jsx)("div",{className:"msp-task-state",children:(0,o.jsxs)("div",{children:[e.progress.canAbort&&(0,o.jsx)(Ri.K0,{svg:Oi.VH,onClick:this.abort,title:"Abort"}),(0,o.jsxs)("div",{children:[e.progress.message," ",n," ",i]})]})})}}function zu(e){if(0===e.children.length)return 1;let t=0;for(const n of e.children)t+=zu(n);return t}function Hu(){const e=(0,r.useContext)(l.aU),[t,n]=(0,r.useState)((0,Gc.uY)());return(0,r.useEffect)(()=>{const t=e.events.task.progress.subscribe(e=>{e.useOverlay&&n(t=>t.set(e.id,e))}),i=e.events.task.finished.subscribe(({id:e})=>{n(t=>t.delete(e))});return()=>{t.unsubscribe(),i.unsubscribe()}},[e]),0===t.size?null:(0,o.jsx)("div",{className:"msp-overlay-tasks",children:t.valueSeq().map(e=>(0,o.jsx)(Ou,{event:e},e.id))})}class Uu extends l.dL{constructor(){super(...arguments),this.hide=()=>{(this.props.entry.hide||function(){}).call(null)}}render(){const e=this.props.entry,t="string"==typeof e.message?(0,o.jsx)("div",{dangerouslySetInnerHTML:{__html:e.message}}):(0,o.jsx)("div",{children:(0,o.jsx)(e.message,{})});return(0,o.jsxs)("div",{className:"msp-toast-entry",children:[(0,o.jsx)("div",{className:"msp-toast-title",onClick:()=>this.hide(),children:e.title}),(0,o.jsx)("div",{className:"msp-toast-message",children:t}),(0,o.jsx)("div",{className:"msp-toast-clear"}),(0,o.jsx)("div",{className:"msp-toast-hide",children:(0,o.jsx)(Ri.K0,{svg:Oi.VH,onClick:this.hide,title:"Hide",className:"msp-no-hover-outline"})})]})}}class Vu extends l.dL{componentDidMount(){this.subscribe(this.plugin.managers.toast.events.changed,()=>this.forceUpdate())}render(){const e=this.plugin.managers.toast.state;if(!e.entries.count())return null;const t=[];return e.entries.forEach((e,n)=>t.push(e)),t.sort(function(e,t){return e.serialNumber-t.serialNumber}),(0,o.jsx)("div",{className:"msp-toast-container",children:t.map(e=>(0,o.jsx)(Uu,{entry:e},e.serialNumber))})}}class _u extends l.dL{constructor(){super(...arguments),this.container=r.createRef(),this.mounted=!1,this.state={noWebGl:!1,showLogo:!0},this.handleLogo=()=>{var e;this.setState({showLogo:!(null===(e=this.plugin.canvas3d)||void 0===e?void 0:e.reprCount.value)})}}async applyMount(){try{const e=await this.plugin.mountAsync(this.container.current,{checkeredCanvasBackground:!0});if(!this.mounted)return;e||this.setState({noWebGl:!0}),this.handleLogo(),this.subscribe(this.plugin.canvas3d.reprCount,this.handleLogo)}catch(e){console.error(e),this.setState({noWebGl:!0})}}componentDidMount(){this.mounted=!0,this.container.current?this.applyMount():this.setState({noWebGl:!0})}componentWillUnmount(){this.mounted=!1,super.componentWillUnmount(),this.plugin.unmount()}renderMissing(){if(this.props.noWebGl){const e=this.props.noWebGl;return(0,o.jsx)(e,{})}return(0,o.jsx)("div",{className:"msp-no-webgl",children:(0,o.jsxs)("div",{children:[(0,o.jsx)("p",{children:(0,o.jsx)("b",{children:"WebGL does not seem to be available."})}),(0,o.jsx)("p",{children:"This can be caused by an outdated browser, graphics card driver issue, or bad weather. Sometimes, just restarting the browser helps. Also, make sure hardware acceleration is enabled in your browser."}),(0,o.jsxs)("p",{children:["For a list of supported browsers, refer to ",(0,o.jsx)("a",{href:"http://caniuse.com/#feat=webgl",target:"_blank",children:"http://caniuse.com/#feat=webgl"}),"."]})]})})}render(){if(this.state.noWebGl)return this.renderMissing();const e=this.props.logo;return(0,o.jsx)("div",{className:this.props.parentClassName||"msp-viewport",style:this.props.parentStyle,ref:this.container,children:this.state.showLogo&&e&&(0,o.jsx)(e,{})})}}const Gu=r.memo(e=>{const{plugin:t,cropFrameColor:n}=e,i=t.helpers.viewportScreenshot,[s,a]=(0,r.useState)(null),l=(0,r.useRef)(null),c=(0,r.useRef)(e);return(0,r.useEffect)(()=>{c.current=e},Object.values(e)),(0,r.useEffect)(()=>{s!==l.current&&a(l.current)}),(0,r.useEffect)(()=>{var e;let n=!1;const s=[];function r(e,t){e&&s.push(e.subscribe(t))}function o(){const e=c.current;!e.suspend&&l.current&&qu(t,i,l.current,e.customBackground,e.borderColor,e.borderWidth),l.current||(n=!0)}const a=setInterval(()=>{n&&(n=!1,o())},125);let u;r(t.events.canvas3d.settingsUpdated,()=>n=!0),r(null===(e=t.canvas3d)||void 0===e?void 0:e.didDraw,()=>n=!0),r(t.state.data.behaviors.isUpdating,e=>{e||(n=!0)}),r(null==i?void 0:i.behaviors.values,()=>n=!0),r(null==i?void 0:i.behaviors.cropParams,()=>n=!0),"undefined"!=typeof ResizeObserver&&(u=new ResizeObserver(()=>n=!0));const d=l.current;return null==u||u.observe(d),o(),()=>{clearInterval(a),s.forEach(e=>e.unsubscribe()),null==u||u.unobserve(d)}},[i]),(0,r.useLayoutEffect)(()=>{l.current&&qu(t,i,l.current,e.customBackground,e.borderColor,e.borderWidth)},[...Object.values(e)]),(0,o.jsx)(o.Fragment,{children:(0,o.jsxs)("div",{style:{position:"relative",width:"100%",height:"100%"},children:[(0,o.jsx)("canvas",{ref:l,onContextMenu:e=>{e.preventDefault(),e.stopPropagation()},style:{display:"block",width:"100%",height:"100%"}}),(0,o.jsx)($u,{plugin:t,canvas:s,color:n})]})})},(e,t)=>(0,Qi.bN)(e,t));async function qu(e,t,n,i,s,r){const o=Zi.YZ.create("Render Screenshot",async e=>{if(!t)return;const o=await t.getPreview(e);if(!o)return;const a=n.getContext("2d");if(!a)return;const{canvas:l,width:c,height:u}=o,d=n.clientWidth,h=n.clientHeight;n.width=d,n.height=h,a.clearRect(0,0,d,h);const p=Ku(c,u,d,h);if(i)a.fillStyle=i,a.fillRect(p.x,p.y,p.width,p.height);else if(t.values.transparent){const e=13;for(let t=0;t<p.width;t+=e)for(let n=0;n<p.height;n+=e){a.fillStyle=(t+n)%2?"#ffffff":"#bfbfbf";const i=p.x+t,s=p.y+n,r=t+e>p.width?p.width-t:e,o=n+e>p.height?p.height-n:e;a.fillRect(i,s,r,o)}}if(a.drawImage(l,p.x,p.y,p.width,p.height),s&&r){const e=r;a.rect(p.x,p.y,p.width,p.height),a.rect(p.x+e,p.y+e,p.width-2*e,p.height-2*e),a.fillStyle=s,a.fill("evenodd")}});return e.runTask(o,{useOverlay:!0})}function $u({plugin:e,canvas:t,color:n="rgba(255, 87, 45, 0.75)"}){var i;const s=e.helpers.viewportScreenshot,a=wc(null==s?void 0:s.behaviors.values),l=wc(null==s?void 0:s.behaviors.cropParams),c=wc(null==s?void 0:s.behaviors.relativeCrop),u=(0,r.useRef)({x:0,y:0,width:0,height:0});wc("viewport"===(null==a?void 0:a.resolution.name)?null===(i=e.canvas3d)||void 0===i?void 0:i.resized:void 0);const[d,h]=r.useState(""),[p,m]=(0,r.useState)([0,0]),[f,g]=(0,r.useState)([0,0]);if(!s||!t||!c)return null;const{width:y,height:v}=s.getSizeAndViewport(),b=Ku(y,v,t.clientWidth,t.clientHeight),x={x:b.x+Math.floor(b.width*c.x),y:b.y+Math.floor(b.height*c.y),width:Math.ceil(b.width*c.width),height:Math.ceil(b.height*c.height)},S=Zu(x),C=Zu(b);if("move"===d?(S.l+=f[0]-p[0],S.r+=f[0]-p[0],S.t+=f[1]-p[1],S.b+=f[1]-p[1]):d&&(d.indexOf("left")>=0?S.l+=f[0]-p[0]:d.indexOf("right")>=0&&(S.r+=f[0]-p[0]),d.indexOf("top")>=0?S.t+=f[1]-p[1]:d.indexOf("bottom")>=0&&(S.b+=f[1]-p[1])),S.l>S.r){const e=S.l;S.l=S.r,S.r=e}if(S.t>S.b){const e=S.t;S.t=S.b,S.b=e}S.l=Math.min(C.r-40,Math.max(C.l,S.l)),S.r=Math.max(C.l+40,Math.min(C.r,S.r)),S.t=Math.min(C.b-40,Math.max(C.t,S.t)),S.b=Math.max(C.t+40,Math.min(C.b,S.b)),x.x=S.l,x.y=S.t,x.width=S.r-S.l+1,x.height=S.b-S.t+1,u.current=x;const w=e=>{e.preventDefault(),g([e.pageX,e.pageY])},k=e=>{e.preventDefault();const t=e.touches[0];g([t.pageX,t.pageY])},B=e=>{e.preventDefault(),h(e.currentTarget.getAttribute("data-drag"));const t=e.touches[0],n=[t.pageX,t.pageY];m(n),g(n),window.addEventListener("touchend",j),window.addEventListener("touchmove",k)},P=e=>{e.preventDefault(),h(e.currentTarget.getAttribute("data-drag"));const t=[e.pageX,e.pageY];m(t),g(t),window.addEventListener("mouseup",I),window.addEventListener("mousemove",w)},I=()=>{window.removeEventListener("mouseup",I),window.removeEventListener("mousemove",w),T()},j=()=>{window.removeEventListener("touchend",j),window.removeEventListener("touchmove",k),T()};function T(){const e=u.current;(null==l?void 0:l.auto)&&(null==s||s.behaviors.cropParams.next({...l,auto:!1})),null==s||s.behaviors.relativeCrop.next({x:(e.x-b.x)/b.width,y:(e.y-b.y)/b.height,width:e.width/b.width,height:e.height/b.height}),h("");const t=[0,0];m(t),g(t)}const A=e=>{e.preventDefault(),e.stopPropagation()},M=`3px solid ${n}`,L="transparent";return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("div",{"data-drag":"move",style:{position:"absolute",left:x.x,top:x.y,width:x.width,height:x.height,border:M,cursor:"move"},onMouseDown:P,onTouchStart:B,draggable:!1,onContextMenu:A}),(0,o.jsx)("div",{"data-drag":"left",style:{position:"absolute",left:x.x-4,top:x.y+4,width:16,height:x.height-4,background:L,cursor:"w-resize"},onMouseDown:P,onTouchStart:B,draggable:!1,onContextMenu:A}),(0,o.jsx)("div",{"data-drag":"right",style:{position:"absolute",left:S.r-8,top:x.y,width:16,height:x.height-4,background:L,cursor:"w-resize"},onMouseDown:P,onTouchStart:B,draggable:!1,onContextMenu:A}),(0,o.jsx)("div",{"data-drag":"top",style:{position:"absolute",left:x.x-4,top:x.y-4,width:x.width+8,height:16,background:L,cursor:"n-resize"},onMouseDown:P,onTouchStart:B,draggable:!1,onContextMenu:A}),(0,o.jsx)("div",{"data-drag":"bottom",style:{position:"absolute",left:x.x-4,top:S.b-8,width:x.width+8,height:16,background:L,cursor:"n-resize"},onMouseDown:P,onTouchStart:B,draggable:!1,onContextMenu:A}),(0,o.jsx)("div",{"data-drag":"top, left",style:{position:"absolute",left:S.l-4,top:S.t-4,width:16,height:16,background:L,cursor:"nw-resize"},onMouseDown:P,onTouchStart:B,draggable:!1,onContextMenu:A}),(0,o.jsx)("div",{"data-drag":"bottom, right",style:{position:"absolute",left:S.r-8,top:S.b-8,width:16,height:16,background:L,cursor:"nw-resize"},onMouseDown:P,onTouchStart:B,draggable:!1,onContextMenu:A}),(0,o.jsx)("div",{"data-drag":"top, right",style:{position:"absolute",left:S.r-8,top:S.t-4,width:16,height:16,background:L,cursor:"ne-resize"},onMouseDown:P,onTouchStart:B,draggable:!1,onContextMenu:A}),(0,o.jsx)("div",{"data-drag":"bottom, left",style:{position:"absolute",left:S.l-4,top:S.b-8,width:16,height:16,background:L,cursor:"ne-resize"},onMouseDown:P,onTouchStart:B,draggable:!1,onContextMenu:A})]})}function Zu(e){return{l:e.x,t:e.y,r:e.x+e.width-1,b:e.y+e.height-1}}function Ku(e,t,n,i){const s=e/t;if(s<=n/i){const e=i*s;return{x:Math.round((n-e)/2),y:0,width:Math.round(e),height:i}}{const e=n/s;return{x:0,y:Math.round((i-e)/2),width:n,height:Math.round(e)}}}function Qu(e,t){return"orthographic"===e?1/(2*Math.tan(t/2)):1/(2*Math.sin(t/2))}class Xu extends l.dL{constructor(){super(...arguments),this.state={showPreview:!0,isDisabled:!1},this.download=()=>{var e;null===(e=this.plugin.helpers.viewportScreenshot)||void 0===e||e.download(),this.props.close()},this.copy=async()=>{var e;try{await(null===(e=this.plugin.helpers.viewportScreenshot)||void 0===e?void 0:e.copyToClipboard()),Fi.a.Toast.Show(this.plugin,{message:"Copied to clipboard.",title:"Screenshot",timeoutMs:1500})}catch(t){return this.copyImg()}},this.copyImg=async()=>{var e;const t=await(null===(e=this.plugin.helpers.viewportScreenshot)||void 0===e?void 0:e.getImageDataUri());this.setState({imageData:t})},this.open=e=>{e.target.files&&e.target.files[0]&&Fi.a.State.Snapshots.OpenFile(this.plugin,{file:e.target.files[0]})}}componentDidMount(){this.subscribe(this.plugin.state.data.behaviors.isUpdating,e=>{this.setState({isDisabled:e})})}componentWillUnmount(){super.componentWillUnmount(),this.setState({imageData:void 0})}render(){var e;const t=!!(null===(e=navigator.clipboard)||void 0===e?void 0:e.write);return(0,o.jsxs)("div",{children:[this.state.showPreview&&(0,o.jsxs)("div",{className:"msp-image-preview",children:[(0,o.jsx)(Gu,{plugin:this.plugin}),(0,o.jsx)(nd,{plugin:this.plugin})]}),(0,o.jsxs)("div",{className:"msp-flex-row",children:[!this.state.imageData&&(0,o.jsx)(Ri.$n,{icon:Oi.y5,onClick:t?this.copy:this.copyImg,disabled:this.state.isDisabled,children:"Copy"}),this.state.imageData&&(0,o.jsx)(Ri.$n,{onClick:()=>this.setState({imageData:void 0}),disabled:this.state.isDisabled,children:"Clear"}),(0,o.jsx)(Ri.$n,{icon:Oi.U3,onClick:this.download,disabled:this.state.isDisabled,children:"Download"})]}),this.state.imageData&&(0,o.jsxs)("div",{className:"msp-row msp-copy-image-wrapper",children:[(0,o.jsx)("div",{children:"Right click below + Copy Image"}),(0,o.jsx)("img",{src:this.state.imageData,style:{width:"100%",height:32,display:"block"}})]}),(0,o.jsx)(td,{plugin:this.plugin,isDisabled:this.state.isDisabled}),(0,o.jsxs)(Ri.Yj,{header:"State",children:[(0,o.jsx)(Kc,{onAction:this.props.close}),(0,o.jsx)(Ri.Yj,{header:"Save Options",initiallyExpanded:!1,noOffset:!0,children:(0,o.jsx)(Qc,{})})]}),(0,o.jsx)(Ri.Yj,{header:"Camera",children:(0,o.jsx)(ed,{plugin:this.plugin})})]})}}function Wu(e){return`${null==e?void 0:e.map(e=>(0,a.LI)(e,2)).join(", ")}`}function Yu({title:e,children:t}){return(0,o.jsxs)("div",{className:"msp-control-row",children:[(0,o.jsx)("span",{className:"msp-control-row-label",children:e}),(0,o.jsx)("div",{className:"msp-control-row-text",style:{fontSize:"0.85rem",overflow:"hidden",whiteSpace:"nowrap"},children:t})]})}function Ju(e){if(e)return function(e,t,n,i){const s=Go.eB.sub((0,Go.eB)(),t,e),r=Qu(n,i)||1;return Go.eB.scaleAndAdd(s,e,s,1/r)}(e.target,e.position,e.mode,e.fov)}function ed({plugin:e}){var t,n,i,s,l,c;const[,u]=(0,r.useState)({});(0,r.useEffect)(()=>{var t;const n=null===(t=e.canvas3d)||void 0===t?void 0:t.didDraw.subscribe(()=>u({}));return()=>null==n?void 0:n.unsubscribe()},[e]);const d=null===(t=e.canvas3d)||void 0===t?void 0:t.camera.state,h=Ju(d),p=Go.eB.sub((0,Go.eB)(),null!==(n=null==d?void 0:d.target)&&void 0!==n?n:Go.eB.origin,null!==(i=null==d?void 0:d.position)&&void 0!==i?i:Go.eB.origin);return Go.eB.normalize(p,p),(0,o.jsxs)("div",{children:[(0,o.jsx)(Yu,{title:"Position",children:Wu(null==d?void 0:d.position)}),(0,o.jsx)(Yu,{title:"FoV Norm. Pos.",children:Wu(h)}),(0,o.jsx)(Yu,{title:"Target",children:Wu(null==d?void 0:d.target)}),(0,o.jsx)(Yu,{title:"Direction",children:Wu(p)}),(0,o.jsx)(Yu,{title:"Up",children:Wu(null==d?void 0:d.up)}),(0,o.jsx)(Yu,{title:"Distance",children:(0,a.LI)(Go.eB.distance(null!==(s=null==d?void 0:d.position)&&void 0!==s?s:Go.eB.origin,null!==(l=null==d?void 0:d.target)&&void 0!==l?l:Go.eB.origin),2)}),(0,o.jsx)(Yu,{title:"Radius",children:(0,a.LI)(null!==(c=null==d?void 0:d.radius)&&void 0!==c?c:0,2)}),(0,o.jsx)(Ri.$n,{onClick:()=>{if(!navigator.clipboard)return;const e=`{\n    position: [${null==h?void 0:h.map(e=>(0,a.LI)(e,2)).join(", ")}],\n    target: [${null==d?void 0:d.target.map(e=>(0,a.LI)(e,2)).join(", ")}],\n    up: [${null==d?void 0:d.up.map(e=>(0,a.LI)(e,2)).join(", ")}],\n}`;navigator.clipboard.writeText(e)},style:{marginTop:1},title:"Copy JSON usable in MolViewSpec, uses FoV Normalized Position",children:"Copy MVS JSON"})]})}function td({plugin:e,isDisabled:t}){const n=e.helpers.viewportScreenshot,i=wc(null==n?void 0:n.behaviors.values);return n?(0,o.jsx)(zi.y1,{params:n.params,values:i,onChangeValues:e=>n.behaviors.values.next(e),isDisabled:t}):null}function nd({plugin:e}){const t=e.helpers.viewportScreenshot,n=wc(null==t?void 0:t.behaviors.cropParams);return wc(null==t?void 0:t.behaviors.relativeCrop),t&&n?(0,o.jsxs)("div",{style:{width:"100%",height:"24px",marginTop:"8px"},children:[(0,o.jsx)(Ri.ff,{icon:Oi.l8,title:"Auto-crop",inline:!0,isSelected:n.auto,style:{background:"transparent",float:"left",width:"auto",height:"24px",lineHeight:"24px"},toggle:()=>t.toggleAutocrop(),label:"Auto-crop "+(n.auto?"On":"Off")}),!n.auto&&(0,o.jsx)(Ri.$n,{icon:Oi.FJ,title:"Crop",style:{background:"transparent",float:"right",height:"24px",lineHeight:"24px",width:"24px",padding:"0"},onClick:()=>t.autocrop()}),!n.auto&&!t.isFullFrame&&(0,o.jsx)(Ri.$n,{icon:Oi.fL,title:"Reset Crop",style:{background:"transparent",float:"right",height:"24px",lineHeight:"24px",width:"24px",padding:"0"},onClick:()=>t.resetCrop()})]}):null}var id=n(80611);class sd extends l.dL{componentDidMount(){this.plugin.canvas3d&&(this.subscribe(this.plugin.events.canvas3d.settingsUpdated,()=>this.forceUpdate()),this.subscribe(this.plugin.canvas3d.camera.stateChanged.pipe((0,Ro.c)(500,void 0,{leading:!0,trailing:!0})),e=>{void 0===e.radiusMax&&void 0===e.radius||this.forceUpdate()}))}render(){return this.plugin.canvas3d?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(zi.dr,{mapping:ad}),(0,o.jsx)(Qr,{})]}):null}}const rd={sequence:"Sequence",log:"Log",left:"Left Panel",right:"Right Panel"},od={animate:Vc._i.trackball.params.animate,camera:Vc._i.camera,background:Xi.t.Group({color:Xi.t.Color((0,es.Q1)(16579577),{label:"Background",description:"Custom background color"}),transparent:Xi.t.Boolean(!1),style:Vc._i.postprocessing.params.background},{pivot:"color"}),lighting:Xi.t.Group({occlusion:Vc._i.postprocessing.params.occlusion,shadow:Vc._i.postprocessing.params.shadow,outline:Vc._i.postprocessing.params.outline,dof:Vc._i.postprocessing.params.dof,fog:Vc._i.cameraFog},{isFlat:!0}),clipping:Xi.t.Group({...Vc._i.cameraClipping.params},{pivot:"radius"}),layout:Xi.t.MultiSelect([],Xi.t.objectToOptions(rd)),advanced:Xi.t.Group({illumination:Vc._i.illumination,multiSample:Vc._i.multiSample,hiZ:Vc._i.hiZ,sharpening:Vc._i.postprocessing.params.sharpening,bloom:Vc._i.postprocessing.params.bloom,resolutionMode:Vc.H7.Params.resolutionMode,pixelScale:Vc.H7.Params.pixelScale,transparency:Vc.H7.Params.transparency})},ad=(ld={params:e=>{var t;const n=Xi.t.clone(od),i=null===(t=e.spec.components)||void 0===t?void 0:t.controls;if(i){const e=[];"none"!==i.top&&e.push(["sequence",rd.sequence]),"none"!==i.bottom&&e.push(["log",rd.log]),"none"!==i.left&&e.push(["left",rd.left]),"none"!==i.right&&e.push(["right",rd.right]),n.layout.options=e}const s=e.config.get(Mr.AB.Background.Styles)||[];return s.length>0&&Object.assign(n.background.params.style,{presets:(0,Qi.Go)(s),isFlat:!1}),n},target(e){var t,n,i;const s=null===(t=e.spec.components)||void 0===t?void 0:t.controls,r=e.layout.state.regionState,o=[];"hidden"===r.top||s&&"none"===s.top||o.push("sequence"),"hidden"===r.bottom||s&&"none"===s.bottom||o.push("log"),"hidden"===r.left||s&&"none"===s.left||o.push("left"),"hidden"===r.right||s&&"none"===s.right||o.push("right");const{pixelScale:a,transparency:l,resolutionMode:c}=null===(n=e.canvas3dContext)||void 0===n?void 0:n.props;return{canvas:null===(i=e.canvas3d)||void 0===i?void 0:i.props,layout:o,resolutionMode:c,pixelScale:a,transparency:l}}},({values:e,update:t,apply:n})=>({params:"function"==typeof ld.params?ld.params:e=>ld.params,getTarget:ld.target,getValues:e,update(e,n){const i=ld.target(n);return(0,id.j)(i,i=>t(e,i,n))},apply:n||(()=>{})}))({values(e,t){const{canvas:n}=e,i=n.renderer;return{layout:e.layout,animate:n.trackball.animate,camera:n.camera,background:{color:i.backgroundColor,transparent:n.transparentBackground,style:n.postprocessing.background},lighting:{occlusion:n.postprocessing.occlusion,shadow:n.postprocessing.shadow,outline:n.postprocessing.outline,dof:n.postprocessing.dof,fog:n.cameraFog},clipping:{...n.cameraClipping},advanced:{illumination:n.illumination,multiSample:n.multiSample,hiZ:n.hiZ,sharpening:n.postprocessing.sharpening,bloom:n.postprocessing.bloom,resolutionMode:e.resolutionMode,pixelScale:e.pixelScale,transparency:e.transparency}}},update(e,t){const n=t.canvas;n.trackball.animate=e.animate,n.camera=e.camera,n.transparentBackground=e.background.transparent,n.renderer.backgroundColor=e.background.color,n.postprocessing.occlusion=e.lighting.occlusion,n.postprocessing.shadow=e.lighting.shadow,n.postprocessing.outline=e.lighting.outline,n.postprocessing.background=e.background.style,n.cameraFog=e.lighting.fog,n.cameraClipping={radius:e.clipping.radius,far:e.clipping.far,minNear:e.clipping.minNear},n.illumination=e.advanced.illumination,n.multiSample=e.advanced.multiSample,n.hiZ=e.advanced.hiZ,n.postprocessing.sharpening=e.advanced.sharpening,n.postprocessing.bloom=e.advanced.bloom,n.postprocessing.dof=e.lighting.dof,t.layout=e.layout,t.resolutionMode=e.advanced.resolutionMode,t.pixelScale=e.advanced.pixelScale,t.transparency=e.advanced.transparency},async apply(e,t){var n;await Fi.a.Canvas3D.SetSettings(t,{settings:e.canvas});const i=e.layout.indexOf("left")<0,s=(0,id.j)(t.layout.state,n=>{n.regionState.top=e.layout.indexOf("sequence")>=0?"full":"hidden",n.regionState.bottom=e.layout.indexOf("log")>=0?"full":"hidden",n.regionState.left=i?"hidden":"none"===t.behaviors.layout.leftPanelTabName.value?"collapsed":"full",n.regionState.right=e.layout.indexOf("right")>=0?"full":"hidden"});await Fi.a.Layout.Update(t,{state:s}),i&&Fi.a.State.SetCurrentObject(t,{state:t.state.data,ref:Yi.Cn.RootRef}),null===(n=t.canvas3dContext)||void 0===n||n.setProps({resolutionMode:e.resolutionMode,pixelScale:e.pixelScale,transparency:e.transparency})}});var ld;class cd extends l.dL{constructor(){super(...arguments),this.allCollapsedState={isSettingsExpanded:!1,isScreenshotExpanded:!1},this.state={...this.allCollapsedState,isCameraResetEnabled:!0},this.resetCamera=()=>{Fi.a.Camera.Reset(this.plugin,{})},this.toggleSettingsExpanded=this.toggle("isSettingsExpanded"),this.toggleScreenshotExpanded=this.toggle("isScreenshotExpanded"),this.toggleControls=()=>{Fi.a.Layout.Update(this.plugin,{state:{showControls:!this.plugin.layout.state.showControls}})},this.toggleExpanded=()=>{Fi.a.Layout.Update(this.plugin,{state:{isExpanded:!this.plugin.layout.state.isExpanded,expandToFullscreen:!1}})},this.toggleFullscreen=()=>{Fi.a.Layout.Update(this.plugin,{state:{expandToFullscreen:!this.plugin.layout.state.expandToFullscreen}})},this.toggleXR=()=>{this.plugin.canvas3d&&(this.plugin.canvas3d.xr.isPresenting.value?this.plugin.canvas3d.xr.end():this.plugin.canvas3d.xr.request())},this.toggleIllumination=()=>{this.plugin.canvas3d&&Fi.a.Canvas3D.SetSettings(this.plugin,{settings:{illumination:{...this.plugin.canvas3d.props.illumination,enabled:!this.plugin.canvas3d.props.illumination.enabled}}})},this.setSettings=e=>{Fi.a.Canvas3D.SetSettings(this.plugin,{settings:{[e.name]:e.value}})},this.setLayout=e=>{Fi.a.Layout.Update(this.plugin,{state:{[e.name]:e.value}})},this.screenshot=()=>{var e;null===(e=this.plugin.helpers.viewportScreenshot)||void 0===e||e.download()},this.enableCameraReset=e=>{this.setState(t=>({...t,isCameraResetEnabled:e}))}}toggle(e){return t=>{this.setState(t=>({...t,...this.allCollapsedState,[e]:!this.state[e]})),null==t||t.currentTarget.blur()}}componentDidMount(){this.subscribe(this.plugin.events.canvas3d.settingsUpdated,()=>this.forceUpdate()),this.subscribe(this.plugin.layout.events.updated,()=>this.forceUpdate()),this.plugin.canvas3d&&(this.subscribe(this.plugin.canvas3d.camera.stateChanged.pipe((0,Ro.c)(500,void 0,{leading:!0,trailing:!0})),e=>this.enableCameraReset(0!==e.radius&&0!==e.radiusMax)),this.subscribe(this.plugin.canvas3d.xr.isSupported,()=>this.forceUpdate()),this.subscribe(this.plugin.canvas3d.xr.isPresenting,()=>this.forceUpdate()))}icon(e,t,n,i=!0,s=!1){return(0,o.jsx)(Ri.K0,{svg:e,toggleState:i,onClick:t,title:n,style:{background:"transparent"},disabled:s})}render(){var e,t,n;const i=this.plugin.config.get(Mr.AB.Viewport.ShowXR),s=!!(null===(e=this.plugin.canvas3d)||void 0===e?void 0:e.xr.isSupported.value),r=!!(null===(t=this.plugin.canvas3d)||void 0===t?void 0:t.xr.isPresenting.value),a="always"===i||"auto"===i&&s,l=s?r?"Exit XR":"Enter XR":"Augmented/Virtual Reality unavailable",c=this.plugin.layout.state;return(0,o.jsxs)("div",{className:"msp-viewport-controls",children:[(0,o.jsxs)("div",{className:"msp-viewport-controls-buttons",children:[this.plugin.config.get(Mr.AB.Viewport.ShowReset)&&(0,o.jsxs)("div",{className:"msp-hover-box-wrapper",children:[(0,o.jsx)("div",{className:"msp-semi-transparent-background"}),this.icon(Oi.FP,this.resetCamera,"Reset Zoom"),(0,o.jsx)("div",{className:"msp-hover-box-body",children:(0,o.jsxs)("div",{className:"msp-flex-column",children:[(0,o.jsx)("div",{className:"msp-flex-row",children:(0,o.jsx)(Ri.$n,{onClick:()=>this.resetCamera(),disabled:!this.state.isCameraResetEnabled,title:"Set camera zoom to fit the visible scene into view",children:"Reset Zoom"})}),(0,o.jsx)("div",{className:"msp-flex-row",children:(0,o.jsx)(Ri.$n,{onClick:()=>Fi.a.Camera.OrientAxes(this.plugin),disabled:!this.state.isCameraResetEnabled,title:"Align principal component axes of the loaded structures to the screen axes (lay flat)",children:"Orient Axes"})}),(0,o.jsx)("div",{className:"msp-flex-row",children:(0,o.jsx)(Ri.$n,{onClick:()=>Fi.a.Camera.ResetAxes(this.plugin),disabled:!this.state.isCameraResetEnabled,title:"Align Cartesian axes to the screen axes",children:"Reset Axes"})})]})}),(0,o.jsx)("div",{className:"msp-hover-box-spacer"})]}),this.plugin.config.get(Mr.AB.Viewport.ShowScreenshotControls)&&(0,o.jsxs)("div",{children:[(0,o.jsx)("div",{className:"msp-semi-transparent-background"}),this.icon(Oi.C$,this.toggleScreenshotExpanded,"Screenshot / State Snapshot",this.state.isScreenshotExpanded)]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("div",{className:"msp-semi-transparent-background"}),this.plugin.config.get(Mr.AB.Viewport.ShowControls)&&this.icon(Oi.fl,this.toggleControls,"Toggle Controls Panel",this.plugin.layout.state.showControls),this.plugin.config.get(Mr.AB.Viewport.ShowExpand)&&(0,o.jsxs)("div",{className:"msp-hover-box-wrapper",children:[this.icon(Oi.E2,this.toggleExpanded,"Toggle Expanded Viewport",this.plugin.layout.state.isExpanded),(0,o.jsx)("div",{className:"msp-hover-box-body",children:(0,o.jsx)("div",{className:"msp-flex-column",children:(0,o.jsx)("div",{className:"msp-flex-row",children:(0,o.jsx)(Ri.$n,{onClick:this.toggleFullscreen,children:c.expandToFullscreen?"Exit Fullscreen":"Fullscreen"})})})}),(0,o.jsx)("div",{className:"msp-hover-box-spacer"})]}),!this.plugin.config.get(Mr.AB.Viewport.ShowExpand)&&this.plugin.config.get(Mr.AB.Viewport.ShowToggleFullscreen)&&this.icon(Oi.Cj,this.toggleFullscreen,"Toggle Full Screen",this.plugin.layout.state.expandToFullscreen),this.plugin.config.get(Mr.AB.Viewport.ShowSettings)&&this.icon(Oi.Hk,this.toggleSettingsExpanded,"Settings / Controls Info",this.state.isSettingsExpanded),this.plugin.config.get(Mr.AB.Viewport.ShowIllumination)&&this.icon(Oi.MI,this.toggleIllumination,"Illumination",(null===(n=this.plugin.canvas3d)||void 0===n?void 0:n.props.illumination.enabled)||!1),a&&this.icon(Oi.le,this.toggleXR,l,r,!s)]}),this.plugin.config.get(Mr.AB.Viewport.ShowSelectionMode)&&(0,o.jsxs)("div",{children:[(0,o.jsx)("div",{className:"msp-semi-transparent-background"}),(0,o.jsx)(Wr,{})]})]}),this.state.isScreenshotExpanded&&(0,o.jsx)("div",{className:"msp-viewport-controls-panel",children:(0,o.jsx)(Ri.tW,{header:"Screenshot / State",title:"Click to close.",initialExpanded:!0,hideExpander:!0,hideOffset:!0,onHeaderClick:this.toggleScreenshotExpanded,topRightIcon:Oi.X6,noTopMargin:!0,childrenClassName:"msp-viewport-controls-panel-controls",children:(0,o.jsx)(Xu,{close:this.toggleScreenshotExpanded})})}),this.state.isSettingsExpanded&&(0,o.jsx)("div",{className:"msp-viewport-controls-panel",children:(0,o.jsx)(Ri.tW,{header:"Settings / Controls Info",title:"Click to close.",initialExpanded:!0,hideExpander:!0,hideOffset:!0,onHeaderClick:this.toggleSettingsExpanded,topRightIcon:Oi.X6,noTopMargin:!0,childrenClassName:"msp-viewport-controls-panel-controls",children:(0,o.jsx)(sd,{})})})]})}}const ud=()=>(0,o.jsx)("a",{className:"msp-logo",href:"https://molstar.org",target:"_blank"}),dd=()=>(0,o.jsx)(_u,{logo:ud});var hd=n(44588),pd=n(55178);function md({plugin:e}){return e.isInitialized?(0,o.jsx)(l.aU.Provider,{value:e,children:(0,o.jsx)(gd,{})}):(0,o.jsx)(fd,{plugin:e})}function fd({plugin:e}){const[t,n]=r.useState({kind:"pending"});return r.useEffect(()=>{n({kind:"pending"});let t=!0;return e.initialized.then(()=>{t&&n({kind:"initialized"})}).catch(e=>{t&&n({kind:"error",message:`${e}`})}),()=>{t=!1}},[e]),"pending"===t.kind?null:"error"===t.kind?(0,o.jsx)("div",{className:"msp-plugin",children:(0,o.jsxs)("div",{className:"msp-plugin-init-error",children:["Initialization error: ",t.message]})}):(0,o.jsx)(l.aU.Provider,{value:e,children:(0,o.jsx)(gd,{})})}r.Component;class gd extends l.dL{constructor(){super(...arguments),this.onDrop=e=>{e.preventDefault();const t=[];if(e.dataTransfer.items)for(let i=0;i<e.dataTransfer.items.length;i++){if("file"!==e.dataTransfer.items[i].kind)continue;const n=e.dataTransfer.items[i].getAsFile();n&&t.push(n)}else for(let i=0;i<e.dataTransfer.files.length;i++){const n=e.dataTransfer.files[i];n&&t.push(n)}const n=t.filter(e=>{const t=e.name.toLowerCase();return t.endsWith(".molx")||t.endsWith(".molj")});n.length>0?Fi.a.State.Snapshots.OpenFile(this.plugin,{file:n[0]}):this.plugin.runTask(this.plugin.state.data.applyAction(hd.OpenFiles,{files:t.map(e=>pd.V.File(e)),format:{name:"auto",params:{}},visuals:!0}))},this.onDragOver=e=>{e.preventDefault()},this.showDragOverlay=new lr.t(!1),this.onDragEnter=e=>{let t=!1;if(e.dataTransfer.items&&e.dataTransfer.items.length>0){for(let n=0;n<e.dataTransfer.items.length;n++)if("file"===e.dataTransfer.items[n].kind){t=!0;break}}else for(let n=0;n<e.dataTransfer.types.length;n++)if("Files"===e.dataTransfer.types[n]){t=!0;break}t&&this.showDragOverlay.next(!0)}}componentDidMount(){this.subscribe(this.plugin.layout.events.updated,()=>this.forceUpdate())}region(e,t){return(0,o.jsx)("div",{className:`msp-layout-region msp-layout-${e}`,children:(0,o.jsx)("div",{className:"msp-layout-static",children:t?(0,o.jsx)(t,{}):null})})}get layoutVisibilityClassName(){var e,t;const n=this.plugin.layout.state,i=null!==(t=null===(e=this.plugin.spec.components)||void 0===e?void 0:e.controls)&&void 0!==t?t:{},s=[];return"none"!==i.top&&n.showControls&&"hidden"!==n.regionState.top||s.push("msp-layout-hide-top"),"none"!==i.left&&n.showControls&&"hidden"!==n.regionState.left?"collapsed"===n.regionState.left&&s.push("msp-layout-collapse-left"):s.push("msp-layout-hide-left"),"none"!==i.right&&n.showControls&&"hidden"!==n.regionState.right||s.push("msp-layout-hide-right"),"none"!==i.bottom&&n.showControls&&"hidden"!==n.regionState.bottom||s.push("msp-layout-hide-bottom"),s.join(" ")}get layoutClassName(){const e=this.plugin.layout.state,t=["msp-plugin-content"];return e.isExpanded?t.push("msp-layout-expanded"):t.push("msp-layout-standard",`msp-layout-standard-${e.controlsDisplay}`),t.join(" ")}render(){var e,t,n,i,s,r,a;const l=this.plugin.layout.state,c=(null===(e=this.plugin.spec.components)||void 0===e?void 0:e.controls)||{},u=(null===(n=null===(t=this.plugin.spec.components)||void 0===t?void 0:t.viewport)||void 0===n?void 0:n.view)||bd,d=(null===(s=null===(i=this.plugin.spec.components)||void 0===i?void 0:i.sequenceViewer)||void 0===s?void 0:s.view)||Du;return(0,o.jsx)("div",{className:"msp-plugin",children:(0,o.jsxs)("div",{className:this.layoutClassName,onDragEnter:this.onDragEnter,children:[(0,o.jsxs)("div",{className:this.layoutVisibilityClassName,children:[this.region("main",u),l.showControls&&"none"!==c.top&&this.region("top",c.top||d),l.showControls&&"none"!==c.left&&this.region("left",c.left||uu),l.showControls&&"none"!==c.right&&this.region("right",c.right||vd),l.showControls&&"none"!==c.bottom&&this.region("bottom",c.bottom||xd)]}),!(null===(r=this.plugin.spec.components)||void 0===r?void 0:r.hideTaskOverlay)&&(0,o.jsx)(Hu,{}),!(null===(a=this.plugin.spec.components)||void 0===a?void 0:a.disableDragOverlay)&&(0,o.jsx)(yd,{plugin:this.plugin,showDragOverlay:this.showDragOverlay})]})})}}function yd({plugin:e,showDragOverlay:t}){const n=wc(t),i=e=>{e.dataTransfer.dropEffect="copy",e.preventDefault(),e.stopPropagation()};return(0,o.jsx)("div",{className:"msp-drag-drop-overlay",style:{display:n?"flex":"none"},onDragEnter:i,onDragOver:i,onDragLeave:()=>t.next(!1),onDrop:n=>function(e,t,n){e.preventDefault(),e.stopPropagation(),n.next(!1);const i=[];if(e.dataTransfer.items)for(let s=0;s<e.dataTransfer.items.length;s++){if("file"!==e.dataTransfer.items[s].kind)continue;const t=e.dataTransfer.items[s].getAsFile();t&&i.push(t)}else for(let s=0;s<e.dataTransfer.files.length;s++){const t=e.dataTransfer.files[s];t&&i.push(t)}t.managers.dragAndDrop.handle(i)}(n,e,t),children:"Load File(s)"})}class vd extends l.dL{render(){var e;const t=(null===(e=this.plugin.spec.components)||void 0===e?void 0:e.structureTools)||Uc;return(0,o.jsx)("div",{className:"msp-scrollable-container",children:(0,o.jsx)(t,{})})}}class bd extends l.dL{render(){var e,t,n,i,s,r;const a=(null===(t=null===(e=this.plugin.spec.components)||void 0===e?void 0:e.viewport)||void 0===t?void 0:t.controls)||cd,l=(null===(i=null===(n=this.plugin.spec.components)||void 0===n?void 0:n.selectionTools)||void 0===i?void 0:i.controls)||Oc,c=(null===(r=null===(s=this.plugin.spec.components)||void 0===s?void 0:s.viewport)||void 0===r?void 0:r.snapshotDescription)||Fc;return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(dd,{}),(0,o.jsxs)("div",{className:"msp-viewport-top-left-controls",children:[(0,o.jsx)(Rc,{}),(0,o.jsx)(Dc,{}),(0,o.jsx)(Nc,{}),(0,o.jsx)(c,{})]}),(0,o.jsx)(l,{}),(0,o.jsx)(a,{}),(0,o.jsx)(Fu,{}),(0,o.jsxs)("div",{className:"msp-highlight-toast-wrapper",children:[(0,o.jsx)(zc,{}),(0,o.jsx)(Vu,{})]})]})}}class xd extends l.dL{constructor(){super(...arguments),this.wrapper=r.createRef(),this.state={entries:this.plugin.log.entries}}componentDidMount(){this.subscribe(this.plugin.events.log,()=>this.setState({entries:this.plugin.log.entries}))}componentDidUpdate(){this.scrollToBottom()}scrollToBottom(){const e=this.wrapper.current;e&&(e.scrollTop=e.scrollHeight-e.clientHeight-1)}render(){const e=this.state.entries,t=e.size,n=[];for(let i=Math.max(0,t-10),s=0;i<t;i++){const t=e.get(i);n.push((0,o.jsxs)("li",{children:[(0,o.jsx)("div",{className:"msp-log-entry-badge msp-log-entry-"+t.type}),(0,o.jsx)("div",{className:"msp-log-timestamp",children:(0,a.fU)(t.timestamp)}),(0,o.jsx)("div",{className:"msp-log-entry",children:t.message})]},s++))}return(0,o.jsx)("div",{ref:this.wrapper,className:"msp-log",style:{position:"absolute",top:"0",right:"0",bottom:"0",left:"0",overflowY:"auto"},children:(0,o.jsx)("ul",{className:"msp-list-unstyled",children:n})})}}var Sd=n(53979),Cd=n(68011),wd=n(79826),kd=n(73564);var Bd,Pd=n(42402);!function(e){e.Registry=class{constructor(){this.providers=(0,Gc.uY)().asMutable(),this.defaultAutoAttachValues=new Map}getParams(e){const t={},n=[],i=[];if(e){const s=this.providers.values();for(;;){const r=s.next();if(r.done)break;const o=r.value;o.isApplicable(e)&&(o.isHidden||(n.push([o.descriptor.name,o.label]),this.defaultAutoAttachValues.get(o.descriptor.name)&&i.push(o.descriptor.name)),t[o.descriptor.name]=Xi.t.Group({...o.getParams(e)},{label:o.label,isHidden:o.isHidden}))}}return{autoAttach:Xi.t.MultiSelect(i,n),properties:Xi.t.Group(t,{isFlat:!0})}}setDefaultAutoAttach(e,t){this.defaultAutoAttachValues.set(e,t)}get(e){if(!this.providers.get(e))throw new Error(`Custom property '${e}' is not registered.`);return this.providers.get(e)}register(e,t){this.providers.set(e.descriptor.name,e),this.defaultAutoAttachValues.set(e.descriptor.name,t)}unregister(e){this.providers.delete(e),this.defaultAutoAttachValues.delete(e)}}}(Bd||(Bd={}));var Id=n(16679),jd=n(82714);class Td{get dataState(){return this.plugin.state.data}rawData(e,t){return this.dataState.build().toRoot().apply(Id.RawData,e,t).commit({revertOnError:!0})}download(e,t){return this.dataState.build().toRoot().apply(Id.Download,e,t).commit({revertOnError:!0})}downloadBlob(e,t){return this.dataState.build().toRoot().apply(Id.DownloadBlob,e,t).commit({revertOnError:!0})}async readFile(e,t){var n,i,s;return{data:await this.dataState.build().toRoot().apply(Id.ReadFile,e,t).commit({revertOnError:!0}),fileInfo:(0,jd.o)(null!==(s=null===(i=null===(n=e.file)||void 0===n?void 0:n.file)||void 0===i?void 0:i.name)&&void 0!==s?s:"")}}constructor(e){this.plugin=e}}var Ad=n(38530),Md=n(90644);class Ld{get dataState(){return this.plugin.state.data}resolveProvider(e){var t;return"string"==typeof e?null!==(t=Ca.Bj[e])&&void 0!==t?t:(0,Ad.L9)(this._providers,t=>t.id===e):e}hasPreset(e){for(const t of this._providers)if(!t.isApplicable||t.isApplicable(e,this.plugin))return!0;return!1}get providers(){return this._providers}getPresets(e){if(!e)return this.providers;const t=[];for(const n of this._providers)n.isApplicable&&!n.isApplicable(e,this.plugin)||t.push(n);return t}getPresetSelect(e){const t=[];for(const n of this._providers)e&&n.isApplicable&&!n.isApplicable(e,this.plugin)||t.push([n.id,n.display.name,n.display.group]);return Xi.t.Select("auto",t)}getPresetsWithOptions(e){const t=[],n=Object.create(null);for(const i of this._providers)i.isApplicable&&!i.isApplicable(e,this.plugin)||(t.push([i.id,i.display.name]),n[i.id]=i.params?Xi.t.Group(i.params(e,this.plugin)):Xi.t.EmptyGroup());return 0===t.length?Xi.t.MappedStatic("",{"":Xi.t.EmptyGroup()}):Xi.t.MappedStatic(t[0][0],n,{options:t})}registerPreset(e){if(this.providerMap.has(e.id))throw new Error(`Representation provider with id '${e.id}' already registered.`);this._providers.push(e),this.providerMap.set(e.id,e)}unregisterPreset(e){this.providerMap.delete(e.id),(0,wr.mO)(this._providers,e)}applyPreset(e,t,n){var i;const s=this.resolveProvider(t);if(!s)return;const r=this.plugin.state.data,o=Yi.so.resolveAndCheck(r,e);if(!o)return void(Md.Zq||console.warn("Applying structure repr. provider to bad cell."));const a=(null===(i=s.params)||void 0===i?void 0:i.call(s,o.obj,this.plugin))||{};let l=n||(s.params?Xi.t.getDefaultValues(a):{});const c=this.plugin.config.get(Mr.AB.Structure.DefaultRepresentationPresetParams);l=Xi.t.merge(a,c,l);const u=Zi.YZ.create(`${s.display.name}`,()=>s.apply(o,l,this.plugin));return this.plugin.runTask(u)}async addRepresentation(e,t,n){const i=this.dataState.build(),s=this.buildRepresentation(i,e,t,n);if(s)return await i.commit(),s}buildRepresentation(e,t,n,i){var s,r;if(!t)return;const o=null===(r=null===(s=Yi.so.resolveAndCheck(this.dataState,t))||void 0===s?void 0:s.obj)||void 0===r?void 0:r.data;if(!o)return;const a=(0,Ui.pQ)(this.plugin,o,n);return(null==i?void 0:i.tag)?e.to(t).applyOrUpdateTagged(i.tag,as.StructureRepresentation3D,a,{state:null==i?void 0:i.initialState}).selector:e.to(t).apply(as.StructureRepresentation3D,a,{state:null==i?void 0:i.initialState}).selector}constructor(e){this.plugin=e,this._providers=[],this.providerMap=new Map,this.defaultProvider=Ca.Bj.auto,(0,Qi.IF)(Ca.Bj,e=>this.registerPreset(e))}}var Ed=n(35256),Dd=n(46031),Nd=n(62752),Fd=n(66270),Rd=n(52468);function Od(e){return e}!function(e){e.CommonParams=(e,t)=>({modelProperties:Xi.t.Optional(Xi.t.Group(Yi.xE.getParamDefinition(Ni.f.Model.CustomModelProperties,void 0,t))),structureProperties:Xi.t.Optional(Xi.t.Group(Yi.xE.getParamDefinition(Ni.f.Model.CustomStructureProperties,void 0,t))),representationPreset:Xi.t.Optional(Xi.t.Text("auto"))})}(Od||(Od={}));const zd=Od.CommonParams,Hd=Od({id:"preset-trajectory-default",display:{name:"Default (Assembly)",group:"Preset",description:"Shows the first assembly or, if that is unavailable, the first model."},isApplicable:e=>!0,params:(e,t)=>({model:Xi.t.Optional(Xi.t.Group(Yi.xE.getParamDefinition(Ni.f.Model.ModelFromTrajectory,e,t))),showUnitcell:Xi.t.Optional(Xi.t.Boolean(!1)),structure:Xi.t.Optional(Nd.z.getParams(void 0,"assembly").type),representationPresetParams:Xi.t.Optional(Xi.t.Group(Ca.n9.CommonParams)),...zd(e,t)}),async apply(e,t,n){const i=n.builders.structure,s=await i.createModel(e,t.model),r=await i.insertModelProperties(s,t.modelProperties),o=await i.createStructure(r||s,t.structure),a=await i.insertStructureProperties(o,t.structureProperties),l=void 0===t.showUnitcell||t.showUnitcell?await i.tryCreateUnitcell(r,void 0,{isHidden:!0}):void 0,c=t.representationPreset||n.config.get(Mr.AB.Structure.DefaultRepresentationPreset)||Ca.Bj.auto.id;return{model:s,modelProperties:r,unitcell:l,structure:o,structureProperties:a,representation:await n.builders.structure.representation.applyPreset(a,c,t.representationPresetParams)}}}),Ud=Od({id:"preset-trajectory-all-models",display:{name:"All Models",group:"Preset",description:"Shows all models; colored by trajectory-index."},isApplicable:e=>e.data.frameCount>1,params:(e,t)=>({useDefaultIfSingleModel:Xi.t.Optional(Xi.t.Boolean(!1)),representationPresetParams:Xi.t.Optional(Xi.t.Group(Ca.n9.CommonParams)),...zd(e,t)}),async apply(e,t,n){var i,s;const r=null===(s=null===(i=Yi.so.resolveAndCheck(n.state.data,e))||void 0===i?void 0:i.obj)||void 0===s?void 0:s.data;if(!r)return{};if(1===r.frameCount&&t.useDefaultIfSingleModel)return Hd.apply(e,t,n);const o=n.builders.structure,a=[],l=[];for(let c=0;c<r.frameCount;c++){const i=await o.createModel(e,{modelIndex:c}),s=await o.insertModelProperties(i,t.modelProperties,{isCollapsed:!0}),u=await o.createStructure(s||i,{name:"model",params:{}}),d=await o.insertStructureProperties(u,t.structureProperties);a.push(i),l.push(u);const h=u.obj?(0,Fd.V8)(u.obj.data,{elementCountFactor:r.frameCount}):"medium",p=t.representationPreset||n.config.get(Mr.AB.Structure.DefaultRepresentationPreset)||Ca.Bj.auto.id;await o.representation.applyPreset(d,p,{theme:{globalName:"trajectory-index"},quality:h})}return{models:a,structures:l}}}),Vd=(e,t)=>({model:Xi.t.Optional(Xi.t.Group(Yi.xE.getParamDefinition(Ni.f.Model.ModelFromTrajectory,e,t))),...zd(e,t)});async function _d(e,t,n,i){const s=i.builders.structure,r=await s.createModel(t,n.model),o=await s.insertModelProperties(r,n.modelProperties),a=await s.createStructure(o||r,{name:"symmetry",params:e}),l=await s.insertStructureProperties(a,n.structureProperties),c=await s.tryCreateUnitcell(o,void 0,{isHidden:!1}),u=n.representationPreset||i.config.get(Mr.AB.Structure.DefaultRepresentationPreset)||Ca.Bj.auto.id;return{model:r,modelProperties:o,unitcell:c,structure:a,structureProperties:l,representation:await i.builders.structure.representation.applyPreset(l,u,{theme:{globalName:e.theme}})}}const Gd=Od({id:"preset-trajectory-unitcell",display:{name:"Unit Cell",group:"Preset",description:"Shows the fully populated unit cell."},isApplicable:e=>Gi.Kx.hasCrystalSymmetry(e.data.representative),params:Vd,async apply(e,t,n){return await _d({ijkMin:Go.eB.create(0,0,0),ijkMax:Go.eB.create(0,0,0)},e,t,n)}}),qd=Od({id:"preset-trajectory-supercell",display:{name:"Super Cell",group:"Preset",description:"Shows the super cell, i.e. the central unit cell and all adjacent unit cells."},isApplicable:e=>Gi.Kx.hasCrystalSymmetry(e.data.representative),params:Vd,async apply(e,t,n){return await _d({ijkMin:Go.eB.create(-1,-1,-1),ijkMax:Go.eB.create(1,1,1),theme:"operator-hkl"},e,t,n)}}),$d=Od({id:"preset-trajectory-crystal-contacts",display:{name:"Crystal Contacts",group:"Preset",description:"Showsasymetric unit and chains from neighbours within 5 , i.e., symmetry mates."},isApplicable:e=>Gi.Kx.hasCrystalSymmetry(e.data.representative),params:(e,t)=>({model:Xi.t.Optional(Xi.t.Group(Yi.xE.getParamDefinition(Ni.f.Model.ModelFromTrajectory,e,t))),...zd(e,t)}),async apply(e,t,n){const i=n.builders.structure,s=await i.createModel(e,t.model),r=await i.insertModelProperties(s,t.modelProperties),o=await i.createStructure(r||s,{name:"symmetry-mates",params:{radius:5}}),a=await i.insertStructureProperties(o,t.structureProperties),l=await i.tryCreateUnitcell(r,void 0,{isHidden:!0}),c=t.representationPreset||n.config.get(Mr.AB.Structure.DefaultRepresentationPreset)||Ca.Bj.auto.id;return{model:s,modelProperties:r,unitcell:l,structure:o,structureProperties:a,representation:await n.builders.structure.representation.applyPreset(a,c,{theme:{globalName:"operator-name",carbonColor:"operator-name",focus:{name:"element-symbol",params:{carbonColor:{name:"operator-name",params:Rd.PO.defaultValues}}}}})}}}),Zd={default:Hd,"all-models":Ud,unitcell:Gd,supercell:qd,crystalContacts:$d};class Kd{resolveProvider(e){var t;return"string"==typeof e?null!==(t=Zd[e])&&void 0!==t?t:(0,Ad.L9)(this._providers,t=>t.id===e):e}hasPreset(e){for(const t of this._providers)if(!t.isApplicable||t.isApplicable(e,this.plugin))return!0;return!1}get providers(){return this._providers}getPresets(e){if(!e)return this.providers;const t=[];for(const n of this._providers)n.isApplicable&&!n.isApplicable(e,this.plugin)||t.push(n);return t}getPresetSelect(e){const t=[];for(const n of this._providers)e&&n.isApplicable&&!n.isApplicable(e,this.plugin)||t.push([n.id,n.display.name]);return Xi.t.Select("auto",t)}getPresetsWithOptions(e){const t=[],n=Object.create(null);for(const i of this._providers)i.isApplicable&&!i.isApplicable(e,this.plugin)||(t.push([i.id,i.display.name]),n[i.id]=i.params?Xi.t.Group(i.params(e,this.plugin)):Xi.t.EmptyGroup());return 0===t.length?Xi.t.MappedStatic("",{"":Xi.t.EmptyGroup()}):Xi.t.MappedStatic(t[0][0],n,{options:t})}registerPreset(e){if(this.providerMap.has(e.id))throw new Error(`Hierarchy provider with id '${e.id}' already registered.`);this._providers.push(e),this.providerMap.set(e.id,e)}unregisterPreset(e){this.providerMap.delete(e.id),(0,wr.mO)(this._providers,e)}applyPreset(e,t,n){const i=this.resolveProvider(t);if(!i)return;const s=this.plugin.state.data,r=Yi.so.resolveAndCheck(s,e);if(!r)return void(Md.Zq||console.warn("Applying hierarchy preset provider to bad cell."));const o=n||(i.params?Xi.t.getDefaultValues(i.params(r.obj,this.plugin)):{}),a=Zi.YZ.create(`${i.display.name}`,()=>i.apply(r,o,this.plugin));return this.plugin.runTask(a)}constructor(e){this.plugin=e,this._providers=[],this.providerMap=new Map,this.defaultProvider=Zd.default,(0,Qi.IF)(Zd,e=>this.registerPreset(e))}}class Qd{get dataState(){return this.plugin.state.data}async parseTrajectoryData(e,t){const n="string"==typeof t?this.plugin.dataFormats.get(t):t;if(!n)throw new Error(`'${t}' is not a supported data format.`);const{trajectory:i}=await n.parse(this.plugin,e);return i}parseTrajectoryBlob(e,t){return this.dataState.build().to(e).apply(Ni.f.Data.ParseBlob,t,{state:{isGhost:!0}}).apply(Ni.f.Model.TrajectoryFromBlob,void 0).commit({revertOnError:!0})}parseTrajectory(e,t){const n=Yi.so.resolveAndCheck(this.dataState,e);if(!n)throw new Error("Invalid data cell.");return Ls.O.Data.Blob.is(n.obj)?this.parseTrajectoryBlob(e,t):this.parseTrajectoryData(e,t)}createModel(e,t,n){return this.dataState.build().to(e).apply(Ni.f.Model.ModelFromTrajectory,t||{modelIndex:0},{state:n}).commit({revertOnError:!0})}insertModelProperties(e,t,n){return this.dataState.build().to(e).apply(Ni.f.Model.CustomModelProperties,t,{state:n}).commit({revertOnError:!0})}tryCreateUnitcell(e,t,n){var i,s,r;const o=this.dataState,a=null===(s=null===(i=Yi.so.resolveAndCheck(o,e))||void 0===i?void 0:i.obj)||void 0===s?void 0:s.data;if(!a)return;const l=null===(r=Ed.i.Provider.get(a))||void 0===r?void 0:r.spacegroup.cell;if(Dd.O8.isZero(l))return;return o.build().to(e).apply(Ni.f.Representation.ModelUnitcell3D,t,{state:n}).commit({revertOnError:!0})}createStructure(e,t,n,i){var s;const r=this.dataState;if(!t){const n=Yi.so.resolveAndCheck(r,e);if(n){const e=Ed.i.Provider.get(null===(s=n.obj)||void 0===s?void 0:s.data);e&&0!==(null==e?void 0:e.assemblies.length)||(t={name:"model",params:{}})}}return r.build().to(e).apply(Ni.f.Model.StructureFromModel,{type:t||{name:"assembly",params:{}}},{state:n,tags:i}).commit({revertOnError:!0})}insertStructureProperties(e,t){return this.dataState.build().to(e).apply(Ni.f.Model.CustomStructureProperties,t).commit({revertOnError:!0})}isComponentTransform(e){return e.transform.transformer===Ni.f.Model.StructureComponent}async tryCreateComponent(e,t,n,i){var s,r;const o=this.dataState,a=`structure-component-${n}`,l=o.build().to(e).applyOrUpdateTagged(a,Ni.f.Model.StructureComponent,t,{tags:i?[...i,a]:[a]});await l.commit();const c=l.selector;if(c.isOk&&0!==(null===(r=null===(s=c.cell)||void 0===s?void 0:s.obj)||void 0===r?void 0:r.data.elementCount))return c;await o.build().delete(c.ref).commit()}tryCreateComponentFromExpression(e,t,n,i){return this.tryCreateComponent(e,{type:{name:"expression",params:t},nullIfEmpty:!0,label:((null==i?void 0:i.label)||"").trim()},n,null==i?void 0:i.tags)}tryCreateComponentStatic(e,t,n){return this.tryCreateComponent(e,{type:{name:"static",params:t},nullIfEmpty:!0,label:((null==n?void 0:n.label)||"").trim()},`static-${t}`,null==n?void 0:n.tags)}tryCreateComponentFromSelection(e,t,n,i){return this.plugin.runTask(Zi.YZ.create("Query Component",async s=>{var r,o;let{label:a,tags:l}=i||{};a=(a||"").trim();const c=null===(o=null===(r=Yi.so.resolveAndCheck(this.dataState,e))||void 0===r?void 0:r.obj)||void 0===o?void 0:o.data;if(!c)return;const u=t.referencesCurrent?{type:{name:"bundle",params:Gi.iZ.Bundle.fromSelection(await t.getSelection(this.plugin,s,c))},nullIfEmpty:!0,label:a||t.label}:{type:{name:"expression",params:t.expression},nullIfEmpty:!0,label:a||t.label};return t.ensureCustomProperties&&await t.ensureCustomProperties({runtime:s,assetManager:this.plugin.managers.asset,errorContext:this.plugin.errorContext},c),this.tryCreateComponent(e,u,n,l)}))}constructor(e){this.plugin=e,this.hierarchy=new Kd(this.plugin),this.representation=new Ld(this.plugin)}}var Xd,Wd,Yd=n(78278),Jd=n(59970);!function(e){e.create=function(e){const{name:t}=e;return{descriptor:e,get(e){return e._propertyData[t]},set(n,i){n.customProperties.add(e),n._propertyData[t]=i}}}}(Xd||(Xd={})),function(e){e.Descriptor={name:"recommended_iso_value"},e.Provider=Xd.create(e.Descriptor)}(Wd||(Wd={}));var eh=n(2469);const th="Volume";async function nh(e,t){if(!t)return;const{entryId:n}=t;return n&&n.toLowerCase().startsWith("emd")?e.runTask(Zi.YZ.create("Try Set Recommended IsoValue",async i=>{try{const s=await(0,eh.$A)(e,i,n);Wd.Provider.set(t,yo.f.IsoValue.absolute(s))}catch(s){console.warn(s)}})):void 0}function ih(e){const t=Wd.Provider.get(e);if(t)return"relative"===t.kind?t:yo.f.adjustedIsoValue(e,t.absoluteValue,"absolute")}async function sh(e,t){const n={},i=t.volume.data&&ih(t.volume.data);i&&(n.isoValue=i);const s=e.build().to(t.volume).apply(Ni.f.Representation.VolumeRepresentation3D,vo(e,t.volume.data,{type:"isosurface",typeParams:n}));return[await s.commit()]}const rh=(0,Jd.N)({label:"CCP4/MRC/MAP",description:"CCP4/MRC/MAP",category:th,binaryExtensions:["ccp4","mrc","map"],parse:async(e,t,n)=>{const i=e.build().to(t).apply(Ni.f.Data.ParseCcp4,{},{state:{isGhost:!0}}),s=i.apply(Ni.f.Volume.VolumeFromCcp4,{entryId:null==n?void 0:n.entryId});return await i.commit({revertOnError:!0}),await nh(e,s.selector.data),{format:i.selector,volume:s.selector}},visuals:sh}),oh=(0,Jd.N)({label:"DSN6/BRIX",description:"DSN6/BRIX",category:th,binaryExtensions:["dsn6","brix"],parse:async(e,t,n)=>{const i=e.build().to(t).apply(Ni.f.Data.ParseDsn6,{},{state:{isGhost:!0}}),s=i.apply(Ni.f.Volume.VolumeFromDsn6,{entryId:null==n?void 0:n.entryId});return await i.commit({revertOnError:!0}),await nh(e,s.selector.data),{format:i.selector,volume:s.selector}},visuals:sh}),ah=(0,Jd.N)({label:"DX",description:"DX",category:th,stringExtensions:["dx"],binaryExtensions:["dxbin"],parse:async(e,t,n)=>{const i=e.build().to(t).apply(Ni.f.Data.ParseDx,{},{state:{isGhost:!0}}).apply(Ni.f.Volume.VolumeFromDx,{entryId:null==n?void 0:n.entryId});return await i.commit({revertOnError:!0}),await nh(e,i.selector.data),{volume:i.selector}},visuals:sh}),lh=(0,Jd.N)({label:"Cube",description:"Cube",category:th,stringExtensions:["cub","cube"],parse:async(e,t,n)=>{const i=e.build().to(t).apply(Ni.f.Data.ParseCube,{},{state:{isGhost:!0}}),s=i.apply(Ni.f.Volume.VolumeFromCube,{entryId:null==n?void 0:n.entryId}),r=i.apply(Ni.f.Model.TrajectoryFromCube,void 0,{state:{isGhost:!0}}).apply(Ni.f.Model.ModelFromTrajectory).apply(Ni.f.Model.StructureFromModel);return await i.commit({revertOnError:!0}),await nh(e,s.selector.data),{format:i.selector,volume:s.selector,structure:r.selector}},visuals:async(e,t)=>{var n,i;const s=e.build(),r=[],o=null===(i=null===(n=t.volume.cell)||void 0===n?void 0:n.obj)||void 0===i?void 0:i.data;if(o&&yo.f.isOrbitals(o)){const n=s.to(t.volume).apply(Ni.f.Representation.VolumeRepresentation3D,vo(e,o,{type:"isosurface",typeParams:{isoValue:yo.f.IsoValue.relative(1),alpha:.4},color:"uniform",colorParams:{value:Ki.s.blue}})),i=s.to(t.volume).apply(Ni.f.Representation.VolumeRepresentation3D,vo(e,o,{type:"isosurface",typeParams:{isoValue:yo.f.IsoValue.relative(-1),alpha:.4},color:"uniform",colorParams:{value:Ki.s.red}}));r.push(n.selector,i.selector)}else{const n=s.to(t.volume).apply(Ni.f.Representation.VolumeRepresentation3D,vo(e,o,{type:"isosurface",typeParams:{isoValue:yo.f.IsoValue.relative(2),alpha:.4},color:"uniform",colorParams:{value:Ki.s.grey}}));r.push(n.selector)}const a=await e.builders.structure.representation.applyPreset(t.structure,"auto");await s.commit();const l=[];return(0,Qi.IF)(null==a?void 0:a.representations,e=>{e&&l.push(e)}),[...r,...l]}}),ch=(0,Jd.N)({label:"DensityServer CIF",description:"DensityServer CIF",category:th,stringExtensions:["cif"],binaryExtensions:["bcif"],isApplicable:(e,t)=>"dscif"===(0,Jd.v)(e,t),parse:async(e,t,n)=>{var i;const s=await e.build().to(t).apply(Ni.f.Data.ParseCif).commit(),r=e.build().to(s),o=s.obj.data.blocks;if(0===o.length)throw new Error("no data blocks");const a=[];let l=0;for(const c of o){if("SERVER"===c.header.toUpperCase())continue;const e=Array.isArray(null==n?void 0:n.entryId)?null==n?void 0:n.entryId[l]:null==n?void 0:n.entryId;(null===(i=c.categories.volume_data_3d_info)||void 0===i?void 0:i.rowCount)>0&&(a.push(r.apply(Ni.f.Volume.VolumeFromDensityServerCif,{blockHeader:c.header,entryId:e}).selector),l++)}await r.commit();for(const c of a)await nh(e,c.data);return{volumes:a}},visuals:async(e,t)=>{const{volumes:n}=t,i=e.build(),s=[];if(n.length>0){const t=n[0].data&&ih(n[0].data)||yo.f.IsoValue.relative(1.5);s[0]=i.to(n[0]).apply(Ni.f.Representation.VolumeRepresentation3D,as.VolumeRepresentation3DHelpers.getDefaultParamsStatic(e,"isosurface",{isoValue:t,alpha:1},"uniform",{value:Ki.s.teal})).selector}if(n.length>1){const t=as.VolumeRepresentation3DHelpers.getDefaultParamsStatic(e,"isosurface",{isoValue:yo.f.IsoValue.relative(3),alpha:.3},"uniform",{value:Ki.s.green}),r=as.VolumeRepresentation3DHelpers.getDefaultParamsStatic(e,"isosurface",{isoValue:yo.f.IsoValue.relative(-3),alpha:.3},"uniform",{value:Ki.s.red});s[s.length]=i.to(n[1]).apply(Ni.f.Representation.VolumeRepresentation3D,t).selector,s[s.length]=i.to(n[1]).apply(Ni.f.Representation.VolumeRepresentation3D,r).selector}return await i.commit(),s}}),uh=(0,Jd.N)({label:"Segmentation CIF",description:"Segmentation CIF",category:th,stringExtensions:["cif"],binaryExtensions:["bcif"],isApplicable:(e,t)=>"segcif"===(0,Jd.v)(e,t),parse:async(e,t)=>{var n;const i=await e.build().to(t).apply(Ni.f.Data.ParseCif).commit(),s=e.build().to(i),r=i.obj.data.blocks;if(0===r.length)throw new Error("no data blocks");const o=[];for(const a of r)"SERVER"!==a.header.toUpperCase()&&(null===(n=a.categories.volume_data_3d_info)||void 0===n?void 0:n.rowCount)>0&&o.push(s.apply(Ni.f.Volume.VolumeFromSegmentationCif,{blockHeader:a.header}).selector);return await s.commit(),{volumes:o}},visuals:async(e,t)=>{const{volumes:n}=t,i=e.build(),s=[];if(n.length>0){yo.f.Segmentation.get(n[0].data)&&(s[s.length]=i.to(n[0]).apply(Ni.f.Representation.VolumeRepresentation3D,as.VolumeRepresentation3DHelpers.getDefaultParams(e,"segment",n[0].data,{alpha:1,instanceGranularity:!0},"volume-segment",{})).selector)}return await i.commit(),s}}),dh=[["ccp4",rh],["dsn6",oh],["cube",lh],["dx",ah],["dscif",ch],["segcif",uh]],hh=[["ply",(0,Jd.N)({label:"PLY",description:"PLY",category:"Shape",stringExtensions:["ply"],parse:async(e,t)=>{const n=e.state.data.build().to(t).apply(Ni.f.Data.ParsePly,{},{state:{isGhost:!0}}),i=n.apply(Ni.f.Model.ShapeFromPly);return await n.commit(),{format:n.selector,shape:i.selector}},visuals(e,t){return e.state.data.build().to(t.shape).apply(Ni.f.Representation.ShapeRepresentation3D).commit()}})]];var ph=n(95354),mh=n(58160);class fh{get types(){return this._list.map(e=>[e.name,e.provider.label])}get extensions(){if(this._extensions)return this._extensions;const e=new Set;return this._list.forEach(({provider:t})=>{var n,i;null===(n=t.stringExtensions)||void 0===n||n.forEach(t=>e.add(t)),null===(i=t.binaryExtensions)||void 0===i||i.forEach(t=>e.add(t))}),this._extensions=e,e}get binaryExtensions(){if(this._binaryExtensions)return this._binaryExtensions;const e=new Set;return this._list.forEach(({provider:t})=>{var n;return null===(n=t.binaryExtensions)||void 0===n?void 0:n.forEach(t=>e.add(t))}),this._binaryExtensions=e,e}get options(){if(this._options)return this._options;const e=[];return this._list.forEach(({name:t,provider:n})=>e.push([t,n.label,n.category||""])),this._options=e,e}constructor(){this._list=[],this._map=new Map,this._extensions=void 0,this._binaryExtensions=void 0,this._options=void 0;for(const[e,t]of dh)this.add(e,t);for(const[e,t]of ph.PO)this.add(e,t);for(const[e,t]of mh.VE)this.add(e,t);for(const[e,t]of hh)this.add(e,t);for(const[e,t]of Yd.HQ)this.add(e,t)}_clear(){this._extensions=void 0,this._binaryExtensions=void 0,this._options=void 0}add(e,t){this._clear(),this._list.push({name:e,provider:t}),this._map.set(e,t)}remove(e){this._clear(),this._list.splice(this._list.findIndex(t=>t.name===e),1),this._map.delete(e)}auto(e,t){var n,i;for(let s=0,r=this.list.length;s<r;++s){const r=this._list[s].provider;let o=!1;if(((null===(n=r.binaryExtensions)||void 0===n?void 0:n.includes(e.ext))||(null===(i=r.stringExtensions)||void 0===i?void 0:i.includes(e.ext)))&&(o=!0),o&&(!r.isApplicable||r.isApplicable(e,t.data)))return r}}get(e){if(this._map.has(e))return this._map.get(e);throw new Error(`unknown data format name '${e}'`)}get list(){return this._list}}class gh extends Wi.e{get isEmpty(){return 0===this._animations.length}get current(){return this._current}get animations(){return this._animations}get isAnimatingStateTransition(){return"built-in.animate-state-snapshot-transition"===this._current.anim.name}triggerUpdate(){this.events.updated.next(void 0)}triggerApply(){this.events.applied.next(void 0)}getParams(){return this._params||(this._params={current:Xi.t.Select(this._animations[0]&&this._animations[0].name,this._animations.map(e=>[e.name,e.display.name]),{label:"Animation"})}),this._params}updateParams(e){if(this.isEmpty)return;this.updateState({params:{...this.state.params,...e}});const t=this.map.get(this.state.params.current),n=t.params(this.context);this._current={anim:t,params:n,paramValues:Xi.t.getDefaultValues(n),state:{},startedTime:-1,lastTime:0},this.triggerUpdate()}updateCurrentParams(e){this.isEmpty||(this._current.paramValues={...this._current.paramValues,...e},this.triggerUpdate())}register(e){this.map.has(e.name)?this.context.log.error(`Animation '${e.name}' is already registered.`):(this._params=void 0,this.map.set(e.name,e),this._animations.push(e),1===this._animations.length?this.updateParams({current:e.name}):this.triggerUpdate())}async play(e,t){await this.stop(),this.map.has(e.name)||this.register(e),this.updateParams({current:e.name}),this.updateCurrentParams(t),await this.start()}async tick(e,t,n){this.currentTime=e,this.isStopped||(t||n?await this.applyFrame(n):this.applyAsync())}async start(){this.updateState({animationState:"playing"}),this.context.behaviors.state.isAnimating.value||this.context.behaviors.state.isAnimating.next(!0),this.triggerUpdate();const e=this._current.anim;let t=this._current.anim.initialState(this._current.paramValues,this.context);if(e.setup){const n=await e.setup(this._current.paramValues,t,this.context);n&&(t=n)}this._current.lastTime=0,this._current.startedTime=-1,this._current.state=t,this.isStopped=!1}async stop(){if(this.isStopped=!0,"stopped"!==this.state.animationState){const e=this._current.anim;e.teardown&&await e.teardown(this._current.paramValues,this._current.state,this.context),this.updateState({animationState:"stopped"}),this.triggerUpdate()}this.context.behaviors.state.isAnimating.value&&this.context.behaviors.state.isAnimating.next(!1)}stopStateTransitionAnimation(){if(this.isAnimatingStateTransition)return this.stop()}get isAnimating(){return"playing"===this.state.animationState}async applyAsync(){if(!this.isApplying){this.isApplying=!0;try{await this.applyFrame()}finally{this.isApplying=!1}}}async applyFrame(e){const t=this.currentTime;this._current.startedTime<0&&(this._current.startedTime=t);const n=await this._current.anim.apply(this._current.state,{lastApplied:this._current.lastTime,current:t-this._current.startedTime,animation:e},{params:this._current.paramValues,plugin:this.context});"finished"===n.kind?this.stop():"next"===n.kind&&(this._current.state=n.state,this._current.lastTime=t-this._current.startedTime),this.triggerApply()}getSnapshot(){return this.current?{state:this.state,current:{paramValues:this._current.paramValues,state:this._current.anim.stateSerialization?this._current.anim.stateSerialization.toJSON(this._current.state):this._current.state}}:{state:this.state}}setSnapshot(e){this.isEmpty||(this.updateState({animationState:e.state.animationState}),this.updateParams(e.state.params),e.current&&(this.current.paramValues=e.current.paramValues,this.current.state=this._current.anim.stateSerialization?this._current.anim.stateSerialization.fromJSON(e.current.state):e.current.state,this.triggerUpdate(),"playing"===this.state.animationState&&this.resume()))}async resume(){this._current.lastTime=0,this._current.startedTime=-1;const e=this._current.anim;this.context.behaviors.state.isAnimating.value||this.context.behaviors.state.isAnimating.next(!0),e.setup&&await e.setup(this._current.paramValues,this._current.state,this.context),this.isStopped=!1}constructor(e){super({params:{current:""},animationState:"stopped"}),this.context=e,this.map=new Map,this._animations=[],this.currentTime=0,this._params=void 0,this.events={updated:this.ev(),applied:this.ev()},this.isStopped=!0,this.isApplying=!1}}var yh=n(51195),vh=n(98537),bh=n(75847),xh=n(2906);function Sh(e,t,n){const i=n[0],s=n[1],r=n[2],o=-i*t[0]-s*t[1]-r*t[2];return(i*e[0]+s*e[1]+r*e[2]+o)/Math.sqrt(i*i+s*s+r*r)}function Ch(e,t,n){if(!e.canvas3d)return;const{origin:i,dirA:s,dirB:r,dirC:o}=n.principalAxes.boxAxes,a=vh.e.clone(s),l=vh.e.clone(o);if(n.positionToFlip){const{aroundX:e,aroundY:t}=function(e,t,n,i){const s=Sh(e,t,i);return{aroundX:Sh(e,t,n)<0,aroundY:s<0}}(n.positionToFlip,i,a,r);e&&(vh.e.negate(l,l),vh.e.negate(a,a)),t&&vh.e.negate(l,l)}const c=vh.e.scale((0,vh.e)(),i,-100);return vh.e.dot(c,a)<=0&&vh.e.negate(l,l),vh.e.dot(vh.e.unitY,l)<=0&&vh.e.negate(a,a),e.canvas3d.camera.getFocus(i,t,a,l,xh.i.createDefaultSnapshot())}function wh(e,t){var n,i;if(!e.canvas3d)return;const s=null===(n=t.targets)||void 0===n?void 0:n.map(t=>{var n,i,s;const r=void 0!==t.targetRef?Bh(e,t.targetRef):Ih(e);if(!r)return;const o=null!==(n=t.radius)&&void 0!==n?n:r.radius*(null!==(i=t.radiusFactor)&&void 0!==i?i:1)+(null!==(s=t.extraRadius)&&void 0!==s?s:0);return Dd.f8.create(r.center,o)}).filter(e=>void 0!==e),r=s&&s.length>0?Th(s):Ih(e);return function(e,t){var n,i;const s=t.center,r=Math.max(t.radius,.01),o=null!==(n=t.direction)&&void 0!==n?n:Go.eB.sub((0,Go.eB)(),e.target,e.position),a=Go.eB.orthogonalize((0,Go.eB)(),o,null!==(i=t.up)&&void 0!==i?i:e.up),l=e.getTargetDistance(r),c=Go.eB.setMagnitude(kh,o,l),u=Go.eB.sub((0,Go.eB)(),s,c);return{target:s,position:u,up:a,radius:r}}(e.canvas3d.camera,{center:r.center,radius:Math.max(r.radius,null!==(i=t.minRadius)&&void 0!==i?i:0),up:t.up,direction:t.direction})}const kh=(0,Go.eB)();function Bh(e,t){const n=Ph([],e,t);if(0!==n.length)return 1===n.length?n[0]:Th(n)}function Ph(e,t,n){const i=t.state.data.cells.get(n),s=function(e,t){var n,i;const s=null==t?void 0:t.obj;if(!s)return;if(!s.data)return void console.warn("Focus: no data");if(s.data instanceof Gi.Structure){const r=Yi.QX.getDecorated(e.state.data,t.transform.ref),o=null!==(i=null===(n=null==r?void 0:r.obj)||void 0===n?void 0:n.data)&&void 0!==i?i:null==s?void 0:s.data,a=ts.QN.getBoundingSphere(Gi.Structure.Loci(o));return a?[a]:[]}if(Ls.O.isRepresentation3D(s)){const e=[];for(const t of s.data.repr.renderObjects){const n=t.values.boundingSphere.ref.value;n.radius>0&&e.push(n)}return e}return}(t,i);if(s)e.push(...s);else{t.state.data.tree.children.get(n).forEach(n=>Ph(e,t,n))}return e}function Ih(e){const t=function(e,t){let n=Array.from(e.state.data.cells.values()).filter(e=>e.obj&&Ls.O.isRepresentation3D(e.obj));t||(n=n.filter(e=>!e.state.isHidden));return n.flatMap(e=>e.obj.data.repr.renderObjects)}(e,!1);return Th(t.map(e=>e.values.boundingSphere.ref.value).filter(e=>e.radius>0))}let jh;function Th(e){null!=jh||(jh=new yh.Z("98")),jh.reset();for(const t of e)jh.includeSphere(t);jh.finishedIncludeStep();for(const t of e)jh.radiusSphere(t);return jh.getSphere()}const Ah={identity:Go.U.create(1,0,0,0,1,0,0,0,1),rotX90:Go.U.create(1,0,0,0,0,1,0,-1,0),rotY90:Go.U.create(0,0,-1,0,1,0,1,0,0),rotZ90:Go.U.create(0,1,0,-1,0,0,0,0,1),rotX270:Go.U.create(1,0,0,0,0,-1,0,1,0),rotY270:Go.U.create(0,0,1,0,1,0,-1,0,0),rotZ270:Go.U.create(0,-1,0,1,0,0,0,0,1),rotX180:Go.U.create(1,0,0,0,-1,0,0,0,-1),rotY180:Go.U.create(-1,0,0,0,1,0,0,0,-1),rotZ180:Go.U.create(-1,0,0,0,-1,0,0,0,1)};function Mh(e,t){const n=function(e,t){let n;return n=Lh(e,{onlyTrace:!0}),n.length>=3*t?n:(n=Lh(e,{skipHydrogens:!0,skipWater:!0}),n.length>=3*t||(n=Lh(e,{})),n)}(e,3);return function(e,t){if(0===e.length)return console.warn("Skipping PCA, no atoms"),{rotation:Ah.identity,origin:Go.eB.zero()};const n=bh.c.calculateMomentsAxes(e),i=bh.c.calculateNormalizedAxes(n),s=function(e,t,n){const i=(0,Go.U)();return Go.U.setValue(i,0,0,e[0]),Go.U.setValue(i,0,1,e[1]),Go.U.setValue(i,0,2,e[2]),Go.U.setValue(i,1,0,t[0]),Go.U.setValue(i,1,1,t[1]),Go.U.setValue(i,1,2,t[2]),Go.U.setValue(i,2,0,n[0]),Go.U.setValue(i,2,1,n[1]),Go.U.setValue(i,2,2,n[2]),i}(i.dirA,i.dirB,i.dirC);r=s,Go.U.determinant(r)<0&&(Go.U.setValue(r,2,0,-Go.U.getValue(r,2,0)),Go.U.setValue(r,2,1,-Go.U.getValue(r,2,1)),Go.U.setValue(r,2,2,-Go.U.getValue(r,2,2)));var r;const o=t?function(e,t){let n=Ah.identity,i=0;const s=(0,Go.U)();for(const r of[Ah.identity,Ah.rotX180,Ah.rotY180,Ah.rotZ180]){const o=Go.U.innerProduct(Go.U.mul(s,r,e),t);o>i&&(n=r,i=o)}return n}(s,t):function(e,t,n){const i=Go.eB.create(Go.U.getValue(t,0,0),Go.U.getValue(t,0,1),Go.U.getValue(t,0,2)),s=Go.eB.create(Go.U.getValue(t,1,0),Go.U.getValue(t,1,1),Go.U.getValue(t,1,2)),r=Go.eB.create(Go.U.getValue(t,2,0),Go.U.getValue(t,2,1),Go.U.getValue(t,2,2)),o=Math.floor(e.length/3),a=(0,Go.eB)();let l=0,c=0,u=0;for(let p=0;p<o;p++)Go.eB.fromArray(a,e,3*p),Go.eB.sub(a,a,n),l+=p*Go.eB.dot(a,i),c+=p*Go.eB.dot(a,s),u+=Eh(p,o)*Go.eB.dot(a,r);const d=u<0,h=d?l+c<0:l-c<0;return h&&d?Ah.rotY180:d?Ah.rotX180:h?Ah.rotZ180:Ah.identity}(e,s,n.origin);return Go.U.mul(s,o,s),{rotation:s,origin:i.origin}}(n,t)}function Lh(e,t){const{onlyTrace:n,skipHydrogens:i,skipWater:s}=t,{x:r,y:o,z:a,type_symbol:l,label_comp_id:c}=Gi.ZP.atom,u=[];for(const d of e){const e=Gi.iZ.Location.create(d);for(const t of d.units){e.unit=t;const d=n?t.polymerElements:t.elements;for(let t=0;t<d.length;t++)e.element=d[t],i&&"H"===l(e)||s&&"HOH"===c(e)||u.push(r(e),o(e),a(e))}}return u}function Eh(e,t){const n=Math.floor(t/2);return e<n?t%2?n-e:n-e-1:e-n}function Dh(e,t){const n=Go.U.invert((0,Go.U)(),t),i=Go.eB.distance(e.position,e.target),s=Go.eB.transformMat3((0,Go.eB)(),Go.eB.create(0,0,i),n),r=Go.eB.transformMat3((0,Go.eB)(),Go.eB.create(0,1,0),n),o=Go.eB.add((0,Go.eB)(),e.target,s);return{...e,position:o,up:r}}const Nh={minRadius:1,extraRadius:4,durationMs:250};class Fh{transformedLoci(e){var t,n;if(Gi.iZ.Loci.is(e)){const i=null===(n=null===(t=this.plugin.helpers.substructureParent.get(e.structure))||void 0===t?void 0:t.obj)||void 0===n?void 0:n.data;i&&(e=Gi.iZ.Loci.remap(e,i))}return e}focusRenderObjects(e,t){if(!e)return;const n=[];for(const i of e){const e=i.values.boundingSphere.ref.value;0!==e.radius&&n.push(e)}this.focusSpheres(n,e=>e,t)}focusLoci(e,t){let n;if(Array.isArray(e)&&e.length>1){const t=[];for(const n of e){const e=ts.QN.getBoundingSphere(this.transformedLoci(n));e&&t.push(e)}if(0===t.length)return;this.boundaryHelper.reset();for(const e of t)this.boundaryHelper.includeSphere(e);this.boundaryHelper.finishedIncludeStep();for(const e of t)this.boundaryHelper.radiusSphere(e);n=this.boundaryHelper.getSphere()}else if(Array.isArray(e)){if(0===e.length)return;n=ts.QN.getBoundingSphere(this.transformedLoci(e[0]))}else n=ts.QN.getBoundingSphere(this.transformedLoci(e));n&&this.focusSphere(n,t)}focusSpheres(e,t,n){const i=[];for(const s of e){const e=t(s);e&&i.push(e)}if(0!==i.length){if(1===i.length)return this.focusSphere(i[0],n);this.boundaryHelper.reset();for(const e of i)this.boundaryHelper.includeSphere(e);this.boundaryHelper.finishedIncludeStep();for(const e of i)this.boundaryHelper.radiusSphere(e);this.focusSphere(this.boundaryHelper.getSphere(),n)}}focusSphere(e,t){var n;const{canvas3d:i}=this.plugin;if(!i)return;const{extraRadius:s,minRadius:r,durationMs:o}={...Nh,...t},a=Math.max(e.radius+s,r);if(null==t?void 0:t.principalAxes){const e=Ch(this.plugin,a,t);null===(n=this.plugin.canvas3d)||void 0===n||n.requestCameraReset({durationMs:o,snapshot:e})}else{const t=i.camera.getFocus(e.center,a);i.requestCameraReset({durationMs:o,snapshot:t})}}focusObject(e){var t,n,i;if(!this.plugin.canvas3d)return;const s=wh(this.plugin,{...e,targets:null===(t=e.targets)||void 0===t?void 0:t.map(e=>{var t;return{...e,extraRadius:null!==(t=e.extraRadius)&&void 0!==t?t:Nh.extraRadius}}),minRadius:null!==(n=e.minRadius)&&void 0!==n?n:Nh.minRadius});this.plugin.canvas3d.requestCameraReset({snapshot:s,durationMs:null!==(i=e.durationMs)&&void 0!==i?i:Nh.durationMs})}orientAxes(e,t){if(!this.plugin.canvas3d)return;if(!e){e=this.plugin.state.data.selectQ(e=>e.ofType(Ls.O.Molecule.Structure)).filter(e=>e.obj&&!e.transform.transformer.definition.isDecorator&&!e.obj.data.parent).map(e=>{var t;return null===(t=e.obj)||void 0===t?void 0:t.data}).filter(e=>!!e)}const{rotation:n}=Mh(e),i=Dh(this.plugin.canvas3d.camera.getSnapshot(),n);this.setSnapshot(i,t)}resetAxes(e){if(!this.plugin.canvas3d)return;const t=Dh(this.plugin.canvas3d.camera.getSnapshot(),Go.U.Identity);this.setSnapshot(t,e)}setSnapshot(e,t){var n;null===(n=this.plugin.canvas3d)||void 0===n||n.requestCameraReset({snapshot:e,durationMs:t})}reset(e,t){var n;null===(n=this.plugin.canvas3d)||void 0===n||n.requestCameraReset({snapshot:e,durationMs:t})}constructor(e){this.plugin=e,this.boundaryHelper=new yh.Z("98")}}class Rh{clearProviders(){this.providers=[],this.isDirty=!0,this.showLabels()}addProvider(e){this.providers.push(e),this.providers.sort((e,t)=>(t.priority||0)-(e.priority||0)),this.isDirty=!0,this.showLabels()}removeProvider(e){this.providers=this.providers.filter(t=>t!==e),this.isDirty=!0,this.showLabels()}mark(e,t){const n=this.locis.findIndex(t=>Er.YL.Loci.areEqual(e,t));-1===n&&t===Dr.xi.Highlight?(this.locis.push(e),this.isDirty=!0):-1!==n&&t===Dr.xi.RemoveHighlight&&((0,wr.P6)(this.locis,n),this.isDirty=!0)}showLabels(){this.ctx.behaviors.labels.highlight.next({labels:this.getLabels()})}getLabels(){if(this.isDirty){this.groupedLabels.clear(),this.labels.length=0;for(const e of this.providers)for(const t of this.locis){if(ts.QN.isEmpty(t.loci))continue;const n=e.label(t.loci,t.repr);if(n){const t=e.group?e.group(n):n.toString(),i=this.groupedLabels.get(t);i?i.push(n):this.groupedLabels.set(t,[n])}}this.labels.length=0,this.groupedLabels.forEach((e,t)=>{const n=e.length,i=n>1&&e[0]!==e[1]?t:e[0];this.labels.push(1===n?i:`${i} <small>||  ${n}</small>`)}),this.isDirty=!1}return this.labels}constructor(e){this.ctx=e,this.providers=[],this.locis=[],this.isDirty=!1,this.labels=[],this.groupedLabels=new Map,e.managers.interactivity.lociHighlights.addProvider((e,t,n)=>{0!==this.providers.length&&(this.mark(e,t),n||this.showLabels())})}}var Oh=n(78945);const zh=new yh.Z("98");class Hh extends Wi.e{get entries(){return this.state.entries}get additionsHistory(){return this.state.additionsHistory}get stats(){return this.state.stats||(this.state.stats=this.calcStats()),this.state.stats}getEntry(e){const t=this.plugin.helpers.substructureParent.get(e,!0);if(!t)return;const n=t.transform.ref;if(!this.entries.has(n)){const t=new Uh(Gi.iZ.Loci(e,[]));return this.entries.set(n,t),t}return this.entries.get(n)}calcStats(){let e=0,t=0;const n=Gi.iZ.Stats.create();this.entries.forEach(i=>{const{elements:s}=i.selection;if(s.length){e+=1;for(let e=0,n=s.length;e<n;++e)t+=ho.CD.size(s[e].indices);Gi.iZ.Stats.add(n,n,Gi.iZ.Stats.ofLoci(i.selection))}});const i=(0,Lr.d_)(n,{countsOnly:!0});return{structureCount:e,elementCount:t,label:i}}add(e){if(!Gi.iZ.Loci.is(e))return!1;const t=this.getEntry(e.structure);if(!t)return!1;const n=t.selection;return t.selection=Gi.iZ.Loci.union(t.selection,e),this.tryAddHistory(e),this.referenceLoci=e,this.events.loci.add.next(e),!Gi.iZ.Loci.areEqual(n,t.selection)}remove(e){if(!Gi.iZ.Loci.is(e))return!1;const t=this.getEntry(e.structure);if(!t)return!1;const n=t.selection;return t.selection=Gi.iZ.Loci.subtract(t.selection,e),this.referenceLoci=e,this.events.loci.remove.next(e),!Gi.iZ.Loci.areEqual(n,t.selection)}intersect(e){if(!Gi.iZ.Loci.is(e))return!1;const t=this.getEntry(e.structure);if(!t)return!1;const n=t.selection;return t.selection=Gi.iZ.Loci.intersect(t.selection,e),this.referenceLoci=e,!Gi.iZ.Loci.areEqual(n,t.selection)}set(e){if(!Gi.iZ.Loci.is(e))return!1;const t=this.getEntry(e.structure);if(!t)return!1;const n=t.selection;return t.selection=e,this.tryAddHistory(e),this.referenceLoci=void 0,!Gi.iZ.Loci.areEqual(n,t.selection)}modifyHistory(e,t,n,i=!1){const s=this.additionsHistory,r=s.indexOf(e);if(r<0)return;let o;switch(t){case"remove":(0,wr.P6)(s,r);break;case"up":o=r-1;break;case"down":o=r+1}if(void 0!==o){const e=n?Math.min(s.length,n):s.length;for(;;){if(o%=e,o<0&&(o+=e),!i||s[r].loci.structure===s[o].loci.structure){const e=s[r];s[r]=s[o],s[o]=e;break}o+="up"===t?-1:1}}this.events.additionsHistoryUpdated.next(void 0)}tryAddHistory(e){if(ts.QN.isEmpty(e))return;let t,n=0;for(const r of this.additionsHistory){if(ts.QN.areEqual(r.loci,e)){t=r;break}n++}if(t)return(0,wr.P6)(this.additionsHistory,n),this.additionsHistory.unshift(t),void this.events.additionsHistoryUpdated.next(void 0);const i=Gi.iZ.Stats.ofLoci(e),s=(0,Lr.d_)(i,{reverse:!0});this.additionsHistory.unshift({id:a.kk.create22(),loci:e,label:s}),this.additionsHistory.length>24&&this.additionsHistory.pop(),this.events.additionsHistoryUpdated.next(void 0)}clearHistory(){0!==this.state.additionsHistory.length&&(this.state.additionsHistory=[],this.events.additionsHistoryUpdated.next(void 0))}clearHistoryForStructure(e){const t=[];for(const n of this.state.additionsHistory)n.loci.structure.root===e.root&&t.push(n);for(const n of t)this.modifyHistory(n,"remove");0!==t.length&&this.events.additionsHistoryUpdated.next(void 0)}onRemove(e,t){var n;this.entries.has(e)&&(this.entries.delete(e),(null==t?void 0:t.data)&&this.clearHistoryForStructure(t.data),(null===(n=this.referenceLoci)||void 0===n?void 0:n.structure)===(null==t?void 0:t.data)&&(this.referenceLoci=void 0),this.state.stats=void 0,this.events.changed.next(void 0))}onUpdate(e,t,n){var i,s,r,o;if(t===n||(null==t?void 0:t.data)===n.data)return;const a=this.plugin.helpers.substructureParent.get(n.data,!0);if(!a)return;if(e!==a.transform.ref)return;if(!this.entries.has(e))return;const l=null===(s=null===(i=this.plugin.helpers.substructureParent.get(n.data))||void 0===i?void 0:i.obj)||void 0===s?void 0:s.data;var c,u;if(l)if(!(null==t?void 0:t.data)||Gi.Structure.areUnitIdsAndIndicesEqual(t.data,n.data)){this.entries.set(e,(c=this.entries.get(e),u=l,new Uh(Gi.iZ.Loci.remap(c.selection,u)))),(null===(r=this.referenceLoci)||void 0===r?void 0:r.structure.root)===l.root&&(this.referenceLoci=Gi.iZ.Loci.remap(this.referenceLoci,l));let t=!1;for(const e of this.state.additionsHistory)e.loci.structure.root===l.root&&(e.loci=Gi.iZ.Loci.remap(e.loci,l),t=!0);t&&this.events.additionsHistoryUpdated.next(void 0)}else this.entries.set(e,new Uh(Gi.iZ.Loci(l,[]))),(null===(o=this.referenceLoci)||void 0===o?void 0:o.structure.root)===l.root&&(this.referenceLoci=void 0),this.clearHistoryForStructure(l),this.state.stats=void 0,this.events.changed.next(void 0)}clear(){const e=this.entries.keys(),t=[];for(;;){const n=e.next();if(n.done)break;const i=this.entries.get(n.value);Gi.iZ.Loci.isEmpty(i.selection)||t.push(i.selection),i.selection=Gi.iZ.Loci(i.selection.structure,[])}return this.referenceLoci=void 0,this.state.stats=void 0,this.events.changed.next(void 0),this.events.loci.clear.next(void 0),this.clearHistory(),t}getLoci(e){const t=this.getEntry(e);return t?t.selection:ts.BL}getStructure(e){const t=this.getEntry(e);if(t)return t.structure}structureHasSelection(e){var t,n;const i=null===(n=null===(t=e.cell)||void 0===t?void 0:t.obj)||void 0===n?void 0:n.data;if(!i)return!1;const s=this.getEntry(i);return!!s&&!Gi.iZ.Loci.isEmpty(s.selection)}has(e){if(Gi.iZ.Loci.is(e)){const t=this.getEntry(e.structure);if(t)return Gi.iZ.Loci.isSubset(t.selection,e)}return!1}tryGetRange(e){if(Gi.iZ.Loci.is(e)&&this.getEntry(e.structure))return Vh(this.referenceLoci,e)}elementCount(){let e=0;return this.entries.forEach(t=>{e+=Gi.iZ.Loci.size(t.selection)}),e}getBoundary(){const e=Go.eB.create(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t=Go.eB.create(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);zh.reset();const n=[];this.entries.forEach(e=>{const t=e.selection;Gi.iZ.Loci.isEmpty(t)||n.push(Gi.iZ.Loci.getBoundary(t))});for(let i=0,s=n.length;i<s;++i){const{box:s,sphere:r}=n[i];Go.eB.min(e,e,s.min),Go.eB.max(t,t,s.max),zh.includePositionRadius(r.center,r.radius)}zh.finishedIncludeStep();for(let i=0,s=n.length;i<s;++i){const{sphere:e}=n[i];zh.radiusPositionRadius(e.center,e.radius)}return{box:{min:e,max:t},sphere:zh.getSphere()}}getPrincipalAxes(){const e=(0,Ad.ZR)(this.entries.values());return Gi.iZ.Loci.getPrincipalAxesMany(e.map(e=>e.selection))}modify(e,t){let n=!1;switch(e){case"add":n=this.add(t);break;case"remove":n=this.remove(t);break;case"intersect":n=this.intersect(t);break;case"set":n=this.set(t)}n&&(this.state.stats=void 0,this.events.changed.next(void 0))}get applicableStructures(){return this.plugin.managers.structure.hierarchy.selection.structures.filter(e=>!!e.cell.obj).map(e=>e.cell.obj.data)}triggerInteraction(e,t,n=!0){switch(e){case"add":this.plugin.managers.interactivity.lociSelects.select({loci:t},n);break;case"remove":this.plugin.managers.interactivity.lociSelects.deselect({loci:t},n);break;case"intersect":this.plugin.managers.interactivity.lociSelects.selectJoin({loci:t},n);break;case"set":this.plugin.managers.interactivity.lociSelects.selectOnly({loci:t},n)}}fromLoci(e,t,n=!0){this.triggerInteraction(e,t,n)}fromCompiledQuery(e,t,n=!0){for(const i of this.applicableStructures){const s=t(new Gi.cY(i));this.triggerInteraction(e,Gi.cv.toLociWithSourceUnits(s),n)}}fromSelectionQuery(e,t,n=!0){this.plugin.runTask(Zi.YZ.create("Structure Selection",async i=>{for(const s of this.applicableStructures){const r=await t.getSelection(this.plugin,i,s);this.triggerInteraction(e,Gi.cv.toLociWithSourceUnits(r),n)}}))}fromSelections(e){var t;const n=Yi.so.resolveAndCheck(this.plugin.state.data,e);if(n&&n.obj)if(Ls.O.Molecule.Structure.Selections.is(n.obj)){this.clear();for(const e of null===(t=n.obj)||void 0===t?void 0:t.data)this.fromLoci("set",e.loci)}else console.warn("fromSelections applied to wrong object type.",n.obj)}getSnapshot(){const e=[];return this.entries.forEach((t,n)=>{e.push({ref:n,bundle:Gi.iZ.Bundle.fromLoci(t.selection)})}),{entries:e}}setSnapshot(e){var t,n;this.entries.clear();for(const{ref:i,bundle:s}of e.entries){const e=null===(n=null===(t=this.plugin.state.data.select(Yi.QX.Generators.byRef(i))[0])||void 0===t?void 0:t.obj)||void 0===n?void 0:n.data;if(!e)continue;const r=Gi.iZ.Bundle.toLoci(s,e);this.fromLoci("set",r,!1)}}constructor(e){super({entries:new Map,additionsHistory:[],stats:{structureCount:0,elementCount:0,label:"Nothing Selected"}}),this.plugin=e,this.events={changed:this.ev(),additionsHistoryUpdated:this.ev(),loci:{add:this.ev(),remove:this.ev(),clear:this.ev()}},e.helpers.substructureParent.events.removed.subscribe(e=>this.onRemove(e.ref,e.obj)),e.helpers.substructureParent.events.updated.subscribe(e=>this.onUpdate(e.ref,e.oldObj,e.obj))}}class Uh{get selection(){return this._selection}set selection(e){this._selection=e,this._structure=void 0}get structure(){return this._structure||(ts.QN.isEmpty(this._selection)?this._structure=void 0:this._structure=Gi.iZ.Loci.toStructure(this._selection)),this._structure}constructor(e){this._structure=void 0,this._selection=e}}function Vh(e,t){if(!Gi.iZ.Loci.is(e))return;if(!Gi.iZ.Loci.is(t))return;if(e.structure!==t.structure)return;if(1!==t.elements.length)return;const n=t.elements[0];if(!n)return;let i;for(const s of e.elements)if(n.unit===s.unit){i=s;break}return i&&n.unit===i.unit?function(e,t,n){const i=Math.min(ho.CD.min(t.indices),ho.CD.min(n.indices)),s=Math.max(ho.CD.max(t.indices),ho.CD.max(n.indices));return Gi.iZ.Loci(e,[{unit:t.unit,indices:ho.CD.ofRange(i,s)}])}(t.structure,i,n):void 0}class _h extends Wi.e{get current(){return this.state.current}get history(){return this.state.history}tryAddHistory(e){if(Gi.iZ.Loci.isEmpty(e.loci))return;let t,n=0;for(const i of this.state.history){if(Gi.iZ.Loci.areEqual(i.loci,e.loci)){t=i;break}n++}if(t)return(0,wr.P6)(this.state.history,n),this.state.history.unshift(e),void this.events.historyUpdated.next(void 0);this.state.history.unshift(e),this.state.history.length>8&&this.state.history.pop(),this.events.historyUpdated.next(void 0)}set(e){this.tryAddHistory(e),this.state.current&&Gi.iZ.Loci.areEqual(this.state.current.loci,e.loci)||(this.state.current=e,this.behaviors.current.next(e))}tryGetRange(e){return Vh(this.referenceLoci,e)}setFromLoci(e){const t=ts.QN.normalize(e);Gi.iZ.Loci.is(t)&&!Gi.iZ.Loci.isEmpty(t)?(this.set({loci:t,label:(0,Lr.YQ)(t,{reverse:!0,hidePrefix:!0,htmlStyling:!1})}),this.referenceLoci=t):this.clear()}addFromLoci(e){const t=this.state.current&&Gi.iZ.Loci.is(e)&&e.structure===this.state.current.loci.structure?Gi.iZ.Loci.union(e,this.state.current.loci):e;this.setFromLoci(t);const n=ts.QN.normalize(e);this.referenceLoci=Gi.iZ.Loci.is(n)?n:void 0}toggleFromLoci(e){var t;const{kind:n,loci:i}=(s=null===(t=this.state.current)||void 0===t?void 0:t.loci,r=e,s&&Gi.iZ.Loci.is(r)&&r.structure===s.structure?Gi.iZ.Loci.isSubset(s,r)?{kind:"subtract",loci:Gi.iZ.Loci.subtract(s,r)}:{kind:"add",loci:Gi.iZ.Loci.union(r,s)}:{kind:"new",loci:r});var s,r;this.setFromLoci(i);const o=ts.QN.normalize(e);this.referenceLoci=Gi.iZ.Loci.is(o)&&"subtract"!==n?o:void 0}extendFromLoci(e){var t;const n=null!==(t=this.tryGetRange(e))&&void 0!==t?t:e;this.toggleFromLoci(n)}clear(){this.state.current&&(this.state.current=void 0,this.behaviors.current.next(void 0)),this.referenceLoci=void 0}getSnapshot(){if(!this.current)return{};const e=this.plugin.helpers.substructureParent.get(this.current.loci.structure),t=null==e?void 0:e.transform.ref;return t?{current:{label:this.current.label,ref:t,bundle:Gi.iZ.Bundle.fromLoci(this.current.loci),category:this.current.category}}:{}}setSnapshot(e){var t,n;if(!e.current)return void this.clear();const{label:i,ref:s,bundle:r,category:o}=e.current,a=null===(n=null===(t=this.plugin.state.data.select(Yi.QX.Generators.byRef(s))[0])||void 0===t?void 0:t.obj)||void 0===n?void 0:n.data;if(!a)return;const l=Gi.iZ.Bundle.toLoci(r,a);this.set({label:i,loci:l,category:o})}constructor(e){super({history:[]}),this.plugin=e,this.events={historyUpdated:this.ev()},this.behaviors={current:this.ev.behavior(void 0)},e.state.data.events.object.removed.subscribe(({obj:e})=>{var t;if(!Ls.O.Molecule.Structure.is(e))return;(null===(t=this.current)||void 0===t?void 0:t.loci.structure)===e.data&&this.clear();const n=[];for(const i of this.history)i.loci.structure===e.data&&n.push(i);n.length!==this.history.length&&(this.history.length=0,this.history.push(...n),this.events.historyUpdated.next(void 0))});const t=(0,Dd.f8)();e.state.data.events.object.updated.subscribe(({oldData:e,obj:n,action:i})=>{var s;if(Ls.O.Molecule.Structure.is(n)&&e!==n.data&&"in-place"===i){const i=this.state.current,r=n.data;if(i&&i.loci.structure===e){const e=Gi.iZ.Loci.remap(i.loci,r);this.state.current={...i,loci:e},this.behaviors.current.next(this.state.current),ts.QN.getBoundingSphere(e,t);const n=null===(s=this.plugin.canvas3d)||void 0===s?void 0:s.camera,o=n.getTargetDistance(t.radius+4);(Go.eB.distance(n.target,t.center)>t.radius||o>n.viewport.height/n.zoom)&&this.plugin.managers.camera.focusSphere(t,{durationMs:0})}}})}}var Gh=n(46800);const qh=[{name:"center-camera",execute:({event:e,args:t,manager:n})=>{"click"===e&&"center-camera"in t&&n.plugin.managers.camera.reset()}},{name:"apply-snapshot",execute:({event:e,args:t,manager:n})=>{if("click"!==e)return;const i=t["apply-snapshot"];i&&n.plugin.managers.snapshot.applyKey(i)}},{name:"next-snapshot",execute:({event:e,args:t,manager:n})=>{if("click"!==e||!("next-snapshot"in t))return;let i=+t["next-snapshot"]||1;i&&(i=i<0?-1:1,n.plugin.managers.snapshot.applyNext(i))}},{name:"focus-refs",execute:({event:e,args:t,manager:n})=>{if("click"!==e)return;const i=Zh(t["focus-refs"]);if(!(null==i?void 0:i.length))return;const s=n.findCells(i);if(!s.length)return;const r=Kh(n.plugin,s);if(!r.length)return;const o=r.map(e=>Bh(n.plugin,e.transform.ref)).filter(e=>!!e);o.length&&n.plugin.managers.camera.focusSpheres(o,e=>e,{extraRadius:3})}},{name:"highlight-refs",execute:({event:e,args:t,manager:n})=>{var i;const s=Zh(t["highlight-refs"]);if(null==s?void 0:s.length)if("mouse-leave"===e&&s.length)n.plugin.managers.interactivity.lociHighlights.clearHighlights();else if("mouse-enter"===e){const e=n.findCells(s);for(const t of Kh(n.plugin,e)){if(!(null===(i=t.obj)||void 0===i?void 0:i.data))continue;const{repr:e}=t.obj.data;for(const t of e.getAllLoci())n.plugin.managers.interactivity.lociHighlights.highlight({loci:t,repr:e},!1)}}}},{name:"query",execute:({event:e,args:t,manager:n})=>{var i;const s=t.query;if(!(null==s?void 0:s.length))return;const r=t.lang||"mol-script",o=Zh(t.action||"highlight"),a=parseFloat(t["focus-radius"]||"3");if("mouse-leave"===e)return void(o.includes("highlight")&&n.plugin.managers.interactivity.lociHighlights.clearHighlights());let l;try{l=Gh.e.toQuery({language:r,expression:s})}catch(u){return void console.warn(`Failed to parse query '${s}' (${r})`,u)}const c=n.plugin.state.data.selectQ(e=>e.rootsOfType(Ls.O.Molecule.Structure));if("mouse-enter"===e){if(!o.includes("focus"))return;n.plugin.managers.interactivity.lociHighlights.clearHighlights();for(const e of c){if(!(null===(i=e.obj)||void 0===i?void 0:i.data))continue;const t=l(new Gi.cY(e.obj.data)),s=Gi.cv.toLociWithSourceUnits(t);n.plugin.managers.interactivity.lociHighlights.highlight({loci:s},!1)}}if("click"===e){if(!o.includes("focus"))return;const e=c.map(e=>Yi.QX.getDecorated(n.plugin.state.data,e.transform.ref)).map(e=>{var t;if(!(null===(t=e.obj)||void 0===t?void 0:t.data))return;const n=l(new Gi.cY(e.obj.data));if(Gi.cv.isEmpty(n))return;const i=Gi.cv.toLociWithSourceUnits(n);return Gi.iZ.Loci.getBoundary(i).sphere}).filter(e=>!!e);e.length&&n.plugin.managers.camera.focusSpheres(e,e=>e,{extraRadius:a})}}},{name:"play-audio",execute:({event:e,args:t,manager:n})=>{if("click"!==e)return;const i=t["play-audio"];(null==i?void 0:i.length)&&n.audio.play(i)}},{name:"toggle-audio",execute:({event:e,args:t,manager:n})=>{if("click"!==e||!("toggle-audio"in t))return;const i=t["toggle-audio"];n.audio.play(i,{toggle:!0})}},{name:"pause-audio",execute:({event:e,args:t,manager:n})=>{"click"===e&&"pause-audio"in t&&n.audio.pause()}},{name:"stop-audio",execute:({event:e,args:t,manager:n})=>{"click"===e&&"stop-audio"in t&&n.audio.stop()}},{name:"dispose-audio",execute:({event:e,args:t,manager:n})=>{"click"===e&&"dispose-audio"in t&&n.audio.dispose()}},{name:"play-transition",execute:({event:e,args:t,manager:n})=>{"click"===e&&"play-transition"in t&&n.plugin.managers.animation.play(Lc.c,{})}},{name:"play-snapshots",execute:({event:e,args:t,manager:n})=>{"click"===e&&"play-snapshots"in t&&n.plugin.managers.snapshot.play({restart:!0})}},{name:"stop-animation",execute:({event:e,args:t,manager:n})=>{"click"===e&&"stop-animation"in t&&n.plugin.managers.snapshot.stop()}}];class $h{registerArgsParser(e,t,n){this.removeArgsParser(e),this.argsParsers.push([e,t,n]),this.argsParsers.sort((e,t)=>t[1]-e[1])}removeArgsParser(e){const t=this.argsParsers.findIndex(t=>t[0]===e);t>=0&&this.argsParsers.splice(t,1)}parseArgs(e){for(const[,,t]of this.argsParsers){const n=t(e);if(n)return n}}registerRefResolver(e,t){this.refResolvers[e]=t}removeRefResolver(e){delete this.refResolvers[e]}registerUriResolver(e,t){this.uriResolvers[e]=t}removeUriResolver(e){delete this.uriResolvers[e]}registerExtension(e){const t=this.extension.findIndex(t=>t.name===e.name);t>=0?this.extension[t]=e:this.extension.push(e)}removeExtension(e){const t=this.extension.findIndex(t=>t.name===e);t>=0&&this.extension.splice(t,1)}_tryRender(e,t){var n;try{return null===(n=e.reactRenderFn)||void 0===n?void 0:n.call(e,t)}catch(i){return console.error(`Failed to render markdown extension '${e.name}'`,i),null}}tryRender(e,t){const n={args:e,manager:this};for(const i of this.extension){const e=this._tryRender(i,n);if(e)return e}for(const i of t){const e=this._tryRender(i,n);if(e)return e}return null}tryExecute(e,t){var n;const i={event:e,args:t,manager:this};for(const r of this.extension)try{null===(n=r.execute)||void 0===n||n.call(r,i)}catch(s){console.error(`Failed to execute markdown extension '${r.name}'`,s)}}tryResolveUri(e){for(const t of Object.values(this.uriResolvers)){const n=t(this.plugin,e);if(n)return n}}findCells(e){const t=new Set,n=[];for(const i of Object.values(this.refResolvers))for(const s of i(this.plugin,e))s&&!t.has(s.transform.ref)&&(t.add(s.transform.ref),n.push(s));return n}resolveAudioPlayer(){if(this.state.audioPlayer.value)return this.state.audioPlayer.value;const e=document.createElement("audio");return e.controls=!0,e.preload="auto",e.style.width="100%",e.style.height="32px",this.state.audioPlayer.next(e),e}get audioPlayer(){return this.state.audioPlayer.value}constructor(e){this.plugin=e,this.state={audioPlayer:new lr.t(null)},this.extension=[],this.refResolvers={default:(e,t)=>t.map(t=>e.state.data.cells.get(t)).filter(e=>!!e)},this.uriResolvers={},this.argsParsers=[["default",100,Qh]],this.audio={play:async(e,t)=>{try{const n=this.resolveAudioPlayer();let i=!1;if(null==e?void 0:e.trim()){const t=this.tryResolveUri(e);let s=e;"function"==typeof(null==t?void 0:t.then)?s=await t:t&&(s=t),i=n.src!==s,i&&(n.src=s,n.load())}!i&&(null==t?void 0:t.toggle)?n.paused?await n.play():n.pause():(n.currentTime=0,await n.play())}catch(n){console.error("Failed to play audio",n)}},pause:()=>{var e;null===(e=this.audioPlayer)||void 0===e||e.pause()},stop:()=>{this.audioPlayer&&(this.audioPlayer.pause(),this.audioPlayer.currentTime=0)},dispose:()=>{this.audioPlayer&&(this.audioPlayer.pause(),this.audioPlayer.currentTime=0,this.state.audioPlayer.next(null))}};for(const t of qh)this.registerExtension(t)}}function Zh(e){var t;return null!==(t=null==e?void 0:e.split(",").map(e=>e.trim()).filter(e=>e.length>0))&&void 0!==t?t:[]}function Kh(e,t){return t.length?e.state.data.selectQ(e=>e.byValue(...t).subtree().filter(e=>Ls.O.isRepresentation3D(e.obj))):[]}function Qh(e){if(!(null==e?void 0:e.startsWith("!")))return;const t=decodeURIComponent(e.substring(1)).split("&").map(e=>e.trim()).filter(e=>e.length>0).map(e=>e.split("=",2).map(e=>e.trim()));return 0!==t.length?Object.fromEntries(t):void 0}const Xh=[["full","Full"],["hidden","Hidden"]],Wh={isExpanded:Xi.t.Boolean(!1),showControls:Xi.t.Boolean(!0),regionState:Xi.t.Group({left:Xi.t.Select("full",[["full","Full"],["collapsed","Collapsed"],["hidden","Hidden"]]),top:Xi.t.Select("full",Xh),right:Xi.t.Select("full",Xh),bottom:Xi.t.Select("full",Xh)}),controlsDisplay:Xi.t.Value("outside",{isHidden:!0}),expandToFullscreen:Xi.t.Boolean(!1)};class Yh extends Wi.e{updateProps(e){const t=!!this.state.isExpanded;if(this.updateState(e),this.root&&"boolean"==typeof e.isExpanded&&e.isExpanded!==t&&this.handleExpand(),this.state.expandToFullscreen){const e=document.getElementsByTagName("body")[0];e&&this.tryRequestFullscreen(e)}else document.fullscreenElement&&this.tryExitFullscreen();this.events.updated.next(void 0)}setProps(e){this.updateState(e)}setRoot(e){this.root=e,this.state.isExpanded&&this.handleExpand()}getScrollElement(){return document.scrollingElement?document.scrollingElement:document.documentElement?document.documentElement:document.body}async tryRequestFullscreen(e){if(!document.fullscreenElement)try{await e.requestFullscreen()}catch(t){console.error(t)}}async tryExitFullscreen(){if(document.fullscreenElement)try{await document.exitFullscreen()}catch(e){console.error(e)}}handleExpand(){try{const e=document.getElementsByTagName("body")[0],t=document.getElementsByTagName("head")[0];if(!e||!t||!this.root)return;if(this.state.isExpanded){const n=t.children,i=[];let s=!1;for(let e=0;e<n.length;e++)n[e]===this.expandedViewport?s=!0:"viewport"===(n[e].name||"").toLowerCase()&&i.push(n[e]);for(const e of i)t.removeChild(e);s||t.appendChild(this.expandedViewport);const r=e.style,o=this.getScrollElement(),a=o.scrollLeft,l=o.scrollTop;this.rootState={top:r.top,bottom:r.bottom,right:r.right,left:r.left,scrollTop:l,scrollLeft:a,position:r.position,overflow:r.overflow,viewports:i,zIndex:this.root.style.zIndex,width:r.width,height:r.height,maxWidth:r.maxWidth,maxHeight:r.maxHeight,margin:r.margin,marginLeft:r.marginLeft,marginRight:r.marginRight,marginTop:r.marginTop,marginBottom:r.marginBottom},r.overflow="hidden",r.position="fixed",r.top="0",r.bottom="0",r.right="0",r.left="0",r.width="100%",r.height="100%",r.maxWidth="100%",r.maxHeight="100%",r.margin="0",r.marginLeft="0",r.marginRight="0",r.marginTop="0",r.marginBottom="0"}else{const n=t.children;for(let e=0;e<n.length;e++)if(n[e]===this.expandedViewport){t.removeChild(this.expandedViewport);break}if(this.state.expandToFullscreen&&document.fullscreenElement&&document.exitFullscreen(),this.rootState){const n=this.rootState;for(const e of n.viewports)t.appendChild(e);const i=e.style;i.top=n.top,i.bottom=n.bottom,i.left=n.left,i.right=n.right,i.width=n.width,i.height=n.height,i.maxWidth=n.maxWidth,i.maxHeight=n.maxHeight,i.margin=n.margin,i.marginLeft=n.marginLeft,i.marginRight=n.marginRight,i.marginTop=n.marginTop,i.marginBottom=n.marginBottom,i.position=n.position,i.overflow=n.overflow||"";const s=this.getScrollElement();s.scrollTop=n.scrollTop,s.scrollLeft=n.scrollLeft,this.rootState=void 0,this.root.style.zIndex=n.zIndex}}}catch(e){const t="Layout change error, you might have to reload the page.";this.context.log.error(t),console.error(t,e)}}dispose(){super.dispose(),document.removeEventListener("fullscreenchange",this.fullscreenChangeHandler),document.removeEventListener("webkitfullscreenchange",this.fullscreenChangeHandler)}constructor(e){super({...Xi.t.getDefaultValues(Wh),...e.spec.layout&&e.spec.layout.initial}),this.context=e,this.events={updated:this.ev()},this.rootState=void 0,this.fullscreenChangeHandler=()=>{document.fullscreenElement||this.updateProps({expandToFullscreen:!1})},document.addEventListener("fullscreenchange",this.fullscreenChangeHandler),document.addEventListener("webkitfullscreenchange",this.fullscreenChangeHandler),Fi.a.Layout.Update.subscribe(e,e=>this.updateProps(e.state)),"undefined"!=typeof document&&(this.expandedViewport=document.createElement("meta"),this.expandedViewport.name="viewport",this.expandedViewport.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0")}}var Jh=n(47478),ep=n(87346),tp=n(96762),np=n(52500),ip=n(43533),sp=n(99487),rp=n(23346),op=n(67651);const ap={includeTypes:Xi.t.MultiSelect((0,sp.mX)(np.I$.Names),Xi.t.objectToOptions(np.I$.Names)),excludeTypes:Xi.t.MultiSelect([],Xi.t.objectToOptions(np.I$.Names)),ignoreHydrogens:Xi.t.Boolean(!1),ignoreHydrogensVariant:Xi.t.Select("all",Xi.t.arrayToOptions(["all","non-polar"])),aromaticBonds:Xi.t.Boolean(!0,{description:"Display aromatic bonds with dashes"}),multipleBonds:Xi.t.Select("symmetric",Xi.t.arrayToOptions(["off","symmetric","offset"]))},lp=(Xi.t.getDefaultValues(ap),{...ep.Lr,...ap,adjustCylinderLength:Xi.t.Boolean(!1,{description:"Shorten cylinders to reduce overlap with spheres. Useful for for transparent bonds. Not working well with aromatic bonds."})}),cp=(Xi.t.getDefaultValues(lp),{...ep.T9,...ap});Xi.t.getDefaultValues(cp);function up(e,t,n){return!np.I$.is(e,n)||np.I$.is(t,n)}function dp(e,t,n){const i=t.elements,s=t.bonds,{a:r,b:o,edgeProps:a}=s,{flags:l}=a,{ignoreHydrogens:c,ignoreHydrogensVariant:u,includeTypes:d,excludeTypes:h}=n,p=np.I$.fromNames(d),m=np.I$.fromNames(h),f=np.I$.isAll(p)&&np.I$.Flag.None===m,{child:g}=e,y=null==g?void 0:g.unitMap.get(t.id);if(g&&!y)throw new Error("expected childUnit to exist if child exists");if(!f||c||g)return n=>{const s=r[n],a=o[n];return!(!y||ho.X9.has(y.elements,i[s]))||(!(f||!up(p,m,l[n]))||!!c&&!(!(0,op.v3)(e,t,i[s],u)&&!(0,op.v3)(e,t,i[a],u)))}}function hp(e,t){const n=e.interUnitBonds,{edges:i}=n,{ignoreHydrogens:s,ignoreHydrogensVariant:r,includeTypes:o,excludeTypes:a}=t,l=np.I$.fromNames(o),c=np.I$.fromNames(a),u=np.I$.isAll(l)&&np.I$.Flag.None===c,{child:d}=e;if(!u||s||d)return t=>{if(d){const n=i[t],s=d.unitMap.get(n.unitA);if(!s)return!0;const r=e.unitMap.get(n.unitA).elements[n.indexA];if(!ho.X9.has(s.elements,r))return!0}if(s){const n=i[t],s=e.unitMap.get(n.unitA),o=e.unitMap.get(n.unitB);if((0,op.v3)(e,s,s.elements[n.indexA],r)||(0,op.v3)(e,o,o.elements[n.indexB],r))return!0}return!(u||!up(l,c,i[t].props.flag))}}function pp(e,t){return!Gi.Nf.Traits.is(e.traits,Gi.Nf.Trait.Water)||(!t.ignoreHydrogens||"non-polar"===t.ignoreHydrogensVariant)}function mp(e,t){for(const{units:n}of e.unitSymmetryGroups)if(Gi.Nf.isAtomic(n[0])&&pp(n[0],t))return!0;return!1}var fp;function gp(e,t,n){const{objectId:i,instanceId:s,groupId:r}=e;if(n===i){const{structure:e,group:n}=t,i=n.units[s];if(r===rp.$.Null){const t=ho.CD.ofRange(0,i.elements.length);return Gi.iZ.Loci(e.target,[{unit:i,indices:t}])}if(Gi.Nf.isAtomic(i)){const{target:t}=e,n=i.bonds.a[r],s=i.bonds.b[r];return Gi.gn.Loci(t,[Gi.gn.Location(t,i,n,t,i,s),Gi.gn.Location(t,i,s,t,i,n)])}}return ts.BL}function yp(e,t,n,i){let s=!1;if(Gi.gn.isLoci(e)){const{structure:i,group:r}=t;if(!Gi.Structure.areEquivalent(e.structure,i))return!1;const o=r.units[0];if(!Gi.Nf.isAtomic(o))return!1;const a=2*o.bonds.edgeCount;for(const t of e.bonds){if(t.aUnit!==t.bUnit)continue;const e=r.unitIndexMap.get(t.aUnit.id);if(void 0!==e){const i=o.bonds.getDirectedEdgeIndex(t.aIndex,t.bIndex);-1!==i&&n(ho.IX.ofSingleton(e*a+i))&&(s=!0)}}}else if(Gi.iZ.Loci.is(e)){const{structure:r,group:o}=t;if(!Gi.Structure.areEquivalent(e.structure,r))return!1;const a=o.units[0];if(!Gi.Nf.isAtomic(a))return!1;const l=2*a.bonds.edgeCount;for(const t of e.elements){const e=o.unitIndexMap.get(t.unit.id);if(void 0!==e){const{offset:r,b:o}=a.bonds;ho.CD.forEach(t.indices,a=>{for(let c=r[a],u=r[a+1];c<u;c++)i&&!ho.CD.has(t.indices,o[c])||n(ho.IX.ofSingleton(e*l+c))&&(s=!0)})}}}return s}function vp(e,t,n){const{objectId:i,groupId:s}=e;if(n===i){const{target:e}=t;if(s===rp.$.Null)return Gi.Structure.Loci(e);{const n=t.interUnitBonds.edges[s],i=t.unitMap.get(n.unitA),r=t.unitMap.get(n.unitB);return Gi.gn.Loci(e,[Gi.gn.Location(e,i,n.indexA,e,r,n.indexB),Gi.gn.Location(e,r,n.indexB,e,i,n.indexA)])}}return ts.BL}!function(e){e.fromGroup=function(e,t){const{group:n,structure:i}=e,s=n.units[0],r=Gi.Nf.isAtomic(s)?2*s.bonds.edgeCount:0,o=n.units.length,a=Gi.gn.Location(i,void 0,void 0,i,void 0,void 0),l=(e,t)=>{const i=n.units[t];return a.aUnit=i,a.bUnit=i,a.aIndex=i.bonds.a[e],a.bIndex=i.bonds.b[e],a};if(null==t?void 0:t.includeLocation2){const e=Gi.gn.Location(i,void 0,void 0,i,void 0,void 0),t=(t,i)=>{const s=n.units[i];return e.aUnit=s,e.bUnit=s,e.aIndex=s.bonds.b[t],e.bIndex=s.bonds.a[t],e};return(0,ip.iQ)(r,o,1,l,!1,()=>!1,t)}return(0,ip.iQ)(r,o,1,l)},e.fromStructure=function(e,t){const n=e.interUnitBonds.edgeCount,i=Gi.gn.Location(e,void 0,void 0,e,void 0,void 0),s=t=>{const n=e.interUnitBonds.edges[t];return i.aUnit=e.unitMap.get(n.unitA),i.aIndex=n.indexA,i.bUnit=e.unitMap.get(n.unitB),i.bIndex=n.indexB,i};if(null==t?void 0:t.includeLocation2){const t=Gi.gn.Location(e,void 0,void 0,e,void 0,void 0),i=n=>{const i=e.interUnitBonds.edges[n];return t.aUnit=e.unitMap.get(i.unitB),t.aIndex=i.indexB,t.bUnit=e.unitMap.get(i.unitA),t.bIndex=i.indexA,t};return(0,ip.iQ)(n,1,1,s,!0,()=>!1,i)}return(0,ip.iQ)(n,1,1,s,!0)},e.fromStructureGroups=function(e,t){const{bondCount:n,unitIndex:i,unitGroupIndex:s,unitEdgeIndex:r}=e.intraUnitBondMapping,o=n,a=Gi.gn.Location(e,void 0,void 0,e,void 0,void 0),l=t=>{const n=e.unitSymmetryGroups[i[t]].units[s[t]],o=r[t];return a.aUnit=n,a.bUnit=n,a.aIndex=n.bonds.a[o],a.bIndex=n.bonds.b[o],a};if(null==t?void 0:t.includeLocation2){const t=Gi.gn.Location(e,void 0,void 0,e,void 0,void 0),n=n=>{const o=e.unitSymmetryGroups[i[n]].units[s[n]],a=r[n];return t.aUnit=o,t.bUnit=o,t.aIndex=o.bonds.b[a],t.bIndex=o.bonds.a[a],t};return(0,ip.iQ)(o,1,1,l,!0,()=>!1,n)}return(0,ip.iQ)(o,1,1,l,!0)}}(fp||(fp={}));const bp=new Map;function xp(e,t,n,i){let s=!1;if(Gi.gn.isLoci(e)){if(!Gi.Structure.areEquivalent(e.structure,t))return!1;for(const i of e.bonds){const e=t.interUnitBonds.getBondIndexFromLocation(i);-1!==e&&n(ho.IX.ofSingleton(e))&&(s=!0)}}else if(Gi.iZ.Loci.is(e)){if(!Gi.Structure.areEquivalent(e.structure,t))return!1;if(i&&1===e.elements.length)return!1;for(const t of e.elements)bp.set(t.unit.id,t.indices);for(const r of e.elements){const{unit:e}=r;if(Gi.Nf.isAtomic(e))for(const o of t.interUnitBonds.getConnectedUnits(e.id)){const a=bp.get(o.unitB);i&&!a||ho.CD.forEach(r.indices,r=>{if(o.connectedIndices.includes(r))for(const l of o.getEdges(r))if(!i||a&&ho.CD.has(a,l.indexB)){const i=t.interUnitBonds.getEdgeIndex(r,e.id,l.indexB,o.unitB);n(ho.IX.ofSingleton(i))&&(s=!0)}})}}bp.clear()}return s}function Sp(e,t,n){const{objectId:i,groupId:s}=e;if(n===i){const e=t.intraUnitBondMapping;return gp({objectId:i,instanceId:e.unitGroupIndex[s],groupId:e.unitEdgeIndex[s]},{structure:t,group:t.unitSymmetryGroups[e.unitIndex[s]]},n)}return ts.BL}function Cp(e,t,n,i){const{unitGroupOffset:s}=t.intraUnitBondMapping;let r=!1;if(Gi.gn.isLoci(e)){if(!Gi.Structure.areEquivalent(e.structure,t))return!1;for(const i of e.bonds){if(i.aUnit!==i.bUnit)continue;const e=t.unitSymmetryGroupsIndexMap.get(i.aUnit.id),o=t.unitSymmetryGroups[e],a=o.units[0];if(!Gi.Nf.isAtomic(a))continue;const l=s[e],c=2*a.bonds.edgeCount,u=o.unitIndexMap.get(i.aUnit.id);if(void 0!==u){const e=a.bonds.getDirectedEdgeIndex(i.aIndex,i.bIndex);-1!==e&&n(ho.IX.ofSingleton(u*c+e+l))&&(r=!0)}}}else if(Gi.iZ.Loci.is(e)){if(!Gi.Structure.areEquivalent(e.structure,t))return!1;for(const o of e.elements){const e=t.unitSymmetryGroupsIndexMap.get(o.unit.id),a=t.unitSymmetryGroups[e],l=a.units[0];if(!Gi.Nf.isAtomic(l))continue;const c=s[e],u=2*l.bonds.edgeCount,d=a.unitIndexMap.get(o.unit.id);if(void 0!==d){const{offset:e,b:t}=l.bonds;ho.CD.forEach(o.indices,s=>{for(let a=e[s],l=e[s+1];a<l;a++)i&&!ho.CD.has(o.indices,t[a])||n(ho.IX.ofSingleton(d*u+a+c))&&(r=!0)})}}}return r}var wp=n(40319),kp=n(62894),Bp=n(8796),Pp=n(43099);const Ip=np.I$.is;function jp(e,t,n,i){const s=e.elements,r=e.bonds,{edgeCount:o,a:a,b:l,edgeProps:c,offset:u}=r,{order:d,flags:h}=c,{sizeFactor:p,sizeAspectRatio:m,adjustCylinderLength:f,aromaticBonds:g,includeTypes:y,excludeTypes:v,multipleBonds:b}=i,x="off"===b,S="symmetric"===b,C=up(np.I$.fromNames(y),np.I$.fromNames(v),np.I$.Flag.Computed),w=(0,Go.eB)(),k=(0,Go.eB)(),B=e.conformation;let P;const I=Gi.iZ.Location.create(t,e),j=Gi.gn.Location(t,e,void 0,t,e,void 0),{child:T}=t;if(i.includeParent&&T){const t=T.unitMap.get(e.id);if(!t)throw new Error("expected childUnit to exist");P=e=>{const n=s[a[e]],i=s[l[e]];return ho.X9.has(t.elements,n)&&!ho.X9.has(t.elements,i)}}const{elementRingIndices:A,elementAromaticRingIndices:M}=e.rings,L=g?e.resonance.delocalizedTriplets:void 0;return{linkCount:2*o,referencePosition:e=>{let t=a[e],n=l[e];const i=null==L?void 0:L.getThirdElement(t,n);if(void 0!==i)return B.invariantPosition(s[i],w);t>n&&([t,n]=[n,t]),u[t+1]-u[t]===1&&([t,n]=[n,t]);const r=M.get(t)||A.get(t);let o=0;for(let a=u[t],c=u[t+1];a<c;++a){const e=l[a];if(e!==n&&e!==t){if(!r)return B.invariantPosition(s[e],w);{const t=M.get(e)||A.get(e);if(!t)continue;const n=(0,wr.u$)(r,t);n>o&&(o=n,B.invariantPosition(s[e],w))}}}return o>0?w:null},position:(e,t,i,r)=>{if(B.invariantPosition(s[a[i]],e),B.invariantPosition(s[l[i]],t),r&&f){const r=(e=>(I.element=s[a[e]],n.size.size(I)*p))(i),o=(e=>(I.element=s[l[e]],n.size.size(I)*p))(i),c=Math.min(r,o)*m,u=Math.sqrt(Math.max(0,r*r-c*c))-.05,d=Math.sqrt(Math.max(0,o*o-c*c))-.05;if(u<=.01&&d<=.01)return;Go.eB.normalize(k,Go.eB.sub(k,t,e)),Go.eB.scaleAndAdd(e,e,k,u),Go.eB.scaleAndAdd(t,t,k,-d)}},style:e=>{const t=d[e],n=h[e];if(Ip(n,np.I$.Flag.MetallicCoordination)||Ip(n,np.I$.Flag.HydrogenBond))return ep.gK.Dashed;if(3===t)return x?ep.gK.Solid:S?ep.gK.Triple:ep.gK.OffsetTriple;if(g){const t=a[e],i=l[e],s=M.get(t),r=M.get(i),o=s&&r?(0,wr.u$)(s,r):0;if(Ip(n,np.I$.Flag.Aromatic)||o&&!C)return 2===o?ep.gK.MirroredAromatic:ep.gK.Aromatic}return 2!==t||x?ep.gK.Solid:S?ep.gK.Double:ep.gK.OffsetDouble},radius:e=>(e=>(j.aIndex=a[e],j.bIndex=l[e],n.size.size(j)*p))(e)*m,ignore:dp(t,e,i),stub:P}}function Tp(e,t,n,i,s,r){if(!Gi.Nf.isAtomic(t))return kp.S.createEmpty(r);if(!pp(t,s))return kp.S.createEmpty(r);if(!t.bonds.edgeCount)return kp.S.createEmpty(r);const{child:o}=n,a=null==o?void 0:o.unitMap.get(t.id);if(o&&!a)return kp.S.createEmpty(r);const l=jp(t,n,i,s),{cylinders:c,boundingSphere:u}=(0,ep.rm)(e,l,s,r);if(u)c.setBoundingSphere(u);else if(c.cylinderCount>0){const e=Dd.f8.expand((0,Dd.f8)(),(null!=a?a:t).boundary.sphere,1*s.sizeFactor);c.setBoundingSphere(e)}return c}function Ap(e,t,n,i,s,r){if(!Gi.Nf.isAtomic(t))return Jh.e.createEmpty(r);if(!pp(t,s))return Jh.e.createEmpty(r);if(!t.bonds.edgeCount)return Jh.e.createEmpty(r);const{child:o}=n,a=null==o?void 0:o.unitMap.get(t.id);if(o&&!a)return Jh.e.createEmpty(r);const l=jp(t,n,i,s),{mesh:c,boundingSphere:u}=(0,ep.C1)(e,l,s,r);if(u)c.setBoundingSphere(u);else if(c.triangleCount>0){const e=Dd.f8.expand((0,Dd.f8)(),(null!=a?a:t).boundary.sphere,1*s.sizeFactor);c.setBoundingSphere(e)}return c}const Mp={...tp.Te,...tp.lm,...lp,sizeFactor:Xi.t.Numeric(.3,{min:0,max:10,step:.01}),sizeAspectRatio:Xi.t.Numeric(2/3,{min:0,max:3,step:.01}),tryUseImpostor:Xi.t.Boolean(!0),includeParent:Xi.t.Boolean(!1)};function Lp(e,t,n,i){return n.tryUseImpostor&&(0,op.VZ)(i)?function(e){return(0,tp.Vb)({defaultProps:Xi.t.getDefaultValues(Mp),createGeometry:Tp,createLocationIterator:(e,t)=>fp.fromGroup(e,{includeLocation2:"interpolate"===t.colorMode}),getLoci:gp,eachLocation:yp,setUpdateState:(e,t,n,i,s,r,o)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.sizeAspectRatio!==n.sizeAspectRatio||t.linkScale!==n.linkScale||t.linkSpacing!==n.linkSpacing||t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||t.linkCap!==n.linkCap||t.aromaticScale!==n.aromaticScale||t.aromaticSpacing!==n.aromaticSpacing||t.aromaticDashCount!==n.aromaticDashCount||t.dashCount!==n.dashCount||t.dashScale!==n.dashScale||t.dashCap!==n.dashCap||t.stubCap!==n.stubCap||!(0,a.af)(t.includeTypes,n.includeTypes)||!(0,a.af)(t.excludeTypes,n.excludeTypes)||t.adjustCylinderLength!==n.adjustCylinderLength||t.aromaticBonds!==n.aromaticBonds||t.multipleBonds!==n.multipleBonds||t.adjustCylinderLength&&!Bp.F.areEqual(i.size,s.size),t.colorMode!==n.colorMode&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0);const l=r.group.units[0],c=o.group.units[0];Gi.Nf.isAtomic(l)&&Gi.Nf.isAtomic(c)&&(wp.O.areEqual(l.bonds,c.bonds)||(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.updateSize=!0))},mustRecreate:(e,t,n)=>!t.tryUseImpostor||!n},e)}(e):function(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(Mp),createGeometry:Ap,createLocationIterator:e=>fp.fromGroup(e),getLoci:gp,eachLocation:yp,setUpdateState:(e,t,n,i,s,r,o)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.sizeAspectRatio!==n.sizeAspectRatio||t.radialSegments!==n.radialSegments||t.linkScale!==n.linkScale||t.linkSpacing!==n.linkSpacing||t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||t.linkCap!==n.linkCap||t.aromaticScale!==n.aromaticScale||t.aromaticSpacing!==n.aromaticSpacing||t.aromaticDashCount!==n.aromaticDashCount||t.dashCount!==n.dashCount||t.dashScale!==n.dashScale||t.dashCap!==n.dashCap||t.stubCap!==n.stubCap||!(0,a.af)(t.includeTypes,n.includeTypes)||!(0,a.af)(t.excludeTypes,n.excludeTypes)||t.adjustCylinderLength!==n.adjustCylinderLength||t.aromaticBonds!==n.aromaticBonds||t.multipleBonds!==n.multipleBonds;const l=r.group.units[0],c=o.group.units[0];Gi.Nf.isAtomic(l)&&Gi.Nf.isAtomic(c)&&(wp.O.areEqual(l.bonds,c.bonds)||(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.updateSize=!0))},mustRecreate:(e,t,n)=>t.tryUseImpostor&&!!n},e)}(e)}function Ep(e,t,n){const i=[],{bondCount:s,unitIndex:r,unitEdgeIndex:o,unitGroupIndex:a}=e.intraUnitBondMapping,{child:l}=e;for(const c of e.unitSymmetryGroups){const s=c.units[0],r=null==l?void 0:l.unitMap.get(s.id),o=!Gi.Nf.isAtomic(s)||l&&!r?ep.Js:jp(s,e,t,n);i.push({group:c,props:o})}return{linkCount:s,referencePosition:e=>{const{group:t,props:n}=i[r[e]];if(!n.referencePosition)return null;const s=n.referencePosition(o[e]);if(!s)return null;const l=t.units[a[e]];return Go.eB.transformMat4(s,s,l.conformation.operator.matrix),s},position:(e,t,n,s)=>{const{group:l,props:c}=i[r[n]];c.position(e,t,o[n],s);const u=l.units[a[n]];Go.eB.transformMat4(e,e,u.conformation.operator.matrix),Go.eB.transformMat4(t,t,u.conformation.operator.matrix)},style:e=>{const{props:t}=i[r[e]];return t.style?t.style(o[e]):ep.gK.Solid},radius:e=>{const{props:t}=i[r[e]];return t.radius(o[e])},ignore:e=>{const{props:t}=i[r[e]];return!!t.ignore&&t.ignore(o[e])},stub:e=>{const{props:t}=i[r[e]];return!!t.stub&&t.stub(o[e])}}}function Dp(e,t,n,i,s){if(!mp(t,i))return kp.S.createEmpty(s);if(!t.intraUnitBondMapping.bondCount)return kp.S.createEmpty(s);const r=Ep(t,n,i),{cylinders:o,boundingSphere:a}=(0,ep.rm)(e,r,i,s);if(a)o.setBoundingSphere(a);else if(o.cylinderCount>0){const{child:e}=t,n=Dd.f8.expand((0,Dd.f8)(),(null!=e?e:t).boundary.sphere,1*i.sizeFactor);o.setBoundingSphere(n)}return o}function Np(e,t,n,i,s){if(!mp(t,i))return Jh.e.createEmpty(s);if(!t.intraUnitBondMapping.bondCount)return Jh.e.createEmpty(s);const r=Ep(t,n,i),{mesh:o,boundingSphere:a}=(0,ep.C1)(e,r,i,s);if(a)o.setBoundingSphere(a);else if(o.triangleCount>0){const{child:e}=t,n=Dd.f8.expand((0,Dd.f8)(),(null!=e?e:t).boundary.sphere,1*i.sizeFactor);o.setBoundingSphere(n)}return o}const Fp={...Pp.EN,...Pp.KE,...lp,sizeFactor:Xi.t.Numeric(.3,{min:0,max:10,step:.01}),sizeAspectRatio:Xi.t.Numeric(2/3,{min:0,max:3,step:.01}),tryUseImpostor:Xi.t.Boolean(!0),includeParent:Xi.t.Boolean(!1)};function Rp(e,t,n,i){return n.tryUseImpostor&&i&&i.extensions.fragDepth?function(e){return(0,Pp.UM)({defaultProps:Xi.t.getDefaultValues(Fp),createGeometry:Dp,createLocationIterator:(e,t)=>mp(e,t)?fp.fromStructureGroups(e,{includeLocation2:"interpolate"===t.colorMode}):ip.FL,getLoci:Sp,eachLocation:Cp,setUpdateState:(e,t,n,i,s,r,o)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.sizeAspectRatio!==n.sizeAspectRatio||t.linkScale!==n.linkScale||t.linkSpacing!==n.linkSpacing||t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||t.linkCap!==n.linkCap||t.aromaticScale!==n.aromaticScale||t.aromaticSpacing!==n.aromaticSpacing||t.aromaticDashCount!==n.aromaticDashCount||t.dashCount!==n.dashCount||t.dashScale!==n.dashScale||t.dashCap!==n.dashCap||t.stubCap!==n.stubCap||!(0,a.af)(t.includeTypes,n.includeTypes)||!(0,a.af)(t.excludeTypes,n.excludeTypes)||t.adjustCylinderLength!==n.adjustCylinderLength||t.multipleBonds!==n.multipleBonds,t.colorMode!==n.colorMode&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0),mp(r,t)&&r.interUnitBonds!==o.interUnitBonds&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.updateSize=!0)},mustRecreate:(e,t,n)=>!t.tryUseImpostor||!n},e)}(e):function(e){return(0,Pp.wA)({defaultProps:Xi.t.getDefaultValues(Fp),createGeometry:Np,createLocationIterator:(e,t)=>mp(e,t)?fp.fromStructureGroups(e):ip.FL,getLoci:Sp,eachLocation:Cp,setUpdateState:(e,t,n,i,s,r,o)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.sizeAspectRatio!==n.sizeAspectRatio||t.radialSegments!==n.radialSegments||t.linkScale!==n.linkScale||t.linkSpacing!==n.linkSpacing||t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||t.linkCap!==n.linkCap||t.aromaticScale!==n.aromaticScale||t.aromaticSpacing!==n.aromaticSpacing||t.aromaticDashCount!==n.aromaticDashCount||t.dashCount!==n.dashCount||t.dashScale!==n.dashScale||t.dashCap!==n.dashCap||t.stubCap!==n.stubCap||!(0,a.af)(t.includeTypes,n.includeTypes)||!(0,a.af)(t.excludeTypes,n.excludeTypes)||t.adjustCylinderLength!==n.adjustCylinderLength||t.multipleBonds!==n.multipleBonds||t.adjustCylinderLength&&!Bp.F.areEqual(i.size,s.size),mp(r,t)&&r.interUnitBonds!==o.interUnitBonds&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.updateSize=!0)},mustRecreate:(e,t,n)=>t.tryUseImpostor&&!!n},e)}(e)}var Op=n(87504);const zp=new Gi.gn.ElementBondIterator;function Hp(e,t,n,i){for(zp.setElement(t,n,i);zp.hasNext;){const t=zp.move();return t.otherUnit.conformation.position(t.otherUnit.elements[t.otherIndex],e),e}return null}const Up=(0,Go.eB)();function Vp(e,t,n){const i=Gi.iZ.Location.create(e),s=Gi.gn.Location(e,void 0,void 0,e,void 0,void 0),r=e.interUnitBonds,{edgeCount:o,edges:l}=r,{sizeFactor:c,sizeAspectRatio:u,adjustCylinderLength:d,aromaticBonds:h,multipleBonds:p}=n,m="off"===p,f="symmetric"===p,g=(0,Go.eB)();let y;const{child:v}=e;n.includeParent&&v&&(y=t=>{const n=l[t],i=v.unitMap.get(n.unitA),s=v.unitMap.get(n.unitB),r=e.unitMap.get(n.unitA).elements[n.indexA],o=e.unitMap.get(n.unitB).elements[n.indexB];return i&&Op.X.has(i.elements,r)&&(!s||!Op.X.has(s.elements,o))});return{linkCount:o,referencePosition:t=>{const n=l[t];let i,s,r,o;if(n.unitA<n.unitB)i=e.unitMap.get(n.unitA),s=e.unitMap.get(n.unitB),r=n.indexA,o=n.indexB;else{if(!(n.unitA>n.unitB))throw new Error("same units in createInterUnitBondCylinderMesh");i=e.unitMap.get(n.unitB),s=e.unitMap.get(n.unitA),r=n.indexB,o=n.indexA}return Hp(Up,e,i,r)||Hp(Up,e,s,o)},position:(n,s,r,o)=>{const a=l[r],h=e.unitMap.get(a.unitA),p=e.unitMap.get(a.unitB);if(h.conformation.position(h.elements[a.indexA],n),p.conformation.position(p.elements[a.indexB],s),o&&d){const o=(n=>{const s=l[n];return i.unit=e.unitMap.get(s.unitA),i.element=i.unit.elements[s.indexA],t.size.size(i)*c})(r),a=(n=>{const s=l[n];return i.unit=e.unitMap.get(s.unitB),i.element=i.unit.elements[s.indexB],t.size.size(i)*c})(r),d=Math.min(o,a)*u,h=Math.sqrt(Math.max(0,o*o-d*d))-.05,p=Math.sqrt(Math.max(0,a*a-d*d))-.05;if(h<=.01&&p<=.01)return;Go.eB.normalize(g,Go.eB.sub(g,s,n)),Go.eB.scaleAndAdd(n,n,g,h),Go.eB.scaleAndAdd(s,s,g,-p)}},style:e=>{const t=l[e].props.order,n=a.NJ.create(l[e].props.flag);return np.I$.is(n,np.I$.Flag.MetallicCoordination)||np.I$.is(n,np.I$.Flag.HydrogenBond)?ep.gK.Dashed:3===t?m?ep.gK.Solid:f?ep.gK.Triple:ep.gK.OffsetTriple:h&&np.I$.is(n,np.I$.Flag.Aromatic)?ep.gK.Aromatic:2!==t||m?ep.gK.Solid:f?ep.gK.Double:ep.gK.OffsetDouble},radius:n=>(n=>{const i=l[n];return s.aUnit=e.unitMap.get(i.unitA),s.aIndex=i.indexA,s.bUnit=e.unitMap.get(i.unitB),s.bIndex=i.indexB,t.size.size(s)*c})(n)*u,ignore:hp(e,n),stub:y}}function _p(e,t,n,i,s){if(!mp(t,i))return kp.S.createEmpty(s);if(!t.interUnitBonds.edgeCount)return kp.S.createEmpty(s);const r=Vp(t,n,i),{cylinders:o,boundingSphere:a}=(0,ep.rm)(e,r,i,s);if(a)o.setBoundingSphere(a);else if(o.cylinderCount>0){const{child:e}=t,n=Dd.f8.expand((0,Dd.f8)(),(null!=e?e:t).boundary.sphere,1*i.sizeFactor);o.setBoundingSphere(n)}return o}function Gp(e,t,n,i,s){if(!mp(t,i))return Jh.e.createEmpty(s);if(!t.interUnitBonds.edgeCount)return Jh.e.createEmpty(s);const r=Vp(t,n,i),{mesh:o,boundingSphere:a}=(0,ep.C1)(e,r,i,s);if(a)o.setBoundingSphere(a);else if(o.triangleCount>0){const{child:e}=t,n=Dd.f8.expand((0,Dd.f8)(),(null!=e?e:t).boundary.sphere,1*i.sizeFactor);o.setBoundingSphere(n)}return o}const qp={...Pp.EN,...Pp.KE,...lp,sizeFactor:Xi.t.Numeric(.3,{min:0,max:10,step:.01}),sizeAspectRatio:Xi.t.Numeric(2/3,{min:0,max:3,step:.01}),tryUseImpostor:Xi.t.Boolean(!0),includeParent:Xi.t.Boolean(!1)};function $p(e,t,n,i){return n.tryUseImpostor&&(0,op.VZ)(i)?function(e){return(0,Pp.UM)({defaultProps:Xi.t.getDefaultValues(qp),createGeometry:_p,createLocationIterator:(e,t)=>mp(e,t)?fp.fromStructure(e,{includeLocation2:"interpolate"===t.colorMode}):ip.FL,getLoci:vp,eachLocation:xp,setUpdateState:(e,t,n,i,s,r,o)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.sizeAspectRatio!==n.sizeAspectRatio||t.linkScale!==n.linkScale||t.linkSpacing!==n.linkSpacing||t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||t.linkCap!==n.linkCap||t.aromaticScale!==n.aromaticScale||t.aromaticSpacing!==n.aromaticSpacing||t.aromaticDashCount!==n.aromaticDashCount||t.dashCount!==n.dashCount||t.dashScale!==n.dashScale||t.dashCap!==n.dashCap||t.stubCap!==n.stubCap||!(0,a.af)(t.includeTypes,n.includeTypes)||!(0,a.af)(t.excludeTypes,n.excludeTypes)||t.adjustCylinderLength!==n.adjustCylinderLength||t.multipleBonds!==n.multipleBonds,t.colorMode!==n.colorMode&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0),mp(r,t)&&r.interUnitBonds!==o.interUnitBonds&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.updateSize=!0)},mustRecreate:(e,t,n)=>!t.tryUseImpostor||!n},e)}(e):function(e){return(0,Pp.wA)({defaultProps:Xi.t.getDefaultValues(qp),createGeometry:Gp,createLocationIterator:(e,t)=>mp(e,t)?fp.fromStructure(e):ip.FL,getLoci:vp,eachLocation:xp,setUpdateState:(e,t,n,i,s,r,o)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.sizeAspectRatio!==n.sizeAspectRatio||t.radialSegments!==n.radialSegments||t.linkScale!==n.linkScale||t.linkSpacing!==n.linkSpacing||t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||t.linkCap!==n.linkCap||t.aromaticScale!==n.aromaticScale||t.aromaticSpacing!==n.aromaticSpacing||t.aromaticDashCount!==n.aromaticDashCount||t.dashCount!==n.dashCount||t.dashScale!==n.dashScale||t.dashCap!==n.dashCap||t.stubCap!==n.stubCap||!(0,a.af)(t.includeTypes,n.includeTypes)||!(0,a.af)(t.excludeTypes,n.excludeTypes)||t.adjustCylinderLength!==n.adjustCylinderLength||t.multipleBonds!==n.multipleBonds||t.adjustCylinderLength&&!Bp.F.areEqual(i.size,s.size),mp(r,t)&&r.interUnitBonds!==o.interUnitBonds&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.updateSize=!0)},mustRecreate:(e,t,n)=>t.tryUseImpostor&&!!n},e)}(e)}var Zp=n(74669),Kp=n(86420),Qp=n(39526),Xp=n(6706),Wp=n(97352);const Yp=Go.eB.add;function Jp(e,t,n){const{ignoreHydrogens:i,ignoreHydrogensVariant:s,traceOnly:r}=n,o=Gi.Nf.isCoarse(t),{child:a}=e,l=null==a?void 0:a.unitMap.get(t.id);if(a&&!l)throw new Error("expected childUnit to exist if child exists");if(a||i||r)return n=>!!l&&!ho.X9.has(l.elements,n)||!o&&i&&(0,op.v3)(e,t,n,s)||r&&!(0,op.UQ)(t,n)}function em(e,t,n,i,s,r){const{child:o}=n,a=null==o?void 0:o.unitMap.get(t.id);if(o&&!a)return Jh.e.createEmpty(r);const{detail:l,sizeFactor:c,stride:u}=s,{elements:d,conformation:h}=t,p=d.length,m=p*(0,Zp.J)(l),f=Kp.P.createState(m,m/2,r),g=(0,Go.eB)(),y=Jp(n,t,s),v=Gi.iZ.Location.create(n,t),b=i.size.size,x=(0,Go.eB)();let S=0,C=0;for(let P=0;P<p;P++){if(u&&P%u!==0)continue;if(y&&y(d[P]))continue;h.invariantPosition(d[P],g),Yp(x,x,g),C+=1,v.element=d[P];const e=b(v);e>S&&(S=e),f.currentGroup=P,(0,Qp.X)(f,g,e*c,l)}const w=Kp.P.getMesh(f);if(0===C)return w;let k;Go.eB.scale(x,x,1/C);const B=r?Dd.f8.clone(r.boundingSphere):void 0;return k=B&&Go.eB.distance(x,B.center)/B.radius<.1?B:Dd.f8.expand((0,Dd.f8)(),(null!=a?a:t).boundary.sphere,S*c+.05),w.setBoundingSphere(k),w}function tm(e,t,n,i,s,r){const{child:o}=n,a=null==o?void 0:o.unitMap.get(t.id);if(o&&!a)return Xp.v.createEmpty(r);const{sizeFactor:l,stride:c}=s,{elements:u,conformation:d}=t,h=u.length,p=Wp.Q.create(h,h/2,r),m=(0,Go.eB)(),f=Jp(n,t,s),g=Gi.iZ.Location.create(n,t),y=i.size.size,v=(0,Go.eB)();let b=0,x=0;if(c&&c>1||f||"uniform"!==i.size.granularity)for(let k=0;k<h;k++){if(c&&k%c!==0)continue;if(f&&f(u[k]))continue;d.invariantPosition(u[k],m),p.add(m[0],m[1],m[2],k),Yp(v,v,m),x+=1,g.element=u[k];const e=y(g);e>b&&(b=e)}else{for(let e=0;e<h;e++)d.invariantPosition(u[e],m),p.add(m[0],m[1],m[2],e),Yp(v,v,m);x=h,b=y(g)}const S=p.getSpheres();if(0===x)return S;let C;Go.eB.scale(v,v,1/x);const w=r?Dd.f8.clone(r.boundingSphere):void 0;return C=w&&Go.eB.distance(v,w.center)/w.radius<.1?w:Dd.f8.expand((0,Dd.f8)(),(null!=a?a:t).boundary.sphere,b*l+.05),S.setBoundingSphere(C),S}function nm(e,t,n){let i=!1;if(!Gi.iZ.Loci.is(e))return!1;const{structure:s,group:r}=t;if(!Gi.Structure.areEquivalent(e.structure,s))return!1;const o=r.elements.length,{unitIndexMap:a}=r;for(const l of e.elements){const e=a.get(l.unit.id);if(void 0!==e){const t=e*o;if(ho.IX.is(l.indices)){const e=t+ho.IX.start(l.indices),s=t+ho.IX.end(l.indices);n(ho.IX.ofBounds(e,s))&&(i=!0)}else for(let e=0,s=l.indices.length;e<s;e++){const r=l.indices[e];let o=e+1;for(;o<s&&l.indices[o]===r;)o++;e=o-1;const a=l.indices[e];i=n(ho.IX.ofRange(t+r,t+a))||i}}}return i}function im(e,t,n){const{objectId:i,instanceId:s,groupId:r}=e;if(n===i){const{structure:e,group:n}=t,i=n.units[s],o=r===rp.$.Null?ho.CD.ofRange(0,i.elements.length):ho.CD.ofSingleton(r);return Gi.iZ.Loci(e.target,[{unit:i,indices:o}])}return ts.BL}function sm(e,t,n,i,s){const{child:r}=t,{detail:o,sizeFactor:a,stride:l}=i,{getSerialIndex:c}=t.serialMapping,u=t.elementCount*(0,Zp.J)(o),d=Kp.P.createState(u,u/2,s),h=n.size.size,p=(0,Go.eB)();let m=0,f=0;for(const b of t.units){const e=null==r?void 0:r.unitMap.get(b.id);if(r&&!e)continue;const{elements:n,conformation:s}=b,u=n.length,g=(0,Go.eB)(),y=Jp(t,b,i),v=Gi.iZ.Location.create(t,b);for(let t=0;t<u;t++){const e=n[t];if(l&&t%l!==0)continue;if(y&&y(e))continue;s.position(e,g),Yp(p,p,g),f+=1,v.element=e;const i=h(v);i>m&&(m=i),d.currentGroup=c(b,e),(0,Qp.X)(d,g,i*a,o)}}const g=Kp.P.getMesh(d);if(0===f)return g;let y;Go.eB.scale(p,p,1/f);const v=s?Dd.f8.clone(s.boundingSphere):void 0;return y=v&&Go.eB.distance(p,v.center)/v.radius<1?v:Dd.f8.expand((0,Dd.f8)(),(null!=r?r:t).boundary.sphere,m*a+.05),g.setBoundingSphere(y),g}function rm(e,t,n,i,s){const{child:r}=t,{sizeFactor:o,stride:a}=i,{getSerialIndex:l}=t.serialMapping,c=t.elementCount,u=Wp.Q.create(c,c/2,s),d=n.size.size,h=(0,Go.eB)();let p=0,m=0;for(const v of t.units){const e=null==r?void 0:r.unitMap.get(v.id);if(r&&!e)continue;const{elements:s,conformation:o}=v,c=s.length,f=(0,Go.eB)(),g=Jp(t,v,i),y=Gi.iZ.Location.create(t,v);if(a&&a>1||g||"uniform"!==n.size.granularity)for(let t=0;t<c;t++){const e=s[t];if(a&&t%a!==0)continue;if(g&&g(e))continue;o.position(e,f),u.add(f[0],f[1],f[2],l(v,e)),Yp(h,h,f),m+=1,y.element=e;const n=d(y);n>p&&(p=n)}else{for(let e=0;e<c;e++){const t=s[e];o.position(t,f),u.add(f[0],f[1],f[2],l(v,t)),Yp(h,h,f)}m+=c,p=d(y)}}const f=u.getSpheres();if(0===m)return f;let g;Go.eB.scale(h,h,1/m);const y=s?Dd.f8.clone(s.boundingSphere):void 0;return g=y&&Go.eB.distance(h,y.center)/y.radius<1?y:Dd.f8.expand((0,Dd.f8)(),(null!=r?r:t).boundary.sphere,p*o+.05),f.setBoundingSphere(g),f}function om(e,t,n){let i=!1;if(!Gi.iZ.Loci.is(e))return!1;if(!Gi.Structure.areEquivalent(e.structure,t))return!1;const{cumulativeUnitElementCount:s}=t.serialMapping;for(const r of e.elements){const e=t.unitIndexMap.get(r.unit.id);if(void 0!==e)if(ho.IX.is(r.indices)){const t=s[e]+ho.IX.start(r.indices),o=s[e]+ho.IX.end(r.indices);n(ho.IX.ofBounds(t,o))&&(i=!0)}else for(let t=0,o=r.indices.length;t<o;t++){const o=s[e]+r.indices[t];n(ho.IX.ofSingleton(o))&&(i=!0)}}return i}function am(e,t,n){const{objectId:i,groupId:s}=e;if(n===i){if(s===rp.$.Null)return Gi.Structure.Loci(t);{const{unitIndices:e,cumulativeUnitElementCount:n}=t.serialMapping,i=e[s],r=t.units[i],o=s-n[i],a=ho.CD.ofSingleton(o);return Gi.iZ.Loci(t,[{unit:r,indices:a}])}}return ts.BL}var lm;!function(e){e.fromGroup=function(e){const{group:t,structure:n}=e,i=t.elements.length,s=t.units.length,r=Gi.iZ.Location.create(n);return(0,ip.iQ)(i,s,1,(e,n)=>{const i=t.units[n];return r.unit=i,r.element=i.elements[e],r})},e.fromStructure=function(e){const{units:t,elementCount:n}=e,i=n,{unitIndices:s,elementIndices:r}=e.serialMapping,o=Gi.iZ.Location.create(e);return(0,ip.iQ)(i,1,1,e=>(o.unit=t[s[e]],o.element=r[e],o),!0)}}(lm||(lm={}));const cm={sizeFactor:Xi.t.Numeric(1,{min:0,max:10,step:.1}),detail:Xi.t.Numeric(0,{min:0,max:3,step:1},Vi.iy.CustomQualityParamInfo),ignoreHydrogens:Xi.t.Boolean(!1),ignoreHydrogensVariant:Xi.t.Select("all",Xi.t.arrayToOptions(["all","non-polar"])),traceOnly:Xi.t.Boolean(!1),tryUseImpostor:Xi.t.Boolean(!0),stride:Xi.t.Numeric(1,{min:1,max:100,step:1})},um={...tp.Te,...tp.qg,...cm};function dm(e,t,n,i){return n.tryUseImpostor&&(0,op.gU)(i)?function(e){return(0,tp.uF)({defaultProps:Xi.t.getDefaultValues(um),createGeometry:tm,createLocationIterator:lm.fromGroup,getLoci:im,eachLocation:nm,setUpdateState:(e,t,n)=>{e.createGeometry=t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||t.traceOnly!==n.traceOnly||t.stride!==n.stride},mustRecreate:(e,t,n)=>!t.tryUseImpostor||!n},e)}(e):function(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(um),createGeometry:em,createLocationIterator:lm.fromGroup,getLoci:im,eachLocation:nm,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.detail!==n.detail||t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||t.traceOnly!==n.traceOnly||t.stride!==n.stride},mustRecreate:(e,t,n)=>t.tryUseImpostor&&!!n},e)}(e)}const hm={...Pp.EN,...Pp.T9,...cm};function pm(e,t,n,i){return n.tryUseImpostor&&i&&i.extensions.fragDepth&&i.extensions.textureFloat?function(e){return(0,Pp.zo)({defaultProps:Xi.t.getDefaultValues(hm),createGeometry:rm,createLocationIterator:lm.fromStructure,getLoci:am,eachLocation:om,setUpdateState:(e,t,n)=>{e.createGeometry=t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||t.traceOnly!==n.traceOnly||t.stride!==n.stride},mustRecreate:(e,t,n)=>!t.tryUseImpostor||!n},e)}(e):function(e){return(0,Pp.wA)({defaultProps:Xi.t.getDefaultValues(hm),createGeometry:sm,createLocationIterator:lm.fromStructure,getLoci:am,eachLocation:om,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.detail!==n.detail||t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||t.traceOnly!==n.traceOnly||t.stride!==n.stride},mustRecreate:(e,t,n)=>t.tryUseImpostor&&!!n},e)}(e)}var mm=n(85135),fm=n(75542),gm=n(37413),ym=n(15062);const vm={"element-sphere":(e,t)=>(0,mm.T)("Element sphere",e,t,dm),"intra-bond":(e,t)=>(0,mm.T)("Intra-unit bond cylinder",e,t,Lp),"inter-bond":(e,t)=>(0,fm.K)("Inter-unit bond cylinder",e,t,$p),"structure-element-sphere":(e,t)=>(0,fm.K)("Structure element sphere",e,t,pm),"structure-intra-bond":(e,t)=>(0,fm.K)("Structure intra-unit bond cylinder",e,t,Rp)},bm={...um,traceOnly:Xi.t.Boolean(!1,{isHidden:!0}),...Mp,...qp,includeParent:Xi.t.Boolean(!1),unitKinds:(0,ym.R8)(["atomic"]),sizeFactor:Xi.t.Numeric(.15,{min:.01,max:10,step:.01}),sizeAspectRatio:Xi.t.Numeric(2/3,{min:.01,max:3,step:.01}),visuals:Xi.t.MultiSelect(["element-sphere","intra-bond","inter-bond"],Xi.t.objectToOptions(vm)),bumpFrequency:Xi.t.Numeric(0,{min:0,max:10,step:.1},Vi.iy.ShadingCategory),density:Xi.t.Numeric(.1,{min:0,max:1,step:.01},Vi.iy.ShadingCategory)};const xm=(0,gm.GT)({name:"ball-and-stick",label:"Ball & Stick",description:"Displays atoms as spheres and bonds as cylinders.",factory:function(e,t){return Er.YL.createMulti("Ball & Stick",e,t,gm.J1,vm)},getParams:function(e,t){let n=bm;return Gi.Structure.getSize(t)>=Gi.Structure.Size.Huge?(n=Xi.t.clone(n),n.visuals.defaultValue=["element-sphere","intra-bond"]):t.unitSymmetryGroups.length>5e3&&(n=Xi.t.clone(n),n.visuals.defaultValue=["structure-element-sphere","structure-intra-bond"]),n},defaultValues:Xi.t.getDefaultValues(bm),defaultColorTheme:{name:"element-symbol"},defaultSizeTheme:{name:"physical"},isApplicable:e=>e.elementCount>0,getData:(e,t)=>t.includeParent?e.asParent():e,mustRecreate:(e,t)=>e.includeParent!==t.includeParent});function Sm(e,t,n,i,s){const{links:r,elements:o}=t.carbohydrates,{linkSizeFactor:a}=i,l=Gi.iZ.Location.create(t),c={linkCount:r.length,position:(e,t,n)=>{const i=r[n];Go.eB.copy(e,o[i.carbohydrateIndexA].geometry.center),Go.eB.copy(t,o[i.carbohydrateIndexB].geometry.center)},radius:e=>{const t=r[e],i=o[t.carbohydrateIndexA],s=i.unit.rings.all[i.ringIndex];return l.unit=i.unit,l.element=i.unit.elements[s[0]],n.size.size(l)*a}},{mesh:u,boundingSphere:d}=(0,ep.C1)(e,c,i,s);if(d)u.setBoundingSphere(d);else if(u.triangleCount>0){const e=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*a);u.setBoundingSphere(e)}return u}const Cm={...tp.Te,...ep.Lr,linkSizeFactor:Xi.t.Numeric(.3,{min:0,max:3,step:.01})};function wm(e){return(0,Pp.wA)({defaultProps:Xi.t.getDefaultValues(Cm),createGeometry:Sm,createLocationIterator:km,getLoci:Bm,eachLocation:Im,setUpdateState:(e,t,n)=>{e.createGeometry=t.linkSizeFactor!==n.linkSizeFactor||t.radialSegments!==n.radialSegments||t.linkCap!==n.linkCap}},e)}function km(e){const{elements:t,links:n}=e.carbohydrates,i=n.length,s=Gi.iZ.Location.create(e);return(0,ip.iQ)(i,1,1,e=>{const i=n[e],r=t[i.carbohydrateIndexA],o=r.unit.rings.all[r.ringIndex];return s.unit=r.unit,s.element=r.unit.elements[o[0]],s},!0)}function Bm(e,t,n){const{objectId:i,groupId:s}=e;if(n===i){if(s===rp.$.Null)return Gi.Structure.Loci(t);{const{links:e,elements:n}=t.carbohydrates,i=e[s],r=n[i.carbohydrateIndexA],o=n[i.carbohydrateIndexB];return Gi.iZ.Loci.union((0,op.rS)(t,r.unit,r.residueIndex,r.altId),(0,op.rS)(t,o.unit,o.residueIndex,o.altId))}}return ts.BL}const Pm=new Set;function Im(e,t,n){let i=!1;if(!Gi.iZ.Loci.is(e))return!1;if(!Gi.Structure.areEquivalent(e.structure,t))return!1;const{getLinkIndices:s}=t.carbohydrates;for(const{unit:r,indices:o}of e.elements)Gi.Nf.isAtomic(r)&&(Pm.clear(),ho.CD.forEach(o,e=>{const t=s(r,r.elements[e]);for(let s=0,r=t.length;s<r;++s)Pm.has(t[s])||(Pm.add(t[s]),n(ho.IX.ofSingleton(t[s]))&&(i=!0))}));return i}var jm=n(15991),Tm=n(26443),Am=n(25876);const Mm=Go.eB.create(0,0,-.5),Lm=Go.eB.create(0,0,.5),Em=(0,Go.eB)(),Dm=(0,Go.eB)(),Nm=(0,Go.eB)(),Fm=(0,Go.eB)();function Rm(e){const t=e.length/3,n=(3===t?1:4===t?2:t)+t,i=4===t?3*t+4:3*n,s=(0,Tm.nT)(n,i);for(let r=0;r<t;++r){const n=(r+1)%t;Go.eB.set(Em,e[3*r],e[3*r+1],-.5),Go.eB.set(Dm,e[3*n],e[3*n+1],-.5),s.add(Em,Dm,Lm)}if(3===t)Go.eB.set(Em,e[0],e[1],-.5),Go.eB.set(Dm,e[3],e[4],-.5),Go.eB.set(Nm,e[6],e[7],-.5),s.add(Nm,Dm,Em);else if(4===t)Go.eB.set(Em,e[0],e[1],-.5),Go.eB.set(Dm,e[3],e[4],-.5),Go.eB.set(Nm,e[6],e[7],-.5),Go.eB.set(Fm,e[9],e[10],-.5),s.addQuad(Fm,Nm,Dm,Em);else for(let r=0;r<t;++r){const n=(r+1)%t;Go.eB.set(Em,e[3*r],e[3*r+1],-.5),Go.eB.set(Dm,e[3*n],e[3*n+1],-.5),s.add(Mm,Dm,Em)}return s.getPrimitive()}let Om,zm;const Hm={pointCount:5,outerRadius:1,innerRadius:.5,thickness:.3},Um=Go.eB.zero(),Vm=Go.eB.zero(),_m=Go.eB.zero(),Gm=Go.eB.zero(),qm=Go.eB.zero();var $m=n(73404);const Zm=[.5,0,0,-.5,0,0,0,.5,0,0,-.5,0,0,0,.5,0,0,-.5],Km=[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],Qm=[0,2,4,0,4,3,1,2,5,1,5,3];let Xm,Wm;(0,$m.L3)(Zm,[0,2,1,3,2,1,3,0,0,4,1,4,2,4,3,4,0,5,1,5,2,5,3,5]);var Ym=n(10375),Jm=n(92570);const ef=Go.$I.identity(),tf=(0,Go.eB)(),nf=(0,Go.eB)(),sf=(0,jm.az)(),rf=(0,jm.wV)(),of=(Om||(Om=Rm((0,Am.n)(8,!0))),Om),af=function(){if(!zm){const e=(0,Am.n)(8,!0),t=new Float32Array(30);for(let i=0;i<8;++i)t[3*i]=e[3*i],t[3*i+1]=e[3*i+1],t[3*i+2]=-.5;t[24]=0,t[25]=0,t[26]=-.5,t[27]=0,t[28]=0,t[29]=.5;const n=[0,1,8,1,2,8,4,5,8,5,6,8,2,3,9,3,4,9,6,7,9,7,0,9];zm=(0,Tm.m9)(t,n)}return zm}(),lf=function(e){const{outerRadius:t,innerRadius:n,thickness:i,pointCount:s}={...Hm,...e},r=2*s*2,o=(0,Tm.nT)(r),a=new Float32Array(2*s),l=new Float32Array(2*s);for(let c=0;c<s;++c){const e=2*c,i=2*c+1,r=(e+1)/s*Math.PI,o=(i+1)/s*Math.PI;l[e]=Math.cos(r)*t,l[i]=Math.sin(r)*t,a[e]=Math.cos(o)*n,a[i]=Math.sin(o)*n}Go.eB.set(Um,0,0,i/2),Go.eB.set(Vm,0,0,-i/2);for(let c=0;c<s;++c){const e=(c+1)%s;Go.eB.set(_m,l[2*c],l[2*c+1],0),Go.eB.set(Gm,a[2*c],a[2*c+1],0),Go.eB.set(qm,l[2*e],l[2*e+1],0),o.add(Um,_m,Gm),o.add(Gm,_m,Vm),o.add(Um,Gm,qm),o.add(qm,Gm,Vm)}return o.getPrimitive()}({outerRadius:1,innerRadius:.5,thickness:.5,pointCount:5}),cf=(Xm||(Xm=(0,Tm.m9)(Zm,Km)),Xm),uf=(Wm||(Wm=(0,Tm.m9)(Zm,Qm)),Wm),df=(0,Ym.uo)(),hf=(0,Ym.r7)(),pf=(0,Ym.jg)(),mf=(0,Ym.SM)(),ff=(0,Ym.VH)();function gf(e,t,n,i,s){const r=Kp.P.createState(256,128,s),{detail:o,sizeFactor:a}=i,l=t.carbohydrates,c=l.elements.length,u=Gi.iZ.Location.create(t);for(let d=0;d<c;++d){const e=l.elements[d],t=e.unit.rings.all[e.ringIndex],i=(0,Jm.N0)(e.component.type,t.length);u.unit=e.unit,u.element=e.unit.elements[t[0]];const s=n.size.size(u),c=s*a,h=s*a*1.612,{center:p,normal:m,direction:f}=e.geometry;switch(Go.eB.add(nf,p,f),Go.$I.targetTo(ef,p,nf,m),Go.$I.setTranslation(ef,p),r.currentGroup=2*d,i){case Jm.RP.FilledSphere:(0,Qp.X)(r,p,c,o);break;case Jm.RP.FilledCube:Go.$I.scaleUniformly(ef,ef,h),Kp.P.addPrimitive(r,ef,sf);break;case Jm.RP.CrossedCube:Go.$I.scaleUniformly(ef,ef,h),Kp.P.addPrimitive(r,ef,rf),Go.$I.mul(ef,ef,Go.$I.rotZ90X180),r.currentGroup+=1,Kp.P.addPrimitive(r,ef,rf);break;case Jm.RP.FilledCone:Go.$I.scaleUniformly(ef,ef,1.2*h),Kp.P.addPrimitive(r,ef,of);break;case Jm.RP.DevidedCone:Go.$I.scaleUniformly(ef,ef,1.2*h),Kp.P.addPrimitive(r,ef,af),Go.$I.mul(ef,ef,Go.$I.rotZ90),r.currentGroup+=1,Kp.P.addPrimitive(r,ef,af);break;case Jm.RP.FlatBox:Go.$I.mul(ef,ef,Go.$I.rotZY90),Go.$I.scale(ef,ef,Go.eB.set(tf,h,h,h/2)),Kp.P.addPrimitive(r,ef,sf);break;case Jm.RP.FilledStar:Go.$I.scaleUniformly(ef,ef,h),Go.$I.mul(ef,ef,Go.$I.rotZY90),Kp.P.addPrimitive(r,ef,lf);break;case Jm.RP.FilledDiamond:Go.$I.mul(ef,ef,Go.$I.rotZY90),Go.$I.scale(ef,ef,Go.eB.set(tf,1.4*h,1.4*h,1.4*h)),Kp.P.addPrimitive(r,ef,cf);break;case Jm.RP.DividedDiamond:Go.$I.mul(ef,ef,Go.$I.rotZY90),Go.$I.scale(ef,ef,Go.eB.set(tf,1.4*h,1.4*h,1.4*h)),Kp.P.addPrimitive(r,ef,uf),Go.$I.mul(ef,ef,Go.$I.rotY90),r.currentGroup+=1,Kp.P.addPrimitive(r,ef,uf);break;case Jm.RP.FlatDiamond:Go.$I.mul(ef,ef,Go.$I.rotZY90),Go.$I.scale(ef,ef,Go.eB.set(tf,h,h/2,h/2)),Kp.P.addPrimitive(r,ef,df);break;case Jm.RP.DiamondPrism:Go.$I.mul(ef,ef,Go.$I.rotZY90),Go.$I.scale(ef,ef,Go.eB.set(tf,h,h,h/2)),Kp.P.addPrimitive(r,ef,df);break;case Jm.RP.PentagonalPrism:case Jm.RP.Pentagon:Go.$I.mul(ef,ef,Go.$I.rotZY90),Go.$I.scale(ef,ef,Go.eB.set(tf,h,h,h/2)),Kp.P.addPrimitive(r,ef,hf);break;case Jm.RP.HexagonalPrism:Go.$I.mul(ef,ef,Go.$I.rotZY90),Go.$I.scale(ef,ef,Go.eB.set(tf,h,h,h/2)),Kp.P.addPrimitive(r,ef,pf);break;case Jm.RP.HeptagonalPrism:Go.$I.mul(ef,ef,Go.$I.rotZY90),Go.$I.scale(ef,ef,Go.eB.set(tf,h,h,h/2)),Kp.P.addPrimitive(r,ef,ff);break;case Jm.RP.FlatHexagon:default:Go.$I.mul(ef,ef,Go.$I.rotZYZ90),Go.$I.scale(ef,ef,Go.eB.set(tf,h/1.5,h,h/2)),Kp.P.addPrimitive(r,ef,mf)}}return Kp.P.getMesh(r)}const yf={...Pp.EN,detail:Xi.t.Numeric(0,{min:0,max:3,step:1},Vi.iy.CustomQualityParamInfo),sizeFactor:Xi.t.Numeric(1.75,{min:0,max:10,step:.01})};function vf(e){return(0,Pp.wA)({defaultProps:Xi.t.getDefaultValues(yf),createGeometry:gf,createLocationIterator:bf,getLoci:xf,eachLocation:Cf,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.detail!==n.detail}},e)}function bf(e){const t=e.carbohydrates.elements,n=2*t.length,i=Gi.iZ.Location.create(e);return(0,ip.iQ)(n,1,1,function(e,n){const s=t[Math.floor(e/2)],r=s.unit.rings.all[s.ringIndex];return i.unit=s.unit,i.element=s.unit.elements[r[0]],i},!0,function(e,t){return e%2==1})}function xf(e,t,n){const{objectId:i,groupId:s}=e;if(n===i){if(s===rp.$.Null)return Gi.Structure.Loci(t);{const e=t.carbohydrates.elements[Math.floor(s/2)];return(0,op.rS)(t,e.unit,e.residueIndex,e.altId)}}return ts.BL}const Sf=new Set;function Cf(e,t,n){const{getElementIndices:i}=t.carbohydrates;let s=!1;if(!Gi.iZ.Loci.is(e))return!1;if(!Gi.Structure.areEquivalent(e.structure,t))return!1;for(const{unit:r,indices:o}of e.elements)Gi.Nf.isAtomic(r)&&(Sf.clear(),ho.CD.forEach(o,e=>{const t=i(r,r.elements[e]);for(let i=0,r=t.length;i<r;++i)Sf.has(t[i])||(Sf.add(t[i]),n(ho.IX.ofSingleton(2*t[i]))&&(s=!0))}));return s}var wf=n(58637);function kf(e,t,n,i,s){const{terminalLinks:r,elements:o}=t.carbohydrates,{terminalLinkSizeFactor:a}=i,l=Gi.iZ.Location.create(t),c={linkCount:r.length,position:(e,t,n)=>{const i=r[n];i.fromCarbohydrate?(Go.eB.copy(e,o[i.carbohydrateIndex].geometry.center),i.elementUnit.conformation.position(i.elementUnit.elements[i.elementIndex],t)):(i.elementUnit.conformation.position(i.elementUnit.elements[i.elementIndex],e),Go.eB.copy(t,o[i.carbohydrateIndex].geometry.center))},radius:e=>{const t=r[e];if(t.fromCarbohydrate){const e=o[t.carbohydrateIndex],n=e.unit.rings.all[e.ringIndex];l.unit=e.unit,l.element=e.unit.elements[n[0]]}else l.unit=t.elementUnit,l.element=t.elementUnit.elements[t.elementIndex];return n.size.size(l)*a},style:e=>{const t=r[e],n=t.elementUnit.elements[t.elementIndex],i=(0,wf.Yd)(t.elementUnit.model.atomicHierarchy.atoms.type_symbol.value(n));return wf.ZL.has(i)?ep.gK.Dashed:ep.gK.Solid}},{mesh:u,boundingSphere:d}=(0,ep.C1)(e,c,i,s);if(d)u.setBoundingSphere(d);else if(u.triangleCount>0){const e=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*a);u.setBoundingSphere(e)}return u}const Bf={...tp.Te,...ep.Lr,terminalLinkSizeFactor:Xi.t.Numeric(.2,{min:0,max:3,step:.01})};function Pf(e){return(0,Pp.wA)({defaultProps:Xi.t.getDefaultValues(Bf),createGeometry:kf,createLocationIterator:If,getLoci:jf,eachLocation:Af,setUpdateState:(e,t,n)=>{e.createGeometry=t.terminalLinkSizeFactor!==n.terminalLinkSizeFactor||t.radialSegments!==n.radialSegments||t.linkCap!==n.linkCap}},e)}function If(e){const{elements:t,terminalLinks:n}=e.carbohydrates,i=n.length,s=Gi.iZ.Location.create(e);return(0,ip.iQ)(i,1,1,e=>{const i=n[e];if(i.fromCarbohydrate){const e=t[i.carbohydrateIndex],n=e.unit.rings.all[e.ringIndex];s.unit=e.unit,s.element=e.unit.elements[n[0]]}else s.unit=i.elementUnit,s.element=i.elementUnit.elements[i.elementIndex];return s},!0)}function jf(e,t,n){const{objectId:i,groupId:s}=e;if(n===i){if(s===rp.$.Null)return Gi.Structure.Loci(t);{const{terminalLinks:e,elements:n}=t.carbohydrates,i=e[s],r=n[i.carbohydrateIndex];return Gi.iZ.Loci.union((0,op.rS)(t,r.unit,r.residueIndex,r.altId),(0,op.uh)(t,i.elementUnit,i.elementUnit.elements[i.elementIndex]))}}return ts.BL}const Tf=new Set;function Af(e,t,n){let i=!1;if(!Gi.iZ.Loci.is(e))return!1;if(!Gi.Structure.areEquivalent(e.structure,t))return!1;const{getTerminalLinkIndices:s}=t.carbohydrates;for(const{unit:r,indices:o}of e.elements)Gi.Nf.isAtomic(r)&&(Tf.clear(),ho.CD.forEach(o,e=>{const t=s(r,r.elements[e]);for(let s=0,r=t.length;s<r;++s)Tf.has(t[s])||(Tf.add(t[s]),n(ho.IX.ofSingleton(t[s]))&&(i=!0))}));return i}const Mf={"carbohydrate-symbol":(e,t)=>(0,fm.K)("Carbohydrate symbol mesh",e,t,vf),"carbohydrate-link":(e,t)=>(0,fm.K)("Carbohydrate link cylinder",e,t,wm),"carbohydrate-terminal-link":(e,t)=>(0,fm.K)("Carbohydrate terminal link cylinder",e,t,Pf)},Lf={...yf,...Cm,...Bf,visuals:Xi.t.MultiSelect(["carbohydrate-symbol","carbohydrate-link","carbohydrate-terminal-link"],Xi.t.objectToOptions(Mf)),bumpFrequency:Xi.t.Numeric(0,{min:0,max:10,step:.1},Vi.iy.ShadingCategory),density:Xi.t.Numeric(.2,{min:0,max:1,step:.01},Vi.iy.ShadingCategory)};const Ef=(0,gm.GT)({name:"carbohydrate",label:"Carbohydrate",description:"Displays carbohydrate symbols (3D SNFG).",factory:function(e,t){return Er.YL.createMulti("Carbohydrate",e,t,gm.J1,Mf)},getParams:function(e,t){return Lf},defaultValues:Xi.t.getDefaultValues(Lf),defaultColorTheme:{name:"carbohydrate-symbol"},defaultSizeTheme:{name:"uniform"},isApplicable:e=>e.models.some(e=>Gi.Kx.hasCarbohydrate(e))});var Df=n(48202),Nf=n(66231);function Ff(e,t){switch(e.kind){case Gi.Nf.Kind.Atomic:return function(e,t){const n=e.model.atomicRanges.cyclicPolymerMap,i=Nf.m.transientSegments(Ng(e),e.elements),s=ho.hT.transientSegments(e.model.atomicHierarchy.residueAtomSegments,e.elements),r=e.model.atomicHierarchy.derived.residue.traceElementIndex,{moleculeType:o}=e.model.atomicHierarchy.derived.residue;let a=-1,l=-1,c=!0,u=-1,d=0;for(;i.hasNext;){for(c=!0,u=d,s.setSegment(i.move());s.hasNext;){if(c){const e=s.move().index;if(++d,!s.hasNext)continue;c=!1,l=e}a=l,l=s.move().index,t(r[a],r[l],d-1,d,o[a]),++d}n.has(l)&&(a=l,l=n.get(a),t(r[a],r[l],d-1,u,o[a]))}}(e,t);case Gi.Nf.Kind.Spheres:case Gi.Nf.Kind.Gaussians:return function(e,t){const n=Nf.m.transientSegments(Ng(e),e.elements),{elements:i}=e;let s=!0,r=0;for(;n.hasNext;){s=!0;const e=n.move();for(let n=e.start,o=e.end;n<o;++n){if(s){if(++n,++r,n>o)continue;s=!1}t(i[n-1],i[n],r-1,r,0),++r}}}(e,t)}}function Rf(e,t){switch(e.kind){case Gi.Nf.Kind.Atomic:return function(e,t){const n=Nf.m.transientSegments(Ng(e),e.elements),i=ho.hT.transientSegments(e.model.atomicHierarchy.residueAtomSegments,e.elements),s=e.model.atomicHierarchy.derived.residue.traceElementIndex;let r=0;for(;n.hasNext;)for(i.setSegment(n.move());i.hasNext;){t(s[i.move().index],r),++r}}(e,t);case Gi.Nf.Kind.Spheres:case Gi.Nf.Kind.Gaussians:return function(e,t){const n=Nf.m.transientSegments(Ng(e),e.elements),{elements:i}=e;let s=0;for(;n.hasNext;){const e=n.move();for(let n=e.start,r=e.end;n<r;++n)t(i[n],s),++s}}(e,t)}}function Of(e,t){return{centerA:Gi.iZ.Location.create(e,t),centerB:Gi.iZ.Location.create(e,t)}}class zf{move(){const{elements:e,residueIndex:t}=this.unit,n=this.gapIt.move();return this.value.centerA.element=this.traceElementIndex[t[e[n.start]]],this.value.centerB.element=this.traceElementIndex[t[e[n.end-1]]],this.hasNext=this.gapIt.hasNext,this.value}constructor(e,t){this.unit=t,this.hasNext=!1,this.traceElementIndex=t.model.atomicHierarchy.derived.residue.traceElementIndex,this.gapIt=Nf.m.transientSegments(Fg(t),t.elements),this.value=Of(e,t),this.hasNext=this.gapIt.hasNext}}class Hf{move(){const e=this.gapIt.move();return this.value.centerA.element=this.unit.elements[e.start],this.value.centerB.element=this.unit.elements[e.end-1],this.hasNext=this.gapIt.hasNext,this.value}constructor(e,t){this.unit=t,this.hasNext=!1,this.gapIt=Nf.m.transientSegments(Fg(t),t.elements),this.value=Of(e,t),this.hasNext=this.gapIt.hasNext}}var Uf=n(49191),Vf=n(59859),_f=n(75434),Gf=n(62020);function qf(e){const{x:t,y:n,z:i}=e.atomicConformation,{polymerType:s,traceElementIndex:r}=e.atomicHierarchy.derived.residue,o=s.length,a=ho.CD.ofBounds(0,e.atomicConformation.atomId.rowCount),l=Nf.m.transientSegments(e.atomicRanges.polymerRanges,a),c=Gf.h.transientSegments(e.atomicHierarchy.residueAtomSegments,a),u=new Float32Array(3*o),d=new Float32Array(3*o);let h=0,p=-1,m=-1;const f=(0,Go.eB)(),g=(0,Go.eB)(),y=(0,Go.eB)(),v=(0,Go.eB)(),b=(0,Go.eB)(),x=(0,Go.eB)(),S=(0,Go.eB)(),C=(0,Go.eB)(),w=(0,Go.eB)(),k=(0,Go.eB)(),B=(0,Go.eB)(),P=(0,Go.eB)(),I=(0,Go.eB)(),j=(0,Go.eB)();for(;l.hasNext;){const e=l.move();for(c.setSegment(e),h=-1,m=-1;c.hasNext;){h+=1;const{index:e}=c.move();0===h&&(m=e),p=e-2;const s=3*p;Go.eB.copy(f,g),Go.eB.copy(g,y),Go.eB.copy(y,v);const o=r[e];if(Go.eB.set(v,t[o],n[o],i[o]),h<3)continue;Go.eB.sub(b,g,f),Go.eB.sub(x,y,g),Go.eB.sub(S,v,y),Go.eB.sub(B,b,x),Go.eB.sub(P,x,S),Go.eB.cross(I,B,P),Go.eB.normalize(I,I),Go.eB.toArray(I,d,s);const a=Math.cos(Go.eB.angle(B,P)),l=Go.eB.magnitude(B),k=Go.eB.magnitude(P),T=Math.sqrt(k*l)/Math.max(2,2*(1-a));Go.eB.scale(C,B,T/l),Go.eB.sub(C,g,C),Go.eB.toArray(C,u,s),Go.eB.scale(w,P,T/k),Go.eB.sub(w,y,w),Go.eB.toArray(w,u,s+3),Go.eB.copy(j,I)}const s=3*m;Go.eB.fromArray(C,u,s+3),Go.eB.fromArray(w,u,s+6),Go.eB.normalize(I,Go.eB.sub(I,C,w));const o=r[m];Go.eB.set(f,t[o],n[o],i[o]),Go.eB.copy(k,f),Go.eB.projectPointOnVector(k,k,I,C),Go.eB.toArray(k,u,s);const a=p+2,T=3*a;Go.eB.fromArray(C,u,T-3),Go.eB.fromArray(w,u,T-6),Go.eB.normalize(I,Go.eB.sub(I,C,w));const A=r[a];Go.eB.set(f,t[A],n[A],i[A]),Go.eB.copy(k,f),Go.eB.projectPointOnVector(k,k,I,C),Go.eB.toArray(k,u,T)}return{centers:u}}const $f=_f._.createProvider({label:"Helix Orientation",descriptor:(0,Vf.e)({name:"molstar_helix_orientation"}),type:"dynamic",defaultParams:{},getParams:()=>({}),isApplicable:e=>!0,obtain:async(e,t)=>({value:qf(t)})});function Zf(e){return np.gG.is(e,np.gG.Flag.Helix)}function Kf(e,t,n={}){switch(e.kind){case Gi.Nf.Kind.Atomic:return new tg(e,t,n);case Gi.Nf.Kind.Spheres:case Gi.Nf.Kind.Gaussians:return new ig(e,t)}}const Qf=np.gG.create(np.gG.Flag.NA);function Xf(e,t){return{center:Gi.iZ.Location.create(e,t),centerPrev:Gi.iZ.Location.create(e,t),centerNext:Gi.iZ.Location.create(e,t),first:!1,last:!1,initial:!1,final:!1,secStrucFirst:!1,secStrucLast:!1,secStrucType:Qf,moleculeType:np.HX.Unknown,coarseBackboneFirst:!1,coarseBackboneLast:!1,p0:(0,Go.eB)(),p1:(0,Go.eB)(),p2:(0,Go.eB)(),p3:(0,Go.eB)(),p4:(0,Go.eB)(),d12:(0,Go.eB)(),d23:(0,Go.eB)()}}var Wf;!function(e){e[e.nextPolymer=0]="nextPolymer",e[e.nextResidue=1]="nextResidue"}(Wf||(Wf={}));const Yf=(0,Go.eB)(),Jf=(0,Go.eB)(),eg=(0,Go.eB)();class tg{atomicPos(e,t){-1!==t&&(e[0]=this.atomicConformation.x[t],e[1]=this.atomicConformation.y[t],e[2]=this.atomicConformation.z[t])}pos(e,t,n){const i=this.traceElementIndex[t];this.helixOrientationCenters&&Zf(n)?Go.eB.fromArray(e,this.helixOrientationCenters,3*t):this.atomicPos(e,i)}updateResidueSegmentRange(e){const{index:t}=this.residueAtomSegments;this.residueSegmentMin=t[this.polymerRanges[2*e.index]],this.residueSegmentMax=t[this.polymerRanges[2*e.index+1]]}getResidueIndex(e){if(e<this.residueSegmentMin){const t=this.cyclicPolymerMap.get(this.residueSegmentMin);e=void 0!==t?t-(this.residueSegmentMin-e-1):this.residueSegmentMin}else if(e>this.residueSegmentMax){const t=this.cyclicPolymerMap.get(this.residueSegmentMax);e=void 0!==t?t+(e-this.residueSegmentMax-1):this.residueSegmentMax}return e}getSecStruc(e){if(this.secondaryStructure){const{type:t,getIndex:n}=this.secondaryStructure,i=t[n(e)];return Zf(i)?np.gG.Flag.Helix:i}return Qf}setControlPoint(e,t,n,i,s){(function(e){return np.gG.is(e,np.gG.Flag.Beta)})(s)||this.helixOrientationCenters&&Zf(s)?Go.eB.scale(e,Go.eB.add(e,t,Go.eB.add(e,i,Go.eB.add(e,n,n))),1/4):Go.eB.copy(e,n)}setFromToVector(e,t,n){this.helixOrientationCenters&&Zf(n)?Go.eB.set(e,1,0,0):(this.atomicPos(Jf,this.directionFromElementIndex[t]),this.atomicPos(eg,this.directionToElementIndex[t]),Go.eB.sub(e,eg,Jf))}setDirection(e,t,n,i){Go.eB.matchDirection(Jf,t,n),Go.eB.matchDirection(eg,i,n),Go.eB.scale(e,Go.eB.add(e,Jf,Go.eB.add(e,eg,Go.eB.add(e,n,n))),1/4)}move(){const{residueIt:e,polymerIt:t,value:n}=this;if(this.state===Wf.nextPolymer)for(;t.hasNext;)if(this.polymerSegment=t.move(),e.setSegment(this.polymerSegment),this.updateResidueSegmentRange(this.polymerSegment),e.hasNext){this.state=Wf.nextResidue;const e=this.residueAtomSegments.index[this.unit.elements[this.polymerSegment.start]],t=this.getResidueIndex(e-1);this.currSecStrucType=e===t?Qf:this.getSecStruc(t),this.nextSecStrucType=this.getSecStruc(e),this.currCoarseBackbone=-1===this.directionFromElementIndex[t]||-1===this.directionToElementIndex[t],this.nextCoarseBackbone=-1===this.directionFromElementIndex[e]||-1===this.directionToElementIndex[e];break}if(this.state===Wf.nextResidue){const{index:t}=e.move(),i=this.getResidueIndex(t-3),s=this.getResidueIndex(t-2),r=this.getResidueIndex(t-1),o=this.getResidueIndex(t+1),a=this.getResidueIndex(t+2),l=this.getResidueIndex(t+3);this.prevSecStrucType=this.getSecStruc(r),this.currSecStrucType=this.getSecStruc(t),this.nextSecStrucType=t===o?Qf:this.getSecStruc(o),this.prevCoarseBackbone=this.currCoarseBackbone,this.currCoarseBackbone=this.nextCoarseBackbone,this.nextCoarseBackbone=-1===this.directionFromElementIndex[o]||-1===this.directionToElementIndex[o],n.secStrucType=this.currSecStrucType,n.secStrucFirst=this.prevSecStrucType!==this.currSecStrucType,n.secStrucLast=this.currSecStrucType!==this.nextSecStrucType,n.coarseBackboneFirst=this.prevCoarseBackbone!==this.currCoarseBackbone,n.coarseBackboneLast=this.currCoarseBackbone!==this.nextCoarseBackbone,n.first=t===this.residueSegmentMin,n.last=t===this.residueSegmentMax,n.moleculeType=this.moleculeType[t],n.initial=t===r,n.final=t===o,n.centerPrev.element=this.traceElementIndex[r],n.center.element=this.traceElementIndex[t],n.centerNext.element=this.traceElementIndex[o];const c=this.getSecStruc(i),u=this.getSecStruc(s),d=this.getSecStruc(r),h=this.getSecStruc(t),p=this.getSecStruc(o),m=this.getSecStruc(a),f=this.getSecStruc(l);this.pos(this.p0,i,c),this.pos(this.p1,s,u),this.pos(this.p2,r,d),this.pos(this.p3,t,h),this.pos(this.p4,o,p),this.pos(this.p5,a,m),this.pos(this.p6,l,f);const g=Zf(c),y=Zf(u),v=Zf(d),b=Zf(h),x=Zf(p),S=Zf(m),C=Zf(f);!this.helixOrientationCenters||b&&n.secStrucFirst&&n.secStrucLast||(b!==v?b?(Go.eB.copy(this.p0,this.p3),Go.eB.copy(this.p1,this.p3),Go.eB.copy(this.p2,this.p3)):v&&(Go.eB.scale(Yf,Go.eB.sub(Yf,this.p2,this.p3),2),Go.eB.add(this.p2,this.p3,Yf),Go.eB.add(this.p1,this.p2,Yf),Go.eB.add(this.p0,this.p1,Yf)):b!==y?b?(Go.eB.copy(this.p0,this.p2),Go.eB.copy(this.p1,this.p2)):y&&(Go.eB.scale(Yf,Go.eB.sub(Yf,this.p1,this.p2),2),Go.eB.add(this.p1,this.p2,Yf),Go.eB.add(this.p0,this.p1,Yf)):b!==g&&(b?Go.eB.copy(this.p0,this.p1):g&&(Go.eB.scale(Yf,Go.eB.sub(Yf,this.p0,this.p1),2),Go.eB.add(this.p0,this.p1,Yf))),b!==x?b?(Go.eB.copy(this.p4,this.p3),Go.eB.copy(this.p5,this.p3),Go.eB.copy(this.p6,this.p3)):x&&(Go.eB.scale(Yf,Go.eB.sub(Yf,this.p4,this.p3),2),Go.eB.add(this.p4,this.p3,Yf),Go.eB.add(this.p5,this.p4,Yf),Go.eB.add(this.p6,this.p5,Yf)):b!==S?b?(Go.eB.copy(this.p5,this.p4),Go.eB.copy(this.p6,this.p4)):S&&(Go.eB.scale(Yf,Go.eB.sub(Yf,this.p5,this.p4),2),Go.eB.add(this.p5,this.p4,Yf),Go.eB.add(this.p6,this.p5,Yf)):b!==C&&(b?Go.eB.copy(this.p6,this.p5):C&&(Go.eB.scale(Yf,Go.eB.sub(Yf,this.p6,this.p5),2),Go.eB.add(this.p6,this.p5,Yf)))),this.currCoarseBackbone?(Go.eB.triangleNormal(this.d01,this.p1,this.p2,this.p3),Go.eB.triangleNormal(this.d12,this.p2,this.p3,this.p4),Go.eB.triangleNormal(this.d23,this.p3,this.p4,this.p5),Go.eB.triangleNormal(this.d34,this.p4,this.p5,this.p6)):(this.setFromToVector(this.d01,r,d),this.setFromToVector(this.d12,t,h),this.setFromToVector(this.d23,o,p),this.setFromToVector(this.d34,a,m));const w=b&&this.helixOrientationCenters,k=1.5;t===r||h!==d&&w?(Go.eB.setMagnitude(Yf,Go.eB.sub(Yf,this.p3,this.p4),k),Go.eB.add(this.p2,this.p3,Yf),Go.eB.add(this.p1,this.p2,Yf),Go.eB.add(this.p0,this.p1,Yf)):r===s||h!==u&&w?(Go.eB.setMagnitude(Yf,Go.eB.sub(Yf,this.p2,this.p3),k),Go.eB.add(this.p1,this.p2,Yf),Go.eB.add(this.p0,this.p1,Yf)):(s===i||h!==c&&w)&&(Go.eB.setMagnitude(Yf,Go.eB.sub(Yf,this.p1,this.p2),k),Go.eB.add(this.p0,this.p1,Yf)),t===o||h!==p&&w?(Go.eB.setMagnitude(Yf,Go.eB.sub(Yf,this.p3,this.p2),k),Go.eB.add(this.p4,this.p3,Yf),Go.eB.add(this.p5,this.p4,Yf),Go.eB.add(this.p6,this.p5,Yf)):o===a||h!==m&&w?(Go.eB.setMagnitude(Yf,Go.eB.sub(Yf,this.p4,this.p3),k),Go.eB.add(this.p5,this.p4,Yf),Go.eB.add(this.p6,this.p5,Yf)):(a===l||h!==f&&w)&&(Go.eB.setMagnitude(Yf,Go.eB.sub(Yf,this.p5,this.p4),k),Go.eB.add(this.p6,this.p5,Yf)),this.setControlPoint(n.p0,this.p0,this.p1,this.p2,u),this.setControlPoint(n.p1,this.p1,this.p2,this.p3,d),this.setControlPoint(n.p2,this.p2,this.p3,this.p4,h),this.setControlPoint(n.p3,this.p3,this.p4,this.p5,p),this.setControlPoint(n.p4,this.p4,this.p5,this.p6,m),this.setDirection(n.d12,this.d01,this.d12,this.d23),this.setDirection(n.d23,this.d12,this.d23,this.d34),e.hasNext||(this.state=Wf.nextPolymer)}return this.hasNext=e.hasNext||t.hasNext,this.value}constructor(e,t,n={}){var i;if(this.unit=e,this.state=Wf.nextPolymer,this.p0=(0,Go.eB)(),this.p1=(0,Go.eB)(),this.p2=(0,Go.eB)(),this.p3=(0,Go.eB)(),this.p4=(0,Go.eB)(),this.p5=(0,Go.eB)(),this.p6=(0,Go.eB)(),this.d01=(0,Go.eB)(),this.d12=(0,Go.eB)(),this.d23=(0,Go.eB)(),this.d34=(0,Go.eB)(),this.hasNext=!1,this.atomicConformation=e.model.atomicConformation,this.residueAtomSegments=e.model.atomicHierarchy.residueAtomSegments,this.polymerRanges=e.model.atomicRanges.polymerRanges,this.traceElementIndex=e.model.atomicHierarchy.derived.residue.traceElementIndex,this.directionFromElementIndex=e.model.atomicHierarchy.derived.residue.directionFromElementIndex,this.directionToElementIndex=e.model.atomicHierarchy.derived.residue.directionToElementIndex,this.moleculeType=e.model.atomicHierarchy.derived.residue.moleculeType,this.cyclicPolymerMap=e.model.atomicRanges.cyclicPolymerMap,this.polymerIt=Nf.m.transientSegments(this.polymerRanges,e.elements),this.residueIt=ho.hT.transientSegments(this.residueAtomSegments,e.elements),this.value=Xf(t,e),this.hasNext=this.residueIt.hasNext&&this.polymerIt.hasNext,n.ignoreSecondaryStructure||(this.secondaryStructure=null===(i=Uf.v.get(t).value)||void 0===i?void 0:i.get(e.invariantId)),n.useHelixOrientation){const t=$f.get(e.model).value;if(!t)throw new Error("missing helix-orientation");this.helixOrientationCenters=t.centers}}}var ng;!function(e){e[e.nextPolymer=0]="nextPolymer",e[e.nextElement=1]="nextElement"}(ng||(ng={}));class ig{getElementIndex(e){return Math.min(Math.max(this.polymerSegment.start,e),this.polymerSegment.end-1)}pos(e,t){const n=this.unit.elements[t];e[0]=this.conformation.x[n],e[1]=this.conformation.y[n],e[2]=this.conformation.z[n]}move(){if(this.state===ng.nextPolymer)for(;this.polymerIt.hasNext;)if(this.polymerSegment=this.polymerIt.move(),this.elementIndex=this.polymerSegment.start,this.elementIndex<this.polymerSegment.end){this.state=ng.nextElement;break}if(this.state===ng.nextElement){const e=this.getElementIndex(this.elementIndex-2),t=this.getElementIndex(this.elementIndex-1),n=this.getElementIndex(this.elementIndex+1),i=this.getElementIndex(this.elementIndex+2);this.value.centerPrev.element=this.value.center.unit.elements[t],this.value.center.element=this.value.center.unit.elements[this.elementIndex],this.value.centerNext.element=this.value.center.unit.elements[n],this.pos(this.value.p0,e),this.pos(this.value.p1,t),this.pos(this.value.p2,this.elementIndex),this.pos(this.value.p3,n),this.pos(this.value.p4,i);const s=.5;this.elementIndex===t?(Go.eB.scale(Yf,Go.eB.sub(Yf,this.value.p2,this.value.p3),s),Go.eB.add(this.value.p1,this.value.p2,Yf),Go.eB.add(this.value.p0,this.value.p1,Yf)):t===e&&(Go.eB.scale(Yf,Go.eB.sub(Yf,this.value.p1,this.value.p2),s),Go.eB.add(this.value.p0,this.value.p1,Yf)),this.elementIndex===n?(Go.eB.scale(Yf,Go.eB.sub(Yf,this.value.p2,this.value.p1),s),Go.eB.add(this.value.p3,this.value.p2,Yf),Go.eB.add(this.value.p4,this.value.p3,Yf)):n===i&&(Go.eB.scale(Yf,Go.eB.sub(Yf,this.value.p3,this.value.p2),s),Go.eB.add(this.value.p4,this.value.p3,Yf)),this.value.first=this.elementIndex===this.polymerSegment.start,this.value.last=this.elementIndex===this.polymerSegment.end-1,this.elementIndex+1>=this.polymerSegment.end&&(this.state=ng.nextPolymer)}return this.hasNext=this.elementIndex+1<this.polymerSegment.end||this.polymerIt.hasNext,this.elementIndex+=1,this.value}constructor(e,t){switch(this.unit=e,this.state=ng.nextPolymer,this.hasNext=!1,this.polymerIt=Nf.m.transientSegments(Ng(e),e.elements),this.value=Xf(t,e),Go.eB.set(this.value.d12,1,0,0),Go.eB.set(this.value.d23,1,0,0),e.kind){case Gi.Nf.Kind.Spheres:this.conformation=e.model.coarseConformation.spheres;break;case Gi.Nf.Kind.Gaussians:this.conformation=e.model.coarseConformation.gaussians}this.hasNext=this.polymerIt.hasNext}}var sg=n(41430);const rg=Go.eB.fromArray,og=Go.eB.toArray,ag=Go.eB.normalize,lg=Go.eB.sub,cg=Go.eB.spline,ug=Go.eB.slerp,dg=Go.eB.copy,hg=Go.eB.cross,pg=Go.eB.orthogonalize,mg=Go.eB.matchDirection,fg=Go.eB.scale,gg=Go.eB.add;function yg(e){const t=e+1,n=3*t;return{curvePoints:new Float32Array(n),tangentVectors:new Float32Array(n),normalVectors:new Float32Array(n),binormalVectors:new Float32Array(n),widthValues:new Float32Array(t),heightValues:new Float32Array(t),linearSegments:e}}function vg(e,t,n,i){!function(e,t,n,i){const{curvePoints:s,tangentVectors:r,linearSegments:o}=e,{p0:a,p1:l,p2:c,p3:u,p4:d,secStrucFirst:h,secStrucLast:p}=t,m=1-i,f=h?.5:n,g=p?.5:n;for(let y=0;y<=o;++y){const e=1*y/o;if(e<m){const t=(0,sg.Cc)(f,n,e);cg(Sg,a,l,c,u,e+i,t),cg(bg,a,l,c,u,e+i+.01,f),cg(xg,a,l,c,u,e+i-.01,f)}else{const t=(0,sg.Cc)(n,g,e);cg(Sg,l,c,u,d,e-m,t),cg(bg,l,c,u,d,e-m+.01,t),cg(xg,l,c,u,d,e-m-.01,t)}og(Sg,s,3*y),ag(wg,lg(wg,bg,xg)),og(wg,r,3*y)}}(e,t,n,i),function(e,t){const{curvePoints:n,tangentVectors:i,normalVectors:s,binormalVectors:r}=e,{d12:o,d23:a}=t,l=n.length/3;rg(jg,i,0),rg(Tg,i,3*(l-1)),pg(Ag,jg,o),pg(Mg,Tg,a),mg(Mg,Mg,Ag),dg(Pg,Ag);const c=l-1;for(let u=0;u<l;++u){const e=(0,sg.TF)(0,c,u)*c,t=0===u?0:1/(l-e);rg(wg,i,3*u),pg(kg,wg,ug(Cg,Pg,Mg,t)),og(kg,s,3*u),dg(Pg,kg),ag(Bg,hg(Bg,wg,kg)),og(Bg,r,3*u)}for(let u=1;u<c;++u)rg(Pg,s,3*(u-1)),rg(kg,s,3*u),rg(Ig,s,3*(u+1)),fg(kg,gg(kg,Pg,gg(kg,Ig,kg)),1/3),og(kg,s,3*u),rg(wg,i,3*u),ag(Bg,hg(Bg,wg,kg)),og(Bg,r,3*u)}(e,t)}const bg=(0,Go.eB)(),xg=(0,Go.eB)(),Sg=(0,Go.eB)();const Cg=(0,Go.eB)(),wg=(0,Go.eB)(),kg=(0,Go.eB)(),Bg=(0,Go.eB)(),Pg=(0,Go.eB)(),Ig=(0,Go.eB)(),jg=(0,Go.eB)(),Tg=(0,Go.eB)(),Ag=(0,Go.eB)(),Mg=(0,Go.eB)();function Lg(e,t,n,i,s,r,o,a){const{widthValues:l,heightValues:c,linearSegments:u}=e,d=1-a;for(let h=0;h<=u;++h){const e=1*h/u;e<d?(l[h]=(0,sg.Cc)(t,n,e+a),c[h]=(0,sg.Cc)(s,r,e+a)):(l[h]=(0,sg.Cc)(n,i,e-d),c[h]=(0,sg.Cc)(r,o,e-d))}}const Eg=.5,Dg=.3;function Ng(e){switch(e.kind){case Gi.Nf.Kind.Atomic:return e.model.atomicRanges.polymerRanges;case Gi.Nf.Kind.Spheres:return e.model.coarseHierarchy.spheres.polymerRanges;case Gi.Nf.Kind.Gaussians:return e.model.coarseHierarchy.gaussians.polymerRanges}}function Fg(e){switch(e.kind){case Gi.Nf.Kind.Atomic:return e.model.atomicRanges.gapRanges;case Gi.Nf.Kind.Spheres:return e.model.coarseHierarchy.spheres.gapRanges;case Gi.Nf.Kind.Gaussians:return e.model.coarseHierarchy.gaussians.gapRanges}}var Rg,Og,zg;function Hg(e,t,n){const{objectId:i,instanceId:s,groupId:r}=e;if(n===i){const{structure:e,group:n}=t,i=n.units[s];if(r===rp.$.Null){const t=ho.CD.ofRange(0,i.elements.length);return Gi.iZ.Loci(e.target,[{unit:i,indices:t}])}if(Gi.Nf.isAtomic(i))return(0,op.nR)(e,i,i.polymerElements[r]);{const{elements:t}=i,n=i.polymerElements[r],s=ho.CD.indexOf(t,n);if(-1!==s){const t=ho.CD.ofSingleton(s);return Gi.iZ.Loci(e,[{unit:i,indices:t}])}}}return ts.BL}function Ug(e,t,n,i,s,r){let o=-1,a=-1;for(let c=s;c<=r;c++){const e=n[c];if(!(e<0)&&(o=ho.CD.indexOf(t,e),o>=0)){a=c;break}}if(o<0)return!1;let l=o;for(let c=r;c>a;c--){const e=n[c];if(e<0)continue;const i=ho.CD.indexOf(t,e);if(i>=0){l=i;break}}return i(ho.IX.ofRange(e+o,e+l))}function Vg(e,t,n,i,s){let r=!1;const{elements:o}=s.unit,{traceElementIndex:a}=s.unit.model.atomicHierarchy.derived.residue,{index:l}=s.unit.model.atomicHierarchy.residueAtomSegments,c=n(s.unit);if(ho.IX.is(s.indices))if(0===ho.IX.start(s.indices)&&ho.IX.end(s.indices)===s.unit.elements.length)r=i(ho.IX.ofBounds(e,e+t))||r;else{r=Ug(e,c,a,i,l[o[ho.IX.min(s.indices)]],l[o[ho.IX.max(s.indices)]])||r}else{const{indices:t}=s;for(let n=0,s=t.length;n<s;n++){const u=l[o[t[n]]];let d=u,h=n+1;for(;h<s;){const e=l[o[t[h]]];if(e-d>1)break;d=e,h++}n=h-1,r=Ug(e,c,a,i,u,d)||r}}return r}function _g(e){return e.polymerElements}function Gg(e,t,n){let i=!1;if(!Gi.iZ.Loci.is(e))return!1;const{structure:s,group:r}=t;if(!Gi.Structure.areEquivalent(e.structure,s))return!1;const o=r.units[0].polymerElements.length;for(const a of e.elements){if(!r.unitIndexMap.has(a.unit.id))continue;const e=r.unitIndexMap.get(a.unit.id)*o;if(Gi.Nf.isAtomic(a.unit))i=Vg(e,o,_g,n,a)||i;else if(ho.IX.is(a.indices)){const t=e+ho.IX.start(a.indices),s=e+ho.IX.end(a.indices);i=n(ho.IX.ofBounds(t,s))||i}else for(let t=0,s=a.indices.length;t<s;t++){const r=a.indices[t];let o=t+1;for(;o<s&&a.indices[o]===r;)o++;t=o-1;const l=a.indices[t];i=n(ho.IX.ofRange(e+r,e+l))||i}}return i}function qg(e,t,n){const{objectId:i,instanceId:s,groupId:r}=e;if(n===i){const{structure:e,group:n}=t,i=n.units[s],o=ho.CD.indexOf(i.elements,i.gapElements[r]),a=ho.CD.indexOf(i.elements,i.gapElements[r%2?r-1:r+1]);if(-1!==o&&-1!==a)return Gi.gn.Loci(e,[Gi.gn.Location(e,i,o,e,i,a),Gi.gn.Location(e,i,a,e,i,o)])}return ts.BL}function $g(e,t,n){let i=!1;if(Gi.gn.isLoci(e)){const{structure:s,group:r}=t;if(!Gi.Structure.areRootsEquivalent(e.structure,s))return!1;e=Gi.gn.remapLoci(e,s);const o=r.units[0].gapElements.length;for(const t of e.bonds){const e=r.unitIndexMap.get(t.aUnit.id);if(void 0!==e){const s=ho.CD.indexOf(t.aUnit.gapElements,t.aUnit.elements[t.aIndex]),r=ho.CD.indexOf(t.bUnit.gapElements,t.bUnit.elements[t.bIndex]);-1!==s&&-1!==r&&n(ho.IX.ofSingleton(e*o+s))&&(i=!0)}}}else if(Gi.iZ.Loci.is(e)){const{structure:s,group:r}=t;if(!Gi.Structure.areRootsEquivalent(e.structure,s))return!1;e=Gi.iZ.Loci.remap(e,s);const o=r.units[0].gapElements.length;for(const t of e.elements){const e=r.unitIndexMap.get(t.unit.id);void 0!==e&&ho.CD.forEach(t.indices,s=>{const r=ho.CD.indexOf(t.unit.gapElements,t.unit.elements[s]);-1!==r&&(n(ho.IX.ofSingleton(e*o+r))&&(i=!0),ho.CD.getAt(t.unit.gapElements,r+1)===t.unit.elements[s]&&n(ho.IX.ofSingleton(e*o+r+1))&&(i=!0))})}}return i}function Zg(e,t,n){const{objectId:i,instanceId:s,groupId:r}=e;if(n===i){const{structure:e,group:n}=t,i=n.units[s];if(Gi.Nf.isAtomic(i)){if(r===rp.$.Null){const t=ho.IX.ofRange(0,i.elements.length);return Gi.iZ.Loci(e.target,[{unit:i,indices:t}])}return(0,op.nR)(e,i,i.nucleotideElements[r])}}return ts.BL}function Kg(e){return e.nucleotideElements}function Qg(e,t,n){let i=!1;if(!Gi.iZ.Loci.is(e))return!1;const{structure:s,group:r}=t;if(!Gi.Structure.areEquivalent(e.structure,s))return!1;const o=r.units[0];if(!Gi.Nf.isAtomic(o))return!1;const{nucleotideElements:a}=o,l=a.length;for(const c of e.elements){if(!Gi.Nf.isAtomic(c.unit))continue;if(!r.unitIndexMap.has(c.unit.id))continue;const e=r.unitIndexMap.get(c.unit.id)*l;Gi.Nf.isAtomic(c.unit)&&(i=Vg(e,l,Kg,n,c)||i)}return i}!function(e){e.fromGroup=function(e,t){const{group:n,structure:i}=e,s=n.units[0].polymerElements,r=s.length,o=n.units.length,a=Gi.iZ.Location.create(i),l=!!(null==t?void 0:t.asSecondary);return(0,ip.iQ)(r,o,1,(e,t)=>{const i=n.units[t];return a.unit=i,a.element=s[e],a},!1,function(e,t){return l})}}(Rg||(Rg={})),function(e){e.fromGroup=function(e,t){const{group:n,structure:i}=e,s=n.units[0].gapElements,r=s.length,o=n.units.length,a=Gi.iZ.Location.create(i),l=!!(null==t?void 0:t.asSecondary);return(0,ip.iQ)(r,o,1,(e,t)=>{const i=n.units[t];return a.unit=i,a.element=s[e],a},!1,function(e,t){return l})}}(Og||(Og={})),function(e){e.fromGroup=function(e){const{group:t,structure:n}=e,i=t.units[0],s=Gi.Nf.isAtomic(i)?i.nucleotideElements:[],r=s.length,o=t.units.length,a=Gi.iZ.Location.create(n);return(0,ip.iQ)(r,o,1,(e,n)=>{const i=t.units[n];return a.unit=i,a.element=s[e],a})}}(zg||(zg={}));const Xg=(0,vh.e)(),Wg=(0,vh.e)();function Yg(e,t){const{model:n,conformation:i}=e,{residueAtomSegments:s,atoms:r,index:o}=n.atomicHierarchy,{label_comp_id:a}=r,l=a.value(s.offsets[t]);let c=(0,np.VH)(l),u=(0,np.qN)(l);if(!c&&!u){const e=o.findAtomOnResidue(t,"C4"),n=o.findAtomOnResidue(t,"N9");-1!==e&&-1!==n&&vh.e.distance(i.invariantPosition(e,Xg),i.invariantPosition(n,Wg))<1.6?c=!0:u=!0}return{isPurine:c,isPyrimidine:u}}function Jg(){return{trace:-1,N1:-1,C2:-1,N3:-1,C4:-1,C5:-1,C6:-1,N7:-1,C8:-1,N9:-1,C1_1:-1,C2_1:-1,C3_1:-1,C4_1:-1,O4_1:-1}}function ey(e,t,n){const i=t.model.atomicHierarchy.index,{traceElementIndex:s}=t.model.atomicHierarchy.derived.residue;return e.trace=s[n],e.N1=i.findAtomOnResidue(n,"N1"),e.C2=i.findAtomOnResidue(n,"C2"),e.N3=i.findAtomOnResidue(n,"N3"),e.C4=i.findAtomOnResidue(n,"C4"),e.C5=i.findAtomOnResidue(n,"C5"),-1===e.C5&&(e.C5=i.findAtomOnResidue(n,"N5")),e.C6=i.findAtomOnResidue(n,"C6"),e.N7=i.findAtomOnResidue(n,"N7"),-1===e.N7&&(e.N7=i.findAtomOnResidue(n,"C7")),e.C8=i.findAtomOnResidue(n,"C8"),e.N9=i.findAtomOnResidue(n,"N9"),e}function ty(e){return-1!==e.trace&&-1!==e.N1&&-1!==e.C2&&-1!==e.N3&&-1!==e.C4&&-1!==e.C5&&-1!==e.C6&&-1!==e.N7&&-1!==e.C8&&-1!==e.N9}function ny(e,t,n){const i=t.model.atomicHierarchy.index,{traceElementIndex:s}=t.model.atomicHierarchy.derived.residue;return e.trace=s[n],e.N1=i.findAtomOnResidue(n,"N1"),-1===e.N1&&(e.N1=i.findAtomOnResidue(n,"C1")),e.C2=i.findAtomOnResidue(n,"C2"),e.N3=i.findAtomOnResidue(n,"N3"),e.C4=i.findAtomOnResidue(n,"C4"),e.C5=i.findAtomOnResidue(n,"C5"),e.C6=i.findAtomOnResidue(n,"C6"),e}function iy(e){return-1!==e.trace&&-1!==e.N1&&-1!==e.C2&&-1!==e.N3&&-1!==e.C4&&-1!==e.C5&&-1!==e.C6}function sy(e,t,n){const i=t.model.atomicHierarchy.index,{traceElementIndex:s}=t.model.atomicHierarchy.derived.residue;return e.trace=s[n],e.C1_1=i.findAtomOnResidue(n,"C1'"),e.C2_1=i.findAtomOnResidue(n,"C2'"),e.C3_1=i.findAtomOnResidue(n,"C3'"),e.C4_1=i.findAtomOnResidue(n,"C4'"),e.O4_1=i.findAtomOnResidue(n,"O4'"),e}function ry(e){return-1!==e.trace&&-1!==e.C1_1&&-1!==e.C2_1&&-1!==e.C3_1&&-1!==e.C4_1&&-1!==e.O4_1}const oy=(0,Go.eB)(),ay=(0,Go.eB)(),ly=(0,Go.eB)(),cy=(0,Go.eB)(),uy=(0,Go.eB)(),dy=(0,Go.eB)(),hy=(0,Go.eB)(),py=(0,Go.eB)(),my=(0,Go.eB)(),fy=(0,Go.eB)(),gy=Go.$I.identity(),yy=(0,Go.eB)(),vy=(0,jm.az)(),by={sizeFactor:Xi.t.Numeric(.2,{min:0,max:10,step:.01}),thicknessFactor:Xi.t.Numeric(1,{min:0,max:2,step:.01}),radialSegments:Xi.t.Numeric(16,{min:2,max:56,step:2},Vi.iy.CustomQualityParamInfo)};Xi.t.getDefaultValues(by);function xy(e,t,n,i,s,r){if(!Gi.Nf.isAtomic(t))return Jh.e.createEmpty(r);const o=t.nucleotideElements.length;if(!o)return Jh.e.createEmpty(r);const{sizeFactor:a,thicknessFactor:l,radialSegments:c}=s,u=o*(vy.vertices.length/3+2*c),d=Kp.P.createState(u,u/4,r),{elements:h,model:p,conformation:m}=t,{chainAtomSegments:f,residueAtomSegments:g}=p.atomicHierarchy,{moleculeType:y}=p.atomicHierarchy.derived.residue,v=ho.hT.transientSegments(f,h),b=ho.hT.transientSegments(g,h),x=1*a,S=l*a*2,C={radiusTop:x,radiusBottom:x,radialSegments:c,bottomCap:!0};let w=0;for(;v.hasNext;)for(b.setSegment(v.move());b.hasNext;){const{index:e}=b.move();if((0,np.OV)(y[e])){const n=Jg();let i=-1,s=-1,r=-1,o=-1,a=-1,l=4.5;const{isPurine:c,isPyrimidine:u}=Yg(t,e);c?(l=4.5,ey(n,t,e),i=n.N1,s=n.C4,r=n.C6,o=n.C2,a=n.N9):u&&(l=3,ny(n,t,e),i=n.N3,s=n.C6,r=n.C4,o=n.C2,a=n.N1),-1!==a&&-1!==n.trace&&(m.invariantPosition(a,uy),m.invariantPosition(n.trace,dy),d.currentGroup=w,(0,Df.y9)(d,uy,dy,1,C),-1!==i&&-1!==s&&-1!==r&&-1!==o&&(m.invariantPosition(i,oy),m.invariantPosition(s,ay),m.invariantPosition(r,ly),m.invariantPosition(o,cy),Go.eB.normalize(hy,Go.eB.sub(hy,ay,oy)),Go.eB.normalize(py,Go.eB.sub(py,cy,ly)),Go.eB.normalize(my,Go.eB.cross(my,hy,py)),Go.$I.targetTo(gy,oy,ay,my),Go.eB.scaleAndAdd(fy,oy,hy,l/2-.2),Go.$I.scale(gy,gy,Go.eB.set(yy,4.5,S,l)),Go.$I.setTranslation(gy,fy),Kp.P.addPrimitive(d,gy,vy))),++w}}const k=Kp.P.getMesh(d),B=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,x);return k.setBoundingSphere(B),k}const Sy={...tp.Te,...by};function Cy(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(Sy),createGeometry:xy,createLocationIterator:zg.fromGroup,getLoci:Zg,eachLocation:Qg,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.thicknessFactor!==n.thicknessFactor||t.radialSegments!==n.radialSegments}},e)}const wy=(0,Go.eB)(),ky=(0,Go.eB)(),By=(0,Go.eB)(),Py=(0,Go.eB)(),Iy=(0,Go.eB)(),jy=(0,Go.eB)(),Ty=(0,Go.eB)(),Ay=(0,Go.eB)(),My=(0,Go.eB)(),Ly=(0,Go.eB)(),Ey=(0,Go.eB)(),Dy={sizeFactor:Xi.t.Numeric(.2,{min:0,max:10,step:.01}),thicknessFactor:Xi.t.Numeric(1,{min:0,max:2,step:.01}),radialSegments:Xi.t.Numeric(16,{min:2,max:56,step:2},Vi.iy.CustomQualityParamInfo),detail:Xi.t.Numeric(0,{min:0,max:3,step:1},Vi.iy.CustomQualityParamInfo)},Ny=(Xi.t.getDefaultValues(Dy),new Float32Array(54)),Fy=new Uint32Array([0,1,2,3,4,5,6,7,16,17,14,15,12,13,8,9,10,11,0,1]),Ry=new Uint32Array([8,12,14,16,6,4,2,0,10]),Oy=new Uint32Array([9,11,1,3,5,7,17,15,13]),zy=new Float32Array(36),Hy=new Uint32Array([0,1,2,3,4,5,6,7,8,9,10,11,0,1]),Uy=new Uint32Array([0,10,8,6,4,2]),Vy=new Uint32Array([1,3,5,7,9,11]),_y=(0,Go.eB)();function Gy(e,t,...n){for(let i=0,s=n.length;i<s;++i){const s=n[i];Go.eB.toArray(Go.eB.add(_y,s,t),e,2*i*3),Go.eB.toArray(Go.eB.sub(_y,s,t),e,3*(2*i+1))}}function qy(e,t,n,i,s,r){if(!Gi.Nf.isAtomic(t))return Jh.e.createEmpty(r);const o=t.nucleotideElements.length;if(!o)return Jh.e.createEmpty(r);const{sizeFactor:a,thicknessFactor:l,radialSegments:c,detail:u}=s,d=o*(26+2*c),h=Kp.P.createState(d,d/4,r),{elements:p,model:m,conformation:f}=t,{chainAtomSegments:g,residueAtomSegments:y}=m.atomicHierarchy,{moleculeType:v}=m.atomicHierarchy.derived.residue,b=ho.hT.transientSegments(g,p),x=ho.hT.transientSegments(y,p),S=1*a,C=l*a,w={radiusTop:S,radiusBottom:S,radialSegments:c};let k=0;for(;b.hasNext;)for(x.setSegment(b.move());x.hasNext;){const{index:e}=x.move();if((0,np.OV)(v[e])){const n=Jg();h.currentGroup=k;const{isPurine:i,isPyrimidine:s}=Yg(t,e);i?(ey(n,t,e),-1!==n.N9&&-1!==n.trace&&(f.invariantPosition(n.N9,Ly),f.invariantPosition(n.trace,wy),h.currentGroup=k,(0,Df.y9)(h,Ly,wy,1,w),(0,Qp.X)(h,Ly,S,u)),ty(n)&&(f.invariantPosition(n.N1,ky),f.invariantPosition(n.C2,By),f.invariantPosition(n.N3,Py),f.invariantPosition(n.C4,Iy),f.invariantPosition(n.C5,jy),f.invariantPosition(n.C6,Ty),f.invariantPosition(n.N7,Ay),f.invariantPosition(n.C8,My),Go.eB.triangleNormal(Ey,ky,Iy,jy),Go.eB.scale(Ey,Ey,C),Gy(Ny,Ey,ky,By,Py,Iy,jy,Ty,Ay,My,Ly),Kp.P.addTriangleStrip(h,Ny,Fy),Kp.P.addTriangleFan(h,Ny,Ry),Kp.P.addTriangleFan(h,Ny,Oy))):s&&(ny(n,t,e),-1!==n.N1&&-1!==n.trace&&(f.invariantPosition(n.N1,ky),f.invariantPosition(n.trace,wy),h.currentGroup=k,(0,Df.y9)(h,ky,wy,1,w),(0,Qp.X)(h,ky,S,u)),iy(n)&&(f.invariantPosition(n.C2,By),f.invariantPosition(n.N3,Py),f.invariantPosition(n.C4,Iy),f.invariantPosition(n.C5,jy),f.invariantPosition(n.C6,Ty),Go.eB.triangleNormal(Ey,ky,Iy,jy),Go.eB.scale(Ey,Ey,C),Gy(zy,Ey,ky,By,Py,Iy,jy,Ty),Kp.P.addTriangleStrip(h,zy,Hy),Kp.P.addTriangleFan(h,zy,Uy),Kp.P.addTriangleFan(h,zy,Vy))),++k}}const B=Kp.P.getMesh(h),P=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,S);return B.setBoundingSphere(P),B}const $y={...tp.Te,...Dy};function Zy(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues($y),createGeometry:qy,createLocationIterator:zg.fromGroup,getLoci:Zg,eachLocation:Qg,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.thicknessFactor!==n.thicknessFactor||t.radialSegments!==n.radialSegments}},e)}const Ky=(0,Go.eB)(),Qy=(0,Go.eB)(),Xy=(0,Go.eB)(),Wy=(0,Go.eB)(),Yy=(0,Go.eB)(),Jy=(0,Go.eB)(),ev=(0,Go.eB)(),tv=(0,Go.eB)(),nv=(0,Go.eB)(),iv=(0,Go.eB)(),sv=(0,Go.eB)(),rv=(0,Go.eB)(),ov=(0,Go.eB)(),av=(0,Go.eB)(),lv=(0,Go.eB)(),cv=(0,Go.eB)(),uv=(0,Go.eB)(),dv={sizeFactor:Xi.t.Numeric(.2,{min:0,max:10,step:.01}),thicknessFactor:Xi.t.Numeric(1,{min:0,max:2,step:.01})},hv=(Xi.t.getDefaultValues(dv),new Float32Array(54)),pv=new Uint32Array([0,1,2,3,4,5,6,7,16,17,14,15,12,13,8,9,10,11,0,1]),mv=new Uint32Array([8,12,14,16,6,4,2,0,10]),fv=new Uint32Array([9,11,1,3,5,7,17,15,13]),gv=new Float32Array(36),yv=new Uint32Array([2,3,4,5,6,7,8,9,10,11,2,3]),vv=new Uint32Array([0,10,8,6,4,2,10]),bv=new Uint32Array([1,3,5,7,9,11,3]),xv=new Float32Array(36),Sv=new Uint32Array([0,1,2,3,4,5,6,7,8,9,10,11,0,1]),Cv=new Uint32Array([0,10,8,6,4,2]),wv=new Uint32Array([1,3,5,7,9,11]),kv=(0,Go.eB)();function Bv(e,t,...n){for(let i=0,s=n.length;i<s;++i){const s=n[i];Go.eB.toArray(Go.eB.add(kv,s,t),e,2*i*3),Go.eB.toArray(Go.eB.sub(kv,s,t),e,3*(2*i+1))}}function Pv(e,t,n,i,s,r){if(!Gi.Nf.isAtomic(t))return Jh.e.createEmpty(r);const o=t.nucleotideElements.length;if(!o)return Jh.e.createEmpty(r);const{sizeFactor:a,thicknessFactor:l}=s,c=25*o,u=Kp.P.createState(c,c/4,r),{elements:d,model:h,conformation:p}=t,{chainAtomSegments:m,residueAtomSegments:f}=h.atomicHierarchy,{moleculeType:g}=h.atomicHierarchy.derived.residue,y=ho.hT.transientSegments(m,d),v=ho.hT.transientSegments(f,d),b=a*l;let x=0;for(;y.hasNext;)for(v.setSegment(y.move());v.hasNext;){const{index:e}=v.move();if((0,np.OV)(g[e])){const n=Jg();u.currentGroup=x,sy(n,t,e),ry(n)&&(p.invariantPosition(n.C1_1,iv),p.invariantPosition(n.C2_1,sv),p.invariantPosition(n.C3_1,rv),p.invariantPosition(n.C4_1,ov),p.invariantPosition(n.O4_1,av),Go.eB.triangleNormal(cv,rv,ov,iv),Go.eB.scale(lv,Go.eB.add(lv,av,Go.eB.add(lv,ov,Go.eB.add(lv,rv,Go.eB.add(lv,iv,sv)))),.2),Go.eB.scale(uv,cv,b),Bv(gv,uv,lv,rv,ov,av,iv,sv),Kp.P.addTriangleStrip(u,gv,yv),Kp.P.addTriangleFanWithNormal(u,gv,vv,cv),Go.eB.negate(cv,cv),Kp.P.addTriangleFanWithNormal(u,gv,bv,cv));const{isPurine:i,isPyrimidine:s}=Yg(t,e);i?(ey(n,t,e),ty(n)&&(p.invariantPosition(n.N1,Ky),p.invariantPosition(n.C2,Qy),p.invariantPosition(n.N3,Xy),p.invariantPosition(n.C4,Wy),p.invariantPosition(n.C5,Yy),p.invariantPosition(n.C6,Jy),p.invariantPosition(n.N7,ev),p.invariantPosition(n.C8,tv),p.invariantPosition(n.N9,nv),Go.eB.triangleNormal(cv,Ky,Wy,Yy),Go.eB.scale(uv,cv,b),Bv(hv,uv,Ky,Qy,Xy,Wy,Yy,Jy,ev,tv,nv),Kp.P.addTriangleStrip(u,hv,pv),Kp.P.addTriangleFanWithNormal(u,hv,mv,cv),Go.eB.negate(cv,cv),Kp.P.addTriangleFanWithNormal(u,hv,fv,cv))):s&&(ny(n,t,e),iy(n)&&(p.invariantPosition(n.N1,Ky),p.invariantPosition(n.C2,Qy),p.invariantPosition(n.N3,Xy),p.invariantPosition(n.C4,Wy),p.invariantPosition(n.C5,Yy),p.invariantPosition(n.C6,Jy),Go.eB.triangleNormal(cv,Ky,Wy,Yy),Go.eB.scale(uv,cv,b),Bv(xv,uv,Ky,Qy,Xy,Wy,Yy,Jy),Kp.P.addTriangleStrip(u,xv,Sv),Kp.P.addTriangleFanWithNormal(u,xv,Cv,cv),Go.eB.negate(cv,cv),Kp.P.addTriangleFanWithNormal(u,xv,wv,cv))),++x}}const S=Kp.P.getMesh(u),C=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,b);return S.setBoundingSphere(C),S}const Iv={...tp.Te,...dv};function jv(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(Iv),createGeometry:Pv,createLocationIterator:zg.fromGroup,getLoci:Zg,eachLocation:Qg,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.thicknessFactor!==n.thicknessFactor}},e)}var Tv=n(93692);const Av=(0,Go.eB)(),Mv=(0,Go.eB)(),Lv=(0,Go.eB)(),Ev=(0,Go.eB)(),Dv=(0,Go.eB)(),Nv=(0,Go.eB)(),Fv=(0,Go.eB)(),Rv=(0,Go.eB)(),Ov=(0,Go.eB)(),zv=(0,Go.eB)(),Hv=(0,Go.eB)(),Uv=(0,Go.eB)(),Vv=(0,Go.eB)(),_v=(0,Go.eB)(),Gv=(0,Go.eB)(),qv={...tp.Te,...tp.lm,sizeFactor:Xi.t.Numeric(.3,{min:0,max:10,step:.01}),radialSegments:Xi.t.Numeric(16,{min:2,max:56,step:2},Vi.iy.CustomQualityParamInfo),tryUseImpostor:Xi.t.Boolean(!0)};function $v(e,t,n,i){return n.tryUseImpostor&&(0,op.VZ)(i)?function(e){return(0,tp.Vb)({defaultProps:Xi.t.getDefaultValues(qv),createGeometry:Zv,createLocationIterator:zg.fromGroup,getLoci:Zg,eachLocation:Qg,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor},mustRecreate:(e,t,n)=>!t.tryUseImpostor||!n},e)}(e):function(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(qv),createGeometry:Kv,createLocationIterator:zg.fromGroup,getLoci:Zg,eachLocation:Qg,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.radialSegments!==n.radialSegments},mustRecreate:(e,t,n)=>t.tryUseImpostor&&!!n},e)}(e)}function Zv(e,t,n,i,s,r){if(!Gi.Nf.isAtomic(t))return kp.S.createEmpty(r);const o=t.nucleotideElements.length;if(!o)return kp.S.createEmpty(r);const a=15*o,l=Tv.h.create(a,a/4,r),{elements:c,model:u,conformation:d}=t,{chainAtomSegments:h,residueAtomSegments:p}=u.atomicHierarchy,{moleculeType:m}=u.atomicHierarchy.derived.residue,f=ho.hT.transientSegments(h,c),g=ho.hT.transientSegments(p,c);let y=0;for(;f.hasNext;)for(g.setSegment(f.move());g.hasNext;){const{index:e}=g.move();if((0,np.OV)(m[e])){const n=Jg();sy(n,t,e),ry(n)&&(d.invariantPosition(n.C1_1,Hv),d.invariantPosition(n.C2_1,Uv),d.invariantPosition(n.C3_1,Vv),d.invariantPosition(n.C4_1,_v),d.invariantPosition(n.O4_1,Gv),d.invariantPosition(n.trace,Av),l.add(Vv[0],Vv[1],Vv[2],Av[0],Av[1],Av[2],1,!0,!0,2,y),l.add(Vv[0],Vv[1],Vv[2],_v[0],_v[1],_v[2],1,!0,!0,2,y),l.add(_v[0],_v[1],_v[2],Gv[0],Gv[1],Gv[2],1,!0,!0,2,y),l.add(Gv[0],Gv[1],Gv[2],Hv[0],Hv[1],Hv[2],1,!0,!0,2,y),l.add(Hv[0],Hv[1],Hv[2],Uv[0],Uv[1],Uv[2],1,!0,!0,2,y),l.add(Uv[0],Uv[1],Uv[2],Vv[0],Vv[1],Vv[2],1,!0,!0,2,y));const{isPurine:i,isPyrimidine:s}=Yg(t,e);i?(ey(n,t,e),-1!==n.C1_1&&-1!==n.N9?(d.invariantPosition(n.C1_1,Hv),d.invariantPosition(n.N9,zv),l.add(zv[0],zv[1],zv[2],Hv[0],Hv[1],Hv[2],1,!0,!0,2,y)):-1!==n.N9&&-1!==n.trace&&(d.invariantPosition(n.N9,zv),d.invariantPosition(n.trace,Av),l.add(zv[0],zv[1],zv[2],Av[0],Av[1],Av[2],1,!0,!0,2,y)),ty(n)&&(d.invariantPosition(n.N1,Mv),d.invariantPosition(n.C2,Lv),d.invariantPosition(n.N3,Ev),d.invariantPosition(n.C4,Dv),d.invariantPosition(n.C5,Nv),d.invariantPosition(n.C6,Fv),d.invariantPosition(n.N7,Rv),d.invariantPosition(n.C8,Ov),d.invariantPosition(n.N9,zv),l.add(zv[0],zv[1],zv[2],Ov[0],Ov[1],Ov[2],1,!0,!0,2,y),l.add(Ov[0],Ov[1],Ov[2],Rv[0],Rv[1],Rv[2],1,!0,!0,2,y),l.add(Rv[0],Rv[1],Rv[2],Nv[0],Nv[1],Nv[2],1,!0,!0,2,y),l.add(Nv[0],Nv[1],Nv[2],Fv[0],Fv[1],Fv[2],1,!0,!0,2,y),l.add(Fv[0],Fv[1],Fv[2],Mv[0],Mv[1],Mv[2],1,!0,!0,2,y),l.add(Mv[0],Mv[1],Mv[2],Lv[0],Lv[1],Lv[2],1,!0,!0,2,y),l.add(Lv[0],Lv[1],Lv[2],Ev[0],Ev[1],Ev[2],1,!0,!0,2,y),l.add(Ev[0],Ev[1],Ev[2],Dv[0],Dv[1],Dv[2],1,!0,!0,2,y),l.add(Dv[0],Dv[1],Dv[2],Nv[0],Nv[1],Nv[2],1,!0,!0,2,y),l.add(Dv[0],Dv[1],Dv[2],zv[0],zv[1],zv[2],1,!0,!0,2,y))):s&&(ny(n,t,e),-1!==n.C1_1&&-1!==n.N1?(d.invariantPosition(n.N1,Mv),d.invariantPosition(n.C1_1,Hv),l.add(Mv[0],Mv[1],Mv[2],Hv[0],Hv[1],Hv[2],1,!0,!0,2,y)):-1!==n.N1&&-1!==n.trace&&(d.invariantPosition(n.N1,Mv),d.invariantPosition(n.trace,Av),l.add(Mv[0],Mv[1],Mv[2],Av[0],Av[1],Av[2],1,!0,!0,2,y)),iy(n)&&(d.invariantPosition(n.N1,Mv),d.invariantPosition(n.C2,Lv),d.invariantPosition(n.N3,Ev),d.invariantPosition(n.C4,Dv),d.invariantPosition(n.C5,Nv),d.invariantPosition(n.C6,Fv),l.add(Mv[0],Mv[1],Mv[2],Fv[0],Fv[1],Fv[2],1,!0,!0,2,y),l.add(Fv[0],Fv[1],Fv[2],Nv[0],Nv[1],Nv[2],1,!0,!0,2,y),l.add(Nv[0],Nv[1],Nv[2],Dv[0],Dv[1],Dv[2],1,!0,!0,2,y),l.add(Dv[0],Dv[1],Dv[2],Ev[0],Ev[1],Ev[2],1,!0,!0,2,y),l.add(Ev[0],Ev[1],Ev[2],Lv[0],Lv[1],Lv[2],1,!0,!0,2,y),l.add(Lv[0],Lv[1],Lv[2],Mv[0],Mv[1],Mv[2],1,!0,!0,2,y))),++y}}const v=l.getCylinders(),b=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*s.sizeFactor);return v.setBoundingSphere(b),v}function Kv(e,t,n,i,s,r){if(!Gi.Nf.isAtomic(t))return Jh.e.createEmpty(r);const o=t.nucleotideElements.length;if(!o)return Jh.e.createEmpty(r);const{sizeFactor:a,radialSegments:l}=s,c=o*(15*l),u=Kp.P.createState(c,c/4,r),{elements:d,model:h,conformation:p}=t,{chainAtomSegments:m,residueAtomSegments:f}=h.atomicHierarchy,{moleculeType:g}=h.atomicHierarchy.derived.residue,y=ho.hT.transientSegments(m,d),v=ho.hT.transientSegments(f,d),b={radiusTop:1*a,radiusBottom:1*a,radialSegments:l};let x=0;for(;y.hasNext;)for(v.setSegment(y.move());v.hasNext;){const{index:e}=v.move();if((0,np.OV)(g[e])){const n=Jg();u.currentGroup=x,sy(n,t,e),ry(n)&&(p.invariantPosition(n.C1_1,Hv),p.invariantPosition(n.C2_1,Uv),p.invariantPosition(n.C3_1,Vv),p.invariantPosition(n.C4_1,_v),p.invariantPosition(n.O4_1,Gv),p.invariantPosition(n.trace,Av),(0,Df.y9)(u,Vv,Av,1,b),(0,Df.y9)(u,Vv,_v,1,b),(0,Df.y9)(u,_v,Gv,1,b),(0,Df.y9)(u,Gv,Hv,1,b),(0,Df.y9)(u,Hv,Uv,1,b),(0,Df.y9)(u,Uv,Vv,1,b));const{isPurine:i,isPyrimidine:s}=Yg(t,e);i?(ey(n,t,e),-1!==n.C1_1&&-1!==n.N9?(p.invariantPosition(n.C1_1,Hv),p.invariantPosition(n.N9,zv),(0,Df.y9)(u,zv,Hv,1,b)):-1!==n.N9&&-1!==n.trace&&(p.invariantPosition(n.N9,zv),p.invariantPosition(n.trace,Av),(0,Df.y9)(u,zv,Av,1,b)),ty(n)&&(p.invariantPosition(n.N1,Mv),p.invariantPosition(n.C2,Lv),p.invariantPosition(n.N3,Ev),p.invariantPosition(n.C4,Dv),p.invariantPosition(n.C5,Nv),p.invariantPosition(n.C6,Fv),p.invariantPosition(n.N7,Rv),p.invariantPosition(n.C8,Ov),p.invariantPosition(n.N9,zv),(0,Df.y9)(u,zv,Ov,1,b),(0,Df.y9)(u,Ov,Rv,1,b),(0,Df.y9)(u,Rv,Nv,1,b),(0,Df.y9)(u,Nv,Fv,1,b),(0,Df.y9)(u,Fv,Mv,1,b),(0,Df.y9)(u,Mv,Lv,1,b),(0,Df.y9)(u,Lv,Ev,1,b),(0,Df.y9)(u,Ev,Dv,1,b),(0,Df.y9)(u,Dv,Nv,1,b),(0,Df.y9)(u,Dv,zv,1,b))):s&&(ny(n,t,e),-1!==n.C1_1&&-1!==n.N1?(p.invariantPosition(n.N1,Mv),p.invariantPosition(n.C1_1,Hv),(0,Df.y9)(u,Mv,Hv,1,b)):-1!==n.N1&&-1!==n.trace&&(p.invariantPosition(n.N1,Mv),p.invariantPosition(n.trace,Av),(0,Df.y9)(u,Mv,Av,1,b)),iy(n)&&(p.invariantPosition(n.N1,Mv),p.invariantPosition(n.C2,Lv),p.invariantPosition(n.N3,Ev),p.invariantPosition(n.C4,Dv),p.invariantPosition(n.C5,Nv),p.invariantPosition(n.C6,Fv),(0,Df.y9)(u,Mv,Fv,1,b),(0,Df.y9)(u,Fv,Nv,1,b),(0,Df.y9)(u,Nv,Dv,1,b),(0,Df.y9)(u,Dv,Ev,1,b),(0,Df.y9)(u,Ev,Lv,1,b),(0,Df.y9)(u,Lv,Mv,1,b))),++x}}const S=Kp.P.getMesh(u),C=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*s.sizeFactor);return S.setBoundingSphere(C),S}const Qv=(0,Go.eB)(),Xv=(0,Go.eB)(),Wv=(0,Go.eB)(),Yv=(0,Go.eB)(),Jv=(0,Go.eB)(),eb=(0,Go.eB)(),tb=(0,Go.eB)(),nb=(0,Go.eB)(),ib=(0,Go.eB)(),sb=(0,Go.eB)(),rb=(0,Go.eB)(),ob=(0,Go.eB)(),ab=(0,Go.eB)(),lb=(0,Go.eB)(),cb=(0,Go.eB)(),ub={...tp.Te,...tp.qg,sizeFactor:Xi.t.Numeric(.3,{min:0,max:10,step:.01}),detail:Xi.t.Numeric(0,{min:0,max:3,step:1},Vi.iy.CustomQualityParamInfo),tryUseImpostor:Xi.t.Boolean(!0)};function db(e,t,n,i){return n.tryUseImpostor&&(0,op.gU)(i)?function(e){return(0,tp.uF)({defaultProps:Xi.t.getDefaultValues(ub),createGeometry:hb,createLocationIterator:zg.fromGroup,getLoci:Zg,eachLocation:Qg,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor},mustRecreate:(e,t,n)=>!t.tryUseImpostor||!n},e)}(e):function(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(ub),createGeometry:pb,createLocationIterator:zg.fromGroup,getLoci:Zg,eachLocation:Qg,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.detail!==n.detail},mustRecreate:(e,t,n)=>t.tryUseImpostor&&!!n},e)}(e)}function hb(e,t,n,i,s,r){if(!Gi.Nf.isAtomic(t))return Xp.v.createEmpty(r);const o=t.nucleotideElements.length;if(!o)return Xp.v.createEmpty(r);const a=15*o,l=Wp.Q.create(a,a/4,r),{elements:c,model:u,conformation:d}=t,{chainAtomSegments:h,residueAtomSegments:p}=u.atomicHierarchy,{moleculeType:m}=u.atomicHierarchy.derived.residue,f=ho.hT.transientSegments(h,c),g=ho.hT.transientSegments(p,c);let y=0;for(;f.hasNext;)for(g.setSegment(f.move());g.hasNext;){const{index:e}=g.move();if((0,np.OV)(m[e])){const n=Jg();sy(n,t,e),ry(n)&&(d.invariantPosition(n.C1_1,rb),d.invariantPosition(n.C2_1,ob),d.invariantPosition(n.C3_1,ab),d.invariantPosition(n.C4_1,lb),d.invariantPosition(n.O4_1,cb),d.invariantPosition(n.trace,Qv),l.add(Qv[0],Qv[1],Qv[2],y),l.add(ab[0],ab[1],ab[2],y),l.add(lb[0],lb[1],lb[2],y),l.add(cb[0],cb[1],cb[2],y),l.add(rb[0],rb[1],rb[2],y),l.add(ob[0],ob[1],ob[2],y));const{isPurine:i,isPyrimidine:s}=Yg(t,e);i?(ey(n,t,e),ty(n)&&(d.invariantPosition(n.N1,Xv),d.invariantPosition(n.C2,Wv),d.invariantPosition(n.N3,Yv),d.invariantPosition(n.C4,Jv),d.invariantPosition(n.C5,eb),d.invariantPosition(n.C6,tb),d.invariantPosition(n.N7,nb),d.invariantPosition(n.C8,ib),d.invariantPosition(n.N9,sb),l.add(sb[0],sb[1],sb[2],y),l.add(ib[0],ib[1],ib[2],y),l.add(nb[0],nb[1],nb[2],y),l.add(eb[0],eb[1],eb[2],y),l.add(tb[0],tb[1],tb[2],y),l.add(Xv[0],Xv[1],Xv[2],y),l.add(Wv[0],Wv[1],Wv[2],y),l.add(Yv[0],Yv[1],Yv[2],y),l.add(Jv[0],Jv[1],Jv[2],y))):s&&(ny(n,t,e),iy(n)&&(d.invariantPosition(n.N1,Xv),d.invariantPosition(n.C2,Wv),d.invariantPosition(n.N3,Yv),d.invariantPosition(n.C4,Jv),d.invariantPosition(n.C5,eb),d.invariantPosition(n.C6,tb),l.add(Xv[0],Xv[1],Xv[2],y),l.add(tb[0],tb[1],tb[2],y),l.add(eb[0],eb[1],eb[2],y),l.add(Jv[0],Jv[1],Jv[2],y),l.add(Yv[0],Yv[1],Yv[2],y),l.add(Wv[0],Wv[1],Wv[2],y))),++y}}const v=l.getSpheres(),b=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*s.sizeFactor);return v.setBoundingSphere(b),v}function pb(e,t,n,i,s,r){if(!Gi.Nf.isAtomic(t))return Jh.e.createEmpty(r);const o=t.nucleotideElements.length;if(!o)return Jh.e.createEmpty(r);const{sizeFactor:a,detail:l}=s,c=o*(0,Zp.J)(l),u=Kp.P.createState(c,c/2,r),{elements:d,model:h,conformation:p}=t,{chainAtomSegments:m,residueAtomSegments:f}=h.atomicHierarchy,{moleculeType:g}=h.atomicHierarchy.derived.residue,y=ho.hT.transientSegments(m,d),v=ho.hT.transientSegments(f,d),b=1*a;let x=0;for(;y.hasNext;)for(v.setSegment(y.move());v.hasNext;){const{index:e}=v.move();if((0,np.OV)(g[e])){const n=Jg();u.currentGroup=x,sy(n,t,e),ry(n)&&(p.invariantPosition(n.C1_1,rb),p.invariantPosition(n.C2_1,ob),p.invariantPosition(n.C3_1,ab),p.invariantPosition(n.C4_1,lb),p.invariantPosition(n.O4_1,cb),p.invariantPosition(n.trace,Qv),(0,Qp.X)(u,Qv,b,l),(0,Qp.X)(u,lb,b,l),(0,Qp.X)(u,cb,b,l),(0,Qp.X)(u,rb,b,l),(0,Qp.X)(u,ob,b,l),(0,Qp.X)(u,ab,b,l));const{isPurine:i,isPyrimidine:s}=Yg(t,e);i?(ey(n,t,e),ty(n)&&(p.invariantPosition(n.N1,Xv),p.invariantPosition(n.C2,Wv),p.invariantPosition(n.N3,Yv),p.invariantPosition(n.C4,Jv),p.invariantPosition(n.C5,eb),p.invariantPosition(n.C6,tb),p.invariantPosition(n.N7,nb),p.invariantPosition(n.C8,ib),p.invariantPosition(n.N9,sb),(0,Qp.X)(u,ib,b,l),(0,Qp.X)(u,nb,b,l),(0,Qp.X)(u,eb,b,l),(0,Qp.X)(u,tb,b,l),(0,Qp.X)(u,Xv,b,l),(0,Qp.X)(u,Wv,b,l),(0,Qp.X)(u,Yv,b,l),(0,Qp.X)(u,Jv,b,l),(0,Qp.X)(u,eb,b,l),(0,Qp.X)(u,sb,b,l))):s&&(ny(n,t,e),iy(n)&&(p.invariantPosition(n.N1,Xv),p.invariantPosition(n.C2,Wv),p.invariantPosition(n.N3,Yv),p.invariantPosition(n.C4,Jv),p.invariantPosition(n.C5,eb),p.invariantPosition(n.C6,tb),(0,Qp.X)(u,tb,b,l),(0,Qp.X)(u,eb,b,l),(0,Qp.X)(u,Jv,b,l),(0,Qp.X)(u,Yv,b,l),(0,Qp.X)(u,Wv,b,l),(0,Qp.X)(u,Xv,b,l))),++x}}const S=Kp.P.getMesh(u),C=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*s.sizeFactor);return S.setBoundingSphere(C),S}const mb=Go.eB.zero(),fb=Go.eB.zero(),gb=Go.eB.zero(),yb=Go.eB.zero(),vb=(0,Am.n)(3,!1);let bb;const xb=Go.$I.identity(),Sb=Go.eB.zero(),Cb=Go.eB.zero(),wb=Go.eB.zero(),kb=Go.eB.zero(),Bb=(bb||(bb=function(){const e=(0,Tm.nT)(8);for(let t=0;t<3;++t){const n=(t+1)%3;Go.eB.set(mb,vb[3*t],vb[3*t+1],-.5),Go.eB.set(fb,vb[3*n],vb[3*n+1],-.5),Go.eB.set(gb,vb[3*n],vb[3*n+1],.5),Go.eB.set(yb,vb[3*t],vb[3*t+1],.5),e.add(mb,fb,gb),e.add(gb,yb,mb)}return Go.eB.set(mb,vb[0],vb[1],-.5),Go.eB.set(fb,vb[3],vb[4],-.5),Go.eB.set(gb,vb[6],vb[7],-.5),e.add(gb,fb,mb),Go.eB.set(mb,vb[0],vb[1],.5),Go.eB.set(fb,vb[3],vb[4],.5),Go.eB.set(gb,vb[6],vb[7],.5),e.add(mb,fb,gb),e.getPrimitive()}()),bb),Pb={sizeFactor:Xi.t.Numeric(.2,{min:0,max:10,step:.01})};Xi.t.getDefaultValues(Pb);function Ib(e,t,n,i,s,r){const o=t.polymerElements.length;if(!o)return Jh.e.createEmpty(r);const{sizeFactor:a}=s,l=24*o,c=Kp.P.createState(l,l/10,r),u=yg(1),{normalVectors:d,binormalVectors:h}=u;let p=0;const m=Kf(t,n);for(;m.hasNext;){const e=m.move();c.currentGroup=p;const t=(0,np.OV)(e.moleculeType),n=np.gG.is(e.secStrucType,np.gG.Flag.Beta);if(vg(u,e,t||n?.5:.9,t?.3:.5),n&&!e.secStrucLast||!n){const n=i.size.size(e.center)*a,s=4*n,r=4*n,o=6*n,l=t?h:d;Go.eB.fromArray(Cb,l,0),Go.eB.fromArray(wb,l,3),Go.eB.normalize(kb,Go.eB.add(kb,Cb,wb)),Go.$I.targetTo(xb,e.p3,e.p1,kb),Go.$I.mul(xb,xb,Go.$I.rotY90Z180),Go.$I.scale(xb,xb,Go.eB.set(Sb,o,r,s)),Go.$I.setTranslation(xb,e.p2),Kp.P.addPrimitive(c,xb,Bb)}++p}const f=Kp.P.getMesh(c),g=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*s.sizeFactor);return f.setBoundingSphere(g),f}const jb={...tp.Te,...Pb};function Tb(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(jb),createGeometry:Ib,createLocationIterator:e=>Rg.fromGroup(e),getLoci:Hg,eachLocation:Gg,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor}},e)}const Ab={sizeFactor:Xi.t.Numeric(.2,{min:0,max:10,step:.01}),radialSegments:Xi.t.Numeric(16,{min:2,max:56,step:2},Vi.iy.CustomQualityParamInfo)};Xi.t.getDefaultValues(Ab);function Mb(e,t,n,i,s,r){const o=t.gapElements.length;if(!o)return Jh.e.createEmpty(r);const{sizeFactor:a,radialSegments:l}=s,c=10*l*2*o*2,u=Kp.P.createState(c,c/10,r),d=(0,Go.eB)(),h=(0,Go.eB)(),p={radiusTop:1,radiusBottom:1,topCap:!0,bottomCap:!0,radialSegments:l};let m=0;const f=function(e,t){switch(t.kind){case Gi.Nf.Kind.Atomic:return new zf(e,t);case Gi.Nf.Kind.Spheres:case Gi.Nf.Kind.Gaussians:return new Hf(e,t)}}(n,t);for(;f.hasNext;){const{centerA:e,centerB:n}=f.move();e.element===n.element||(t.conformation.invariantPosition(e.element,d),t.conformation.invariantPosition(n.element,h),p.radiusTop=p.radiusBottom=i.size.size(e)*a,u.currentGroup=m,(0,Df.GH)(u,d,h,.5,10,!1,p),p.radiusTop=p.radiusBottom=i.size.size(n)*a,u.currentGroup=m+1,(0,Df.GH)(u,h,d,.5,10,!1,p)),m+=2}const g=Kp.P.getMesh(u),y=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*s.sizeFactor);return g.setBoundingSphere(y),g}const Lb={...tp.Te,...Ab};function Eb(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(Lb),createGeometry:Mb,createLocationIterator:e=>Og.fromGroup(e,{asSecondary:!0}),getLoci:qg,eachLocation:$g,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.radialSegments!==n.radialSegments}},e)}const Db=(0,Go.eB)(),Nb=(0,Go.eB)(),Fb=(0,Go.eB)(),Rb=(0,Go.eB)(),Ob=(0,Go.eB)(),zb=(0,Go.eB)(),Hb=(0,Go.eB)(),Ub=(0,Go.eB)(),Vb=(0,Go.eB)(),_b=(0,Go.eB)(),Gb=(0,Go.eB)(),qb=(0,Go.eB)(),$b=(0,Go.eB)(),Zb=(0,Go.eB)(),Kb=(0,Go.eB)(),Qb=Go.eB.fromArray,Xb=Go.eB.scale,Wb=Go.eB.add,Yb=Go.eB.sub,Jb=Go.eB.magnitude,ex=Go.eB.negate,tx=Go.eB.copy,nx=Go.eB.cross,ix=Go.eB.set,sx=Ad.Gm.add3,rx=Ad.Gm.add;function ox(e,t,n,i,s,r,o,a,l){const{vertices:c,normals:u,indices:d}=t,h=c.elementCount;if(Qb(Db,i,e),Xb(Hb,Db,o),Xb(zb,Db,a),Qb(Nb,s,e),Xb(Rb,Nb,r),nx(_b,Nb,Db),Qb(Vb,n,e),Wb(qb,Wb(qb,Vb,Rb),zb),Yb($b,Wb($b,Vb,Rb),Hb),Yb(Zb,Yb(Zb,Vb,Rb),Hb),Wb(Kb,Yb(Kb,Vb,Rb),zb),o<a?(sx(c,Kb[0],Kb[1],Kb[2]),sx(c,Zb[0],Zb[1],Zb[2]),sx(c,$b[0],$b[1],$b[2]),sx(c,qb[0],qb[1],qb[2]),tx(Ob,zb)):(sx(c,qb[0],qb[1],qb[2]),sx(c,$b[0],$b[1],$b[2]),sx(c,Zb[0],Zb[1],Zb[2]),sx(c,Kb[0],Kb[1],Kb[2]),tx(Ob,Hb)),l){for(let e=0;e<4;++e)sx(u,-_b[0],-_b[1],-_b[2]);sx(d,h,h+1,h+2),sx(d,h+2,h+3,h)}else{for(let e=0;e<4;++e)sx(u,_b[0],_b[1],_b[2]);sx(d,h+2,h+1,h),sx(d,h,h+3,h+2)}}function ax(e,t,n,i,s,r,o,a,l,c){const{currentGroup:u,vertices:d,normals:h,indices:p,groups:m}=e,f=d.elementCount;let g=0;a>0?(Qb(Db,t,0),Qb(Nb,t,3*s),g=a/Jb(Yb(Fb,Nb,Db))):ix(Ub,0,0,0);for(let y=0;y<=s;++y){const e=r[y],l=o[y],c=0===a?l:a*(1-y/s),u=3*y;Qb(Ob,n,u),Xb(Ob,Ob,c),Qb(Rb,i,u),Xb(Rb,Rb,e),a>0&&(Qb(Db,n,u),Qb(Nb,i,u),Xb(Ub,nx(Ub,Db,Nb),g)),Qb(Vb,t,u),Qb(_b,n,u),Qb(Gb,i,u),Wb(Db,Wb(Db,Vb,Rb),Ob),Wb(Nb,_b,Ub),sx(d,Db[0],Db[1],Db[2]),sx(h,Nb[0],Nb[1],Nb[2]),Wb(Db,Yb(Db,Vb,Rb),Ob),sx(d,Db[0],Db[1],Db[2]),sx(h,Nb[0],Nb[1],Nb[2]),ex(Nb,Gb),sx(d,Db[0],Db[1],Db[2]),sx(h,Nb[0],Nb[1],Nb[2]),Yb(Db,Yb(Db,Vb,Rb),Ob),sx(d,Db[0],Db[1],Db[2]),sx(h,Nb[0],Nb[1],Nb[2]),Wb(Nb,ex(Nb,_b),Ub),sx(d,Db[0],Db[1],Db[2]),sx(h,Nb[0],Nb[1],Nb[2]),Yb(Db,Wb(Db,Vb,Rb),Ob),sx(d,Db[0],Db[1],Db[2]),sx(h,Nb[0],Nb[1],Nb[2]),tx(Nb,Gb),sx(d,Db[0],Db[1],Db[2]),sx(h,Nb[0],Nb[1],Nb[2]),Wb(Db,Wb(Db,Vb,Rb),Ob),sx(d,Db[0],Db[1],Db[2]),sx(h,Nb[0],Nb[1],Nb[2])}for(let y=0;y<s;++y){for(let e=0;e<2;e++)sx(p,f+8*y+2*e,f+8*(y+1)+2*e+1,f+8*y+2*e+1),sx(p,f+8*y+2*e,f+8*(y+1)+2*e,f+8*(y+1)+2*e+1);for(let e=2;e<4;e++)sx(p,f+8*y+2*e,f+8*(y+1)+2*e,f+8*y+2*e+1),sx(p,f+8*(y+1)+2*e,f+8*(y+1)+2*e+1,f+8*y+2*e+1)}if(l){const s=r[0],l=o[0],c=0===a?l:a;ox(0,e,t,n,i,s,c,c,!1)}else if(a>0){const s=r[0],l=o[0];ox(0,e,t,n,i,s,a,-l,!1),ox(0,e,t,n,i,s,-a,l,!1)}if(c&&0===a){const a=r[s],l=o[s];ox(3*s,e,t,n,i,a,l,l,!0)}for(let y=0,v=8*(s+1)+(l?4:a>0?8:0)+(c&&0===a?4:0);y<v;++y)rx(m,u)}const lx=(0,Go.eB)(),cx=(0,Go.eB)(),ux=(0,Go.eB)(),dx=(0,Go.eB)(),hx=(0,Go.eB)(),px=(0,Go.eB)();function mx(e,t,n,i,s){e[0]=t[0]*i+n[0]*s,e[1]=t[1]*i+n[1]*s,e[2]=t[2]*i+n[2]*s}function fx(e,t,n,i,s,r){e[0]=t[0]*s+n[0]*r+i[0],e[1]=t[1]*s+n[1]*r+i[1],e[2]=t[2]*s+n[2]*r+i[2]}const gx=Go.eB.fromArray,yx=Go.eB.normalize,vx=Go.eB.scaleAndAdd,bx=Go.eB.cross,xx=Go.eB.slerp,Sx=Go.eB.dot,Cx=Go.eB.unitX,wx=Ad.Gm.add3,kx=new Map;function Bx(e,t,n,i,s,r,o,a,l,c,u,d=!1){const{currentGroup:h,vertices:p,normals:m,indices:f,groups:g}=e;let y=p.elementCount;const{cos:v,sin:b}=function(e,t){const n=t?1:0,i=(0,Ad.m1)(e,n);if(!kx.has(i)){const t=[],s=[];for(let i=0;i<e;++i){const r=(2*i+n)/e*Math.PI;t[i]=Math.cos(r),s[i]=Math.sin(r)}kx.set(i,{cos:t,sin:s})}return kx.get(i)}(r,"rounded"===u),x=Math.round(r/4),S=3*x,C=d&&s&&(l||c);let w;const k=C&&l&&c;k&&(w=s/2);for(let I=0;I<=s;++I){const e=3*I;gx(hx,n,e),gx(px,i,e),gx(dx,t,e);let c,d=o[I],h=a[I];if(C){const e=k?I<=w:l;c=k?Math.max(Number.EPSILON,Math.sqrt(1-Math.pow((e?w-I:I-w)/w,2))):Math.max(Number.EPSILON,Math.sqrt(1-Math.pow((e?s-I:I)/s,2))),d*=c,h*=c,bx(cx,e?px:hx,e?hx:px),yx(cx,cx)}const f="rounded"===u&&h>d;for(let t=0;t<r;++t){if(f){fx(ux,hx,px,dx,d*v[t],d*b[t]);const e=Sx(px,Cx)<0?t<x||t>=S?h-d:-h+d:t>=x&&t<S?-h+d:h-d;vx(ux,ux,hx,e),t===x||t===x-1?mx(lx,hx,px,0,1):t===S||t===S-1?mx(lx,hx,px,0,-1):mx(lx,hx,px,v[t],b[t])}else fx(ux,hx,px,dx,h*v[t],d*b[t]),mx(lx,hx,px,d*v[t],h*b[t]);yx(lx,lx),wx(p,ux[0],ux[1],ux[2]),C&&xx(lx,cx,lx,c),wx(m,lx[0],lx[1],lx[2])}}const B=Math.round(r/2);for(let I=0;I<s;++I){for(let e=0;e<B;++e)wx(f,y+I*r+(e+1)%r,y+(I+1)*r+(e+1)%r,y+I*r+e),wx(f,y+(I+1)*r+(e+1)%r,y+(I+1)*r+e,y+I*r+e);for(let e=B;e<r;++e)wx(f,y+I*r+(e+1)%r,y+(I+1)*r+e,y+I*r+e),wx(f,y+(I+1)*r+(e+1)%r,y+(I+1)*r+e,y+I*r+(e+1)%r)}if(l){const e=0,s=p.elementCount;gx(hx,n,e),gx(px,i,e),gx(dx,t,e),bx(lx,px,hx),wx(p,dx[0],dx[1],dx[2]),wx(m,lx[0],lx[1],lx[2]);const l=C?0:o[0];let c=C?0:a[0];const d="rounded"===u&&c>l;d&&(c-=l),y=p.elementCount;for(let t=0;t<r;++t)d?(fx(ux,hx,px,dx,l*v[t],l*b[t]),vx(ux,ux,hx,t<x||t>=S?c:-c)):fx(ux,hx,px,dx,c*v[t],l*b[t]),wx(p,ux[0],ux[1],ux[2]),wx(m,lx[0],lx[1],lx[2]),wx(f,y+(t+1)%r,y+t,s)}if(c){const e=3*s,l=p.elementCount;gx(hx,n,e),gx(px,i,e),gx(dx,t,e),bx(lx,hx,px),wx(p,dx[0],dx[1],dx[2]),wx(m,lx[0],lx[1],lx[2]);const c=C?0:o[s];let d=C?0:a[s];const h="rounded"===u&&d>c;h&&(d-=c),y=p.elementCount;for(let t=0;t<r;++t)h?(fx(ux,hx,px,dx,c*v[t],c*b[t]),vx(ux,ux,hx,t<x||t>=S?d:-d)):fx(ux,hx,px,dx,d*v[t],c*b[t]),wx(p,ux[0],ux[1],ux[2]),wx(m,lx[0],lx[1],lx[2]),wx(f,y+t,y+(t+1)%r,l)}const P=(s+1)*r+(l?r+1:0)+(c?r+1:0);Ad.Gm.addRepeat(g,P,h)}const Px=Go.eB.fromArray,Ix=Go.eB.magnitude,jx=Go.eB.sub,Tx=Go.eB.add,Ax=Go.eB.scale,Mx=Go.eB.negate,Lx=Go.eB.copy,Ex=Go.eB.cross,Dx=Ad.Gm.add3,Nx=Ad.Gm.add,Fx=(0,Go.eB)(),Rx=(0,Go.eB)(),Ox=(0,Go.eB)(),zx=(0,Go.eB)(),Hx=(0,Go.eB)(),Ux=(0,Go.eB)(),Vx=(0,Go.eB)(),_x=(0,Go.eB)(),Gx=(0,Go.eB)();function qx(e,t,n,i,s,r,o,a){const{currentGroup:l,vertices:c,normals:u,indices:d,groups:h}=e,p=c.elementCount;let m=0;a>0&&(Px(Fx,t,0),Px(Rx,t,3*s),m=a/Ix(jx(Ox,Rx,Fx)));for(let f=0;f<=s;++f){const e=r[f],l=o[f],d=0===a?l:a*(1-f/s),h=3*f;Px(Hx,n,h),Ax(Hx,Hx,d),Px(zx,i,h),Ax(zx,zx,e),a>0&&(Px(Fx,n,h),Px(Rx,i,h),Ax(Ux,Ex(Ux,Fx,Rx),m)),Px(Vx,t,h),Px(_x,n,h),Px(Gx,i,h),Tx(Fx,Vx,Hx),Mx(Rx,Gx),Dx(c,Fx[0],Fx[1],Fx[2]),Dx(u,Rx[0],Rx[1],Rx[2]),jx(Fx,Vx,Hx),Dx(c,Fx[0],Fx[1],Fx[2]),Dx(u,Rx[0],Rx[1],Rx[2]),Tx(Fx,Vx,Hx),Lx(Rx,Gx),Dx(c,Fx[0],Fx[1],Fx[2]),Dx(u,Rx[0],Rx[1],Rx[2]),jx(Fx,Vx,Hx),Dx(c,Fx[0],Fx[1],Fx[2]),Dx(u,Rx[0],Rx[1],Rx[2])}for(let f=0;f<s;++f)Dx(d,p+4*f,p+4*(f+1)+1,p+4*f+1),Dx(d,p+4*f,p+4*(f+1),p+4*(f+1)+1),Dx(d,p+4*f+2+1,p+4*(f+1)+2+1,p+4*f+2),Dx(d,p+4*f+2,p+4*(f+1)+2+1,p+4*(f+1)+2);for(let f=0,g=4*(s+1);f<g;++f)Nx(h,l)}const $x={sizeFactor:Xi.t.Numeric(.2,{min:0,max:10,step:.01}),aspectRatio:Xi.t.Numeric(5,{min:.1,max:10,step:.1}),arrowFactor:Xi.t.Numeric(1.5,{min:0,max:3,step:.1},{description:"Size factor for sheet arrows"}),tubularHelices:Xi.t.Boolean(!1,{description:"Draw alpha helices as tubes"}),roundCap:Xi.t.Boolean(!1,{description:"Draw round caps on tubular alpha helices"}),helixProfile:Xi.t.Select("elliptical",Xi.t.arrayToOptions(["elliptical","rounded","square"]),{description:"Protein helix trace profile"}),nucleicProfile:Xi.t.Select("square",Xi.t.arrayToOptions(["elliptical","rounded","square"]),{description:"Nucleic strand trace profile"}),detail:Xi.t.Numeric(0,{min:0,max:3,step:1},Vi.iy.CustomQualityParamInfo),linearSegments:Xi.t.Numeric(8,{min:1,max:48,step:1},Vi.iy.CustomQualityParamInfo),radialSegments:Xi.t.Numeric(16,{min:2,max:56,step:2},Vi.iy.CustomQualityParamInfo)},Zx=(Xi.t.getDefaultValues($x),(0,Go.eB)());function Kx(e,t,n,i,s,r){const o=t.polymerElements.length;if(!o)return Jh.e.createEmpty(r);const{sizeFactor:a,detail:l,linearSegments:c,radialSegments:u,aspectRatio:d,arrowFactor:h,tubularHelices:p,roundCap:m,helixProfile:f,nucleicProfile:g}=s,y=c*u*o+(u+1)*o*2,v=Kp.P.createState(y,y/10,r),b=Gi.Nf.isCoarse(t),x=yg(c),{curvePoints:S,normalVectors:C,binormalVectors:w,widthValues:k,heightValues:B}=x;let P=0;const I=Kf(t,n,{ignoreSecondaryStructure:!1,useHelixOrientation:p});for(;I.hasNext;){const e=I.move();v.currentGroup=P;const t=(0,np.OV)(e.moleculeType),n=np.gG.is(e.secStrucType,np.gG.Flag.Beta),s=np.gG.is(e.secStrucType,np.gG.Flag.Helix),r=t?Dg:Eg;vg(x,e,s&&!p?.9:.5,r);let o=i.size.size(e.centerPrev)*a,y=i.size.size(e.center)*a,j=i.size.size(e.centerNext)*a;b&&(o*=d/2,y*=d/2,j*=d/2);const T=e.secStrucFirst||e.coarseBackboneFirst||e.first,A=e.secStrucLast||e.coarseBackboneLast||e.last,M=s&&p&&m;let L=c;if(e.initial){L=Math.max(Math.round(c*r),1);const t=c-L;S.copyWithin(0,3*t),w.copyWithin(0,3*t),C.copyWithin(0,3*t),Go.eB.fromArray(Zx,S,3),Go.eB.normalize(Zx,Go.eB.sub(Zx,e.p2,Zx)),Go.eB.scaleAndAdd(Zx,e.p2,Zx,2*y),Go.eB.toArray(Zx,S,0)}else e.final&&(L=Math.max(Math.round(c*(1-r)),1),Go.eB.fromArray(Zx,S,3*L-3),Go.eB.normalize(Zx,Go.eB.sub(Zx,e.p2,Zx)),Go.eB.scaleAndAdd(Zx,e.p2,Zx,2*y),Go.eB.toArray(Zx,S,3*L));if(!0===e.initial&&!0===e.final)(0,Qp.X)(v,e.p2,2*y,l);else if(n){const t=o*d,n=y*d,i=j*d,s=e.secStrucLast?n*h:0;Lg(x,o,y,j,t,n,i,r),2===u?qx(v,S,C,w,L,k,B,s):ax(v,S,C,w,L,k,B,s,T,A)}else{let e,n,i;s?p?(o*=1.5*d,y*=1.5*d,j*=1.5*d,e=o,n=y,i=j):(e=o*d,n=y*d,i=j*d):t?(e=o*d,n=y*d,i=j*d):(e=o,n=y,i=j),Lg(x,o,y,j,e,n,i,r);const[a,l]=t?[w,C]:[C,w];if(t)for(let t=0,s=a.length;t<s;t++)a[t]*=-1;const c=t?g:f;2===u?t?qx(v,S,a,l,L,B,k,0):qx(v,S,a,l,L,k,B,0):4===u?ax(v,S,a,l,L,k,B,0,T,A):n===y?Bx(v,S,a,l,L,u,k,B,T,A,"elliptical",M):"square"===c?ax(v,S,a,l,L,k,B,0,T,A):Bx(v,S,a,l,L,u,k,B,T,A,c)}++P}const j=Kp.P.getMesh(v),T=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*s.sizeFactor);return j.setBoundingSphere(T),j}const Qx={...tp.Te,...$x};function Xx(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(Qx),createGeometry:Kx,createLocationIterator:e=>Rg.fromGroup(e,{asSecondary:!0}),getLoci:Hg,eachLocation:Gg,setUpdateState:(e,t,n,i,s,r,o)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.tubularHelices!==n.tubularHelices||t.roundCap!==n.roundCap||t.detail!==n.detail||t.linearSegments!==n.linearSegments||t.radialSegments!==n.radialSegments||t.aspectRatio!==n.aspectRatio||t.arrowFactor!==n.arrowFactor||t.helixProfile!==n.helixProfile||t.nucleicProfile!==n.nucleicProfile;const a=Uf.v.get(r.structure).version;e.info.secondaryStructureHash!==a&&(void 0!==e.info.secondaryStructureHash&&(e.createGeometry=!0),e.info.secondaryStructureHash=a)},initUpdateState:(e,t,n,i)=>{const s=Uf.v.get(i.structure).version;e.info.secondaryStructureHash=s}},e)}const Wx={"polymer-trace":(e,t)=>(0,mm.T)("Polymer trace mesh",e,t,Xx),"polymer-gap":(e,t)=>(0,mm.T)("Polymer gap cylinder",e,t,Eb),"nucleotide-block":(e,t)=>(0,mm.T)("Nucleotide block mesh",e,t,Cy),"nucleotide-ring":(e,t)=>(0,mm.T)("Nucleotide ring mesh",e,t,Zy),"nucleotide-atomic-ring-fill":(e,t)=>(0,mm.T)("Nucleotide atomic ring fill",e,t,jv),"nucleotide-atomic-bond":(e,t)=>(0,mm.T)("Nucleotide atomic bond",e,t,$v),"nucleotide-atomic-element":(e,t)=>(0,mm.T)("Nucleotide atomic element",e,t,db),"direction-wedge":(e,t)=>(0,mm.T)("Polymer direction wedge",e,t,Tb)},Yx={...Qx,...Lb,...Sy,...$y,...qv,...ub,...Iv,...jb,sizeFactor:Xi.t.Numeric(.2,{min:0,max:10,step:.01}),visuals:Xi.t.MultiSelect(["polymer-trace","polymer-gap","nucleotide-ring","nucleotide-atomic-ring-fill","nucleotide-atomic-bond","nucleotide-atomic-element"],Xi.t.objectToOptions(Wx)),bumpFrequency:Xi.t.Numeric(2,{min:0,max:10,step:.1},Vi.iy.ShadingCategory),density:Xi.t.Numeric(.1,{min:0,max:1,step:.01},Vi.iy.ShadingCategory),colorMode:Xi.t.Select("default",Xi.t.arrayToOptions(["default","interpolate"]),{...Vi.iy.ShadingCategory,isHidden:!0})};const Jx=(0,gm.GT)({name:"cartoon",label:"Cartoon",description:"Displays ribbons, planks, tubes smoothly following the trace atoms of polymers.",factory:function(e,t){return Er.YL.createMulti("Cartoon",e,t,gm.J1,Wx)},getParams:function(e,t){const n=Xi.t.clone(Yx);let i=!1,s=!1;return t.units.forEach(e=>{!i&&Gi.Nf.isAtomic(e)&&e.nucleotideElements.length&&(i=!0),!s&&e.gapElements.length&&(s=!0)}),n.visuals.defaultValue=["polymer-trace"],i&&n.visuals.defaultValue.push("nucleotide-ring"),s&&n.visuals.defaultValue.push("polymer-gap"),n},defaultValues:Xi.t.getDefaultValues(Yx),defaultColorTheme:{name:"chain-id"},defaultSizeTheme:{name:"uniform"},isApplicable:e=>e.polymerResidueCount>0,ensureCustomProperties:{attach:async(e,t)=>{await Uf.v.attach(e,t,void 0,!0);for(const n of t.models)await $f.attach(e,n,void 0,!0)},detach:e=>{Uf.v.ref(e,!1);for(const t of e.models)$f.ref(t,!1)}}});var eS=n(45438),tS=n(83448),nS=n(35695);const iS=Go.eB.add;function sS(e,t,n,i,s,r){const{child:o}=n,a=null==o?void 0:o.unitMap.get(t.id);if(o&&!a)return Jh.e.createEmpty(r);const{detail:l,sizeFactor:c}=s,{elements:u,model:d}=t,h=u.length,p=h*(0,Zp.J)(l),m=Kp.P.createState(p,p/2,r),f=tS._.Provider.get(d);if(!f)return Jh.e.createEmpty(r);const g=(0,Go.eB)(),y=(0,Go.U)(),v=(0,Go.eB)(),b=(0,Go.eB)(),x=(0,Go.eB)(),{elementToAnsiotrop:S,data:C}=f,{U:w}=C,k=C._schema.U.space,B=t.conformation,P=Gi.iZ.Location.create(n);P.unit=t;const I=Jp(n,t,s),j=(0,Go.eB)();let T=0;for(let E=0;E<h;E++){const e=u[E],t=S[e];if(-1!==t&&(!I||!I(u[E]))){P.element=e,B.invariantPosition(e,g),iS(j,j,g),T+=1,m.currentGroup=E,Go.qY.toMat3(y,k,w.value(t)),Go.U.symmtricFromLower(y,y),Go.U.symmetricEigenvalues(v,y),Go.U.eigenvector(b,y,v[1]),Go.U.eigenvector(x,y,v[2]);for(let e=0;e<3;++e)v[e]=1.5958*c*Math.sqrt(Math.abs(v[e]));(0,nS.T)(v[0],v[1],Go.p8)&&(0,nS.T)(v[1],v[2],Go.p8)?(0,Qp.X)(m,g,v[0],l):(0,eS.P)(m,g,x,b,v,l)}}const A=Kp.P.getMesh(m);if(0===T)return A;let M;Go.eB.scale(j,j,1/T);const L=r?Dd.f8.clone(r.boundingSphere):void 0;return M=L&&Go.eB.distance(j,L.center)/L.radius<.1?L:Dd.f8.expand((0,Dd.f8)(),(null!=a?a:t).boundary.sphere,1*c*2),A.setBoundingSphere(M),A}const rS={...tp.Te,sizeFactor:Xi.t.Numeric(1,{min:0,max:10,step:.1}),detail:Xi.t.Numeric(0,{min:0,max:3,step:1},Vi.iy.CustomQualityParamInfo),ignoreHydrogens:Xi.t.Boolean(!1),ignoreHydrogensVariant:Xi.t.Select("all",Xi.t.arrayToOptions(["all","non-polar"])),traceOnly:Xi.t.Boolean(!1)};function oS(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(rS),createGeometry:sS,createLocationIterator:lm.fromGroup,getLoci:im,eachLocation:nm,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.detail!==n.detail||t.ignoreHydrogens!==n.ignoreHydrogens}},e)}function aS(e,t,n,i,s){const{child:r}=t,{detail:o,sizeFactor:a}=i,{getSerialIndex:l}=t.serialMapping,c=t.elementCount*(0,Zp.J)(o),u=Kp.P.createState(c,c/2,s),d=(0,Go.eB)(),h=(0,Go.U)(),p=(0,Go.eB)(),m=(0,Go.eB)(),f=(0,Go.eB)(),g=(0,Go.eB)();let y=0;for(const S of t.units){const e=null==r?void 0:r.unitMap.get(S.id);if(r&&!e)return Jh.e.createEmpty(s);const{elements:n,model:c}=S,v=n.length,b=tS._.Provider.get(c);if(!b)return Jh.e.createEmpty(s);const x=Jp(t,S,i),{elementToAnsiotrop:C,data:w}=b,{U:k}=w,B=w._schema.U.space,P=S.conformation,I=Gi.iZ.Location.create(t);I.unit=S;for(let t=0;t<v;t++){const e=n[t],i=C[e];if(-1!==i&&(!x||!x(n[t]))){I.element=e,P.position(e,d),iS(g,g,d),y+=1,u.currentGroup=l(S,n[t]),Go.qY.toMat3(h,B,k.value(i)),Go.U.symmtricFromLower(h,h),Go.U.symmetricEigenvalues(p,h),Go.U.eigenvector(m,h,p[1]),Go.U.eigenvector(f,h,p[2]);for(let e=0;e<3;++e)p[e]=1.5958*a*Math.sqrt(Math.abs(p[e]));(0,nS.T)(p[0],p[1],Go.p8)&&(0,nS.T)(p[1],p[2],Go.p8)?(0,Qp.X)(u,d,p[0],o):(0,eS.P)(u,d,f,m,p,o)}}}const v=Kp.P.getMesh(u);if(0===y)return v;let b;Go.eB.scale(g,g,1/y);const x=s?Dd.f8.clone(s.boundingSphere):void 0;return b=x&&Go.eB.distance(g,x.center)/x.radius<1?x:Dd.f8.expand((0,Dd.f8)(),(null!=r?r:t).boundary.sphere,1*a*2),v.setBoundingSphere(b),v}const lS={...Pp.EN,sizeFactor:Xi.t.Numeric(1,{min:0,max:10,step:.1}),detail:Xi.t.Numeric(0,{min:0,max:3,step:1},Vi.iy.CustomQualityParamInfo),ignoreHydrogens:Xi.t.Boolean(!1),ignoreHydrogensVariant:Xi.t.Select("all",Xi.t.arrayToOptions(["all","non-polar"])),traceOnly:Xi.t.Boolean(!1)};function cS(e){return(0,Pp.wA)({defaultProps:Xi.t.getDefaultValues(lS),createGeometry:aS,createLocationIterator:lm.fromStructure,getLoci:am,eachLocation:om,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.detail!==n.detail||t.ignoreHydrogens!==n.ignoreHydrogens}},e)}const uS={"ellipsoid-mesh":(e,t)=>(0,gm.TP)("Ellipsoid Mesh",e,t,oS),"intra-bond":(e,t)=>(0,gm.TP)("Intra-unit bond cylinder",e,t,Lp),"inter-bond":(e,t)=>(0,gm.Kp)("Inter-unit bond cylinder",e,t,$p),"structure-ellipsoid-mesh":(e,t)=>(0,gm.Kp)("Structure Ellipsoid Mesh",e,t,cS),"structure-intra-bond":(e,t)=>(0,gm.Kp)("Structure intra-unit bond cylinder",e,t,Rp)},dS={...rS,...Mp,...qp,includeParent:Xi.t.Boolean(!1),adjustCylinderLength:Xi.t.Boolean(!1,{isHidden:!0}),unitKinds:(0,ym.R8)(["atomic"]),sizeFactor:Xi.t.Numeric(1,{min:.01,max:10,step:.01}),sizeAspectRatio:Xi.t.Numeric(.1,{min:.01,max:3,step:.01}),linkCap:Xi.t.Boolean(!0),visuals:Xi.t.MultiSelect(["ellipsoid-mesh","intra-bond","inter-bond"],Xi.t.objectToOptions(uS)),bumpFrequency:Xi.t.Numeric(0,{min:0,max:10,step:.1},Vi.iy.ShadingCategory)};const hS=(0,gm.GT)({name:"ellipsoid",label:"Ellipsoid",description:"Displays anisotropic displacement ellipsoids of atomic elements plus bonds as cylinders.",factory:function(e,t){return Er.YL.createMulti("Ellipsoid",e,t,gm.J1,uS)},getParams:function(e,t){let n=dS;return Gi.Structure.getSize(t)>=Gi.Structure.Size.Huge?(n=Xi.t.clone(n),n.visuals.defaultValue=["ellipsoid-mesh","intra-bond"]):t.unitSymmetryGroups.length>5e3&&(n=Xi.t.clone(n),n.visuals.defaultValue=["structure-ellipsoid-mesh","structure-intra-bond"]),n},defaultValues:Xi.t.getDefaultValues(dS),defaultColorTheme:{name:"element-symbol"},defaultSizeTheme:{name:"uniform"},isApplicable:e=>e.elementCount>0&&e.models.some(e=>tS._.Provider.isApplicable(e)),getData:(e,t)=>t.includeParent?e.asParent():e,mustRecreate:(e,t)=>e.includeParent!==t.includeParent});var pS=n(93902),mS=n(99984),fS=n(27601),gS=n(13226),yS=n(94538);const vS="\nprecision highp float;\n\nattribute vec3 aPosition;\nattribute float aRadius;\n\nvarying vec3 vPosition;\nvarying float vRadiusSqInv;\n\n#if defined(dCalcType_groupId)\n    attribute float aGroup;\n    varying float vGroup;\n#endif\n\nuniform vec3 uBboxSize;\nuniform vec3 uBboxMin;\nuniform float uResolution;\n\nvoid main() {\n    vRadiusSqInv = 1.0 / (aRadius * aRadius);\n    #if defined(dCalcType_groupId)\n        vGroup = aGroup;\n    #endif\n    gl_PointSize = ceil(((aRadius * 3.0) / uResolution) + uResolution);\n    vPosition = (aPosition - uBboxMin) / uResolution;\n    gl_Position = vec4(((aPosition - uBboxMin) / uBboxSize) * 2.0 - 1.0, 1.0);\n}\n",bS="\nprecision highp float;\n\nvarying vec3 vPosition;\nvarying float vRadiusSqInv;\n#if defined(dCalcType_groupId)\n    #if defined(dGridTexType_2d)\n        precision highp sampler2D;\n        uniform sampler2D tMinDistanceTex;\n        uniform vec3 uGridTexDim;\n    #elif defined(dGridTexType_3d)\n        precision highp sampler3D;\n        uniform sampler3D tMinDistanceTex;\n    #endif\n    varying float vGroup;\n#endif\n\n#include common\n\nuniform vec3 uGridDim;\nuniform vec2 uGridTexScale;\nuniform float uCurrentSlice;\nuniform float uCurrentX;\nuniform float uCurrentY;\nuniform float uAlpha;\nuniform float uResolution;\nuniform float uRadiusFactorInv;\n\nvoid main() {\n    vec2 v = gl_FragCoord.xy - vec2(uCurrentX, uCurrentY) - 0.5;\n    vec3 fragPos = vec3(v.x, v.y, uCurrentSlice);\n    float dist = distance(fragPos, vPosition) * uResolution;\n\n    #if defined(dCalcType_density)\n        float density = exp(-uAlpha * ((dist * dist) * vRadiusSqInv));\n        gl_FragColor.a = density * uRadiusFactorInv;\n    #elif defined(dCalcType_minDistance)\n        gl_FragColor.a = 1.0 - dist * uRadiusFactorInv;\n    #elif defined(dCalcType_groupId)\n        #if defined(dGridTexType_2d)\n            float minDistance = 1.0 - texture2D(tMinDistanceTex, (gl_FragCoord.xy) / (uGridTexDim.xy / uGridTexScale)).a;\n        #elif defined(dGridTexType_3d)\n            float minDistance = 1.0 - texelFetch(tMinDistanceTex, ivec3(gl_FragCoord.xy, uCurrentSlice), 0).a;\n        #endif\n        if (dist * uRadiusFactorInv > minDistance + uResolution * 0.05)\n            discard;\n        gl_FragColor.rgb = packIntToRGB(vGroup);\n    #endif\n}\n",xS={drawCount:(0,yS.Xb)("number"),instanceCount:(0,yS.Xb)("number"),aRadius:(0,yS.Yz)("float32",1,0),aPosition:(0,yS.Yz)("float32",3,0),aGroup:(0,yS.Yz)("float32",1,0),uCurrentSlice:(0,yS.w5)("f"),uCurrentX:(0,yS.w5)("f"),uCurrentY:(0,yS.w5)("f"),uBboxMin:(0,yS.w5)("v3","material"),uBboxSize:(0,yS.w5)("v3","material"),uGridDim:(0,yS.w5)("v3","material"),uGridTexDim:(0,yS.w5)("v3","material"),uGridTexScale:(0,yS.w5)("v2","material"),uAlpha:(0,yS.w5)("f","material"),uResolution:(0,yS.w5)("f","material"),uRadiusFactorInv:(0,yS.w5)("f","material"),tMinDistanceTex:(0,yS.$G)("texture","rgba","float","nearest","material"),dGridTexType:(0,yS.$F)("string",["2d","3d"]),dCalcType:(0,yS.$F)("string",["density","minDistance","groupId"])},SS="gaussian-density";function CS(e){return e.namedFramebuffers[SS]||(e.namedFramebuffers[SS]=e.resources.framebuffer()),e.namedFramebuffers[SS]}function wS(e,t,n,i,s,r){const o=`${SS}-${e}`;return t.namedTextures[o]||(t.namedTextures[o]=t.resources.texture(n,i,s,r)),t.namedTextures[o]}function kS(e,t,n,i,s,r){return e.isWebGL2?function(e,t,n,i,s,r){Md.g$&&e.timer.mark("GaussianDensityTexture3d");const o=function(e,t,n,i,s,r){const{gl:o,resources:l,state:c,extensions:{colorBufferFloat:u,textureFloat:d,colorBufferHalfFloat:h,textureHalfFloat:p}}=e,{smoothness:m,resolution:f}=s,{drawCount:g,positions:y,radii:v,groups:b,scale:x,expandedBox:S,dim:C,maxRadius:w}=TS(t,n,i,s),[k,B,P]=C,I=wS("min-dist-3d",e,"volume-uint8","rgba","ubyte","nearest");I.define(k,B,P);const j=Go.ZY.create(1,1),T=2*w,A=AS(e,g,y,v,b,I,S,C,C,j,m,f,T),{uCurrentSlice:M}=A.values,L=CS(e);L.bind(),MS(e),c.viewport(0,0,k,B),c.scissor(0,0,k,B),r||(r=h&&p?l.texture("volume-float16","rgba","fp16","linear"):u&&d?l.texture("volume-float32","rgba","float","linear"):l.texture("volume-uint8","rgba","ubyte","linear"));function E(e,t){c.currentRenderItemId=-1;for(let n=0;n<P;++n)a.IQ.update(M,n),e.attachFramebuffer(L,0,n),t&&o.clear(o.COLOR_BUFFER_BIT),A.render();o.flush()}return r.define(k,B,P),ES(e,A),E(r,!0),LS(e,A),E(I,!0),DS(e,A),E(r,!1),{texture:r,scale:x,bbox:S,gridDim:C,gridTexDim:C,gridDataDim:C,gridTexScale:j,radiusFactor:T,resolution:f,maxRadius:w}}(e,t,n,i,s,r);Md.g$&&e.timer.markEnd("GaussianDensityTexture3d");return PS(o)}(e,t,n,i,s,r):BS(e,t,n,i,!1,s,r)}function BS(e,t,n,i,s,r,o){Md.g$&&e.timer.mark("GaussianDensityTexture2d");const a=jS(e,t,n,i,s,r,o);return Md.g$&&e.timer.markEnd("GaussianDensityTexture2d"),PS(a)}function PS({texture:e,scale:t,bbox:n,gridDim:i,gridTexDim:s,gridDataDim:r,gridTexScale:o,radiusFactor:a,resolution:l,maxRadius:c}){return{transform:IS(t,n),texture:e,bbox:n,gridDim:i,gridTexDim:s,gridDataDim:r,gridTexScale:o,radiusFactor:a,resolution:l,maxRadius:c}}function IS(e,t){const n=Go.$I.identity();return Go.$I.fromScaling(n,e),Go.$I.setTranslation(n,t.min),n}function jS(e,t,n,i,s,r,o){const{gl:l,resources:c,state:u,extensions:{colorBufferFloat:d,textureFloat:h,colorBufferHalfFloat:p,textureHalfFloat:m,blendMinMax:f}}=e,{smoothness:g,resolution:y}=r,{drawCount:v,positions:b,radii:x,groups:S,scale:C,expandedBox:w,dim:k,maxRadius:B}=TS(t,n,i,r),[P,I,j]=k,{texDimX:T,texDimY:A,texCols:M,powerOfTwoSize:L}=function(e){const t=e[0]*e[1]*e[2],n=Math.sqrt(t),i=Math.pow(2,Math.ceil(Math.log(n)/Math.log(2)));let s=0,r=e[1],o=1,a=e[2];i<e[0]*e[2]?(a=Math.floor(i/e[0]),o=Math.ceil(e[2]/a),s=a*e[0],r*=o):s=e[0]*e[2];return{texDimX:s,texDimY:r,texRows:o,texCols:a,powerOfTwoSize:r<i?i:2*i}}(k),E=Go.eB.create(T,A,0),D=Go.ZY.create(T/L,A/L),N=2*B,F=s?L:T,R=s?L:A,O=wS("min-dist-2d",e,"image-uint8","rgba","ubyte","nearest");O.define(F,R);const z=AS(e,v,b,x,S,O,w,k,E,D,g,y,N),{uCurrentSlice:H,uCurrentX:U,uCurrentY:V}=z.values,_=CS(e);function G(e,t){u.currentRenderItemId=-1,e.attachFramebuffer(_,0),t&&(u.viewport(0,0,F,R),u.scissor(0,0,F,R),l.clear(l.COLOR_BUFFER_BIT)),a.IQ.update(V,0);let n=0,i=0,s=0;for(let r=0;r<j;++r)n>=M&&(n-=M,i+=I,s=0,a.IQ.update(V,i)),a.IQ.update(U,s),a.IQ.update(H,r),u.viewport(s,i,P,I),u.scissor(s,i,P,I),z.render(),++n,s+=P;l.flush()}return _.bind(),MS(e),o||(o=p&&m?c.texture("image-float16","rgba","fp16","linear"):d&&h?c.texture("image-float32","rgba","float","linear"):c.texture("image-uint8","rgba","ubyte","linear")),o.define(F,R),ES(e,z),G(o,!0),f&&(LS(e,z),G(O,!0),DS(e,z),G(o,!1)),{texture:o,scale:C,bbox:w,gridDim:k,gridTexDim:E,gridDataDim:k,gridTexScale:D,radiusFactor:N,resolution:y,maxRadius:B}}function TS(e,t,n,i){const{resolution:s,radiusOffset:r}=i,o=1/s,{indices:a,x:l,y:c,z:u,id:d}=e,h=ho.CD.size(a),p=new Float32Array(3*h),m=new Float32Array(h),f=new Float32Array(h);let g=0;for(let S=0;S<h;++S){const e=ho.CD.getAt(a,S);p[3*S]=l[e],p[3*S+1]=c[e],p[3*S+2]=u[e];const t=n(e)+r;g<t&&(g=t),m[S]=t,f[S]=d?d[S]:S}const y=2*g+4*s,v=Dd.DJ.expand((0,Dd.DJ)(),t,Go.eB.create(y,y,y)),b=Dd.DJ.scale((0,Dd.DJ)(),v,o),x=Dd.DJ.size((0,Go.eB)(),b);Go.eB.ceil(x,x);return{drawCount:h,positions:p,radii:m,groups:f,scale:Go.eB.create(s,s,s),expandedBox:v,dim:x,maxRadius:g}}function AS(e,t,n,i,s,r,o,l,c,u,d,h,p){if(e.namedComputeRenderables[SS]){const m=Go.eB.sub((0,Go.eB)(),o.max,o.min),f=e.namedComputeRenderables[SS].values;a.IQ.updateIfChanged(f.drawCount,t),a.IQ.updateIfChanged(f.instanceCount,1),a.IQ.update(f.aRadius,i),a.IQ.update(f.aPosition,n),a.IQ.update(f.aGroup,s),a.IQ.updateIfChanged(f.uCurrentSlice,0),a.IQ.updateIfChanged(f.uCurrentX,0),a.IQ.updateIfChanged(f.uCurrentY,0),a.IQ.update(f.uBboxMin,o.min),a.IQ.update(f.uBboxSize,m),a.IQ.update(f.uGridDim,l),a.IQ.update(f.uGridTexDim,c),a.IQ.update(f.uGridTexScale,u),a.IQ.updateIfChanged(f.uAlpha,d),a.IQ.updateIfChanged(f.uResolution,h),a.IQ.updateIfChanged(f.uRadiusFactorInv,1/p),a.IQ.update(f.tMinDistanceTex,r),a.IQ.updateIfChanged(f.dGridTexType,r.getDepth()>0?"3d":"2d"),a.IQ.updateIfChanged(f.dCalcType,"density"),e.namedComputeRenderables[SS].update()}else e.namedComputeRenderables[SS]=function(e,t,n,i,s,r,o,l,c,u,d,h,p){const m=Go.eB.sub((0,Go.eB)(),o.max,o.min),f={drawCount:a.IQ.create(t),instanceCount:a.IQ.create(1),aRadius:a.IQ.create(i),aPosition:a.IQ.create(n),aGroup:a.IQ.create(s),uCurrentSlice:a.IQ.create(0),uCurrentX:a.IQ.create(0),uCurrentY:a.IQ.create(0),uBboxMin:a.IQ.create(o.min),uBboxSize:a.IQ.create(m),uGridDim:a.IQ.create(l),uGridTexDim:a.IQ.create(c),uGridTexScale:a.IQ.create(u),uAlpha:a.IQ.create(d),uResolution:a.IQ.create(h),uRadiusFactorInv:a.IQ.create(1/p),tMinDistanceTex:a.IQ.create(r),dGridTexType:a.IQ.create(r.getDepth()>0?"3d":"2d"),dCalcType:a.IQ.create("density")},g={...xS},y=(0,fS.NG)(SS,vS,bS),v=(0,gS.$h)(e,"points",y,g,f);return(0,pS._)(v,f)}(e,t,n,i,s,r,o,l,c,u,d,h,p);return e.namedComputeRenderables[SS]}function MS(e){const{gl:t,state:n}=e;n.disable(t.CULL_FACE),n.enable(t.BLEND),n.disable(t.DEPTH_TEST),n.enable(t.SCISSOR_TEST),n.depthMask(!1),n.clearColor(0,0,0,0)}function LS(e,t){const{gl:n,state:i}=e;if(a.IQ.update(t.values.dCalcType,"minDistance"),t.update(),i.colorMask(!1,!1,!1,!0),i.blendFunc(n.ONE,n.ONE),!e.extensions.blendMinMax)throw new Error("GPU gaussian surface calculation requires EXT_blend_minmax");i.blendEquation(e.extensions.blendMinMax.MAX)}function ES(e,t){const{gl:n,state:i}=e;a.IQ.update(t.values.dCalcType,"density"),t.update(),i.colorMask(!1,!1,!1,!0),i.blendFunc(n.ONE,n.ONE),i.blendEquation(n.FUNC_ADD)}function DS(e,t){const{gl:n,state:i}=e;a.IQ.update(t.values.dCalcType,"groupId"),t.update(),i.colorMask(!0,!0,!0,!1),i.blendFunc(n.ONE,n.ZERO),i.blendEquation(n.FUNC_ADD)}var NS=n(64213);async function FS(e,t,n,i,s){const{resolution:r,radiusOffset:o,smoothness:a}=s,l=1/r,{indices:c,x:u,y:d,z:h,id:p}=t,m=ho.CD.size(c),f=new Float32Array(m);let g=0;for(let H=0;H<m;++H){const e=i(ho.CD.getAt(c,H))+o;g<e&&(g=e),f[H]=e}const y=2*g+r,v=Dd.DJ.expand((0,Dd.DJ)(),n,Go.eB.create(y,y,y)),b=v.min,x=Dd.DJ.scale((0,Dd.DJ)(),v,l),S=Dd.DJ.size((0,Go.eB)(),x);Go.eB.ceil(S,S);const C=Go.qY.Space(S,[0,1,2],Float32Array),w=C.create(),k=Go.qY.create(C,w),B=C.create();B.fill(-1);const P=Go.qY.create(C,B),[I,j,T]=S,A=T,M=A*j,L=(0,Dd.oI)(S[0],b[0],r),E=(0,Dd.oI)(S[1],b[1],r),D=(0,Dd.oI)(S[2],b[2],r),N=C.create(),F=a,R=Math.ceil(1e5/(Math.pow(Math.pow(g,3),3)*l));function O(e,t){for(let n=e;n<t;++n){const e=ho.CD.getAt(c,n),t=u[e],i=d[e],s=h[e],r=f[n],o=1/(r*r),a=2*r,m=a*a,g=Math.ceil(a*l),y=Math.floor(l*(t-b[0])),v=Math.floor(l*(i-b[1])),x=Math.floor(l*(s-b[2])),S=Math.max(0,y-g),C=Math.max(0,v-g),k=Math.max(0,x-g),P=Math.min(I,y+g+2),R=Math.min(j,v+g+2),O=Math.min(T,x+g+2);for(let l=S;l<P;++l){const e=L[l]-t,r=l*M;for(let t=C;t<R;++t){const a=E[t]-i,l=e*e+a*a,c=t*A+r;for(let e=k;e<O;++e){const t=D[e]-s,i=l+t*t;if(i<=m){const t=(0,NS.RL)(i*o*-F),s=e+c;w[s]+=t,t>N[s]&&(N[s]=t,B[s]=p?p[n]:n)}}}}}}await async function(){for(let t=0;t<m;t+=R)O(t,Math.min(t+R,m)),e.shouldUpdate&&await e.update({message:"filling density grid",current:t,max:m})}();const z=Go.$I.identity();return Go.$I.fromScaling(z,Go.eB.create(r,r,r)),Go.$I.setTranslation(z,v.min),{field:k,idField:P,transform:z,radiusFactor:1,resolution:r,maxRadius:g}}const RS={resolution:Xi.t.Numeric(1,{min:.1,max:20,step:.1},{description:"Grid resolution/cell spacing.",...Vi.iy.CustomQualityParamInfo}),radiusOffset:Xi.t.Numeric(0,{min:0,max:10,step:.1},{description:"Extra/offset radius added to the atoms/coarse elements for gaussian calculation. Useful to create coarse, low resolution surfaces."}),smoothness:Xi.t.Numeric(1.5,{min:.5,max:2.5,step:.1},{description:"Smoothness of the gausian surface, lower is smoother."}),...op.$J};Xi.t.getDefaultValues(RS);function OS(e,t){const n=e.maxTextureSize/3;return n*n/Math.max(1,t?t.units.length/16:1)}function zS(e,t,n,i){const{position:s,boundary:r,radius:o}=(0,op.LT)(e,t,n,i),a=(0,op.FC)(r.box,i);return Zi.YZ.create("Gaussian Density",async e=>await FS(e,s,r.box,o,a))}var HS=n(79642),US=n(2534),VS=n(66630),_S=n(15815),GS=n(47831),qS=n(21087);const $S={...RS,...Vi.uE,ignoreHydrogens:Xi.t.Boolean(!1),ignoreHydrogensVariant:Xi.t.Select("all",Xi.t.arrayToOptions(["all","non-polar"])),tryUseGpu:Xi.t.Boolean(!0),includeParent:Xi.t.Boolean(!1,{isHidden:!0})},ZS={...tp.Te,...tp.ii,...$S},KS={...Pp.EN,...Pp.Hj,...$S};function QS(e){return e.extensions.colorBufferFloat&&e.extensions.textureFloat&&e.extensions.textureFloatLinear&&e.extensions.blendMinMax&&e.extensions.drawBuffers}function XS(e,t,n){if(t.resolution>1)return!1;const i=n.maxTextureSize/3,{areaCells:s,maxAreaCells:r}=(0,op.Dt)(e.boundary.box,t.resolution,i*i);return s<r}function WS(e,t,n,i){return n.tryUseGpu&&i&&QS(i)&&XS(t,n,i)?function(e){return(0,tp.O$)({defaultProps:Xi.t.getDefaultValues(ZS),createGeometry:nC,createLocationIterator:lm.fromGroup,getLoci:im,eachLocation:nm,setUpdateState:(e,t,n)=>{t.resolution!==n.resolution&&(e.createGeometry=!0),t.radiusOffset!==n.radiusOffset&&(e.createGeometry=!0),t.smoothness!==n.smoothness&&(e.createGeometry=!0),t.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),t.traceOnly!==n.traceOnly&&(e.createGeometry=!0),t.includeParent!==n.includeParent&&(e.createGeometry=!0),t.smoothColors.name!==n.smoothColors.name?e.updateColor=!0:"on"===t.smoothColors.name&&"on"===n.smoothColors.name&&(t.smoothColors.params.resolutionFactor!==n.smoothColors.params.resolutionFactor&&(e.updateColor=!0),t.smoothColors.params.sampleStride!==n.smoothColors.params.sampleStride&&(e.updateColor=!0))},mustRecreate:(e,t,n)=>!t.tryUseGpu||!n||!XS(e.structure,t,n),processValues:(e,t,n,i,s)=>{const{resolution:r,colorTexture:o}=t.meta,a=(0,Vi.Y0)(n.smoothColors,i.color.preferSmoothing,r);a&&s&&((0,GS._i)(e,a.resolution,a.stride,s,o),t.meta.colorTexture=e.tColorGrid.ref.value)},dispose:e=>{var t;e.vertexTexture.ref.value.destroy(),e.groupTexture.ref.value.destroy(),e.normalTexture.ref.value.destroy(),e.doubleBuffer.destroy(),null===(t=e.meta.colorTexture)||void 0===t||t.destroy()}},e)}(e):function(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(ZS),createGeometry:JS,createLocationIterator:lm.fromGroup,getLoci:im,eachLocation:nm,setUpdateState:(e,t,n)=>{t.resolution!==n.resolution&&(e.createGeometry=!0),t.radiusOffset!==n.radiusOffset&&(e.createGeometry=!0),t.smoothness!==n.smoothness&&(e.createGeometry=!0),t.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),t.traceOnly!==n.traceOnly&&(e.createGeometry=!0),t.includeParent!==n.includeParent&&(e.createGeometry=!0),t.smoothColors.name!==n.smoothColors.name?e.updateColor=!0:"on"===t.smoothColors.name&&"on"===n.smoothColors.name&&(t.smoothColors.params.resolutionFactor!==n.smoothColors.params.resolutionFactor&&(e.updateColor=!0),t.smoothColors.params.sampleStride!==n.smoothColors.params.sampleStride&&(e.updateColor=!0))},mustRecreate:(e,t,n)=>t.tryUseGpu&&!!n&&XS(e.structure,t,n),processValues:(e,t,n,i,s)=>{const{resolution:r,colorTexture:o}=t.meta,a=(0,Vi.Y0)(n.smoothColors,i.color.preferSmoothing,r);a&&((0,_S.XP)(e,a.resolution,a.stride,s,o),t.meta.colorTexture=e.tColorGrid.ref.value)},dispose:e=>{var t;null===(t=e.meta.colorTexture)||void 0===t||t.destroy()}},e)}(e)}function YS(e,t,n,i){return n.tryUseGpu&&i&&QS(i)&&XS(t,n,i)?function(e){return(0,Pp.hJ)({defaultProps:Xi.t.getDefaultValues(KS),createGeometry:iC,createLocationIterator:lm.fromStructure,getLoci:am,eachLocation:om,setUpdateState:(e,t,n)=>{t.resolution!==n.resolution&&(e.createGeometry=!0),t.radiusOffset!==n.radiusOffset&&(e.createGeometry=!0),t.smoothness!==n.smoothness&&(e.createGeometry=!0),t.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),t.traceOnly!==n.traceOnly&&(e.createGeometry=!0),t.includeParent!==n.includeParent&&(e.createGeometry=!0),t.smoothColors.name!==n.smoothColors.name?e.updateColor=!0:"on"===t.smoothColors.name&&"on"===n.smoothColors.name&&(t.smoothColors.params.resolutionFactor!==n.smoothColors.params.resolutionFactor&&(e.updateColor=!0),t.smoothColors.params.sampleStride!==n.smoothColors.params.sampleStride&&(e.updateColor=!0))},mustRecreate:(e,t,n)=>!t.tryUseGpu||!n||!XS(e,t,n),processValues:(e,t,n,i,s)=>{const{resolution:r,colorTexture:o}=t.meta,a=(0,Vi.Y0)(n.smoothColors,i.color.preferSmoothing,r);a&&s&&((0,GS._i)(e,a.resolution,a.stride,s,o),t.meta.colorTexture=e.tColorGrid.ref.value)},dispose:e=>{var t;e.vertexTexture.ref.value.destroy(),e.groupTexture.ref.value.destroy(),e.normalTexture.ref.value.destroy(),e.doubleBuffer.destroy(),null===(t=e.meta.colorTexture)||void 0===t||t.destroy()}},e)}(e):function(e){return(0,Pp.wA)({defaultProps:Xi.t.getDefaultValues(KS),createGeometry:eC,createLocationIterator:lm.fromStructure,getLoci:am,eachLocation:om,setUpdateState:(e,t,n)=>{t.resolution!==n.resolution&&(e.createGeometry=!0),t.radiusOffset!==n.radiusOffset&&(e.createGeometry=!0),t.smoothness!==n.smoothness&&(e.createGeometry=!0),t.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),t.traceOnly!==n.traceOnly&&(e.createGeometry=!0),t.smoothColors.name!==n.smoothColors.name?e.updateColor=!0:"on"===t.smoothColors.name&&"on"===n.smoothColors.name&&(t.smoothColors.params.resolutionFactor!==n.smoothColors.params.resolutionFactor&&(e.updateColor=!0),t.smoothColors.params.sampleStride!==n.smoothColors.params.sampleStride&&(e.updateColor=!0))},mustRecreate:(e,t,n)=>t.tryUseGpu&&!!n&&XS(e,t,n),processValues:(e,t,n,i,s)=>{const{resolution:r,colorTexture:o}=t.meta,a=(0,Vi.Y0)(n.smoothColors,i.color.preferSmoothing,r);a&&((0,_S.XP)(e,a.resolution,a.stride,s,o),t.meta.colorTexture=e.tColorGrid.ref.value)},dispose:e=>{var t;null===(t=e.meta.colorTexture)||void 0===t||t.destroy()}},e)}(e)}async function JS(e,t,n,i,s,r){const{smoothness:o}=s,{transform:a,field:l,idField:c,radiusFactor:u,resolution:d,maxRadius:h}=await zS(n,t,i.size,s).runInContext(e.runtime),p={isoLevel:Math.exp(-o)/u,scalarField:l,idField:c},m=await(0,HS.O)(p,r).runAsChild(e.runtime);m.meta.resolution=d,Jh.e.transform(m,a),e.webgl&&!e.webgl.isWebGL2?(Jh.e.uniformTriangleGroup(m),qS.IQ.updateIfChanged(m.varyingGroup,!1)):qS.IQ.updateIfChanged(m.varyingGroup,!0);const f=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,h);return m.setBoundingSphere(f),m}async function eC(e,t,n,i,s){const{smoothness:r}=i,{transform:o,field:a,idField:l,radiusFactor:c,resolution:u,maxRadius:d}=await function(e,t,n){const{position:i,boundary:s,radius:r}=(0,op.oc)(e,t,n),o=(0,op.FC)(s.box,n);return Zi.YZ.create("Gaussian Density",async e=>await FS(e,i,s.box,r,o))}(t,n.size,i).runInContext(e.runtime),h={isoLevel:Math.exp(-r)/c,scalarField:a,idField:l},p=await(0,HS.O)(h,s).runAsChild(e.runtime);p.meta.resolution=u,Jh.e.transform(p,o),e.webgl&&!e.webgl.isWebGL2?(Jh.e.uniformTriangleGroup(p),qS.IQ.updateIfChanged(p.varyingGroup,!1)):qS.IQ.updateIfChanged(p.varyingGroup,!0);const m=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,d);return p.setBoundingSphere(m),p}const tC="gaussian-surface";function nC(e,t,n,i,s,r){const{webgl:o}=e;if(!o)throw new Error("webgl context required to create gaussian surface texture-mesh");const{namedTextures:a,resources:l,extensions:{colorBufferFloat:c,textureFloat:u,colorBufferHalfFloat:d,textureHalfFloat:h}}=o;a[tC]||(a[tC]=d&&h?l.texture("image-float16","rgba","fp16","linear"):c&&u?l.texture("image-float32","rgba","float","linear"):l.texture("image-uint8","rgba","ubyte","linear"));const p=Go.eB.create(0,1,2),m=t.elements.length,f=e=>{Md.g$&&o.timer.mark("createGaussianSurfaceTextureMesh");const r=function(e,t,n,i,s,r,o){const{position:a,boundary:l,radius:c}=(0,op.LT)(e,t,n,s),u=(0,op.FC)(l.box,s,OS(r,e));return BS(r,a,l.box,c,i,u,o)}(n,t,i.size,!0,s,o,a[tC]),l=Math.exp(-s.smoothness)/r.radiusFactor,c=null==e?void 0:e.doubleBuffer.get(),u=(0,VS._)(o,r.texture,r.gridDim,r.gridTexDim,r.gridDataDim,r.gridTexScale,r.transform,l,!1,!0,p,!0,null==c?void 0:c.vertex,null==c?void 0:c.group,null==c?void 0:c.normal);Md.g$&&o.timer.markEnd("createGaussianSurfaceTextureMesh");const d=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,r.maxRadius),h=US.X.create(u.vertexCount,m,u.vertexTexture,u.groupTexture,u.normalTexture,d,e);return h.meta.resolution=r.resolution,h},g=f(r);return g.meta.webgl=o,g.meta.reset=()=>{f(g)},g}function iC(e,t,n,i,s){const{webgl:r}=e;if(!r)throw new Error("webgl context required to create structure gaussian surface texture-mesh");const{namedTextures:o,resources:a,extensions:{colorBufferFloat:l,textureFloat:c,colorBufferHalfFloat:u,textureHalfFloat:d}}=r;o[tC]||(o[tC]=u&&d?a.texture("image-float16","rgba","fp16","linear"):l&&c?a.texture("image-float32","rgba","float","linear"):a.texture("image-uint8","rgba","ubyte","linear"));const h=Go.eB.create(0,1,2),p=t.elementCount,m=e=>{Md.g$&&r.timer.mark("createStructureGaussianSurfaceTextureMesh");const s=function(e,t,n,i,s,r){const{box:o}=e.lookup3d.boundary,{position:a,boundary:l,radius:c}=(0,op.oc)(e,t,i);return BS(s,a,o,c,n,(0,op.FC)(l.box,i),r)}(t,n.size,!0,i,r,o[tC]),a=Math.exp(-i.smoothness)/s.radiusFactor,l=null==e?void 0:e.doubleBuffer.get(),c=(0,VS._)(r,s.texture,s.gridDim,s.gridTexDim,s.gridDataDim,s.gridTexScale,s.transform,a,!1,!0,h,!0,null==l?void 0:l.vertex,null==l?void 0:l.group,null==l?void 0:l.normal);Md.g$&&r.timer.markEnd("createStructureGaussianSurfaceTextureMesh");const u=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,s.maxRadius),d=US.X.create(c.vertexCount,p,c.vertexTexture,c.groupTexture,c.normalTexture,u,e);return d.meta.resolution=s.resolution,d},f=m(s);return f.meta.webgl=r,f.meta.reset=()=>{m(f)},f}var sC=n(8958);async function rC(e,t,n,i,s,r){const{smoothness:o}=s,{transform:a,field:l,idField:c,maxRadius:u}=await zS(n,t,i.size,s).runInContext(e.runtime),d={isoLevel:Math.exp(-o),scalarField:l,idField:c},h=await(0,HS.e)(d,r).runAsChild(e.runtime);sC.q.transform(h,a);const p=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,u);return h.setBoundingSphere(p),h}const oC={...tp.zj,...RS,sizeFactor:Xi.t.Numeric(3,{min:0,max:10,step:.1}),lineSizeAttenuation:Xi.t.Boolean(!1),ignoreHydrogens:Xi.t.Boolean(!1),ignoreHydrogensVariant:Xi.t.Select("all",Xi.t.arrayToOptions(["all","non-polar"])),includeParent:Xi.t.Boolean(!1,{isHidden:!0})};function aC(e){return(0,tp.zK)({defaultProps:Xi.t.getDefaultValues(oC),createGeometry:rC,createLocationIterator:lm.fromGroup,getLoci:im,eachLocation:nm,setUpdateState:(e,t,n)=>{t.resolution!==n.resolution&&(e.createGeometry=!0),t.radiusOffset!==n.radiusOffset&&(e.createGeometry=!0),t.smoothness!==n.smoothness&&(e.createGeometry=!0),t.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),t.traceOnly!==n.traceOnly&&(e.createGeometry=!0),t.includeParent!==n.includeParent&&(e.createGeometry=!0)}},e)}const lC={"gaussian-surface-mesh":(e,t)=>(0,mm.T)("Gaussian surface mesh",e,t,WS),"structure-gaussian-surface-mesh":(e,t)=>(0,gm.Kp)("Structure-Gaussian surface mesh",e,t,YS),"gaussian-surface-wireframe":(e,t)=>(0,mm.T)("Gaussian surface wireframe",e,t,aC)},cC={...ZS,...oC,visuals:Xi.t.MultiSelect(["gaussian-surface-mesh"],Xi.t.objectToOptions(lC)),bumpFrequency:Xi.t.Numeric(1,{min:0,max:10,step:.1},Vi.iy.ShadingCategory),density:Xi.t.Numeric(.5,{min:0,max:1,step:.01},Vi.iy.ShadingCategory)};const uC=(0,gm.GT)({name:"gaussian-surface",label:"Gaussian Surface",description:"Displays a gaussian molecular surface.",factory:function(e,t){return Er.YL.createMulti("Gaussian Surface",e,t,gm.J1,lC)},getParams:function(e,t){return cC},defaultValues:Xi.t.getDefaultValues(cC),defaultColorTheme:{name:"chain-id"},defaultSizeTheme:{name:"physical"},isApplicable:e=>e.elementCount>0});var dC=n(76012);const hC={...Pp.ip,background:Xi.t.Boolean(!1),backgroundMargin:Xi.t.Numeric(0,{min:0,max:1,step:.01}),backgroundColor:Xi.t.Color(Ki.s.black),backgroundOpacity:Xi.t.Numeric(.5,{min:0,max:1,step:.01}),borderWidth:Xi.t.Numeric(.25,{min:0,max:.5,step:.01}),level:Xi.t.Select("residue",[["chain","Chain"],["residue","Residue"],["element","Element"]],{isEssential:!0}),ignoreHydrogens:Xi.t.Boolean(!1),ignoreHydrogensVariant:Xi.t.Select("all",Xi.t.arrayToOptions(["all","non-polar"])),chainScale:Xi.t.Numeric(10,{min:0,max:20,step:.1}),residueScale:Xi.t.Numeric(1,{min:0,max:20,step:.1}),elementScale:Xi.t.Numeric(.5,{min:0,max:20,step:.1})};function pC(e){return(0,Pp.Go)({defaultProps:Xi.t.getDefaultValues(hC),createGeometry:mC,createLocationIterator:lm.fromStructure,getLoci:am,eachLocation:om,setUpdateState:(e,t,n)=>{e.createGeometry=t.level!==n.level||"chain"===t.level&&t.chainScale!==n.chainScale||"residue"===t.level&&t.residueScale!==n.residueScale||"element"===t.level&&t.elementScale!==n.elementScale||t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant}},e)}function mC(e,t,n,i,s){switch(i.level){case"chain":return function(e,t,n,i,s){const r=Gi.iZ.Location.create(t),{units:o,serialMapping:a}=t,{auth_asym_id:l,label_asym_id:c}=Gi.ZP.chain,{cumulativeUnitElementCount:u}=a,d=o.length,{chainScale:h}=i,p=dC.t.create(i,d,d/2,s);for(let m=0,f=o.length;m<f;++m){const e=o[m];r.unit=e,r.element=e.elements[0];const{center:t,radius:n}=e.lookup3d.boundary.sphere;Go.eB.transformMat4(fC,t,e.conformation.operator.matrix);const i=l(r),s=c(r),a=i===s?s:`${s} [${i}]`;p.add(a,fC[0],fC[1],fC[2],n,h,u[m])}return p.getText()}(0,t,0,i,s);case"residue":return function(e,t,n,i,s){const r=Gi.iZ.Location.create(t),{units:o,serialMapping:a}=t,{label_comp_id:l}=Gi.ZP.atom,{auth_seq_id:c}=Gi.ZP.residue,{cumulativeUnitElementCount:u}=a,d=2*t.polymerResidueCount,{residueScale:h}=i,p=dC.t.create(i,d,d/2,s);for(let m=0,f=o.length;m<f;++m){const e=o[m],t=e.conformation,{elements:n}=e;r.unit=e,r.element=e.elements[0];const i=e.model.atomicHierarchy.residueAtomSegments.index,s=u[m];let a=0;const d=n.length;for(;a<d;){const e=a,o=i[n[a]];for(a++;a<d&&i[n[a]]===o;)a++;gC.reset();for(let i=e;i<a;i++)t.position(n[i],fC),gC.includePosition(fC);gC.finishedIncludeStep();for(let i=e;i<a;i++)t.position(n[i],fC),gC.radiusPosition(fC);r.element=n[e];const{center:u,radius:m}=gC.getSphere(),f=c(r),g=`${l(r)} ${f}`;p.add(g,u[0],u[1],u[2],m,h,s+e)}}return p.getText()}(0,t,0,i,s);case"element":return function(e,t,n,i,s){const r=Gi.iZ.Location.create(t),{units:o,serialMapping:a}=t,{label_atom_id:l,label_alt_id:c}=Gi.ZP.atom,{cumulativeUnitElementCount:u}=a,d=n.size,h=t.elementCount,{elementScale:p}=i,m=dC.t.create(i,h,h/2,s);for(let f=0,g=o.length;f<g;++f){const e=o[f],n=e.conformation,{elements:s}=e;r.unit=e;const a=u[f],h=Jp(t,e,{...i,traceOnly:!1});for(let t=0,i=s.length;t<i;t++){if(h&&h(s[t]))continue;r.element=s[t],n.position(r.element,fC);const e=l(r),i=c(r),o=i?`${e}%${i}`:e;m.add(o,fC[0],fC[1],fC[2],d.size(r),p,a+t)}}return m.getText()}(0,t,n,i,s)}}const fC=(0,Go.eB)(),gC=new yh.Z("98");const yC={"label-text":(e,t)=>(0,gm.Kp)("Label text",e,t,pC)},vC={...hC,visuals:Xi.t.MultiSelect(["label-text"],Xi.t.objectToOptions(yC))};const bC=(0,gm.GT)({name:"label",label:"Label",description:"Displays labels.",factory:function(e,t){const n=Er.YL.createMulti("Label",e,t,gm.J1,yC);return n.setState({pickable:!1,markerActions:Dr.xi.None}),n},getParams:function(e,t){return vC},defaultValues:Xi.t.getDefaultValues(vC),defaultColorTheme:{name:"uniform"},defaultSizeTheme:{name:"physical"},isApplicable:e=>e.elementCount>0});const xC={probeRadius:Xi.t.Numeric(1.4,{min:0,max:10,step:.1},{description:"Radius of the probe tracing the molecular surface."}),resolution:Xi.t.Numeric(.5,{min:.01,max:20,step:.01},{description:"Grid resolution/cell spacing.",...Vi.iy.CustomQualityParamInfo}),probePositions:Xi.t.Numeric(36,{min:12,max:90,step:1},{description:"Number of positions tested for probe target intersection.",...Vi.iy.CustomQualityParamInfo})};Xi.t.getDefaultValues(xC);async function SC(e,t,n,i,s,r){let o=-1;function a(e,t,n,i,s){if(-1!==o){const r=o;if(r!==i&&r!==s&&l(r,e,t,n))return r;o=-1}for(let r=0,a=w.count;r<a;++r){const a=ho.CD.getAt(k,w.indices[r]);if(a!==i&&a!==s&&l(a,e,t,n))return o=a,a}return-1}function l(e,t,n,i){const s=T[e],r=B[e]-t,o=P[e]-n,a=I[e]-i;return r*r+o*o+a*a<s*s}function c(e,t){for(let n=e;n<t;++n){const e=ho.CD.getAt(k,n),t=B[e],i=P[e],s=I[e],r=T[e],o=r*r;C.find(t,i,s,r);const l=Math.ceil(r*b),c=Math.floor(b*(t-E)),u=Math.floor(b*(i-D)),d=Math.floor(b*(s-N)),h=Math.max(0,c-l),p=Math.max(0,u-l),m=Math.max(0,d-l),f=Math.min(O,c+l+2),g=Math.min(z,u+l+2),y=Math.min(H,d+l+2);for(let v=h;v<f;++v){const l=K[v]-t,c=v*V;for(let u=p;u<g;++u){const d=Q[u]-i,h=l*l+d*d,p=u*U+c;for(let c=m;c<y;++c){const u=X[c]-s,m=h+u*u;if(m<o){const o=c+p;$[o]<0&&($[o]*=-1);const h=Math.sqrt(m),f=r/h;if(-1===a(l*f+t,d*f+i,u*f+s,e,-1)){const e=r-h;e<$[o]&&($[o]=e,Z[o]=j[n])}}}}}}}const u=(0,Go.eB)(),d=(0,Go.eB)(),h=(0,Go.eB)(),p=(0,Go.eB)();function m(e,t){const n=T[e],i=T[t],s=u[0]=B[t]-B[e],r=u[1]=P[t]-P[e],l=u[2]=I[t]-I[e],c=s*s+r*r+l*l,m=Math.sqrt(c),f=n*((n*n+m*m-i*i)/(2*n*m));var g,y;Go.eB.normalize(u,u),y=u,(g=h)[0]=g[1]=g[2]=1,0!==y[0]?g[0]=(y[1]+y[2])/-y[0]:0!==y[1]?g[1]=(y[0]+y[2])/-y[1]:0!==y[2]&&(g[2]=(y[0]+y[1])/-y[2]),Go.eB.normalize(h,h),Go.eB.cross(p,u,h),Go.eB.normalize(p,p);const S=Math.sqrt(n*n-f*f);Go.eB.scale(h,h,S),Go.eB.scale(p,p,S),Go.eB.scale(u,u,f),d[0]=u[0]+B[e],d[1]=u[1]+P[e],d[2]=u[2]+I[e],o=-1;for(let o=0;o<v;++o){const n=_[o],i=G[o],s=d[0]+n*h[0]+i*p[0],r=d[1]+n*h[1]+i*p[1],l=d[2]+n*h[2]+i*p[2];if(-1===a(s,r,l,e,t)){const n=Math.floor(b*(s-E)),i=Math.floor(b*(r-D)),o=Math.floor(b*(l-N)),a=Math.max(0,n-x),c=Math.max(0,i-x),d=Math.max(0,o-x),h=Math.min(O,n+x+2),p=Math.min(z,i+x+2),m=Math.min(H,o+x+2);for(let f=a;f<h;++f){const n=s-K[f],i=f*V;for(let s=c;s<p;++s){const o=r-Q[s],a=n*n+o*o,c=s*U+i;for(let i=d;i<m;++i){const s=l-X[i],r=a+s*s,d=i+c,h=$[d];if(h>0&&r<h*h){$[d]=Math.sqrt(r);const i=n*u[0]+o*u[1]+s*u[2];Z[d]=j[ho.CD.indexOf(k,i<0?t:e)]}}}}}}}function f(e,t){for(let n=e;n<t;++n){const e=ho.CD.getAt(k,n);C.find(B[e],P[e],I[e],T[e]);for(let t=0,n=w.count;t<n;++t){const n=ho.CD.getAt(k,w.indices[t]);e<n&&m(e,n)}}}const{resolution:g,probeRadius:y,probePositions:v}=r,b=1/g,x=Math.max(5,2+Math.floor(y*b)),S=Go.eB.create(i,i,i);Go.eB.scale(S,S,2);const C=(0,Dd.Eh)(t,n,S),w=C.result;null===s&&(s=C.boundary.box);const{indices:k,x:B,y:P,z:I,id:j,radius:T}=t,A=ho.CD.size(k),M=i+g,L=Dd.DJ.expand((0,Dd.DJ)(),s,Go.eB.create(M,M,M)),[E,D,N]=L.min,F=Dd.DJ.scale((0,Dd.DJ)(),L,b),R=Dd.DJ.size((0,Go.eB)(),F);Go.eB.ceil(R,R);const[O,z,H]=R,U=H,V=U*z,{cosTable:_,sinTable:G}=function(e){let t=0;const n=2*Math.PI/e,i=new Float32Array(e),s=new Float32Array(e);for(let r=0;r<e;r++)i[r]=Math.cos(t),s[r]=Math.sin(t),t+=n;return{cosTable:i,sinTable:s}}(v),q=Go.qY.Space(R,[0,1,2],Float32Array),$=q.create(),Z=q.create();$.fill(-1001),Z.fill(-1);const K=(0,Dd.oI)(O,E,g),Q=(0,Dd.oI)(z,D,g),X=(0,Dd.oI)(H,N,g),W=Math.ceil(1e5/(Math.pow(Math.pow(i,3),3)*b));await async function(){for(let t=0;t<A;t+=W)c(t,Math.min(t+W,A)),e.shouldUpdate&&await e.update({message:"projecting points",current:t,max:A})}(),await async function(){for(let t=0;t<A;t+=W)f(t,Math.min(t+W,A)),e.shouldUpdate&&await e.update({message:"projecting torii",current:t,max:A})}();const Y=Go.qY.create(q,$),J=Go.qY.create(q,Z),ee=$o.$.identity();return $o.$.fromScaling(ee,Go.eB.create(g,g,g)),$o.$.setTranslation(ee,L.min),{field:Y,idField:J,transform:ee,resolution:g,maxRadius:i}}function CC(e,t,n,i){const{position:s,boundary:r,maxRadius:o}=function(e,t,n,i){const{probeRadius:s}=i,{position:r,boundary:o,radius:a}=(0,op.LT)(e,t,n,i),{indices:l}=r,c=ho.CD.size(l),u=new Float32Array(ho.CD.end(l));let d=0;for(let h=0;h<c;++h){const e=ho.CD.getAt(l,h),t=a(e);d<t&&(d=t),u[e]=t+s}return{position:{...r,radius:u},boundary:o,maxRadius:d}}(e,t,n,i),a=(0,op.FC)(r.box,i);return Zi.YZ.create("Molecular Surface",async e=>await kC(e,s,r,o,r.box,a))}function wC(e,t,n){const{position:i,boundary:s,maxRadius:r}=function(e,t,n){const{probeRadius:i}=n,{position:s,boundary:r,radius:o}=(0,op.oc)(e,t,n),{indices:a}=s,l=ho.CD.size(a),c=new Float32Array(ho.CD.end(a));let u=0;for(let d=0;d<l;++d){const e=ho.CD.getAt(a,d),t=o(e);u<t&&(u=t),c[e]=t+i}return{position:{...s,radius:c},boundary:r,maxRadius:u}}(e,t,n),o=(0,op.FC)(s.box,n);return Zi.YZ.create("Molecular Surface",async e=>await kC(e,i,s,r,s.box,o))}async function kC(e,t,n,i,s,r){return SC(e,t,n,i,s,r)}const BC={...tp.Te,...xC,...op.$J,...Vi.uE};async function PC(e,t,n,i,s,r){const{transform:o,field:l,idField:c,resolution:u,maxRadius:d}=await CC(n,t,i.size,s).runInContext(e.runtime),h={isoLevel:s.probeRadius,scalarField:l,idField:c},p=await(0,HS.O)(h,r).runAsChild(e.runtime);if(s.includeParent){const e=Math.ceil(2/s.resolution);Jh.e.smoothEdges(p,{iterations:e,maxNewEdgeLength:Math.sqrt(2)})}Jh.e.transform(p,o),e.webgl&&!e.webgl.isWebGL2?(Jh.e.uniformTriangleGroup(p),a.IQ.updateIfChanged(p.varyingGroup,!1)):a.IQ.updateIfChanged(p.varyingGroup,!0);const m=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,d);return p.setBoundingSphere(m),p.meta.resolution=u,p}function IC(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(BC),createGeometry:PC,createLocationIterator:lm.fromGroup,getLoci:im,eachLocation:nm,setUpdateState:(e,t,n)=>{t.resolution!==n.resolution&&(e.createGeometry=!0),t.probeRadius!==n.probeRadius&&(e.createGeometry=!0),t.probePositions!==n.probePositions&&(e.createGeometry=!0),t.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),t.traceOnly!==n.traceOnly&&(e.createGeometry=!0),t.includeParent!==n.includeParent&&(e.createGeometry=!0),t.smoothColors.name!==n.smoothColors.name?e.updateColor=!0:"on"===t.smoothColors.name&&"on"===n.smoothColors.name&&(t.smoothColors.params.resolutionFactor!==n.smoothColors.params.resolutionFactor&&(e.updateColor=!0),t.smoothColors.params.sampleStride!==n.smoothColors.params.sampleStride&&(e.updateColor=!0))},processValues:(e,t,n,i,s)=>{const{resolution:r,colorTexture:o}=t.meta,a=(0,Vi.Y0)(n.smoothColors,i.color.preferSmoothing,r);a&&((0,_S.XP)(e,a.resolution,a.stride,s,o),t.meta.colorTexture=e.tColorGrid.ref.value)},dispose:e=>{var t;null===(t=e.meta.colorTexture)||void 0===t||t.destroy()}},e)}async function jC(e,t,n,i,s){const{transform:r,field:o,idField:l,resolution:c,maxRadius:u}=await wC(t,n.size,i).runInContext(e.runtime),d={isoLevel:i.probeRadius,scalarField:o,idField:l},h=await(0,HS.O)(d,s).runAsChild(e.runtime);if(i.includeParent){const e=Math.ceil(2/i.resolution);Jh.e.smoothEdges(h,{iterations:e,maxNewEdgeLength:Math.sqrt(2)})}Jh.e.transform(h,r),e.webgl&&!e.webgl.isWebGL2?(Jh.e.uniformTriangleGroup(h),a.IQ.updateIfChanged(h.varyingGroup,!1)):a.IQ.updateIfChanged(h.varyingGroup,!0);const p=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,u);return h.setBoundingSphere(p),h.meta.resolution=c,h}function TC(e){return(0,Pp.wA)({defaultProps:Xi.t.getDefaultValues(BC),createGeometry:jC,createLocationIterator:lm.fromStructure,getLoci:am,eachLocation:om,setUpdateState:(e,t,n)=>{t.resolution!==n.resolution&&(e.createGeometry=!0),t.probeRadius!==n.probeRadius&&(e.createGeometry=!0),t.probePositions!==n.probePositions&&(e.createGeometry=!0),t.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),t.traceOnly!==n.traceOnly&&(e.createGeometry=!0),t.includeParent!==n.includeParent&&(e.createGeometry=!0),t.smoothColors.name!==n.smoothColors.name?e.updateColor=!0:"on"===t.smoothColors.name&&"on"===n.smoothColors.name&&(t.smoothColors.params.resolutionFactor!==n.smoothColors.params.resolutionFactor&&(e.updateColor=!0),t.smoothColors.params.sampleStride!==n.smoothColors.params.sampleStride&&(e.updateColor=!0))},processValues:(e,t,n,i,s)=>{const{resolution:r,colorTexture:o}=t.meta,a=(0,Vi.Y0)(n.smoothColors,i.color.preferSmoothing,r);a&&((0,_S.XP)(e,a.resolution,a.stride,s,o),t.meta.colorTexture=e.tColorGrid.ref.value)},dispose:e=>{var t;null===(t=e.meta.colorTexture)||void 0===t||t.destroy()}},e)}const AC={...tp.zj,...xC,...op.$J,sizeFactor:Xi.t.Numeric(1.5,{min:0,max:10,step:.1})};async function MC(e,t,n,i,s,r){const{transform:o,field:a,idField:l,maxRadius:c}=await CC(n,t,i.size,s).runInContext(e.runtime),u={isoLevel:s.probeRadius,scalarField:a,idField:l},d=await(0,HS.e)(u,r).runAsChild(e.runtime);sC.q.transform(d,o);const h=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,c);return d.setBoundingSphere(h),d}function LC(e){return(0,tp.zK)({defaultProps:Xi.t.getDefaultValues(AC),createGeometry:MC,createLocationIterator:lm.fromGroup,getLoci:im,eachLocation:nm,setUpdateState:(e,t,n)=>{t.resolution!==n.resolution&&(e.createGeometry=!0),t.probeRadius!==n.probeRadius&&(e.createGeometry=!0),t.probePositions!==n.probePositions&&(e.createGeometry=!0),t.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),t.includeParent!==n.includeParent&&(e.createGeometry=!0)}},e)}const EC={"molecular-surface-mesh":(e,t)=>(0,mm.T)("Molecular surface mesh",e,t,IC),"structure-molecular-surface-mesh":(e,t)=>(0,gm.Kp)("Structure Molecular surface mesh",e,t,TC),"molecular-surface-wireframe":(e,t)=>(0,mm.T)("Molecular surface wireframe",e,t,LC)},DC={...BC,...AC,visuals:Xi.t.MultiSelect(["molecular-surface-mesh"],Xi.t.objectToOptions(EC)),bumpFrequency:Xi.t.Numeric(1,{min:0,max:10,step:.1},Vi.iy.ShadingCategory),density:Xi.t.Numeric(.5,{min:0,max:1,step:.01},Vi.iy.ShadingCategory)};const NC=(0,gm.GT)({name:"molecular-surface",label:"Molecular Surface",description:"Displays a molecular surface.",factory:function(e,t){return Er.YL.createMulti("Molecular Surface",e,t,gm.J1,EC)},getParams:function(e,t){return DC},defaultValues:Xi.t.getDefaultValues(DC),defaultColorTheme:{name:"chain-id"},defaultSizeTheme:{name:"physical"},isApplicable:e=>e.elementCount>0}),FC={...tp.Te,sizeFactor:Xi.t.Numeric(1,{min:0,max:2,step:.1}),detail:Xi.t.Numeric(0,{min:0,max:3,step:1},Vi.iy.CustomQualityParamInfo)};function RC(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(FC),createGeometry:OC,createLocationIterator:zC,getLoci:HC,eachLocation:UC,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.detail!==n.detail}},e)}function OC(e,t,n,i,s,r){if(!function(e){if(Gi.Nf.Traits.is(e.traits,Gi.Nf.Trait.MultiChain))return!1;if(Gi.Nf.Traits.is(e.traits,Gi.Nf.Trait.Partitioned))return!1;if(Gi.Nf.isCoarse(e))return!0;if(0===e.elements.length)return!1;e.model.atomicHierarchy.derived.residue.moleculeType;const t=e.residueIndex[e.elements[0]],n=e.model.atomicHierarchy.derived.residue.moleculeType[t];return n!==np.HX.Ion&&n!==np.HX.Water}(t))return Jh.e.createEmpty(r);const{detail:o,sizeFactor:a}=s,l=Kp.P.createState(256,128,r),c=t.principalAxes.boxAxes,{origin:u,dirA:d,dirB:h}=c,p=Dd.n.size((0,Go.eB)(),c);Go.eB.scale(p,p,a/2);const m=Go.eB.create(p[2],p[1],p[0]);l.currentGroup=0,(0,eS.P)(l,u,d,h,m,o+1);const f=Kp.P.getMesh(l),g=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*s.sizeFactor);return f.setBoundingSphere(g),f}function zC(e){const{group:t,structure:n}=e,i=t.units.length,s=Gi.iZ.Location.create(n);return(0,ip.iQ)(1,i,1,(e,n)=>{const i=t.units[n];return s.unit=i,s.element=i.elements[e],s})}function HC(e,t,n){const{objectId:i,instanceId:s}=e;if(n===i){const{structure:e,group:n}=t,i=n.units[s],r=ho.CD.ofBounds(0,i.elements.length);return Gi.iZ.Loci(e,[{unit:i,indices:r}])}return ts.BL}function UC(e,t,n){let i=!1;if(!Gi.iZ.Loci.is(e))return!1;const{structure:s,group:r}=t;if(!Gi.Structure.areEquivalent(e.structure,s))return!1;const o=r.elements.length;for(const a of e.elements){const e=r.unitIndexMap.get(a.unit.id);void 0!==e&&ho.CD.size(a.indices)===o&&n(ho.IX.ofSingleton(e))&&(i=!0)}return i}const VC={"orientation-ellipsoid-mesh":(e,t)=>(0,mm.T)("Orientation ellipsoid mesh",e,t,RC)},_C={...FC,visuals:Xi.t.MultiSelect(["orientation-ellipsoid-mesh"],Xi.t.objectToOptions(VC)),bumpFrequency:Xi.t.Numeric(1,{min:0,max:10,step:.1},Vi.iy.ShadingCategory)};const GC=(0,gm.GT)({name:"orientation",label:"Orientation",description:"Displays orientation ellipsoids for polymer chains.",factory:function(e,t){return Er.YL.createMulti("Orientation",e,t,gm.J1,VC)},getParams:function(e,t){return _C},defaultValues:Xi.t.getDefaultValues(_C),defaultColorTheme:{name:"chain-id"},defaultSizeTheme:{name:"uniform"},isApplicable:e=>e.elementCount>0});var qC=n(14366),$C=n(59884);const ZC=Go.eB.add,KC={...tp.PJ,pointSizeAttenuation:Xi.t.Boolean(!1),ignoreHydrogens:Xi.t.Boolean(!1),ignoreHydrogensVariant:Xi.t.Select("all",Xi.t.arrayToOptions(["all","non-polar"])),traceOnly:Xi.t.Boolean(!1),stride:Xi.t.Numeric(1,{min:1,max:100,step:1})};function QC(e,t,n,i,s,r){const{child:o}=n,a=null==o?void 0:o.unitMap.get(t.id);if(o&&!a)return qC.O.createEmpty(r);const{stride:l}=s,c=t.elements,u=c.length,d=$C.N.create(u,u/10,r),h=(0,Go.eB)(),p=t.conformation,m=Jp(n,t,s),f=(0,Go.eB)();let g=0;if(l&&l>1||m)for(let x=0;x<u;++x)l&&x%l!==0||m&&m(c[x])||(p.invariantPosition(c[x],h),ZC(f,f,h),g+=1,d.add(h[0],h[1],h[2],x));else for(let x=0;x<u;++x)p.invariantPosition(c[x],h),ZC(f,f,h),g+=1,d.add(h[0],h[1],h[2],x);const y=d.getPoints();if(0===g)return y;let v;Go.eB.scale(f,f,1/g);const b=r?Dd.f8.clone(r.boundingSphere):void 0;return v=b&&Go.eB.distance(f,b.center)/b.radius<.1?b:Dd.f8.expand((0,Dd.f8)(),(null!=a?a:t).boundary.sphere,1*s.sizeFactor),y.setBoundingSphere(v),y}function XC(e){return(0,tp.fm)({defaultProps:Xi.t.getDefaultValues(KC),createGeometry:QC,createLocationIterator:lm.fromGroup,getLoci:im,eachLocation:nm,setUpdateState:(e,t,n)=>{e.createGeometry=t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||t.traceOnly!==n.traceOnly||t.stride!==n.stride}},e)}function WC(e,t,n,i,s){const{child:r}=t,{stride:o}=i,{getSerialIndex:a}=t.serialMapping,l=t.elementCount,c=$C.N.create(l,l/2,s),u=(0,Go.eB)();let d=0;for(const f of t.units){const e=null==r?void 0:r.unitMap.get(f.id);if(r&&!e)return qC.O.createEmpty(s);const{elements:n,conformation:l}=f,h=n.length,p=(0,Go.eB)(),m=Jp(t,f,i);if(o&&o>1||m)for(let t=0;t<h;t++){const e=n[t];o&&t%o!==0||(m&&m(e)||(l.position(e,p),c.add(p[0],p[1],p[2],a(f,e)),ZC(u,u,p),d+=1))}else{for(let e=0;e<h;e++){const t=n[e];l.position(t,p),c.add(p[0],p[1],p[2],a(f,t)),ZC(u,u,p)}d+=h}}const h=c.getPoints();if(0===d)return h;let p;Go.eB.scale(u,u,1/d);const m=s?Dd.f8.clone(s.boundingSphere):void 0;return p=m&&Go.eB.distance(u,m.center)/m.radius<1?m:Dd.f8.expand((0,Dd.f8)(),(null!=r?r:t).boundary.sphere,1*i.sizeFactor),h.setBoundingSphere(p),h}const YC={...Pp.yv,pointSizeAttenuation:Xi.t.Boolean(!1),ignoreHydrogens:Xi.t.Boolean(!1),ignoreHydrogensVariant:Xi.t.Select("all",Xi.t.arrayToOptions(["all","non-polar"])),traceOnly:Xi.t.Boolean(!1),stride:Xi.t.Numeric(1,{min:1,max:100,step:1})};function JC(e){return(0,Pp.yW)({defaultProps:Xi.t.getDefaultValues(YC),createGeometry:WC,createLocationIterator:lm.fromStructure,getLoci:am,eachLocation:om,setUpdateState:(e,t,n)=>{e.createGeometry=t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||t.traceOnly!==n.traceOnly||t.stride!==n.stride}},e)}const ew={"element-point":(e,t)=>(0,mm.T)("Element points",e,t,XC),"structure-element-point":(e,t)=>(0,gm.Kp)("Structure element points",e,t,JC)},tw={...KC,density:Xi.t.Numeric(.1,{min:0,max:1,step:.01},Vi.iy.ShadingCategory),visuals:Xi.t.MultiSelect(["element-point"],Xi.t.objectToOptions(ew))};const nw=(0,gm.GT)({name:"point",label:"Point",description:"Displays elements (atoms, coarse spheres) as points.",factory:function(e,t){return Er.YL.createMulti("Point",e,t,gm.J1,ew)},getParams:function(e,t){let n=tw;return t.unitSymmetryGroups.length>5e3&&(n=Xi.t.clone(n),n.visuals.defaultValue=["structure-element-point"]),n},defaultValues:Xi.t.getDefaultValues(tw),defaultColorTheme:{name:"element-symbol"},defaultSizeTheme:{name:"uniform"},isApplicable:e=>e.elementCount>0}),iw={sizeFactor:Xi.t.Numeric(.2,{min:0,max:10,step:.01}),detail:Xi.t.Numeric(0,{min:0,max:3,step:1},Vi.iy.CustomQualityParamInfo),linearSegments:Xi.t.Numeric(8,{min:1,max:48,step:1},Vi.iy.CustomQualityParamInfo),radialSegments:Xi.t.Numeric(16,{min:2,max:56,step:2},Vi.iy.CustomQualityParamInfo)},sw=(Xi.t.getDefaultValues(iw),(0,Go.eB)());function rw(e,t,n,i,s,r){const o=t.polymerElements.length;if(!o)return Jh.e.createEmpty(r);const{sizeFactor:a,detail:l,linearSegments:c,radialSegments:u}=s,d=c*u*o+(u+1)*o*2,h=Kp.P.createState(d,d/10,r),p=yg(c),{curvePoints:m,normalVectors:f,binormalVectors:g,widthValues:y,heightValues:v}=p;let b=0;const x=Kf(t,n,{ignoreSecondaryStructure:!0});for(;x.hasNext;){const e=x.move();h.currentGroup=b;const t=(0,np.OV)(e.moleculeType)?Dg:Eg;vg(p,e,.5,t);const n=e.coarseBackboneFirst||e.first,s=e.coarseBackboneLast||e.last,r=i.size.size(e.centerPrev)*a,o=i.size.size(e.center)*a,d=i.size.size(e.centerNext)*a;Lg(p,r,o,d,r,o,d,t);let S=c;if(e.initial){S=Math.max(Math.round(c*t),1);const n=c-S;m.copyWithin(0,3*n),g.copyWithin(0,3*n),f.copyWithin(0,3*n),y.copyWithin(0,3*n),v.copyWithin(0,3*n),Go.eB.fromArray(sw,m,3),Go.eB.normalize(sw,Go.eB.sub(sw,e.p2,sw)),Go.eB.scaleAndAdd(sw,e.p2,sw,2*o),Go.eB.toArray(sw,m,0)}else e.final&&(S=Math.max(Math.round(c*(1-t)),1),Go.eB.fromArray(sw,m,3*S-3),Go.eB.normalize(sw,Go.eB.sub(sw,e.p2,sw)),Go.eB.scaleAndAdd(sw,e.p2,sw,2*o),Go.eB.toArray(sw,m,3*S));!0===e.initial&&!0===e.final?(0,Qp.X)(h,e.p2,2*o,l):2===u?qx(h,m,f,g,S,y,v,0):4===u?ax(h,m,f,g,S,y,v,0,n,s):Bx(h,m,f,g,S,u,y,v,n,s,"elliptical"),++b}const S=Kp.P.getMesh(h),C=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*s.sizeFactor);return S.setBoundingSphere(C),S}const ow={...tp.Te,...iw};function aw(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(ow),createGeometry:rw,createLocationIterator:e=>Rg.fromGroup(e,{asSecondary:!0}),getLoci:Hg,eachLocation:Gg,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.detail!==n.detail||t.linearSegments!==n.linearSegments||t.radialSegments!==n.radialSegments}},e)}const lw={"polymer-tube":(e,t)=>(0,mm.T)("Polymer tube mesh",e,t,aw),"polymer-gap":(e,t)=>(0,mm.T)("Polymer gap cylinder",e,t,Eb)},cw={...ow,...Lb,sizeFactor:Xi.t.Numeric(.2,{min:0,max:10,step:.01}),visuals:Xi.t.MultiSelect(["polymer-tube","polymer-gap"],Xi.t.objectToOptions(lw)),bumpFrequency:Xi.t.Numeric(2,{min:0,max:10,step:.1},Vi.iy.ShadingCategory),density:Xi.t.Numeric(.1,{min:0,max:1,step:.01},Vi.iy.ShadingCategory)};const uw=(0,gm.GT)({name:"putty",label:"Putty",description:"Displays a tube smoothly following the trace atoms of polymers.",factory:function(e,t){return Er.YL.createMulti("Putty",e,t,gm.J1,lw)},getParams:function(e,t){const n=Xi.t.clone(cw);let i=!1,s=!1;return t.units.forEach(e=>{!i&&Gi.Nf.isAtomic(e)&&e.nucleotideElements.length&&(i=!0),!s&&e.gapElements.length&&(s=!0)}),n.visuals.defaultValue=["polymer-tube"],s&&n.visuals.defaultValue.push("polymer-gap"),n},defaultValues:Xi.t.getDefaultValues(cw),defaultColorTheme:{name:"chain-id"},defaultSizeTheme:{name:"uncertainty"},isApplicable:e=>e.polymerResidueCount>0}),dw={"element-sphere":(e,t)=>(0,mm.T)("Sphere mesh/impostor",e,t,dm),"structure-element-sphere":(e,t)=>(0,gm.Kp)("Structure sphere mesh/impostor",e,t,pm)},hw={...um,bumpFrequency:Xi.t.Numeric(1,{min:0,max:10,step:.1},Vi.iy.ShadingCategory),density:Xi.t.Numeric(.5,{min:0,max:1,step:.01},Vi.iy.ShadingCategory),visuals:Xi.t.MultiSelect(["element-sphere"],Xi.t.objectToOptions(dw))};let pw;const mw=(0,gm.GT)({name:"spacefill",label:"Spacefill",description:"Displays atomic/coarse elements as spheres.",factory:function(e,t){return Er.YL.createMulti("Spacefill",e,t,gm.J1,dw)},getParams:function(e,t){let n=hw;return t.isCoarseGrained&&(pw||(pw=Xi.t.clone(hw),pw.sizeFactor.defaultValue=2),n=pw),t.unitSymmetryGroups.length>5e3&&(n=Xi.t.clone(n),n.visuals.defaultValue=["structure-element-sphere"]),n},defaultValues:Xi.t.getDefaultValues(hw),defaultColorTheme:{name:"element-symbol"},defaultSizeTheme:{name:"physical"},isApplicable:e=>e.elementCount>0}),fw=np.I$.is;function gw(e,t,n,i){const s=Gi.iZ.Location.create(t,e),r=e.elements,o=e.bonds,{edgeCount:a,a:l,b:c,edgeProps:u,offset:d}=o,{order:h,flags:p}=u,{sizeFactor:m,aromaticBonds:f,includeTypes:g,excludeTypes:y,multipleBonds:v}=i,b="off"===v,x="symmetric"===v,S=up(np.I$.fromNames(g),np.I$.fromNames(y),np.I$.Flag.Computed),C=(0,Go.eB)(),w=e.conformation,{elementRingIndices:k,elementAromaticRingIndices:B}=e.rings,P=f?e.resonance.delocalizedTriplets:void 0;return{linkCount:2*a,referencePosition:e=>{let t=l[e],n=c[e];const i=null==P?void 0:P.getThirdElement(t,n);if(void 0!==i)return w.invariantPosition(r[i],C);t>n&&([t,n]=[n,t]),d[t+1]-d[t]===1&&([t,n]=[n,t]);const s=B.get(t)||k.get(t);let o=0;for(let a=d[t],l=d[t+1];a<l;++a){const e=c[a];if(e!==n&&e!==t){if(!s)return w.invariantPosition(r[e],C);{const t=B.get(e)||k.get(e);if(!t)continue;const n=(0,wr.u$)(s,t);n>o&&(o=n,w.invariantPosition(r[e],C))}}}return o>0?C:null},position:(e,t,n,i)=>{w.invariantPosition(r[l[n]],e),w.invariantPosition(r[c[n]],t)},style:e=>{const t=h[e],n=p[e];if(fw(n,np.I$.Flag.MetallicCoordination)||fw(n,np.I$.Flag.HydrogenBond))return ep.gK.Dashed;if(3===t)return b?ep.gK.Solid:x?ep.gK.Triple:ep.gK.OffsetTriple;if(f){const t=l[e],i=c[e],s=B.get(t),r=B.get(i),o=s&&r?(0,wr.u$)(s,r):0;if(fw(n,np.I$.Flag.Aromatic)||o&&!S)return 2===o?ep.gK.MirroredAromatic:ep.gK.Aromatic}return 2!==t||b?ep.gK.Solid:x?ep.gK.Double:ep.gK.OffsetDouble},radius:e=>{s.element=r[l[e]];const t=n.size.size(s);s.element=r[c[e]];const i=n.size.size(s);return Math.min(t,i)*m},ignore:dp(t,e,i)}}function yw(e,t,n,i,s,r){if(!Gi.Nf.isAtomic(t))return sC.q.createEmpty(r);if(!pp(t,s))return sC.q.createEmpty(r);if(!t.bonds.edgeCount)return sC.q.createEmpty(r);const{child:o}=n,a=null==o?void 0:o.unitMap.get(t.id);if(o&&!a)return sC.q.createEmpty(r);const l=gw(t,n,i,s),{lines:c,boundingSphere:u}=(0,ep.Yz)(e,l,s,r);if(u)c.setBoundingSphere(u);else if(c.lineCount>0){const e=Dd.f8.expand((0,Dd.f8)(),(null!=a?a:t).boundary.sphere,1*s.sizeFactor);c.setBoundingSphere(e)}return c}const vw={...tp.zj,...cp,includeParent:Xi.t.Boolean(!1)};function bw(e){return(0,tp.zK)({defaultProps:Xi.t.getDefaultValues(vw),createGeometry:yw,createLocationIterator:e=>fp.fromGroup(e),getLoci:gp,eachLocation:yp,setUpdateState:(e,t,n,i,s,r,o)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.linkScale!==n.linkScale||t.linkSpacing!==n.linkSpacing||t.aromaticDashCount!==n.aromaticDashCount||t.dashCount!==n.dashCount||t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||!(0,a.af)(t.includeTypes,n.includeTypes)||!(0,a.af)(t.excludeTypes,n.excludeTypes)||t.aromaticBonds!==n.aromaticBonds||t.multipleBonds!==n.multipleBonds;const l=r.group.units[0],c=o.group.units[0];Gi.Nf.isAtomic(l)&&Gi.Nf.isAtomic(c)&&(wp.O.areEqual(l.bonds,c.bonds)||(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.updateSize=!0))}},e)}function xw(e,t,n,i,s){if(!mp(t,i))return sC.q.createEmpty(s);if(!t.intraUnitBondMapping.bondCount)return sC.q.createEmpty(s);const r=function(e,t,n){const i=[],{bondCount:s,unitIndex:r,unitEdgeIndex:o,unitGroupIndex:a}=e.intraUnitBondMapping,{child:l}=e;for(const c of e.unitSymmetryGroups){const s=c.units[0],r=null==l?void 0:l.unitMap.get(s.id),o=!Gi.Nf.isAtomic(s)||l&&!r?ep.Js:gw(s,e,t,n);i.push({group:c,props:o})}return{linkCount:s,referencePosition:e=>{const{group:t,props:n}=i[r[e]];if(!n.referencePosition)return null;const s=n.referencePosition(o[e]);if(!s)return null;const l=t.units[a[e]];return Go.eB.transformMat4(s,s,l.conformation.operator.matrix),s},position:(e,t,n,s)=>{const{group:l,props:c}=i[r[n]];c.position(e,t,o[n],s);const u=l.units[a[n]];Go.eB.transformMat4(e,e,u.conformation.operator.matrix),Go.eB.transformMat4(t,t,u.conformation.operator.matrix)},style:e=>{const{props:t}=i[r[e]];return t.style?t.style(o[e]):ep.gK.Solid},radius:e=>{const{props:t}=i[r[e]];return t.radius(o[e])},ignore:e=>{const{props:t}=i[r[e]];return!!t.ignore&&t.ignore(o[e])},stub:e=>{const{props:t}=i[r[e]];return!!t.stub&&t.stub(o[e])}}}(t,n,i),{lines:o,boundingSphere:a}=(0,ep.Yz)(e,r,i,s);if(a)o.setBoundingSphere(a);else if(o.lineCount>0){const{child:e}=t,n=Dd.f8.expand((0,Dd.f8)(),(null!=e?e:t).boundary.sphere,1*i.sizeFactor);o.setBoundingSphere(n)}return o}const Sw={...Pp.YD,...cp,includeParent:Xi.t.Boolean(!1)};function Cw(e){return(0,Pp.yd)({defaultProps:Xi.t.getDefaultValues(Sw),createGeometry:xw,createLocationIterator:(e,t)=>mp(e,t)?fp.fromStructureGroups(e):ip.FL,getLoci:Sp,eachLocation:Cp,setUpdateState:(e,t,n,i,s,r,o)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.linkScale!==n.linkScale||t.linkSpacing!==n.linkSpacing||t.aromaticDashCount!==n.aromaticDashCount||t.dashCount!==n.dashCount||t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||!(0,a.af)(t.includeTypes,n.includeTypes)||!(0,a.af)(t.excludeTypes,n.excludeTypes)||t.multipleBonds!==n.multipleBonds,mp(r,t)&&r.interUnitBonds!==o.interUnitBonds&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.updateSize=!0)}},e)}const ww=new Gi.gn.ElementBondIterator;function kw(e,t,n,i){for(ww.setElement(t,n,i);ww.hasNext;){const t=ww.move();return t.otherUnit.conformation.position(t.otherUnit.elements[t.otherIndex],e),e}return null}function Bw(e,t,n,i,s){if(!mp(t,i))return sC.q.createEmpty(s);if(!t.interUnitBonds.edgeCount)return sC.q.createEmpty(s);const r=function(e,t,n){const i=e.interUnitBonds,{edgeCount:s,edges:r}=i,{sizeFactor:o,aromaticBonds:l,multipleBonds:c}=n,u="off"===c,d="symmetric"===c,h=(0,Go.eB)(),p=Gi.iZ.Location.create();return{linkCount:s,referencePosition:t=>{const n=r[t];let i,s,o,a;if(n.unitA<n.unitB)i=e.unitMap.get(n.unitA),s=e.unitMap.get(n.unitB),o=n.indexA,a=n.indexB;else{if(!(n.unitA>n.unitB))throw new Error("same units in createInterUnitBondLines");i=e.unitMap.get(n.unitB),s=e.unitMap.get(n.unitA),o=n.indexB,a=n.indexA}return kw(h,e,i,o)||kw(h,e,s,a)},position:(t,n,i,s)=>{const o=r[i],a=e.unitMap.get(o.unitA),l=e.unitMap.get(o.unitB);a.conformation.position(a.elements[o.indexA],t),l.conformation.position(l.elements[o.indexB],n)},style:e=>{const t=r[e].props.order,n=a.NJ.create(r[e].props.flag);return np.I$.is(n,np.I$.Flag.MetallicCoordination)||np.I$.is(n,np.I$.Flag.HydrogenBond)?ep.gK.Dashed:3===t?u?ep.gK.Solid:d?ep.gK.Triple:ep.gK.OffsetTriple:l&&np.I$.is(n,np.I$.Flag.Aromatic)?ep.gK.Aromatic:2!==t||u?ep.gK.Solid:d?ep.gK.Double:ep.gK.OffsetDouble},radius:n=>{const i=r[n];p.structure=e,p.unit=e.unitMap.get(i.unitA),p.element=p.unit.elements[i.indexA];const s=t.size.size(p);p.unit=e.unitMap.get(i.unitB),p.element=p.unit.elements[i.indexB];const a=t.size.size(p);return Math.min(s,a)*o},ignore:hp(e,n)}}(t,n,i),{lines:o,boundingSphere:l}=(0,ep.Yz)(e,r,i,s);if(l)o.setBoundingSphere(l);else if(o.lineCount>0){const{child:e}=t,n=Dd.f8.expand((0,Dd.f8)(),(null!=e?e:t).boundary.sphere,1*i.sizeFactor);o.setBoundingSphere(n)}return o}const Pw={...Pp.YD,...cp,includeParent:Xi.t.Boolean(!1)};function Iw(e){return(0,Pp.yd)({defaultProps:Xi.t.getDefaultValues(Pw),createGeometry:Bw,createLocationIterator:(e,t)=>mp(e,t)?fp.fromStructure(e):ip.FL,getLoci:vp,eachLocation:xp,setUpdateState:(e,t,n,i,s,r,o)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.linkScale!==n.linkScale||t.linkSpacing!==n.linkSpacing||t.aromaticDashCount!==n.aromaticDashCount||t.dashCount!==n.dashCount||t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||!(0,a.af)(t.includeTypes,n.includeTypes)||!(0,a.af)(t.excludeTypes,n.excludeTypes)||t.multipleBonds!==n.multipleBonds,mp(r,t)&&r.interUnitBonds!==o.interUnitBonds&&(e.createGeometry=!0,e.updateTransform=!0,e.updateColor=!0,e.updateSize=!0)}},e)}var jw=n(91852),Tw=n(64592);const Aw=Go.eB.add,Mw=Go.eB.scaleAndAdd,Lw=Go.eB.unitX,Ew=Go.eB.unitY,Dw=Go.eB.unitZ,Nw={...tp.zj,lineSizeAttenuation:Xi.t.Boolean(!1),ignoreHydrogens:Xi.t.Boolean(!1),ignoreHydrogensVariant:Xi.t.Select("all",Xi.t.arrayToOptions(["all","non-polar"])),traceOnly:Xi.t.Boolean(!1),crosses:Xi.t.Select("lone",Xi.t.arrayToOptions(["lone","all"])),crossSize:Xi.t.Numeric(.35,{min:0,max:2,step:.01})};function Fw(e,t,n,i,s,r){const{child:o}=n;if(o&&!o.unitMap.get(t.id))return sC.q.createEmpty(r);const a=t.elements,l=a.length,c=jw.d.create(l,l/10,r),u=(0,Go.eB)(),d=(0,Go.eB)(),h=(0,Go.eB)(),p=t.conformation,m=Jp(n,t,s),f=s.crossSize/2,g="lone"===s.crosses,y=(0,Go.eB)();let v=0;for(let C=0;C<l;++C)m&&m(a[C])||g&&Gi.Nf.isAtomic(t)&&pp(t,s)&&0!==(0,Tw.Hm)(n,t,C)||(p.invariantPosition(a[C],u),Aw(y,y,u),v+=1,Mw(d,u,Lw,f),Mw(h,u,Lw,-f),c.add(d[0],d[1],d[2],h[0],h[1],h[2],C),Mw(d,u,Ew,f),Mw(h,u,Ew,-f),c.add(d[0],d[1],d[2],h[0],h[1],h[2],C),Mw(d,u,Dw,f),Mw(h,u,Dw,-f),c.add(d[0],d[1],d[2],h[0],h[1],h[2],C));const b=c.getLines();if(0===v)return b;let x;Go.eB.scale(y,y,1/v);const S=r?Dd.f8.clone(r.boundingSphere):void 0;return x=S&&Go.eB.distance(y,S.center)/S.radius<.1?S:Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*s.sizeFactor),b.setBoundingSphere(x),b}function Rw(e){return(0,tp.zK)({defaultProps:Xi.t.getDefaultValues(Nw),createGeometry:Fw,createLocationIterator:lm.fromGroup,getLoci:im,eachLocation:nm,setUpdateState:(e,t,n)=>{e.createGeometry=t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||t.traceOnly!==n.traceOnly||t.crosses!==n.crosses||t.crossSize!==n.crossSize}},e)}function Ow(e,t,n,i,s){const{child:r}=t,{getSerialIndex:o}=t.serialMapping,a=t.elementCount,l=jw.d.create(a,a/2,s),c=(0,Go.eB)(),u=(0,Go.eB)(),d=(0,Go.eB)(),h=i.crossSize/2,p="lone"===i.crosses,m=(0,Go.eB)();let f=0;for(const b of t.units){const e=null==r?void 0:r.unitMap.get(b.id);if(r&&!e)return sC.q.createEmpty(s);const{elements:n,conformation:a}=b,g=n.length,y=Jp(t,b,i);for(let s=0;s<g;s++){if(y&&y(n[s]))continue;if(p&&Gi.Nf.isAtomic(b)&&pp(b,i)&&0!==(0,Tw.Hm)(t,b,s))continue;a.position(n[s],c),Aw(m,m,c),f+=1;const e=o(b,n[s]);Mw(u,c,Lw,h),Mw(d,c,Lw,-h),l.add(u[0],u[1],u[2],d[0],d[1],d[2],e),Mw(u,c,Ew,h),Mw(d,c,Ew,-h),l.add(u[0],u[1],u[2],d[0],d[1],d[2],e),Mw(u,c,Dw,h),Mw(d,c,Dw,-h),l.add(u[0],u[1],u[2],d[0],d[1],d[2],e)}}const g=l.getLines();if(0===f)return g;let y;Go.eB.scale(m,m,1/f);const v=s?Dd.f8.clone(s.boundingSphere):void 0;return y=v&&Go.eB.distance(m,v.center)/v.radius<1?v:Dd.f8.expand((0,Dd.f8)(),(null!=r?r:t).boundary.sphere,1*i.sizeFactor),g.setBoundingSphere(y),g}const zw={...Pp.YD,lineSizeAttenuation:Xi.t.Boolean(!1),ignoreHydrogens:Xi.t.Boolean(!1),ignoreHydrogensVariant:Xi.t.Select("all",Xi.t.arrayToOptions(["all","non-polar"])),traceOnly:Xi.t.Boolean(!1),crosses:Xi.t.Select("lone",Xi.t.arrayToOptions(["lone","all"])),crossSize:Xi.t.Numeric(.35,{min:0,max:2,step:.01})};function Hw(e){return(0,Pp.yd)({defaultProps:Xi.t.getDefaultValues(zw),createGeometry:Ow,createLocationIterator:lm.fromStructure,getLoci:am,eachLocation:om,setUpdateState:(e,t,n)=>{e.createGeometry=t.ignoreHydrogens!==n.ignoreHydrogens||t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant||t.traceOnly!==n.traceOnly||t.crosses!==n.crosses||t.crossSize!==n.crossSize}},e)}const Uw={"intra-bond":(e,t)=>(0,mm.T)("Intra-unit bond line",e,t,bw),"inter-bond":(e,t)=>(0,fm.K)("Inter-unit bond line",e,t,Iw),"element-point":(e,t)=>(0,mm.T)("Points",e,t,XC),"element-cross":(e,t)=>(0,mm.T)("Crosses",e,t,Rw),"structure-intra-bond":(e,t)=>(0,fm.K)("Structure intra-unit bond line",e,t,Cw),"structure-element-point":(e,t)=>(0,fm.K)("Structure element points",e,t,JC),"structure-element-cross":(e,t)=>(0,fm.K)("Structure element crosses",e,t,Hw)},Vw={...vw,...Pw,...KC,...Nw,pointStyle:Xi.t.Select("circle",Xi.t.objectToOptions(qC.O.StyleTypes)),multipleBonds:Xi.t.Select("offset",Xi.t.arrayToOptions(["off","symmetric","offset"])),includeParent:Xi.t.Boolean(!1),sizeFactor:Xi.t.Numeric(2,{min:.01,max:10,step:.01}),unitKinds:(0,ym.R8)(["atomic"]),visuals:Xi.t.MultiSelect(["intra-bond","inter-bond","element-point","element-cross"],Xi.t.objectToOptions(Uw)),density:Xi.t.Numeric(.1,{min:0,max:1,step:.01},Vi.iy.ShadingCategory)};const _w=(0,gm.GT)({name:"line",label:"Line",description:"Displays bonds as lines and atoms as points or croses.",factory:function(e,t){return Er.YL.createMulti("Line",e,t,gm.J1,Uw)},getParams:function(e,t){let n=Vw;return Gi.Structure.getSize(t)>=Gi.Structure.Size.Huge?(n=Xi.t.clone(n),n.visuals.defaultValue=["intra-bond","element-point","element-cross"]):t.unitSymmetryGroups.length>5e3&&(n=Xi.t.clone(n),n.visuals.defaultValue=["structure-intra-bond","structure-element-point","structure-element-cross"]),n},defaultValues:Xi.t.getDefaultValues(Vw),defaultColorTheme:{name:"element-symbol"},defaultSizeTheme:{name:"uniform"},isApplicable:e=>e.elementCount>0,getData:(e,t)=>t.includeParent?e.asParent():e,mustRecreate:(e,t)=>e.includeParent!==t.includeParent});var Gw=n(84194);function qw(e,t,n,i,s){const{webgl:r}=e;if(!r)throw new Error("GaussianDensityVolume requires `webgl`");const o=Go.eB.create(0,1,2),a={min:0,max:1,mean:.04,sigma:.01},l=e=>{const s=e?e.gridTexture.ref.value:void 0,l=function(e,t,n,i,s){const{position:r,boundary:o,radius:a}=(0,op.oc)(e,t,n),l=(0,op.FC)(o.box,n);return kS(i,r,o.box,a,l,s)}(t,n.size,i,r,s),{transform:c,texture:u,bbox:d,gridDim:h}=l,p=Go.$I.mul((0,Go.$I)(),c,Go.$I.fromScaling((0,Go.$I)(),h)),m=Go.$I.getScaling((0,Go.eB)(),c),f=Gw.E.create(d,h,c,p,m,u,a,!0,o,"byte",e),g=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,l.maxRadius);return f.setBoundingSphere(g),f},c=l(s);return c.meta.reset=()=>{l(c)},c}const $w={...Pp.I,...RS,ignoreHydrogens:Xi.t.Boolean(!1),ignoreHydrogensVariant:Xi.t.Select("all",Xi.t.arrayToOptions(["all","non-polar"])),includeParent:Xi.t.Boolean(!1,{isHidden:!0})};function Zw(e){return(0,Pp.Yl)({defaultProps:Xi.t.getDefaultValues($w),createGeometry:qw,createLocationIterator:lm.fromStructure,getLoci:am,eachLocation:om,setUpdateState:(e,t,n)=>{t.resolution!==n.resolution&&(e.createGeometry=!0),t.radiusOffset!==n.radiusOffset&&(e.createGeometry=!0),t.smoothness!==n.smoothness&&(e.createGeometry=!0),t.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),t.traceOnly!==n.traceOnly&&(e.createGeometry=!0),t.includeParent!==n.includeParent&&(e.createGeometry=!0)},dispose:e=>{e.gridTexture.ref.value.destroy()}},e)}function Kw(e,t,n,i,s,r){const{webgl:o}=e;if(!o)throw new Error("GaussianDensityVolume requires `webgl`");const a=Go.eB.create(0,1,2),l={min:0,max:1,mean:.04,sigma:.01},c=e=>{const r=e?e.gridTexture.ref.value:void 0,c=function(e,t,n,i,s,r){const{position:o,boundary:a,radius:l}=(0,op.LT)(e,t,n,i),c=(0,op.FC)(a.box,i,OS(s,e));return kS(s,o,a.box,l,c,r)}(n,t,i.size,s,o,r),{transform:u,texture:d,bbox:h,gridDim:p}=c,m=Go.$I.mul((0,Go.$I)(),u,Go.$I.fromScaling((0,Go.$I)(),p)),f=Go.$I.getScaling((0,Go.eB)(),u),g=Gw.E.create(h,p,u,m,f,d,l,!0,a,"byte",e),y=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,c.maxRadius);return g.setBoundingSphere(y),g},u=c(r);return u.meta.reset=()=>{c(u)},u}const Qw={...tp.Ny,...RS,ignoreHydrogens:Xi.t.Boolean(!1),ignoreHydrogensVariant:Xi.t.Select("all",Xi.t.arrayToOptions(["all","non-polar"])),includeParent:Xi.t.Boolean(!1,{isHidden:!0})};function Xw(e){return(0,tp.Pi)({defaultProps:Xi.t.getDefaultValues(Qw),createGeometry:Kw,createLocationIterator:lm.fromGroup,getLoci:im,eachLocation:nm,setUpdateState:(e,t,n)=>{t.resolution!==n.resolution&&(e.createGeometry=!0),t.radiusOffset!==n.radiusOffset&&(e.createGeometry=!0),t.smoothness!==n.smoothness&&(e.createGeometry=!0),t.ignoreHydrogens!==n.ignoreHydrogens&&(e.createGeometry=!0),t.ignoreHydrogensVariant!==n.ignoreHydrogensVariant&&(e.createGeometry=!0),t.traceOnly!==n.traceOnly&&(e.createGeometry=!0),t.includeParent!==n.includeParent&&(e.createGeometry=!0)},dispose:e=>{e.gridTexture.ref.value.destroy()}},e)}const Ww={"gaussian-volume":(e,t)=>(0,gm.Kp)("Gaussian volume",e,t,Zw),"units-gaussian-volume":(e,t)=>(0,gm.TP)("Units-Gaussian volume",e,t,Xw)},Yw={...$w,jumpLength:Xi.t.Numeric(4,{min:0,max:20,step:.1}),visuals:Xi.t.MultiSelect(["gaussian-volume"],Xi.t.objectToOptions(Ww))};const Jw=(0,gm.GT)({name:"gaussian-volume",label:"Gaussian Volume",description:"Displays a gaussian molecular density using direct volume rendering.",factory:function(e,t){return Er.YL.createMulti("Gaussian Volume",e,t,gm.J1,Ww)},getParams:function(e,t){return Yw},defaultValues:Xi.t.getDefaultValues(Yw),defaultColorTheme:{name:"chain-id"},defaultSizeTheme:{name:"physical"},isApplicable:e=>e.elementCount>0}),ek=Go.eB.scale,tk=Go.eB.add,nk=Go.eB.sub,ik={...tp.Te,...tp.lm,sizeFactor:Xi.t.Numeric(.3,{min:0,max:10,step:.01}),radialSegments:Xi.t.Numeric(16,{min:2,max:56,step:2},Vi.iy.CustomQualityParamInfo),tryUseImpostor:Xi.t.Boolean(!0)};function sk(e,t,n,i){return n.tryUseImpostor&&(0,op.VZ)(i)?function(e){return(0,tp.Vb)({defaultProps:Xi.t.getDefaultValues(ik),createGeometry:rk,createLocationIterator:e=>Rg.fromGroup(e),getLoci:Hg,eachLocation:Gg,setUpdateState:(e,t,n)=>{},mustRecreate:(e,t,n)=>!t.tryUseImpostor||!n},e)}(e):function(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(ik),createGeometry:ok,createLocationIterator:e=>Rg.fromGroup(e),getLoci:Hg,eachLocation:Gg,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.radialSegments!==n.radialSegments},mustRecreate:(e,t,n)=>t.tryUseImpostor&&!!n},e)}(e)}function rk(e,t,n,i,s,r){const o=t.polymerElements.length;if(!o)return kp.S.createEmpty(r);const a=2*o,l=Tv.h.create(a,a/4,r),c=t.conformation,u=(0,Go.eB)(),d=(0,Go.eB)(),h=(0,Go.eB)();Ff(t,function(e,t,n,i,s){c.invariantPosition(e,u),c.invariantPosition(t,d);const r=(0,np.OV)(s)?Dg:Eg;tk(h,u,ek(h,nk(h,d,u),r)),l.add(u[0],u[1],u[2],h[0],h[1],h[2],1,!1,!1,2,n),l.add(h[0],h[1],h[2],d[0],d[1],d[2],1,!1,!1,2,i)});const p=l.getCylinders(),m=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*s.sizeFactor);return p.setBoundingSphere(m),p}function ok(e,t,n,i,s,r){const o=t.polymerElements.length;if(!o)return Jh.e.createEmpty(r);const{radialSegments:a,sizeFactor:l}=s,c=2*a*o*2,u=Kp.P.createState(c,c/10,r),d=t.conformation,h=(0,Go.eB)(),p=(0,Go.eB)(),m={radiusTop:1,radiusBottom:1,radialSegments:a},f=Gi.iZ.Location.create(n,t),g=Gi.iZ.Location.create(n,t);Ff(t,function(e,t,n,s,r){f.element=e,g.element=t,d.invariantPosition(f.element,h),d.invariantPosition(g.element,p);const o=(0,np.OV)(r)?Dg:Eg;m.radiusTop=m.radiusBottom=i.size.size(f)*l,u.currentGroup=n,(0,Df.y9)(u,h,p,o,m),m.radiusTop=m.radiusBottom=i.size.size(g)*l,u.currentGroup=s,(0,Df.y9)(u,p,h,1-o,m)});const y=Kp.P.getMesh(u),v=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*s.sizeFactor);return y.setBoundingSphere(v),y}const ak={...tp.Te,...tp.qg,sizeFactor:Xi.t.Numeric(.3,{min:0,max:10,step:.01}),detail:Xi.t.Numeric(0,{min:0,max:3,step:1},Vi.iy.CustomQualityParamInfo),tryUseImpostor:Xi.t.Boolean(!0)};function lk(e,t,n,i){return n.tryUseImpostor&&(0,op.gU)(i)?function(e){return(0,tp.uF)({defaultProps:Xi.t.getDefaultValues(ak),createGeometry:ck,createLocationIterator:e=>Rg.fromGroup(e),getLoci:Hg,eachLocation:Gg,setUpdateState:(e,t,n)=>{},mustRecreate:(e,t,n)=>!t.tryUseImpostor||!n},e)}(e):function(e){return(0,tp.Pv)({defaultProps:Xi.t.getDefaultValues(ak),createGeometry:uk,createLocationIterator:e=>Rg.fromGroup(e),getLoci:Hg,eachLocation:Gg,setUpdateState:(e,t,n)=>{e.createGeometry=t.sizeFactor!==n.sizeFactor||t.detail!==n.detail},mustRecreate:(e,t,n)=>t.tryUseImpostor&&!!n},e)}(e)}function ck(e,t,n,i,s,r){const o=t.polymerElements.length;if(!o)return Xp.v.createEmpty(r);const a=Wp.Q.create(o,o/2,r),l=t.conformation,c=(0,Go.eB)();Rf(t,(e,t)=>{l.invariantPosition(e,c),a.add(c[0],c[1],c[2],t)});const u=a.getSpheres(),d=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*s.sizeFactor);return u.setBoundingSphere(d),u}function uk(e,t,n,i,s,r){const o=t.polymerElements.length;if(!o)return Jh.e.createEmpty(r);const{detail:a,sizeFactor:l}=s,c=o*(0,Zp.J)(a),u=Kp.P.createState(c,c/2,r),d=t.conformation,h=(0,Go.eB)(),p=Gi.iZ.Location.create(n,t);Rf(t,(e,t)=>{p.element=e,d.invariantPosition(p.element,h),u.currentGroup=t,(0,Qp.X)(u,h,i.size.size(p)*l,a)});const m=Kp.P.getMesh(u),f=Dd.f8.expand((0,Dd.f8)(),t.boundary.sphere,1*s.sizeFactor);return m.setBoundingSphere(f),m}const dk={"polymer-backbone-cylinder":(e,t)=>(0,mm.T)("Polymer backbone cylinder",e,t,sk),"polymer-backbone-sphere":(e,t)=>(0,mm.T)("Polymer backbone sphere",e,t,lk),"polymer-gap":(e,t)=>(0,mm.T)("Polymer gap cylinder",e,t,Eb)},hk={...ak,...ik,...Lb,sizeAspectRatio:Xi.t.Numeric(1,{min:.1,max:3,step:.1}),visuals:Xi.t.MultiSelect(["polymer-backbone-cylinder","polymer-backbone-sphere","polymer-gap"],Xi.t.objectToOptions(dk)),bumpFrequency:Xi.t.Numeric(0,{min:0,max:10,step:.1},Vi.iy.ShadingCategory),density:Xi.t.Numeric(.1,{min:0,max:1,step:.01},Vi.iy.ShadingCategory),colorMode:Xi.t.Select("default",Xi.t.arrayToOptions(["default","interpolate"]),{...Vi.iy.ShadingCategory,isHidden:!0})};const pk=(0,gm.GT)({name:"backbone",label:"Backbone",description:"Displays polymer backbone with cylinders and spheres.",factory:function(e,t){return Er.YL.createMulti("Backbone",e,t,gm.J1,dk)},getParams:function(e,t){const n=Xi.t.clone(hk);let i=!1;return t.units.forEach(e=>{!i&&e.gapElements.length&&(i=!0)}),n.visuals.defaultValue=["polymer-backbone-cylinder","polymer-backbone-sphere"],i&&n.visuals.defaultValue.push("polymer-gap"),n},defaultValues:Xi.t.getDefaultValues(hk),defaultColorTheme:{name:"chain-id"},defaultSizeTheme:{name:"uniform"},isApplicable:e=>e.polymerResidueCount>0});var mk=n(78290),fk=n(39622),gk=n(98391),yk=n(3622),vk=n(69292),bk=n(75849);const xk=Go.eB.set,Sk=Go.eB.transformMat4,Ck=Go.eB.squaredDistance,wk={...Pp.m7,interpolation:Xi.t.Select("nearest",Xi.t.objectToOptions(mk.On)),imageResolution:Xi.t.Numeric(.5,{min:.01,max:20,step:.01},{description:"Grid resolution/cell spacing.",...Vi.iy.CustomQualityParamInfo}),mode:Xi.t.Select("frame",Xi.t.arrayToOptions(["frame","plane"]),{description:"Frame: slice through the structure along arbitrary axes in any step size. Plane: an arbitrary plane defined by point and normal."}),offset:Xi.t.Numeric(0,{min:-1,max:1,step:.01},{isEssential:!0,immediateUpdate:!0,hideIf:e=>"frame"!==e.mode,description:"Relative offset from center."}),axis:Xi.t.Select("c",Xi.t.arrayToOptions(["a","b","c"]),{isEssential:!0,hideIf:e=>"frame"!==e.mode}),rotation:Xi.t.Group({axis:Xi.t.Vec3(Go.eB.create(1,0,0),{},{description:"Axis of rotation"}),angle:Xi.t.Numeric(0,{min:-180,max:180,step:1},{immediateUpdate:!0,description:"Axis rotation angle in Degrees"})},{isExpanded:!0,hideIf:e=>"frame"!==e.mode}),plane:Xi.t.Group({point:Xi.t.Vec3(Go.eB.create(0,0,0),{},{description:"Plane point"}),normal:Xi.t.Vec3(Go.eB.create(1,0,0),{},{description:"Plane normal"})},{isExpanded:!0,hideIf:e=>"plane"!==e.mode}),extent:Xi.t.Select("frame",Xi.t.arrayToOptions(["frame","sphere"]),{description:"Extent of the plane, either box (frame) or sphere."}),margin:Xi.t.Numeric(4,{min:0,max:50,step:1},{immediateUpdate:!0,description:"Margin around the structure in Angstrom"}),frame:Xi.t.Select("principalAxes",Xi.t.arrayToOptions(["principalAxes","boundingBox"])),antialias:Xi.t.Boolean(!0,{description:"Antialiasing of structure edges."}),cutout:Xi.t.Boolean(!1,{description:"Cutout the structure from the image."}),defaultColor:Xi.t.Color((0,gk.Q1)(13421772),{description:"Default color for parts of the image that are not covered by the color theme."}),includeParent:Xi.t.Boolean(!1,{description:"Show parent structure (but within extent of this structure)."})};function kk(e){return(0,Pp.cT)({defaultProps:Xi.t.getDefaultValues(wk),createGeometry:Bk,createLocationIterator:lm.fromStructure,getLoci:am,eachLocation:om,setUpdateState:(e,t,n,i,s)=>{e.createGeometry=!(t.imageResolution===n.imageResolution&&t.mode===n.mode&&t.margin===n.margin&&t.frame===n.frame&&t.extent===n.extent&&Go.eB.equals(t.rotation.axis,n.rotation.axis)&&t.rotation.angle===n.rotation.angle&&t.offset===n.offset&&t.axis===n.axis&&Go.eB.equals(t.plane.point,n.plane.point)&&Go.eB.equals(t.plane.normal,n.plane.normal)&&t.antialias===n.antialias&&t.cutout===n.cutout&&t.defaultColor===n.defaultColor&&yk.J.areEqual(i.color,s.color)&&Bp.F.areEqual(i.size,s.size))}},e)}function Bk(e,t,n,i,s){const{imageResolution:r,offset:o,antialias:a,cutout:l,defaultColor:c}=i,u=1/r,d="color"in n.color&&n.color.color?n.color.color:()=>(0,gk.Q1)(16777215),{size:h,major:p,minor:m,normal:f,center:g,trim:y}=function(e,t){const{mode:n,axis:i,frame:s,extent:r,margin:o,rotation:a,plane:l,includeParent:c}=t;c&&e.child&&(e=e.child);const u=(0,Go.eB)(),d=(0,Go.eB)(),h=(0,Go.eB)(),p=(0,Go.eB)(),m=(0,Go.eB)(),f=(0,Go.eB)();let g,y,v,b=0,x=0,S=0;if("principalAxes"===s){const t=Gi.Structure.getPrincipalAxes(e).boxAxes;[b,x,S]=Dd.n.size((0,Go.eB)(),t),g=t.dirA,y=t.dirB,v=t.dirC,Go.eB.copy(f,t.origin)}else[b,x,S]=Dd.DJ.size((0,Go.eB)(),e.boundary.box),g=Go.eB.create(1,0,0),y=Go.eB.create(0,1,0),v=Go.eB.create(0,0,1),Go.eB.copy(f,e.boundary.sphere.center);if(Go.eB.set(d,b,x,S),"c"===i?(Go.eB.set(u,b,x,S),Go.eB.copy(h,g),Go.eB.copy(p,y),Go.eB.copy(m,v)):"b"===i?(Go.eB.set(u,b,S,x),Go.eB.copy(h,g),Go.eB.copy(m,y),Go.eB.copy(p,v)):(Go.eB.set(u,x,S,b),Go.eB.copy(m,g),Go.eB.copy(h,y),Go.eB.copy(p,v)),0!==a.angle){const e=(0,Go.eB)();Go.eB.scaleAndAdd(e,e,g,a.axis[0]),Go.eB.scaleAndAdd(e,e,y,a.axis[1]),Go.eB.scaleAndAdd(e,e,v,a.axis[2]),Go.eB.normalize(e,e);const t=Go.$I.fromRotation((0,Go.$I)(),(0,bk.pu)(a.angle),e);Go.eB.transformDirection(h,h,t),Go.eB.transformDirection(p,p,t),Go.eB.transformDirection(m,m,t)}if("sphere"===r||0!==a.angle){const t=2*e.boundary.sphere.radius,n=Go.eB.magnitude(Dd.DJ.size((0,Go.eB)(),Dd.DJ.fromSphere3D((0,Dd.DJ)(),e.boundary.sphere)));Go.eB.set(u,n,n,t),"sphere"===r&&Go.eB.set(d,t,t,t)}Go.eB.addScalar(u,u,2*o),Go.eB.addScalar(d,d,2*o);const C=Go.k.identity();return"principalAxes"===s&&Go.k.fromBasis(C,Go.eB.normalize((0,Go.eB)(),g),Go.eB.normalize((0,Go.eB)(),y),Go.eB.normalize((0,Go.eB)(),v)),"plane"===n&&(Go.eB.copy(f,l.point),Go.eB.copy(m,l.normal),Go.eB.cross(h,m,Go.eB.unitX),Go.eB.dot(h,h)<Go.p8&&Go.eB.cross(h,m,Go.eB.unitY),Go.eB.normalize(h,h),Go.eB.cross(p,m,h),Go.eB.normalize(p,p)),{size:u,major:h,minor:p,normal:m,center:f,trim:{type:"sphere"===r?2:3,center:f,scale:d,rotation:C,transform:Go.$I.identity()}}}(t,i),v=Go.eB.create(h[0],h[1],1),b=Go.eB.setMagnitude((0,Go.eB)(),f,h[2]/2),x=Math.floor(h[1]*u),S=Math.floor(h[0]*u),C=Go.$I.identity(),w=(0,Go.eB)(),k=(0,Go.eB)();Go.eB.add(w,g,p),Go.$I.targetTo(C,g,w,m),Go.eB.scaleAndAdd(k,g,b,o),Go.$I.setTranslation(C,k),Go.$I.mul(C,C,Go.$I.rotY90),Go.$I.scale(C,C,v);const{getSerialIndex:B}=t.serialMapping,P=n.color.granularity.startsWith("vertex"),I=vk.i.fromNormalAndCoplanarPoint((0,vk.i)(),Go.eB.normalize((0,Go.eB)(),f),k),j=Go.$I.invert((0,Go.$I)(),C),T=(0,ip.tu)((0,Go.eB)(),(0,Go.eB)()),A=Gi.iZ.Location.create(t),{units:M}=t;let L=0;for(let _=0,G=M.length;_<G;++_){const{elements:e}=M[_];A.unit=M[_];for(let t=0,i=e.length;t<i;++t){A.element=e[t];const i=n.size.size(A);i>L&&(L=i)}}const E=new Uint8Array(x*S*4),D=new Uint8Array(x*S*4),N=new Float32Array(x*S);N.fill(Number.MAX_VALUE);const F=(0,Go.eB)(),R=(0,Go.eB)(),O=(0,Go.eB)();if(P){let e=0;for(let t=0;t<S;++t)for(let n=0;n<x;++n){const i=(0,sg.qE)(n+.5,0,x-1)/x-.5,s=(0,sg.qE)(t+.5,0,S-1)/S-.5;Go.eB.set(w,s,-i,0),Go.eB.transformMat4(w,w,C),Go.eB.copy(T.position,w);const r=d(T,!1);gk.Q1.toArray(r,E,e),E[e+3]=l?0:255,e+=4}}else for(let _=0,G=x*S*4;_<G;_+=4)gk.Q1.toArray(c,E,_),E[_+3]=l?0:255;for(let _=0,G=M.length;_<G;++_){const e=M[_],{elements:t,conformation:i}=e;A.unit=M[_];for(let s=0,o=t.length;s<o;++s){const e=t[s];A.element=e,i.position(e,F);const o=vk.i.distanceToPoint(I,F);if(Math.abs(o)>L)continue;const h=n.size.size(A);if(Math.abs(o)>h)continue;const p=Math.cos(Math.abs(o)/h),m=a?r*p:0,f=h+m/2,g=f*f;Go.eB.scaleAndAdd(R,F,I.normal,-o),Go.eB.transformMat4(O,R,j),Go.eB.addScalar(O,O,.5);const y=Math.floor(O[0]*S),v=x-Math.ceil(O[1]*x),b=Math.ceil(h*u),k=Math.max(0,y-b),M=Math.max(0,v-b),z=Math.min(S,y+b+2),H=Math.min(x,v+b+2);Go.eB.copy(T.position,R);const U=P?c:d(A,!1),V=B(A.unit,A.element);for(let t=k;t<z;++t)for(let e=M;e<H;++e){const n=(0,sg.qE)(t+.5,0,S-1)/S-.5,i=(0,sg.qE)(e+.5,0,x-1)/x-.5;xk(w,n,-i,0),Sk(w,w,C);const s=Ck(w,F);if(s>g)continue;const r=t*x+e;if(s<N[r]){const e=4*r,t=Math.sqrt(s)-h+m/2;let n=t>0?1-t/m:1;P?1===n?N[r]=s:l&&(0===D[e]&&0===D[e+1]&&0===D[e+2]||(n=1)):1===n?(N[r]=s,gk.Q1.toArray(U,E,e)):l?(gk.Q1.toArray(U,E,e),0===D[e]&&0===D[e+1]&&0===D[e+2]||(n=1)):gk.Q1.toArray(gk.Q1.interpolate(gk.Q1.fromArray(E,e),U,n),E,e),(0,mS.Gu)(V,D,e),D[e+3]=a?Math.round(255*n):255,l&&(E[4*r+3]=a?Math.round(255*n):255)}}}}const z={width:x,height:S,array:E,flipY:!0},H={width:x,height:S,array:D,flipY:!0},U={width:1,height:1,array:new Float32Array(1),flipY:!0},V=new Float32Array([-.5,.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0]);return(0,fk.pi)(C,V,0,4),mk._V.create(z,V,H,U,y,-1,s)}const Pk={"plane-image":(e,t)=>(0,gm.Kp)("Plane image",e,t,kk)},Ik={...wk,visuals:Xi.t.MultiSelect(["plane-image"],Xi.t.objectToOptions(Pk))};const jk=(0,gm.GT)({name:"plane",label:"Plane",description:"Displays planes.",factory:function(e,t){return Er.YL.createMulti("Plane",e,t,gm.J1,Pk)},getParams:function(e,t){return Ik},defaultValues:Xi.t.getDefaultValues(Ik),defaultColorTheme:{name:"element-symbol"},defaultSizeTheme:{name:"physical"},isApplicable:e=>e.elementCount>0,getData:(e,t)=>t.includeParent?e.asParent():e,mustRecreate:(e,t)=>e.includeParent!==t.includeParent});class Tk extends Er.lN{constructor(){super(),(0,Qi.IF)(Tk.BuiltIn,(e,t)=>{if(e.name!==t)throw new Error(`Fix BuiltInStructureRepresentations to have matching names. ${e.name} ${t}`);this.add(e)})}}!function(e){e.BuiltIn={cartoon:Jx,backbone:pk,"ball-and-stick":xm,carbohydrate:Ef,ellipsoid:hS,"gaussian-surface":uC,"gaussian-volume":Jw,label:bC,line:_w,"molecular-surface":NC,orientation:GC,plane:jk,point:nw,putty:uw,spacefill:mw}}(Tk||(Tk={}));var Ak=n(68130),Mk=n(17197),Lk=n(93096),Ek=n(46005),Dk=n(69715);const Nk=1e3/30;class Fk{get isAnimating(){return this._isAnimating}async tick(e,t){var n,i;if(await this.plugin.managers.animation.tick(e,null==t?void 0:t.isSynchronous,null==t?void 0:t.animation),null===(n=this.plugin.canvas3d)||void 0===n||n.tick(e,t),Md.g$){const e=null===(i=this.plugin.canvas3d)||void 0===i?void 0:i.webgl.timer.resolve();if(e)for(const t of e)(0,Dk.d)([t])}}resetTime(e){var t;null===(t=this.plugin.canvas3d)||void 0===t||t.resetTime(e)}start(e){var t,n;null===(t=this.plugin.canvas3d)||void 0===t||t.resume(),this._isAnimating=!0,this.resetTime(0),this.properTimeT=0,this.lastTickT=(0,qc.t)(),(null==e?void 0:e.immediate)?this.frame():this.currentFrame=null===(n=this.plugin.canvas3d)||void 0===n?void 0:n.requestAnimationFrame(this.frame)}stop(e){var t,n;this._isAnimating=!1,void 0!==this.currentFrame&&(null===(t=this.plugin.canvas3d)||void 0===t||t.cancelAnimationFrame(this.currentFrame),this.currentFrame=void 0),(null==e?void 0:e.noDraw)&&(null===(n=this.plugin.canvas3d)||void 0===n||n.pause(null==e?void 0:e.noDraw))}constructor(e){this.plugin=e,this.lastTickT=0,this.properTimeT=0,this.currentFrame=void 0,this._isAnimating=!1,this.frame=(e,t)=>{var n;const i=(0,qc.t)(),s=i-this.lastTickT;this.lastTickT=i,this.properTimeT+=Math.min(s,Nk),this.tick(this.properTimeT,{xrFrame:t}),this._isAnimating&&(this.currentFrame=null===(n=this.plugin.canvas3d)||void 0===n?void 0:n.requestAnimationFrame(this.frame))}}}var Rk=n(78439),Ok=n(87053),zk=n(12845);class Hk{getDecorator(e){const t=this.plugin.state.data.tree,n=t.children.get(e);if(1!==n.size)return e;const i=n.first();return i&&t.transforms.get(i).transformer.definition.isDecorator?this.getDecorator(i):e}get(e,t=!1){const n=this.root.get(e);if(n)return t?this.plugin.state.data.cells.get(n.ref):this.plugin.state.data.cells.get(this.getDecorator(n.ref))}addMapping(e,t,n){if(!Ls.O.Molecule.Structure.is(n))return!1;if(this.tracked.set(t,n.data),this.root.has(n.data)){this.root.get(n.data).count++}else{const i=e.select(Yi.QX.Generators.byRef(t).rootOfType([Ls.O.Molecule.Structure]))[0];i?this.root.set(n.data,{ref:i.transform.ref,count:1}):this.root.set(n.data,{ref:t,count:1})}return!0}removeMapping(e){if(!this.tracked.has(e))return!1;const t=this.tracked.get(e);this.tracked.delete(e);const n=this.root.get(t);return n.count>1?n.count--:this.root.delete(t),!0}updateMapping(e,t,n,i){return!!Ls.O.Molecule.Structure.is(i)&&(this.removeMapping(t),this.addMapping(e,t,i),!0)}dispose(){this.ev.dispose()}constructor(e){this.plugin=e,this.ev=Ek.V.create(),this.events={updated:this.ev(),removed:this.ev()},this.root=new Map,this.tracked=new Map,e.state.data.events.object.created.subscribe(e=>{this.addMapping(e.state,e.ref,e.obj)}),e.state.data.events.object.removed.subscribe(e=>{this.removeMapping(e.ref)&&this.events.removed.next({ref:e.ref,obj:e.obj})}),e.state.data.events.object.updated.subscribe(e=>{this.updateMapping(e.state,e.ref,e.oldObj,e.obj)&&this.events.updated.next({ref:e.ref,oldObj:e.oldObj,obj:e.obj})})}}var Uk=n(59530);class Vk{constructor(){this.ev=Ek.V.create(),this.id=0,this.runningTasks=new Set,this.abortRequests=new Map,this.options=new Map,this.currentContext=[],this.events={progress:this.ev(),finished:this.ev()}}tryGetAbortTaskId(e){if(this.abortRequests.has(e.progress.taskId))return e.progress.taskId;for(const t of e.children){const e=this.tryGetAbortTaskId(t);if(void 0!==e)return e}}track(e,t){return n=>{var i;if(n.canAbort&&n.requestAbort){const e=this.tryGetAbortTaskId(n.root);void 0!==e&&n.requestAbort(this.abortRequests.get(e))}const s=(0,qc.t)()-n.root.progress.startedTime;this.events.progress.next({id:e,useOverlay:null===(i=this.options.get(t))||void 0===i?void 0:i.useOverlay,level:s<250?"none":"background",progress:n})}}async run(e,t){const n=this.id++;let i;(null==t?void 0:t.createNewContext)||0===this.currentContext.length?i={ctx:(0,Uk.pm)(e,this.track(n,e.id),100),refCount:1}:(i=this.currentContext[this.currentContext.length-1],i.refCount++);try{this.options.set(e.id,{useOverlay:!!(null==t?void 0:t.useOverlay)}),this.runningTasks.add(e.id);return await(0,Uk.yR)(i.ctx,e)}finally{this.options.delete(e.id),this.runningTasks.delete(e.id),this.events.finished.next({id:n}),this.abortRequests.delete(e.id),i.refCount--,0===i.refCount&&(0,wr.mO)(this.currentContext,i)}}requestAbortAll(e){this.runningTasks.forEach(t=>this.abortRequests.set(t,e))}requestAbort(e,t){const n="number"==typeof e?e:e.root.progress.taskId;this.abortRequests.set(n,t)}dispose(){this.ev.dispose()}}!function(e){function t(e){return new Promise(t=>setTimeout(t,e))}e.testTask=function(e){return Zi.YZ.create("Test",async n=>{let i=0;for(;i<e;)await t(100+200*Math.random()),n.shouldUpdate&&await n.update({message:"Step "+i,current:i,max:e,isIndeterminate:!1}),i++})}}(Vk||(Vk={}));class _k extends Wi.e{findByKey(e){return this.state.entries.find(t=>!!t&&t.key===e)}show(e){let t,n=this.state.entries;const i=++this.serialId;let s;e.key&&(t=this.findByKey(e.key))?(void 0!==t.timeout&&clearTimeout(t.timeout),s=t.serialNumber,n=n.remove(t.id)):s=++this.serialNumber,t={id:i,serialNumber:s,key:e.key,title:e.title,message:e.message,timeout:this.timeout(i,e.timeoutMs),hide:()=>this.hideId(i)},this.updateState({entries:n.set(i,t)})&&this.events.changed.next(void 0)}timeout(e,t){if(void 0!==t)return t<0&&(t=500),setTimeout(()=>{const t=this.state.entries.get(e);t.timeout=void 0,this.hide(t)},t)}hideId(e){this.hide(this.state.entries.get(e))}hide(e){e&&(void 0!==e.timeout&&clearTimeout(e.timeout),e.hide=void 0,this.updateState({entries:this.state.entries.delete(e.id)})&&this.events.changed.next(void 0))}constructor(e){super({entries:(0,Gc.uY)()}),this.events={changed:this.ev()},this.serialNumber=0,this.serialId=0,Fi.a.Toast.Show.subscribe(e,e=>this.show(e)),Fi.a.Toast.Hide.subscribe(e,e=>this.hide(this.findByKey(e.key)))}}var Gk=n(56927),qk=n(61199);function $k(){const e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))&&0===e.toDataURL("image/webp").indexOf("data:image/webp")}class Zk extends Wi.N{createParams(){let e=8192;if(this.plugin.canvas3d){const{webgl:t}=this.plugin.canvas3d;e=Math.floor(Math.min(t.maxRenderbufferSize,t.maxTextureSize)/2)}return{resolution:Xi.t.MappedStatic("viewport",{viewport:Xi.t.Group({}),hd:Xi.t.Group({}),"full-hd":Xi.t.Group({}),"ultra-hd":Xi.t.Group({}),custom:Xi.t.Group({width:Xi.t.Numeric(1920,{min:128,max:e,step:1}),height:Xi.t.Numeric(1080,{min:128,max:e,step:1})},{isFlat:!0})},{options:[["viewport","Viewport"],["hd","HD (1280 x 720)"],["full-hd","Full HD (1920 x 1080)"],["ultra-hd","Ultra HD (3840 x 2160)"],["custom","Custom"]]}),format:Xi.t.MappedStatic("png",{png:Xi.t.Group({}),webp:Xi.t.Group({quality:Xi.t.Numeric(.9,{min:0,max:1,step:.01})}),jpeg:Xi.t.Group({quality:Xi.t.Numeric(.9,{min:0,max:1,step:.01})})},{options:[["png","PNG"],["jpeg","JPEG"],...$k()?[["webp","WebP"]]:[]]}),transparent:Xi.t.Boolean(!1),axes:Gk.kf.axes,illumination:Xi.t.Group({extraIterations:Xi.t.Numeric(1,{min:0,max:5,step:1}),targetIterationTimeMs:Xi.t.Numeric(300,{min:100,max:3e3,step:10})})}}get params(){return this._params?this._params:this._params=this.createParams()}get values(){return this.behaviors.values.value}get cropParams(){return this.behaviors.cropParams.value}get relativeCrop(){return this.behaviors.relativeCrop.value}getCanvasSize(){var e,t;return{width:(null===(e=this.plugin.canvas3d)||void 0===e?void 0:e.webgl.gl.drawingBufferWidth)||0,height:(null===(t=this.plugin.canvas3d)||void 0===t?void 0:t.webgl.gl.drawingBufferHeight)||0}}getSize(){const e=this.values;switch(e.resolution.name){case"viewport":return this.getCanvasSize();case"hd":return{width:1280,height:720};case"full-hd":return{width:1920,height:1080};case"ultra-hd":return{width:3840,height:2160};default:return{width:e.resolution.params.width,height:e.resolution.params.height}}}getPostprocessingProps(){const e=this.plugin.canvas3d,t=e.props.postprocessing.occlusion;return{...e.props.postprocessing,occlusion:"on"===t.name?{name:"on",params:{...t.params,samples:128,resolutionScale:e.webgl.pixelRatio,transparentThreshold:1}}:t}}getIlluminationProps(e){const t=this.plugin.canvas3d.props.illumination,{extraIterations:n,targetIterationTimeMs:i}=this.values.illumination;return{...t,enabled:!e&&t.enabled,maxIterations:Math.ceil(Math.log2(Math.pow(2,t.maxIterations+n)*t.rendersPerFrame[1])),targetFps:1e3/i,denoiseThreshold:[t.denoiseThreshold[0],t.denoiseThreshold[0]],rendersPerFrame:[1,1]}}createPass(e){const t=this.plugin.canvas3d,{colorBufferFloat:n,textureFloat:i}=t.webgl.extensions;return t.getImagePass({transparentBackground:this.values.transparent,cameraHelper:{axes:this.values.axes},multiSample:{...t.props.multiSample,mode:e?"off":"on",sampleLevel:n&&i?4:2,reuseOcclusion:!1},postprocessing:this.getPostprocessingProps(),marking:{...t.props.marking},illumination:this.getIlluminationProps(e)})}get previewPass(){return this._previewPass||(this._previewPass=this.createPass(!0))}get imagePass(){if(this._imagePass){const e=this.plugin.canvas3d;return this._imagePass.setProps({cameraHelper:{axes:this.values.axes},transparentBackground:this.values.transparent,postprocessing:this.getPostprocessingProps(),marking:{...e.props.marking},illumination:this.getIlluminationProps(!1)}),this._imagePass}return this._imagePass=this.createPass(!1)}getFilename(e){"string"!=typeof e&&(e=this.extension);const t=this.plugin.state.data.select(Yi.QX.Generators.rootsOfType(Ls.O.Molecule.Model)).map(e=>e.obj.data),n=new Set;t.forEach(e=>n.add(e.entryId.toUpperCase()));return`${Ms.M.toArray(n).join("-")||"molstar-image"}${e}`}resetCrop(){this.behaviors.relativeCrop.next({x:0,y:0,width:1,height:1})}toggleAutocrop(){this.cropParams.auto?(this.behaviors.cropParams.next({...this.cropParams,auto:!1}),this.resetCrop()):this.behaviors.cropParams.next({...this.cropParams,auto:!0})}get isFullFrame(){const e=this.relativeCrop;return(0,nS.T)(e.x,0,1e-5)&&(0,nS.T)(e.y,0,1e-5)&&(0,nS.T)(e.width,1,1e-5)&&(0,nS.T)(e.height,1,1e-5)}autocrop(e=this.cropParams.relativePadding){const{data:t,width:n,height:i}=this.previewData.image,s=this.previewData.transparent,r=s?this.previewData.background:4278190080|this.previewData.background;let o=n,a=0,l=i,c=0;for(let p=0;p<i;p++){const e=p*n;for(let i=0;i<n;i++){const n=4*(e+i);if(s){if(0===t[n+3])continue}else{if((t[n]<<16|t[n+1]<<8|t[n+2]|t[n+3]<<24)===r)continue}i<o&&(o=i),i>a&&(a=i),p<l&&(l=p),p>c&&(c=p)}}if(o>a){const e=o;o=a,a=e}if(l>c){const e=l;l=c,c=e}const u=a-o+1,d=c-l+1;o-=e*u,a+=e*u,l-=e*d,c+=e*d;const h={x:Math.max(0,o/n),y:Math.max(0,l/i),width:Math.min(1,(a-o+1)/n),height:Math.min(1,(c-l+1)/i)};this.behaviors.relativeCrop.next(h)}async getPreview(e,t=320){const{width:n,height:i}=this.getSize();if(n<=0||i<=0)return;const s=n/i;let r=0,o=0;s>1?(r=t,o=Math.round(t/s)):(o=t,r=Math.round(t*s));const a=this.plugin.canvas3d.props;this.previewPass.setProps({cameraHelper:{axes:this.values.axes},transparentBackground:this.values.transparent,postprocessing:a.postprocessing,marking:a.marking});const l=await this.previewPass.getImageData(e,r,o),c=this.previewCanvas;c.width=l.width,c.height=l.height,this.previewData.image=l,this.previewData.background=a.renderer.backgroundColor,this.previewData.transparent=this.values.transparent;const u=c.getContext("2d");if(!u)throw new Error("Could not create canvas 2d context");return u.putImageData(l,0,0),this.cropParams.auto&&this.autocrop(),this.events.previewed.next(void 0),{canvas:c,width:r,height:o}}getSizeAndViewport(){const{width:e,height:t}=this.getSize(),n=this.relativeCrop,i={x:Math.floor(n.x*e),y:Math.floor(n.y*t),width:Math.ceil(n.width*e),height:Math.ceil(n.height*t)};return i.width+i.x>e&&(i.width=e-i.x),i.height+i.y>t&&(i.height=t-i.y),{width:e,height:t,viewport:i}}async draw(e){const{width:t,height:n,viewport:i}=this.getSizeAndViewport();if(!(t<=0||n<=0)){this.plugin.animationLoop.stop({noDraw:!0});try{await e.update("Rendering image...");const s=this.imagePass;await s.updateBackground();const r=await s.getImageData(e,t,n,i);await e.update("Encoding image...");const o=this.canvas;o.width=r.width,o.height=r.height;const a=o.getContext("2d");if(!a)throw new Error("Could not create canvas 2d context");a.putImageData(r,0,0)}finally{this.plugin.animationLoop.start({immediate:!0})}}}copyToClipboardTask(){const e=navigator.clipboard;if(null==e?void 0:e.write)return Zi.YZ.create("Copy Image",async t=>{await this.draw(t),await t.update("Converting image...");const n=this.mimeType,i=await(0,Pd.PG)(this.canvas,n,this.quality),s=new ClipboardItem({[n]:i});await e.write([s]),this.plugin.log.message("Image copied to clipboard.")});this.plugin.log.error("clipboard.write not supported!")}get mimeType(){var e,t;return`image/${null!==(t=null===(e=this.values.format)||void 0===e?void 0:e.name)&&void 0!==t?t:"png"}`}get extension(){var e,t,n;return"jpeg"===(null===(e=this.values.format)||void 0===e?void 0:e.name)?".jpg":`.${null!==(n=null===(t=this.values.format)||void 0===t?void 0:t.name)&&void 0!==n?n:"png"}`}get quality(){var e,t,n,i;switch(null===(e=this.values.format)||void 0===e?void 0:e.name){case"webp":case"jpeg":return null!==(i=null===(n=null===(t=this.values.format)||void 0===t?void 0:t.params)||void 0===n?void 0:n.quality)&&void 0!==i?i:.9;default:return}}getImageDataUri(){return this.plugin.runTask(Zi.YZ.create("Generate Image",async e=>(await this.draw(e),await e.update("Converting image..."),this.canvas.toDataURL(this.mimeType))))}copyToClipboard(){const e=this.copyToClipboardTask();if(e)return this.plugin.runTask(e)}downloadTask(e){return Zi.YZ.create("Download Image",async t=>{await this.draw(t),await t.update("Downloading image...");const n=await(0,Pd.PG)(this.canvas,this.mimeType,this.quality);(0,qk.R)(n,null!=e?e:this.getFilename(this.extension))})}download(e){return this.plugin.runTask(this.downloadTask(e),{useOverlay:!0})}constructor(e){super(),this.plugin=e,this._params=void 0,this.behaviors={values:this.ev.behavior({transparent:this.params.transparent.defaultValue,format:{name:"png",params:{}},axes:{name:"off",params:{}},resolution:this.params.resolution.defaultValue,illumination:this.params.illumination.defaultValue}),cropParams:this.ev.behavior({auto:!0,relativePadding:.1}),relativeCrop:this.ev.behavior({x:0,y:0,width:1,height:1})},this.events={previewed:this.ev()},this.canvas=document.createElement("canvas"),this.previewCanvas=document.createElement("canvas"),this.previewData={image:{data:new Uint8ClampedArray(1),width:1,height:0},background:(0,es.Q1)(0),transparent:!1}}}var Kk=n(24452);class Qk{addHandler(e,t){const n=this.handlers.findIndex(t=>t[0]===e);n<0?this.handlers.push([e,t]):this.handlers[n][1]=t}removeHandler(e){const t=this.handlers.findIndex(t=>t[0]===e);t>=0&&this.handlers.splice(t,1)}async handle(e){for(let t=this.handlers.length-1;t>=0;t--){const n=this.handlers[t][1];if(await n(e,this.plugin))return}!function(e,t){const n=t.filter(e=>{const t=e.name.toLowerCase();return t.endsWith(".molx")||t.endsWith(".molj")});n.length>0?Fi.a.State.Snapshots.OpenFile(e,{file:n[0]}):e.runTask(e.state.data.applyAction(hd.OpenFiles,{files:t.map(e=>pd.V.File(e)),format:{name:"auto",params:{}},visuals:!0}))}(this.plugin,e)}dispose(){this.handlers.length=0}constructor(e){this.plugin=e,this.handlers=[]}}class Xk{constructor(){this.errors=Object.create(null)}get(e){var t;return null!==(t=this.errors[e])&&void 0!==t?t:[]}add(e,t){e in this.errors&&Array.isArray(this.errors[e])?this.errors[e].push(t):this.errors[e]=[t]}clear(e){delete this.errors[e]}}class Wk{mount(e){var t;this.parent.parentElement!==e&&(null===(t=this.parent.parentElement)||void 0===t||t.removeChild(this.parent)),e.appendChild(this.parent)}unmount(){var e;null===(e=this.parent.parentElement)||void 0===e||e.removeChild(this.parent)}constructor(e){this.options=e;const t=document.createElement("div");Object.assign(t.style,{position:"absolute",left:0,top:0,right:0,bottom:0,"-webkit-user-select":"none","user-select":"none","-webkit-tap-highlight-color":"rgba(0,0,0,0)","-webkit-touch-callout":"none","touch-action":"manipulation"});let n=null==e?void 0:e.canvas;n||(n=document.createElement("canvas"),(null==e?void 0:e.checkeredCanvasBackground)&&Object.assign(n.style,{"background-image":"linear-gradient(45deg, lightgrey 25%, transparent 25%, transparent 75%, lightgrey 75%, lightgrey), linear-gradient(45deg, lightgrey 25%, transparent 25%, transparent 75%, lightgrey 75%, lightgrey)","background-size":"60px 60px","background-position":"0 0, 30px 30px"}),t.appendChild(n)),this.canvas=n,this.parent=t}}class Yk{get isInitialized(){return this._isInitialized}build(){return this.state.data.build()}async initViewerAsync(e,t,n){return this._initViewer(e,t,n)}async initContainerAsync(e){return this._initContainer(e)}async mountAsync(e,t){return this._mount(e,t)}_initContainer(e){var t;if(this.container)return!0;const n=new Wk({checkeredCanvasBackground:null==e?void 0:e.checkeredCanvasBackground,canvas:null===(t=null==e?void 0:e.canvas3dContext)||void 0===t?void 0:t.canvas});return!!this._initViewer(n.canvas,n.parent,null==e?void 0:e.canvas3dContext)&&(this.container=n,!0)}_mount(e,t){var n;if(this.disposed)throw new Error("Cannot mount a disposed context");return!!this._initContainer(t)&&(null===(n=this.container)||void 0===n||n.mount(e),this.handleResize(),!0)}unmount(){var e;null===(e=this.container)||void 0===e||e.unmount()}_initViewer(e,t,n){var i,s,r,o,a,l;try{this.layout.setRoot(t),this.spec.layout&&this.spec.layout.initial&&this.layout.setProps(this.spec.layout.initial),n||(n=Vc.H7.fromCanvas(e,this.managers.asset,{antialias:!(null!==(i=this.config.get(Mr.AB.General.DisableAntialiasing))&&void 0!==i&&i),preserveDrawingBuffer:!(null!==(s=this.config.get(Mr.AB.General.DisablePreserveDrawingBuffer))&&void 0!==s&&s),preferWebGl1:this.config.get(Mr.AB.General.PreferWebGl1)||!1,failIfMajorPerformanceCaveat:!(null!==(r=this.config.get(Mr.AB.General.AllowMajorPerformanceCaveat))&&void 0!==r&&r),powerPreference:this.config.get(Mr.AB.General.PowerPreference)||"high-performance",handleResize:this.handleResize},{pixelScale:this.config.get(Mr.AB.General.PixelScale)||1,pickScale:this.config.get(Mr.AB.General.PickScale)||.25,transparency:this.config.get(Mr.AB.General.Transparency)||"wboit",resolutionMode:this.config.get(Mr.AB.General.ResolutionMode)||"auto"})),this.canvas3dContext=n,this.canvas3d=Vc.mX.create(this.canvas3dContext),this.canvas3dInit.next(!0);let c=this.spec.canvas3d;const u=(0,es.Q1)(16579577);return c?(void 0===(null===(a=c.renderer)||void 0===a?void 0:a.backgroundColor)&&(c=(0,id.j)(c,e=>{e.renderer?e.renderer.backgroundColor=u:e.renderer={backgroundColor:u}})),null===(l=this.canvas3d)||void 0===l||l.setProps(c)):null===(o=this.canvas3d)||void 0===o||o.setProps({renderer:{backgroundColor:u}}),this.animationLoop.start(),this.helpers.viewportScreenshot=new Zk(this),this.subs.push(this.canvas3d.interaction.click.subscribe(e=>this.behaviors.interaction.click.next(e))),this.subs.push(this.canvas3d.interaction.drag.subscribe(e=>this.behaviors.interaction.drag.next(e))),this.subs.push(this.canvas3d.interaction.hover.subscribe(e=>this.behaviors.interaction.hover.next(e))),this.subs.push(this.canvas3d.input.resize.pipe((0,su.B)(50),(0,Ro.c)(100,void 0,{leading:!1,trailing:!0})).subscribe(()=>this.handleResize())),this.subs.push(this.canvas3d.input.keyDown.subscribe(e=>this.behaviors.interaction.key.next(e))),this.subs.push(this.canvas3d.input.keyUp.subscribe(e=>this.behaviors.interaction.keyReleased.next(e))),this.subs.push(this.canvas3d.xr.isPresenting.subscribe(e=>this.log.info("WebXR "+(e?"enabled":"disabled")))),this.subs.push(this.canvas3d.xr.requestFailed.subscribe(e=>this.log.error(`WebXR request failed: ${e}`))),this.subs.push(this.layout.events.updated.subscribe(()=>requestAnimationFrame(()=>this.handleResize()))),this.handleResize(),Zi._F.setImmediate(()=>this.initCanvas3dPromiseCallbacks[0]()),!0}catch(c){return this.log.error(""+c),console.error(c),Zi._F.setImmediate(()=>this.initCanvas3dPromiseCallbacks[1](c)),!1}}get isBusy(){return this.behaviors.state.isAnimating.value||this.behaviors.state.isUpdating.value}get selectionMode(){return this.behaviors.interaction.selectionMode.value}set selectionMode(e){this.behaviors.interaction.selectionMode.next(e)}dataTransaction(e,t){return this.runTask(this.state.data.transaction(e,t))}clear(e=!1){var t;return e&&(null===(t=this.canvas3d)||void 0===t||t.setProps(Vc.FN)),Fi.a.State.RemoveObject(this,{state:this.state.data,ref:Yi.Cn.RootRef})}dispose(e){var t,n;if(!this.disposed){for(const e of this.subs)e.unsubscribe();this.subs=[],this.layout.dispose(),this.managers.markdownExtensions.audio.dispose(),this.animationLoop.stop(),this.commands.dispose(),null===(t=this.canvas3d)||void 0===t||t.dispose(),(null==e?void 0:e.doNotDisposeCanvas3DContext)||null===(n=this.canvas3dContext)||void 0===n||n.dispose(e),this.ev.dispose(),this.state.dispose(),this.helpers.substructureParent.dispose(),(0,Qi.IF)(this.managers,e=>{var t;return null===(t=null==e?void 0:e.dispose)||void 0===t?void 0:t.call(e)}),(0,Qi.IF)(this.managers.structure,e=>{var t;return null===(t=null==e?void 0:e.dispose)||void 0===t?void 0:t.call(e)}),(0,Qi.IF)(this.managers.volume,e=>{var t;return null===(t=null==e?void 0:e.dispose)||void 0===t?void 0:t.call(e)}),this.unmount(),this.container=void 0,this.customState={},this.disposed=!0}}initBehaviorEvents(){this.subs.push((0,Sd.h)(this.state.data.behaviors.isUpdating,this.state.behaviors.behaviors.isUpdating).subscribe(e=>{this.behaviors.state.isUpdating.value!==e&&this.behaviors.state.isUpdating.next(e)}));const e=this.config.get(Mr.AB.General.IsBusyTimeoutMs)||750,t=this.behaviors.state.isBusy;let n;const i=()=>{t.value||t.next(!0)},s=()=>{void 0!==n&&clearTimeout(n),n=void 0};this.subs.push((0,Sd.h)(this.behaviors.state.isUpdating,this.behaviors.state.isAnimating).subscribe(r=>{const o=this.behaviors.state.isUpdating.value,a=this.behaviors.state.isAnimating.value;o||a?t.value||(s(),n=setTimeout(i,e)):(s(),t.next(!1))})),this.subs.push(this.behaviors.interaction.selectionMode.subscribe(e=>{var t;e||null===(t=this.managers.interactivity)||void 0===t||t.lociSelects.deselectAll()}))}initBuiltInBehavior(){Rk.U0.State.registerDefault(this),Rk.U0.Representation.registerDefault(this),Rk.U0.Camera.registerDefault(this),Rk.U0.Misc.registerDefault(this),this.subs.push((0,Sd.h)(this.state.data.events.log,this.state.behaviors.events.log).subscribe(e=>this.events.log.next(e)))}async initBehaviors(){let e=this.state.behaviors.build();for(const t of Object.keys(Ok.A.Categories))e.toRoot().apply(Ok.A.CreateCategory,{label:Ok.A.Categories[t]},{ref:t,state:{isLocked:!0}});for(const t of this.spec.behaviors){"custom-props"===Ok.A.getCategoryId(t.transformer)&&e.to(Ok.A.getCategoryId(t.transformer)).apply(t.transformer,t.defaultParams,{ref:t.transformer.id})}await this.runTask(this.state.behaviors.updateTree(e,{doNotUpdateCurrent:!0,doNotLogTiming:!0})),e=this.state.behaviors.build();for(const t of this.spec.behaviors){"custom-props"!==Ok.A.getCategoryId(t.transformer)&&e.to(Ok.A.getCategoryId(t.transformer)).apply(t.transformer,t.defaultParams,{ref:t.transformer.id})}await this.runTask(this.state.behaviors.updateTree(e,{doNotUpdateCurrent:!0,doNotLogTiming:!0}))}initCustomFormats(){if(this.spec.customFormats)for(const e of this.spec.customFormats)this.dataFormats.add(e[0],e[1])}initAnimations(){if(this.spec.animations)for(const e of this.spec.animations)this.managers.animation.register(e)}initDataActions(){if(this.spec.actions)for(const e of this.spec.actions)this.state.data.actions.add(e.action)}async init(){try{this.subs.push(this.events.log.subscribe(e=>this.log.entries=this.log.entries.push(e))),this.initCustomFormats(),this.initBehaviorEvents(),this.initBuiltInBehavior(),this.managers.interactivity=new Nr(this),this.managers.lociLabels=new Rh(this),this.builders.structure=new Qd(this),this.initAnimations(),this.initDataActions(),await this.initBehaviors(),this.log.message(`Mol* Plugin ${Kk.j} [${Kk.s.toLocaleString()}]`),Md.Zq||this.log.message("Development mode enabled"),Md.Bb&&this.log.message("Debug mode enabled"),this._isInitialized=!0,this.initializedPromiseCallbacks[0]()}catch(e){throw this.initializedPromiseCallbacks[1](e),e}}constructor(e){var t,n;this.spec=e,this.runTask=(e,t)=>this.managers.task.run(e,t),this.resolveTask=e=>{if(e)return Zi.YZ.is(e)?this.runTask(e):e},this.subs=[],this.initCanvas3dPromiseCallbacks=[()=>{},()=>{}],this._isInitialized=!1,this.initializedPromiseCallbacks=[()=>{},()=>{}],this.disposed=!1,this.container=void 0,this.ev=Ek.V.create(),this.config=new Mr.tf(this.spec.config),this.state=new Ec.p(this),this.commands=new zk.K,this.canvas3dInit=this.ev.behavior(!1),this.behaviors={state:{isAnimating:this.ev.behavior(!1),isUpdating:this.ev.behavior(!1),isBusy:this.ev.behavior(!1)},interaction:{hover:this.ev.behavior({current:Er.YL.Loci.Empty,modifiers:mu.Fs.None,buttons:0,button:0}),click:this.ev.behavior({current:Er.YL.Loci.Empty,modifiers:mu.Fs.None,buttons:0,button:0}),drag:this.ev.behavior({current:Er.YL.Loci.Empty,modifiers:mu.Fs.None,buttons:0,button:0,pageStart:(0,Go.ZY)(),pageEnd:(0,Go.ZY)()}),key:this.ev.behavior(mu.Vl),keyReleased:this.ev.behavior(mu.Vl),selectionMode:this.ev.behavior(!1)},labels:{highlight:this.ev.behavior({labels:[]})},layout:{leftPanelTabName:this.ev.behavior("root")},canvas3d:{initialized:this.canvas3dInit.pipe((0,cr.p)(e=>!!e),(n=1,n<=0?function(){return Cd.w}:(0,wd.N)(function(e,t){var i=0;e.subscribe((0,kd._)(t,function(e){++i<=n&&(t.next(e),n<=i&&t.complete())}))})))}},this.canvas3dInitialized=new Promise((e,t)=>{this.initCanvas3dPromiseCallbacks=[e,t]}),this.initialized=new Promise((e,t)=>{this.initializedPromiseCallbacks=[e,t]}),this.layout=new Yh(this),this.animationLoop=new Fk(this),this.representation={structure:{registry:new Tk,themes:{colorThemeRegistry:yk.J.createRegistry(),sizeThemeRegistry:Bp.F.createRegistry()}},volume:{registry:new Ak.H,themes:{colorThemeRegistry:yk.J.createRegistry(),sizeThemeRegistry:Bp.F.createRegistry()}}},this.query={structure:{registry:new os.lL}},this.dataFormats=new fh,this.builders={data:new Td(this),structure:void 0},this.helpers={substructureParent:new Hk(this),viewportScreenshot:void 0},this.managers={structure:{hierarchy:new rr(this),component:new As(this),measurement:new Ar(this),selection:new Hh(this),focus:new _h(this)},volume:{hierarchy:new Lo(this)},interactivity:void 0,camera:new Fh(this),animation:new gh(this),snapshot:new Oh.g(this),lociLabels:void 0,toast:new _k(this),asset:new pd.E,task:new Vk,markdownExtensions:new $h(this),dragAndDrop:new Qk(this)},this.events={log:this.ev(),task:this.managers.task.events,canvas3d:{settingsUpdated:this.ev()}},this.customModelProperties=new Bd.Registry,this.customStructureProperties=new Bd.Registry,this.customStructureControls=new Map,this.customImportControls=new Map,this.genericRepresentationControls=new Map,this.errorContext=new Xk,this.customState=Object.create(null),this.handleResize=()=>{var e,t;const n=null===(e=this.canvas3dContext)||void 0===e?void 0:e.canvas,i=this.layout.root;i&&n&&((0,Pd.H5)(n,i,this.canvas3dContext.pixelScale),this.canvas3dContext.syncPixelScale(),null===(t=this.canvas3d)||void 0===t||t.requestResize())},this.log={entries:(0,Gc.B8)(),entry:e=>this.events.log.next(e),error:e=>this.events.log.next(Lk.x.error(e)),message:e=>this.events.log.next(Lk.x.message(e)),info:e=>this.events.log.next(Lk.x.info(e)),warn:e=>this.events.log.next(Lk.x.warning(e))},this.fetch=Mk.hW,(0,Jm.GW)(null!==(t=this.config.get(Mr.AB.Structure.SaccharideCompIdMapType))&&void 0!==t?t:"default")}}class Jk extends Yk{initCustomParamEditors(){if(this.spec.customParamEditors)for(const[e,t]of this.spec.customParamEditors)this.customParamEditors.set(e.id,t)}dispose(e){super.dispose(e),this.layout.dispose()}constructor(e){super(e),this.spec=e,this.customParamEditors=new Map,this.customUIState={},this.initCustomParamEditors()}}var eB=n(68819);async function tB(e){const{spec:t,target:n,onBeforeUIRender:i,render:s}=e,o=new Jk(t||(0,eB.DefaultPluginUISpec)());await o.init(),i&&await i(o),s((0,r.createElement)(md,{plugin:o}),n);try{await o.canvas3dInitialized}catch(a){}return o}},11346:function(e){var t=/\/\*[^*]*\*+([^/*][^*]*\*+)*\//g,n=/\n/g,i=/^\s*/,s=/^(\*?[-#/*\\\w]+(\[[0-9a-z_-]+\])?)\s*/,r=/^:\s*/,o=/^((?:'(?:\\'|.)*?'|"(?:\\"|.)*?"|\([^)]*?\)|[^};])+)/,a=/^[;\s]*/,l=/^\s+|\s+$/g,c="";function u(e){return e?e.replace(l,c):c}e.exports=function(e,l){if("string"!=typeof e)throw new TypeError("First argument must be a string");if(!e)return[];l=l||{};var d=1,h=1;function p(e){var t=e.match(n);t&&(d+=t.length);var i=e.lastIndexOf("\n");h=~i?e.length-i:h+e.length}function m(){var e={line:d,column:h};return function(t){return t.position=new f(e),v(),t}}function f(e){this.start=e,this.end={line:d,column:h},this.source=l.source}function g(t){var n=new Error(l.source+":"+d+":"+h+": "+t);if(n.reason=t,n.filename=l.source,n.line=d,n.column=h,n.source=e,!l.silent)throw n}function y(t){var n=t.exec(e);if(n){var i=n[0];return p(i),e=e.slice(i.length),n}}function v(){y(i)}function b(e){var t;for(e=e||[];t=x();)!1!==t&&e.push(t);return e}function x(){var t=m();if("/"==e.charAt(0)&&"*"==e.charAt(1)){for(var n=2;c!=e.charAt(n)&&("*"!=e.charAt(n)||"/"!=e.charAt(n+1));)++n;if(n+=2,c===e.charAt(n-1))return g("End of comment missing");var i=e.slice(2,n-2);return h+=2,p(i),e=e.slice(n),h+=2,t({type:"comment",comment:i})}}function S(){var e=m(),n=y(s);if(n){if(x(),!y(r))return g("property missing ':'");var i=y(o),l=e({type:"declaration",property:u(n[0].replace(t,c)),value:i?u(i[0].replace(t,c)):c});return y(a),l}}return f.prototype.content=e,v(),function(){var e,t=[];for(b(t);e=S();)!1!==e&&(t.push(e),b(t));return t}()}},35229:function(e,t,n){var i=(this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}})(n(74870)),s=n(98917);function r(e,t){var n={};return e&&"string"==typeof e?((0,i.default)(e,function(e,i){e&&i&&(n[(0,s.camelCase)(e,t)]=i)}),n):n}r.default=r,e.exports=r},74870:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){let n=null;if(!e||"string"!=typeof e)return n;const i=(0,s.default)(e),r="function"==typeof t;return i.forEach(e=>{if("declaration"!==e.type)return;const{property:i,value:s}=e;r?t(i,s,e):s&&(n=n||{},n[i]=s)}),n};const s=i(n(11346))},92849:function(e){var t=Object.prototype.hasOwnProperty,n=Object.prototype.toString,i=Object.defineProperty,s=Object.getOwnPropertyDescriptor,r=function(e){return"function"==typeof Array.isArray?Array.isArray(e):"[object Array]"===n.call(e)},o=function(e){if(!e||"[object Object]"!==n.call(e))return!1;var i,s=t.call(e,"constructor"),r=e.constructor&&e.constructor.prototype&&t.call(e.constructor.prototype,"isPrototypeOf");if(e.constructor&&!s&&!r)return!1;for(i in e);return void 0===i||t.call(e,i)},a=function(e,t){i&&"__proto__"===t.name?i(e,t.name,{enumerable:!0,configurable:!0,value:t.newValue,writable:!0}):e[t.name]=t.newValue},l=function(e,n){if("__proto__"===n){if(!t.call(e,n))return;if(s)return s(e,n).value}return e[n]};e.exports=function e(){var t,n,i,s,c,u,d=arguments[0],h=1,p=arguments.length,m=!1;for("boolean"==typeof d&&(m=d,d=arguments[1]||{},h=2),(null==d||"object"!=typeof d&&"function"!=typeof d)&&(d={});h<p;++h)if(null!=(t=arguments[h]))for(n in t)i=l(d,n),d!==(s=l(t,n))&&(m&&s&&(o(s)||(c=r(s)))?(c?(c=!1,u=i&&r(i)?i:[]):u=i&&o(i)?i:{},a(d,{name:n,newValue:e(m,u,s)})):void 0!==s&&a(d,{name:n,newValue:s}));return d}},98917:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.camelCase=void 0;var n=/^--[a-zA-Z0-9_-]+$/,i=/-([a-z])/g,s=/^[^-]+$/,r=/^-(webkit|moz|ms|o|khtml)-/,o=/^-(ms)-/,a=function(e,t){return t.toUpperCase()},l=function(e,t){return"".concat(t,"-")};t.camelCase=function(e,t){return void 0===t&&(t={}),function(e){return!e||s.test(e)||n.test(e)}(e)?e:(e=e.toLowerCase(),(e=t.reactCompat?e.replace(o,l):e.replace(r,l)).replace(i,a))}}}]);
//# sourceMappingURL=966-0aba7b78307a205fbb7f.js.map